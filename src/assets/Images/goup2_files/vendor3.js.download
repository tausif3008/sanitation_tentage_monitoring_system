/*! For license information please see vendor3.js.LICENSE.txt */
(self.webpackChunkskype4life=self.webpackChunkskype4life||[]).push([[8],{566456:function(e,t,i){var n,r,s,a,o=i(734155),l=i(348764).Buffer,d=window;a=(e,t)=>{var a,c={},h={exports:c},u=Object.create,p=Object.defineProperty,g=Object.getOwnPropertyDescriptor,m=Object.getOwnPropertyNames,f=Object.getPrototypeOf,S=Object.prototype.hasOwnProperty,v=(e,t)=>function(){return t||(0,e[m(e)[0]])((t={exports:{}}).exports,t),t.exports},y=(e,t)=>{for(var i in t)p(e,i,{get:t[i],enumerable:!0})},C=(e,t,i,n)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let r of m(t))S.call(e,r)||r===i||p(e,r,{get:()=>t[r],enumerable:!(n=g(t,r))||n.enumerable});return e},T=(e,t,i)=>(i=null!=e?u(f(e)):{},C(!t&&e&&e.__esModule?i:p(i,"default",{value:e,enumerable:!0}),e)),E=(e,t,i,n)=>{for(var r,s=n>1?void 0:n?g(t,i):t,a=e.length-1;a>=0;a--)(r=e[a])&&(s=(n?r(t,i,s):r(s))||s);return n&&s&&p(t,i,s),s},_=(e,t)=>(i,n)=>t(i,n,e),b=v({"../node_modules/axios/lib/helpers/bind.js"(e,t){"use strict";t.exports=function(e,t){return function(){for(var i=new Array(arguments.length),n=0;n<i.length;n++)i[n]=arguments[n];return e.apply(t,i)}}}}),P=v({"../node_modules/axios/lib/utils.js"(e,t){"use strict";var i=b(),n=Object.prototype.toString;function r(e){return"[object Array]"===n.call(e)}function s(e){return void 0===e}function a(e){return null!==e&&"object"==typeof e}function o(e){return"[object Function]"===n.call(e)}function l(e,t){if(null!=e)if("object"!=typeof e&&(e=[e]),r(e))for(var i=0,n=e.length;i<n;i++)t.call(null,e[i],i,e);else for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.call(null,e[s],s,e)}t.exports={isArray:r,isArrayBuffer:function(e){return"[object ArrayBuffer]"===n.call(e)},isBuffer:function(e){return null!==e&&!s(e)&&null!==e.constructor&&!s(e.constructor)&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)},isFormData:function(e){return"undefined"!=typeof FormData&&e instanceof FormData},isArrayBufferView:function(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&e.buffer instanceof ArrayBuffer},isString:function(e){return"string"==typeof e},isNumber:function(e){return"number"==typeof e},isObject:a,isUndefined:s,isDate:function(e){return"[object Date]"===n.call(e)},isFile:function(e){return"[object File]"===n.call(e)},isBlob:function(e){return"[object Blob]"===n.call(e)},isFunction:o,isStream:function(e){return a(e)&&o(e.pipe)},isURLSearchParams:function(e){return"undefined"!=typeof URLSearchParams&&e instanceof URLSearchParams},isStandardBrowserEnv:function(){return("undefined"==typeof navigator||"ReactNative"!==navigator.product&&"NativeScript"!==navigator.product&&"NS"!==navigator.product)&&"undefined"!=typeof window&&"undefined"!=typeof document},forEach:l,merge:function e(){var t={};function i(i,n){"object"==typeof t[n]&&"object"==typeof i?t[n]=e(t[n],i):t[n]=i}for(var n=0,r=arguments.length;n<r;n++)l(arguments[n],i);return t},deepMerge:function e(){var t={};function i(i,n){"object"==typeof t[n]&&"object"==typeof i?t[n]=e(t[n],i):t[n]="object"==typeof i?e({},i):i}for(var n=0,r=arguments.length;n<r;n++)l(arguments[n],i);return t},extend:function(e,t,n){return l(t,(function(t,r){e[r]=n&&"function"==typeof t?i(t,n):t})),e},trim:function(e){return e.replace(/^\s*/,"").replace(/\s*$/,"")}}}}),I=v({"../node_modules/axios/lib/helpers/buildURL.js"(e,t){"use strict";var i=P();function n(e){return encodeURIComponent(e).replace(/%40/gi,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}t.exports=function(e,t,r){if(!t)return e;var s;if(r)s=r(t);else if(i.isURLSearchParams(t))s=t.toString();else{var a=[];i.forEach(t,(function(e,t){null!=e&&(i.isArray(e)?t+="[]":e=[e],i.forEach(e,(function(e){i.isDate(e)?e=e.toISOString():i.isObject(e)&&(e=JSON.stringify(e)),a.push(n(t)+"="+n(e))})))})),s=a.join("&")}if(s){var o=e.indexOf("#");-1!==o&&(e=e.slice(0,o)),e+=(-1===e.indexOf("?")?"?":"&")+s}return e}}}),A=v({"../node_modules/axios/lib/core/InterceptorManager.js"(e,t){"use strict";var i=P();function n(){this.handlers=[]}n.prototype.use=function(e,t){return this.handlers.push({fulfilled:e,rejected:t}),this.handlers.length-1},n.prototype.eject=function(e){this.handlers[e]&&(this.handlers[e]=null)},n.prototype.forEach=function(e){i.forEach(this.handlers,(function(t){null!==t&&e(t)}))},t.exports=n}}),R=v({"../node_modules/axios/lib/core/transformData.js"(e,t){"use strict";var i=P();t.exports=function(e,t,n){return i.forEach(n,(function(i){e=i(e,t)})),e}}}),w=v({"../node_modules/axios/lib/cancel/isCancel.js"(e,t){"use strict";t.exports=function(e){return!(!e||!e.__CANCEL__)}}}),M=v({"../node_modules/axios/lib/helpers/normalizeHeaderName.js"(e,t){"use strict";var i=P();t.exports=function(e,t){i.forEach(e,(function(i,n){n!==t&&n.toUpperCase()===t.toUpperCase()&&(e[t]=i,delete e[n])}))}}}),O=v({"../node_modules/axios/lib/core/enhanceError.js"(e,t){"use strict";t.exports=function(e,t,i,n,r){return e.config=t,i&&(e.code=i),e.request=n,e.response=r,e.isAxiosError=!0,e.toJSON=function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code}},e}}}),D=v({"../node_modules/axios/lib/core/createError.js"(e,t){"use strict";var i=O();t.exports=function(e,t,n,r,s){var a=new Error(e);return i(a,t,n,r,s)}}}),k=v({"../node_modules/axios/lib/core/settle.js"(e,t){"use strict";var i=D();t.exports=function(e,t,n){var r=n.config.validateStatus;!r||r(n.status)?e(n):t(i("Request failed with status code "+n.status,n.config,null,n.request,n))}}}),N=v({"../node_modules/axios/lib/helpers/isAbsoluteURL.js"(e,t){"use strict";t.exports=function(e){return/^([a-z][a-z\d\+\-\.]*:)?\/\//i.test(e)}}}),L=v({"../node_modules/axios/lib/helpers/combineURLs.js"(e,t){"use strict";t.exports=function(e,t){return t?e.replace(/\/+$/,"")+"/"+t.replace(/^\/+/,""):e}}}),x=v({"../node_modules/axios/lib/core/buildFullPath.js"(e,t){"use strict";var i=N(),n=L();t.exports=function(e,t){return e&&!i(t)?n(e,t):t}}}),F=v({"../node_modules/axios/lib/helpers/parseHeaders.js"(e,t){"use strict";var i=P(),n=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"];t.exports=function(e){var t,r,s,a={};return e?(i.forEach(e.split("\n"),(function(e){if(s=e.indexOf(":"),t=i.trim(e.substr(0,s)).toLowerCase(),r=i.trim(e.substr(s+1)),t){if(a[t]&&n.indexOf(t)>=0)return;a[t]="set-cookie"===t?(a[t]?a[t]:[]).concat([r]):a[t]?a[t]+", "+r:r}})),a):a}}}),U=v({"../node_modules/axios/lib/helpers/isValidXss.js"(e,t){"use strict";t.exports=function(e){return/(\b)(on\w+)=|javascript|(<\s*)(\/*)script/gi.test(e)}}}),V=v({"../node_modules/axios/lib/helpers/isURLSameOrigin.js"(e,t){"use strict";var i=P(),n=U();t.exports=i.isStandardBrowserEnv()?function(){var e,t=/(msie|trident)/i.test(navigator.userAgent),r=document.createElement("a");function s(e){var i=e;if(n(e))throw new Error("URL contains XSS injection attempt");return t&&(r.setAttribute("href",i),i=r.href),r.setAttribute("href",i),{href:r.href,protocol:r.protocol?r.protocol.replace(/:$/,""):"",host:r.host,search:r.search?r.search.replace(/^\?/,""):"",hash:r.hash?r.hash.replace(/^#/,""):"",hostname:r.hostname,port:r.port,pathname:"/"===r.pathname.charAt(0)?r.pathname:"/"+r.pathname}}return e=s(window.location.href),function(t){var n=i.isString(t)?s(t):t;return n.protocol===e.protocol&&n.host===e.host}}():function(){return function(){return!0}}()}}),H=v({"../node_modules/axios/lib/helpers/cookies.js"(e,t){"use strict";var i=P();t.exports=i.isStandardBrowserEnv()?function(){return{write:function(e,t,n,r,s,a){var o=[];o.push(e+"="+encodeURIComponent(t)),i.isNumber(n)&&o.push("expires="+new Date(n).toGMTString()),i.isString(r)&&o.push("path="+r),i.isString(s)&&o.push("domain="+s),!0===a&&o.push("secure"),document.cookie=o.join("; ")},read:function(e){var t=document.cookie.match(new RegExp("(^|;\\s*)("+e+")=([^;]*)"));return t?decodeURIComponent(t[3]):null},remove:function(e){this.write(e,"",Date.now()-864e5)}}}():function(){return{write:function(){},read:function(){return null},remove:function(){}}}()}}),B=v({"../node_modules/axios/lib/adapters/xhr.js"(e,t){"use strict";var i=P(),n=k(),r=I(),s=x(),a=F(),o=V(),l=D();t.exports=function(e){return new Promise((function(t,d){var c=e.data,h=e.headers;i.isFormData(c)&&delete h["Content-Type"];var u=new XMLHttpRequest;if(e.auth){var p=e.auth.username||"",g=e.auth.password||"";h.Authorization="Basic "+btoa(p+":"+g)}var m=s(e.baseURL,e.url);if(u.open(e.method.toUpperCase(),r(m,e.params,e.paramsSerializer),!0),u.timeout=e.timeout,u.onreadystatechange=function(){if(u&&4===u.readyState&&(0!==u.status||u.responseURL&&0===u.responseURL.indexOf("file:"))){var i="getAllResponseHeaders"in u?a(u.getAllResponseHeaders()):null,r={data:e.responseType&&"text"!==e.responseType?u.response:u.responseText,status:u.status,statusText:u.statusText,headers:i,config:e,request:u};n(t,d,r),u=null}},u.onabort=function(){u&&(d(l("Request aborted",e,"ECONNABORTED",u)),u=null)},u.onerror=function(){d(l("Network Error",e,null,u)),u=null},u.ontimeout=function(){var t="timeout of "+e.timeout+"ms exceeded";e.timeoutErrorMessage&&(t=e.timeoutErrorMessage),d(l(t,e,"ECONNABORTED",u)),u=null},i.isStandardBrowserEnv()){var f=H(),S=(e.withCredentials||o(m))&&e.xsrfCookieName?f.read(e.xsrfCookieName):void 0;S&&(h[e.xsrfHeaderName]=S)}if("setRequestHeader"in u&&i.forEach(h,(function(e,t){void 0===c&&"content-type"===t.toLowerCase()?delete h[t]:u.setRequestHeader(t,e)})),i.isUndefined(e.withCredentials)||(u.withCredentials=!!e.withCredentials),e.responseType)try{u.responseType=e.responseType}catch(t){if("json"!==e.responseType)throw t}"function"==typeof e.onDownloadProgress&&u.addEventListener("progress",e.onDownloadProgress),"function"==typeof e.onUploadProgress&&u.upload&&u.upload.addEventListener("progress",e.onUploadProgress),e.cancelToken&&e.cancelToken.promise.then((function(e){u&&(u.abort(),d(e),u=null)})),void 0===c&&(c=null),u.send(c)}))}}}),$=v({"../node_modules/axios/lib/defaults.js"(e,t){"use strict";var i=P(),n=M(),r={"Content-Type":"application/x-www-form-urlencoded"};function s(e,t){!i.isUndefined(e)&&i.isUndefined(e["Content-Type"])&&(e["Content-Type"]=t)}var a,l={adapter:(("undefined"!=typeof XMLHttpRequest||void 0!==o&&"[object process]"===Object.prototype.toString.call(o))&&(a=B()),a),transformRequest:[function(e,t){return n(t,"Accept"),n(t,"Content-Type"),i.isFormData(e)||i.isArrayBuffer(e)||i.isBuffer(e)||i.isStream(e)||i.isFile(e)||i.isBlob(e)?e:i.isArrayBufferView(e)?e.buffer:i.isURLSearchParams(e)?(s(t,"application/x-www-form-urlencoded;charset=utf-8"),e.toString()):i.isObject(e)?(s(t,"application/json;charset=utf-8"),JSON.stringify(e)):e}],transformResponse:[function(e){if("string"==typeof e)try{e=JSON.parse(e)}catch(e){}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*"}}};i.forEach(["delete","get","head"],(function(e){l.headers[e]={}})),i.forEach(["post","put","patch"],(function(e){l.headers[e]=i.merge(r)})),t.exports=l}}),j=v({"../node_modules/axios/lib/core/dispatchRequest.js"(e,t){"use strict";var i=P(),n=R(),r=w(),s=$();function a(e){e.cancelToken&&e.cancelToken.throwIfRequested()}t.exports=function(e){return a(e),e.headers=e.headers||{},e.data=n(e.data,e.headers,e.transformRequest),e.headers=i.merge(e.headers.common||{},e.headers[e.method]||{},e.headers),i.forEach(["delete","get","head","post","put","patch","common"],(function(t){delete e.headers[t]})),(e.adapter||s.adapter)(e).then((function(t){return a(e),t.data=n(t.data,t.headers,e.transformResponse),t}),(function(t){return r(t)||(a(e),t&&t.response&&(t.response.data=n(t.response.data,t.response.headers,e.transformResponse))),Promise.reject(t)}))}}}),G=v({"../node_modules/axios/lib/core/mergeConfig.js"(e,t){"use strict";var i=P();t.exports=function(e,t){t=t||{};var n={},r=["url","method","params","data"],s=["headers","auth","proxy"],a=["baseURL","url","transformRequest","transformResponse","paramsSerializer","timeout","withCredentials","adapter","responseType","xsrfCookieName","xsrfHeaderName","onUploadProgress","onDownloadProgress","maxContentLength","validateStatus","maxRedirects","httpAgent","httpsAgent","cancelToken","socketPath"];i.forEach(r,(function(e){void 0!==t[e]&&(n[e]=t[e])})),i.forEach(s,(function(r){i.isObject(t[r])?n[r]=i.deepMerge(e[r],t[r]):void 0!==t[r]?n[r]=t[r]:i.isObject(e[r])?n[r]=i.deepMerge(e[r]):void 0!==e[r]&&(n[r]=e[r])})),i.forEach(a,(function(i){void 0!==t[i]?n[i]=t[i]:void 0!==e[i]&&(n[i]=e[i])}));var o=r.concat(s).concat(a),l=Object.keys(t).filter((function(e){return-1===o.indexOf(e)}));return i.forEach(l,(function(i){void 0!==t[i]?n[i]=t[i]:void 0!==e[i]&&(n[i]=e[i])})),n}}}),W=v({"../node_modules/axios/lib/core/Axios.js"(e,t){"use strict";var i=P(),n=I(),r=A(),s=j(),a=G();function o(e){this.defaults=e,this.interceptors={request:new r,response:new r}}o.prototype.request=function(e){"string"==typeof e?(e=arguments[1]||{}).url=arguments[0]:e=e||{},(e=a(this.defaults,e)).method?e.method=e.method.toLowerCase():this.defaults.method?e.method=this.defaults.method.toLowerCase():e.method="get";var t=[s,void 0],i=Promise.resolve(e);for(this.interceptors.request.forEach((function(e){t.unshift(e.fulfilled,e.rejected)})),this.interceptors.response.forEach((function(e){t.push(e.fulfilled,e.rejected)}));t.length;)i=i.then(t.shift(),t.shift());return i},o.prototype.getUri=function(e){return e=a(this.defaults,e),n(e.url,e.params,e.paramsSerializer).replace(/^\?/,"")},i.forEach(["delete","get","head","options"],(function(e){o.prototype[e]=function(t,n){return this.request(i.merge(n||{},{method:e,url:t}))}})),i.forEach(["post","put","patch"],(function(e){o.prototype[e]=function(t,n,r){return this.request(i.merge(r||{},{method:e,url:t,data:n}))}})),t.exports=o}}),q=v({"../node_modules/axios/lib/cancel/Cancel.js"(e,t){"use strict";function i(e){this.message=e}i.prototype.toString=function(){return"Cancel"+(this.message?": "+this.message:"")},i.prototype.__CANCEL__=!0,t.exports=i}}),z=v({"../node_modules/axios/lib/cancel/CancelToken.js"(e,t){"use strict";var i=q();function n(e){if("function"!=typeof e)throw new TypeError("executor must be a function.");var t;this.promise=new Promise((function(e){t=e}));var n=this;e((function(e){n.reason||(n.reason=new i(e),t(n.reason))}))}n.prototype.throwIfRequested=function(){if(this.reason)throw this.reason},n.source=function(){var e;return{token:new n((function(t){e=t})),cancel:e}},t.exports=n}}),K=v({"../node_modules/axios/lib/helpers/spread.js"(e,t){"use strict";t.exports=function(e){return function(t){return e.apply(null,t)}}}}),J=v({"../node_modules/axios/lib/axios.js"(e,t){"use strict";var i=P(),n=b(),r=W(),s=G();function a(e){var t=new r(e),s=n(r.prototype.request,t);return i.extend(s,r.prototype,t),i.extend(s,t),s}var o=a($());o.Axios=r,o.create=function(e){return a(s(o.defaults,e))},o.Cancel=q(),o.CancelToken=z(),o.isCancel=w(),o.all=function(e){return Promise.all(e)},o.spread=K(),t.exports=o,t.exports.default=o}}),Y=v({"../node_modules/axios/index.js"(e,t){t.exports=J()}}),Q=v({"../node_modules/@skype/hydra_player_hls_sdk/hydra_player_hls_sdk_bundle.js"(e,t){var i;i=function(){return function(){"use strict";var e={458:function(e,t,i){var n=this&&this.__assign||function(){return n=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},n.apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.LiveStreamStatistic=void 0;var r=i(844),s=i(68),a=i(329),o=function(){function e(e,t,i){this.name=e,this.stopCrash=t,this.start(i)}return e.prototype.complete=function(){try{a.assert(this.startTime,"not started",this.stopCrash),a.assert(void 0===this.duration,"already completed",this.stopCrash)}catch(e){if(this.name!==r.PlayerScenarioType.LoadHlsFirstFragment&&this.name!==r.PlayerScenarioType.HlsKeyLoad)throw e}this.duration=Date.now()-this.startTime},e.prototype.fail=function(e){this.failReason=e,this.complete()},e.prototype.setDetail=function(e){this.details=e},e.prototype.getTelemetryEvent=function(){a.assert(this.startTime,"not started",this.stopCrash);var e={name:this.name,startTime:this.startTime,duration:this.duration};return this.failReason&&(e.failReason=this.failReason),this.details&&(e.details=this.details),e},e.prototype.getName=function(){return this.name},e.prototype.getDuration=function(){var e;return null!==(e=this.duration)&&void 0!==e?e:0},e.prototype.getFailReason=function(){return this.failReason},e.prototype.getDetails=function(){return this.details},e.prototype.start=function(e){a.assert(!this.startTime,"already started",this.stopCrash),this.startTime=Date.now(),e&&(this.details=e)},e.prototype.updateDetails=function(e,t){if(this.details&&"object"==typeof this.details)for(var i=0;i<e.length;i++)this.details[e[i]]=t[i]},e}(),l=function(){function e(e,t,i,n,r){this.config=e,this.logFn=t,this.playerDiagnosticsLog=i,this.playerMetadata=n,this.hydraInitResult=r,this.currentScenarioMap=new Map,this.playerEvents=[],this.playbackEvents=[],this.experimentalEvents=[],this.callSetupSucceeded=!1,this.callDropped=!1,this.clientNetworkType=void 0,this.maxPlayerPlaybackEventCount=e.maxPlayerPlaybackEventCount||5,this.maxPlayerDiagnosticsCount=e.maxPlayerDiagnosticsCount||5,this.maxPlayerMemoryTraceLogCount=e.maxPlayerMemoryTraceLogCount||100,this.maxPlayerExperimentalEvents=e.maxPlayerExperimentalEvents||100,a.getECSSetting(this.config,"stopCrash",!1)?this.stopCrash=!1:this.stopCrash=!0,this.config.debugLogging&&(this.playerDiagnosticsLog.memoryLog=[]),this.addNetworkTypeEventListener()}return e.prototype.getPlayerDiagnosticSnapshot=function(){return this.currentPlayerDiagnosticSnapshot},e.prototype.registerStatsUpdated=function(e){var t=this;this.currentPlayerDiagnosticSnapshot=e,Object.keys(this.playerDiagnosticsLog).forEach((function(i){var n,r=i,s=null!==(n=t.playerDiagnosticsLog[i])&&void 0!==n?n:[];if(Array.isArray(s)){s.push(e[r]);var a="memoryLog"===r&&s.length>t.maxPlayerMemoryTraceLogCount,o="memoryLog"!==r&&s.length>t.maxPlayerDiagnosticsCount;(a||o)&&s.splice(0,1)}else t.playerDiagnosticsLog[i]=e[r]}))},e.prototype.registerEventLoadAttempt=function(e,t){this.registerScenario(e,t)},e.prototype.registerEventLoadFailed=function(e,t){this.completeScenario(e,t)},e.prototype.registerEventLoadSucceeded=function(e,t){this.completeScenario(e,void 0,t),e===r.PlayerScenarioType.LoadPlayer&&(this.callSetupSucceeded=!0)},e.prototype.registerSdnPluginLoadAttempt=function(e){this.registerScenario(r.PlayerScenarioType.SdnPluginLoad,JSON.stringify(e))},e.prototype.registerSdnPluginLoadFailed=function(e){this.completeScenario(r.PlayerScenarioType.SdnPluginLoad,e)},e.prototype.registerSdnPluginLoadSucceeded=function(){this.completeScenario(r.PlayerScenarioType.SdnPluginLoad)},e.prototype.registerStreamConnectionAttempt=function(e){this.registerScenario(r.PlayerScenarioType.StreamConnection,{streamUrl:e})},e.prototype.registerStreamConnectionSucceeded=function(e){var t=this.getScenario(r.PlayerScenarioType.StreamConnection);null==t||t.updateDetails(["results"],[a.stringifyObject(e)]),this.completeScenario(r.PlayerScenarioType.StreamConnection)},e.prototype.registerStreamConnectionFailed=function(e,t){var i=this.getScenario(r.PlayerScenarioType.StreamConnection);null==i||i.updateDetails(["results"],[a.stringifyObject(t)]),this.completeScenario(r.PlayerScenarioType.StreamConnection,e)},e.prototype.registerSetSourceAttempt=function(e,t,i){var n=e||"";i&&(n={src:e||"",isPrimary:a.stringifyObject(t),reason:i}),this.registerScenario(r.PlayerScenarioType.SetSource,n)},e.prototype.registerSetSourceSucceeded=function(e,t,i,n){var s=this.getScenario(r.PlayerScenarioType.SetSource);a.assert(s,"no SetSource scenario to update details",this.stopCrash),null==s||s.updateDetails(["src","isPrimary","SwitchingDiagnostics","StepDuration"],[e,a.stringifyObject(t),a.stringifyObject(i),a.stringifyObject(n)]),this.completeScenario(r.PlayerScenarioType.SetSource)},e.prototype.registerSetSourceFailed=function(e,t,i,n,s){var o=null!=t?t:"Failed to find stream url",l=this.getScenario(r.PlayerScenarioType.SetSource);a.assert(l,"no SetSource scenario to update details",this.stopCrash),null==l||l.updateDetails(["src","isPrimary","SwitchingDiagnostics","stepDuration"],[o,a.stringifyObject(i),a.stringifyObject(n),a.stringifyObject(s)]),this.completeScenario(r.PlayerScenarioType.SetSource,e)},e.prototype.registerPlayerDestroyed=function(e){this.registerScenario(r.PlayerScenarioType.Destroyed,e),this.completeScenario(r.PlayerScenarioType.Destroyed)},e.prototype.registerPlaybackStateChanged=function(e){e!==s.HydraPlayerPlaybackState.CanPlayThrough||this.firstReadyStateTimestamp?e!==s.HydraPlayerPlaybackState.Playing||this.firstPlayingStateTimestamp||(this.firstPlayingStateTimestamp=Date.now()):this.firstReadyStateTimestamp=Date.now(),this.registerPlaybackEvent(r.TelemetryEventType.StateChanged,e)},e.prototype.registerHydraInputStateChanged=function(e,t){this.registerPlaybackEvent(r.TelemetryEventType.HydraInputStateChanged,e,t)},e.prototype.registerHydraOutputStateChanged=function(e,t){this.registerPlaybackEvent(r.TelemetryEventType.HydraOutputStateChanged,e,t)},e.prototype.registerPlaybackBuffering=function(e){this.registerPlaybackEvent(r.TelemetryEventType.Buffering,e)},e.prototype.registerPlaybackError=function(e,t,i){this.registerPlaybackEvent(r.TelemetryEventType.Error,{errorType:e,details:t,errorSource:i})},e.prototype.registerIgnoredPlaybackError=function(e){this.registerPlaybackEvent(r.TelemetryEventType.IgnoredError,e)},e.prototype.registerDownloadBitrateChanged=function(e){this.registerPlaybackEvent(r.TelemetryEventType.BitrateChangedDownload,e)},e.prototype.registerStreamOptionsConfigured=function(e,t){this.registerPlaybackEvent(r.TelemetryEventType.StreamOptionsConfigured,e,t)},e.prototype.registerPlaybackBitrateChanged=function(e){this.registerPlaybackEvent(r.TelemetryEventType.BitrateChangedPlayback,e)},e.prototype.registerVolumeChange=function(e){this.registerPlaybackEvent(r.TelemetryEventType.Volume,e)},e.prototype.getSnapshotReport=function(){var e,t,i=[this.getTotalLoadEvent(),this.getHydraLoadEvent()].concat(this.playerEvents.map((function(e){return e.getTelemetryEvent()}))),r=this.playbackEvents,s={};return this.currentPlayerDiagnosticSnapshot&&(s=this.filterAndPrepareTelemetry()),n(n(n(n(n(n(n(n(n(n(n(n(n({isFullReport:!1,configIds:this.config.configIds||"",eTag:this.config.eTag||""},this.getPlayerMetadataReport()),{isIframe:!0,isFullscreenButtonDisabled:!1,telemetryTickMs:null!==(t=null===(e=this.currentPlayerDiagnosticSnapshot)||void 0===e?void 0:e.statsInterval)&&void 0!==t?t:-1}),this.getHydraInitializationReport()),this.getPlayerInitializationReport(i,r)),this.getHydraInternalReport(r)),this.getPlaybackReport(r)),this.getBitrateReport(r)),this.getStreamConnectionReport(i)),this.getSdnReport(i)),this.getSetSourceReport(i)),this.getExperimentalEvents()),{networkType:this.getClientNetworkType(),callSetupSucceeded:this.callSetupSucceeded,callDropped:this.callDropped}),s)},e.prototype.getReport=function(){var e,t,i=[this.getTotalLoadEvent(),this.getHydraLoadEvent()].concat(this.playerEvents.map((function(e){return e.getTelemetryEvent()}))),r=this.playbackEvents;return n(n(n(n(n(n(n(n(n(n(n(n(n({isFullReport:!0,configIds:this.config.configIds||"",eTag:this.config.eTag||""},this.getPlayerMetadataReport()),{isIframe:!0,isFullscreenButtonDisabled:!1,telemetryTickMs:null!==(t=null===(e=this.currentPlayerDiagnosticSnapshot)||void 0===e?void 0:e.statsInterval)&&void 0!==t?t:-1}),this.getHydraInitializationReport()),this.getPlayerInitializationReport(i,r)),this.getHydraInternalReport(r)),this.getPlaybackReport(r)),this.getBitrateReport(r)),this.getStreamConnectionReport(i)),this.getSdnReport(i)),this.getSetSourceReport(i)),this.getExperimentalEvents()),{networkType:this.getClientNetworkType(),callSetupSucceeded:this.callSetupSucceeded,callDropped:this.callDropped}),this.getPlayerDiagnosticLog())},e.prototype.getHydraLoadEvent=function(){var e,t,i,n={name:r.PlayerScenarioType.LoadHydra,startTime:(null===(e=this.hydraInitResult)||void 0===e?void 0:e.initStartTime)||-1,duration:(null===(t=this.hydraInitResult)||void 0===t?void 0:t.initDuration)||0};(null===(i=this.hydraInitResult)||void 0===i?void 0:i.errorMsg)&&(n.failReason=this.hydraInitResult.errorMsg);var s=this.getHydraRuntimeDownloadDetails();return s&&(n.details=s),n},e.prototype.getHydraRuntimeDownloadDetails=function(){if(this.hydraInitResult){for(var e=[],t=0,i=this.hydraInitResult.runtimeDownloadResults;t<i.length;t++){var n=i[t],r={success:n.success,url:n.url,startTime:n.startTime,duration:n.duration,trackingReference:n.trackingReference,timeTakenToDownloadScript:n.timeTakenToDownloadScript};n.errorMsg&&(r.errorMsg=n.errorMsg),e.push(r)}return a.stringifyObject(e)}return null},e.prototype.getTotalLoadEvent=function(){var e,t,i,n=this.playerEvents.find((function(e){return e.getName()===r.PlayerScenarioType.LoadPlayer})),s=(null===(e=this.hydraInitResult)||void 0===e?void 0:e.initDuration)||0,a=(null==n?void 0:n.getDuration())||0,o=null==n?void 0:n.getFailReason(),l={name:r.PlayerScenarioType.Load,startTime:(null===(t=this.hydraInitResult)||void 0===t?void 0:t.initStartTime)||-1,duration:s+a};return(null===(i=this.hydraInitResult)||void 0===i?void 0:i.errorMsg)?l.failReason=this.hydraInitResult.errorMsg:o&&(l.failReason=o),l},e.prototype.getPlayerMetadataReport=function(){return{playerId:this.playerMetadata.playerId||"",traceId:this.playerMetadata.playerId?this.playerMetadata.playerId.replace(/-/g,""):"",hydraPlayerRuntimeVersion:this.playerMetadata.hydraPlayerRuntimeVersion||"",hydraPlayerSdkVersion:this.playerMetadata.hydraPlayerSdkVersion,player_playerType:this.playerMetadata.hydraPlayerType}},e.prototype.registerPlaybackEvent=function(e,t,i){var n=this.createTelemetryEvent(e,t,i);e===r.TelemetryEventType.Error&&(null==t?void 0:t.errorType)!==s.HydraPlayerPlaybackErrorType.PlaybackRetried&&(n.fatal=!0,this.callDropped=!0),this.playbackEvents.push(n),this.playbackEvents.length>this.maxPlayerPlaybackEventCount&&this.playbackEvents.splice(0,1),this.logTelemetryEvent(n)},e.prototype.getPlayerDiagnosticLog=function(){var e=this;if(!this.currentPlayerDiagnosticSnapshot)return{};var t=this.currentPlayerDiagnosticSnapshot,i=this.playerDiagnosticsLog,r=n(n({},t),i),s={};return Object.keys(r).forEach((function(t){s["player_".concat(t)]=e.prepareForTelemetry(r[t])})),s},e.prototype.getHydraInitializationReport=function(){var e,t,i,n;return{hydraInit_succeeded:(null===(e=this.hydraInitResult)||void 0===e?void 0:e.initSucceeded)||!1,hydraInit_startTime:(null===(t=this.hydraInitResult)||void 0===t?void 0:t.initStartTime)||-1,hydraInit_errorMessage:(null===(i=this.hydraInitResult)||void 0===i?void 0:i.errorMsg)||"",hydraInit_duration:(null===(n=this.hydraInitResult)||void 0===n?void 0:n.initDuration)||0}},e.prototype.getPlayerInitializationReport=function(e,t){var i=e.find((function(e){return e.name===r.PlayerScenarioType.Load}));return{init_timeLoadToStreamConnectionEstablished:(null!=i&&this.initialStreamConnectionEstablishedTimestamp?this.initialStreamConnectionEstablishedTimestamp-i.startTime:-1)||-1,init_timeLoadToReady:(null!=i&&this.firstReadyStateTimestamp?this.firstReadyStateTimestamp-i.startTime:-1)||-1,init_timeLoadToPlaying:(null!=i&&this.firstPlayingStateTimestamp?this.firstPlayingStateTimestamp-i.startTime:-1)||-1,init_allEvents:this.prepareForTelemetry(e)}},e.prototype.getHydraInternalReport=function(e){var t=e.filter((function(e){return e.eventType===r.TelemetryEventType.HydraInputStateChanged})),i=e.filter((function(e){return e.eventType===r.TelemetryEventType.HydraOutputStateChanged}));return{hydra_inputStateChangeEvents:this.prepareForTelemetry(t),hydra_outputStateChangeEvents:this.prepareForTelemetry(i)}},e.prototype.getPlaybackReport=function(e){var t=e.filter((function(e){return e.eventType===r.TelemetryEventType.StateChanged})),i=t.find((function(e){return e.payload===s.HydraPlayerPlaybackState.CanPlayThrough})),n=t.find((function(e){return e.payload===s.HydraPlayerPlaybackState.Play})),a=t.find((function(e){return e.payload===s.HydraPlayerPlaybackState.Start})),o=t.find((function(e){return e.payload===s.HydraPlayerPlaybackState.Playing})),l=null!=i&&null!=n?n.timestamp-i.timestamp:-1,d=null!=n&&null!=a?a.timestamp-n.timestamp:-1,c=null!=a&&null!=o?o.timestamp-a.timestamp:-1,h=t.filter((function(e){return e.payload===s.HydraPlayerPlaybackState.Seeked})),u=t.filter((function(e){return e.payload===s.HydraPlayerPlaybackState.Seeking})),p=t.filter((function(e){return e.payload===s.HydraPlayerPlaybackState.Pause})),g=t.filter((function(e){return e.payload===s.HydraPlayerPlaybackState.Waiting})),m=[r.TelemetryEventType.BitrateChangedDownload,r.TelemetryEventType.BitrateChangedPlayback,r.TelemetryEventType.Error,r.TelemetryEventType.Mute,r.TelemetryEventType.StateChanged,r.TelemetryEventType.Volume,r.TelemetryEventType.StreamOptionsConfigured,r.TelemetryEventType.IgnoredError],f=e.filter((function(e){return e.eventType===r.TelemetryEventType.Error})),S=e.filter((function(e){return e.eventType===r.TelemetryEventType.IgnoredError})),v=e.filter((function(e){return e.eventType===r.TelemetryEventType.Volume||e.eventType===r.TelemetryEventType.Mute})),y=e.filter((function(e){return e.eventType===r.TelemetryEventType.StreamOptionsConfigured})),C=e.filter((function(e){return!m.includes(e.eventType)}));return{playback_timeReadyToPlay:l,playback_timePlayToStart:d,playback_timeStartToPlaying:c,playback_bufferingEvents:this.prepareForTelemetry(g),playback_errorEvents:this.prepareForTelemetry(f),playback_ignoredErrorEvents:this.prepareForTelemetry(S),playback_pauseEvents:this.prepareForTelemetry(p),playback_otherEvents:this.prepareForTelemetry(C),playback_seekedEvents:this.prepareForTelemetry(h),playback_seekingEvents:this.prepareForTelemetry(u),playback_stateChangeEvents:this.prepareForTelemetry(t),playback_volumeEvents:this.prepareForTelemetry(v),playback_streamOptionsConfiguredEvents:this.prepareForTelemetry(y)}},e.prototype.getBitrateReport=function(e){var t,i,s,a,o=e.filter((function(e){return e.eventType===r.TelemetryEventType.BitrateChangedDownload})),l=o.sort((function(e){return Number(e.payload)})),d=o.length>0?{bitrate_downloadChanges:this.prepareForTelemetry(o),bitrate_downloadChangeCount:o.length>0||-1,bitrate_downloadMin:(null===(t=l[0])||void 0===t?void 0:t.payload)||-1,bitrate_downloadMax:(null===(i=l[l.length-1])||void 0===i?void 0:i.payload)||-1}:{},c=e.filter((function(e){return e.eventType===r.TelemetryEventType.BitrateChangedPlayback})),h=c.sort((function(e){return Number(e.payload)})),u=c.length>0?{bitrate_playbackChanges:this.prepareForTelemetry(c),bitrate_playbackChangeCount:c.length>0||-1,bitrate_playbackMin:(null===(s=h[0])||void 0===s?void 0:s.payload)||-1,bitrate_playbackMax:(null===(a=h[h.length-1])||void 0===a?void 0:a.payload)||-1}:{};return n(n({},d),u)},e.prototype.addNetworkTypeEventListener=function(){var e,t,i,n,r=this;(null===(t=null===(e=window.navigator)||void 0===e?void 0:e.connection)||void 0===t?void 0:t.type)&&(null===(n=null===(i=window.navigator)||void 0===i?void 0:i.connection)||void 0===n||n.addEventListener("change",(function(){r.updateClientNetworkType()})))},e.prototype.updateClientNetworkType=function(){this.clientNetworkType=void 0,this.getClientNetworkType()},e.prototype.getClientNetworkType=function(){var e,t,i,n;if(void 0===this.clientNetworkType){var r="Unknown";if(null===(t=null===(e=window.navigator)||void 0===e?void 0:e.connection)||void 0===t?void 0:t.type)switch(null===(n=null===(i=window.navigator)||void 0===i?void 0:i.connection)||void 0===n?void 0:n.type){case"cellular":r="WWAN";break;case"ethernet":r="Wired";break;case"wifi":r="Wireless";break;default:r="Unknown"}this.clientNetworkType=r}return this.clientNetworkType},e.prototype.getSdnReport=function(e){var t,i,n=e.filter((function(e){return e.name===r.PlayerScenarioType.SdnPluginLoad})),s=n.length>0?n[n.length-1]:void 0;return{sdn_loaded:!(null==s||void 0!==s.failReason),sdn_details:null!==(t=null==s?void 0:s.details)&&void 0!==t?t:"",sdn_error:null!==(i=null==s?void 0:s.failReason)&&void 0!==i?i:"",sdn_events:this.prepareForTelemetry(n)}},e.prototype.getStreamConnectionReport=function(e){var t=e.filter((function(e){return e.name===r.PlayerScenarioType.StreamConnection}));return{stream_connection_events:this.prepareForTelemetry(t)}},e.prototype.getSetSourceReport=function(e){var t=e.filter((function(e){return e.name===r.PlayerScenarioType.SetSource}));return{set_source_events:this.prepareForTelemetry(t)}},e.prototype.registerScenario=function(e,t){var i=this.currentScenarioMap.get(e),n=new o(e,this.stopCrash,t);try{a.assert(null==i,"previous scenario:".concat(a.stringifyObject(i)," is not completed, new scenario:").concat(a.stringifyObject(n)),this.stopCrash)}catch(t){if(e!==r.PlayerScenarioType.LoadHlsFirstFragment&&e!==r.PlayerScenarioType.HlsKeyLoad)throw t}this.currentScenarioMap.set(e,n),this.playerEvents.push(n)},e.prototype.completeScenario=function(e,t,i){var n=this.currentScenarioMap.get(e);try{a.assert(n,"no scenario to complete",this.stopCrash)}catch(t){if(e!==r.PlayerScenarioType.LoadHlsFirstFragment&&e!==r.PlayerScenarioType.HlsKeyLoad)throw t}t?null==n||n.fail(t):(e!==r.PlayerScenarioType.StreamConnection||this.initialStreamConnectionEstablishedTimestamp||(this.initialStreamConnectionEstablishedTimestamp=Date.now()),i&&(null==n||n.setDetail(i)),null==n||n.complete()),this.currentScenarioMap.delete(e)},e.prototype.logTelemetryEvent=function(e){this.config.debugLogging&&(this.logFn("debug","PlayerTelemetryEvent: ".concat(JSON.stringify(e))),this.logFn("debug","PlayerDiagnosticData: ".concat(JSON.stringify(this.currentPlayerDiagnosticSnapshot))))},e.prototype.filterAndPrepareTelemetry=function(){var e=this,t=new Set;t.add("serviceLatencyCdg"),t.add("endToEndLatencyCdg"),t.add("videoEdgeLatencyCdg");var i={};return Object.keys(this.currentPlayerDiagnosticSnapshot).forEach((function(n){t.has(n)||(i["player_".concat(n)]=e.prepareForTelemetry(e.currentPlayerDiagnosticSnapshot[n]))})),i},e.prototype.prepareForTelemetry=function(e){return"boolean"==typeof e?e:"string"==typeof e||void 0===e?e||"":"number"==typeof e?null!=e?e:-1:JSON.stringify(e)},e.prototype.getScenario=function(e){return this.currentScenarioMap.get(e)},e.prototype.createTelemetryEvent=function(e,t,i){var n,r,s={eventType:e,timestamp:Date.now(),currentPlayPosition:null!==(r=null===(n=this.currentPlayerDiagnosticSnapshot)||void 0===n?void 0:n.currentPlayPosition)&&void 0!==r?r:-1};return void 0!==t&&(s.payload=this.prepareForTelemetry(t)),s.message=i,s},e.prototype.registerExperimentalEvent=function(e,t,i){var n=this.createTelemetryEvent(e,t,i);this.experimentalEvents.push(n),this.experimentalEvents.length>this.maxPlayerExperimentalEvents&&this.experimentalEvents.splice(0,1),this.logTelemetryEvent(n)},e.prototype.getExperimentalEvents=function(){return{playback_experimentalEvents:this.prepareForTelemetry(this.experimentalEvents)}},e}();t.LiveStreamStatistic=l},751:function(e,t){var i,n,r,s,a,o;Object.defineProperty(t,"__esModule",{value:!0}),t.HydraPlayerType=t.HydraStreamingEventType=t.HydraPlayerPlaybackErrorType=t.HydraPlayerPlaybackState=t.HydraPlayerSetupErrorType=t.HydraStreamDeliveryPipeline=void 0,(o=t.HydraStreamDeliveryPipeline||(t.HydraStreamDeliveryPipeline={})).AMS="AMS",o.HLS="MiddleLaneHttpLiveStreaming",o.Ums="MiddleLaneUltraLowLatency",(a=t.HydraPlayerSetupErrorType||(t.HydraPlayerSetupErrorType={})).MultiplePlayerLoad="MultiplePlayerLoad",a.PlayerInitializationFailed="PlayerInitializationFailed",a.InvalidStream="InvalidStream",a.SetSourceFailed="SetSourceFailed",(s=t.HydraPlayerPlaybackState||(t.HydraPlayerPlaybackState={})).LoadStart="loadstart",s.LoadedData="loadeddata",s.LoadedMetadata="loadedmetadata",s.Start="start",s.CanPlayThrough="canplaythrough",s.Play="play",s.Playing="playing",s.Pause="pause",s.Waiting="waiting",s.Seeking="seeking",s.Seeked="seeked",s.Ended="ended",s.Error="error",s.Destroyed="destroyed",s.Initialized="initialized",s.Stalled="stalled",s.VolumeChange="volumechange",s.PlaybackBitrateChanged="playbackbitratechanged",s.DownloadBitrateChanged="downloadbitratechanged",s.HlsKeyLoading="hlsKeyLoading",s.HlsKeyLoaded="hlsKeyLoaded",s.HlsKeyLoadedFailed="hlsKeyLoadedFailed",s.HlsManifestLoading="hlsManifestLoading",s.HlsManifestLoaded="hlsManifestLoaded",s.HlsManifestLoadedFailed="hlsManifestLoadedFailed",s.HlsFirstFragmentLoading="hlsFragLoading",s.HlsFirstFragmentBuffered="hlsFragBuffered",s.HlsFirstFragmentLoadFailed="hlsFirstFragmentLoadFailed",s.Online="online",s.Offline="offline",s.NetworkChange="networkChange",(r=t.HydraPlayerPlaybackErrorType||(t.HydraPlayerPlaybackErrorType={})).UnsupportedPlatform="UnsupportedPlatform",r.NetworkError="NetworkError",r.PlaybackRetried="PlaybackRetried",r.PlaybackError="PlaybackError",r.Unknown="Unknown",(n=t.HydraStreamingEventType||(t.HydraStreamingEventType={})).TLE="TLE",n.Overflow="Overflow",n.TownHallBasic="TownHall_Basic",n.TownHallPremium="TownHall_Premium",n.TownHall="TownHall",(i=t.HydraPlayerType||(t.HydraPlayerType={}))[i.Hls=1]="Hls",i[i.Ums=2]="Ums"},855:function(e,t,i){var n=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),r=this&&this.__exportStar||function(e,t){for(var i in e)"default"===i||Object.prototype.hasOwnProperty.call(t,i)||n(t,e,i)};Object.defineProperty(t,"__esModule",{value:!0}),r(i(952),t),r(i(751),t)},952:function(e,t,i){var n=this&&this.__assign||function(){return n=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},n.apply(this,arguments)},r=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function a(e){try{l(n.next(e))}catch(e){s(e)}}function o(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,o)}l((n=n.apply(e,t||[])).next())}))},s=this&&this.__generator||function(e,t){var i,n,r,s,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return s={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function o(o){return function(l){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;s&&(s=0,o[0]&&(a=0)),a;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,n=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(6===o[0]&&a.label<r[1]){a.label=r[1],r=o;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(o);break}r[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(e){o=[6,e],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,l])}}},a=this&&this.__spreadArray||function(e,t,i){if(i||2===arguments.length)for(var n,r=0,s=t.length;r<s;r++)!n&&r in t||(n||(n=Array.prototype.slice.call(t,0,r)),n[r]=t[r]);return e.concat(n||Array.prototype.slice.call(t))};Object.defineProperty(t,"__esModule",{value:!0}),t.HlsHydraPlayer=t.getSdkVersion=void 0;var o=i(124),l=i(68),d=i(328),c=i(844),h=i(944),u=i(329),p=i(63),g=i(458);t.getSdkVersion=function(){return"4.2488.1"};var m=function(){function e(e,t){this.playerSettings=e,this.eventHandler=t,this.spinner=null,this.commandResultsMap=new Map,this._onMessage=this.onMessage.bind(this),this.telemetryReportHandler=null,this.playerInternalEventHandler=null,this.playerRuntimeJsUrls=this.getRuntimeJsUrls(),this.playerSettings.hydraPlayerSdkVersion="4.2488.1"}return Object.defineProperty(e.prototype,"contextWindow",{get:function(){var e;return null===(e=this.container)||void 0===e?void 0:e.ownerDocument.defaultView},enumerable:!1,configurable:!0}),e.prototype.getRuntimeJsUrls=function(){if(!Array.isArray(this.playerSettings.playerRuntimeJsUrls)){var e=(0,u.getMajorFromVersion)("4.2488.1");return e&&this.playerSettings.playerRuntimeJsUrls[e]||[]}return this.playerSettings.playerRuntimeJsUrls},e.prototype.initializeIFrame=function(e){return r(this,void 0,void 0,(function(){var t;return s(this,(function(i){switch(i.label){case 0:return this.container=e,0===this.playerRuntimeJsUrls.length?[2,{initSucceeded:!1,initStartTime:Date.now(),initDuration:0,runtimeDownloadResults:[],errorMsg:"No compatible runtime URL provided for version ".concat("4.2488.1",', URLs: "').concat((0,u.stringifyObject)(this.playerSettings.playerRuntimeJsUrls),'"')}]:[4,(0,u.createIFrame)(e,this.playerRuntimeJsUrls,this.playerSettings.maxRetryCountForLoadingResources,this.playerSettings.disableSandbox,this.playerSettings.hydraRuntimeFetchTimeout)];case 1:return(t=i.sent()).initResult.initSucceeded&&t.iframe&&(this.iframe=t.iframe,this.contextWindow.addEventListener("message",this._onMessage)),[2,t.initResult]}}))}))},e.prototype.setup=function(e){return r(this,void 0,void 0,(function(){var t;return s(this,(function(i){switch(i.label){case 0:return this.spinner=new u.Spinner(e),[4,this.initializeIFrame(e)];case 1:return t=i.sent(),this.telemetryReportHandler=new S(this.playerSettings,this.eventHandler.log.bind(this.eventHandler),t,this.spinner),this.playerInternalEventHandler=new f(this.spinner,this.telemetryReportHandler),t.initSucceeded?[4,this.sendCommand("createHlsHydraPlayer",this.playerSettings,t)]:[3,3];case 2:return i.sent(),[2,!0];case 3:return this.eventHandler.log("error","Failed to setup HydraPlayer: ".concat(t.errorMsg)),this.spinner.hide(),[2,!1]}}))}))},e.prototype.isIFrameCommunicationActive=function(){var e;return!!(null===(e=this.iframe)||void 0===e?void 0:e.contentWindow)&&!!this.contextWindow},e.prototype.getFullTelemetryReport=function(){var e;return(null===(e=this.telemetryReportHandler)||void 0===e?void 0:e.getFullTelemetryReport())||{}},e.prototype.getSnapshotTelemetryReport=function(){var e;return(null===(e=this.telemetryReportHandler)||void 0===e?void 0:e.getSnapshotTelemetryReport())||{}},e.prototype.callPlayerApi=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];return r(this,void 0,void 0,(function(){return s(this,(function(i){switch(i.label){case 0:return this.iframe?[4,this.sendCommand.apply(this,a([e],t,!1))]:[3,2];case 1:case 3:return[2,i.sent()];case 2:return[4,Promise.reject(new Error("Hydra IFrame not initialized yet"))]}}))}))},e.prototype.dispose=function(){var e;null===(e=this.telemetryReportHandler)||void 0===e||e.addDisposeTelemetry(),this.isIFrameCommunicationActive()&&this.sendCommand("disposeHydraPlayer")},e.prototype.release=function(){var e;null===(e=this.spinner)||void 0===e||e.hide(),this.contextWindow&&this.contextWindow.removeEventListener("message",this._onMessage),this.iframe&&this.container&&this.container.hasChildNodes()&&this.container.removeChild(this.iframe)},e.prototype.sendCommand=function(e){for(var t,i,n=[],a=1;a<arguments.length;a++)n[a-1]=arguments[a];return r(this,void 0,void 0,(function(){var r,a,l;return s(this,(function(s){switch(s.label){case 0:if(r={msgType:o.MessageType.Command,name:e,args:n},!this.isIFrameCommunicationActive())throw new Error("IFrame MessageAPI communication not active");return void 0!==(a=this.commandResultsMap.get(e.toString()))&&a.reject(new Error("function ".concat(e," is invoked again, before previous call is completed"))),l=h.defer(),this.commandResultsMap.set(e,l),null===(i=null===(t=this.iframe)||void 0===t?void 0:t.contentWindow)||void 0===i||i.postMessage(r,"*"),[4,l.promise];case 1:return[2,s.sent()]}}))}))},e.prototype.onMessage=function(e){switch(e.data.msgType){case o.MessageType.PlayerEvent:this.processPlayerEvent(e.data);break;case o.MessageType.InternalPlayerEvent:this.processInternalPlayerEvent(e.data);break;case o.MessageType.CommandSuccessResult:this.processCommandSuccessResult(e.data);break;case o.MessageType.CommandFailureResult:this.processCommandFailureResult(e.data)}},e.prototype.processCommandSuccessResult=function(e){var t=this.commandResultsMap.get(e.name.toString());void 0!==t&&(t.resolve(e.result),this.commandResultsMap.delete(e.name.toString()))},e.prototype.processCommandFailureResult=function(e){var t=this.commandResultsMap.get(e.name.toString());void 0!==t&&(t.reject(e.error),this.commandResultsMap.delete(e.name.toString()))},e.prototype.processPlayerEvent=function(e){this.eventHandler[e.name].apply(this.eventHandler,e.args)},e.prototype.processInternalPlayerEvent=function(e){this.playerInternalEventHandler&&this.playerInternalEventHandler[e.name].apply(this,e.args)},e}();t.HlsHydraPlayer=m;var f=function(){function e(e,t){this.spinner=e,this.telemetryReportHandler=t}return e.prototype.firstPlayerLoadAttemptDone=function(){this.spinner.hide()},e.prototype.fullTelemetryReportUpdated=function(e){this.telemetryReportHandler.setFullTelemetryReport(e)},e.prototype.snapshotTelemetryReportUpdated=function(e){this.telemetryReportHandler.setSnapshotTelemetryReport(e)},e}(),S=function(){function e(e,t,i,n){var r=this;this.logFn=t,this.spinner=n;var s=new g.LiveStreamStatistic(e,(function(e,t){r.logFn(e,t)}),{perceivedBandwidth:[],videoBufferLength:[],videoCachedLength:[],videoEdgeLatency:[],playerHeight:[],playerWidth:[],mediaHeight:[],mediaWidth:[],windowHeight:[],windowWidth:[],playbackRate:[],currentPlayPosition:[],statsInterval:[],serviceAvgLatency:[],endToEndAvgLatency:[]},{hydraPlayerSdkVersion:e.hydraPlayerSdkVersion||"Unknown",hydraPlayerType:d.HydraPlayerType.Hls},i);this.fullTelemetryReport=s.getReport(),this.snapshotTelemetryReport=s.getSnapshotReport()}return e.prototype.getFullTelemetryReport=function(){return this.fullTelemetryReport},e.prototype.getSnapshotTelemetryReport=function(){return this.snapshotTelemetryReport},e.prototype.setFullTelemetryReport=function(e){var t,i,r;this.fullTelemetryReport=n(n({},e),{init_spinnerShowTimestamp:null!==(t=this.spinner.firstShowTimestamp)&&void 0!==t?t:-1,init_spinnerHideTimestamp:null!==(i=this.spinner.firstHideTimestamp)&&void 0!==i?i:-1,init_spinnerDuration:null!==(r=this.spinner.firstSpinnerDuration)&&void 0!==r?r:-1,init_spinnerVisible:this.spinner.isVisible()})},e.prototype.setSnapshotTelemetryReport=function(e){var t,i,r;this.snapshotTelemetryReport=n(n({},e),{init_spinnerShowTimestamp:null!==(t=this.spinner.firstShowTimestamp)&&void 0!==t?t:-1,init_spinnerHideTimestamp:null!==(i=this.spinner.firstHideTimestamp)&&void 0!==i?i:-1,init_spinnerDuration:null!==(r=this.spinner.firstSpinnerDuration)&&void 0!==r?r:-1,init_spinnerVisible:this.spinner.isVisible()})},e.prototype.addDisposeTelemetry=function(){var e=Date.now();try{this.updateInitEventsWithDisposeEvent(this.fullTelemetryReport,e)}catch(e){this.logFn("warn","Failed to add player destroyed information to init_allEvents telemetry field in full telemetry report")}try{this.updateInitEventsWithDisposeEvent(this.snapshotTelemetryReport,e)}catch(e){this.logFn("warn","Failed to add player destroyed information to init_allEvents telemetry field in snapshot telemetry report")}try{this.updateStateChangeEventsWithDisposeEvent(this.fullTelemetryReport,e)}catch(e){this.logFn("warn","Failed to add player destroyed information to playback_stateChangeEvents telemetry field in full telemetry report")}try{this.updateStateChangeEventsWithDisposeEvent(this.snapshotTelemetryReport,e)}catch(e){this.logFn("warn","Failed to add player destroyed information to playback_stateChangeEvents telemetry field in snapshot telemetry report")}this.fullTelemetryReport.hydraDisposeTimestamp=e,this.snapshotTelemetryReport.hydraDisposeTimestamp=e},e.prototype.updateInitEventsWithDisposeEvent=function(e,t){var i=e.init_allEvents,n=JSON.parse(i);n[n.length-1].name!==c.PlayerScenarioType.Destroyed&&n.push({name:c.PlayerScenarioType.Destroyed,startTime:t,duration:0,details:p.HydraPlayerDestroyedReason.PlayerStopped}),e.init_allEvents=(0,u.stringifyObject)(n)},e.prototype.updateStateChangeEventsWithDisposeEvent=function(e,t){var i=e.playback_stateChangeEvents,n=JSON.parse(i);n[n.length-1].payload!==l.HydraPlayerPlaybackState.Destroyed&&n.push({eventType:c.TelemetryEventType.StateChanged,timestamp:t,currentPlayPosition:-1,payload:l.HydraPlayerPlaybackState.Destroyed}),e.playback_stateChangeEvents=(0,u.stringifyObject)(n)},e}()},124:function(e,t){var i;Object.defineProperty(t,"__esModule",{value:!0}),t.MessageType=void 0,(i=t.MessageType||(t.MessageType={})).Command="Command",i.CommandSuccessResult="CommandSuccessResult",i.CommandFailureResult="CommandFailureResult",i.PlayerEvent="PlayerEvent",i.InternalPlayerEvent="InternalPlayerEvent"},63:function(e,t){var i,n;Object.defineProperty(t,"__esModule",{value:!0}),t.HydraSupportedSDN=t.HydraPlayerDestroyedReason=void 0,(n=t.HydraPlayerDestroyedReason||(t.HydraPlayerDestroyedReason={})).PlayerStopped="PlayerStopped",n.PlaybackError="PlaybackError",(i=t.HydraSupportedSDN||(t.HydraSupportedSDN={})).Hive="hive",i.Kollective="kollective",i.Ramp="ramp",i.Peer5="peer5",i.Microsoft="microsoft"},844:function(e,t){var i,n;Object.defineProperty(t,"__esModule",{value:!0}),t.PlayerScenarioType=t.TelemetryEventType=void 0,(n=t.TelemetryEventType||(t.TelemetryEventType={})).BitrateChangedDownload="BitrateChangedDownload",n.StreamOptionsConfigured="StreamOptionsConfigured",n.BitrateChangedPlayback="BitrateChangedPlayback",n.CaptionsToggled="CaptionsToggled",n.Error="Error",n.IgnoredError="IgnoredError",n.FullscreenChanged="FullscreenChanged",n.Mute="Mute",n.PotentialMediaFreeze="PotentialMediaFreeze",n.StateChanged="StateChanged",n.HydraInputStateChanged="HydraInputStateChanged",n.HydraOutputStateChanged="HydraOutputStateChanged",n.Volume="Volume",n.Buffering="Buffering",n.Online="Online",n.Offline="Offline",n.NetworkChange="NetworkChange",n.HlsEvents="HlsEvents",(i=t.PlayerScenarioType||(t.PlayerScenarioType={})).LoadHydra="LoadHydra",i.LoadHlsScript="LoadHlsScript",i.LoadPlayer="LoadPlayer",i.Load="Load",i.LoadHlsAuthCookie="LoadHlsAuthCookie",i.HlsManifestLoad="HlsManifestLoad",i.HlsKeyLoad="HlsKeyLoad",i.LoadHlsFirstFragment="LoadHlsFirstFragment",i.SetSource="SetSource",i.SdnPluginLoad="SdnPluginLoad",i.ThaPluginLoad="ThaPluginLoad",i.HydraPipelineInitialization="HydraPipelineInitialization",i.Destroyed="Destroyed",i.Setup="Setup",i.StreamConnection="StreamConnection"},328:function(e,t){var i,n;Object.defineProperty(t,"__esModule",{value:!0}),t.HydraPlayerType=t.HydraStreamingEventType=void 0,(n=t.HydraStreamingEventType||(t.HydraStreamingEventType={})).TLE="TLE",n.Overflow="Overflow",n.TownHallBasic="TownHall_Basic",n.TownHallPremium="TownHall_Premium",n.TownHall="TownHall",(i=t.HydraPlayerType||(t.HydraPlayerType={}))[i.Hls=1]="Hls",i[i.Ums=2]="Ums"},68:function(e,t){var i,n,r,s;Object.defineProperty(t,"__esModule",{value:!0}),t.HydraPlayerPlaybackErrorType=t.HydraPlayerPlaybackState=t.HydraPlayerSetupErrorType=t.HydraStreamDeliveryPipeline=void 0,(s=t.HydraStreamDeliveryPipeline||(t.HydraStreamDeliveryPipeline={})).AMS="AMS",s.HLS="MiddleLaneHttpLiveStreaming",s.Ums="MiddleLaneUltraLowLatency",(r=t.HydraPlayerSetupErrorType||(t.HydraPlayerSetupErrorType={})).MultiplePlayerLoad="MultiplePlayerLoad",r.PlayerInitializationFailed="PlayerInitializationFailed",r.InvalidStream="InvalidStream",r.SetSourceFailed="SetSourceFailed",(n=t.HydraPlayerPlaybackState||(t.HydraPlayerPlaybackState={})).LoadStart="loadstart",n.LoadedData="loadeddata",n.LoadedMetadata="loadedmetadata",n.Start="start",n.CanPlayThrough="canplaythrough",n.Play="play",n.Playing="playing",n.Pause="pause",n.Waiting="waiting",n.Seeking="seeking",n.Seeked="seeked",n.Ended="ended",n.Error="error",n.Destroyed="destroyed",n.Initialized="initialized",n.Stalled="stalled",n.VolumeChange="volumechange",n.PlaybackBitrateChanged="playbackbitratechanged",n.DownloadBitrateChanged="downloadbitratechanged",n.HlsKeyLoading="hlsKeyLoading",n.HlsKeyLoaded="hlsKeyLoaded",n.HlsKeyLoadedFailed="hlsKeyLoadedFailed",n.HlsManifestLoading="hlsManifestLoading",n.HlsManifestLoaded="hlsManifestLoaded",n.HlsManifestLoadedFailed="hlsManifestLoadedFailed",n.HlsFirstFragmentLoading="hlsFragLoading",n.HlsFirstFragmentBuffered="hlsFragBuffered",n.HlsFirstFragmentLoadFailed="hlsFirstFragmentLoadFailed",n.Online="online",n.Offline="offline",n.NetworkChange="networkChange",(i=t.HydraPlayerPlaybackErrorType||(t.HydraPlayerPlaybackErrorType={})).UnsupportedPlatform="UnsupportedPlatform",i.NetworkError="NetworkError",i.PlaybackRetried="PlaybackRetried",i.PlaybackError="PlaybackError",i.Unknown="Unknown"},944:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.defer=void 0,t.defer=function(){var e,t;return{promise:new Promise((function(i,n){e=i,t=n})),resolve:e,reject:t}}},329:function(e,t,i){var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function a(e){try{l(n.next(e))}catch(e){s(e)}}function o(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,o)}l((n=n.apply(e,t||[])).next())}))},r=this&&this.__generator||function(e,t){var i,n,r,s,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return s={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function o(o){return function(l){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;s&&(s=0,o[0]&&(a=0)),a;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,n=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(6===o[0]&&a.label<r[1]){a.label=r[1],r=o;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(o);break}r[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(e){o=[6,e],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,l])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.createVideoElement=t.createVideoElementDiv=t.showPlayerControls=t.getSdnStats=t.Spinner=t.repeatUntilCancel=t.wait=t.stringifyError=t.stringifyObject=t.getRandomHexString=t.getPlayerSetting=t.getECSSetting=t.assert=t.createIFrame=t.getMajorFromVersion=void 0;var s=i(63),a=i(328);function o(e,t,i,s,a){return n(this,void 0,void 0,(function(){var o,l,c,u,p=this;return r(this,(function(g){switch(g.label){case 0:return o=100,l=Date.now(),[4,d(i,c={trackingRef:"",timeTakenToDownloadScript:-1},a).catch((function(e){return n(p,void 0,void 0,(function(){var t;return r(this,(function(n){switch(n.label){case 0:return t="Failed to get IFrame source: ".concat(h(e)),s.push({success:!1,url:i,startTime:l,duration:Date.now()-l,trackingReference:c.trackingRef,timeTakenToDownloadScript:c.timeTakenToDownloadScript,errorMsg:t}),s.length>o&&s.shift(),[4,Promise.reject(new Error(t))];case 1:return[2,n.sent()]}}))}))}))];case 1:return u=g.sent(),t.srcdoc=u,e.appendChild(t),[4,new Promise((function(e,n){t.onload=function(){s.push({success:!0,url:i,startTime:l,duration:Date.now()-l,trackingReference:c.trackingRef,timeTakenToDownloadScript:c.timeTakenToDownloadScript}),s.length>o&&s.shift(),e()},t.onerror=function(e){var t="Failed to load HydraPlayer IFrame: ".concat(h(e));s.push({success:!1,url:i,startTime:l,duration:Date.now()-l,trackingReference:c.trackingRef,timeTakenToDownloadScript:c.timeTakenToDownloadScript,errorMsg:t}),s.length>o&&s.shift(),n(new Error(t))}}))];case 2:return g.sent(),[2]}}))}))}function l(e,t){return n(this,void 0,void 0,(function(){var i=this;return r(this,(function(s){switch(s.label){case 0:return[4,e(t).catch((function(s){return n(i,void 0,void 0,(function(){var i=this;return r(this,(function(a){switch(a.label){case 0:return 0!=--t?[3,2]:[4,Promise.reject(s)];case 1:case 3:return[2,a.sent()];case 2:return[4,new Promise((function(a){return setTimeout((function(){a(l(e,t).catch((function(e){return n(i,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,Promise.reject(new Error("".concat(h(s)).concat(", ",h(e))))];case 1:return[2,t.sent()]}}))}))})))}),100)}))]}}))}))}))];case 1:return s.sent(),[2]}}))}))}function d(e,t,i){return n(this,void 0,void 0,(function(){var s,a,o,l=this;return r(this,(function(d){switch(d.label){case 0:return s=Date.now(),[4,c(e,t,i).catch((function(e){return n(l,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,Promise.reject(e)];case 1:return[2,t.sent()]}}))}))}))];case 1:return a=d.sent(),o="<script> ".concat(a,"<\/script>"),t.timeTakenToDownloadScript=Date.now()-s,[2,"\n        <html class style='height: 100%; width: 100%; overflow: hidden'>\n        <head></head>\n        <body class style='height: 100%; width: 100%; margin: 0px'>\n            ".concat(o,"\n        </body>\n        </html>\n    ")]}}))}))}function c(e,t,i){return n(this,void 0,void 0,(function(){var s,a,o,l=this;return r(this,(function(d){switch(d.label){case 0:return s=function(e,t){var i,n;return t.includes("vz")?null!==(n=e.headers.get("uuid"))&&void 0!==n?n:"":null!==(i=e.headers.get("X-Azure-Ref"))&&void 0!==i?i:""},i?(a=new AbortController,o=setTimeout((function(){a.abort()}),i),[4,fetch(e,{signal:a.signal,cache:"no-cache"}).then((function(i){return n(l,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return clearTimeout(o),i.ok?[3,2]:[4,Promise.reject(new Error("".concat(i.status)))];case 1:return[2,n.sent()];case 2:return t.trackingRef=s(i,e),[2,i]}}))}))})).then((function(t){return n(l,void 0,void 0,(function(){var i=this;return r(this,(function(s){switch(s.label){case 0:return[4,t.text().then((function(s){return n(i,void 0,void 0,(function(){return r(this,(function(i){switch(i.label){case 0:return s?[2,s]:[3,1];case 1:return[4,Promise.reject(new Error("".concat(t.status,", script ").concat(e," contents are null")))];case 2:return[2,i.sent()]}}))}))}))];case 1:return[2,s.sent()]}}))}))})).catch((function(e){return n(l,void 0,void 0,(function(){return r(this,(function(t){throw clearTimeout(o),e}))}))}))]):[3,2];case 1:case 3:return[2,d.sent()];case 2:return[4,fetch(e,{cache:"no-cache"}).then((function(i){return n(l,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return i.ok?[3,2]:[4,Promise.reject(new Error("".concat(i.status)))];case 1:return[2,n.sent()];case 2:return t.trackingRef=s(i,e),[2,i]}}))}))})).then((function(t){return n(l,void 0,void 0,(function(){var i=this;return r(this,(function(s){switch(s.label){case 0:return[4,t.text().then((function(s){return n(i,void 0,void 0,(function(){return r(this,(function(i){switch(i.label){case 0:return s?[2,s]:[3,1];case 1:return[4,Promise.reject(new Error("".concat(t.status,", script ").concat(e," contents are null")))];case 2:return[2,i.sent()]}}))}))}))];case 1:return[2,s.sent()]}}))}))}))]}}))}))}function h(e){try{if(!e)return"".concat(e);if(e instanceof Map)return i={},e.forEach((function(e,t){i[t.toString()]=e})),JSON.stringify(i);var t=e.toString();return t.endsWith("[object Object]")?JSON.stringify(e):t}catch(e){return""}var i}function u(e){return n(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,new Promise((function(t){return setTimeout(t,e)}))];case 1:return t.sent(),[2]}}))}))}t.getMajorFromVersion=function(e){var t=e.match(/^(\d+)\.\d+\.\d+(-.*)?$/);return t?t[1]:null},t.createIFrame=function(e,t,i,s,a){return void 0===s&&(s=!1),n(this,void 0,void 0,(function(){var d,c,u,p,g=this;return r(this,(function(m){switch(m.label){case 0:return d=[],c=Date.now(),(u=e.ownerDocument.createElement("iframe")).id="player-iframe",s||u.sandbox.add("allow-scripts"),u.allowFullscreen=!0,u.allow="camera; microphone; autoplay",u.style.height="100%",u.style.width="100%",u.style.border="none",p=function(e){return t[e%t.length]},[4,l((function(t){return n(g,void 0,void 0,(function(){var i;return r(this,(function(n){switch(n.label){case 0:return i=p(t),[4,o(e,u,i,d,a)];case 1:return n.sent(),[2]}}))}))}),i).then((function(){return{iframe:u,initResult:{initSucceeded:!0,initStartTime:c,initDuration:Date.now()-c,runtimeDownloadResults:d}}})).catch((function(e){return n(g,void 0,void 0,(function(){var i;return r(this,(function(n){return i="Failed to load Hydra player runtime scripts, src: ",t.forEach((function(e){return i=i.concat(e,", ")})),i+="errors: ".concat(h(e)),[2,{initResult:{initSucceeded:!1,initStartTime:c,initDuration:Date.now()-c,runtimeDownloadResults:d,errorMsg:i}}]}))}))}))];case 1:return[2,m.sent()]}}))}))},t.assert=function(e,t,i){if(void 0===i&&(i=!1),!e){if(!i)throw new Error("Assert failed".concat(void 0!==t?": ".concat(t):""));console.error("Assert failed".concat(void 0!==t?": ".concat(t):""))}},t.getECSSetting=function(e,t,i){var n,r=i,s=null===(n=e.ecsSettings)||void 0===n?void 0:n[t];return typeof s==typeof r&&(r=s),r},t.getPlayerSetting=function(e,t){var i;return void 0!==(null===(i=e.ecsSettings)||void 0===i?void 0:i[t])?e.ecsSettings[t]:e[t]},t.getRandomHexString=function(e){return Array.from(Array(e)).map((function(){return Math.floor(16*Math.random()).toString(16)})).join("")},t.stringifyObject=h,t.stringifyError=function(e){return e instanceof Error?e.message:h(e)},t.wait=u,t.repeatUntilCancel=function(e,t,i,s){var a=!1,o=s||console.log;return o("RepeatUntilCancel starting task: ".concat(e)),n(this,void 0,void 0,(function(){var n,s,l;return r(this,(function(r){switch(r.label){case 0:return a?[3,2]:(n=new Date,t(),s=(new Date).getTime()-n.getTime(),(l=i-s)<0&&(l=i+l%i,o("Skipping execution for ".concat(e,", last execution took: ").concat(s," ms, delayMs: ").concat(i),"warn")),[4,u(l)]);case 1:return r.sent(),[3,0];case 2:return[2]}}))})),function(){o("RepeatUntilCancel stopping task: ".concat(e)),a=!0}};var p=function(){function e(e){this.container=e,this.spinnerId="hydra-player-spinner",this.firstSpinnerShowTimestamp=null,this.firstSpinnerHideTimestamp=null,this.spinnerInfoHistory=[],this.maxTimestampHistorySize=100;var t=this.container.ownerDocument.getElementById(this.spinnerId);if(t)return this.spinner=t,void this.show();var i=this.container.ownerDocument.createElement("style");i.textContent="\n            .ml-player-spinner-container {\n                width: 100%;\n                height: 100%;\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                position: absolute;\n                pointer-events: none;\n            }\n            .ml-player-spinner {\n                width: 3.6rem;\n                height: 3.6rem;\n                display: block;\n                overflow-clip-margin: content-box;\n                overflow: hidden;\n                animation: ml-player-spinner-outer-rotate 3s linear infinite;\n            }\n            .ml-player-spinner-dark-wheel {\n                fill: none;\n                r: 45%;\n                cx: 50%;\n                cy: 50%;\n                stroke: rgb(68, 71, 145);\n                stroke-width: 8px;\n            }\n            .ml-player-spinner-light-wheel {\n                fill: none;\n                r: 45%;\n                cx: 50%;\n                cy: 50%;\n                stroke: rgb(127, 133, 245);\n                stroke-width: 8px;\n                stroke-dasharray: 283;\n                stroke-dashoffset: 280;\n                stroke-linecap: round;\n                transform-origin: 50% 50%;\n                animation: ml-player-spinner-inner-rotate 1.5s cubic-bezier(0.33, 0, 0.67, 1) infinite;\n            }\n            @keyframes ml-player-spinner-outer-rotate {\n                0% {\n                    transform: rotate(0deg);\n                }\n                100% {\n                    transform: rotate(360deg);\n                }\n            }\n            @keyframes ml-player-spinner-inner-rotate {\n                0% {\n                    stroke-dashoffset: 283;\n                    transform: rotate(0deg);\n                }\n                25% {\n                    stroke-dashoffset: 283;\n                    transform: rotate(0deg);\n                }\n                50% {\n                    stroke-dashoffset: 75;\n                    transform: rotate(45deg);\n                }\n                75% {\n                    stroke-dashoffset: 75;\n                    transform: rotate(45deg);\n                }\n                100% {\n                    stroke-dashoffset: 283;\n                    transform: rotate(360deg);\n                }\n            }\n        ",this.container.ownerDocument.head.appendChild(i),this.container.style.position="relative";var n=this.container.ownerDocument.createElement("div");n.classList.add("ml-player-spinner-container"),this.container.appendChild(n),this.spinner=this.container.ownerDocument.createElementNS("http://www.w3.org/2000/svg","svg"),this.spinner.style.position="absolute",this.spinner.setAttribute("viewBox","0 0 100 100"),this.spinner.classList.add("ml-player-spinner"),this.spinner.id=this.spinnerId,n.appendChild(this.spinner);var r=this.container.ownerDocument.createElementNS("http://www.w3.org/2000/svg","circle");r.classList.add("ml-player-spinner-dark-wheel"),this.spinner.appendChild(r);var s=this.container.ownerDocument.createElementNS("http://www.w3.org/2000/svg","circle");s.classList.add("ml-player-spinner-light-wheel"),this.spinner.appendChild(s),this.show()}return Object.defineProperty(e.prototype,"firstShowTimestamp",{get:function(){return this.firstSpinnerShowTimestamp},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"firstHideTimestamp",{get:function(){return this.firstSpinnerHideTimestamp},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"firstSpinnerDuration",{get:function(){return this.firstSpinnerShowTimestamp?this.firstSpinnerHideTimestamp?this.firstSpinnerHideTimestamp-this.firstSpinnerShowTimestamp:Date.now()-this.firstSpinnerShowTimestamp:null},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"visibilityHistory",{get:function(){if(this.spinnerInfoHistory.length>0){var e=this.spinnerInfoHistory[this.spinnerInfoHistory.length-1];e.hideTimestamp||(e.displayDuration=Date.now()-e.showTimestamp)}return this.spinnerInfoHistory},enumerable:!1,configurable:!0}),e.prototype.show=function(){var e=Date.now();this.firstSpinnerShowTimestamp||(this.firstSpinnerShowTimestamp=e),(0===this.spinnerInfoHistory.length||this.spinnerInfoHistory[this.spinnerInfoHistory.length-1].hideTimestamp)&&(this.spinnerInfoHistory.push({showTimestamp:e,displayDuration:0}),this.spinnerInfoHistory.length>this.maxTimestampHistorySize&&this.spinnerInfoHistory.splice(0,1)),this.spinner.style.display="block"},e.prototype.hide=function(){var e=Date.now();if(this.firstSpinnerHideTimestamp||(this.firstSpinnerHideTimestamp=e),this.spinnerInfoHistory.length>0){var t=this.spinnerInfoHistory[this.spinnerInfoHistory.length-1];t.hideTimestamp||(t.hideTimestamp=e,t.displayDuration=e-t.showTimestamp)}this.spinner.style.display="none"},e.prototype.isVisible=function(){return"none"!==this.spinner.style.display},e}();t.Spinner=p,t.getSdnStats=function(e,t){(null==e?void 0:e.peer5)&&(t.sdnName=e.peer5?s.HydraSupportedSDN.Microsoft:"",t.sdnVersion=e.peer5?e.peer5.version:"","function"==typeof e.peer5.getStats&&(t.sdnStats=e.peer5.getStats(),t.isP2PSdnUsed=e.peer5.getStats().numOfPeers>0))},t.showPlayerControls=function(e){return void 0!==e.allowPlayerControls?e.allowPlayerControls:e.streamingEventType===a.HydraStreamingEventType.TLE},t.createVideoElementDiv=function(e,t,i){i("createVideoElementDiv started");var n=t.ownerDocument.createElement("div");return n.id=e,n.style.position="relative",n.style.width="100%",n.style.height="100%",t.appendChild(n),i("createVideoElementDiv done"),n},t.createVideoElement=function(e,t,i,n,r){r("createVideoElement started");var s=t.ownerDocument.createElement("video");s.controls=n,s.id=e,s.setAttribute("playsinline","");var a=i.videoLang;a&&(s.setAttribute("lang",a),r("createVideoElement: language set to ".concat(a)));for(var o=i.videoElementStyles,l=0;l<o.length;l++)s.classList.add(o[l]);return s.style.width="100%",s.style.height="100%",s.style.position="absolute",s.muted=i.muteVideo,s.addEventListener("contextmenu",(function(e){e.preventDefault()})),["play","pause","stop","seekbackward","seekforward","seekto","previoustrack","nexttrack"].forEach((function(e){try{navigator.mediaSession.setActionHandler(e,(function(){}))}catch(e){}})),t.appendChild(s),r("createVideoElement done"),s}}},t={};return function i(n){var r=t[n];if(void 0!==r)return r.exports;var s=t[n]={exports:{}};return e[n].call(s.exports,s,s.exports,i),s.exports}(855)}()},"object"==typeof e&&"object"==typeof t?t.exports=i():(r=[],void 0===(s="function"==typeof(n=i)?n.apply(e,r):n)||(h.exports=s))}}),X=v({"../node_modules/@skype/hydra_player_ums_sdk/hydra_player_ums_sdk_bundle.js"(e,t){var i;i=function(){return function(){"use strict";var e={458:function(e,t,i){var n=this&&this.__assign||function(){return n=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},n.apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.LiveStreamStatistic=void 0;var r=i(844),s=i(68),a=i(329),o=function(){function e(e,t,i){this.name=e,this.stopCrash=t,this.start(i)}return e.prototype.complete=function(){try{a.assert(this.startTime,"not started",this.stopCrash),a.assert(void 0===this.duration,"already completed",this.stopCrash)}catch(e){if(this.name!==r.PlayerScenarioType.LoadHlsFirstFragment&&this.name!==r.PlayerScenarioType.HlsKeyLoad)throw e}this.duration=Date.now()-this.startTime},e.prototype.fail=function(e){this.failReason=e,this.complete()},e.prototype.setDetail=function(e){this.details=e},e.prototype.getTelemetryEvent=function(){a.assert(this.startTime,"not started",this.stopCrash);var e={name:this.name,startTime:this.startTime,duration:this.duration};return this.failReason&&(e.failReason=this.failReason),this.details&&(e.details=this.details),e},e.prototype.getName=function(){return this.name},e.prototype.getDuration=function(){var e;return null!==(e=this.duration)&&void 0!==e?e:0},e.prototype.getFailReason=function(){return this.failReason},e.prototype.getDetails=function(){return this.details},e.prototype.start=function(e){a.assert(!this.startTime,"already started",this.stopCrash),this.startTime=Date.now(),e&&(this.details=e)},e.prototype.updateDetails=function(e,t){if(this.details&&"object"==typeof this.details)for(var i=0;i<e.length;i++)this.details[e[i]]=t[i]},e}(),l=function(){function e(e,t,i,n,r){this.config=e,this.logFn=t,this.playerDiagnosticsLog=i,this.playerMetadata=n,this.hydraInitResult=r,this.currentScenarioMap=new Map,this.playerEvents=[],this.playbackEvents=[],this.experimentalEvents=[],this.callSetupSucceeded=!1,this.callDropped=!1,this.clientNetworkType=void 0,this.maxPlayerPlaybackEventCount=e.maxPlayerPlaybackEventCount||5,this.maxPlayerDiagnosticsCount=e.maxPlayerDiagnosticsCount||5,this.maxPlayerMemoryTraceLogCount=e.maxPlayerMemoryTraceLogCount||100,this.maxPlayerExperimentalEvents=e.maxPlayerExperimentalEvents||100,a.getECSSetting(this.config,"stopCrash",!1)?this.stopCrash=!1:this.stopCrash=!0,this.config.debugLogging&&(this.playerDiagnosticsLog.memoryLog=[]),this.addNetworkTypeEventListener()}return e.prototype.getPlayerDiagnosticSnapshot=function(){return this.currentPlayerDiagnosticSnapshot},e.prototype.registerStatsUpdated=function(e){var t=this;this.currentPlayerDiagnosticSnapshot=e,Object.keys(this.playerDiagnosticsLog).forEach((function(i){var n,r=i,s=null!==(n=t.playerDiagnosticsLog[i])&&void 0!==n?n:[];if(Array.isArray(s)){s.push(e[r]);var a="memoryLog"===r&&s.length>t.maxPlayerMemoryTraceLogCount,o="memoryLog"!==r&&s.length>t.maxPlayerDiagnosticsCount;(a||o)&&s.splice(0,1)}else t.playerDiagnosticsLog[i]=e[r]}))},e.prototype.registerEventLoadAttempt=function(e,t){this.registerScenario(e,t)},e.prototype.registerEventLoadFailed=function(e,t){this.completeScenario(e,t)},e.prototype.registerEventLoadSucceeded=function(e,t){this.completeScenario(e,void 0,t),e===r.PlayerScenarioType.LoadPlayer&&(this.callSetupSucceeded=!0)},e.prototype.registerSdnPluginLoadAttempt=function(e){this.registerScenario(r.PlayerScenarioType.SdnPluginLoad,JSON.stringify(e))},e.prototype.registerSdnPluginLoadFailed=function(e){this.completeScenario(r.PlayerScenarioType.SdnPluginLoad,e)},e.prototype.registerSdnPluginLoadSucceeded=function(){this.completeScenario(r.PlayerScenarioType.SdnPluginLoad)},e.prototype.registerStreamConnectionAttempt=function(e){this.registerScenario(r.PlayerScenarioType.StreamConnection,{streamUrl:e})},e.prototype.registerStreamConnectionSucceeded=function(e){var t=this.getScenario(r.PlayerScenarioType.StreamConnection);null==t||t.updateDetails(["results"],[a.stringifyObject(e)]),this.completeScenario(r.PlayerScenarioType.StreamConnection)},e.prototype.registerStreamConnectionFailed=function(e,t){var i=this.getScenario(r.PlayerScenarioType.StreamConnection);null==i||i.updateDetails(["results"],[a.stringifyObject(t)]),this.completeScenario(r.PlayerScenarioType.StreamConnection,e)},e.prototype.registerSetSourceAttempt=function(e,t,i){var n=e||"";i&&(n={src:e||"",isPrimary:a.stringifyObject(t),reason:i}),this.registerScenario(r.PlayerScenarioType.SetSource,n)},e.prototype.registerSetSourceSucceeded=function(e,t,i,n){var s=this.getScenario(r.PlayerScenarioType.SetSource);a.assert(s,"no SetSource scenario to update details",this.stopCrash),null==s||s.updateDetails(["src","isPrimary","SwitchingDiagnostics","StepDuration"],[e,a.stringifyObject(t),a.stringifyObject(i),a.stringifyObject(n)]),this.completeScenario(r.PlayerScenarioType.SetSource)},e.prototype.registerSetSourceFailed=function(e,t,i,n,s){var o=null!=t?t:"Failed to find stream url",l=this.getScenario(r.PlayerScenarioType.SetSource);a.assert(l,"no SetSource scenario to update details",this.stopCrash),null==l||l.updateDetails(["src","isPrimary","SwitchingDiagnostics","stepDuration"],[o,a.stringifyObject(i),a.stringifyObject(n),a.stringifyObject(s)]),this.completeScenario(r.PlayerScenarioType.SetSource,e)},e.prototype.registerPlayerDestroyed=function(e){this.registerScenario(r.PlayerScenarioType.Destroyed,e),this.completeScenario(r.PlayerScenarioType.Destroyed)},e.prototype.registerPlaybackStateChanged=function(e){e!==s.HydraPlayerPlaybackState.CanPlayThrough||this.firstReadyStateTimestamp?e!==s.HydraPlayerPlaybackState.Playing||this.firstPlayingStateTimestamp||(this.firstPlayingStateTimestamp=Date.now()):this.firstReadyStateTimestamp=Date.now(),this.registerPlaybackEvent(r.TelemetryEventType.StateChanged,e)},e.prototype.registerHydraInputStateChanged=function(e,t){this.registerPlaybackEvent(r.TelemetryEventType.HydraInputStateChanged,e,t)},e.prototype.registerHydraOutputStateChanged=function(e,t){this.registerPlaybackEvent(r.TelemetryEventType.HydraOutputStateChanged,e,t)},e.prototype.registerPlaybackBuffering=function(e){this.registerPlaybackEvent(r.TelemetryEventType.Buffering,e)},e.prototype.registerPlaybackError=function(e,t,i){this.registerPlaybackEvent(r.TelemetryEventType.Error,{errorType:e,details:t,errorSource:i})},e.prototype.registerIgnoredPlaybackError=function(e){this.registerPlaybackEvent(r.TelemetryEventType.IgnoredError,e)},e.prototype.registerDownloadBitrateChanged=function(e){this.registerPlaybackEvent(r.TelemetryEventType.BitrateChangedDownload,e)},e.prototype.registerStreamOptionsConfigured=function(e,t){this.registerPlaybackEvent(r.TelemetryEventType.StreamOptionsConfigured,e,t)},e.prototype.registerPlaybackBitrateChanged=function(e){this.registerPlaybackEvent(r.TelemetryEventType.BitrateChangedPlayback,e)},e.prototype.registerVolumeChange=function(e){this.registerPlaybackEvent(r.TelemetryEventType.Volume,e)},e.prototype.getSnapshotReport=function(){var e,t,i=[this.getTotalLoadEvent(),this.getHydraLoadEvent()].concat(this.playerEvents.map((function(e){return e.getTelemetryEvent()}))),r=this.playbackEvents,s={};return this.currentPlayerDiagnosticSnapshot&&(s=this.filterAndPrepareTelemetry()),n(n(n(n(n(n(n(n(n(n(n(n(n({isFullReport:!1,configIds:this.config.configIds||"",eTag:this.config.eTag||""},this.getPlayerMetadataReport()),{isIframe:!0,isFullscreenButtonDisabled:!1,telemetryTickMs:null!==(t=null===(e=this.currentPlayerDiagnosticSnapshot)||void 0===e?void 0:e.statsInterval)&&void 0!==t?t:-1}),this.getHydraInitializationReport()),this.getPlayerInitializationReport(i,r)),this.getHydraInternalReport(r)),this.getPlaybackReport(r)),this.getBitrateReport(r)),this.getStreamConnectionReport(i)),this.getSdnReport(i)),this.getSetSourceReport(i)),this.getExperimentalEvents()),{networkType:this.getClientNetworkType(),callSetupSucceeded:this.callSetupSucceeded,callDropped:this.callDropped}),s)},e.prototype.getReport=function(){var e,t,i=[this.getTotalLoadEvent(),this.getHydraLoadEvent()].concat(this.playerEvents.map((function(e){return e.getTelemetryEvent()}))),r=this.playbackEvents;return n(n(n(n(n(n(n(n(n(n(n(n(n({isFullReport:!0,configIds:this.config.configIds||"",eTag:this.config.eTag||""},this.getPlayerMetadataReport()),{isIframe:!0,isFullscreenButtonDisabled:!1,telemetryTickMs:null!==(t=null===(e=this.currentPlayerDiagnosticSnapshot)||void 0===e?void 0:e.statsInterval)&&void 0!==t?t:-1}),this.getHydraInitializationReport()),this.getPlayerInitializationReport(i,r)),this.getHydraInternalReport(r)),this.getPlaybackReport(r)),this.getBitrateReport(r)),this.getStreamConnectionReport(i)),this.getSdnReport(i)),this.getSetSourceReport(i)),this.getExperimentalEvents()),{networkType:this.getClientNetworkType(),callSetupSucceeded:this.callSetupSucceeded,callDropped:this.callDropped}),this.getPlayerDiagnosticLog())},e.prototype.getHydraLoadEvent=function(){var e,t,i,n={name:r.PlayerScenarioType.LoadHydra,startTime:(null===(e=this.hydraInitResult)||void 0===e?void 0:e.initStartTime)||-1,duration:(null===(t=this.hydraInitResult)||void 0===t?void 0:t.initDuration)||0};(null===(i=this.hydraInitResult)||void 0===i?void 0:i.errorMsg)&&(n.failReason=this.hydraInitResult.errorMsg);var s=this.getHydraRuntimeDownloadDetails();return s&&(n.details=s),n},e.prototype.getHydraRuntimeDownloadDetails=function(){if(this.hydraInitResult){for(var e=[],t=0,i=this.hydraInitResult.runtimeDownloadResults;t<i.length;t++){var n=i[t],r={success:n.success,url:n.url,startTime:n.startTime,duration:n.duration,trackingReference:n.trackingReference,timeTakenToDownloadScript:n.timeTakenToDownloadScript};n.errorMsg&&(r.errorMsg=n.errorMsg),e.push(r)}return a.stringifyObject(e)}return null},e.prototype.getTotalLoadEvent=function(){var e,t,i,n=this.playerEvents.find((function(e){return e.getName()===r.PlayerScenarioType.LoadPlayer})),s=(null===(e=this.hydraInitResult)||void 0===e?void 0:e.initDuration)||0,a=(null==n?void 0:n.getDuration())||0,o=null==n?void 0:n.getFailReason(),l={name:r.PlayerScenarioType.Load,startTime:(null===(t=this.hydraInitResult)||void 0===t?void 0:t.initStartTime)||-1,duration:s+a};return(null===(i=this.hydraInitResult)||void 0===i?void 0:i.errorMsg)?l.failReason=this.hydraInitResult.errorMsg:o&&(l.failReason=o),l},e.prototype.getPlayerMetadataReport=function(){return{playerId:this.playerMetadata.playerId||"",traceId:this.playerMetadata.playerId?this.playerMetadata.playerId.replace(/-/g,""):"",hydraPlayerRuntimeVersion:this.playerMetadata.hydraPlayerRuntimeVersion||"",hydraPlayerSdkVersion:this.playerMetadata.hydraPlayerSdkVersion,player_playerType:this.playerMetadata.hydraPlayerType}},e.prototype.registerPlaybackEvent=function(e,t,i){var n=this.createTelemetryEvent(e,t,i);e===r.TelemetryEventType.Error&&(null==t?void 0:t.errorType)!==s.HydraPlayerPlaybackErrorType.PlaybackRetried&&(n.fatal=!0,this.callDropped=!0),this.playbackEvents.push(n),this.playbackEvents.length>this.maxPlayerPlaybackEventCount&&this.playbackEvents.splice(0,1),this.logTelemetryEvent(n)},e.prototype.getPlayerDiagnosticLog=function(){var e=this;if(!this.currentPlayerDiagnosticSnapshot)return{};var t=this.currentPlayerDiagnosticSnapshot,i=this.playerDiagnosticsLog,r=n(n({},t),i),s={};return Object.keys(r).forEach((function(t){s["player_".concat(t)]=e.prepareForTelemetry(r[t])})),s},e.prototype.getHydraInitializationReport=function(){var e,t,i,n;return{hydraInit_succeeded:(null===(e=this.hydraInitResult)||void 0===e?void 0:e.initSucceeded)||!1,hydraInit_startTime:(null===(t=this.hydraInitResult)||void 0===t?void 0:t.initStartTime)||-1,hydraInit_errorMessage:(null===(i=this.hydraInitResult)||void 0===i?void 0:i.errorMsg)||"",hydraInit_duration:(null===(n=this.hydraInitResult)||void 0===n?void 0:n.initDuration)||0}},e.prototype.getPlayerInitializationReport=function(e,t){var i=e.find((function(e){return e.name===r.PlayerScenarioType.Load}));return{init_timeLoadToStreamConnectionEstablished:(null!=i&&this.initialStreamConnectionEstablishedTimestamp?this.initialStreamConnectionEstablishedTimestamp-i.startTime:-1)||-1,init_timeLoadToReady:(null!=i&&this.firstReadyStateTimestamp?this.firstReadyStateTimestamp-i.startTime:-1)||-1,init_timeLoadToPlaying:(null!=i&&this.firstPlayingStateTimestamp?this.firstPlayingStateTimestamp-i.startTime:-1)||-1,init_allEvents:this.prepareForTelemetry(e)}},e.prototype.getHydraInternalReport=function(e){var t=e.filter((function(e){return e.eventType===r.TelemetryEventType.HydraInputStateChanged})),i=e.filter((function(e){return e.eventType===r.TelemetryEventType.HydraOutputStateChanged}));return{hydra_inputStateChangeEvents:this.prepareForTelemetry(t),hydra_outputStateChangeEvents:this.prepareForTelemetry(i)}},e.prototype.getPlaybackReport=function(e){var t=e.filter((function(e){return e.eventType===r.TelemetryEventType.StateChanged})),i=t.find((function(e){return e.payload===s.HydraPlayerPlaybackState.CanPlayThrough})),n=t.find((function(e){return e.payload===s.HydraPlayerPlaybackState.Play})),a=t.find((function(e){return e.payload===s.HydraPlayerPlaybackState.Start})),o=t.find((function(e){return e.payload===s.HydraPlayerPlaybackState.Playing})),l=null!=i&&null!=n?n.timestamp-i.timestamp:-1,d=null!=n&&null!=a?a.timestamp-n.timestamp:-1,c=null!=a&&null!=o?o.timestamp-a.timestamp:-1,h=t.filter((function(e){return e.payload===s.HydraPlayerPlaybackState.Seeked})),u=t.filter((function(e){return e.payload===s.HydraPlayerPlaybackState.Seeking})),p=t.filter((function(e){return e.payload===s.HydraPlayerPlaybackState.Pause})),g=t.filter((function(e){return e.payload===s.HydraPlayerPlaybackState.Waiting})),m=[r.TelemetryEventType.BitrateChangedDownload,r.TelemetryEventType.BitrateChangedPlayback,r.TelemetryEventType.Error,r.TelemetryEventType.Mute,r.TelemetryEventType.StateChanged,r.TelemetryEventType.Volume,r.TelemetryEventType.StreamOptionsConfigured,r.TelemetryEventType.IgnoredError],f=e.filter((function(e){return e.eventType===r.TelemetryEventType.Error})),S=e.filter((function(e){return e.eventType===r.TelemetryEventType.IgnoredError})),v=e.filter((function(e){return e.eventType===r.TelemetryEventType.Volume||e.eventType===r.TelemetryEventType.Mute})),y=e.filter((function(e){return e.eventType===r.TelemetryEventType.StreamOptionsConfigured})),C=e.filter((function(e){return!m.includes(e.eventType)}));return{playback_timeReadyToPlay:l,playback_timePlayToStart:d,playback_timeStartToPlaying:c,playback_bufferingEvents:this.prepareForTelemetry(g),playback_errorEvents:this.prepareForTelemetry(f),playback_ignoredErrorEvents:this.prepareForTelemetry(S),playback_pauseEvents:this.prepareForTelemetry(p),playback_otherEvents:this.prepareForTelemetry(C),playback_seekedEvents:this.prepareForTelemetry(h),playback_seekingEvents:this.prepareForTelemetry(u),playback_stateChangeEvents:this.prepareForTelemetry(t),playback_volumeEvents:this.prepareForTelemetry(v),playback_streamOptionsConfiguredEvents:this.prepareForTelemetry(y)}},e.prototype.getBitrateReport=function(e){var t,i,s,a,o=e.filter((function(e){return e.eventType===r.TelemetryEventType.BitrateChangedDownload})),l=o.sort((function(e){return Number(e.payload)})),d=o.length>0?{bitrate_downloadChanges:this.prepareForTelemetry(o),bitrate_downloadChangeCount:o.length>0||-1,bitrate_downloadMin:(null===(t=l[0])||void 0===t?void 0:t.payload)||-1,bitrate_downloadMax:(null===(i=l[l.length-1])||void 0===i?void 0:i.payload)||-1}:{},c=e.filter((function(e){return e.eventType===r.TelemetryEventType.BitrateChangedPlayback})),h=c.sort((function(e){return Number(e.payload)})),u=c.length>0?{bitrate_playbackChanges:this.prepareForTelemetry(c),bitrate_playbackChangeCount:c.length>0||-1,bitrate_playbackMin:(null===(s=h[0])||void 0===s?void 0:s.payload)||-1,bitrate_playbackMax:(null===(a=h[h.length-1])||void 0===a?void 0:a.payload)||-1}:{};return n(n({},d),u)},e.prototype.addNetworkTypeEventListener=function(){var e,t,i,n,r=this;(null===(t=null===(e=window.navigator)||void 0===e?void 0:e.connection)||void 0===t?void 0:t.type)&&(null===(n=null===(i=window.navigator)||void 0===i?void 0:i.connection)||void 0===n||n.addEventListener("change",(function(){r.updateClientNetworkType()})))},e.prototype.updateClientNetworkType=function(){this.clientNetworkType=void 0,this.getClientNetworkType()},e.prototype.getClientNetworkType=function(){var e,t,i,n;if(void 0===this.clientNetworkType){var r="Unknown";if(null===(t=null===(e=window.navigator)||void 0===e?void 0:e.connection)||void 0===t?void 0:t.type)switch(null===(n=null===(i=window.navigator)||void 0===i?void 0:i.connection)||void 0===n?void 0:n.type){case"cellular":r="WWAN";break;case"ethernet":r="Wired";break;case"wifi":r="Wireless";break;default:r="Unknown"}this.clientNetworkType=r}return this.clientNetworkType},e.prototype.getSdnReport=function(e){var t,i,n=e.filter((function(e){return e.name===r.PlayerScenarioType.SdnPluginLoad})),s=n.length>0?n[n.length-1]:void 0;return{sdn_loaded:!(null==s||void 0!==s.failReason),sdn_details:null!==(t=null==s?void 0:s.details)&&void 0!==t?t:"",sdn_error:null!==(i=null==s?void 0:s.failReason)&&void 0!==i?i:"",sdn_events:this.prepareForTelemetry(n)}},e.prototype.getStreamConnectionReport=function(e){var t=e.filter((function(e){return e.name===r.PlayerScenarioType.StreamConnection}));return{stream_connection_events:this.prepareForTelemetry(t)}},e.prototype.getSetSourceReport=function(e){var t=e.filter((function(e){return e.name===r.PlayerScenarioType.SetSource}));return{set_source_events:this.prepareForTelemetry(t)}},e.prototype.registerScenario=function(e,t){var i=this.currentScenarioMap.get(e),n=new o(e,this.stopCrash,t);try{a.assert(null==i,"previous scenario:".concat(a.stringifyObject(i)," is not completed, new scenario:").concat(a.stringifyObject(n)),this.stopCrash)}catch(t){if(e!==r.PlayerScenarioType.LoadHlsFirstFragment&&e!==r.PlayerScenarioType.HlsKeyLoad)throw t}this.currentScenarioMap.set(e,n),this.playerEvents.push(n)},e.prototype.completeScenario=function(e,t,i){var n=this.currentScenarioMap.get(e);try{a.assert(n,"no scenario to complete",this.stopCrash)}catch(t){if(e!==r.PlayerScenarioType.LoadHlsFirstFragment&&e!==r.PlayerScenarioType.HlsKeyLoad)throw t}t?null==n||n.fail(t):(e!==r.PlayerScenarioType.StreamConnection||this.initialStreamConnectionEstablishedTimestamp||(this.initialStreamConnectionEstablishedTimestamp=Date.now()),i&&(null==n||n.setDetail(i)),null==n||n.complete()),this.currentScenarioMap.delete(e)},e.prototype.logTelemetryEvent=function(e){this.config.debugLogging&&(this.logFn("debug","PlayerTelemetryEvent: ".concat(JSON.stringify(e))),this.logFn("debug","PlayerDiagnosticData: ".concat(JSON.stringify(this.currentPlayerDiagnosticSnapshot))))},e.prototype.filterAndPrepareTelemetry=function(){var e=this,t=new Set;t.add("serviceLatencyCdg"),t.add("endToEndLatencyCdg"),t.add("videoEdgeLatencyCdg");var i={};return Object.keys(this.currentPlayerDiagnosticSnapshot).forEach((function(n){t.has(n)||(i["player_".concat(n)]=e.prepareForTelemetry(e.currentPlayerDiagnosticSnapshot[n]))})),i},e.prototype.prepareForTelemetry=function(e){return"boolean"==typeof e?e:"string"==typeof e||void 0===e?e||"":"number"==typeof e?null!=e?e:-1:JSON.stringify(e)},e.prototype.getScenario=function(e){return this.currentScenarioMap.get(e)},e.prototype.createTelemetryEvent=function(e,t,i){var n,r,s={eventType:e,timestamp:Date.now(),currentPlayPosition:null!==(r=null===(n=this.currentPlayerDiagnosticSnapshot)||void 0===n?void 0:n.currentPlayPosition)&&void 0!==r?r:-1};return void 0!==t&&(s.payload=this.prepareForTelemetry(t)),s.message=i,s},e.prototype.registerExperimentalEvent=function(e,t,i){var n=this.createTelemetryEvent(e,t,i);this.experimentalEvents.push(n),this.experimentalEvents.length>this.maxPlayerExperimentalEvents&&this.experimentalEvents.splice(0,1),this.logTelemetryEvent(n)},e.prototype.getExperimentalEvents=function(){return{playback_experimentalEvents:this.prepareForTelemetry(this.experimentalEvents)}},e}();t.LiveStreamStatistic=l},751:function(e,t){var i,n,r,s,a,o;Object.defineProperty(t,"__esModule",{value:!0}),t.HydraPlayerType=t.HydraStreamingEventType=t.HydraPlayerPlaybackErrorType=t.HydraPlayerPlaybackState=t.HydraPlayerSetupErrorType=t.HydraStreamDeliveryPipeline=void 0,(o=t.HydraStreamDeliveryPipeline||(t.HydraStreamDeliveryPipeline={})).AMS="AMS",o.HLS="MiddleLaneHttpLiveStreaming",o.Ums="MiddleLaneUltraLowLatency",(a=t.HydraPlayerSetupErrorType||(t.HydraPlayerSetupErrorType={})).MultiplePlayerLoad="MultiplePlayerLoad",a.PlayerInitializationFailed="PlayerInitializationFailed",a.InvalidStream="InvalidStream",a.SetSourceFailed="SetSourceFailed",(s=t.HydraPlayerPlaybackState||(t.HydraPlayerPlaybackState={})).LoadStart="loadstart",s.LoadedData="loadeddata",s.LoadedMetadata="loadedmetadata",s.Start="start",s.CanPlayThrough="canplaythrough",s.Play="play",s.Playing="playing",s.Pause="pause",s.Waiting="waiting",s.Seeking="seeking",s.Seeked="seeked",s.Ended="ended",s.Error="error",s.Destroyed="destroyed",s.Initialized="initialized",s.Stalled="stalled",s.VolumeChange="volumechange",s.PlaybackBitrateChanged="playbackbitratechanged",s.DownloadBitrateChanged="downloadbitratechanged",s.HlsKeyLoading="hlsKeyLoading",s.HlsKeyLoaded="hlsKeyLoaded",s.HlsKeyLoadedFailed="hlsKeyLoadedFailed",s.HlsManifestLoading="hlsManifestLoading",s.HlsManifestLoaded="hlsManifestLoaded",s.HlsManifestLoadedFailed="hlsManifestLoadedFailed",s.HlsFirstFragmentLoading="hlsFragLoading",s.HlsFirstFragmentBuffered="hlsFragBuffered",s.HlsFirstFragmentLoadFailed="hlsFirstFragmentLoadFailed",s.Online="online",s.Offline="offline",s.NetworkChange="networkChange",(r=t.HydraPlayerPlaybackErrorType||(t.HydraPlayerPlaybackErrorType={})).UnsupportedPlatform="UnsupportedPlatform",r.NetworkError="NetworkError",r.PlaybackRetried="PlaybackRetried",r.PlaybackError="PlaybackError",r.Unknown="Unknown",(n=t.HydraStreamingEventType||(t.HydraStreamingEventType={})).TLE="TLE",n.Overflow="Overflow",n.TownHallBasic="TownHall_Basic",n.TownHallPremium="TownHall_Premium",n.TownHall="TownHall",(i=t.HydraPlayerType||(t.HydraPlayerType={}))[i.Hls=1]="Hls",i[i.Ums=2]="Ums"},979:function(e,t,i){var n=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,n,r)}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),r=this&&this.__exportStar||function(e,t){for(var i in e)"default"===i||Object.prototype.hasOwnProperty.call(t,i)||n(t,e,i)};Object.defineProperty(t,"__esModule",{value:!0}),r(i(165),t),r(i(751),t)},165:function(e,t,i){var n=this&&this.__assign||function(){return n=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},n.apply(this,arguments)},r=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function a(e){try{l(n.next(e))}catch(e){s(e)}}function o(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,o)}l((n=n.apply(e,t||[])).next())}))},s=this&&this.__generator||function(e,t){var i,n,r,s,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return s={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function o(o){return function(l){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;s&&(s=0,o[0]&&(a=0)),a;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,n=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(6===o[0]&&a.label<r[1]){a.label=r[1],r=o;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(o);break}r[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(e){o=[6,e],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,l])}}},a=this&&this.__spreadArray||function(e,t,i){if(i||2===arguments.length)for(var n,r=0,s=t.length;r<s;r++)!n&&r in t||(n||(n=Array.prototype.slice.call(t,0,r)),n[r]=t[r]);return e.concat(n||Array.prototype.slice.call(t))};Object.defineProperty(t,"__esModule",{value:!0}),t.UmsHydraPlayer=t.getSdkVersion=void 0;var o=i(124),l=i(68),d=i(328),c=i(844),h=i(63),u=i(458),p=i(329),g=i(944);t.getSdkVersion=function(){return"4.2488.1"};var m=function(){function e(e,t){this.playerSettings=e,this.eventHandler=t,this.spinner=null,this.commandResultsMap=new Map,this._onMessage=this.onMessage.bind(this),this.telemetryReportHandler=null,this.playerInternalEventHandler=null,this.playerRuntimeJsUrls=this.getRuntimeJsUrls(),this.playerSettings.hydraPlayerSdkVersion="4.2488.1"}return Object.defineProperty(e.prototype,"contextWindow",{get:function(){var e;return null===(e=this.container)||void 0===e?void 0:e.ownerDocument.defaultView},enumerable:!1,configurable:!0}),e.prototype.getRuntimeJsUrls=function(){if(!Array.isArray(this.playerSettings.playerRuntimeJsUrls)){var e=(0,p.getMajorFromVersion)("4.2488.1");return e&&this.playerSettings.playerRuntimeJsUrls[e]||[]}return this.playerSettings.playerRuntimeJsUrls},e.prototype.initializeIFrame=function(e){return r(this,void 0,void 0,(function(){var t;return s(this,(function(i){switch(i.label){case 0:return this.container=e,0===this.playerRuntimeJsUrls.length?[2,{initSucceeded:!1,initStartTime:Date.now(),initDuration:0,runtimeDownloadResults:[],errorMsg:"No compatible runtime URL provided for version ".concat("4.2488.1",', URLs: "').concat((0,p.stringifyObject)(this.playerSettings.playerRuntimeJsUrls),'"')}]:[4,(0,p.createIFrame)(e,this.playerRuntimeJsUrls,this.playerSettings.maxRetryCountForLoadingResources,this.playerSettings.disableSandbox,this.playerSettings.hydraRuntimeFetchTimeout)];case 1:return(t=i.sent()).initResult.initSucceeded&&t.iframe&&(this.iframe=t.iframe,this.contextWindow.addEventListener("message",this._onMessage)),[2,t.initResult]}}))}))},e.prototype.setup=function(e){return r(this,void 0,void 0,(function(){var t;return s(this,(function(i){switch(i.label){case 0:return this.spinner=new p.Spinner(e),[4,this.initializeIFrame(e)];case 1:return t=i.sent(),this.telemetryReportHandler=new S(this.playerSettings,this.eventHandler.log.bind(this.eventHandler),t,this.spinner),this.playerInternalEventHandler=new f(this.spinner,this.telemetryReportHandler),t.initSucceeded?[4,this.sendCommand("createUmsHydraPlayer",this.playerSettings,t)]:[3,3];case 2:return i.sent(),[2,!0];case 3:return this.eventHandler.log("error","Failed to setup HydraPlayer: ".concat(t.errorMsg)),this.spinner.hide(),[2,!1]}}))}))},e.prototype.isIFrameCommunicationActive=function(){var e;return!!(null===(e=this.iframe)||void 0===e?void 0:e.contentWindow)&&!!this.contextWindow},e.prototype.getFullTelemetryReport=function(){var e;return(null===(e=this.telemetryReportHandler)||void 0===e?void 0:e.getFullTelemetryReport())||{}},e.prototype.getSnapshotTelemetryReport=function(){var e;return(null===(e=this.telemetryReportHandler)||void 0===e?void 0:e.getSnapshotTelemetryReport())||{}},e.prototype.callPlayerApi=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];return r(this,void 0,void 0,(function(){return s(this,(function(i){switch(i.label){case 0:return this.iframe?[4,this.sendCommand.apply(this,a([e],t,!1))]:[3,2];case 1:case 3:return[2,i.sent()];case 2:return[4,Promise.reject(new Error("Hydra IFrame not initialized yet"))]}}))}))},e.prototype.dispose=function(){var e;null===(e=this.telemetryReportHandler)||void 0===e||e.addDisposeTelemetry(),this.isIFrameCommunicationActive()&&this.sendCommand("disposeHydraPlayer")},e.prototype.release=function(){var e;null===(e=this.spinner)||void 0===e||e.hide(),this.contextWindow&&this.contextWindow.removeEventListener("message",this._onMessage),this.iframe&&this.container&&this.container.hasChildNodes()&&this.container.removeChild(this.iframe)},e.prototype.sendCommand=function(e){for(var t,i,n=[],a=1;a<arguments.length;a++)n[a-1]=arguments[a];return r(this,void 0,void 0,(function(){var r,a,l;return s(this,(function(s){switch(s.label){case 0:if(r={msgType:o.MessageType.Command,name:e,args:n},!this.isIFrameCommunicationActive())throw new Error("IFrame MessageAPI communication not active");return void 0!==(a=this.commandResultsMap.get(e.toString()))&&a.reject(new Error("function ".concat(e," is invoked again, before previous call is completed"))),l=g.defer(),this.commandResultsMap.set(e,l),null===(i=null===(t=this.iframe)||void 0===t?void 0:t.contentWindow)||void 0===i||i.postMessage(r,"*"),[4,l.promise];case 1:return[2,s.sent()]}}))}))},e.prototype.onMessage=function(e){switch(e.data.msgType){case o.MessageType.PlayerEvent:this.processPlayerEvent(e.data);break;case o.MessageType.InternalPlayerEvent:this.processInternalPlayerEvent(e.data);break;case o.MessageType.CommandSuccessResult:this.processCommandSuccessResult(e.data);break;case o.MessageType.CommandFailureResult:this.processCommandFailureResult(e.data)}},e.prototype.processCommandSuccessResult=function(e){var t=this.commandResultsMap.get(e.name.toString());void 0!==t&&(t.resolve(e.result),this.commandResultsMap.delete(e.name.toString()))},e.prototype.processCommandFailureResult=function(e){var t=this.commandResultsMap.get(e.name.toString());void 0!==t&&(t.reject(e.error),this.commandResultsMap.delete(e.name.toString()))},e.prototype.processPlayerEvent=function(e){this.eventHandler[e.name].apply(this.eventHandler,e.args)},e.prototype.processInternalPlayerEvent=function(e){this.playerInternalEventHandler&&this.playerInternalEventHandler[e.name].apply(this,e.args)},e}();t.UmsHydraPlayer=m;var f=function(){function e(e,t){this.spinner=e,this.telemetryReportHandler=t}return e.prototype.firstPlayerLoadAttemptDone=function(){this.spinner.hide()},e.prototype.fullTelemetryReportUpdated=function(e){this.telemetryReportHandler.setFullTelemetryReport(e)},e.prototype.snapshotTelemetryReportUpdated=function(e){this.telemetryReportHandler.setSnapshotTelemetryReport(e)},e}(),S=function(){function e(e,t,i,n){var r=this;this.logFn=t,this.spinner=n;var s=new u.LiveStreamStatistic(e,(function(e,t){r.logFn(e,t)}),{currentPlayPosition:[],playbackRate:[],statsInterval:[],videoBufferLength:[],videoCachedLength:[],videoEdgeLatency:[],playerHeight:[],playerWidth:[],mediaHeight:[],mediaWidth:[],windowHeight:[],windowWidth:[]},{hydraPlayerSdkVersion:e.hydraPlayerSdkVersion||"Unknown",hydraPlayerType:d.HydraPlayerType.Ums},i);this.fullTelemetryReport=s.getReport(),this.snapshotTelemetryReport=s.getSnapshotReport()}return e.prototype.getFullTelemetryReport=function(){return this.fullTelemetryReport},e.prototype.getSnapshotTelemetryReport=function(){return this.snapshotTelemetryReport},e.prototype.setFullTelemetryReport=function(e){var t,i,r;this.fullTelemetryReport=n(n({},e),{init_spinnerShowTimestamp:null!==(t=this.spinner.firstShowTimestamp)&&void 0!==t?t:-1,init_spinnerHideTimestamp:null!==(i=this.spinner.firstHideTimestamp)&&void 0!==i?i:-1,init_spinnerDuration:null!==(r=this.spinner.firstSpinnerDuration)&&void 0!==r?r:-1,init_spinnerVisible:this.spinner.isVisible()})},e.prototype.setSnapshotTelemetryReport=function(e){var t,i,r;this.snapshotTelemetryReport=n(n({},e),{init_spinnerShowTimestamp:null!==(t=this.spinner.firstShowTimestamp)&&void 0!==t?t:-1,init_spinnerHideTimestamp:null!==(i=this.spinner.firstHideTimestamp)&&void 0!==i?i:-1,init_spinnerDuration:null!==(r=this.spinner.firstSpinnerDuration)&&void 0!==r?r:-1,init_spinnerVisible:this.spinner.isVisible()})},e.prototype.addDisposeTelemetry=function(){var e=Date.now();try{this.updateInitEventsWithDisposeEvent(this.fullTelemetryReport,e)}catch(e){this.logFn("warn","Failed to add player destroyed information to init_allEvents telemetry field in full telemetry report")}try{this.updateInitEventsWithDisposeEvent(this.snapshotTelemetryReport,e)}catch(e){this.logFn("warn","Failed to add player destroyed information to init_allEvents telemetry field in snapshot telemetry report")}try{this.updateStateChangeEventsWithDisposeEvent(this.fullTelemetryReport,e)}catch(e){this.logFn("warn","Failed to add player destroyed information to playback_stateChangeEvents telemetry field in full telemetry report")}try{this.updateStateChangeEventsWithDisposeEvent(this.snapshotTelemetryReport,e)}catch(e){this.logFn("warn","Failed to add player destroyed information to playback_stateChangeEvents telemetry field in snapshot telemetry report")}this.fullTelemetryReport.hydraDisposeTimestamp=e,this.snapshotTelemetryReport.hydraDisposeTimestamp=e},e.prototype.updateInitEventsWithDisposeEvent=function(e,t){var i=e.init_allEvents,n=JSON.parse(i);n[n.length-1].name!==c.PlayerScenarioType.Destroyed&&n.push({name:c.PlayerScenarioType.Destroyed,startTime:t,duration:0,details:h.HydraPlayerDestroyedReason.PlayerStopped}),e.init_allEvents=(0,p.stringifyObject)(n)},e.prototype.updateStateChangeEventsWithDisposeEvent=function(e,t){var i=e.playback_stateChangeEvents,n=JSON.parse(i);n[n.length-1].payload!==l.HydraPlayerPlaybackState.Destroyed&&n.push({eventType:c.TelemetryEventType.StateChanged,timestamp:t,currentPlayPosition:-1,payload:l.HydraPlayerPlaybackState.Destroyed}),e.playback_stateChangeEvents=(0,p.stringifyObject)(n)},e}()},124:function(e,t){var i;Object.defineProperty(t,"__esModule",{value:!0}),t.MessageType=void 0,(i=t.MessageType||(t.MessageType={})).Command="Command",i.CommandSuccessResult="CommandSuccessResult",i.CommandFailureResult="CommandFailureResult",i.PlayerEvent="PlayerEvent",i.InternalPlayerEvent="InternalPlayerEvent"},63:function(e,t){var i,n;Object.defineProperty(t,"__esModule",{value:!0}),t.HydraSupportedSDN=t.HydraPlayerDestroyedReason=void 0,(n=t.HydraPlayerDestroyedReason||(t.HydraPlayerDestroyedReason={})).PlayerStopped="PlayerStopped",n.PlaybackError="PlaybackError",(i=t.HydraSupportedSDN||(t.HydraSupportedSDN={})).Hive="hive",i.Kollective="kollective",i.Ramp="ramp",i.Peer5="peer5",i.Microsoft="microsoft"},844:function(e,t){var i,n;Object.defineProperty(t,"__esModule",{value:!0}),t.PlayerScenarioType=t.TelemetryEventType=void 0,(n=t.TelemetryEventType||(t.TelemetryEventType={})).BitrateChangedDownload="BitrateChangedDownload",n.StreamOptionsConfigured="StreamOptionsConfigured",n.BitrateChangedPlayback="BitrateChangedPlayback",n.CaptionsToggled="CaptionsToggled",n.Error="Error",n.IgnoredError="IgnoredError",n.FullscreenChanged="FullscreenChanged",n.Mute="Mute",n.PotentialMediaFreeze="PotentialMediaFreeze",n.StateChanged="StateChanged",n.HydraInputStateChanged="HydraInputStateChanged",n.HydraOutputStateChanged="HydraOutputStateChanged",n.Volume="Volume",n.Buffering="Buffering",n.Online="Online",n.Offline="Offline",n.NetworkChange="NetworkChange",n.HlsEvents="HlsEvents",(i=t.PlayerScenarioType||(t.PlayerScenarioType={})).LoadHydra="LoadHydra",i.LoadHlsScript="LoadHlsScript",i.LoadPlayer="LoadPlayer",i.Load="Load",i.LoadHlsAuthCookie="LoadHlsAuthCookie",i.HlsManifestLoad="HlsManifestLoad",i.HlsKeyLoad="HlsKeyLoad",i.LoadHlsFirstFragment="LoadHlsFirstFragment",i.SetSource="SetSource",i.SdnPluginLoad="SdnPluginLoad",i.ThaPluginLoad="ThaPluginLoad",i.HydraPipelineInitialization="HydraPipelineInitialization",i.Destroyed="Destroyed",i.Setup="Setup",i.StreamConnection="StreamConnection"},328:function(e,t){var i,n;Object.defineProperty(t,"__esModule",{value:!0}),t.HydraPlayerType=t.HydraStreamingEventType=void 0,(n=t.HydraStreamingEventType||(t.HydraStreamingEventType={})).TLE="TLE",n.Overflow="Overflow",n.TownHallBasic="TownHall_Basic",n.TownHallPremium="TownHall_Premium",n.TownHall="TownHall",(i=t.HydraPlayerType||(t.HydraPlayerType={}))[i.Hls=1]="Hls",i[i.Ums=2]="Ums"},68:function(e,t){var i,n,r,s;Object.defineProperty(t,"__esModule",{value:!0}),t.HydraPlayerPlaybackErrorType=t.HydraPlayerPlaybackState=t.HydraPlayerSetupErrorType=t.HydraStreamDeliveryPipeline=void 0,(s=t.HydraStreamDeliveryPipeline||(t.HydraStreamDeliveryPipeline={})).AMS="AMS",s.HLS="MiddleLaneHttpLiveStreaming",s.Ums="MiddleLaneUltraLowLatency",(r=t.HydraPlayerSetupErrorType||(t.HydraPlayerSetupErrorType={})).MultiplePlayerLoad="MultiplePlayerLoad",r.PlayerInitializationFailed="PlayerInitializationFailed",r.InvalidStream="InvalidStream",r.SetSourceFailed="SetSourceFailed",(n=t.HydraPlayerPlaybackState||(t.HydraPlayerPlaybackState={})).LoadStart="loadstart",n.LoadedData="loadeddata",n.LoadedMetadata="loadedmetadata",n.Start="start",n.CanPlayThrough="canplaythrough",n.Play="play",n.Playing="playing",n.Pause="pause",n.Waiting="waiting",n.Seeking="seeking",n.Seeked="seeked",n.Ended="ended",n.Error="error",n.Destroyed="destroyed",n.Initialized="initialized",n.Stalled="stalled",n.VolumeChange="volumechange",n.PlaybackBitrateChanged="playbackbitratechanged",n.DownloadBitrateChanged="downloadbitratechanged",n.HlsKeyLoading="hlsKeyLoading",n.HlsKeyLoaded="hlsKeyLoaded",n.HlsKeyLoadedFailed="hlsKeyLoadedFailed",n.HlsManifestLoading="hlsManifestLoading",n.HlsManifestLoaded="hlsManifestLoaded",n.HlsManifestLoadedFailed="hlsManifestLoadedFailed",n.HlsFirstFragmentLoading="hlsFragLoading",n.HlsFirstFragmentBuffered="hlsFragBuffered",n.HlsFirstFragmentLoadFailed="hlsFirstFragmentLoadFailed",n.Online="online",n.Offline="offline",n.NetworkChange="networkChange",(i=t.HydraPlayerPlaybackErrorType||(t.HydraPlayerPlaybackErrorType={})).UnsupportedPlatform="UnsupportedPlatform",i.NetworkError="NetworkError",i.PlaybackRetried="PlaybackRetried",i.PlaybackError="PlaybackError",i.Unknown="Unknown"},944:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.defer=void 0,t.defer=function(){var e,t;return{promise:new Promise((function(i,n){e=i,t=n})),resolve:e,reject:t}}},329:function(e,t,i){var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,s){function a(e){try{l(n.next(e))}catch(e){s(e)}}function o(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,o)}l((n=n.apply(e,t||[])).next())}))},r=this&&this.__generator||function(e,t){var i,n,r,s,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return s={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function o(o){return function(l){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;s&&(s=0,o[0]&&(a=0)),a;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,n=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(6===o[0]&&a.label<r[1]){a.label=r[1],r=o;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(o);break}r[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(e){o=[6,e],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,l])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.createVideoElement=t.createVideoElementDiv=t.showPlayerControls=t.getSdnStats=t.Spinner=t.repeatUntilCancel=t.wait=t.stringifyError=t.stringifyObject=t.getRandomHexString=t.getPlayerSetting=t.getECSSetting=t.assert=t.createIFrame=t.getMajorFromVersion=void 0;var s=i(63),a=i(328);function o(e,t,i,s,a){return n(this,void 0,void 0,(function(){var o,l,c,u,p=this;return r(this,(function(g){switch(g.label){case 0:return o=100,l=Date.now(),[4,d(i,c={trackingRef:"",timeTakenToDownloadScript:-1},a).catch((function(e){return n(p,void 0,void 0,(function(){var t;return r(this,(function(n){switch(n.label){case 0:return t="Failed to get IFrame source: ".concat(h(e)),s.push({success:!1,url:i,startTime:l,duration:Date.now()-l,trackingReference:c.trackingRef,timeTakenToDownloadScript:c.timeTakenToDownloadScript,errorMsg:t}),s.length>o&&s.shift(),[4,Promise.reject(new Error(t))];case 1:return[2,n.sent()]}}))}))}))];case 1:return u=g.sent(),t.srcdoc=u,e.appendChild(t),[4,new Promise((function(e,n){t.onload=function(){s.push({success:!0,url:i,startTime:l,duration:Date.now()-l,trackingReference:c.trackingRef,timeTakenToDownloadScript:c.timeTakenToDownloadScript}),s.length>o&&s.shift(),e()},t.onerror=function(e){var t="Failed to load HydraPlayer IFrame: ".concat(h(e));s.push({success:!1,url:i,startTime:l,duration:Date.now()-l,trackingReference:c.trackingRef,timeTakenToDownloadScript:c.timeTakenToDownloadScript,errorMsg:t}),s.length>o&&s.shift(),n(new Error(t))}}))];case 2:return g.sent(),[2]}}))}))}function l(e,t){return n(this,void 0,void 0,(function(){var i=this;return r(this,(function(s){switch(s.label){case 0:return[4,e(t).catch((function(s){return n(i,void 0,void 0,(function(){var i=this;return r(this,(function(a){switch(a.label){case 0:return 0!=--t?[3,2]:[4,Promise.reject(s)];case 1:case 3:return[2,a.sent()];case 2:return[4,new Promise((function(a){return setTimeout((function(){a(l(e,t).catch((function(e){return n(i,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,Promise.reject(new Error("".concat(h(s)).concat(", ",h(e))))];case 1:return[2,t.sent()]}}))}))})))}),100)}))]}}))}))}))];case 1:return s.sent(),[2]}}))}))}function d(e,t,i){return n(this,void 0,void 0,(function(){var s,a,o,l=this;return r(this,(function(d){switch(d.label){case 0:return s=Date.now(),[4,c(e,t,i).catch((function(e){return n(l,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,Promise.reject(e)];case 1:return[2,t.sent()]}}))}))}))];case 1:return a=d.sent(),o="<script> ".concat(a,"<\/script>"),t.timeTakenToDownloadScript=Date.now()-s,[2,"\n        <html class style='height: 100%; width: 100%; overflow: hidden'>\n        <head></head>\n        <body class style='height: 100%; width: 100%; margin: 0px'>\n            ".concat(o,"\n        </body>\n        </html>\n    ")]}}))}))}function c(e,t,i){return n(this,void 0,void 0,(function(){var s,a,o,l=this;return r(this,(function(d){switch(d.label){case 0:return s=function(e,t){var i,n;return t.includes("vz")?null!==(n=e.headers.get("uuid"))&&void 0!==n?n:"":null!==(i=e.headers.get("X-Azure-Ref"))&&void 0!==i?i:""},i?(a=new AbortController,o=setTimeout((function(){a.abort()}),i),[4,fetch(e,{signal:a.signal,cache:"no-cache"}).then((function(i){return n(l,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return clearTimeout(o),i.ok?[3,2]:[4,Promise.reject(new Error("".concat(i.status)))];case 1:return[2,n.sent()];case 2:return t.trackingRef=s(i,e),[2,i]}}))}))})).then((function(t){return n(l,void 0,void 0,(function(){var i=this;return r(this,(function(s){switch(s.label){case 0:return[4,t.text().then((function(s){return n(i,void 0,void 0,(function(){return r(this,(function(i){switch(i.label){case 0:return s?[2,s]:[3,1];case 1:return[4,Promise.reject(new Error("".concat(t.status,", script ").concat(e," contents are null")))];case 2:return[2,i.sent()]}}))}))}))];case 1:return[2,s.sent()]}}))}))})).catch((function(e){return n(l,void 0,void 0,(function(){return r(this,(function(t){throw clearTimeout(o),e}))}))}))]):[3,2];case 1:case 3:return[2,d.sent()];case 2:return[4,fetch(e,{cache:"no-cache"}).then((function(i){return n(l,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return i.ok?[3,2]:[4,Promise.reject(new Error("".concat(i.status)))];case 1:return[2,n.sent()];case 2:return t.trackingRef=s(i,e),[2,i]}}))}))})).then((function(t){return n(l,void 0,void 0,(function(){var i=this;return r(this,(function(s){switch(s.label){case 0:return[4,t.text().then((function(s){return n(i,void 0,void 0,(function(){return r(this,(function(i){switch(i.label){case 0:return s?[2,s]:[3,1];case 1:return[4,Promise.reject(new Error("".concat(t.status,", script ").concat(e," contents are null")))];case 2:return[2,i.sent()]}}))}))}))];case 1:return[2,s.sent()]}}))}))}))]}}))}))}function h(e){try{if(!e)return"".concat(e);if(e instanceof Map)return i={},e.forEach((function(e,t){i[t.toString()]=e})),JSON.stringify(i);var t=e.toString();return t.endsWith("[object Object]")?JSON.stringify(e):t}catch(e){return""}var i}function u(e){return n(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,new Promise((function(t){return setTimeout(t,e)}))];case 1:return t.sent(),[2]}}))}))}t.getMajorFromVersion=function(e){var t=e.match(/^(\d+)\.\d+\.\d+(-.*)?$/);return t?t[1]:null},t.createIFrame=function(e,t,i,s,a){return void 0===s&&(s=!1),n(this,void 0,void 0,(function(){var d,c,u,p,g=this;return r(this,(function(m){switch(m.label){case 0:return d=[],c=Date.now(),(u=e.ownerDocument.createElement("iframe")).id="player-iframe",s||u.sandbox.add("allow-scripts"),u.allowFullscreen=!0,u.allow="camera; microphone; autoplay",u.style.height="100%",u.style.width="100%",u.style.border="none",p=function(e){return t[e%t.length]},[4,l((function(t){return n(g,void 0,void 0,(function(){var i;return r(this,(function(n){switch(n.label){case 0:return i=p(t),[4,o(e,u,i,d,a)];case 1:return n.sent(),[2]}}))}))}),i).then((function(){return{iframe:u,initResult:{initSucceeded:!0,initStartTime:c,initDuration:Date.now()-c,runtimeDownloadResults:d}}})).catch((function(e){return n(g,void 0,void 0,(function(){var i;return r(this,(function(n){return i="Failed to load Hydra player runtime scripts, src: ",t.forEach((function(e){return i=i.concat(e,", ")})),i+="errors: ".concat(h(e)),[2,{initResult:{initSucceeded:!1,initStartTime:c,initDuration:Date.now()-c,runtimeDownloadResults:d,errorMsg:i}}]}))}))}))];case 1:return[2,m.sent()]}}))}))},t.assert=function(e,t,i){if(void 0===i&&(i=!1),!e){if(!i)throw new Error("Assert failed".concat(void 0!==t?": ".concat(t):""));console.error("Assert failed".concat(void 0!==t?": ".concat(t):""))}},t.getECSSetting=function(e,t,i){var n,r=i,s=null===(n=e.ecsSettings)||void 0===n?void 0:n[t];return typeof s==typeof r&&(r=s),r},t.getPlayerSetting=function(e,t){var i;return void 0!==(null===(i=e.ecsSettings)||void 0===i?void 0:i[t])?e.ecsSettings[t]:e[t]},t.getRandomHexString=function(e){return Array.from(Array(e)).map((function(){return Math.floor(16*Math.random()).toString(16)})).join("")},t.stringifyObject=h,t.stringifyError=function(e){return e instanceof Error?e.message:h(e)},t.wait=u,t.repeatUntilCancel=function(e,t,i,s){var a=!1,o=s||console.log;return o("RepeatUntilCancel starting task: ".concat(e)),n(this,void 0,void 0,(function(){var n,s,l;return r(this,(function(r){switch(r.label){case 0:return a?[3,2]:(n=new Date,t(),s=(new Date).getTime()-n.getTime(),(l=i-s)<0&&(l=i+l%i,o("Skipping execution for ".concat(e,", last execution took: ").concat(s," ms, delayMs: ").concat(i),"warn")),[4,u(l)]);case 1:return r.sent(),[3,0];case 2:return[2]}}))})),function(){o("RepeatUntilCancel stopping task: ".concat(e)),a=!0}};var p=function(){function e(e){this.container=e,this.spinnerId="hydra-player-spinner",this.firstSpinnerShowTimestamp=null,this.firstSpinnerHideTimestamp=null,this.spinnerInfoHistory=[],this.maxTimestampHistorySize=100;var t=this.container.ownerDocument.getElementById(this.spinnerId);if(t)return this.spinner=t,void this.show();var i=this.container.ownerDocument.createElement("style");i.textContent="\n            .ml-player-spinner-container {\n                width: 100%;\n                height: 100%;\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                position: absolute;\n                pointer-events: none;\n            }\n            .ml-player-spinner {\n                width: 3.6rem;\n                height: 3.6rem;\n                display: block;\n                overflow-clip-margin: content-box;\n                overflow: hidden;\n                animation: ml-player-spinner-outer-rotate 3s linear infinite;\n            }\n            .ml-player-spinner-dark-wheel {\n                fill: none;\n                r: 45%;\n                cx: 50%;\n                cy: 50%;\n                stroke: rgb(68, 71, 145);\n                stroke-width: 8px;\n            }\n            .ml-player-spinner-light-wheel {\n                fill: none;\n                r: 45%;\n                cx: 50%;\n                cy: 50%;\n                stroke: rgb(127, 133, 245);\n                stroke-width: 8px;\n                stroke-dasharray: 283;\n                stroke-dashoffset: 280;\n                stroke-linecap: round;\n                transform-origin: 50% 50%;\n                animation: ml-player-spinner-inner-rotate 1.5s cubic-bezier(0.33, 0, 0.67, 1) infinite;\n            }\n            @keyframes ml-player-spinner-outer-rotate {\n                0% {\n                    transform: rotate(0deg);\n                }\n                100% {\n                    transform: rotate(360deg);\n                }\n            }\n            @keyframes ml-player-spinner-inner-rotate {\n                0% {\n                    stroke-dashoffset: 283;\n                    transform: rotate(0deg);\n                }\n                25% {\n                    stroke-dashoffset: 283;\n                    transform: rotate(0deg);\n                }\n                50% {\n                    stroke-dashoffset: 75;\n                    transform: rotate(45deg);\n                }\n                75% {\n                    stroke-dashoffset: 75;\n                    transform: rotate(45deg);\n                }\n                100% {\n                    stroke-dashoffset: 283;\n                    transform: rotate(360deg);\n                }\n            }\n        ",this.container.ownerDocument.head.appendChild(i),this.container.style.position="relative";var n=this.container.ownerDocument.createElement("div");n.classList.add("ml-player-spinner-container"),this.container.appendChild(n),this.spinner=this.container.ownerDocument.createElementNS("http://www.w3.org/2000/svg","svg"),this.spinner.style.position="absolute",this.spinner.setAttribute("viewBox","0 0 100 100"),this.spinner.classList.add("ml-player-spinner"),this.spinner.id=this.spinnerId,n.appendChild(this.spinner);var r=this.container.ownerDocument.createElementNS("http://www.w3.org/2000/svg","circle");r.classList.add("ml-player-spinner-dark-wheel"),this.spinner.appendChild(r);var s=this.container.ownerDocument.createElementNS("http://www.w3.org/2000/svg","circle");s.classList.add("ml-player-spinner-light-wheel"),this.spinner.appendChild(s),this.show()}return Object.defineProperty(e.prototype,"firstShowTimestamp",{get:function(){return this.firstSpinnerShowTimestamp},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"firstHideTimestamp",{get:function(){return this.firstSpinnerHideTimestamp},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"firstSpinnerDuration",{get:function(){return this.firstSpinnerShowTimestamp?this.firstSpinnerHideTimestamp?this.firstSpinnerHideTimestamp-this.firstSpinnerShowTimestamp:Date.now()-this.firstSpinnerShowTimestamp:null},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"visibilityHistory",{get:function(){if(this.spinnerInfoHistory.length>0){var e=this.spinnerInfoHistory[this.spinnerInfoHistory.length-1];e.hideTimestamp||(e.displayDuration=Date.now()-e.showTimestamp)}return this.spinnerInfoHistory},enumerable:!1,configurable:!0}),e.prototype.show=function(){var e=Date.now();this.firstSpinnerShowTimestamp||(this.firstSpinnerShowTimestamp=e),(0===this.spinnerInfoHistory.length||this.spinnerInfoHistory[this.spinnerInfoHistory.length-1].hideTimestamp)&&(this.spinnerInfoHistory.push({showTimestamp:e,displayDuration:0}),this.spinnerInfoHistory.length>this.maxTimestampHistorySize&&this.spinnerInfoHistory.splice(0,1)),this.spinner.style.display="block"},e.prototype.hide=function(){var e=Date.now();if(this.firstSpinnerHideTimestamp||(this.firstSpinnerHideTimestamp=e),this.spinnerInfoHistory.length>0){var t=this.spinnerInfoHistory[this.spinnerInfoHistory.length-1];t.hideTimestamp||(t.hideTimestamp=e,t.displayDuration=e-t.showTimestamp)}this.spinner.style.display="none"},e.prototype.isVisible=function(){return"none"!==this.spinner.style.display},e}();t.Spinner=p,t.getSdnStats=function(e,t){(null==e?void 0:e.peer5)&&(t.sdnName=e.peer5?s.HydraSupportedSDN.Microsoft:"",t.sdnVersion=e.peer5?e.peer5.version:"","function"==typeof e.peer5.getStats&&(t.sdnStats=e.peer5.getStats(),t.isP2PSdnUsed=e.peer5.getStats().numOfPeers>0))},t.showPlayerControls=function(e){return void 0!==e.allowPlayerControls?e.allowPlayerControls:e.streamingEventType===a.HydraStreamingEventType.TLE},t.createVideoElementDiv=function(e,t,i){i("createVideoElementDiv started");var n=t.ownerDocument.createElement("div");return n.id=e,n.style.position="relative",n.style.width="100%",n.style.height="100%",t.appendChild(n),i("createVideoElementDiv done"),n},t.createVideoElement=function(e,t,i,n,r){r("createVideoElement started");var s=t.ownerDocument.createElement("video");s.controls=n,s.id=e,s.setAttribute("playsinline","");var a=i.videoLang;a&&(s.setAttribute("lang",a),r("createVideoElement: language set to ".concat(a)));for(var o=i.videoElementStyles,l=0;l<o.length;l++)s.classList.add(o[l]);return s.style.width="100%",s.style.height="100%",s.style.position="absolute",s.muted=i.muteVideo,s.addEventListener("contextmenu",(function(e){e.preventDefault()})),["play","pause","stop","seekbackward","seekforward","seekto","previoustrack","nexttrack"].forEach((function(e){try{navigator.mediaSession.setActionHandler(e,(function(){}))}catch(e){}})),t.appendChild(s),r("createVideoElement done"),s}}},t={};return function i(n){var r=t[n];if(void 0!==r)return r.exports;var s=t[n]={exports:{}};return e[n].call(s.exports,s,s.exports,i),s.exports}(979)}()},"object"==typeof e&&"object"==typeof t?t.exports=i():(r=[],void 0===(s="function"==typeof(n=i)?n.apply(e,r):n)||(h.exports=s))}}),Z=v({"../node_modules/pako/lib/utils/common.js"(e){"use strict";var t="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;function i(e,t){return Object.prototype.hasOwnProperty.call(e,t)}e.assign=function(e){for(var t=Array.prototype.slice.call(arguments,1);t.length;){var n=t.shift();if(n){if("object"!=typeof n)throw new TypeError(n+"must be non-object");for(var r in n)i(n,r)&&(e[r]=n[r])}}return e},e.shrinkBuf=function(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)};var n={arraySet:function(e,t,i,n,r){if(t.subarray&&e.subarray)e.set(t.subarray(i,i+n),r);else for(var s=0;s<n;s++)e[r+s]=t[i+s]},flattenChunks:function(e){var t,i,n,r,s,a;for(n=0,t=0,i=e.length;t<i;t++)n+=e[t].length;for(a=new Uint8Array(n),r=0,t=0,i=e.length;t<i;t++)s=e[t],a.set(s,r),r+=s.length;return a}},r={arraySet:function(e,t,i,n,r){for(var s=0;s<n;s++)e[r+s]=t[i+s]},flattenChunks:function(e){return[].concat.apply([],e)}};e.setTyped=function(t){t?(e.Buf8=Uint8Array,e.Buf16=Uint16Array,e.Buf32=Int32Array,e.assign(e,n)):(e.Buf8=Array,e.Buf16=Array,e.Buf32=Array,e.assign(e,r))},e.setTyped(t)}}),ee=v({"../node_modules/pako/lib/zlib/trees.js"(e){"use strict";var t=Z();function i(e){for(var t=e.length;--t>=0;)e[t]=0}var n=256,r=286,s=30,a=15,o=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],l=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],d=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],c=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],h=new Array(576);i(h);var u=new Array(60);i(u);var p=new Array(512);i(p);var g=new Array(256);i(g);var m=new Array(29);i(m);var f,S,v,y=new Array(s);function C(e,t,i,n,r){this.static_tree=e,this.extra_bits=t,this.extra_base=i,this.elems=n,this.max_length=r,this.has_stree=e&&e.length}function T(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}function E(e){return e<256?p[e]:p[256+(e>>>7)]}function _(e,t){e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255}function b(e,t,i){e.bi_valid>16-i?(e.bi_buf|=t<<e.bi_valid&65535,_(e,e.bi_buf),e.bi_buf=t>>16-e.bi_valid,e.bi_valid+=i-16):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=i)}function P(e,t,i){b(e,i[2*t],i[2*t+1])}function I(e,t){var i=0;do{i|=1&e,e>>>=1,i<<=1}while(--t>0);return i>>>1}function A(e,t,i){var n,r,s=new Array(16),o=0;for(n=1;n<=a;n++)s[n]=o=o+i[n-1]<<1;for(r=0;r<=t;r++){var l=e[2*r+1];0!==l&&(e[2*r]=I(s[l]++,l))}}function R(e){var t;for(t=0;t<r;t++)e.dyn_ltree[2*t]=0;for(t=0;t<s;t++)e.dyn_dtree[2*t]=0;for(t=0;t<19;t++)e.bl_tree[2*t]=0;e.dyn_ltree[512]=1,e.opt_len=e.static_len=0,e.last_lit=e.matches=0}function w(e){e.bi_valid>8?_(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0}function M(e,t,i,n){var r=2*t,s=2*i;return e[r]<e[s]||e[r]===e[s]&&n[t]<=n[i]}function O(e,t,i){for(var n=e.heap[i],r=i<<1;r<=e.heap_len&&(r<e.heap_len&&M(t,e.heap[r+1],e.heap[r],e.depth)&&r++,!M(t,n,e.heap[r],e.depth));)e.heap[i]=e.heap[r],i=r,r<<=1;e.heap[i]=n}function D(e,t,i){var r,s,a,d,c=0;if(0!==e.last_lit)do{r=e.pending_buf[e.d_buf+2*c]<<8|e.pending_buf[e.d_buf+2*c+1],s=e.pending_buf[e.l_buf+c],c++,0===r?P(e,s,t):(P(e,(a=g[s])+n+1,t),0!==(d=o[a])&&b(e,s-=m[a],d),P(e,a=E(--r),i),0!==(d=l[a])&&b(e,r-=y[a],d))}while(c<e.last_lit);P(e,256,t)}function k(e,t){var i,n,r,s=t.dyn_tree,o=t.stat_desc.static_tree,l=t.stat_desc.has_stree,d=t.stat_desc.elems,c=-1;for(e.heap_len=0,e.heap_max=573,i=0;i<d;i++)0!==s[2*i]?(e.heap[++e.heap_len]=c=i,e.depth[i]=0):s[2*i+1]=0;for(;e.heap_len<2;)s[2*(r=e.heap[++e.heap_len]=c<2?++c:0)]=1,e.depth[r]=0,e.opt_len--,l&&(e.static_len-=o[2*r+1]);for(t.max_code=c,i=e.heap_len>>1;i>=1;i--)O(e,s,i);r=d;do{i=e.heap[1],e.heap[1]=e.heap[e.heap_len--],O(e,s,1),n=e.heap[1],e.heap[--e.heap_max]=i,e.heap[--e.heap_max]=n,s[2*r]=s[2*i]+s[2*n],e.depth[r]=(e.depth[i]>=e.depth[n]?e.depth[i]:e.depth[n])+1,s[2*i+1]=s[2*n+1]=r,e.heap[1]=r++,O(e,s,1)}while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],function(e,t){var i,n,r,s,o,l,d=t.dyn_tree,c=t.max_code,h=t.stat_desc.static_tree,u=t.stat_desc.has_stree,p=t.stat_desc.extra_bits,g=t.stat_desc.extra_base,m=t.stat_desc.max_length,f=0;for(s=0;s<=a;s++)e.bl_count[s]=0;for(d[2*e.heap[e.heap_max]+1]=0,i=e.heap_max+1;i<573;i++)(s=d[2*d[2*(n=e.heap[i])+1]+1]+1)>m&&(s=m,f++),d[2*n+1]=s,n>c||(e.bl_count[s]++,o=0,n>=g&&(o=p[n-g]),l=d[2*n],e.opt_len+=l*(s+o),u&&(e.static_len+=l*(h[2*n+1]+o)));if(0!==f){do{for(s=m-1;0===e.bl_count[s];)s--;e.bl_count[s]--,e.bl_count[s+1]+=2,e.bl_count[m]--,f-=2}while(f>0);for(s=m;0!==s;s--)for(n=e.bl_count[s];0!==n;)(r=e.heap[--i])>c||(d[2*r+1]!==s&&(e.opt_len+=(s-d[2*r+1])*d[2*r],d[2*r+1]=s),n--)}}(e,t),A(s,c,e.bl_count)}function N(e,t,i){var n,r,s=-1,a=t[1],o=0,l=7,d=4;for(0===a&&(l=138,d=3),t[2*(i+1)+1]=65535,n=0;n<=i;n++)r=a,a=t[2*(n+1)+1],++o<l&&r===a||(o<d?e.bl_tree[2*r]+=o:0!==r?(r!==s&&e.bl_tree[2*r]++,e.bl_tree[32]++):o<=10?e.bl_tree[34]++:e.bl_tree[36]++,o=0,s=r,0===a?(l=138,d=3):r===a?(l=6,d=3):(l=7,d=4))}function L(e,t,i){var n,r,s=-1,a=t[1],o=0,l=7,d=4;for(0===a&&(l=138,d=3),n=0;n<=i;n++)if(r=a,a=t[2*(n+1)+1],!(++o<l&&r===a)){if(o<d)do{P(e,r,e.bl_tree)}while(0!=--o);else 0!==r?(r!==s&&(P(e,r,e.bl_tree),o--),P(e,16,e.bl_tree),b(e,o-3,2)):o<=10?(P(e,17,e.bl_tree),b(e,o-3,3)):(P(e,18,e.bl_tree),b(e,o-11,7));o=0,s=r,0===a?(l=138,d=3):r===a?(l=6,d=3):(l=7,d=4)}}i(y);var x=!1;function F(e,i,n,r){b(e,0+(r?1:0),3),function(e,i,n,r){w(e),r&&(_(e,n),_(e,~n)),t.arraySet(e.pending_buf,e.window,i,n,e.pending),e.pending+=n}(e,i,n,!0)}e._tr_init=function(e){x||(function(){var e,t,i,n,c,T=new Array(16);for(i=0,n=0;n<28;n++)for(m[n]=i,e=0;e<1<<o[n];e++)g[i++]=n;for(g[i-1]=n,c=0,n=0;n<16;n++)for(y[n]=c,e=0;e<1<<l[n];e++)p[c++]=n;for(c>>=7;n<s;n++)for(y[n]=c<<7,e=0;e<1<<l[n]-7;e++)p[256+c++]=n;for(t=0;t<=a;t++)T[t]=0;for(e=0;e<=143;)h[2*e+1]=8,e++,T[8]++;for(;e<=255;)h[2*e+1]=9,e++,T[9]++;for(;e<=279;)h[2*e+1]=7,e++,T[7]++;for(;e<=287;)h[2*e+1]=8,e++,T[8]++;for(A(h,287,T),e=0;e<s;e++)u[2*e+1]=5,u[2*e]=I(e,5);f=new C(h,o,257,r,a),S=new C(u,l,0,s,a),v=new C(new Array(0),d,0,19,7)}(),x=!0),e.l_desc=new T(e.dyn_ltree,f),e.d_desc=new T(e.dyn_dtree,S),e.bl_desc=new T(e.bl_tree,v),e.bi_buf=0,e.bi_valid=0,R(e)},e._tr_stored_block=F,e._tr_flush_block=function(e,t,i,r){var s,a,o=0;e.level>0?(2===e.strm.data_type&&(e.strm.data_type=function(e){var t,i=4093624447;for(t=0;t<=31;t++,i>>>=1)if(1&i&&0!==e.dyn_ltree[2*t])return 0;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return 1;for(t=32;t<n;t++)if(0!==e.dyn_ltree[2*t])return 1;return 0}(e)),k(e,e.l_desc),k(e,e.d_desc),o=function(e){var t;for(N(e,e.dyn_ltree,e.l_desc.max_code),N(e,e.dyn_dtree,e.d_desc.max_code),k(e,e.bl_desc),t=18;t>=3&&0===e.bl_tree[2*c[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t}(e),s=e.opt_len+3+7>>>3,(a=e.static_len+3+7>>>3)<=s&&(s=a)):s=a=i+5,i+4<=s&&-1!==t?F(e,t,i,r):4===e.strategy||a===s?(b(e,2+(r?1:0),3),D(e,h,u)):(b(e,4+(r?1:0),3),function(e,t,i,n){var r;for(b(e,t-257,5),b(e,i-1,5),b(e,n-4,4),r=0;r<n;r++)b(e,e.bl_tree[2*c[r]+1],3);L(e,e.dyn_ltree,t-1),L(e,e.dyn_dtree,i-1)}(e,e.l_desc.max_code+1,e.d_desc.max_code+1,o+1),D(e,e.dyn_ltree,e.dyn_dtree)),R(e),r&&w(e)},e._tr_tally=function(e,t,i){return e.pending_buf[e.d_buf+2*e.last_lit]=t>>>8&255,e.pending_buf[e.d_buf+2*e.last_lit+1]=255&t,e.pending_buf[e.l_buf+e.last_lit]=255&i,e.last_lit++,0===t?e.dyn_ltree[2*i]++:(e.matches++,t--,e.dyn_ltree[2*(g[i]+n+1)]++,e.dyn_dtree[2*E(t)]++),e.last_lit===e.lit_bufsize-1},e._tr_align=function(e){b(e,2,3),P(e,256,h),function(e){16===e.bi_valid?(_(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)}(e)}}}),te=v({"../node_modules/pako/lib/zlib/adler32.js"(e,t){"use strict";t.exports=function(e,t,i,n){for(var r=65535&e|0,s=e>>>16&65535|0,a=0;0!==i;){i-=a=i>2e3?2e3:i;do{s=s+(r=r+t[n++]|0)|0}while(--a);r%=65521,s%=65521}return r|s<<16|0}}}),ie=v({"../node_modules/pako/lib/zlib/crc32.js"(e,t){"use strict";var i=function(){for(var e,t=[],i=0;i<256;i++){e=i;for(var n=0;n<8;n++)e=1&e?3988292384^e>>>1:e>>>1;t[i]=e}return t}();t.exports=function(e,t,n,r){var s=i,a=r+n;e^=-1;for(var o=r;o<a;o++)e=e>>>8^s[255&(e^t[o])];return-1^e}}}),ne=v({"../node_modules/pako/lib/zlib/messages.js"(e,t){"use strict";t.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}}}),re=v({"../node_modules/pako/lib/zlib/deflate.js"(e){"use strict";var t,i=Z(),n=ee(),r=te(),s=ie(),a=ne(),o=-2,l=258,d=262,c=103,h=113,u=666;function p(e,t){return e.msg=a[t],t}function g(e){return(e<<1)-(e>4?9:0)}function m(e){for(var t=e.length;--t>=0;)e[t]=0}function f(e){var t=e.state,n=t.pending;n>e.avail_out&&(n=e.avail_out),0!==n&&(i.arraySet(e.output,t.pending_buf,t.pending_out,n,e.next_out),e.next_out+=n,t.pending_out+=n,e.total_out+=n,e.avail_out-=n,t.pending-=n,0===t.pending&&(t.pending_out=0))}function S(e,t){n._tr_flush_block(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,f(e.strm)}function v(e,t){e.pending_buf[e.pending++]=t}function y(e,t){e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t}function C(e,t){var i,n,r=e.max_chain_length,s=e.strstart,a=e.prev_length,o=e.nice_match,c=e.strstart>e.w_size-d?e.strstart-(e.w_size-d):0,h=e.window,u=e.w_mask,p=e.prev,g=e.strstart+l,m=h[s+a-1],f=h[s+a];e.prev_length>=e.good_match&&(r>>=2),o>e.lookahead&&(o=e.lookahead);do{if(h[(i=t)+a]===f&&h[i+a-1]===m&&h[i]===h[s]&&h[++i]===h[s+1]){s+=2,i++;do{}while(h[++s]===h[++i]&&h[++s]===h[++i]&&h[++s]===h[++i]&&h[++s]===h[++i]&&h[++s]===h[++i]&&h[++s]===h[++i]&&h[++s]===h[++i]&&h[++s]===h[++i]&&s<g);if(n=l-(g-s),s=g-l,n>a){if(e.match_start=t,a=n,n>=o)break;m=h[s+a-1],f=h[s+a]}}}while((t=p[t&u])>c&&0!=--r);return a<=e.lookahead?a:e.lookahead}function T(e){var t,n,a,o,l,c,h,u,p,g,m=e.w_size;do{if(o=e.window_size-e.lookahead-e.strstart,e.strstart>=m+(m-d)){i.arraySet(e.window,e.window,m,m,0),e.match_start-=m,e.strstart-=m,e.block_start-=m,t=n=e.hash_size;do{a=e.head[--t],e.head[t]=a>=m?a-m:0}while(--n);t=n=m;do{a=e.prev[--t],e.prev[t]=a>=m?a-m:0}while(--n);o+=m}if(0===e.strm.avail_in)break;if(c=e.strm,h=e.window,u=e.strstart+e.lookahead,p=o,g=void 0,(g=c.avail_in)>p&&(g=p),n=0===g?0:(c.avail_in-=g,i.arraySet(h,c.input,c.next_in,g,u),1===c.state.wrap?c.adler=r(c.adler,h,g,u):2===c.state.wrap&&(c.adler=s(c.adler,h,g,u)),c.next_in+=g,c.total_in+=g,g),e.lookahead+=n,e.lookahead+e.insert>=3)for(l=e.strstart-e.insert,e.ins_h=e.window[l],e.ins_h=(e.ins_h<<e.hash_shift^e.window[l+1])&e.hash_mask;e.insert&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[l+3-1])&e.hash_mask,e.prev[l&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=l,l++,e.insert--,!(e.lookahead+e.insert<3)););}while(e.lookahead<d&&0!==e.strm.avail_in)}function E(e,t){for(var i,r;;){if(e.lookahead<d){if(T(e),e.lookahead<d&&0===t)return 1;if(0===e.lookahead)break}if(i=0,e.lookahead>=3&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==i&&e.strstart-i<=e.w_size-d&&(e.match_length=C(e,i)),e.match_length>=3)if(r=n._tr_tally(e,e.strstart-e.match_start,e.match_length-3),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=3){e.match_length--;do{e.strstart++,e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart}while(0!=--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+1])&e.hash_mask;else r=n._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(r&&(S(e,!1),0===e.strm.avail_out))return 1}return e.insert=e.strstart<2?e.strstart:2,4===t?(S(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(S(e,!1),0===e.strm.avail_out)?1:2}function _(e,t){for(var i,r,s;;){if(e.lookahead<d){if(T(e),e.lookahead<d&&0===t)return 1;if(0===e.lookahead)break}if(i=0,e.lookahead>=3&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=2,0!==i&&e.prev_length<e.max_lazy_match&&e.strstart-i<=e.w_size-d&&(e.match_length=C(e,i),e.match_length<=5&&(1===e.strategy||3===e.match_length&&e.strstart-e.match_start>4096)&&(e.match_length=2)),e.prev_length>=3&&e.match_length<=e.prev_length){s=e.strstart+e.lookahead-3,r=n._tr_tally(e,e.strstart-1-e.prev_match,e.prev_length-3),e.lookahead-=e.prev_length-1,e.prev_length-=2;do{++e.strstart<=s&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart)}while(0!=--e.prev_length);if(e.match_available=0,e.match_length=2,e.strstart++,r&&(S(e,!1),0===e.strm.avail_out))return 1}else if(e.match_available){if((r=n._tr_tally(e,0,e.window[e.strstart-1]))&&S(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return 1}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(r=n._tr_tally(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<2?e.strstart:2,4===t?(S(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(S(e,!1),0===e.strm.avail_out)?1:2}function b(e,t,i,n,r){this.good_length=e,this.max_lazy=t,this.nice_length=i,this.max_chain=n,this.func=r}function P(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=8,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new i.Buf16(1146),this.dyn_dtree=new i.Buf16(122),this.bl_tree=new i.Buf16(78),m(this.dyn_ltree),m(this.dyn_dtree),m(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new i.Buf16(16),this.heap=new i.Buf16(573),m(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new i.Buf16(573),m(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function I(e){var t;return e&&e.state?(e.total_in=e.total_out=0,e.data_type=2,(t=e.state).pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap?42:h,e.adler=2===t.wrap?0:1,t.last_flush=0,n._tr_init(t),0):p(e,o)}function A(e){var i,n=I(e);return 0===n&&((i=e.state).window_size=2*i.w_size,m(i.head),i.max_lazy_match=t[i.level].max_lazy,i.good_match=t[i.level].good_length,i.nice_match=t[i.level].nice_length,i.max_chain_length=t[i.level].max_chain,i.strstart=0,i.block_start=0,i.lookahead=0,i.insert=0,i.match_length=i.prev_length=2,i.match_available=0,i.ins_h=0),n}function R(e,t,n,r,s,a){if(!e)return o;var l=1;if(-1===t&&(t=6),r<0?(l=0,r=-r):r>15&&(l=2,r-=16),s<1||s>9||8!==n||r<8||r>15||t<0||t>9||a<0||a>4)return p(e,o);8===r&&(r=9);var d=new P;return e.state=d,d.strm=e,d.wrap=l,d.gzhead=null,d.w_bits=r,d.w_size=1<<d.w_bits,d.w_mask=d.w_size-1,d.hash_bits=s+7,d.hash_size=1<<d.hash_bits,d.hash_mask=d.hash_size-1,d.hash_shift=~~((d.hash_bits+3-1)/3),d.window=new i.Buf8(2*d.w_size),d.head=new i.Buf16(d.hash_size),d.prev=new i.Buf16(d.w_size),d.lit_bufsize=1<<s+6,d.pending_buf_size=4*d.lit_bufsize,d.pending_buf=new i.Buf8(d.pending_buf_size),d.d_buf=1*d.lit_bufsize,d.l_buf=3*d.lit_bufsize,d.level=t,d.strategy=a,d.method=n,A(e)}t=[new b(0,0,0,0,(function(e,t){var i=65535;for(i>e.pending_buf_size-5&&(i=e.pending_buf_size-5);;){if(e.lookahead<=1){if(T(e),0===e.lookahead&&0===t)return 1;if(0===e.lookahead)break}e.strstart+=e.lookahead,e.lookahead=0;var n=e.block_start+i;if((0===e.strstart||e.strstart>=n)&&(e.lookahead=e.strstart-n,e.strstart=n,S(e,!1),0===e.strm.avail_out))return 1;if(e.strstart-e.block_start>=e.w_size-d&&(S(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(S(e,!0),0===e.strm.avail_out?3:4):(e.strstart>e.block_start&&(S(e,!1),e.strm.avail_out),1)})),new b(4,4,8,4,E),new b(4,5,16,8,E),new b(4,6,32,32,E),new b(4,4,16,16,_),new b(8,16,32,32,_),new b(8,16,128,128,_),new b(8,32,128,256,_),new b(32,128,258,1024,_),new b(32,258,258,4096,_)],e.deflateInit=function(e,t){return R(e,t,8,15,8,0)},e.deflateInit2=R,e.deflateReset=A,e.deflateResetKeep=I,e.deflateSetHeader=function(e,t){return e&&e.state?2!==e.state.wrap?o:(e.state.gzhead=t,0):o},e.deflate=function(e,i){var r,a,d,C;if(!e||!e.state||i>5||i<0)return e?p(e,o):o;if(a=e.state,!e.output||!e.input&&0!==e.avail_in||a.status===u&&4!==i)return p(e,0===e.avail_out?-5:o);if(a.strm=e,r=a.last_flush,a.last_flush=i,42===a.status)if(2===a.wrap)e.adler=0,v(a,31),v(a,139),v(a,8),a.gzhead?(v(a,(a.gzhead.text?1:0)+(a.gzhead.hcrc?2:0)+(a.gzhead.extra?4:0)+(a.gzhead.name?8:0)+(a.gzhead.comment?16:0)),v(a,255&a.gzhead.time),v(a,a.gzhead.time>>8&255),v(a,a.gzhead.time>>16&255),v(a,a.gzhead.time>>24&255),v(a,9===a.level?2:a.strategy>=2||a.level<2?4:0),v(a,255&a.gzhead.os),a.gzhead.extra&&a.gzhead.extra.length&&(v(a,255&a.gzhead.extra.length),v(a,a.gzhead.extra.length>>8&255)),a.gzhead.hcrc&&(e.adler=s(e.adler,a.pending_buf,a.pending,0)),a.gzindex=0,a.status=69):(v(a,0),v(a,0),v(a,0),v(a,0),v(a,0),v(a,9===a.level?2:a.strategy>=2||a.level<2?4:0),v(a,3),a.status=h);else{var E=8+(a.w_bits-8<<4)<<8;E|=(a.strategy>=2||a.level<2?0:a.level<6?1:6===a.level?2:3)<<6,0!==a.strstart&&(E|=32),E+=31-E%31,a.status=h,y(a,E),0!==a.strstart&&(y(a,e.adler>>>16),y(a,65535&e.adler)),e.adler=1}if(69===a.status)if(a.gzhead.extra){for(d=a.pending;a.gzindex<(65535&a.gzhead.extra.length)&&(a.pending!==a.pending_buf_size||(a.gzhead.hcrc&&a.pending>d&&(e.adler=s(e.adler,a.pending_buf,a.pending-d,d)),f(e),d=a.pending,a.pending!==a.pending_buf_size));)v(a,255&a.gzhead.extra[a.gzindex]),a.gzindex++;a.gzhead.hcrc&&a.pending>d&&(e.adler=s(e.adler,a.pending_buf,a.pending-d,d)),a.gzindex===a.gzhead.extra.length&&(a.gzindex=0,a.status=73)}else a.status=73;if(73===a.status)if(a.gzhead.name){d=a.pending;do{if(a.pending===a.pending_buf_size&&(a.gzhead.hcrc&&a.pending>d&&(e.adler=s(e.adler,a.pending_buf,a.pending-d,d)),f(e),d=a.pending,a.pending===a.pending_buf_size)){C=1;break}C=a.gzindex<a.gzhead.name.length?255&a.gzhead.name.charCodeAt(a.gzindex++):0,v(a,C)}while(0!==C);a.gzhead.hcrc&&a.pending>d&&(e.adler=s(e.adler,a.pending_buf,a.pending-d,d)),0===C&&(a.gzindex=0,a.status=91)}else a.status=91;if(91===a.status)if(a.gzhead.comment){d=a.pending;do{if(a.pending===a.pending_buf_size&&(a.gzhead.hcrc&&a.pending>d&&(e.adler=s(e.adler,a.pending_buf,a.pending-d,d)),f(e),d=a.pending,a.pending===a.pending_buf_size)){C=1;break}C=a.gzindex<a.gzhead.comment.length?255&a.gzhead.comment.charCodeAt(a.gzindex++):0,v(a,C)}while(0!==C);a.gzhead.hcrc&&a.pending>d&&(e.adler=s(e.adler,a.pending_buf,a.pending-d,d)),0===C&&(a.status=c)}else a.status=c;if(a.status===c&&(a.gzhead.hcrc?(a.pending+2>a.pending_buf_size&&f(e),a.pending+2<=a.pending_buf_size&&(v(a,255&e.adler),v(a,e.adler>>8&255),e.adler=0,a.status=h)):a.status=h),0!==a.pending){if(f(e),0===e.avail_out)return a.last_flush=-1,0}else if(0===e.avail_in&&g(i)<=g(r)&&4!==i)return p(e,-5);if(a.status===u&&0!==e.avail_in)return p(e,-5);if(0!==e.avail_in||0!==a.lookahead||0!==i&&a.status!==u){var _=2===a.strategy?function(e,t){for(var i;;){if(0===e.lookahead&&(T(e),0===e.lookahead)){if(0===t)return 1;break}if(e.match_length=0,i=n._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,i&&(S(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(S(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(S(e,!1),0===e.strm.avail_out)?1:2}(a,i):3===a.strategy?function(e,t){for(var i,r,s,a,o=e.window;;){if(e.lookahead<=l){if(T(e),e.lookahead<=l&&0===t)return 1;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=3&&e.strstart>0&&(r=o[s=e.strstart-1])===o[++s]&&r===o[++s]&&r===o[++s]){a=e.strstart+l;do{}while(r===o[++s]&&r===o[++s]&&r===o[++s]&&r===o[++s]&&r===o[++s]&&r===o[++s]&&r===o[++s]&&r===o[++s]&&s<a);e.match_length=l-(a-s),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=3?(i=n._tr_tally(e,1,e.match_length-3),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(i=n._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),i&&(S(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(S(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(S(e,!1),0===e.strm.avail_out)?1:2}(a,i):t[a.level].func(a,i);if(3!==_&&4!==_||(a.status=u),1===_||3===_)return 0===e.avail_out&&(a.last_flush=-1),0;if(2===_&&(1===i?n._tr_align(a):5!==i&&(n._tr_stored_block(a,0,0,!1),3===i&&(m(a.head),0===a.lookahead&&(a.strstart=0,a.block_start=0,a.insert=0))),f(e),0===e.avail_out))return a.last_flush=-1,0}return 4!==i?0:a.wrap<=0?1:(2===a.wrap?(v(a,255&e.adler),v(a,e.adler>>8&255),v(a,e.adler>>16&255),v(a,e.adler>>24&255),v(a,255&e.total_in),v(a,e.total_in>>8&255),v(a,e.total_in>>16&255),v(a,e.total_in>>24&255)):(y(a,e.adler>>>16),y(a,65535&e.adler)),f(e),a.wrap>0&&(a.wrap=-a.wrap),0!==a.pending?0:1)},e.deflateEnd=function(e){var t;return e&&e.state?42!==(t=e.state.status)&&69!==t&&73!==t&&91!==t&&t!==c&&t!==h&&t!==u?p(e,o):(e.state=null,t===h?p(e,-3):0):o},e.deflateSetDictionary=function(e,t){var n,s,a,l,d,c,h,u,p=t.length;if(!e||!e.state)return o;if(2===(l=(n=e.state).wrap)||1===l&&42!==n.status||n.lookahead)return o;for(1===l&&(e.adler=r(e.adler,t,p,0)),n.wrap=0,p>=n.w_size&&(0===l&&(m(n.head),n.strstart=0,n.block_start=0,n.insert=0),u=new i.Buf8(n.w_size),i.arraySet(u,t,p-n.w_size,n.w_size,0),t=u,p=n.w_size),d=e.avail_in,c=e.next_in,h=e.input,e.avail_in=p,e.next_in=0,e.input=t,T(n);n.lookahead>=3;){s=n.strstart,a=n.lookahead-2;do{n.ins_h=(n.ins_h<<n.hash_shift^n.window[s+3-1])&n.hash_mask,n.prev[s&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=s,s++}while(--a);n.strstart=s,n.lookahead=2,T(n)}return n.strstart+=n.lookahead,n.block_start=n.strstart,n.insert=n.lookahead,n.lookahead=0,n.match_length=n.prev_length=2,n.match_available=0,e.next_in=c,e.input=h,e.avail_in=d,n.wrap=l,0},e.deflateInfo="pako deflate (from Nodeca project)"}}),se=v({"../node_modules/pako/lib/utils/strings.js"(e){"use strict";var t=Z(),i=!0,n=!0;try{String.fromCharCode.apply(null,[0])}catch(e){i=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){n=!1}var r,s=new t.Buf8(256);for(r=0;r<256;r++)s[r]=r>=252?6:r>=248?5:r>=240?4:r>=224?3:r>=192?2:1;function a(e,r){if(r<65534&&(e.subarray&&n||!e.subarray&&i))return String.fromCharCode.apply(null,t.shrinkBuf(e,r));for(var s="",a=0;a<r;a++)s+=String.fromCharCode(e[a]);return s}s[254]=s[254]=1,e.string2buf=function(e){var i,n,r,s,a,o=e.length,l=0;for(s=0;s<o;s++)55296==(64512&(n=e.charCodeAt(s)))&&s+1<o&&56320==(64512&(r=e.charCodeAt(s+1)))&&(n=65536+(n-55296<<10)+(r-56320),s++),l+=n<128?1:n<2048?2:n<65536?3:4;for(i=new t.Buf8(l),a=0,s=0;a<l;s++)55296==(64512&(n=e.charCodeAt(s)))&&s+1<o&&56320==(64512&(r=e.charCodeAt(s+1)))&&(n=65536+(n-55296<<10)+(r-56320),s++),n<128?i[a++]=n:n<2048?(i[a++]=192|n>>>6,i[a++]=128|63&n):n<65536?(i[a++]=224|n>>>12,i[a++]=128|n>>>6&63,i[a++]=128|63&n):(i[a++]=240|n>>>18,i[a++]=128|n>>>12&63,i[a++]=128|n>>>6&63,i[a++]=128|63&n);return i},e.buf2binstring=function(e){return a(e,e.length)},e.binstring2buf=function(e){for(var i=new t.Buf8(e.length),n=0,r=i.length;n<r;n++)i[n]=e.charCodeAt(n);return i},e.buf2string=function(e,t){var i,n,r,o,l=t||e.length,d=new Array(2*l);for(n=0,i=0;i<l;)if((r=e[i++])<128)d[n++]=r;else if((o=s[r])>4)d[n++]=65533,i+=o-1;else{for(r&=2===o?31:3===o?15:7;o>1&&i<l;)r=r<<6|63&e[i++],o--;o>1?d[n++]=65533:r<65536?d[n++]=r:(r-=65536,d[n++]=55296|r>>10&1023,d[n++]=56320|1023&r)}return a(d,n)},e.utf8border=function(e,t){var i;for((t=t||e.length)>e.length&&(t=e.length),i=t-1;i>=0&&128==(192&e[i]);)i--;return i<0||0===i?t:i+s[e[i]]>t?i:t}}}),ae=v({"../node_modules/pako/lib/zlib/zstream.js"(e,t){"use strict";t.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}}}),oe=v({"../node_modules/pako/lib/deflate.js"(e){"use strict";var t=re(),i=Z(),n=se(),r=ne(),s=ae(),a=Object.prototype.toString;function o(e){if(!(this instanceof o))return new o(e);this.options=i.assign({level:-1,method:8,chunkSize:16384,windowBits:15,memLevel:8,strategy:0,to:""},e||{});var l=this.options;l.raw&&l.windowBits>0?l.windowBits=-l.windowBits:l.gzip&&l.windowBits>0&&l.windowBits<16&&(l.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new s,this.strm.avail_out=0;var d=t.deflateInit2(this.strm,l.level,l.method,l.windowBits,l.memLevel,l.strategy);if(0!==d)throw new Error(r[d]);if(l.header&&t.deflateSetHeader(this.strm,l.header),l.dictionary){var c;if(c="string"==typeof l.dictionary?n.string2buf(l.dictionary):"[object ArrayBuffer]"===a.call(l.dictionary)?new Uint8Array(l.dictionary):l.dictionary,0!==(d=t.deflateSetDictionary(this.strm,c)))throw new Error(r[d]);this._dict_set=!0}}function l(e,t){var i=new o(t);if(i.push(e,!0),i.err)throw i.msg||r[i.err];return i.result}o.prototype.push=function(e,r){var s,o,l=this.strm,d=this.options.chunkSize;if(this.ended)return!1;o=r===~~r?r:!0===r?4:0,"string"==typeof e?l.input=n.string2buf(e):"[object ArrayBuffer]"===a.call(e)?l.input=new Uint8Array(e):l.input=e,l.next_in=0,l.avail_in=l.input.length;do{if(0===l.avail_out&&(l.output=new i.Buf8(d),l.next_out=0,l.avail_out=d),1!==(s=t.deflate(l,o))&&0!==s)return this.onEnd(s),this.ended=!0,!1;0!==l.avail_out&&(0!==l.avail_in||4!==o&&2!==o)||("string"===this.options.to?this.onData(n.buf2binstring(i.shrinkBuf(l.output,l.next_out))):this.onData(i.shrinkBuf(l.output,l.next_out)))}while((l.avail_in>0||0===l.avail_out)&&1!==s);return 4===o?(s=t.deflateEnd(this.strm),this.onEnd(s),this.ended=!0,0===s):2!==o||(this.onEnd(0),l.avail_out=0,!0)},o.prototype.onData=function(e){this.chunks.push(e)},o.prototype.onEnd=function(e){0===e&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=i.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},e.Deflate=o,e.deflate=l,e.deflateRaw=function(e,t){return(t=t||{}).raw=!0,l(e,t)},e.gzip=function(e,t){return(t=t||{}).gzip=!0,l(e,t)}}}),le=v({"../node_modules/pako/lib/zlib/inffast.js"(e,t){"use strict";t.exports=function(e,t){var i,n,r,s,a,o,l,d,c,h,u,p,g,m,f,S,v,y,C,T,E,_,b,P,I;i=e.state,n=e.next_in,P=e.input,r=n+(e.avail_in-5),s=e.next_out,I=e.output,a=s-(t-e.avail_out),o=s+(e.avail_out-257),l=i.dmax,d=i.wsize,c=i.whave,h=i.wnext,u=i.window,p=i.hold,g=i.bits,m=i.lencode,f=i.distcode,S=(1<<i.lenbits)-1,v=(1<<i.distbits)-1;e:do{g<15&&(p+=P[n++]<<g,g+=8,p+=P[n++]<<g,g+=8),y=m[p&S];t:for(;;){if(p>>>=C=y>>>24,g-=C,0==(C=y>>>16&255))I[s++]=65535&y;else{if(!(16&C)){if(0==(64&C)){y=m[(65535&y)+(p&(1<<C)-1)];continue t}if(32&C){i.mode=12;break e}e.msg="invalid literal/length code",i.mode=30;break e}T=65535&y,(C&=15)&&(g<C&&(p+=P[n++]<<g,g+=8),T+=p&(1<<C)-1,p>>>=C,g-=C),g<15&&(p+=P[n++]<<g,g+=8,p+=P[n++]<<g,g+=8),y=f[p&v];i:for(;;){if(p>>>=C=y>>>24,g-=C,!(16&(C=y>>>16&255))){if(0==(64&C)){y=f[(65535&y)+(p&(1<<C)-1)];continue i}e.msg="invalid distance code",i.mode=30;break e}if(E=65535&y,g<(C&=15)&&(p+=P[n++]<<g,(g+=8)<C&&(p+=P[n++]<<g,g+=8)),(E+=p&(1<<C)-1)>l){e.msg="invalid distance too far back",i.mode=30;break e}if(p>>>=C,g-=C,E>(C=s-a)){if((C=E-C)>c&&i.sane){e.msg="invalid distance too far back",i.mode=30;break e}if(_=0,b=u,0===h){if(_+=d-C,C<T){T-=C;do{I[s++]=u[_++]}while(--C);_=s-E,b=I}}else if(h<C){if(_+=d+h-C,(C-=h)<T){T-=C;do{I[s++]=u[_++]}while(--C);if(_=0,h<T){T-=C=h;do{I[s++]=u[_++]}while(--C);_=s-E,b=I}}}else if(_+=h-C,C<T){T-=C;do{I[s++]=u[_++]}while(--C);_=s-E,b=I}for(;T>2;)I[s++]=b[_++],I[s++]=b[_++],I[s++]=b[_++],T-=3;T&&(I[s++]=b[_++],T>1&&(I[s++]=b[_++]))}else{_=s-E;do{I[s++]=I[_++],I[s++]=I[_++],I[s++]=I[_++],T-=3}while(T>2);T&&(I[s++]=I[_++],T>1&&(I[s++]=I[_++]))}break}}break}}while(n<r&&s<o);n-=T=g>>3,p&=(1<<(g-=T<<3))-1,e.next_in=n,e.next_out=s,e.avail_in=n<r?r-n+5:5-(n-r),e.avail_out=s<o?o-s+257:257-(s-o),i.hold=p,i.bits=g}}}),de=v({"../node_modules/pako/lib/zlib/inftrees.js"(e,t){"use strict";var i=Z(),n=15,r=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],s=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],a=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],o=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];t.exports=function(e,t,l,d,c,h,u,p){var g,m,f,S,v,y,C,T,E,_=p.bits,b=0,P=0,I=0,A=0,R=0,w=0,M=0,O=0,D=0,k=0,N=null,L=0,x=new i.Buf16(16),F=new i.Buf16(16),U=null,V=0;for(b=0;b<=n;b++)x[b]=0;for(P=0;P<d;P++)x[t[l+P]]++;for(R=_,A=n;A>=1&&0===x[A];A--);if(R>A&&(R=A),0===A)return c[h++]=20971520,c[h++]=20971520,p.bits=1,0;for(I=1;I<A&&0===x[I];I++);for(R<I&&(R=I),O=1,b=1;b<=n;b++)if(O<<=1,(O-=x[b])<0)return-1;if(O>0&&(0===e||1!==A))return-1;for(F[1]=0,b=1;b<n;b++)F[b+1]=F[b]+x[b];for(P=0;P<d;P++)0!==t[l+P]&&(u[F[t[l+P]]++]=P);if(0===e?(N=U=u,y=19):1===e?(N=r,L-=257,U=s,V-=257,y=256):(N=a,U=o,y=-1),k=0,P=0,b=I,v=h,w=R,M=0,f=-1,S=(D=1<<R)-1,1===e&&D>852||2===e&&D>592)return 1;for(;;){C=b-M,u[P]<y?(T=0,E=u[P]):u[P]>y?(T=U[V+u[P]],E=N[L+u[P]]):(T=96,E=0),g=1<<b-M,I=m=1<<w;do{c[v+(k>>M)+(m-=g)]=C<<24|T<<16|E|0}while(0!==m);for(g=1<<b-1;k&g;)g>>=1;if(0!==g?(k&=g-1,k+=g):k=0,P++,0==--x[b]){if(b===A)break;b=t[l+u[P]]}if(b>R&&(k&S)!==f){for(0===M&&(M=R),v+=I,O=1<<(w=b-M);w+M<A&&!((O-=x[w+M])<=0);)w++,O<<=1;if(D+=1<<w,1===e&&D>852||2===e&&D>592)return 1;c[f=k&S]=R<<24|w<<16|v-h|0}}return 0!==k&&(c[v+k]=b-M<<24|64<<16|0),p.bits=R,0}}}),ce=v({"../node_modules/pako/lib/zlib/inflate.js"(e){"use strict";var t=Z(),i=te(),n=ie(),r=le(),s=de(),a=-2,o=12,l=30;function d(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function c(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new t.Buf16(320),this.work=new t.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function h(e){var i;return e&&e.state?(i=e.state,e.total_in=e.total_out=i.total=0,e.msg="",i.wrap&&(e.adler=1&i.wrap),i.mode=1,i.last=0,i.havedict=0,i.dmax=32768,i.head=null,i.hold=0,i.bits=0,i.lencode=i.lendyn=new t.Buf32(852),i.distcode=i.distdyn=new t.Buf32(592),i.sane=1,i.back=-1,0):a}function u(e){var t;return e&&e.state?((t=e.state).wsize=0,t.whave=0,t.wnext=0,h(e)):a}function p(e,t){var i,n;return e&&e.state?(n=e.state,t<0?(i=0,t=-t):(i=1+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?a:(null!==n.window&&n.wbits!==t&&(n.window=null),n.wrap=i,n.wbits=t,u(e))):a}function g(e,t){var i,n;return e?(n=new c,e.state=n,n.window=null,0!==(i=p(e,t))&&(e.state=null),i):a}var m,f,S=!0;function v(e){if(S){var i;for(m=new t.Buf32(512),f=new t.Buf32(32),i=0;i<144;)e.lens[i++]=8;for(;i<256;)e.lens[i++]=9;for(;i<280;)e.lens[i++]=7;for(;i<288;)e.lens[i++]=8;for(s(1,e.lens,0,288,m,0,e.work,{bits:9}),i=0;i<32;)e.lens[i++]=5;s(2,e.lens,0,32,f,0,e.work,{bits:5}),S=!1}e.lencode=m,e.lenbits=9,e.distcode=f,e.distbits=5}function y(e,i,n,r){var s,a=e.state;return null===a.window&&(a.wsize=1<<a.wbits,a.wnext=0,a.whave=0,a.window=new t.Buf8(a.wsize)),r>=a.wsize?(t.arraySet(a.window,i,n-a.wsize,a.wsize,0),a.wnext=0,a.whave=a.wsize):((s=a.wsize-a.wnext)>r&&(s=r),t.arraySet(a.window,i,n-r,s,a.wnext),(r-=s)?(t.arraySet(a.window,i,n-r,r,0),a.wnext=r,a.whave=a.wsize):(a.wnext+=s,a.wnext===a.wsize&&(a.wnext=0),a.whave<a.wsize&&(a.whave+=s))),0}e.inflateReset=u,e.inflateReset2=p,e.inflateResetKeep=h,e.inflateInit=function(e){return g(e,15)},e.inflateInit2=g,e.inflate=function(e,c){var h,u,p,g,m,f,S,C,T,E,_,b,P,I,A,R,w,M,O,D,k,N,L,x,F=0,U=new t.Buf8(4),V=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return a;(h=e.state).mode===o&&(h.mode=13),m=e.next_out,p=e.output,S=e.avail_out,g=e.next_in,u=e.input,f=e.avail_in,C=h.hold,T=h.bits,E=f,_=S,N=0;e:for(;;)switch(h.mode){case 1:if(0===h.wrap){h.mode=13;break}for(;T<16;){if(0===f)break e;f--,C+=u[g++]<<T,T+=8}if(2&h.wrap&&35615===C){h.check=0,U[0]=255&C,U[1]=C>>>8&255,h.check=n(h.check,U,2,0),C=0,T=0,h.mode=2;break}if(h.flags=0,h.head&&(h.head.done=!1),!(1&h.wrap)||(((255&C)<<8)+(C>>8))%31){e.msg="incorrect header check",h.mode=l;break}if(8!=(15&C)){e.msg="unknown compression method",h.mode=l;break}if(T-=4,k=8+(15&(C>>>=4)),0===h.wbits)h.wbits=k;else if(k>h.wbits){e.msg="invalid window size",h.mode=l;break}h.dmax=1<<k,e.adler=h.check=1,h.mode=512&C?10:o,C=0,T=0;break;case 2:for(;T<16;){if(0===f)break e;f--,C+=u[g++]<<T,T+=8}if(h.flags=C,8!=(255&h.flags)){e.msg="unknown compression method",h.mode=l;break}if(57344&h.flags){e.msg="unknown header flags set",h.mode=l;break}h.head&&(h.head.text=C>>8&1),512&h.flags&&(U[0]=255&C,U[1]=C>>>8&255,h.check=n(h.check,U,2,0)),C=0,T=0,h.mode=3;case 3:for(;T<32;){if(0===f)break e;f--,C+=u[g++]<<T,T+=8}h.head&&(h.head.time=C),512&h.flags&&(U[0]=255&C,U[1]=C>>>8&255,U[2]=C>>>16&255,U[3]=C>>>24&255,h.check=n(h.check,U,4,0)),C=0,T=0,h.mode=4;case 4:for(;T<16;){if(0===f)break e;f--,C+=u[g++]<<T,T+=8}h.head&&(h.head.xflags=255&C,h.head.os=C>>8),512&h.flags&&(U[0]=255&C,U[1]=C>>>8&255,h.check=n(h.check,U,2,0)),C=0,T=0,h.mode=5;case 5:if(1024&h.flags){for(;T<16;){if(0===f)break e;f--,C+=u[g++]<<T,T+=8}h.length=C,h.head&&(h.head.extra_len=C),512&h.flags&&(U[0]=255&C,U[1]=C>>>8&255,h.check=n(h.check,U,2,0)),C=0,T=0}else h.head&&(h.head.extra=null);h.mode=6;case 6:if(1024&h.flags&&((b=h.length)>f&&(b=f),b&&(h.head&&(k=h.head.extra_len-h.length,h.head.extra||(h.head.extra=new Array(h.head.extra_len)),t.arraySet(h.head.extra,u,g,b,k)),512&h.flags&&(h.check=n(h.check,u,b,g)),f-=b,g+=b,h.length-=b),h.length))break e;h.length=0,h.mode=7;case 7:if(2048&h.flags){if(0===f)break e;b=0;do{k=u[g+b++],h.head&&k&&h.length<65536&&(h.head.name+=String.fromCharCode(k))}while(k&&b<f);if(512&h.flags&&(h.check=n(h.check,u,b,g)),f-=b,g+=b,k)break e}else h.head&&(h.head.name=null);h.length=0,h.mode=8;case 8:if(4096&h.flags){if(0===f)break e;b=0;do{k=u[g+b++],h.head&&k&&h.length<65536&&(h.head.comment+=String.fromCharCode(k))}while(k&&b<f);if(512&h.flags&&(h.check=n(h.check,u,b,g)),f-=b,g+=b,k)break e}else h.head&&(h.head.comment=null);h.mode=9;case 9:if(512&h.flags){for(;T<16;){if(0===f)break e;f--,C+=u[g++]<<T,T+=8}if(C!==(65535&h.check)){e.msg="header crc mismatch",h.mode=l;break}C=0,T=0}h.head&&(h.head.hcrc=h.flags>>9&1,h.head.done=!0),e.adler=h.check=0,h.mode=o;break;case 10:for(;T<32;){if(0===f)break e;f--,C+=u[g++]<<T,T+=8}e.adler=h.check=d(C),C=0,T=0,h.mode=11;case 11:if(0===h.havedict)return e.next_out=m,e.avail_out=S,e.next_in=g,e.avail_in=f,h.hold=C,h.bits=T,2;e.adler=h.check=1,h.mode=o;case o:if(5===c||6===c)break e;case 13:if(h.last){C>>>=7&T,T-=7&T,h.mode=27;break}for(;T<3;){if(0===f)break e;f--,C+=u[g++]<<T,T+=8}switch(h.last=1&C,T-=1,3&(C>>>=1)){case 0:h.mode=14;break;case 1:if(v(h),h.mode=20,6===c){C>>>=2,T-=2;break e}break;case 2:h.mode=17;break;case 3:e.msg="invalid block type",h.mode=l}C>>>=2,T-=2;break;case 14:for(C>>>=7&T,T-=7&T;T<32;){if(0===f)break e;f--,C+=u[g++]<<T,T+=8}if((65535&C)!=(C>>>16^65535)){e.msg="invalid stored block lengths",h.mode=l;break}if(h.length=65535&C,C=0,T=0,h.mode=15,6===c)break e;case 15:h.mode=16;case 16:if(b=h.length){if(b>f&&(b=f),b>S&&(b=S),0===b)break e;t.arraySet(p,u,g,b,m),f-=b,g+=b,S-=b,m+=b,h.length-=b;break}h.mode=o;break;case 17:for(;T<14;){if(0===f)break e;f--,C+=u[g++]<<T,T+=8}if(h.nlen=257+(31&C),C>>>=5,T-=5,h.ndist=1+(31&C),C>>>=5,T-=5,h.ncode=4+(15&C),C>>>=4,T-=4,h.nlen>286||h.ndist>30){e.msg="too many length or distance symbols",h.mode=l;break}h.have=0,h.mode=18;case 18:for(;h.have<h.ncode;){for(;T<3;){if(0===f)break e;f--,C+=u[g++]<<T,T+=8}h.lens[V[h.have++]]=7&C,C>>>=3,T-=3}for(;h.have<19;)h.lens[V[h.have++]]=0;if(h.lencode=h.lendyn,h.lenbits=7,L={bits:h.lenbits},N=s(0,h.lens,0,19,h.lencode,0,h.work,L),h.lenbits=L.bits,N){e.msg="invalid code lengths set",h.mode=l;break}h.have=0,h.mode=19;case 19:for(;h.have<h.nlen+h.ndist;){for(;R=(F=h.lencode[C&(1<<h.lenbits)-1])>>>16&255,w=65535&F,!((A=F>>>24)<=T);){if(0===f)break e;f--,C+=u[g++]<<T,T+=8}if(w<16)C>>>=A,T-=A,h.lens[h.have++]=w;else{if(16===w){for(x=A+2;T<x;){if(0===f)break e;f--,C+=u[g++]<<T,T+=8}if(C>>>=A,T-=A,0===h.have){e.msg="invalid bit length repeat",h.mode=l;break}k=h.lens[h.have-1],b=3+(3&C),C>>>=2,T-=2}else if(17===w){for(x=A+3;T<x;){if(0===f)break e;f--,C+=u[g++]<<T,T+=8}T-=A,k=0,b=3+(7&(C>>>=A)),C>>>=3,T-=3}else{for(x=A+7;T<x;){if(0===f)break e;f--,C+=u[g++]<<T,T+=8}T-=A,k=0,b=11+(127&(C>>>=A)),C>>>=7,T-=7}if(h.have+b>h.nlen+h.ndist){e.msg="invalid bit length repeat",h.mode=l;break}for(;b--;)h.lens[h.have++]=k}}if(h.mode===l)break;if(0===h.lens[256]){e.msg="invalid code -- missing end-of-block",h.mode=l;break}if(h.lenbits=9,L={bits:h.lenbits},N=s(1,h.lens,0,h.nlen,h.lencode,0,h.work,L),h.lenbits=L.bits,N){e.msg="invalid literal/lengths set",h.mode=l;break}if(h.distbits=6,h.distcode=h.distdyn,L={bits:h.distbits},N=s(2,h.lens,h.nlen,h.ndist,h.distcode,0,h.work,L),h.distbits=L.bits,N){e.msg="invalid distances set",h.mode=l;break}if(h.mode=20,6===c)break e;case 20:h.mode=21;case 21:if(f>=6&&S>=258){e.next_out=m,e.avail_out=S,e.next_in=g,e.avail_in=f,h.hold=C,h.bits=T,r(e,_),m=e.next_out,p=e.output,S=e.avail_out,g=e.next_in,u=e.input,f=e.avail_in,C=h.hold,T=h.bits,h.mode===o&&(h.back=-1);break}for(h.back=0;R=(F=h.lencode[C&(1<<h.lenbits)-1])>>>16&255,w=65535&F,!((A=F>>>24)<=T);){if(0===f)break e;f--,C+=u[g++]<<T,T+=8}if(R&&0==(240&R)){for(M=A,O=R,D=w;R=(F=h.lencode[D+((C&(1<<M+O)-1)>>M)])>>>16&255,w=65535&F,!(M+(A=F>>>24)<=T);){if(0===f)break e;f--,C+=u[g++]<<T,T+=8}C>>>=M,T-=M,h.back+=M}if(C>>>=A,T-=A,h.back+=A,h.length=w,0===R){h.mode=26;break}if(32&R){h.back=-1,h.mode=o;break}if(64&R){e.msg="invalid literal/length code",h.mode=l;break}h.extra=15&R,h.mode=22;case 22:if(h.extra){for(x=h.extra;T<x;){if(0===f)break e;f--,C+=u[g++]<<T,T+=8}h.length+=C&(1<<h.extra)-1,C>>>=h.extra,T-=h.extra,h.back+=h.extra}h.was=h.length,h.mode=23;case 23:for(;R=(F=h.distcode[C&(1<<h.distbits)-1])>>>16&255,w=65535&F,!((A=F>>>24)<=T);){if(0===f)break e;f--,C+=u[g++]<<T,T+=8}if(0==(240&R)){for(M=A,O=R,D=w;R=(F=h.distcode[D+((C&(1<<M+O)-1)>>M)])>>>16&255,w=65535&F,!(M+(A=F>>>24)<=T);){if(0===f)break e;f--,C+=u[g++]<<T,T+=8}C>>>=M,T-=M,h.back+=M}if(C>>>=A,T-=A,h.back+=A,64&R){e.msg="invalid distance code",h.mode=l;break}h.offset=w,h.extra=15&R,h.mode=24;case 24:if(h.extra){for(x=h.extra;T<x;){if(0===f)break e;f--,C+=u[g++]<<T,T+=8}h.offset+=C&(1<<h.extra)-1,C>>>=h.extra,T-=h.extra,h.back+=h.extra}if(h.offset>h.dmax){e.msg="invalid distance too far back",h.mode=l;break}h.mode=25;case 25:if(0===S)break e;if(b=_-S,h.offset>b){if((b=h.offset-b)>h.whave&&h.sane){e.msg="invalid distance too far back",h.mode=l;break}b>h.wnext?(b-=h.wnext,P=h.wsize-b):P=h.wnext-b,b>h.length&&(b=h.length),I=h.window}else I=p,P=m-h.offset,b=h.length;b>S&&(b=S),S-=b,h.length-=b;do{p[m++]=I[P++]}while(--b);0===h.length&&(h.mode=21);break;case 26:if(0===S)break e;p[m++]=h.length,S--,h.mode=21;break;case 27:if(h.wrap){for(;T<32;){if(0===f)break e;f--,C|=u[g++]<<T,T+=8}if(_-=S,e.total_out+=_,h.total+=_,_&&(e.adler=h.check=h.flags?n(h.check,p,_,m-_):i(h.check,p,_,m-_)),_=S,(h.flags?C:d(C))!==h.check){e.msg="incorrect data check",h.mode=l;break}C=0,T=0}h.mode=28;case 28:if(h.wrap&&h.flags){for(;T<32;){if(0===f)break e;f--,C+=u[g++]<<T,T+=8}if(C!==(4294967295&h.total)){e.msg="incorrect length check",h.mode=l;break}C=0,T=0}h.mode=29;case 29:N=1;break e;case l:N=-3;break e;case 31:return-4;default:return a}return e.next_out=m,e.avail_out=S,e.next_in=g,e.avail_in=f,h.hold=C,h.bits=T,(h.wsize||_!==e.avail_out&&h.mode<l&&(h.mode<27||4!==c))&&y(e,e.output,e.next_out,_-e.avail_out)?(h.mode=31,-4):(E-=e.avail_in,_-=e.avail_out,e.total_in+=E,e.total_out+=_,h.total+=_,h.wrap&&_&&(e.adler=h.check=h.flags?n(h.check,p,_,e.next_out-_):i(h.check,p,_,e.next_out-_)),e.data_type=h.bits+(h.last?64:0)+(h.mode===o?128:0)+(20===h.mode||15===h.mode?256:0),(0===E&&0===_||4===c)&&0===N&&(N=-5),N)},e.inflateEnd=function(e){if(!e||!e.state)return a;var t=e.state;return t.window&&(t.window=null),e.state=null,0},e.inflateGetHeader=function(e,t){var i;return e&&e.state?0==(2&(i=e.state).wrap)?a:(i.head=t,t.done=!1,0):a},e.inflateSetDictionary=function(e,t){var n,r=t.length;return e&&e.state?0!==(n=e.state).wrap&&11!==n.mode?a:11===n.mode&&i(1,t,r,0)!==n.check?-3:y(e,t,r,r)?(n.mode=31,-4):(n.havedict=1,0):a},e.inflateInfo="pako inflate (from Nodeca project)"}}),he=v({"../node_modules/pako/lib/zlib/constants.js"(e,t){"use strict";t.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}}}),ue=v({"../node_modules/pako/lib/zlib/gzheader.js"(e,t){"use strict";t.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}}}),pe=v({"../node_modules/pako/lib/inflate.js"(e){"use strict";var t=ce(),i=Z(),n=se(),r=he(),s=ne(),a=ae(),o=ue(),l=Object.prototype.toString;function d(e){if(!(this instanceof d))return new d(e);this.options=i.assign({chunkSize:16384,windowBits:0,to:""},e||{});var c=this.options;c.raw&&c.windowBits>=0&&c.windowBits<16&&(c.windowBits=-c.windowBits,0===c.windowBits&&(c.windowBits=-15)),!(c.windowBits>=0&&c.windowBits<16)||e&&e.windowBits||(c.windowBits+=32),c.windowBits>15&&c.windowBits<48&&0==(15&c.windowBits)&&(c.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new a,this.strm.avail_out=0;var h=t.inflateInit2(this.strm,c.windowBits);if(h!==r.Z_OK)throw new Error(s[h]);if(this.header=new o,t.inflateGetHeader(this.strm,this.header),c.dictionary&&("string"==typeof c.dictionary?c.dictionary=n.string2buf(c.dictionary):"[object ArrayBuffer]"===l.call(c.dictionary)&&(c.dictionary=new Uint8Array(c.dictionary)),c.raw&&(h=t.inflateSetDictionary(this.strm,c.dictionary))!==r.Z_OK))throw new Error(s[h])}function c(e,t){var i=new d(t);if(i.push(e,!0),i.err)throw i.msg||s[i.err];return i.result}d.prototype.push=function(e,s){var a,o,d,c,h,u=this.strm,p=this.options.chunkSize,g=this.options.dictionary,m=!1;if(this.ended)return!1;o=s===~~s?s:!0===s?r.Z_FINISH:r.Z_NO_FLUSH,"string"==typeof e?u.input=n.binstring2buf(e):"[object ArrayBuffer]"===l.call(e)?u.input=new Uint8Array(e):u.input=e,u.next_in=0,u.avail_in=u.input.length;do{if(0===u.avail_out&&(u.output=new i.Buf8(p),u.next_out=0,u.avail_out=p),(a=t.inflate(u,r.Z_NO_FLUSH))===r.Z_NEED_DICT&&g&&(a=t.inflateSetDictionary(this.strm,g)),a===r.Z_BUF_ERROR&&!0===m&&(a=r.Z_OK,m=!1),a!==r.Z_STREAM_END&&a!==r.Z_OK)return this.onEnd(a),this.ended=!0,!1;u.next_out&&(0!==u.avail_out&&a!==r.Z_STREAM_END&&(0!==u.avail_in||o!==r.Z_FINISH&&o!==r.Z_SYNC_FLUSH)||("string"===this.options.to?(d=n.utf8border(u.output,u.next_out),c=u.next_out-d,h=n.buf2string(u.output,d),u.next_out=c,u.avail_out=p-c,c&&i.arraySet(u.output,u.output,d,c,0),this.onData(h)):this.onData(i.shrinkBuf(u.output,u.next_out)))),0===u.avail_in&&0===u.avail_out&&(m=!0)}while((u.avail_in>0||0===u.avail_out)&&a!==r.Z_STREAM_END);return a===r.Z_STREAM_END&&(o=r.Z_FINISH),o===r.Z_FINISH?(a=t.inflateEnd(this.strm),this.onEnd(a),this.ended=!0,a===r.Z_OK):o!==r.Z_SYNC_FLUSH||(this.onEnd(r.Z_OK),u.avail_out=0,!0)},d.prototype.onData=function(e){this.chunks.push(e)},d.prototype.onEnd=function(e){e===r.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=i.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},e.Inflate=d,e.inflate=c,e.inflateRaw=function(e,t){return(t=t||{}).raw=!0,c(e,t)},e.ungzip=c}}),ge=v({"../node_modules/pako/index.js"(e,t){"use strict";var i={};(0,Z().assign)(i,oe(),pe(),he()),t.exports=i}}),me=v({"../signaling-agent/node_modules/sdp-transform/lib/grammar.js"(e,t){var i=t.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\S*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbXMessage",reg:/^rtcp-fb:(\*|\d*) x-message ([\S| ]*)/,names:["payload","param"],format:function(e){return"rtcp-fb:"+("*"===e.payload?"%s":"%d")+" x-message %s"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%d trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"cryptoscale",reg:/^cryptoscale:(\d*) (client|server) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","flavor","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"cryptoscale:%d %s %s %s %s":"cryptoscale:%d %s %s %s"}},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t+=null!=e["network-id"]?" network-id %d":"%v",t+=null!=e["network-cost"]?" network-cost %d":"%v"}},{push:"xCandidatesIpv6",reg:/^x-candidate-ipv6:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",t+=null!=e.rateNumerator?" rate=%s":"",t+=null!=e.rateDenominator?"/%s":""}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{name:"xMediaBw",reg:/^x-mediabw:(\S*) send=(\d*);recv=(\d*)/,names:["label","sendBw","receiveBw"],format:"x-mediabw:%s send=%d;recv=%d"},{name:"xSsrcRange",reg:/^x-ssrc-range:(\d*)-(\d*)/,names:["ssrcMin","ssrcMax"],format:"x-ssrc-range:%d-%d"},{name:"xSource",reg:/^x-source:(\S*)/,format:"x-source:%s"},{name:"xSourceStreamId",reg:/^x-source-streamid:(\S*)/,format:"x-source-streamid:%s"},{name:"xCaps",reg:/^x-caps:(\d*) (\S*)/,names:["payloadType","value"],format:"x-caps:%d %s"},{name:"signalingFbXMessage",reg:/^x-signaling-fb:(\*|\d*) x-message ([\S| ]*)/,names:["payload","param"],format:function(e){return"x-signaling-fb:"+("*"===e.payload?"%s":"%d")+" x-message %s"}},{push:"xMediaSettings",reg:/^x-mediasettings:([\S| ]*)/,names:["settings"],format:"x-mediasettings:%s"},{name:"xDataProtocol",reg:/^x-data-protocol:\s?(.*)/,format:"x-data-protocol:%s"},{push:"invalid",names:["value"]}]};Object.keys(i).forEach((function(e){i[e].forEach((function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")}))}))}}),fe=v({"../signaling-agent/node_modules/sdp-transform/lib/parser.js"(e){var t=function(e){return String(Number(e))===e?Number(e):e},i=function(e,i,n){var r=e.name&&e.names;e.push&&!i[e.push]?i[e.push]=[]:r&&!i[e.name]&&(i[e.name]={});var s=e.push?{}:r?i[e.name]:i;!function(e,i,n,r){if(r&&!n)i[r]=t(e[1]);else for(var s=0;s<n.length;s+=1)null!=e[s+1]&&(i[n[s]]=t(e[s+1]))}(n.match(e.reg),s,e.names,e.name),e.push&&i[e.push].push(s)},n=me(),r=RegExp.prototype.test.bind(/^([a-z])=(.*)/);e.parse=function(e){var t={},s=[],a=t;return e.split(/(\r\n|\r|\n)/).filter(r).forEach((function(e){var t=e[0],r=e.slice(2);"m"===t&&(s.push({rtp:[],fmtp:[]}),a=s[s.length-1]);for(var o=0;o<(n[t]||[]).length;o+=1){var l=n[t][o];if(l.reg.test(r))return i(l,a,r)}})),t.media=s,t};var s=function(e,i){var n=i.split(/=(.+)/,2);return 2===n.length?e[n[0]]=t(n[1]):1===n.length&&i.length>1&&(e[n[0]]=void 0),e};e.parseParams=function(e){return e.split(/;\s?/).reduce(s,{})},e.parseFmtpConfig=e.parseParams,e.parsePayloads=function(e){return e.toString().split(" ").map(Number)},e.parseRemoteCandidates=function(e){for(var i=[],n=e.split(" ").map(t),r=0;r<n.length;r+=3)i.push({component:n[r],ip:n[r+1],port:n[r+2]});return i},e.parseImageAttributes=function(e){return e.split(" ").map((function(e){return e.substring(1,e.length-1).split(",").reduce(s,{})}))},e.parseSimulcastStreamList=function(e){return e.split(";").map((function(e){return e.split(",").map((function(e){var i,n=!1;return"~"!==e[0]?i=t(e):(i=t(e.substring(1,e.length)),n=!0),{scid:i,paused:n}}))}))}}}),Se=v({"../signaling-agent/node_modules/sdp-transform/lib/writer.js"(e,t){var i=me(),n=/%[sdv%]/g,r=function(e){var t=1,i=arguments,r=i.length;return e.replace(n,(function(e){if(t>=r)return e;var n=i[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(n);case"%d":return Number(n);case"%v":return""}}))},s=function(e,t,i){var n=[e+"="+(t.format instanceof Function?t.format(t.push?i:i[t.name]):t.format)];if(t.names)for(var s=0;s<t.names.length;s+=1){var a=t.names[s];t.name?n.push(i[t.name][a]):n.push(i[t.names[s]])}else n.push(i[t.name]);return r.apply(null,n)},a=["v","o","s","i","u","e","p","c","b","t","r","z","a"],o=["i","c","b","a"];t.exports=function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach((function(e){null==e.payloads&&(e.payloads="")}));var n=t.outerOrder||a,r=t.innerOrder||o,l=[];return n.forEach((function(t){i[t].forEach((function(i){i.name in e&&null!=e[i.name]?l.push(s(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){l.push(s(t,i,e))}))}))})),e.media.forEach((function(e){l.push(s("m",i.m[0],e)),r.forEach((function(t){i[t].forEach((function(i){i.name in e&&null!=e[i.name]?l.push(s(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){l.push(s(t,i,e))}))}))}))})),l.join("\r\n")+"\r\n"}}}),ve=v({"../signaling-agent/node_modules/sdp-transform/lib/index.js"(e){var t=fe(),i=Se();e.write=i,e.parse=t.parse,e.parseParams=t.parseParams,e.parseFmtpConfig=t.parseFmtpConfig,e.parsePayloads=t.parsePayloads,e.parseRemoteCandidates=t.parseRemoteCandidates,e.parseImageAttributes=t.parseImageAttributes,e.parseSimulcastStreamList=t.parseSimulcastStreamList}}),ye=v({"../skype-calling-utilities/dist/skype-calling-utilities.bundle.js"(e,t){"use strict";var a;a=(e,t)=>{var n,r={},s={exports:r},a=Object.defineProperty,o=Object.getOwnPropertyDescriptor,l=Object.getOwnPropertyNames,d=Object.prototype.hasOwnProperty,c={};((e,t)=>{for(var i in t)a(e,i,{get:t[i],enumerable:!0})})(c,{SlimCoreElectronControlCapturer:()=>v}),s.exports=(n=c,((e,t,i,n)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let r of l(t))d.call(e,r)||r===i||a(e,r,{get:()=>t[r],enumerable:!(n=o(t,r))||n.enumerable});return e})(a({},"__esModule",{value:!0}),n));var h=i(496486);function u(e){if(!e)return`${e}`;if(e instanceof Map)return function(e){const t={};return e.forEach(((e,i)=>{t[i.toString()]=e})),JSON.stringify(t)}(e);const t=e.toString();return t.endsWith("[object Object]")?JSON.stringify(e):t}var p,g,m=class{constructor(e){this.eventLogger=e,this.subscriptions=[]}subscribe(e){return new f(this.subscriptions,e)}dispose(e){this.subscriptions=[]}raiseEvents(e){this.subscriptions.slice().forEach((t=>{try{void 0!==t.eventHandler&&e(t.eventHandler)}catch(e){this.eventLogger?.warn?.("Event handler exception caught!",u(e))}}))}},f=class{constructor(e,t){this.subscriptions=e,this.eventHandler=t,this.subscriptions.push(this)}dispose(){(0,h.remove)(this.subscriptions,(e=>e===this)),this.eventHandler=void 0}},S=class extends m{constructor(e){super(e)}changed(e,t){return this.subscribe({changed:{skipEventConfig:t,handler:e},on:void 0})}on(e,t){return this.subscribe({changed:void 0,on:{name:String(e),handler:this._toEventCallback(t)}})}once(e,t,i){let n;return n=this.on(e,this._fromEventCallback(((...e)=>{n.dispose(i),this._toEventCallback(t)(...e)}))),n}raiseChanged(e){this.raiseEvents((t=>{if(!t.changed)return;const{skipEventConfig:i,handler:n}=t.changed;!this.getShouldSkipChangedEvent(e,i)&&n()}))}event(e){return{raise:this._fromEventCallback(((...t)=>this._raiseEventImpl(String(e),...t)))}}_raiseEventImpl(e,...t){this.raiseEvents((i=>i.on&&i.on.name===e&&i.on.handler(...t)))}_toEventCallback(e){return e}_fromEventCallback(e){return e}getShouldSkipChangedEvent(e,t){return e?.skipDominantSpeakerUpdatesOnCall?!!t?.skipDominantSpeakerUpdatesOnCall:!!e?.skipParticipantsUpdatesOnCall&&!!t?.skipParticipantsUpdatesOnCall}};(g=p||(p={})).encodeMouseEvent=function(e){if(!e)return new Uint8Array(0);e.buttonType||(e.buttonType=0),e.xPos||(e.xPos=0),e.yPos||(e.yPos=0),e.wheelRotation||(e.wheelRotation=0);const t=new ArrayBuffer(7),i=new DataView(t),n=(3&e.type)<<0,r=(7&e.buttonType)<<2,s=(e.buttonDown?1:0)<<5,a=(e.wheelButtonDown?1:0)<<6;return i.setUint8(0,1),i.setUint8(1,n|r|s|a|0),i.setUint16(2,e.xPos,!0),i.setUint16(4,e.yPos,!0),i.setUint8(6,e.wheelRotation),new Uint8Array(t)},g.encodeKeyboardEvent=function(e){const t=new ArrayBuffer(3),i=new DataView(t),n=(3&e.codeType)<<0,r=(e.keyUp?1:0)<<4,s=(e.repeat?1:0)<<5;return i.setUint8(0,0),i.setUint8(1,0|n|r|s|0),i.setUint8(2,e.code),new Uint8Array(t)},g.decodeEventType=function(e){return e[0]},g.decodeMouseEvent=function(e){if(1!==e[0]||7!==e.length)return null;const t=new DataView(e.buffer),i=t.getUint8(1);return{type:3&i,buttonType:i>>2&7,buttonDown:!!(i>>5&1),wheelButtonDown:!!(i>>6&1),xPos:t.getUint16(2,!0),yPos:t.getUint16(4,!0),wheelRotation:t.getUint8(6)}},g.decodeKeyboardEvent=function(e){if(0!==e[0]||3!==e.length)return null;const t=new DataView(e.buffer),i=t.getUint8(1);return{codeType:3&i,code:t.getUint8(2),repeat:!!(i>>5&1),keyUp:!!(i>>4&1)}};var v=class extends S{constructor(e,t,i=!0,n=1){super(),this._logger=e,this._element=t,this._captureRegionPreserveAspectRatio=i,this._mouseMoveCount=0,this._mouseMoveStartTime=0,this._isMouseDown=!1,this._isMouseOnRenderer=!1,this._captureMode=0,this._pollTimerID=0,this._resizeTimerID=0,this._mouseMoveThrottlingEnabled=!1,this._handleResizeEvents=()=>{clearTimeout(this._resizeTimerID),this._resizeTimerID=window.setTimeout((()=>{this.updateCaptureRegion()}),250)},this._handleMouseLeave=e=>{!this._isOnScreenContent(e)&&this._isMouseOnRenderer&&(this._raiseCaptureEvent(2),this._logger.info("Mouse leaving render region")),this._isMouseOnRenderer=!1},this._handleMouseEnter=e=>{this._isOnScreenContent(e)&&(this._isMouseOnRenderer=!0,this._raiseCaptureEvent(1),this._logger.info("Mouse entering render region"))},this._handleLosingFocus=()=>{this._syncKeyStates(!0)},this._handleClick=e=>{this._isOnScreenContent(e)&&(this._raiseCaptureEvent(0),this._logger.info("Mouse clicked"))},this._handleMouseMove=e=>{if(!this._isOnScreenContent(e)&&this._isMouseOnRenderer)return this._raiseCaptureEvent(2),this._isMouseOnRenderer=!1,void this._logger.info("Mouse leaving render region");if(this._isOnScreenContent(e)&&!this._isMouseOnRenderer&&(this._raiseCaptureEvent(1),this._isMouseOnRenderer=!0,this._logger.info("Mouse entering render region")),2!==this._captureMode&&3!==this._captureMode)return;if(this._mouseMoveCount++,this._mouseMoveThrottlingEnabled){if(!this._isOnScreenContent(e)||!this._shouldMoveMouse())return}else if(!this._isOnScreenContent(e)||this._mouseMoveCount%2==0)return;const t={type:0};this._normalizeMousePosition(e,t),this._raiseMouseEvent(t)},this._handleMouseDown=e=>{if(2!==this._captureMode&&3!==this._captureMode)return;if(!this._isOnScreenContent(e))return;const t={type:2,buttonType:y(e.button),buttonDown:!0};this._isMouseDown=!0,this._normalizeMousePosition(e,t),this._raiseMouseEvent(t)},this._handleMouseUp=e=>{if(2!==this._captureMode&&3!==this._captureMode)return;if(!this._isOnScreenContent(e))return;const t={type:2,buttonType:y(e.button),buttonDown:!1};this._isMouseDown=!1,this._normalizeMousePosition(e,t),this._raiseMouseEvent(t)},this._handleKeyDown=e=>{this._raiseKeyboardEvent({codeType:1,code:e.keyCode,repeat:e.repeat,keyUp:!1}),e.stopPropagation(),e.preventDefault()},this._handleKeyUp=e=>{this._raiseKeyboardEvent({codeType:1,code:e.keyCode,repeat:e.repeat,keyUp:!0}),e.stopPropagation(),e.preventDefault()},this._handleWheel=e=>{this._raiseMouseEvent({type:1,wheelRotation:e.deltaY>0?-120:120})},this._handleContextMenu=e=>{e.preventDefault()},this._ensureCanReceiveKeyboardInput(),this._element.ownerDocument?.defaultView?.addEventListener("resize",this._handleResizeEvents,!1),this._captureRegion={left:0,top:0,width:this._element.clientWidth,height:this._element.clientHeight},this._videoSize={width:Math.floor(t.clientHeight*n),height:t.clientHeight},this._origElementSize={width:0,height:0},this._checkElementSize(),this._mouseMoveStartTime=new Date(0).getTime()}get captureMode(){return this._captureMode}get captureRegion(){return this._captureRegion}setMouseMoveThrottlingFeatureFlag(e){this._mouseMoveThrottlingEnabled=e}dispose(e){this._logger.info(`dispose causeId: ${e}`),window.clearTimeout(this._pollTimerID),this._element.ownerDocument?.defaultView?.removeEventListener("resize",this._handleResizeEvents,!1),super.dispose(e)}updateVideoSize(e,t){this._videoSize.width=e,this._videoSize.height=t,this.updateCaptureRegion()}updateCaptureRegion(){this._captureRegionPreserveAspectRatio?(this._captureRegion.width=this._element.clientWidth,this._captureRegion.height=this._element.clientWidth*this._videoSize.height/this._videoSize.width,this._captureRegion.height>this._element.clientHeight?(this._captureRegion.width=this._element.clientHeight*this._videoSize.width/this._videoSize.height,this._captureRegion.height=this._element.clientHeight,this._captureRegion.left=(this._element.clientWidth-this._captureRegion.width)/2,this._captureRegion.top=0):(this._captureRegion.left=0,this._captureRegion.top=(this._element.clientHeight-this._captureRegion.height)/2)):(this._captureRegion.width=this._element.clientWidth,this._captureRegion.height=this._element.clientHeight,this._captureRegion.top=0,this._captureRegion.left=0)}setCaptureMode(e){3===this._captureMode&&3!==e&&this._syncKeyStates(!0),this._captureMode=e,0!==e?("none"===this._element.style.pointerEvents&&this._logger.warn("Element pointer-events is 'none', event handlers will not work"),this._element.addEventListener("click",this._handleClick),this._element.addEventListener("pointermove",this._handleMouseMove),this._element.addEventListener("pointerdown",this._handleMouseDown),this._element.addEventListener("pointerup",this._handleMouseUp),this._element.addEventListener("pointerenter",this._handleMouseEnter),this._element.addEventListener("pointerleave",this._handleMouseLeave),3===e?(this._element.addEventListener("wheel",this._handleWheel),this._element.addEventListener("keydown",this._handleKeyDown),this._element.addEventListener("keyup",this._handleKeyUp),this._element.addEventListener("contextmenu",this._handleContextMenu),this._element.addEventListener("blur",this._handleLosingFocus)):(this._element.removeEventListener("wheel",this._handleWheel),this._element.removeEventListener("keydown",this._handleKeyDown),this._element.removeEventListener("keyup",this._handleKeyUp),this._element.removeEventListener("contextmenu",this._handleContextMenu),this._element.removeEventListener("blur",this._handleLosingFocus))):(this._element.removeEventListener("pointermove",this._handleMouseMove),this._element.removeEventListener("pointerdown",this._handleMouseDown),this._element.removeEventListener("pointerup",this._handleMouseUp),this._element.removeEventListener("pointerenter",this._handleMouseEnter),this._element.removeEventListener("pointerleave",this._handleMouseLeave),this._element.removeEventListener("click",this._handleClick),this._element.removeEventListener("wheel",this._handleWheel),this._element.removeEventListener("keydown",this._handleKeyDown),this._element.removeEventListener("keyup",this._handleKeyUp),this._element.removeEventListener("contextmenu",this._handleContextMenu),this._element.removeEventListener("blur",this._handleLosingFocus))}_ensureCanReceiveKeyboardInput(){this._element.tabIndex=this._element.tabIndex}_checkElementSize(){this._origElementSize.width===this._element.clientWidth&&this._origElementSize.height===this._element.clientHeight||(this.updateCaptureRegion(),this._origElementSize.width=this._element.clientWidth,this._origElementSize.height=this._element.clientHeight),this._pollTimerID=window.setTimeout((()=>{this._checkElementSize()}),3e3)}_raiseMouseEvent(e){this.event("mouseControlEvent").raise(e)}_raiseKeyboardEvent(e){this.event("keyboardControlEvent").raise(e)}_raiseCaptureEvent(e){this.event("ctrlCaptureEvent").raise(e)}_normalizeMousePosition(e,t){t.xPos=(e.offsetX-this._captureRegion.left)/this._captureRegion.width*65535,t.yPos=(e.offsetY-this._captureRegion.top)/this._captureRegion.height*65535}_isOnScreenContent(e){const t=this._captureRegion.left,i=this._captureRegion.left+this._captureRegion.width,n=this._captureRegion.top,r=this._captureRegion.top+this._captureRegion.height;return t<=e.offsetX&&e.offsetX<i&&n<=e.offsetY&&e.offsetY<r}_shouldMoveMouse(){if(this._mouseMoveStartTime){const e=(new Date).getTime(),t=e-this._mouseMoveStartTime;if(this._isMouseDown&&t>=30||!this._isMouseDown&&t>=50)return this._mouseMoveStartTime=e,!0}else this._mouseMoveStartTime=(new Date).getTime();return!1}_syncKeyStates(e){this._raiseKeyboardEvent({codeType:1,code:17,repeat:!1,keyUp:e}),this._raiseKeyboardEvent({codeType:1,code:16,repeat:!1,keyUp:e}),this._raiseKeyboardEvent({codeType:1,code:18,repeat:!1,keyUp:e}),this._raiseKeyboardEvent({codeType:1,code:91,repeat:!1,keyUp:e}),this._logger.info("Synced Key states.")}static formatMouseEvent(e){return p.encodeMouseEvent(e)}static formatKeyboardEvent(e){return p.encodeKeyboardEvent(e)}};function y(e){switch(e){case 0:return 0;case 2:return 1;case 1:return 2;default:return}}return"object"==typeof s.exports&&"object"==typeof r&&(s.exports=((e,t,i,n)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let r of Object.getOwnPropertyNames(t))Object.prototype.hasOwnProperty.call(e,r)||r===i||Object.defineProperty(e,r,{get:()=>t[r],enumerable:!(n=Object.getOwnPropertyDescriptor(t,r))||n.enumerable});return e})(s.exports,r)),s.exports},"object"==typeof e&&"object"==typeof t?t.exports=a(i(174958),i(496486)):(r=[i(174958),i(496486)],void 0===(s="function"==typeof(n=a)?n.apply(e,r):n)||(h.exports=s))}}),Ce=v({"../node_modules/synctasks/dist/SyncTasks.js"(e){"use strict";function t(e){return null!=e&&"function"==typeof e.then}function i(e){return null!=e&&"function"==typeof e.cancel}function n(t,i){if(!e.config.catchExceptions)return t();try{return t()}catch(e){return i(e)}}Object.defineProperty(e,"__esModule",{value:!0}),e.config={exceptionsToConsole:!0,catchExceptions:!0,traceEnabled:!1,exceptionHandler:void 0,unhandledErrorHandler:function(e){throw e}},e.fromThenable=function(e){var t=h();return e.then((function(e){t.resolve(e)}),(function(e){t.reject(e)})),t.promise().thenAsync((function(e){return e}))};var r,s,a,o=[],l="undefined"!=typeof setImmediate;function d(e){o.push(e),1===o.length&&(l?setImmediate(c):setTimeout(c,0))}function c(){var e=o;o=[];for(var t=0;t<e.length;t++)e[t]()}function h(){return new r.SyncTask}function u(e){return(new r.SyncTask).resolve(e).promise()}function p(e){var n=h(),s=!1;return n.onCancel((function(t){e.forEach((function(e){i(e)&&r.SyncTask.cancelOtherInternal(e,t)}))})),e.forEach((function(e){t(e)?e.then((function(e){s||(s=!0,n.resolve(e))}),(function(e){s||(s=!0,n.reject(e))})):s||(s=!0,n.resolve(e))})),n.promise()}e.asyncCallback=d,s=r||(r={}),a=function(){function r(){this._completedSuccess=!1,this._completedFail=!1,this._traceEnabled=!1,this._cancelCallbacks=[],this._wasCanceled=!1,this._wasExplicitlyCanceled=!1,this._resolving=!1,this._storedCallbackSets=[],this._mustHandleError=!0}return r.prototype._addCallbackSet=function(e,t){var i=this,n=new r;return n.onCancel((function(t){e.wasCanceled=!0,e.cancelContext=t,i._cancelInternal(t)})),e.task=n,this._storedCallbackSets.push(e),t?this._mustHandleError=!1:n._mustHandleError=!1,this._resolving||(this._completedSuccess?this._resolveSuccesses():this._completedFail&&this._resolveFailures()),n.promise()},r.prototype.onCancel=function(e){return this._completedSuccess||this._completedFail||(this._wasCanceled?e(this._cancelContext):this._cancelCallbacks.push(e)),this},r.prototype.then=function(e,t){return this._addCallbackSet({successFunc:e,failFunc:t},!0)},r.prototype.thenAsync=function(e,t){return this._addCallbackSet({successFunc:e,failFunc:t,asyncCallback:!0},!0)},r.prototype.catch=function(e){return this._addCallbackSet({failFunc:e},!0)},r.prototype.always=function(e){return this._addCallbackSet({successFunc:e,failFunc:e},!0)},r.prototype.setTracingEnabled=function(e){return this._traceEnabled=e,this},r.prototype.finally=function(e){return this._addCallbackSet({successFunc:e,failFunc:e},!1),this},r.prototype.done=function(e){return this._addCallbackSet({successFunc:e},!1),this},r.prototype.fail=function(e){return this._addCallbackSet({failFunc:e},!1),this},r.prototype.resolve=function(e){return this._checkState(!0),this._completedSuccess=!0,this._storedResolution=e,this._cancelCallbacks=[],this._resolveSuccesses(),this},r.prototype.reject=function(e){return this._checkState(!1),this._completedFail=!0,this._storedErrResolution=e,this._cancelCallbacks=[],this._resolveFailures(),r._enforceErrorHandled(this),this},r.prototype._checkState=function(t){if(this._completedSuccess||this._completedFail){this._completeStack&&console.error(this._completeStack.message,this._completeStack.stack);var i="Failed to "+(t?"resolve":"reject")+": the task is already "+(this._completedSuccess?"resolved":"rejected");throw new Error(i)}(e.config.traceEnabled||this._traceEnabled)&&(this._completeStack=new Error("resolve"))},r._enforceErrorHandled=function(t){t._mustHandleError&&(r._rejectedTasks.push(t),r._enforceErrorHandledTimer||(r._enforceErrorHandledTimer=setTimeout((function(){r._enforceErrorHandledTimer=void 0;var t=r._rejectedTasks;r._rejectedTasks=[],t.forEach((function(t,i){t._mustHandleError&&e.config.unhandledErrorHandler(t._storedErrResolution)}))}),0)))},r.prototype.cancel=function(e){if(this._wasExplicitlyCanceled)throw new Error("Already Canceled");this._wasExplicitlyCanceled=!0,this._cancelInternal(e)},r.prototype._cancelInternal=function(e){var t=this;if(!this._wasCanceled){this._wasCanceled=!0,this._cancelContext=e;var i=this._cancelCallbacks;this._cancelCallbacks=[],i.length>0&&i.forEach((function(e){t._completedSuccess||t._completedFail||e(t._cancelContext)}))}},r.cancelOtherInternal=function(e,t){var i=e;i._storedCallbackSets&&i._cancelInternal?i._cancelInternal(t):e.cancel(t)},r.prototype.promise=function(){return this},r.prototype._resolveSuccesses=function(){var e=this;for(this._resolving=!0;this._storedCallbackSets.length;){var t=this._storedCallbackSets;this._storedCallbackSets=[],t.forEach((function(t){t.asyncCallback?d((function(){return e._resolveSuccessCallback(t)})):e._resolveSuccessCallback(t)}))}this._resolving=!1},r.prototype._resolveSuccessCallback=function(e){var s=this;e.successFunc?n((function(){var n=e.successFunc(s._storedResolution);i(n)&&(e.wasCanceled?r.cancelOtherInternal(n,e.cancelContext):e.task.onCancel((function(e){return r.cancelOtherInternal(n,e)}))),t(n)?n.then((function(t){e.task.resolve(t)}),(function(t){e.task.reject(t)})):e.task.resolve(n)}),(function(t){s._handleException(t,"SyncTask caught exception in success block: "+t.toString()),e.task.reject(t)})):e.task.resolve(this._storedResolution)},r.prototype._resolveFailures=function(){var e=this;for(this._resolving=!0;this._storedCallbackSets.length;){var t=this._storedCallbackSets;this._storedCallbackSets=[],t.forEach((function(t){t.asyncCallback?d((function(){return e._resolveFailureCallback(t)})):e._resolveFailureCallback(t)}))}this._resolving=!1},r.prototype._resolveFailureCallback=function(e){var s=this;e.failFunc?n((function(){var n=e.failFunc(s._storedErrResolution);i(n)&&(e.wasCanceled?r.cancelOtherInternal(n,e.cancelContext):e.task.onCancel((function(e){return r.cancelOtherInternal(n,e)}))),t(n)?n.then((function(t){e.task.resolve(t)}),(function(t){e.task.reject(t)})):e.task.resolve(n)}),(function(t){s._handleException(t,"SyncTask caught exception in failure block: "+t.toString()),e.task.reject(t)})):e.task.reject(this._storedErrResolution)},r.prototype._handleException=function(t,i){e.config.exceptionsToConsole&&console.error(i),e.config.exceptionHandler&&e.config.exceptionHandler(t)},r.prototype.toEs6Promise=function(){var e=this;return new Promise((function(t,i){return e.then(t,i)}))},r._rejectedTasks=[],r}(),s.SyncTask=a,e.all=function(e){if(0===e.length)return u([]);var n,s=h(),a=e.length,o=Array(e.length);s.onCancel((function(t){e.forEach((function(e){i(e)&&r.SyncTask.cancelOtherInternal(e,t)}))}));var l=function(){0==--a&&(void 0!==n?s.reject(n):s.resolve(o))};return e.forEach((function(e,i){t(e)?e.then((function(e){o[i]=e,l()}),(function(e){void 0===n&&(n=void 0===e||e),l()})):(o[i]=e,l())})),s.promise()},e.Defer=h,e.Resolved=u,e.Rejected=function(e){return(new r.SyncTask).reject(e).promise()},e.race=p,e.raceTimer=function(e,t){var i=h(),n=setTimeout((function(){i.resolve({timedOut:!0})}),t);return p([e.then((function(e){return clearTimeout(n),{timedOut:!1,result:e}})),i.promise()])}}}),Te=v({"../node_modules/sdp-transform/lib/grammar.js"(e,t){var i=t.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\S*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbXMessage",reg:/^rtcp-fb:(\*|\d*) x-message ([\S| ]*)/,names:["payload","param"],format:function(e){return"rtcp-fb:"+("*"===e.payload?"%s":"%d")+" x-message %s"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%d trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"cryptoscale",reg:/^cryptoscale:(\d*) (client|server) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","flavor","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"cryptoscale:%d %s %s %s %s":"cryptoscale:%d %s %s %s"}},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t+=null!=e["network-id"]?" network-id %d":"%v",t+=null!=e["network-cost"]?" network-cost %d":"%v"}},{push:"xCandidatesIpv6",reg:/^x-candidate-ipv6:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",t+=null!=e.rateNumerator?" rate=%s":"",t+=null!=e.rateDenominator?"/%s":""}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{name:"xMediaBw",reg:/^x-mediabw:(\S*) send=(\d*);recv=(\d*)/,names:["label","sendBw","receiveBw"],format:"x-mediabw:%s send=%d;recv=%d"},{name:"xSsrcRange",reg:/^x-ssrc-range:(\d*)-(\d*)/,names:["ssrcMin","ssrcMax"],format:"x-ssrc-range:%d-%d"},{name:"xSource",reg:/^x-source:(\S*)/,format:"x-source:%s"},{name:"xSourceStreamId",reg:/^x-source-streamid:(\S*)/,format:"x-source-streamid:%s"},{name:"xCaps",reg:/^x-caps:(\d*) (\S*)/,names:["payloadType","value"],format:"x-caps:%d %s"},{name:"signalingFbXMessage",reg:/^x-signaling-fb:(\*|\d*) x-message ([\S| ]*)/,names:["payload","param"],format:function(e){return"x-signaling-fb:"+("*"===e.payload?"%s":"%d")+" x-message %s"}},{push:"xMediaSettings",reg:/^x-mediasettings:([\S| ]*)/,names:["settings"],format:"x-mediasettings:%s"},{name:"xDataProtocol",reg:/^x-data-protocol:\s?(.*)/,format:"x-data-protocol:%s"},{name:"xMultiStream",reg:/^x-multi-stream:(\d*) (\d*) (\d*) (\d*)/,names:["numberOfStreams","startSsrc","ssrcRange","ssrcGroupRange"],format:"x-multi-stream:%d %d %d %d"},{push:"invalid",names:["value"]}]};Object.keys(i).forEach((function(e){i[e].forEach((function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")}))}))}}),Ee=v({"../node_modules/sdp-transform/lib/parser.js"(e){var t=function(e){return String(Number(e))===e?Number(e):e},i=function(e,i,n){var r=e.name&&e.names;e.push&&!i[e.push]?i[e.push]=[]:r&&!i[e.name]&&(i[e.name]={});var s=e.push?{}:r?i[e.name]:i;!function(e,i,n,r){if(r&&!n)i[r]=t(e[1]);else for(var s=0;s<n.length;s+=1)null!=e[s+1]&&(i[n[s]]=t(e[s+1]))}(n.match(e.reg),s,e.names,e.name),e.push&&i[e.push].push(s)},n=Te(),r=RegExp.prototype.test.bind(/^([a-z])=(.*)/);e.parse=function(e){var t={},s=[],a=t;return e.split(/(\r\n|\r|\n)/).filter(r).forEach((function(e){var t=e[0],r=e.slice(2);"m"===t&&(s.push({rtp:[],fmtp:[]}),a=s[s.length-1]);for(var o=0;o<(n[t]||[]).length;o+=1){var l=n[t][o];if(l.reg.test(r))return i(l,a,r)}})),t.media=s,t};var s=function(e,i){var n=i.split(/=(.+)/,2);return 2===n.length?e[n[0]]=t(n[1]):1===n.length&&i.length>1&&(e[n[0]]=void 0),e};e.parseParams=function(e){return e.split(/;\s?/).reduce(s,{})},e.parseFmtpConfig=e.parseParams,e.parsePayloads=function(e){return e.toString().split(" ").map(Number)},e.parseRemoteCandidates=function(e){for(var i=[],n=e.split(" ").map(t),r=0;r<n.length;r+=3)i.push({component:n[r],ip:n[r+1],port:n[r+2]});return i},e.parseImageAttributes=function(e){return e.split(" ").map((function(e){return e.substring(1,e.length-1).split(",").reduce(s,{})}))},e.parseSimulcastStreamList=function(e){return e.split(";").map((function(e){return e.split(",").map((function(e){var i,n=!1;return"~"!==e[0]?i=t(e):(i=t(e.substring(1,e.length)),n=!0),{scid:i,paused:n}}))}))}}}),_e=v({"../node_modules/sdp-transform/lib/writer.js"(e,t){var i=Te(),n=/%[sdv%]/g,r=function(e){var t=1,i=arguments,r=i.length;return e.replace(n,(function(e){if(t>=r)return e;var n=i[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(n);case"%d":return Number(n);case"%v":return""}}))},s=function(e,t,i){var n=[e+"="+(t.format instanceof Function?t.format(t.push?i:i[t.name]):t.format)];if(t.names)for(var s=0;s<t.names.length;s+=1){var a=t.names[s];t.name?n.push(i[t.name][a]):n.push(i[t.names[s]])}else n.push(i[t.name]);return r.apply(null,n)},a=["v","o","s","i","u","e","p","c","b","t","r","z","a"],o=["i","c","b","a"];t.exports=function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach((function(e){null==e.payloads&&(e.payloads="")}));var n=t.outerOrder||a,r=t.innerOrder||o,l=[];return n.forEach((function(t){i[t].forEach((function(i){i.name in e&&null!=e[i.name]?l.push(s(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){l.push(s(t,i,e))}))}))})),e.media.forEach((function(e){l.push(s("m",i.m[0],e)),r.forEach((function(t){i[t].forEach((function(i){i.name in e&&null!=e[i.name]?l.push(s(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){l.push(s(t,i,e))}))}))}))})),l.join("\r\n")+"\r\n"}}}),be=v({"../node_modules/sdp-transform/lib/index.js"(e){var t=Ee(),i=_e();e.write=i,e.parse=t.parse,e.parseParams=t.parseParams,e.parseFmtpConfig=t.parseFmtpConfig,e.parsePayloads=t.parsePayloads,e.parseRemoteCandidates=t.parseRemoteCandidates,e.parseImageAttributes=t.parseImageAttributes,e.parseSimulcastStreamList=t.parseSimulcastStreamList}}),Pe={};y(Pe,{HttpRequestDispatcherImplementation:()=>We,generateCauseId:()=>Re,getOvb:()=>ni,getVersion:()=>ii,pluginlessStackFactory:()=>kF}),h.exports=(a=Pe,C(p({},"__esModule",{value:!0}),a));var Ie=T(Y()),Ae=8;function Re(){const e="abcdef0123456789";let t="";for(let i=0;i<Ae;i++)t+=e.charAt(Math.floor(16*Math.random()));return t}var we=i(174958),Me=i(496486),Oe=class e{constructor(e,t,i=""){this.ulLogComponent=e,this.ulSafeComponent=t,this._getPrefix=(0,Me.isFunction)(i)?i:()=>i,this.logComponent=we.LogFactory.instance().component(this.ulLogComponent),we.LogFactory.instance().declareComponentSafe(this.ulLogComponent,t)}createChild(t){const i=(0,Me.isFunction)(t)?t:()=>t;return new e(this.ulLogComponent,this.ulSafeComponent,(()=>this._getPrefix()?`${this._getPrefix()}/${i()}`:i()))}log(...e){this._apply((e=>this.logComponent.debug2(null,e)),e)}debug(...e){this._apply((e=>this.logComponent.debug4(null,e)),e)}info(...e){this._apply((e=>this.logComponent.debug1(null,e)),e)}warn(...e){this._apply((e=>this.logComponent.warn(null,e)),e)}error(...e){this._apply((e=>this.logComponent.error(null,e)),e)}_apply(e,t=[]){this._addPrefix(t),e(t.map((e=>e instanceof DOMException?e.toString():e)).map((e=>(0,Me.isObject)(e)?JSON.stringify(e):e)).join(", "))}_addPrefix(e){if(e&&e[0]){const t=`${this._getPrefix()} ${e[0]}`;e[0]=t}}},De=i(174958);function ke(e){return"string"==typeof e?De.pii.Mri(e):De.pii.Omit(e)}function Ne(e){return e&&De.pii.Mri(e)}function Le(e){const t=function(e){const t="99:";return e&&e.substr(0,3)===t?De.pii.Omit(e):e}(e);return t&&t.substr(0,8)}var xe=["response","responseText","responseURL","status","state","statusText","timeout","withCredentials","stack","message","name","error","piiSafe","phase","code","participantId","phrase","subCode","reason"];function Fe(e){try{return JSON.parse(JSON.stringify(e,xe,4))}catch(e){return{error:"failed to parse object"}}}var Ue=e=>{try{return e.split("\n")[0]}catch(e){return"invalid stack"}};function Ve(e,t=!1){if(null==e)return"void";if(e instanceof Error)return e.toString();if(e instanceof String||e instanceof Number||e instanceof Boolean)return e.toString();try{return e.stack&&(e.stack=Ue(e.stack)),(t?JSON.stringify(e):JSON.stringify(e,xe,4)).replace(/(\r\n\t|\n|\r\t|\s)/gm,"")}catch(t){return`failed to get error information:${e&&"function"==typeof e.toString&&e.toString()} ${e?.response&&JSON.stringify(e.response)}`}}function He(e){try{return JSON.stringify(e,null,2)}catch(t){return`failed to stringify obj ${e}`}}function Be(e,t){try{return e.substring(0,length)}catch(t){return e}}function $e(e){return e||!1===e||""===e||0===e}function je(e){if(!e)return!1;try{return atob(e),!0}catch(e){return!1}}function Ge(e){if(!e)return`${e}`;if(e instanceof Map)return function(e){const t={};return e.forEach(((e,i)=>{t[i.toString()]=e})),JSON.stringify(t)}(e);const t=e.toString();return t.endsWith("[object Object]")?JSON.stringify(e):t}var We=class{constructor(e){e&&"function"==typeof e.createChild?this.logger=e.createChild("RequestDispatcher"):this.logger=new Oe("JS.TsCalling.RequestDispatcher",!1)}getRequestOptions(e,t,i,n,r){return{headers:t||{},timeout:n,payload:i||null,responseType:r}}getAsync(e,t){return this.sendRequest(e,t,"GET")}postAsync(e,t){return this.sendRequest(e,t,"POST")}putAsync(e,t){return this.sendRequest(e,t,"PUT")}removeAsync(e,t){return this.sendRequest(e,t,"DELETE")}async sendRequest(e,t={headers:{}},i){const n=this.logger.createChild(`[${t.causeId||Re()}][Request]`);n.info(`sending, ${i}-${e}`);const r=Date.now();let s;t.headers=t.headers||{},t.headers["content-type"]||(t.headers["content-type"]=t.contentType||"application/json");try{const d=Ie.default.request({url:e,method:i,headers:t.headers||{},timeout:"number"==typeof t.timeout?t.timeout:45e3,data:t.payload||"",responseType:t.responseType||t.dataType||"json",withCredentials:(o=t.withCredentials,l=!1,void 0!==o?o:l),cancelToken:new Ie.default.CancelToken((e=>{s=e}))});(a=t.timeout)&&"function"==typeof a.then&&t.timeout.then((()=>{n.info("Aborting pending request"),s()}),(()=>{n.info("Timeout promise rejected, ignoring")}));const c=await d;return n.info(`success, status=${c.status}`),{response:c.data,request:c.request,duration:Date.now()-r}}catch(e){if(n.info("failed"),Ie.default.isCancel(e))throw n.info(`response=${He(e.response)}`),{aborted:!0};throw e.response?n.info(`response=${He(e.response)}`):e.request?n.info(`no response, request=${He(e.request)}`):n.info(`request not made, error=${He(e)}`),e||new Error("Request failed")}var a,o,l}},qe=i(496486),ze=i(496486),Ke=class{constructor(e){this.eventLogger=e,this.subscriptions=[]}subscribe(e){return new Je(this.subscriptions,e)}dispose(e){this.subscriptions=[]}raiseEvents(e){this.subscriptions.slice().forEach((t=>{try{void 0!==t.eventHandler&&e(t.eventHandler)}catch(e){this.eventLogger?.warn?.("Event handler exception caught!",Ge(e))}}))}},Je=class{constructor(e,t){this.subscriptions=e,this.eventHandler=t,this.subscriptions.push(this)}dispose(){(0,ze.remove)(this.subscriptions,(e=>e===this)),this.eventHandler=void 0}},Ye=class extends Ke{constructor(e){super(e)}changed(e,t){return this.subscribe({changed:{skipEventConfig:t,handler:e},on:void 0})}on(e,t){return this.subscribe({changed:void 0,on:{name:String(e),handler:this._toEventCallback(t)}})}once(e,t,i){let n;return n=this.on(e,this._fromEventCallback(((...e)=>{n.dispose(i),this._toEventCallback(t)(...e)}))),n}raiseChanged(e){this.raiseEvents((t=>{if(!t.changed)return;const{skipEventConfig:i,handler:n}=t.changed;!this.getShouldSkipChangedEvent(e,i)&&n()}))}event(e){return{raise:this._fromEventCallback(((...t)=>this._raiseEventImpl(String(e),...t)))}}_raiseEventImpl(e,...t){this.raiseEvents((i=>i.on&&i.on.name===e&&i.on.handler(...t)))}_toEventCallback(e){return e}_fromEventCallback(e){return e}getShouldSkipChangedEvent(e,t){return e?.skipDominantSpeakerUpdatesOnCall?!!t?.skipDominantSpeakerUpdatesOnCall:!!e?.skipParticipantsUpdatesOnCall&&!!t?.skipParticipantsUpdatesOnCall}},Qe=Ye,Xe="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",Ze="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",et="http://www.webrtc.org/experiments/rtp-hdrext/video-layers-allocation00",tt={MEDIA_STATE:{send:"sendonly",receive:"recvonly",sendReceive:"sendrecv",inactive:"inactive"},MEDIA_DIRECTION:{SEND:"send",RECV:"recv"},MEDIA_DEVICE_KIND:{audioInput:"audioinput",audioOutput:"audiooutput",videoInput:"videoinput",compositeAudio:"compositeAudio",virtualDevice:"virtualDevice"},MEDIA_DEVICE:{camera:"camera",microphone:"microphone",speaker:"speaker",compositeAudio:"compositeAudio",defaultId:"default",communicationsId:"communications",defaultDeviceLabel:"Default",audioIngestDevice:"audioIngestDevice",virtualDevice:"virtualDevice"},MEDIA_ERROR:{constraintNotSatisfiedError:"ConstraintNotSatisfiedError",iceConnectionError:"iceConnectionError",srtpError:"srtpError",permissionDeniedError:"permissionDeniedError",internalError:"internalError",sourceUnavailableError:"SourceUnavailableError",devicesNotFoundError:"DevicesNotFoundError",noDeviceSelected:"noDeviceSelected",noNetworkError:"noNetworkError",incompatibleOffer:"IncompatibleOffer",mediaStreamRequestError:"MediaStreamRequestError",extensionNotFoundError:"ExtensionNotFoundError",sharingCancelledError:"SharingCancelledError",permissionDeniedBySystemError:"PermissionsDeniedBySystem",chromeRuntimeNotDefinedError:"ChromeRuntimeNotDefinedError",mediaStreamRequestTimedOut:"MediaStreamRequestTimedout",unsupportedStream:"UnsupportedStream",webGlRendererError:"WebGlRendererError",audioPlaybackError:"audioPlaybackError",unexpectedClose:"unexpectedClose",incompatibleOriginator:"incompatibleOriginator"},HISTOGRAM_BATCH:{seconds1to3:2,seconds3to5:4,seconds5to8:7,seconds8to15:14,seconds15to60:59,seconds60toMax:1e6},RENEGOTIATION_ERROR:{local:"local",glare:"glare",signaling:"signaling",media:"media",escalation:"escalation"},MSI:{unsubscribe:-1,subscribeAny:-2},MEDIA_LABEL:{audio:"main-audio",video:"main-video",sharing:"applicationsharing-video",data:"data"},MEDIA_TYPE:{audio:"audio",video:"video",sharing:"sharing",data:"x-data",dataChannel:"application"},MODALITY:{audio:"audio",video:"video",sharing:"sharing",data:"data"},TRACK_KIND:{audio:"audio",video:"video"},ICE_TRANSPORT_POLICY:{all:"all",relay:"relay"},RENDERER_TYPE:{video:"video",sharing:"sharing"},CONTENT_TYPE:{SDP:"application/sdp"},ALLOWED_CONTENT_TYPES:{SDP_ONLY:["application/sdp"],SDP_NGC:["application/sdp","application/sdp-ngc-0.5","application/sdp-ngc-1.0"]},STREAMING_STATE:{created:"created",started:"started",active:"active",inactive:"inactive",stopped:"stopped",removed:"removed",failed:"failed"},TIME_INTERVAL:{SEC_1:1},DISPLAY_SOURCE_ID:"display",EMPTY_DEVICE_ID:"0",SYSTEM_AUDIO_SOURCE_ID:"system",MULTIPLE_RECV_STREAMS:"multipleVideoStreams",PROFILES:{udpTlsRtpSavpf:"UDP/TLS/RTP/SAVPF",rtpSavpf:"RTP/SAVPF",rtpSavp:"RTP/SAVP",udpDtlsSctp:"UDP/DTLS/SCTP"},REPORTING_PROFILE:{RT_PROFILE:"REAL_TIME",BE_PROFILE:"BEST_EFFORT",NRT_PROFILE:"NEAR_REAL_TIME"},PAYLOAD_TYPE:{DATA_CHANNEL:"webrtc-datachannel",X_DATA:"127 126",MSRTC_RED:97,MSRTC_CNFB:120},VIDEO_CAPABILITIES:{MAX_FS_PATH:"max-fs",MAX_MBPS_PATH:"max-mbps",MAX_FPS_PATH:"max-fps",MAX_BR_PATH:"max-br",SSRC_PATH:"ssrc",RID_PATH:"rid",KEYFRAME_PATH:"KeyFrame",MAX_WIDTH:"max-width",MAX_HEIGHT:"max-height",VLA_DEBUG:"vla-debug"},TRANSPORT_CC:{EXT_URI:Xe,MSSDP_ENCODED_URI:Xe.replace(/\//g,"\\"),ATTRIBUTE:"transport-cc"},ABS_SEND_TIME:{EXT_URI:Ze,MSSDP_ENCODED_URI:Ze.replace(/\//g,"\\")},VLA:{EXT_URI:et,EXT_URI_NON_ADV:et+"-non-advertised",DEFAULT_VALUE:10},AUDIO_DECODER:{MUCHv2:{CODEC:{NAME:"x-much2",RATE:48e3,ENCODING:2},SUBSTITUTION:{NAME:"L16",RATE:48e3,ENCODING:2},PT:113},SatinFB:{CODEC:{NAME:"SATINFB",RATE:48e3,ENCODING:2},SUBSTITUTION:{NAME:"L16",RATE:48e3,ENCODING:2},PT:109}},MACROBLOCK_SIZE:16,MEDIA_EVENT_FIELDS:{Extensions:["IceConnectionState","IceConnectionStatePrevious","SignalingState","SignalingStatePrevious"],metrics:["ReconnectInProgress","IceConnectedStateTime","ErrorType","ErrorDetail","InitialNegotiationType","InitialNegotiationCompleted"]},RES_TABLE:{SEND:[{w:320,h:180,minBr:2e4,maxBr:175e3},{w:416,h:234,minBr:125e3,maxBr:5e5},{w:640,h:360,minBr:4e5,maxBr:575e3},{w:960,h:540,minBr:5e5,maxBr:1125e3},{w:1280,h:720,minBr:1e6,maxBr:25e5},{w:1920,h:1080,minBr:175e4,maxBr:1e8}],RECV:[{w:320,h:180,minBr:2e4,maxBr:175e3},{w:426,h:240,minBr:125e3,maxBr:5e5},{w:640,h:360,minBr:4e5,maxBr:575e3},{w:960,h:540,minBr:5e5,maxBr:1125e3},{w:1280,h:720,minBr:1e6,maxBr:25e5},{w:1920,h:1080,minBr:175e4,maxBr:1e8}]}};function it(e,t){for(const i in e)e.hasOwnProperty(i)&&t(e[i],i)}function nt(e,t){for(const i in e)e.hasOwnProperty(i)&&("object"==typeof e[i]?nt(e[i],t):t(e[i],i,e))}function rt(e){return null!=e&&!Number.isNaN(e)}function st(e,t){return rt(t)?rt(e)?Math.min(e,t):t:e}function at(e){let t=0;return e.forEach((e=>t+=e)),t/=e.length,t}function ot(e,t){let i=!1;for(let n=e.length;n-- >0;)t(e[n],n,e)&&(e.splice(n,1),i=!0);return i}function lt(e){const t=[];for(const i in e)e.hasOwnProperty(i)&&t.push(e[i]);return t}function dt(e){return!Object.keys(e).length}function ct(e){return Object.keys(e)}function ht(e){const t={};return it(e,((e,i)=>{t[i]=e})),t}function ut(e){let t;if(!e||"object"!=typeof e)return e;if(e instanceof Date)return t=new Date,t.setTime(e.getTime()),t;if(e instanceof Array){t=[];for(let i=0,n=e.length;i<n;i++)t[i]=ut(e[i]);return t}if(e instanceof Object)return t={},it(e,(function(e,i){t[i]=ut(e)})),t;throw new Error("Unable to copy: "+Ge(e))}function pt(e){return Object.keys(e).forEach((t=>{void 0===e[t]&&delete e[t]})),e}function gt(){const e=()=>Math.floor(65536*(1+Math.random())).toString(16).substring(1);return e()+e()+e()+"4"+e().substring(1)+"b"+e().substring(1)+e()+e()+e()}function mt(e,t){let i;const n=typeof e;if(e===t)return!0;if(n!==typeof t||"object"!==n&&"function"!==n)return!1;if(null===e||null===t)return e===t;if(e instanceof Date&&t instanceof Date)return+e==+t;if(e instanceof Map&&t instanceof Map)return function(e,t){let i;if(e.size!==t.size)return!1;let n=!0;return e.forEach(((e,r)=>{i=t.get(r),(i!==e||void 0===i&&!t.has(r))&&(n=!1)})),n}(e,t);for(i in e)if(!(i in t)||!mt(e[i],t[i]))return!1;for(i in t)if(!(i in e)||!mt(e[i],t[i]))return!1;return!0}function ft(e,t){if(-1===t.indexOf(e))throw{detail:`${e} mediaContent.contentType is not supported`,type:tt.MEDIA_ERROR.incompatibleOffer}}function St(e,t){e.forEach((e=>{if(""!==e&&-1!==t.findIndex((t=>t===e)))throw{detail:`Required feature '${e}' is not acceptable.`,type:tt.MEDIA_ERROR.incompatibleOffer}}))}function vt(e,t,i,n=0){for(let r=1;r<e.length;r++)if(e[r-1]+n<t&&t<=e[r]+n)return i?e[r]:e[r-1];return e[0]}function yt(e,t,i){return t<=e&&e<=i}function Ct(e,...t){for(const i of t)if(i.hasOwnProperty(e))return i[e]}function Tt(e,t){return e.filter((e=>!t.some((t=>t===e))))}function Et(e,t){if(e===t)return e;let i=0,n=0,r="";for(let s=0;s<e.length&&!(r.length>e.length-s);s++){let a=s;n-i>r.length&&(r=e.substring(i,n),s=n-1),i=s,n=s;for(let o=0;o<t.length;o++)a<e.length&&t[o]===e[a++]?n=a:(a=s,n-i>r.length&&(r=e.substring(i,n),s=n-1),i=s,n=s)}return r}function _t(e,t){const i=new Array(e.length+1);for(let n=0;n<e.length+1;n++){i[n]=new Array(t.length+1);for(let e=0;e<t.length+1;e++)i[n][e]=0}for(let t=1;t<e.length+1;t++)i[t][0]=t;for(let e=1;e<t.length+1;e++)i[0][e]=e;for(let n=1;n<e.length+1;n++)for(let r=1;r<t.length+1;r++){let s=1;e[n-1]===t[r-1]&&(s=0),i[n][r]=Math.min(i[n-1][r]+1,i[n][r-1]+1,i[n-1][r-1]+s)}return i[e.length][t.length]}function bt(e,t=3){return e&&parseFloat(e.toFixed(t))}function Pt(e,t){if(!e)return"";if(e.length<3)return e;const i=[],n=e.match(/\(([0-9a-zA-Z]+:[0-9a-zA-Z]+)\)/);n&&i.push(n[1]);try{if(t?.length){const n=new RegExp(`(${t.join("|")})`,"gi");let r=n.exec(e);for(;r;)i.push(r[1]),r=n.exec(e)}else i.push("no_keywords")}catch(e){i.push(`Error: ${Ge(e)}`)}return 0===i.length?"unknown":i.join(" ")}function It(e,t,i=0){return e&&void 0!==t&&t>-1&&e.length>t&&e.splice(i,e.length-t),e}function At(e,t,i,n=0){It(e,0===i?0:i-1,n),0!==i&&e.push(t)}function Rt(e,t){const i={};for(const e in t)i[e]={get:t[e],configurable:!1,enumerable:!0};Object.defineProperties(e,i)}function wt(e){return e?.length>0?e[e.length-1]:void 0}var Mt=window?.performance?.now&&window?.performance?.timeOrigin,Ot=Mt?()=>window.performance.now():()=>Date.now(),Dt=Mt?window.performance.timeOrigin:0,kt=Ot,Nt=Dt;function Lt(e,t,i){if(e?.length>0){const n=[];for(const r of e){const e=ut(r);e[t]=e[t]&&e[t]-i,n.push(e)}return n}return e}function xt(e,t){if(!e)return;const i={seconds1to3:[],seconds3to5:[],seconds5to8:[],seconds8to15:[],seconds15to60:[],seconds60toMax:[]};for(const[n,r]of Object.entries(e))for(const e of r)i[n].push(e-t);return i}function Ft(e,t,i=!1){const n=e?.map(t).filter((e=>void 0!==e&&!isNaN(e)&&null!==e&&""!==e&&(!1===i||0!==e)));return n?.length?n.join(","):void 0}function Ut(e,t,i){const n=e?.map(t).filter((e=>void 0!==e&&!isNaN(e)&&null!==e&&""!==e)).splice(-i);return n?.length?n:void 0}function Vt(e,t){const i=[];for(const n of e.keys())t.has(n)||i.push(n);for(const t of i)e.delete(t)}function Ht(e){return"object"==typeof e?Ge(e):e}function Bt(e){const t=Object.keys(e).map(Number).sort(((e,t)=>e-t)),i=t.reduce(((t,i)=>t+(e[i]??0)),0);return{getPercentile:n=>{const r=i*n;let s=0;for(const i of t)if(s+=e[i],s>=r)return i}}}function $t(e,t){return e.hasOwnProperty(t)?e[t]:e.hasOwnProperty(t.toLowerCase())?e[t.toLowerCase()]:void 0}function jt(e){const t=e.toLowerCase(),i='token_types="',n=t.indexOf(i);if(-1===n)return[];const r=t.indexOf('"',n+13);if(-1===r)return[];const s=t.substring(n+13,r).trim();return""===s?[]:s.split(" ")}var Gt=i(496486),Wt={numVideoChannelsGvc:({current:e,constraints:t})=>Kt(e,t),specCompliantSimulcast:({current:e,constraints:t})=>Yt(e,t),multiviewResolutionLimits:({current:e,constraints:t,logger:i})=>Jt(e,t,i),enableVla:({current:e,settings:t,constraints:i,settingsSuffix:n})=>Zt(e,t,i,n),allowRemoteVla:({current:e,settings:t,constraints:i,settingsSuffix:n})=>Zt(e,t,i,n),enableNonAdvVla:({current:e,settings:t,constraints:i,settingsSuffix:n})=>Zt(e,t,i,n),outgoingVideoLimit:({current:e,constraints:t})=>Xt(e,t)},qt=(e,t,i)=>({...zt(e,t,i),...zt(e,t,i,"1on1"),...zt(e,t,i,"Multiparty")}),zt=(e,t,i,n)=>{const r={};for(const s of Object.keys(Wt)){const a=`${s}${n??""}`;n&&!rt(t[a])||(r[a]=Wt[s]({current:t[a],settings:t,constraints:i,settingsSuffix:n,logger:e}))}return r},Kt=(e,t)=>st(e,t.maxIncomingStreams),Jt=(e,t,i)=>{const n=t.maxParticipantResolutions;if(!n)return e;const r={more:e.more};if(Number.isInteger(n))Object.keys(e).forEach((t=>{r[t]=st(n,e[t])}));else{const t=Object.keys(n);if(!t.length)return i.warn(`ignoring invalid value provided for maxParticipantResolutions: ${n}}`),e;t.forEach((t=>{r[t]=st(n[t],e[t]||e.more)}))}return r},Yt=(e,t)=>void 0!==t.maxSimulcastLayers||e.allowOverride?{...e,video:Qt(e.video,t),sharing:Qt(e.sharing,t)}:e,Qt=(e,t)=>{const i=e?.layerScaleFactors?.filter((e=>e<=t.maxSimulcastLayers));return i?.length>1?{...e,layerScaleFactors:i}:{...e,enableLocally:!1,allowEnableRemotely:!1}},Xt=(e,t)=>{const{outgoingVideoLimit:i,maxOutgoingResolution:n}=t,r=(0,Gt.isNumber)(i),s=st(r?i:i?.maxResolution,n),a=st(e?.maxResolution,s),o=st(e?.maxBitrate,r?void 0:i?.maxBitrate),l=st(e?.maxFramerate,r?void 0:i?.maxFramerate);return{...e,maxResolution:a,maxBitrate:o,maxFramerate:l}},Zt=(e,t,i,n)=>!((t.specCompliantSimulcast.constraintsDisableVla||t[`specCompliantSimulcast${n}`]?.constraintsDisableVla)&&i.maxSimulcastLayers<2)&&e,ei=class extends Qe{constructor(e){super(e),this.logger=e,this._constraints={},this._callConstraintsTelemetry=[]}get constraints(){return this._constraints}get callConstraintsTelemetry(){return this._callConstraintsTelemetry}addCallConstraintsTelemetryEvent(e,t){const i={timestamp:(new Date).getTime(),type:t,value:e};this._callConstraintsTelemetry.push(i)}setConstraints(e){this.logger.debug("Setting new platform call constraints",JSON.stringify(e)),this._constraints=e,this.addCallConstraintsTelemetryEvent(e,"requested"),this.raiseChanged()}getSettings(e){return qt(this.logger,e,this._constraints)}},ti=class e{constructor(e){this._callingLogger=e,this._maybeLog=(e,...t)=>{try{this._callingLogger[e](...t)}catch(e){this._callingLogger.info("[failed to log]",Ve(e))}}}getPrefix(e,t){let i="";return t&&(i+=`[${t}]`),e&&(i+=`[${e}]`),i}createChild(t,i){return new e(this._callingLogger.createChild(t,i))}createFnLogger(t,i,...n){return new e(this._callingLogger.createChild(this.getPrefix(t,i)+n.join(""),!1))}logSuccess(e){this._maybeLog("info",`success=${e}}`)}logFailure(e){const t=Ve(e);this._maybeLog("info",`failed=${t}}`)}log(...e){this._maybeLog("log",...e)}debug(...e){this._maybeLog("debug",...e)}info(...e){this._maybeLog("info",...e)}warn(...e){this._maybeLog("warn",...e)}error(...e){this._maybeLog("error",...e)}};function ii(){return"2024.13.01.19"}function ni(){return"5d60bfcfbf65862f074bd44f3beb1676fd6f338a"}var ri=i(496486),si="0.0";function ai(e,t){let i=[];if(t.some((t=>(i=e.match(t),!!i))),!i||i.length<2)return si;const n=i[1]?.replace(/_/g,".");return n||si}function oi(e){return"136"===function(){const e="os-sku",t=window.external;return t?.getHostEnvironmentValue?JSON.parse(t.getHostEnvironmentValue(e))[e]:"-1"}()?"Hololens":/hostAudio-Processing/i.test(e)?"RoomAudioProcessing":/iPhone|iPad|iPod|Android|Mobi/i.test(e)?"Mobile":"Desktop"}function li(){const e="((\\d+\\.?){2,4})",t={name:"Unknown",engine:"Unknown",version:si,formFactor:"Unknown"},i=[{name:"WebView2",engine:"Chromium",key:"maglev",masks:[new RegExp(`maglev/${e}`)]},{name:"Edge",engine:"Edge",key:"Edge",masks:[new RegExp(`Edge/${e}`)]},{name:"EdgeAnaheim",engine:"Chromium",key:"EdgA",masks:[new RegExp(`Chrome/${e}`)]},{name:"EdgeAnaheim",engine:"Chromium",key:"Edg",masks:[new RegExp(`Edg/${e}`)]},{name:"Chromium",engine:"Chromium",key:"Chromium",masks:[new RegExp(`Chromium/${e}`)]},{name:"Opera",engine:"Chromium",key:"OPR",masks:[new RegExp(`Chrome/${e}`)]},{name:"YandexBrowser",engine:"Chromium",key:"YaBrowser",masks:[new RegExp(`Chrome/${e}`)]},{name:"Electron",engine:"Chromium",key:"Electron",masks:[new RegExp(`Electron/${e}`)]},{name:"CiscoOS",engine:"Chromium",key:"Cisco",masks:[new RegExp(`Chrome/${e}`)]},{name:"ZoomRoom",engine:"Chromium",key:"ZoomRoom",masks:[new RegExp(`Chrome/${e}`)]},{name:"SamsungTV",engine:"Chromium",key:"TeamsSamsungTVBrowser",masks:[new RegExp(`Chrome/${e}`)]},{name:"Chrome",engine:"Chromium",key:"Chrome",masks:[new RegExp(`Chrome/${e}`)]},{name:"Firefox",engine:"Firefox",key:"Firefox",masks:[new RegExp(`Firefox/${e}`)]},{name:"Safari",engine:"Safari",key:"Safari",masks:[new RegExp(`Version/${e}.*?Safari/`)]},{name:"AppleWebView",engine:"Safari",key:"Mac OS X",masks:[new RegExp("(\\d+_\\d+(_\\d+)?).*Mac OS X"),new RegExp("(\\d+_\\d+(_\\d+)?).*")]},{name:"MSIE",engine:"MSIE",key:"Trident",masks:[new RegExp(`MSIE ${e}`),new RegExp(`rv:${e}`)]}],n=navigator.userAgent;let r=t;return i.some((e=>{if(-1!==n.indexOf(e.key)){const t=window.navigator.mediaDevices?.isRemote;return r={name:e.name,engine:t?"ChromiumAVD":e.engine,version:ai(n,e.masks),formFactor:oi(n)},!0}return!1})),r}var di={src:["//amp.azure.net/libs/amp/2.3.8.4/azuremediaplayer.min.js","https://amsglob0cdnstream13.azureedge.net/1-0-3013-17/bundles/player-skin.min.js"],css:["https://amsglob0cdnstream13.azureedge.net/1-0-3013-17/bundles/player-skin.min.css","https://statics.teams.cdn.office.net/evergreen-assets/broadcast/video-player.css?v=2"],styles:["azuremediaplayer","amp-stream-skin","amp-big-play-centered"],lang:"en-us",disableFullscreenButton:!1,playerType:0},ci={src:["https://azuremdncdnhlsendpoint.azureedge.net/hlsjsv115/hls.js","https://vzmdncdnendpoint.azureedge.net/hlsjsv115/hls.js"],css:[],styles:[],lang:"en-us",disableFullscreenButton:!1,muteVideo:!1,playerType:1,hydraPlayerWebSdkUrls:["https://afdhls.playerscript.prod.ml.cdn.office.net/hlsrt2023-1208-2/hydra_player_hls_bundle.js","https://vzhls.playerscript.prod.ml.cdn.office.net/hlsrt2023-1208-2/hydra_player_hls_bundle.js"]},hi={src:[],css:[],styles:[],playerType:2,hydraPlayerWebSdkUrls:["https://afdhls.playerscript.prod.ml.cdn.office.net/umsrt2023-1207-3/hydra_player_ums_bundle.js","https://vzhls.playerscript.prod.ml.cdn.office.net/umsrt2023-1207-3/hydra_player_ums_bundle.js"]},ui=class{constructor(e,t,i,n){this.configIds=i,this.logger=n,this.defaultSettings=function(){let e;return e="Safari"===li().engine?new gi:new pi,e.getSettings()}(),this.logger.info(`client settings: ${JSON.stringify(t)}`),this.defaultSettings.debug=t?.debug||!1,this.defaultSettings.playerType=t?.playerConfig?.playerType||this.defaultSettings.playerType,t?.playerConfig&&(0===this.defaultSettings.playerType?this.defaultSettings.ampSettings.liveStreamPlayerConfiguration=t.playerConfig:1===this.defaultSettings.playerType?this.defaultSettings.hlsSettings.liveStreamPlayerConfiguration=t.playerConfig:2===this.defaultSettings.playerType&&(this.defaultSettings.umsSettings.liveStreamPlayerConfiguration=t.playerConfig)),(0,ri.mergeWith)(this.defaultSettings,e,mi),this.logger.info(`applied settings: ${JSON.stringify(this.defaultSettings)}`)}get playerConfig(){return 0===this.defaultSettings.playerType?this.defaultSettings.ampSettings.liveStreamPlayerConfiguration:1===this.defaultSettings.playerType?this.defaultSettings.hlsSettings.liveStreamPlayerConfiguration:2===this.defaultSettings.playerType?this.defaultSettings.umsSettings.liveStreamPlayerConfiguration:null}get config(){return this.defaultSettings}},pi=class{constructor(){this.defaultSettings={allowSdnPlugins:!0,capturePlayerLogs:!0,playerType:0,loadType:1,maxPlayerDiagnosticsCount:50,maxPlayerMemoryTraceLogCount:1e3,maxPlayerPlaybackEventCount:50,maxRetryCount:10,playerTelemetryTickMs:1e3,removeEmptyDefaultTextTrack:!0,sendSnapshotTelemetry:!1,sendSnapshotTelemetryEveryMs:1e4,sendInitialTelemetryAfterMs:6e4,sendTelemetry:!0,textTrackKind:"subtitles",maxRetryCountForLoadingResources:5,maxVideoTrackHistoryLogCount:100,ampSettings:{errorCodesEligibleForStreamingUrlSwitch:[4194309,2097564,2097556,2097752,2097753,5242884],liveStreamPlayerConfiguration:di,sourceResetTimeoutInMs:1e3,streamingUrlSwitchMaxCount:2,resetStreamingUrlSwitchCount:!1,useBrowserWindowSizeForBitRate:!0,estimateAbsoluteTime:!0,maxAbsoluteTimeOffsetEstimationResultsLogCount:100,collectUserInitiatedSeekEventsTelemetry:!0,maxUserInitiatedSeekEventCount:100},hlsSettings:{liveStreamPlayerConfiguration:ci,timeoutForSwitchingUrl:9e3,estimateAbsoluteTime:!0,maxAbsoluteTimeOffsetEstimationResultsLogCount:100,playlistInitialSequenceNumber:1,skipNonce:!1,maxStreamConnectionResultsLogCount:100,logHlsJsEvents:!1,logHlsJsEventsEveryMs:5e3,maxPlayerExperimentalEvents:100},umsSettings:{liveStreamPlayerConfiguration:hi,timeoutForSwitchingUrl:9e3,maxStreamConnectionResultsLogCount:100,minTargetEdgeLatency:.2,maxEdgeLatencyHistoryLength:300,latencyCompensationThreshold:.5,maxPlayerExperimentalEvents:100}}}getSettings(){return this.defaultSettings}},gi=class extends pi{constructor(){super(),this.settings=super.getSettings(),this.settings.loadType=0,this.settings.allowSdnPlugins=!1,this.settings.umsSettings.minTargetEdgeLatency=.6,this.settings.umsSettings.latencyCompensationThreshold=.9}getSettings(){return this.settings}};function mi(e,t){if((0,ri.isArray)(e))return t.slice()}function fi(e){return!!e&&!!e.url&&!!e.decryptionToken}function Si(e,t,i){if(!e&&!i)throw new Error("Assert failed"+(void 0!==t?`: ${t}`:""))}var vi=class{constructor(e,t,i){this.name=e,this.stopCrash=t,this.start(i)}complete(){Si(this.startTime,"not started",this.stopCrash),Si(void 0===this.duration,"already completed",this.stopCrash),this.duration=Date.now()-this.startTime}updateDetails(e,t){if(this.details&&"object"==typeof this.details)for(let i=0;i<e.length;i++)this.details[e[i]]=t[i]}fail(e){this.failReason=e,this.complete()}set detail(e){this.details=e}getTelemetryEvent(){Si(this.startTime,"not started",this.stopCrash);try{Si(void 0!==this.duration,"not completed",this.stopCrash)}catch(e){if("SetSource"!==this.name&&"Load"!==this.name)throw e}const e={name:this.name,startTime:this.startTime,duration:this.duration};return this.failReason&&(e.failReason=this.failReason),this.details&&(e.details=this.details),e}start(e){Si(!this.startTime,"already started",this.stopCrash),this.startTime=Date.now(),this.details=e}},yi=class{constructor(e,t,i){this.config=e,this.logger=t,this.playerDiagnosticsLog=i,this.currentScenarioMap=new Map,this.playerEvents=[],this.playbackEvents=[],this.userInitiatedSeekEvents=[],this.experimentalEvents=[],this.clientNetworkType=void 0,this.maxPlayerPlaybackEventCount=e.maxPlayerPlaybackEventCount||5,this.maxPlayerDiagnosticsCount=e.maxPlayerDiagnosticsCount||5,this.maxPlayerMemoryTraceLogCount=e.maxPlayerMemoryTraceLogCount||100,this.maxUserInitiatedSeekEventCount=e.ampSettings?.maxUserInitiatedSeekEventCount||100,this.stopCrash=e.stopCrash||!1,this.config.debug&&(this.playerDiagnosticsLog.memoryLog=[]),this.addNetworkTypeEventListener()}getPlayerDiagnosticSnapshot(){return this.currentPlayerDiagnosticSnapshot}registerStatsUpdated(e){this.currentPlayerDiagnosticSnapshot=e,Object.keys(this.playerDiagnosticsLog).forEach((t=>{const i=t,n=this.playerDiagnosticsLog[t];if(Array.isArray(n)){n.push(e[i]);const t="memoryLog"===i&&n.length>this.maxPlayerMemoryTraceLogCount,r="memoryLog"!==i&&n.length>this.maxPlayerDiagnosticsCount;(t||r)&&n.splice(0,1)}else this.playerDiagnosticsLog[t]=e[i]}))}registerEventLoadAttempt(e,t){this.registerScenario(e,t)}registerEventLoadFailed(e,t){this.completeScenario(e,t)}registerEventLoadSucceeded(e,t){this.completeScenario(e,void 0,t)}registerPlayerLoadAttempt(){this.registerScenario("Load")}registerPlayerLoadSucceeded(e){this.completeScenario("Load",void 0,e)}registerPlayerLoadFailed(e){this.completeScenario("Load",e)}registerPlayerSetupAttempt(){this.registerScenario("Setup")}registerPlayerSetupSucceeded(){this.completeScenario("Setup")}registerPlayerSetupFailed(e){this.completeScenario("Setup",e)}registerStreamConnectionAttempt(e){this.registerScenario("StreamConnection")}registerStreamConnectionSucceeded(){this.completeScenario("StreamConnection")}registerStreamConnectionFailed(e){this.completeScenario("StreamConnection",e)}registerSetSourceAttempt(e,t){let i=e;t&&(i={src:e,reason:t}),this.registerScenario("SetSource",i)}registerSetSourceSucceeded(e){this.getScenario("SetSource").updateDetails(["src"],[e]),this.completeScenario("SetSource")}registerSetSourcedFailed(e,t){this.getScenario("SetSource").updateDetails(["src"],[t]),this.completeScenario("SetSource",e)}registerSdnPluginLoad(e,t,i){this.registerScenario("SdnPluginLoad",e);const n=t?void 0:i;this.completeScenario("SdnPluginLoad",n)}registerPlayerDestroyed(e){this.registerScenario("Destroyed",e),this.completeScenario("Destroyed")}registerPlaybackStateChanged(e,t){let i;"Ready"!==e||this.firstReadyStateTimestamp?"Playing"!==e||this.firstPlayingStateTimestamp||(this.firstPlayingStateTimestamp=Date.now()):this.firstReadyStateTimestamp=Date.now(),t&&"Buffering"===e&&(t?i=t.message:this.logger.debug(`Unexpected buffering payload: ${JSON.stringify(t)}`)),this.registerPlaybackEvent("StateChanged",e,i)}registerPlaybackError(e,t){this.registerPlaybackEvent("Error",{errorType:e,details:t})}registerDownloadBitratechanged(e){this.registerPlaybackEvent("BitrateChangedDownload",e)}registerStreamOptionsConfigured(e,t){this.registerPlaybackEvent("StreamOptionsConfigured",this.generateCleanedStreamOption(e),t)}registerPlaybackBitratechanged(e){this.registerPlaybackEvent("BitrateChangedPlayback",e)}registerPotentialMediaFreeze(e){this.registerPlaybackEvent("PotentialMediaFreeze",e)}registerCaptionToggle(e,t,i){const n={isEnabled:e,culture:t,playerTime:i};this.registerPlaybackEvent("CaptionsToggled",n)}registerFullScreenChange(e){this.registerPlaybackEvent("FullscreenChanged",e)}registerMute(e){this.registerPlaybackEvent("Mute",e)}registerVolumeChange(e){this.registerPlaybackEvent("Volume",e)}getExperimentalEvents(){return{playback_experimentalEvents:this.prepareForTelemetry(this.experimentalEvents)}}getUserInitiatedSeekEvents(){return{playback_userInitiatedSeekEvents:this.prepareForTelemetry(this.userInitiatedSeekEvents)}}getSnapshotReport(e={}){const t=this.playerEvents.map((e=>e.getTelemetryEvent())),i=this.playbackEvents;let n={};return this.currentPlayerDiagnosticSnapshot&&(n=this.filterAndPrepareTelemetry()),{isFullReport:!1,configIds:e.configIds||"",playerId:e.playerId||"",correlationId:e.correlationId||"",traceId:e.correlationId?e.correlationId.replace(/-/g,""):"",eTag:e.eTag||"",isFinal:e.isFinal??!1,isIframe:1===this.config.loadType,isFullscreenButtonDisabled:e.disableFullscreenButton??!1,threadId:e.threadId||"",telemetryTickMs:this.currentPlayerDiagnosticSnapshot&&this.currentPlayerDiagnosticSnapshot.statsInterval?this.currentPlayerDiagnosticSnapshot.statsInterval:-1,tsCallingVersion:"2024.13.01.19",...this.getInitializationReport(t,i),...this.getPlaybackReport(i),...this.getBitrateReport(i),...this.getSdnReport(t),...this.getSetSourceReport(t),...this.getExperimentalEvents(),...this.getUserInitiatedSeekEvents(),networkType:this.getClientNetworkType(),callSetupSucceeded:this.getCallSetupSucceeded(t),callDropped:this.getCallDropped(i),...n}}getReport(e={}){const t=this.playerEvents.map((e=>e.getTelemetryEvent())),i=this.playbackEvents;return{callendReason:e.callendReason,isFullReport:!0,configIds:e.configIds||"",playerId:e.playerId||"",correlationId:e.correlationId||"",traceId:e.correlationId?e.correlationId.replace(/-/g,""):"",eTag:e.eTag||"",isFinal:e.isFinal??!1,isIframe:1===this.config.loadType,isFullscreenButtonDisabled:e.disableFullscreenButton??!1,threadId:e.threadId||"",telemetryTickMs:this.currentPlayerDiagnosticSnapshot&&this.currentPlayerDiagnosticSnapshot.statsInterval?this.currentPlayerDiagnosticSnapshot.statsInterval:-1,tsCallingVersion:"2024.13.01.19",...this.getInitializationReport(t,i),...this.getPlaybackReport(i),...this.getBitrateReport(i),...this.getSdnReport(t),...this.getSetSourceReport(t),...this.getExperimentalEvents(),...this.getUserInitiatedSeekEvents(),networkType:this.getClientNetworkType(),callSetupSucceeded:this.getCallSetupSucceeded(t),callDropped:this.getCallDropped(i),...this.getPlayerDiagnosticLog()}}registerExperimentalEvent(e,t,i){const n=this.createTelemetryEvent(e,t,i);this.experimentalEvents.push(n),this.logTelemetryEvent(n)}registerUserInitiatedSeek(e){const t=(this.currentPlayerDiagnosticSnapshot?.currentPlayPosition?this.currentPlayerDiagnosticSnapshot.currentPlayPosition:-1)<e.newCurrentPlayPosition,i={...e,seekForward:t},n=this.createTelemetryEvent("UserInitiatedSeek",i);this.userInitiatedSeekEvents.push(n),this.userInitiatedSeekEvents.length>this.maxUserInitiatedSeekEventCount&&this.userInitiatedSeekEvents.splice(0,1)}createTelemetryEvent(e,t,i){const n={eventType:e,timestamp:Date.now(),currentPlayPosition:this.currentPlayerDiagnosticSnapshot&&this.currentPlayerDiagnosticSnapshot.currentPlayPosition?this.currentPlayerDiagnosticSnapshot.currentPlayPosition:-1};return void 0!==t&&(n.payload=this.prepareForTelemetry(t)),n.message=i,n}registerPlaybackEvent(e,t,i){const n=this.createTelemetryEvent(e,t,i);"Error"===e&&"PlaybackRetried"!==t?.errorType&&(n.fatal=!0),this.playbackEvents.push(n),this.playbackEvents.length>this.maxPlayerPlaybackEventCount&&this.playbackEvents.splice(0,1),this.logTelemetryEvent(n)}getPlayerDiagnosticLog(){if(!this.currentPlayerDiagnosticSnapshot)return{};const e={...this.currentPlayerDiagnosticSnapshot,...this.playerDiagnosticsLog},t={};return Object.keys(e).forEach((i=>{t[`player_${i}`]=this.prepareForTelemetry(e[i])})),t}getCallSetupSucceeded(e){const t=e.find((e=>"Load"===e.name));return!!t&&!t.failReason}getCallDropped(e){return!!e.filter((e=>"Error"===e.eventType)).find((e=>e.fatal))}getInitializationReport(e,t){const i=e.find((e=>"Load"===e.name));return{init_timeLoadToStreamConnectionEstablished:(i&&this.initialStreamConnectionEstablishedTimestamp?this.initialStreamConnectionEstablishedTimestamp-i.startTime:-1)||-1,init_timeLoadToReady:(i&&this.firstReadyStateTimestamp?this.firstReadyStateTimestamp-i.startTime:-1)||-1,init_timeLoadToPlaying:(i&&this.firstPlayingStateTimestamp?this.firstPlayingStateTimestamp-i.startTime:-1)||-1,init_allEvents:this.prepareForTelemetry(e)}}getPlaybackReport(e){const t=e.filter((e=>"StateChanged"===e.eventType)),i=t.find((e=>"Ready"===e.payload)),n=t.find((e=>"Play"===e.payload)),r=t.find((e=>"Start"===e.payload)),s=t.find((e=>"Playing"===e.payload)),a=i&&n?n.timestamp-i.timestamp:-1,o=n&&r?r.timestamp-n.timestamp:-1,l=r&&s?s.timestamp-r.timestamp:-1,d=t.filter((e=>"Seeked"===e.payload)),c=t.filter((e=>"Seeking"===e.payload)),h=t.filter((e=>"Paused"===e.payload)),u=t.filter((e=>"Resume"===e.payload)),p=t.filter((e=>"Buffering"===e.payload)),g=["BitrateChangedDownload","BitrateChangedPlayback","Error","Mute","StateChanged","Volume","StreamOptionsConfigured"],m=e.filter((e=>"Error"===e.eventType)),f=e.filter((e=>"Volume"===e.eventType||"Mute"===e.eventType)),S=e.filter((e=>"StreamOptionsConfigured"===e.eventType)),v=e.filter((e=>!g.includes(e.eventType)));return{playback_timeReadyToPlay:a,playback_timePlayToStart:o,playback_timeStartToPlaying:l,playback_bufferingEvents:this.prepareForTelemetry(p),playback_errorEvents:this.prepareForTelemetry(m),playback_pauseEvents:this.prepareForTelemetry(h),playback_resumeEvents:this.prepareForTelemetry(u),playback_otherEvents:this.prepareForTelemetry(v),playback_seekedEvents:this.prepareForTelemetry(d),playback_seekingEvents:this.prepareForTelemetry(c),playback_stateChangeEvents:this.prepareForTelemetry(t),playback_volumeEvents:this.prepareForTelemetry(f),playback_streamOptionsConfiguredEvents:this.prepareForTelemetry(S)}}generateCleanedStreamOption(e){return{...e,stream:{...e?.stream,decryptionToken:e?.stream?.decryptionToken?"valid":"empty",sdnContext:e?.stream?.sdnContext?"valid":"empty",keyAuthorizationToken:e?.stream?.keyAuthorizationToken?"valid":"empty"},altStream:e?.altStream?{...e?.altStream,decryptionToken:e?.altStream?.decryptionToken?"valid":"empty",sdnContext:e?.altStream?.sdnContext?"valid":"empty",keyAuthorizationToken:e?.stream?.keyAuthorizationToken?"valid":"empty"}:void 0}}getBitrateReport(e){const t=e.filter((e=>"BitrateChangedDownload"===e.eventType)),i=t.sort((e=>Number(e.payload))),n=t.length?{bitrate_downloadChanges:this.prepareForTelemetry(t),bitrate_downloadChangeCount:t.length||-1,bitrate_downloadMin:i[0].payload||-1,bitrate_downloadMax:i[i.length-1].payload||-1}:{},r=e.filter((e=>"BitrateChangedPlayback"===e.eventType)),s=r.sort((e=>Number(e.payload)));return{...n,...r.length?{bitrate_playbackChanges:this.prepareForTelemetry(r),bitrate_playbackChangeCount:r.length||-1,bitrate_playbackMin:s[0].payload||-1,bitrate_playbackMax:s[s.length-1].payload||-1}:{}}}addNetworkTypeEventListener(){window.navigator?.connection?.type&&window.navigator?.connection?.addEventListener("change",(()=>this.updateClientNetworkType()))}updateClientNetworkType(){this.clientNetworkType=void 0,this.getClientNetworkType()}getClientNetworkType(){if(void 0===this.clientNetworkType){let e="Unknown";if(window.navigator?.connection?.type){const t=window.navigator?.connection?.type;switch(t){case"cellular":e="WWAN";break;case"ethernet":e="Wired";break;case"wifi":e="Wireless";break;default:e="Unknown"}}this.clientNetworkType=e}return this.clientNetworkType}getSdnReport(e){const t=e.filter((e=>"SdnPluginLoad"===e.name)),i=t.length?t[t.length-1]:void 0;return{sdn_loaded:!(!i||void 0!==i.failReason),sdn_details:i&&i.details||"",sdn_error:i&&i.failReason||"",sdn_events:this.prepareForTelemetry(t)}}getSetSourceReport(e){const t=e.filter((e=>"SetSource"===e.name));return{set_source_events:this.prepareForTelemetry(t)}}registerScenario(e,t){const i=this.currentScenarioMap.get(e),n=new vi(e,this.stopCrash,t);Si(!i,`previous scenario:${Ge(i)} is not completed, new scenario:${Ge(n)}`,this.stopCrash),this.currentScenarioMap.set(e,n),this.playerEvents.push(n)}getScenario(e){return this.currentScenarioMap.get(e)}completeScenario(e,t,i){const n=this.currentScenarioMap.get(e);Si(n,"no scenario to complete",this.stopCrash),t?n.fail(t):("StreamConnection"!==e||this.initialStreamConnectionEstablishedTimestamp||(this.initialStreamConnectionEstablishedTimestamp=Date.now()),i&&(n.detail=i),n.complete()),this.currentScenarioMap.delete(e)}logTelemetryEvent(e){this.config.debug&&(this.logger.debug(`PlayerTelemetryEvent: ${JSON.stringify(e)}`),this.logger.debug(`PlayerDiagnosticData: ${JSON.stringify(this.currentPlayerDiagnosticSnapshot)}`))}filterAndPrepareTelemetry(){const e=new Set;e.add("serviceLatencyCdg"),e.add("endToEndLatencyCdg"),e.add("videoEdgeLatencyCdg");const t={};return Object.keys(this.currentPlayerDiagnosticSnapshot).forEach((i=>{e.has(i)||(t[`player_${i}`]=this.prepareForTelemetry(this.currentPlayerDiagnosticSnapshot[i]))})),t}prepareForTelemetry(e){return"boolean"==typeof e?e:"string"==typeof e||void 0===e?e||"":"number"==typeof e?e??-1:JSON.stringify(e)}},Ci=i(496486);function Ti(e){return new Promise((t=>{t(e())}))}function Ei(){let e,t;return{promise:new Promise(((i,n)=>{e=i,t=n})),resolve:e,reject:t}}function _i(e){return new Promise((t=>setTimeout(t,e)))}function bi(){const e=Oi(),t=Di();let i;return(i||(i={})).CaptionFunctionalityNotSupported="CaptionFunctionalityNotSupported",class{constructor(e,t){this.container=e,this.eventsHandler=t,this.videoElementEvents=[],this.playerEvents=[],this.maxMemoryTraceLogCount=1e4,this.videoSourceType="application/dash+xml",this.sdnPluginLoaded=!1,this.statsTimer=-1,this.statsInterval=1e3,this.videoSourceSetAttemptCount=0,this.totalBufferingTime=0,this.isBuffering=!1,this.totalPlayingTime=0,this.isPlaying=!1,this.videoTrackTotalDurations=[]}get contextWindow(){return this.container.ownerDocument.defaultView}configure(e,t,i){this.liveStreamOptions=e,this.playerId=i,t&&(this.configProvider=t,this.statsInterval=t.config.playerTelemetryTickMs||this.statsInterval,this.maxMemoryTraceLogCount=t.config.maxPlayerMemoryTraceLogCount||this.maxMemoryTraceLogCount)}getIceCandidates(){let e=[];try{const t=this.liveStreamOptions.stream.sdnContext||this.liveStreamOptions.altStream?.sdnContext||"",i=JSON.parse(t),n=JSON.parse(i.sdnConfig);if(!n.RTCIceCandidates)throw new Error("RTCIceCandidates not present in SDN Context");e=n.RTCIceCandidates}catch(e){this.log(`getIceCandidates failed: ${JSON.stringify(e.message)}`,"error")}return this.log(`getIceCandidates: ${JSON.stringify(e)}`,"debug"),e}loadPlayerScript(){let e=Promise.resolve("");const t=this.configProvider.playerConfig.nonce,i=this.configProvider.playerConfig.css;for(let n=0;n<i.length;n++)e=e.then((()=>this.retry((()=>this.loadCss(this.container.ownerDocument,i[n],t)))));return e=e.then((()=>this.loadAmpScript())),e}loadAmpScript(){this.log("loadPlayerScript started");let e=Promise.resolve("");const t=this.configProvider.playerConfig?.nonce,i=this.configProvider.playerConfig?.src||[],n=Math.max(2,this.configProvider.config.maxRetryCountForLoadingResources);if(0===i.length)return Promise.reject("AMP Player Src is empty");for(let r=0;r<i.length;++r)e=e.then((()=>this.loadScriptPromise(i,r,t,n)));return e}loadScriptPromise(e,t,i,n,r=""){return this.retry((()=>this.setScriptByLoad(this.container.ownerDocument,e[t],i)),n).then((i=>`${e[t]}: ${i} `.concat(r))).catch((s=>this.retry((()=>this.setScriptByBlob(this.container.ownerDocument,e[t],i)),n).then((i=>`${e[t]}: ${i}`.concat(` ${s} `,` ${r} `))).catch((a=>this.retry((()=>this.setScriptByInnerHtml(this.container.ownerDocument,e[t],i)),1).then((i=>`${e[t]}: ${i}`.concat(` ${s} `,`${a} `,` ${r} `))).catch((s=>{let o=r;return t<e.length&&(o=o.concat(`Failed to load script, nonce: ${i}, src: ${e[t]} index: ${t} `),o=o.concat(`${n} attempts LoadFailure `,`${n} attempts BlobFetchFailure: `,a,", 1 attempt InnerHtmlFailure: ",`${s} `)),Promise.reject(o)}))))))}retry(e,t=this.configProvider.config.maxRetryCountForLoadingResources,i=1,n=200){return e(t).then((e=>`${e}, succeeded on load number: ${i} `)).catch((r=>(this.log(`Error loading resource: ${r} -- ${t} retriesLeft`),0==--t?Promise.reject(`${r}`):new Promise((s=>setTimeout((()=>s(this.retry(e,t,i+1).then((e=>"string"==typeof e?`${e}, succeeded on load number: ${i}`:e)).catch((e=>Promise.reject(`${r}`.concat(", ",e)))))),n))))))}setScriptByLoad(e,t,i){const n=e.createElement("script"),r=this.getElementLoadPromise(n,t);return n.src=t,i&&(n.nonce=i),e.head.appendChild(n),r.then((()=>Promise.resolve("Success: setScriptByLoad")))}setScriptByBlob(e,t,i){return this.safeResponse(t).then((t=>t.blob().then((n=>{if(n){const t=URL.createObjectURL(n);return this.setScriptByLoad(e,t,i).then((()=>Promise.resolve("Success: setScriptByBlob")))}return Promise.reject(`${t.status}, blob is null`)}))))}setScriptByInnerHtml(e,t,i){return this.safeResponse(t).then((t=>t.text().then((n=>{if(n){const t=document.createElement("script");return t.innerHTML=n,i&&!this.configProvider.config.hlsSettings.skipNonce&&(t.nonce=i),e.head.appendChild(t),Promise.resolve("Success: setScriptByInnerHtml")}return Promise.reject(`status code:${t.status}, text is null`)}))))}safeResponse(e){return fetch(e).then((e=>e.ok?e:Promise.reject(`${e.status}`)))}tryLoadSdnPlugin(){return this.sdnPluginLoaded||!this.liveStreamOptions.sdn?Promise.resolve():this.configProvider.config.allowSdnPlugins?(this.log("tryLoadSdnPlugin started"),this.retry((()=>this.setScriptByLoad(this.container.ownerDocument,this.liveStreamOptions.sdn.url,this.configProvider.playerConfig.nonce))).then((()=>{this.log("SDN script loaded"),this.sdnPluginLoaded=!0,this.log("tryLoadSdnPlugin done")}))):(this.log("Loading SDN plugins is not allowed"),Promise.reject("Loading SDN plugins is not allowed"))}createAmp(){this.log("createAmp started"),this.createVideoElement();const i=this.getAmpOptions();if(this.playerInstance=this.contextWindow.amp(this.video.id,i),!this.playerInstance)throw this.log("createAmp failed","error"),new Error("playerInstance is null");"html5"===this.playerInstance.currentTechName()?.toLowerCase()&&this.configProvider.config.ampSettings.estimateAbsoluteTime&&this.isControlsDisabled()?(this.absoluteTimeOffsetEstimator=new wi(this.log.bind(this)),this.diagnosticProvider=new e(this.playerInstance,this.contextWindow,new Date,this.configProvider,this.absoluteTimeOffsetEstimator),this.absoluteTimeOffsetEstimator.setEstimationResultCallback(this.onAbsoluteTimeOffsetEstimation.bind(this))):this.diagnosticProvider=new e(this.playerInstance,this.contextWindow,new Date,this.configProvider);const n={controlsEnabled:!this.isControlsDisabled(),logFn:this.log.bind(this),removeEmptyDefaultTextTrack:this.configProvider.config.removeEmptyDefaultTextTrack};this.diagnosticProvider.setValue("streamingEventType",this.liveStreamOptions.streamingEventType),this.diagnosticProvider.setValue("playerControlsEnabled",!this.isControlsDisabled()),this.captionsControl=new t(this.playerInstance,this,n,this.diagnosticProvider),this.registerPlayerEvents(),this.log("createAmp done")}isControlsDisabled(){return void 0!==this.liveStreamOptions.allowPlayerControls?!this.liveStreamOptions.allowPlayerControls:"Overflow"===this.liveStreamOptions.streamingEventType||"TownHall_Basic"===this.liveStreamOptions.streamingEventType||"TownHall_Premium"===this.liveStreamOptions.streamingEventType||"TownHall"===this.liveStreamOptions.streamingEventType}onAbsoluteTimeOffsetEstimation(e){if(this.diagnosticProvider.appendAbsoluteTimeOffsetEstimation(e),!e.isSuccess){const e=this.addEvent("CaptionFunctionalityNotSupported",{detail:{data:{fatal:!0,details:"absolute time offset estimation failed - captions will fail"}}});this.video.dispatchEvent(e)}}addEvent(e,t){let i={};return t?.detail&&(i={detail:t.detail}),new CustomEvent(e,i)}setSource(e){if(this.log("setSource started"),!this.playerInstance)throw this.log("setSource failed: playerInstance is null","error"),new Error("playerInstance is null");this.videoSourceSetAttemptCount++,this.videoSourceSetAttemptCount>0&&this.diagnosticProvider.setValue("retryCount",this.videoSourceSetAttemptCount-1);const t={src:e.url,type:this.videoSourceType,protectionInfo:e.decryptionToken?[{type:"AES",authenticationToken:e.decryptionToken}]:null};this.configureSdnSource(t,e),this.diagnosticProvider.setValue("streamUrl",e.url),this.diagnosticProvider.setValue("streamId",this.getStreamIdFromStreamUrl(e.url)),this.diagnosticProvider.setValue("streamDeliveryPipeline",e.streamDeliveryPipeline||""),this.playerInstance.src([t],this.getTextTracks()),this.absoluteTimeOffsetEstimator&&this.absoluteTimeOffsetEstimator.setManifestFileURL(e.url+"(format=m3u8-aapl-v4)"),this.log("setSource done")}getStreamIdFromStreamUrl(e){try{const t=new URL(e).pathname;if(t){const e=t.split("/");if(e?.length>1)return e[1]}return this.log(`unable to parse stream ID from stream URL: ${e}`,"warn"),""}catch{return this.log(`cannot parse stream ID from invalid stream URL: ${e}`,"warn"),""}}setPlayTime(e){e&&(this.log(`setPlayerTime: ${e}`),this.playerInstance.currentTime(e))}dispose(){this.log("dispose started"),this.diagnosticProvider&&(this.stopStatsCollection(),this.diagnosticProvider.dispose(),this.diagnosticProvider=null),this.captionsControl&&(this.captionsControl.dispose(),this.captionsControl=null),this.playerInstance&&(this.removePlayerEventListeners(),this.playerInstance.getMemoryLog(!0),this.playerInstance.dispose(),this.playerInstance=null),this.eventsHandler.ampDisposed(),this.video&&(this.removeVideoEventListeners(),this.video.parentNode&&this.video.parentNode.removeChild(this.video),this.video=null),this.absoluteTimeOffsetEstimator&&(this.absoluteTimeOffsetEstimator.stopStreamAbsoluteTimeOffsetRetrieval(),this.absoluteTimeOffsetEstimator=null),this.log("dispose done"),this.eventsHandler=null}updatePlaybackDiagnostics(){this.updateTotalPlayingTimeStatistic(),this.updateBufferingRateStatistic(),this.updateVideoTrackHistoryStatistic()}handlePlaybackStopped(){this.isBuffering=!1,this.isPlaying=!1,this.currentVideoPlaybackBitrate=null}showCaptions(e){this.log(`showCaptions: ${e}`),this.captionsControl.showCaptions(e)}addCues(e){e=e.filter((e=>e.text&&0!==e.text.trim().length)),this.captionsControl.addCues(e)}clearCues(){this.captionsControl.clearCues()}captionsToggled(e,t,i){this.log(`captionsToggled: ${e} for culture ${t} at ${i}`),this.eventsHandler.message("captionsToggled").send(e,t,i)}createVideoElement(){this.log("createVideoElement started"),this.video=this.container.ownerDocument.createElement("video"),this.video.id="amp-player",this.video.setAttribute("playsinline","");const e=this.configProvider.playerConfig.lang;e&&(this.video.setAttribute("lang",e),this.log(`createVideoElement: language set to ${e}`));const t=this.configProvider.playerConfig.styles;for(let e=0;e<t.length;e++)this.video.classList.add(t[e]);this.container.appendChild(this.video),this.log("createVideoElement done")}getAmpOptions(){const e=[];this.configProvider.config.debug?e.push({target:"memory",maxMemoryTraceCount:this.maxMemoryTraceLogCount}):e.push({target:"console"});const t={TraceTargets:e,maxLogLevel:this.configProvider.config.debug?3:2},i={techOrder:["azureHtml5JS","html5"],nativeControlsForTouch:!1,autoplay:!0,preload:"auto",controls:!this.isControlsDisabled(),logo:{enabled:!1},height:"100%",width:"100%",traceConfig:t,disableFullscreenButton:this.configProvider.playerConfig?.disableFullscreenButton,staleDataTimeLimitInSec:30,heuristicProfile:this.contextWindow.amp.Player.HeuristicProfile.HighQuality,customPlayerSettings:{customHeuristicSettings:{bandwidthTestWithTimeThresholdDuringLive:!1,windowSizeHeuristics:this.configProvider.config.ampSettings.useBrowserWindowSizeForBitRate,useBrowserWindowForWindowSizeRule:this.configProvider.config.ampSettings.useBrowserWindowSizeForBitRate,useVariableFragmentSizeMode:!0}},plugins:{}};return this.initializePluginOptions(i),i}isStreamValid(e){return e&&!!e.url&&!!e.decryptionToken}initializePluginOptions(e){if(!this.sdnPluginLoaded||!this.liveStreamOptions.sdn)return;const t=this.isStreamValid(this.liveStreamOptions.stream)?this.liveStreamOptions.stream:this.liveStreamOptions.altStream;this.log(`initializePluginOptions, receivedSDNContext: ${JSON.stringify(t?.sdnContext)}`,"info");try{switch(this.liveStreamOptions.sdn.name){case"hive":if(e.plugins={hive:{debugLevel:this.configProvider.config.debug?"debug":"notice",telemetryId:this.playerId}},t&&t.sdnContext)try{const i=JSON.parse(t.sdnContext);if(i.sdnConfig){const t=JSON.parse(i.sdnConfig);t.candidateTopicName="RequestIceCandidates",delete t.RTCIceCandidates,Object.assign(e.plugins.hive,t)}}catch(e){this.log(`initializePluginOptions, failed to parse Hive sdnConfig Json from sdnContext Json, error: ${e}`,"warn")}break;case"kollective":if(t&&t.sdnContext){let i=null,n=null,r=null;try{i=this.parseJson(t.sdnContext,"kollective sdn context")}catch(e){this.log(`initializePluginOptions, failed to parse Kollective sdnContext Json, error: ${e}`,"error")}if(i){try{n=this.parseJson(i.playbackinfo,"kollective sdn playback info")}catch(e){this.log(`initializePluginOptions, failed to parse Kollective sdnContext playbackinfo Json, error: ${e}`,"error")}try{r=this.parseJson(i.sdnConfig,"kollective sdn config")}catch(e){this.log(`initializePluginOptions, failed to parse Kollective sdnContext sdnConfig Json, error: ${e}`,"error")}}e.plugins={kollectiveSDN:{playbackInfo:n,sdnConfig:r,reportSessionId:this.playerId}}}break;case"ramp":t&&t.sdnContext&&(e.plugins={RampMOPlugin:this.parseJson(t.sdnContext,"ramp sdn context")},this.configProvider.config.debug&&(e.plugins.RampMOPlugin.verbose=!0));break;case"peer5":t.sdnContext&&(e.plugins={peer5:this.parseJson(t.sdnContext,"peer5 sdn context")})}}catch(e){this.log(`initializePluginOptions failed, error: ${e.message}`,"error")}this.log(`initializePluginOptions, configured plugin options: ${JSON.stringify(e.plugins)}`,"info")}getTextTracks(){const e=[];if(this.isControlsDisabled())e.push({id:"amp-player_default",kind:"captions",label:"default-text-track",src:"",srclang:"en"});else if(this.liveStreamOptions.supportedSubtitleLanguages){const t=this.liveStreamOptions.supportedSubtitleLanguages;for(let i=0;i<t.length;i++)e.push({id:`amp-player_${t[i].culture}`,kind:this.configProvider.config.textTrackKind,label:t[i].name||t[i].culture,src:"",srclang:t[i].culture.substr(0,2)})}return e}configureSdnSource(e,t){if(this.sdnPluginLoaded&&this.liveStreamOptions.sdn){switch(this.liveStreamOptions.sdn.name){case"hive":if(!t.sdnContext){e.sdnList=[];break}try{const i=JSON.parse(t.sdnContext);i.playbackinfo&&(e.sdnList=[{sdnName:"hive",sdnUrl:i.playbackinfo}])}catch(i){e.sdnList=[{sdnName:"hive",sdnUrl:t.sdnContext}]}break;case"kollective":if(!t.sdnContext){e.sdnList=[];break}try{const i=this.parseJson(t.sdnContext,"kollective sdn list context"),n=this.parseJson(i.playbackinfo,"kollective sdn list playback info"),r=this.parseJson(i.sdnConfig,"kollective sdn list sdn config");e.sdnList=[{sdnName:"kollectiveSDN",playbackInfo:n,sdnConfig:r}]}catch(t){return e.sdnList=[],void this.log(`configureSdnSource failed, error: ${t}`,"error")}break;case"ramp":case"peer5":e.sdnList=[];break;default:return}this.log(`configureSdnSource, configured source context: ${JSON.stringify(e)}`,"info")}}registerPlayerEvents(){this.registerPlayerEvent(this.contextWindow.amp.eventName.error,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.error)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.canplaythrough,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.canplaythrough)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.play,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.play)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.playing,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.playing)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.pause,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.pause)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.resume,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.resume)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.start,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.start)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.ended,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.ended)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.seeking,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.seeking)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.seeked,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.seeked)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.loadedmetadata,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.loadedmetadata)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.waiting,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.waiting)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.playbackbitratechanged,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.playbackbitratechanged)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.downloadbitratechanged,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.downloadbitratechanged)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.fullscreenchange,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.fullscreenchange)})),this.registerPlayerEvent("potentialMediaFreeze",(()=>{this.onAmpEvent("potentialMediaFreeze")})),this.registerPlayerEvent(this.contextWindow.amp.eventName.mute,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.mute)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.unmute,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.unmute)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.volumechange,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.volumechange)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.loadeddata,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.loadeddata)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.loadstart,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.loadstart)})),Object.values(i).forEach((e=>{this.registerVideoEvent(e,(t=>{this.handleUserExperienceErrorEvent(e,t.detail.data.details,t.detail.data.fatal)}))})),this.configProvider.config.ampSettings.collectUserInitiatedSeekEventsTelemetry&&(this.playerEvents.push("currentTimeChanging"),this.playerInstance.addEventListener("currentTimeChanging",((e,t)=>this.onAmpCurrentTimeChangingEvent(e,t))))}onAmpCurrentTimeChangingEvent(e,t){if("currentTimeChanging"!==e.type||!t.time)return;const i={newCurrentPlayPosition:t.time};this.eventsHandler.message("stateChanged").send("UserInitiatedSeek",i)}registerPlayerEvent(e,t){this.playerEvents.push(e),this.playerInstance.addEventListener(e,t)}registerVideoEvent(e,t){this.videoElementEvents.push({name:e,callback:t}),this.video.addEventListener(e,t)}removePlayerEventListeners(){this.playerEvents.forEach((e=>{this.playerInstance.removeEventListener(e)}))}removeVideoEventListeners(){this.videoElementEvents.forEach((e=>{this.video.removeEventListener(e.name,e.callback)}))}onAmpEvent(e){let t,i;switch(e){case this.contextWindow.amp.eventName.error:i=this.playerInstance.error(),t={currentTime:this.playerInstance.currentTime(),errorCode:i?i.code:0,message:i?i.message:""};break;case this.contextWindow.amp.eventName.canplaythrough:this.initializeStatsColletion();break;case this.contextWindow.amp.eventName.loadedmetadata:this.captionsControl.initialize(),this.absoluteTimeOffsetEstimator&&this.absoluteTimeOffsetEstimator.restartStreamAbsoluteTimeOffsetRetrieval();break;case this.contextWindow.amp.eventName.fullscreenchange:t={isFullscreen:this.playerInstance.isFullscreen()};break;case this.contextWindow.amp.eventName.playbackbitratechanged:t={bitrate:this.playerInstance.currentPlaybackBitrate()};break;case this.contextWindow.amp.eventName.downloadbitratechanged:t={bitrate:this.playerInstance.currentDownloadBitrate()};break;case this.contextWindow.amp.eventName.seeked:t={captionsTimestamp:this.isControlsDisabled()?this.playerInstance.currentMediaTime():this.playerInstance.currentTime()};break;case this.contextWindow.amp.eventName.volumechange:t={value:this.playerInstance.volume()}}this.updatePlaybackDiagnostics(),this.updatePlayerState(e),this.eventsHandler.message("statsUpdated").send(this.getPlayerDiagnostics()),this.eventsHandler.message("stateChanged").send(e,t)}updatePlayerState(e){this.updatePlayingState(e),this.updateBufferingState(e),this.updateCurrentVideoTrackBitrate(e),e!==this.contextWindow.amp.eventName.ended&&e!==this.contextWindow.amp.eventName.error||this.handlePlaybackStopped()}handleUserExperienceErrorEvent(e,t,i){const n={currentTime:this.video?this.video.currentTime:0,message:t,type:e,errorCode:0,fatal:i};this.updatePlaybackDiagnostics(),this.eventsHandler.message("statsUpdated").send(this.getPlayerDiagnostics()),this.eventsHandler.message("stateChanged").send(this.contextWindow.amp.eventName.error,n)}updatePlayingState(e){this.isPlaying?e!==this.contextWindow.amp.eventName.pause&&e!==this.contextWindow.amp.eventName.seeking&&e!==this.contextWindow.amp.eventName.ended&&e!==this.contextWindow.amp.eventName.error&&e!==this.contextWindow.amp.eventName.waiting||(this.isPlaying=!1):e===this.contextWindow.amp.eventName.playing&&(this.isPlaying=!0)}updateBufferingState(e){this.isBuffering?(e===this.contextWindow.amp.eventName.pause&&"html5"===this.playerInstance.currentTechName()?.toLowerCase()||e===this.contextWindow.amp.eventName.seeking||e===this.contextWindow.amp.eventName.ended||e===this.contextWindow.amp.eventName.error||e===this.contextWindow.amp.eventName.playing)&&(this.isBuffering=!1):e===this.contextWindow.amp.eventName.waiting&&(this.isBuffering=!0)}updateCurrentVideoTrackBitrate(e){e===this.contextWindow.amp.eventName.playbackbitratechanged&&this.playerInstance.currentPlaybackBitrate()!==this.currentVideoPlaybackBitrate&&(this.currentVideoPlaybackBitrate=this.playerInstance.currentPlaybackBitrate(),this.updateVideoTrackHistoryStatistic())}initializeStatsColletion(){this.diagnosticProvider.initialize(),this.statsTimer=window.setInterval((()=>{this.eventsHandler&&(this.updatePlaybackDiagnostics(),this.eventsHandler.message("statsUpdated").send(this.getPlayerDiagnostics()))}),this.statsInterval)}stopStatsCollection(){this.updatePlaybackDiagnostics(),this.eventsHandler.message("statsUpdated").send(this.getPlayerDiagnostics()),-1!==this.statsTimer&&window.clearInterval(this.statsTimer),this.statsTimer=-1}updateVideoTrackHistoryStatistic(){const e=new Date;if(this.currentVideoPlaybackBitrate){const t=this.diagnosticProvider.getValue("videoTrackHistory"),i=this.diagnosticProvider.getValue("videoTrackTotalDurations");if(t.length>0&&this.currentVideoPlaybackBitrate===t[t.length-1].trackPlaybackBitrate){if(this.videoTrackHistoryUpdatedTimestamp){this.latestVideoTrackDuration+=(e.getTime()-this.videoTrackHistoryUpdatedTimestamp.getTime())/1e3,t[t.length-1].durationInSeconds=Number(this.latestVideoTrackDuration.toFixed(0));const n=this.videoTrackTotalDurations.find((e=>e.trackPlaybackBitrate===this.currentVideoPlaybackBitrate)),r=i.find((e=>e.trackPlaybackBitrate===this.currentVideoPlaybackBitrate));n&&r&&(n.totalDurationInSeconds+=(e.getTime()-this.videoTrackHistoryUpdatedTimestamp.getTime())/1e3,r.totalDurationInSeconds=Number(n.totalDurationInSeconds.toFixed(0)))}}else{const n=this.playerInstance.videoBufferData();let r=null;if(n&&n.perceivedBandwidth&&(r=n.perceivedBandwidth),t.push({trackPlaybackBitrate:this.currentVideoPlaybackBitrate,trackSwitchTimestamp:e.getTime(),trackSwitchMeasuredBandwidth:this.diagnosticProvider?this.diagnosticProvider.getAverageMeasuredBandwidth():null,trackSwitchMeasuredByteSize:this.diagnosticProvider?this.diagnosticProvider.getAverageMeasuredVideoDownloadSize():null,trackSwitchPerceivedBandwidth:r,durationInSeconds:0}),this.latestVideoTrackDuration=0,t.length>this.configProvider.config.maxVideoTrackHistoryLogCount&&t.splice(0,1),!this.videoTrackTotalDurations.find((e=>e.trackPlaybackBitrate===this.currentVideoPlaybackBitrate))){const e={trackPlaybackBitrate:this.currentVideoPlaybackBitrate,totalDurationInSeconds:0},t={trackPlaybackBitrate:this.currentVideoPlaybackBitrate,totalDurationInSeconds:0};this.videoTrackTotalDurations.push(e),i.push(t)}}}this.videoTrackHistoryUpdatedTimestamp=e}updateTotalPlayingTimeStatistic(){const e=new Date;this.isPlaying&&this.totalPlayingTimeUpdatedTimestamp&&(this.totalPlayingTime+=e.getTime()-this.totalPlayingTimeUpdatedTimestamp.getTime()),this.totalPlayingTimeUpdatedTimestamp=e,this.diagnosticProvider.setValue("totalPlayingTimeInSeconds",Number((this.totalPlayingTime/1e3).toFixed(0)))}updateBufferingRateStatistic(){const e=new Date;this.isBuffering&&this.bufferingRateStatUpdatedTimestamp&&(this.totalBufferingTime+=e.getTime()-this.bufferingRateStatUpdatedTimestamp.getTime()),this.bufferingRateStatUpdatedTimestamp=e;const t=this.totalPlayingTime>0||this.totalBufferingTime>0?this.totalBufferingTime/(this.totalPlayingTime+this.totalBufferingTime):0;this.diagnosticProvider.setValue("bufferingRate",Number(t.toFixed(3)))}getPlayerDiagnostics(){const e=this.diagnosticProvider.getPlayerDiagnosticSnapshot();return e.statsInterval=this.statsInterval,this.configProvider.config.debug&&(e.memoryLog=this.playerInstance.getMemoryLog(!0)),e}log(e,t="info"){const i=`[AmpPlayer${1===this.configProvider.config.loadType?"IFrame":""}]: ${e}`;this.configProvider.config.debug&&console.log(i),this.eventsHandler.message("log").send(t,i)}getElementLoadPromise(e,t){return new Promise(((i,n)=>{e.onload=()=>{i("Element Load success")},e.onerror=()=>{n(`Failed to load script: ${t}`)}}))}loadCss(e,t,i){const n=e.createElement("link"),r=this.getElementLoadPromise(n,t);return n.href=t,n.rel="stylesheet",i&&(n.nonce=i),e.head.appendChild(n),r}parseJson(e,t){try{return JSON.parse(e)}catch(e){throw this.log(`Error parsing JSON for ${t}, error: ${JSON.stringify(e)}`),e}}}}function Pi(){const e=bi();return class{constructor(t,i){this.pipe=t,this.amp=new e(i,this)}processMessage(e){"Command"===e.msgType&&Promise.resolve().then((()=>this.amp[e.cmd].apply(this.amp,e.args))).then((t=>{this.pipe&&this.pipe.sendMsg({msgType:"CommandResult",cmd:e.cmd,result:JSON.stringify(t)})})).catch((t=>{this.pipe&&this.pipe.sendMsg({msgType:"CommandResult",cmd:e.cmd,error:t})}))}message(e){return{send:this.fromMessage(((...t)=>{this.sendMessageImpl(e,t)}))}}ampDisposed(){this.pipe.dispose(),this.pipe=null,this.amp=null}fromMessage(e){return e}sendMessageImpl(e,t){this.pipe.sendMsg({msgType:"PlayerNotification",name:e,args:t})}}}bi();var Ii=Pi();function Ai(){function e(e){let t="unknown";try{t="string"==typeof e?e:"toString"in e&&0!==e.toString().indexOf("[object")?e.toString():JSON.stringify(e)}catch(t){console.error("Failed to stringify error",e)}return t}return class{constructor(){this.processMsg=this.processMsg.bind(this),window.addEventListener("message",this.processMsg)}sendMsg(t){try{let i=t;(function(e){return"CommandResult"===e.msgType})(t)&&t.error instanceof Event&&(console.debug("Stringifying error Event before trying to postMessage:",t),i={msgType:t.msgType,cmd:t.cmd,error:`Event: ${e(t.error)}`}),this.postMessage(i)}catch(i){console.error("Unexpected exception caught from postMessage.\n","message:",t,"\n","exception:",i);const n={msgType:"PlayerNotification",name:"log",args:["error",`Unexpected error with postMessage: ${e(i)}`]};throw this.postMessage(n),i}}registerObserver(e){this.observer=e}dispose(){window.removeEventListener("message",this.processMsg),this.observer=null}processMsg(e){this.observer.processMessage(e.data)}postMessage(e){window.parent.postMessage(e,"*")}}}function Ri(){const e=Mi();return class{constructor(t){this.playlistFileDownloadPromise=Promise.resolve(),this.playlistFileDownloadRetryWaitTime=250,this.playlistFileDownloadMaxRetryCount=20,this.playlistFileDownloadCancellationFlag=!1,this.logFn=(e,i)=>t(`[HlsAbsoluteTimeOffsetEstimator]: ${e}`,i),this.hlsFileParser=new e(t)}get absoluteTimeOffset(){return this.estimatedAbsoluteTimeOffset}setEstimationResultCallback(e){this.onAbsoluteTimeOffsetEstimation=e}restartStreamAbsoluteTimeOffsetRetrieval(){this.stopStreamAbsoluteTimeOffsetRetrieval().then((()=>this.startStreamAbsoluteTimeOffsetRetrieval()))}setManifestFileURL(e){this.cachedManifestUrl=e}startStreamAbsoluteTimeOffsetRetrieval(){this.playlistFileDownloadPromise=this.retryPlaylistFileDownload((()=>this.estimateStreamTimeFromPlaylist(this.currentManifestUrl))).then((()=>{this.logFn(`Succeeded in downloading playlist files to estimate\n                    absolute stream time offset as: ${this.estimatedAbsoluteTimeOffset}`)})).catch((e=>{this.logFn(`Failed to download playlist files to estimate absolute stream time offset: ${e.message}`,"error")}))}stopStreamAbsoluteTimeOffsetRetrieval(){return this.playlistFileDownloadCancellationFlag=!0,this.playlistFileDownloadPromise.then((()=>{this.playlistFileDownloadCancellationFlag=!1,this.currentManifestUrl=this.cachedManifestUrl,this.cachedManifestUrl=null}))}retryPlaylistFileDownload(e,t=0){let i=Promise.resolve();return i=e().then((()=>(this.onAbsoluteTimeOffsetEstimation&&this.onAbsoluteTimeOffsetEstimation({timestamp:Date.now(),retries:t,isSuccess:!0,absoluteTimeOffsetEstimation:this.absoluteTimeOffset}),Promise.resolve()))).catch((i=>(t++,this.logFn(`Error loading playlist file: ${i} -- attempt ${t}`),this.onAbsoluteTimeOffsetEstimation&&this.onAbsoluteTimeOffsetEstimation({timestamp:Date.now(),retries:t,isSuccess:!1,error:i.message}),t===this.playlistFileDownloadMaxRetryCount?Promise.reject(new Error(`${i} after ${t} attempts`)):this.playlistFileDownloadCancellationFlag?Promise.reject(new Error("cancelling playlist file download")):new Promise((i=>setTimeout((()=>i(this.retryPlaylistFileDownload(e,t))),this.playlistFileDownloadRetryWaitTime)))))),i}estimateStreamTimeFromPlaylist(e){return this.hlsFileParser.getStreamRenditionsUrlsFromManifest(e).then((t=>{if(0===t.audioRenditions.length&&0===t.videoRenditions.length)throw new Error(`Unable to retrieve renditions URLs from manifest: ${e}`);return Promise.all([t.videoRenditions.length>0?this.hlsFileParser.getTextFileContent(t.videoRenditions[0]):Promise.resolve(null),t.audioRenditions.length>0?this.hlsFileParser.getTextFileContent(t.audioRenditions[0]):Promise.resolve(null)])})).then((e=>{let t;for(let i=0;i<e.length;i++){const n=e[i];if(n){this.logFn("Using segment duration and sequence number to calculate absolute time offset","debug");const e=this.hlsFileParser.getHlsFieldByName("SequenceNumber",n);if(0==e.length)throw new Error("Unable to retrieve sequence number from playlist file");const i=this.hlsFileParser.getHlsFieldByName("SegmentDuration",n,10);if(0==i.length)throw new Error("Unable to retrieve segment durations from playlist file");const r=i.map(Number);r.sort(((e,t)=>e-t));const s=r[Math.floor(r.length/2)],a=Number(e[0])*Number(s);t=t?Math.max(t,a):a}}this.estimatedAbsoluteTimeOffset=t}))}}}Ai();var wi=Ri();function Mi(){return class{constructor(e){this.fieldNameRegexMap={BaseUrl:/(.*)\/.*/,AudioManifestFile:/#EXT-X-MEDIA:TYPE=AUDIO.*URI=\"(.*)\"/,SequenceNumber:/#EXT-X-MEDIA-SEQUENCE:(\d+)/,SegmentDuration:/#EXTINF:(\d+(\.\d+)?)/},this.logFn=(t,i)=>e(`[HlsFileParser]: ${t}`,i)}getHlsFieldByName(e,t,i=1){const n=[];for(let r=1;r<=i;r++){const i=this.fieldNameRegexMap[e].exec(t);if(!(i&&i.length>0))break;n.push(i[1]),t=t.substring(i.index+i[0].length)}return n}getStreamRenditionsUrlsFromManifest(e){return e?this.getTextFileContent(e).then((t=>{const i={audioRenditions:[],videoRenditions:[]},n=t.split("\n"),r=this.getHlsFieldByName("BaseUrl",e);for(let e=0;e<n.length;e++)if(n[e].includes("#EXT-X-STREAM-INF")){const t=n[e+1];t.includes("http")?i.videoRenditions.push(t):r.length>0&&i.videoRenditions.push(`${r[0]}/${t}`)}else if(n[e].includes("EXT-X-MEDIA:TYPE")){const t=this.getHlsFieldByName("AudioManifestFile",n[e]);if(t.length>0){const e=t[0];e.includes("http")?i.audioRenditions.push(e):r.length>0&&i.audioRenditions.push(`${r[0]}/${e}`)}}return i})).catch((e=>(this.logFn(`Failed to extract stream renditions from manifest, error: ${e.message}`,"error"),{audioRenditions:[],videoRenditions:[]}))):(this.logFn("No manifest URL provided to parse"),Promise.resolve({audioRenditions:[],videoRenditions:[]}))}getTextFileContent(e){return fetch(e).then((t=>{if(!t.ok)throw new Error(`http-error ${t.status} when downloading: ${e}`);return t.text()})).catch((e=>(this.logFn(`Error downloading resource: ${e}`,"error"),Promise.reject(e))))}}}function Oi(){return class{constructor(e,t,i,n,r){this.playerInstance=e,this.contextWindow=t,this.streamingStartedTimestamp=i,this.configProvider=n,this.absoluteTimeOffsetEstimator=r,this.currentDiagnosticSnapshot={playerType:0,currentPlayPosition:null,tech:null,perceivedBandwidth:null,playerHeight:null,playerWidth:null,mediaHeight:null,mediaWidth:null,windowHeight:null,windowWidth:null,videoStream:null,audioStream:null,totalDurationInSeconds:null,avgVideoDownloadLatency:null,avgAudioDownloadLatency:null,avgVideoDownloadBytes:null,avgAudioDownloadBytes:null,avgAudioDownloadBandwidth:null,avgVideoDownloadBandwidth:null,maxVideoDownloadBytes:null,minVideoDownloadBytes:null,videoDownloadSuccessCount:null,audioDownloadSuccessCount:null,videoDownloadFailureCount:null,audioDownloadFailureCount:null,videoBufferLength:null,videoCachedLength:null,audioBufferLength:null,audioCachedLength:null,videoEdgeLatency:null,audioEdgeLatency:null,playbackRate:null,playbackBitrate:null,downloadBitrate:null,audioDownloadBitrate:null,audioPlaybackBitrate:null,isFullscreen:null,streamType:null,playerVersion:null,isP2PSdnUsed:null,sdnName:null,livePosition:null,muted:null,volume:null,errorCode:null,currentMediaTime:null,currentAbsoluteTime:null,absoluteTimeOffsetEstimationResults:null,estimatedAbsoluteTimeOffset:null,videoDownloadFailures:null,audioDownloadFailures:null,heuristicProfile:null,encryption:null,retryFrequency:null,averageDownloadBitrate:null,totalDownloadedBytes:0,streamId:null,streamUrl:null,streamingEventType:null,playerControlsEnabled:null,streamDeliveryPipeline:null,retryCount:0,totalPlayingTimeInSeconds:0,bufferingRate:0,videoTrackHistory:[],videoTrackTotalDurations:[],memoryLog:null,statsInterval:null},this.videoDownloadLatencies=[],this.audioDownloadLatencies=[],this.audioDownloadBytes=[],this.videoDownloadBytes=[],this.audioDownloadBandwidths=[],this.videoDownloadBandwidths=[],this.videoDownloadSuccessCount=0,this.audioDownloadSuccessCount=0,this.videoDownloadFailureCount=0,this.audioDownloadFailureCount=0,this.audioDownloadFailures=[],this.videoDownloadFailures=[],this.totalDownloadedBytes=0,this.slidingWindowLengthForLatency=5,this.slidingWindowLengthForDownloadBytes=30,this.slidingWindowLengthForDownloadBandwidth=10,this.absoluteTimeOffsetEstimationResults=[],this.downloadFailuresLimit=10,this.onAudioDownloadCompleted=this.onAudioDownloadCompleted.bind(this),this.onAudioDownloadError=this.onAudioDownloadError.bind(this),this.onVideoDownloadCompleted=this.onVideoDownloadCompleted.bind(this),this.onVideoDownloadError=this.onVideoDownloadError.bind(this)}initialize(){this.playerVideoBuffer=this.playerInstance.videoBufferData(),this.playerAudioBuffer=this.playerInstance.audioBufferData(),this.registerForPlayerBufferEvents()}setValue(e,t){this.currentDiagnosticSnapshot[e]=t}getValue(e){return this.currentDiagnosticSnapshot[e]}appendAbsoluteTimeOffsetEstimation(e){this.absoluteTimeOffsetEstimationResults.push(e),this.absoluteTimeOffsetEstimationResults.length>this.configProvider.config.ampSettings.maxAbsoluteTimeOffsetEstimationResultsLogCount&&this.absoluteTimeOffsetEstimationResults.splice(0,1)}getPlayerDiagnosticSnapshot(){if(!this.playerInstance)return null;const e=window.screen,t=this.playerInstance.error(),i=e=>{const t=e.slice().sort();return t[Math.floor(t.length/2)]};this.currentDiagnosticSnapshot.errorCode=t&&t.code||0,this.currentDiagnosticSnapshot.currentPlayPosition=this.playerInstance.currentTime(),this.currentDiagnosticSnapshot.currentMediaTime=this.playerInstance.currentMediaTime()??this.playerInstance.currentTime(),this.currentDiagnosticSnapshot.currentAbsoluteTime=this.getCurrentAbsoluteTime(),this.currentDiagnosticSnapshot.absoluteTimeOffsetEstimationResults=this.absoluteTimeOffsetEstimationResults,this.currentDiagnosticSnapshot.estimatedAbsoluteTimeOffset=this.getCurrentAbsoluteTimeOffset(),this.currentDiagnosticSnapshot.playbackBitrate=this.playerInstance.currentPlaybackBitrate(),this.currentDiagnosticSnapshot.downloadBitrate=this.playerInstance.currentDownloadBitrate(),this.currentDiagnosticSnapshot.audioDownloadBitrate=this.lastAudioDownloadBitrate,this.currentDiagnosticSnapshot.perceivedBandwidth=this.playerVideoBuffer?this.playerVideoBuffer.perceivedBandwidth:0,this.currentDiagnosticSnapshot.tech=this.playerInstance.currentTechName(),this.currentDiagnosticSnapshot.playerVersion=this.playerInstance.getAmpVersion(),this.currentDiagnosticSnapshot.isP2PSdnUsed=this.isP2PSdnUsed(),this.currentDiagnosticSnapshot.sdnName=this.sdnName(),this.currentDiagnosticSnapshot.heuristicProfile=this.playerInstance.currentHeuristicProfile(),this.currentDiagnosticSnapshot.encryption=this.playerInstance.currentProtectionInfo()?this.playerInstance.currentProtectionInfo().type:"",this.currentDiagnosticSnapshot.streamType=this.getStreamType(this.currentDiagnosticSnapshot.streamType),this.currentDiagnosticSnapshot.totalDurationInSeconds=this.getTotalDurationInSeconds(),this.currentDiagnosticSnapshot.audioStream=this.getAudioStreamData(),this.currentDiagnosticSnapshot.videoStream=this.getVideoStreamData(),this.currentDiagnosticSnapshot.muted=this.playerInstance.muted(),this.currentDiagnosticSnapshot.volume=this.playerInstance.volume(),this.currentDiagnosticSnapshot.playbackRate=this.playerInstance.playbackRate();const n=this.getPlayerCachedLength(),r=this.getPlayerEdgeLatency();this.currentDiagnosticSnapshot.audioBufferLength=this.playerAudioBuffer?this.playerAudioBuffer.bufferLevel:0,this.currentDiagnosticSnapshot.audioCachedLength=n,this.currentDiagnosticSnapshot.audioEdgeLatency=r,this.currentDiagnosticSnapshot.videoBufferLength=this.playerVideoBuffer?this.playerVideoBuffer.bufferLevel:0,this.currentDiagnosticSnapshot.videoCachedLength=n,this.currentDiagnosticSnapshot.videoEdgeLatency=r,this.currentDiagnosticSnapshot.livePosition=this.getLivePosition(),this.currentDiagnosticSnapshot.mediaHeight=this.playerInstance.videoHeight(),this.currentDiagnosticSnapshot.mediaWidth=this.playerInstance.videoWidth(),this.currentDiagnosticSnapshot.playerHeight=this.playerInstance.height(),this.currentDiagnosticSnapshot.playerWidth=this.playerInstance.width(),this.currentDiagnosticSnapshot.windowHeight=e?e.height:0,this.currentDiagnosticSnapshot.windowWidth=e?e.width:0,this.currentDiagnosticSnapshot.isFullscreen=this.playerInstance.isFullscreen(),this.currentDiagnosticSnapshot.avgAudioDownloadLatency=i(this.audioDownloadLatencies),this.currentDiagnosticSnapshot.avgVideoDownloadLatency=i(this.videoDownloadLatencies),this.currentDiagnosticSnapshot.avgAudioDownloadBytes=i(this.audioDownloadBytes),this.currentDiagnosticSnapshot.avgVideoDownloadBytes=i(this.videoDownloadBytes),this.currentDiagnosticSnapshot.maxVideoDownloadBytes=Math.max.apply(null,this.videoDownloadBytes),this.currentDiagnosticSnapshot.minVideoDownloadBytes=Math.min.apply(null,this.videoDownloadBytes),this.currentDiagnosticSnapshot.avgAudioDownloadBandwidth=i(this.audioDownloadBandwidths),this.currentDiagnosticSnapshot.avgVideoDownloadBandwidth=i(this.videoDownloadBandwidths),this.currentDiagnosticSnapshot.audioDownloadFailureCount=this.audioDownloadFailureCount,this.currentDiagnosticSnapshot.audioDownloadSuccessCount=this.audioDownloadSuccessCount,this.currentDiagnosticSnapshot.videoDownloadFailureCount=this.videoDownloadFailureCount,this.currentDiagnosticSnapshot.videoDownloadSuccessCount=this.videoDownloadSuccessCount,this.currentDiagnosticSnapshot.audioDownloadFailures=this.audioDownloadFailures,this.currentDiagnosticSnapshot.videoDownloadFailures=this.videoDownloadFailures,this.currentDiagnosticSnapshot.totalDownloadedBytes=this.totalDownloadedBytes,this.currentDiagnosticSnapshot.retryFrequency=this.getRetryFrequency(),this.currentDiagnosticSnapshot.averageDownloadBitrate=this.getAverageDownloadBitrate();const s=this.getDiagnosticWritableField();return Object.keys(s).forEach((e=>{this.currentDiagnosticSnapshot[e]=s[e]})),this.currentDiagnosticSnapshot}getDiagnosticWritableField(){return{streamUrl:this.currentDiagnosticSnapshot.streamUrl,streamId:this.currentDiagnosticSnapshot.streamId,streamingEventType:this.currentDiagnosticSnapshot.streamingEventType,playerControlsEnabled:this.currentDiagnosticSnapshot.playerControlsEnabled,streamDeliveryPipeline:this.currentDiagnosticSnapshot.streamDeliveryPipeline,retryCount:this.currentDiagnosticSnapshot.retryCount,totalPlayingTimeInSeconds:this.currentDiagnosticSnapshot.totalPlayingTimeInSeconds,bufferingRate:this.currentDiagnosticSnapshot.bufferingRate,videoTrackHistory:this.currentDiagnosticSnapshot.videoTrackHistory,videoTrackTotalDurations:this.currentDiagnosticSnapshot.videoTrackTotalDurations}}dispose(){this.unsubscribeFromPlayerBufferEvents()}registerForPlayerBufferEvents(){this.playerVideoBuffer&&(this.playerVideoBuffer.addEventListener(this.contextWindow.amp.bufferDataEventName.downloadcompleted,this.onVideoDownloadCompleted),this.playerVideoBuffer.addEventListener(this.contextWindow.amp.bufferDataEventName.downloadfailed,this.onVideoDownloadError)),this.playerAudioBuffer&&(this.playerAudioBuffer.addEventListener(this.contextWindow.amp.bufferDataEventName.downloadcompleted,this.onAudioDownloadCompleted),this.playerAudioBuffer.addEventListener(this.contextWindow.amp.bufferDataEventName.downloadfailed,this.onAudioDownloadError))}unsubscribeFromPlayerBufferEvents(){this.playerVideoBuffer&&(this.playerVideoBuffer.removeEventListener(this.contextWindow.amp.bufferDataEventName.downloadcompleted,this.onVideoDownloadCompleted),this.playerVideoBuffer.removeEventListener(this.contextWindow.amp.bufferDataEventName.downloadfailed,this.onVideoDownloadError)),this.playerAudioBuffer&&(this.playerAudioBuffer.removeEventListener(this.contextWindow.amp.bufferDataEventName.downloadcompleted,this.onAudioDownloadCompleted),this.playerAudioBuffer.removeEventListener(this.contextWindow.amp.bufferDataEventName.downloadfailed,this.onAudioDownloadError))}isP2PSdnUsed(){return!!this.sdnName()}sdnName(){const e="options_";return this.playerInstance[e]&&this.playerInstance[e].sdn&&this.playerInstance[e].sdn.name}getStreamType(e){let t="";return this.playerInstance&&(t=this.playerInstance.isLive()?"LIVE":"DVR"),""===t||"LIVE"===e&&t!==e?e||"":t}getCurrentAbsoluteTime(){return this.absoluteTimeOffsetEstimator?this.absoluteTimeOffsetEstimator.absoluteTimeOffset?this.absoluteTimeOffsetEstimator.absoluteTimeOffset+this.playerInstance.currentTime():this.playerInstance.currentTime():this.playerInstance.currentAbsoluteTime()??this.playerInstance.currentTime()}getCurrentAbsoluteTimeOffset(){return this.getCurrentAbsoluteTime()-this.playerInstance.currentTime()}getTotalDurationInSeconds(){const e=((new Date).getTime()-this.streamingStartedTimestamp.getTime())/1e3;return Number(e.toFixed(0))}onVideoDownloadCompleted(){this.videoDownloadSuccessCount++,this.addToList(this.videoDownloadLatencies,this.playerVideoBuffer.downloadCompleted.totalDownloadMs,this.slidingWindowLengthForLatency),this.addToList(this.videoDownloadBytes,this.playerVideoBuffer.downloadCompleted.totalBytes,this.slidingWindowLengthForDownloadBytes),this.addToList(this.videoDownloadBandwidths,8*this.playerVideoBuffer.downloadCompleted.totalBytes*1e3/this.playerVideoBuffer.downloadCompleted.totalDownloadMs,this.slidingWindowLengthForDownloadBandwidth),this.totalDownloadedBytes+=this.playerVideoBuffer.downloadCompleted.totalBytes}onAudioDownloadCompleted(){this.audioDownloadSuccessCount++,this.addToList(this.audioDownloadLatencies,this.playerAudioBuffer.downloadCompleted.totalDownloadMs,this.slidingWindowLengthForLatency),this.addToList(this.audioDownloadBytes,this.playerAudioBuffer.downloadCompleted.totalBytes,this.slidingWindowLengthForDownloadBytes),this.addToList(this.audioDownloadBandwidths,8*this.playerAudioBuffer.downloadCompleted.totalBytes*1e3/this.playerAudioBuffer.downloadCompleted.totalDownloadMs,this.slidingWindowLengthForDownloadBandwidth),this.totalDownloadedBytes+=this.playerAudioBuffer.downloadCompleted.totalBytes;const e=this.playerAudioBuffer.downloadCompleted.mediaDownload.bitrate;e!==this.lastAudioDownloadBitrate&&(this.lastAudioDownloadBitrate=e)}addToList(e,t,i){e.push(t),e.length>i&&e.shift()}onVideoDownloadError(){this.videoDownloadFailureCount++,this.addDownloadFailureInfo(this.playerVideoBuffer.downloadFailed,this.videoDownloadFailures)}onAudioDownloadError(){this.audioDownloadFailureCount++,this.addDownloadFailureInfo(this.playerAudioBuffer.downloadFailed,this.audioDownloadFailures)}addDownloadFailureInfo(e,t){const i={bitrate:e.mediaDownload.bitrate,errorCode:e.code,mediaTime:e.mediaDownload.mediaTime,message:e.message,timestamp:Date.now()};this.addToList(t,i,this.downloadFailuresLimit)}getAudioStreamData(){const e=this.playerInstance.currentAudioStreamList();if(e)try{const t=e.streams[e.enabledIndices[0]];return{bitrate:t.bitrate,codec:t.codec,enabled:t.enabled,name:t.name,language:t.language}}catch(e){return}}getVideoStreamData(){const e=this.playerInstance.currentVideoStreamList();if(e)try{const t=e.streams[e.selectedIndex],i=this.playerInstance.currentPlaybackBitrate(),n=e=>({bitrate:e.bitrate,height:e.height,id:e.id,selectable:e.selectable,width:e.width}),r=t.tracks?t.tracks.map(n).find((e=>e.bitrate===i)):null;return{codec:t.codec,name:t.name,currentTrack:r}}catch(e){return}}getLivePosition(){const e=this.playerInstance.buffered();if(0===e.length)return 0;let t=e.end(0);for(let i=1;i<e.length;i++)t=Math.max(t,e.end(i));return t}getAverageDownloadBitrate(){if(this.streamingStartedTimestamp&&this.totalDownloadedBytes){const e=((new Date).getTime()-this.streamingStartedTimestamp.getTime())/1e3;if(e>0)return 8*this.totalDownloadedBytes/e}return 0}getRetryFrequency(){const e=this.currentDiagnosticSnapshot.retryCount;if(this.streamingStartedTimestamp&&e){const t=((new Date).getTime()-this.streamingStartedTimestamp.getTime())/6e4;if(t>0)return e/t}return 0}getAverageMeasuredBandwidth(){if(0===this.videoDownloadBandwidths.length)return null;let e=0;for(let t=0;t<this.videoDownloadBandwidths.length;t++)e+=this.videoDownloadBandwidths[t];return e/this.videoDownloadBandwidths.length}getAverageMeasuredVideoDownloadSize(){if(0===this.videoDownloadBytes.length)return null;let e=0;for(let t=0;t<this.videoDownloadBytes.length;t++)e+=this.videoDownloadBytes[t];return e/this.videoDownloadBytes.length}getPlayerCachedLength(){const e=this.playerInstance.buffered();let t=0;for(let i=0;i<e.length;i++)t+=e.end(i)-e.start(i);return t}getPlayerEdgeLatency(){const e=this.playerInstance.buffered();if(0===e.length)return 0;let t=e.end(0);for(let i=1;i<e.length;i++)t=Math.max(t,e.end(i));return t-this.playerInstance.currentTime()}}}function Di(){return class{constructor(e,t,i,n){this.player=e,this.toggleListener=t,this.config=i,this.diagnosticProvider=n,this.onTextTrackChanged=this.onTextTrackChanged.bind(this),this.isHtml5Tech="html5"===this.player.currentTechName()?.toLowerCase()}dispose(){this.unsubscribeFromTrackEvents(),this.player=null,this.toggleListener=null}initialize(){const e=this.getPlayerTextTracksAsArray();if(!this.config.controlsEnabled&&e.length>0)e[0].mode="showing";else for(let t=0;t<e.length;t++)e[t].mode="disabled";this.subscribeOnTrackEvents()}addCues(e){const t=this.player.getCurrentTextTrack();if(!t)return;const i=this.getCurrentAbsoluteTime()||1,n=this.getCurrentTime(),r=this.config.controlsEnabled?i-n:Math.max(i-n,0),s=this.isHtml5Tech?window.VTTCue:window.vttjs&&window.vttjs.VTTCue||window.VTTCue;for(let i=0;i<e.length;i++){const{start:n,end:a,text:o}=e[i],l=2,d=new s(Number((n-r).toFixed(l)),Number((a-r).toFixed(l)),o);d.size=100,!this.containsCue(t,d)&&t.addCue(d)}}clearCues(){const e=this.player.getCurrentTextTrack();if(e)try{if(e.activeCues&&e.removeCue)for(;e.activeCues.length>0;)e.removeCue(e.activeCues[0]);const t="setCues_";if(e.cues[t]){e.cues_&&(e.cues_.length=0),e.cues[t]([]);const i=Object.getOwnPropertyNames(e.cues);for(let t=0;t<i.length;t++)"length"!==i[t]&&"length_"!==i[t]&&"cues_"!==i[t]&&delete e.cues[i[t]]}}catch(e){this.config.logFn(`[clearCues]: ${e}`,"warn")}}showCaptions(e){this.config.logFn(`[CaptionsControl]: showCaptions(${e})`),e?this.show():this.hide()}hide(){this.previouslyVisibleTextTrack=this.player.getCurrentTextTrack(),this.previouslyVisibleTextTrack&&(this.previouslyVisibleTextTrack.mode="disabled"),this.player.captionToggle&&this.player.captionToggle.hide&&this.player.captionToggle.hide(),this.player.MoreOptionscaptionSubtitleButton&&this.player.MoreOptionscaptionSubtitleButton.hide&&this.player.MoreOptionscaptionSubtitleButton.hide(),this.player.MoreOptionscaptionSettingsButton&&this.player.MoreOptionscaptionSettingsButton.hide&&this.player.MoreOptionscaptionSettingsButton.hide()}show(){this.previouslyVisibleTextTrack&&(this.previouslyVisibleTextTrack.mode="showing"),this.player.captionToggle&&this.player.captionToggle.show&&this.player.captionToggle.show(),this.player.MoreOptionscaptionSubtitleButton&&this.player.MoreOptionscaptionSubtitleButton.show&&this.player.MoreOptionscaptionSubtitleButton.show(),this.player.MoreOptionscaptionSettingsButton&&this.player.MoreOptionscaptionSettingsButton.show&&this.player.MoreOptionscaptionSettingsButton.show()}subscribeOnTrackEvents(){const e=this.player.textTracks(),t="addEventListener";e&&e[t]&&(this.config.controlsEnabled&&e[t]("change",this.onTextTrackChanged),this.isHtml5Tech&&this.config.removeEmptyDefaultTextTrack&&e[t]("addtrack",this.onAddTrack.bind(this)))}unsubscribeFromTrackEvents(){const e=this.player.textTracks(),t="removeEventListener";e&&e[t]&&(this.config.controlsEnabled&&e[t]("change",this.onTextTrackChanged),this.isHtml5Tech&&this.config.removeEmptyDefaultTextTrack&&e[t]("addtrack",this.onAddTrack.bind(this)))}onTextTrackChanged(){const e=this.player.getCurrentTextTrack();if(!e||!this.currentTextTrack||this.currentTextTrack.label!==e.label||this.currentTextTrack.mode!==e.mode){if(e||this.currentTextTrack){const t=!!e&&"showing"===e.mode,i=this.getCulture(e||this.currentTextTrack),n=this.getCurrentTime();this.toggleListener.captionsToggled(t,i,n),this.config.logFn(`[CaptionsControl]: track changed: culture '${i}', timestamp '${n}'`)}this.currentTextTrack=e}}onAddTrack(e){const t=e?.track;"captions"===t?.kind&&!t.label&&!t.id&&(this.player?.textTracks_?.removeTrack_(t),this.config.logFn("[CaptionsControl]: removing default empty text track"))}getCurrentTime(){return this.isHtml5Tech?this.player.currentTime():(this.config.controlsEnabled?this.player.currentTime():this.player.currentMediaTime())||1}getCurrentAbsoluteTime(){return this.diagnosticProvider.getCurrentAbsoluteTime()}getCulture(e){if(!e)return"";if(e.id){const t=e.id.split("_")[1];if(t)return t}return""}getPlayerTextTracksAsArray(){const e=this.player.textTracks();return e&&e.tracks_||[]}containsCue(e,t){return Array.from(e?.cues||[]).some((e=>this.areCueEquals(e,t)))}areCueEquals(e,t){function i(e){return{start:e.start?e.start:e.startTime,end:e.end?e.end:e.endTime,text:e.text}}const n=i(e),r=i(t);return n.start===r.start&&n.end===r.end&&n.text===r.text}}}function ki(){const e=Ai(),t=Pi(),i=new e,n=new t(i,document.body);i.registerObserver(n)}function Ni(){let e=`(${ki.toString()})();`;return e+=bi.toString()+";",e+=Ai.toString()+";",e+=Pi.toString()+";",e+=Di.toString()+";",e+=Oi.toString()+";",e+=Ri.toString()+";",e+=Mi.toString()+";",e+="//# sourceURL=TsCallingAmpPlayer.js",e}Mi(),Oi(),Di();var Li=class{sendMsg(e){this.peer.onMsg(e)}registerObserver(e){this.observer=e}onMsg(e){this.observer&&this.observer.processMessage(e)}connect(e){this.peer=e}dispose(){this.peer=null,this.observer=null}},xi=class{constructor(e){this.container=e}get contextWindow(){return this.container.ownerDocument.defaultView}sendMsg(e){this.iframe?.contentWindow?.postMessage(e,"*")}registerObserver(e){this.observer=e}dispose(){this.contextWindow&&this.contextWindow.removeEventListener("message",this.processMsg),this.iframe&&this.container.hasChildNodes()&&this.container.removeChild(this.iframe),this.iframe=null}initializeAmpIframe(e){const t=this.initializeIframe();return this.setAmpIframeContent(e),this.finalizeIframe(t)}initializeIframe(){const e=Ei();return this.iframe=this.container.ownerDocument.createElement("iframe"),this.iframe.id="player-iframe",this.iframe.sandbox.add("allow-scripts"),this.iframe.allowFullscreen=!0,this.iframe.allow="camera; microphone; autoplay",this.iframe.style.height="100%",this.iframe.style.width="100%",this.iframe.style.border="none",this.iframe.onload=()=>{e.resolve()},this.iframe.onerror=()=>{e.reject("iframe load failed")},e}finalizeIframe(e){return this.container.appendChild(this.iframe),this.processMsg=this.processMsg.bind(this),this.contextWindow.addEventListener("message",this.processMsg),e.promise}processMsg(e){"null"===e.origin&&e.source===this.iframe.contentWindow&&this.observer&&("RequestIceCandidates"===e.data?this.observer.processMessage({msgType:"Command",cmd:"getIceCandidates",args:[]}):this.observer.processMessage(e.data))}setAmpIframeContent(e){const t=Ni(),i=`\n            <html class style='height: 100%; width: 100%; overflow: hidden'>\n            <head></head>\n            <body class style='height: 100%; width: 100%; margin: 0px'>\n                ${e?`<script nonce='${e}'> ${t}<\/script>`:`<script> ${t}<\/script>`}\n            </body>\n            </html>\n        `;this.iframe.srcdoc=i}},Fi=class extends Ye{constructor(e){super(e),this.logger=e,this.resultsMap=new Map,this.on("log",((e,t)=>{this.logger[e](t)}))}async initialize(e,t,i,n){const r={config:i.config,playerConfig:i.playerConfig},s=i.playerConfig?.nonce||"";this.pipe=await async function(e,t,i){if(0===t){const t=new Li,i=new Li;return t.connect(i),i.connect(t),i.registerObserver(new Ii(i,e)),t}if(1===t){const t=new xi(e);return await t.initializeAmpIframe(i),t}throw new Error(`Unsupported communication type ${t}`)}(e,i.config.loadType,s),this.pipe.registerObserver(this),await this.message("configure").send(t,r,n)}message(e){return{send:this.fromMessage(((...t)=>this.sendMessageImpl(e,...t)))}}dispose(){super.dispose(),this.pipe.sendMsg(this.buildMsg("dispose")),this.pipe.dispose()}processMessage(e){let t;switch(e.msgType){case"CommandResult":t=this.getDeferred(e.cmd.toString()),t&&(e.error?(t.reject(e.error),this.logger.warn(`remote command failed: ${String(e.cmd)}, ${e.error}`)):e.result?t.resolve(e.result):t.resolve(),this.processCommandResult(e),this.resultsMap.delete(e.cmd.toString()));break;case"PlayerNotification":{const t=this.event(e.name);t.raise.apply(t,e.args);break}case"Command":this.processCommand(e).catch((t=>this.logger.warn(`error while processing command: ${JSON.stringify(e)}: ${t}`)));break;default:this.logger.warn(`unexpected message received: ${JSON.stringify(e)}`)}}async processCommand(e){"getIceCandidates"===e.cmd.toString()?await this.message("getIceCandidates").send():this.logger.warn(`unsupported command received: ${JSON.stringify(e)}`)}processCommandResult(e){"getIceCandidates"===e.cmd.toString()?this.pipe.sendMsg({topic:"RequestIceCandidates",candidates:e.result}):this.logger.debug(`ignoring command result for: ${JSON.stringify(e)}`)}fromMessage(e){return e}sendMessageImpl(e,...t){return this.pipe.sendMsg(this.buildMsg(e,t)),this.waitForCompletion(e.toString())}buildMsg(e,t){return{msgType:"Command",cmd:e,args:t}}getDeferred(e){return this.resultsMap.get(e)}waitForCompletion(e){const t=this.getDeferred(e);t&&t.reject(new Error(`function ${e} is invoked again, before previous call is completed`));const i=Ei();return this.resultsMap.set(e,i),i.promise}},Ui=class extends Ye{constructor(e,t){super(),this.player=e,this.logger=t,this.playerSubs=[],this.subscribeForPlayerEvents()}get isRendering(){return!!this.player&&this.player.isRendering()}get streamSize(){return this.player?this.player.getStreamSize():{width:0,height:0}}get rendererType(){return 0}get frameType(){return-1}dispose(){this.stopPlayer(),super.dispose()}captions(){return this.player.getCaptionsControl()}getStats(){throw new Error("Method not implemented.")}setScalingMode(e,t){throw new Error("Method not implemented.")}captureFrame(e,t){throw new Error("Method not implemented.")}stopPlayer(){const e=this.player;this.player=null,e&&(this.logger.info("stopPlayer"),this.unsubscribeFromPlayerEvents(),e.stop())}subscribeForPlayerEvents(){this.playerSubs.push(this.player.on("fullscreenToggled",(e=>this.onFullScreenToggled(e)))),this.playerSubs.push(this.player.on("captionsToggled",((e,t,i)=>this.onCaptionsToggled(e,t,i))))}unsubscribeFromPlayerEvents(){for(const e of this.playerSubs)e.dispose();this.playerSubs=[]}onFullScreenToggled(e){this.event("fullScreenToggled").raise(e)}onCaptionsToggled(e,t,i){this.logger.info(`Turned captions ${e?"ON":"OFF"} for culture [${t}] at player time [${i}]`),this.event("captionsToggled").raise(e,t,i)}},Vi=class{constructor(e,t){this.player=e,this.availableCultures=t,this.selectedCulture="",this.disposable=this.player.on("captionsToggled",((e,t,i)=>{this.selectedCulture=e?t:""}))}async addCues(e){await this.player.message("addCues").send(e)}async clearCues(){await this.player.message("clearCues").send()}async showCaptions(e){await this.player.message("showCaptions").send(e)}getSelectedCulture(){return this.selectedCulture}getAvailableCultures(){return this.availableCultures}dispose(){this.disposable.dispose(),this.player=null}};function Hi(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}var Bi=[2097152,2097552,2097556,2097557,2097564,2097652,2097654,2097655,2097656,2097752,3145728,4194305,4194306,4194307,4194308,4194309,5242880,5242881,5242882,5242884,5242885,5242886],$i=2097753,ji=class extends Ye{constructor(e,t,i){super(),this.logger=e,this.liveStreamStatistic=t,this.configProvider=i,this.playerState="Destroyed",this.retryCount=0,this.captionsTimestamp=0,this.isSwitchStreamingUrlOngoing=!1,this.streamingUrlSwitchCount=0,this.isPlaybackUnsupported=!1,this.id=Hi(),this.logger.info(`AmpLiveStreamPlayer created: ID: ${this.id}`)}get playerId(){return this.id}async configure(e){if(!fi(e.stream)&&!fi(e.altStream))return void this.logger.error("Invalid Live Stream configuration provided: no valid primary or alternative stream");this.logger.info("Live Stream configuration provided"),this.liveStreamOptions=e;const t=fi(e.stream)?e.stream:e.altStream;if(this.playerInstance&&!this.isPlaybackUnsupported){try{await this.playerInstance.message("configure").send(e)}catch(e){const t=Ge(e);this.logger.error(`configure failed: ${t}`)}await this.handleStreamInfoUpdate(t)}else this.selectedStreamDetails=t}async loadPlayer(e){if(this.playerInstance)return this.logger.error("playerLoadFailed: cannot load a player while current one is still active"),{setupSucceeded:!1,playerSetupError:{errorType:"MultiplePlayerLoad",errorMessage:"cannot load a player while current one is still active"}};if(!this.liveStreamOptions||!this.selectedStreamDetails||!fi(this.selectedStreamDetails))return this.logger.error("playerLoadFailed: empty/invalid primary and alternate stream info configured"),{setupSucceeded:!1,playerSetupError:{errorType:"InvalidStream",errorMessage:"empty/invalid primary and alternate stream info configured"}};let t;this.playerInstance=new Fi(this.logger.createChild("AmpPlayerWrapper")),this.playerInstance.on("stateChanged",((e,t)=>this.ampStateChanged(e,t))),this.playerInstance.on("captionsToggled",((e,t,i)=>this.captionsToggled(e,t,i))),this.playerInstance.on("statsUpdated",(e=>this.liveStreamStatistic.registerStatsUpdated(e))),await this.playerInstance.initialize(e,this.liveStreamOptions,this.configProvider,this.id),this.liveStreamStatistic.registerPlayerLoadAttempt(),this.loadSucceeded=!1,this.liveStreamStatistic.registerEventLoadAttempt("LoadScript"),this.srcLoadPromise||(this.srcLoadPromise=this.playerInstance.message("loadPlayerScript").send());try{t=await this.srcLoadPromise}catch(e){const i=Ge(e);return this.logger.error(`playerLoadFailed: player scripts load failed: ${i}`),this.liveStreamStatistic.registerEventLoadFailed("LoadScript",`Load Script failed: ${e}`),this.liveStreamStatistic.registerPlayerLoadFailed(`script load failed: ${t}`),this.srcLoadPromise=null,{setupSucceeded:!1,playerSetupError:{errorType:"PlayerScriptLoadFailed",errorMessage:i}}}this.liveStreamStatistic.registerEventLoadSucceeded("LoadScript"),await this.tryLoadSdnPlugin(),this.liveStreamStatistic.registerEventLoadAttempt("CreateAmp");try{await this.playerInstance.message("createAmp").send()}catch(e){const i=Ge(e);return this.logger.error(`playerLoadFailed: createAmp failed: ${i}`),this.liveStreamStatistic.registerEventLoadFailed("CreateAmp",`createAmp failed: ${e}`),this.liveStreamStatistic.registerPlayerLoadFailed(`create amp failed ${i}, script load: ${t}`),{setupSucceeded:!1,playerSetupError:{errorType:"PlayerInitializationFailed",errorMessage:i}}}this.liveStreamStatistic.registerEventLoadSucceeded("CreateAmp");try{return await this.setPlayerSource(this.selectedStreamDetails),this.loadSucceeded=!0,this.logger.info(`loadPlayer succeeded: ${this.loadSucceeded}`),this.liveStreamStatistic.registerPlayerLoadSucceeded(t),this.playerState="Initialized",{setupSucceeded:this.loadSucceeded}}catch(e){const i=Ge(e);return this.loadSucceeded=!1,this.logger.error(`loadPlayer succeeded: ${this.loadSucceeded}: setSource failed: ${i}`),this.liveStreamStatistic.registerPlayerLoadFailed(`setPlayerSource failed; script load: ${t}`),{setupSucceeded:this.loadSucceeded,playerSetupError:{errorType:"SetSourceFailed",errorMessage:i}}}}getRenderer(){return!this.renderer&&this.playerInstance&&(this.renderer=new Ui(this,this.logger.createChild("LiveStreamRenderer"))),this.renderer}stop(){this.destroy("PlayerStopped")}getPlaybackState(){return this.playerState}getCaptionsTimestamp(){return this.captionsTimestamp}getCaptionsControl(){if(!this.captionsControl&&this.playerInstance){const e=this.liveStreamOptions.supportedSubtitleLanguages?this.liveStreamOptions.supportedSubtitleLanguages.map((e=>e.culture)):[];this.captionsControl=new Vi(this.playerInstance,e)}return this.captionsControl}getStreamSize(){const e=this.liveStreamStatistic.getPlayerDiagnosticSnapshot();return e?{width:e.mediaWidth,height:e.mediaHeight}:{width:0,height:0}}isRendering(){const e=this.getStreamSize();return e.width>0&&e.height>0}ampStateChanged(e,t){switch(e){case"error":return this.handlePlaybackError(t);case"canplaythrough":return this.onCanplaythrough();case"play":return this.onPlay();case"playing":return this.onPlaying();case"pause":return this.onPause();case"resume":return this.onResume();case"start":return this.onStart();case"ended":return this.onEnded();case"seeking":return this.onSeeking();case"seeked":return this.onSeeked(t);case"loadedmetadata":return this.onMetadataLoaded();case"waiting":return this.onWaiting();case"playbackbitratechanged":return this.onPlaybackBitrateChanged(t);case"downloadbitratechanged":return this.onDownloadBitrateChanged(t);case"fullscreenchange":return this.onFullscreenChange(t);case"potentialMediaFreeze":return this.onPotentialMediaFreeze();case"mute":return this.onMute();case"unmute":return this.onUnmute();case"volumechange":return this.onVolumeChange(t);case"loadstart":return this.onLoadStart();case"loadeddata":return this.onLoadedData();case"UserInitiatedSeek":return this.onUserInitiatedSeek(t);default:this.logger.warn(`Unknown amp event ${e}`)}}onUserInitiatedSeek(e){this.liveStreamStatistic.registerUserInitiatedSeek(e)}captionsToggled(e,t,i){this.event("captionsToggled").raise(e,t,i),this.liveStreamStatistic.registerCaptionToggle(e,t,i)}async tryLoadSdnPlugin(){if(this.sdnPluginLoadPromise)return void this.raiseSdnPluginSkippedEvent("SDN plugin already loaded");if(!this.liveStreamOptions.sdn)return void this.raiseSdnPluginSkippedEvent("No SDNs configured in liveStreamOptions");if(!this.configProvider.config.allowSdnPlugins)return void this.raiseSdnPluginSkippedEvent("Client configured to not allow SDN plugins");switch(this.liveStreamOptions.sdn.name){case"hive":case"kollective":case"ramp":case"peer5":break;default:return this.logger.warn(`unsupported SDN provider: ${this.liveStreamOptions.sdn.name}`),void this.liveStreamStatistic.registerSdnPluginLoad(this.liveStreamOptions.sdn.name,!1,`Unsupported SDN provider: ${this.liveStreamOptions.sdn.name}`)}let e;this.liveStreamStatistic.registerEventLoadAttempt("SdnPluginLoad");try{this.sdnPluginLoadPromise=this.playerInstance.message("tryLoadSdnPlugin").send(),await this.sdnPluginLoadPromise}catch(t){e=Ge(t),this.sdnPluginLoadPromise=void 0,this.logger.error(`loadSdnPlugin failed: ${e}`),this.liveStreamStatistic.registerEventLoadFailed("SdnPluginLoad",e),this.event("sdnPluginLoadFailed").raise(e)}this.liveStreamStatistic.registerEventLoadSucceeded("SdnPluginLoad",this.liveStreamOptions.sdn.name)}raiseSdnPluginSkippedEvent(e){this.logger.warn(`skipping SDN plugin load: ${e}`),this.event("sdnPluginLoadSkipped").raise(e)}async setPlayerSource(e){if(!e)throw this.logger.error("setPlayerSource: streamDetails is undefined"),new Error("setPlayerSource: streamDetails is undefined");if(!this.playerInstance)throw this.logger.error("setPlayerSource: playerInstance is null"),new Error("playerInstance is null");this.logger.info(`setPlayerSource: AMP source set to: [${e.url}]`),this.lastKnownPlayTime=this.getCurrentTime()||this.lastKnownPlayTime;try{this.logger.info("setPlayerSource: src changed"),this.selectedStreamDetails=e,this.liveStreamStatistic.registerSetSourceAttempt(e.url),await this.playerInstance.message("setSource").send(e),this.liveStreamStatistic.registerSetSourceSucceeded()}catch(e){const t=Ge(e);throw this.logger.error(`setPlayerSource: failed with error [${t}]`),this.liveStreamStatistic.registerSetSourcedFailed(t),e}}async handleStreamInfoUpdate(e){this.loadSucceeded&&e.url!==this.selectedStreamDetails.url?await this.setPlayerSource(e):this.loadSucceeded&&this.playerInstance&&this.getCurrentTime()>0&&this.setPlaybackState("Start")}async switchStreamingUrl(e,t){if(this.streamingUrlSwitchCount>=this.configProvider.config.ampSettings.streamingUrlSwitchMaxCount||!(0,Ci.includes)(this.configProvider.config.ampSettings.errorCodesEligibleForStreamingUrlSwitch,e)&&!t)return!1;const i=this.selectedStreamDetails.url===this.liveStreamOptions.stream?.url,n=i?this.liveStreamOptions.altStream:this.liveStreamOptions.stream;return fi(n)?(this.isSwitchStreamingUrlOngoing=!0,this.streamingUrlSwitchCount++,this.setPlayerSource(n).then((()=>!0)).catch((()=>!1))):(this.logger.error(`Stream to switch (${i?"alternative":"primary"}) is not valid`),!1)}destroy(e){this.srcLoadPromise=null,this.sdnPluginLoadPromise=null,this.renderer&&(this.renderer.dispose(),this.renderer=null),this.captionsControl&&(this.captionsControl.dispose(),this.captionsControl=null),this.playerInstance&&(this.liveStreamStatistic.registerPlayerDestroyed(e),this.playerInstance.dispose(),this.playerInstance=null,this.setPlaybackState("Destroyed"))}getCurrentTime(){const e=this.liveStreamStatistic.getPlayerDiagnosticSnapshot();return e&&e.currentPlayPosition||0}onCanplaythrough(){this.setPlaybackState("Ready")}onPlay(){(this.retryCount>0||this.lastKnownPlayTime)&&(this.logger.info(`Playing after retry count ${this.retryCount}, Setting current time to ${this.lastKnownPlayTime}`),this.playerInstance.message("setPlayTime").send(this.lastKnownPlayTime),this.retryCount=0,this.lastKnownPlayTime=void 0),this.setPlaybackState("Play")}onPlaying(){this.setPlaybackState("Playing")}onPause(){this.setPlaybackState("Paused")}onResume(){this.setPlaybackState("Resume")}onStart(){this.logger.info(`Playback started, retry count: ${this.retryCount}`),this.setPlaybackState("Start"),this.isSwitchStreamingUrlOngoing&&(this.logger.info(`Playback started, switch count: ${this.streamingUrlSwitchCount}`),this.event("urlSwitched").raise(this.selectedStreamDetails===this.liveStreamOptions.altStream),this.isSwitchStreamingUrlOngoing=!1)}onEnded(){this.setPlaybackState("Ended")}onSeeking(){this.setPlaybackState("Seeking")}onSeeked(e){this.captionsTimestamp=e.captionsTimestamp,this.setPlaybackState("Seeked")}onMetadataLoaded(){this.setPlaybackState("LoadedMetadata")}onWaiting(){this.setPlaybackState("Buffering")}onLoadedData(){this.setPlaybackState("LoadedData")}onLoadStart(){this.setPlaybackState("LoadStart")}setPlaybackState(e){this.playerState=e,this.logger.debug(`playback state changed: ${e}`),this.liveStreamStatistic.registerPlaybackStateChanged(e),this.event("playbackStateChanged").raise()}onPlaybackBitrateChanged(e){this.liveStreamStatistic.registerPlaybackBitratechanged(e.bitrate)}onDownloadBitrateChanged(e){this.liveStreamStatistic.registerDownloadBitratechanged(e.bitrate)}onFullscreenChange(e){this.logger.debug(`fullscreenchange, isFullscreen=${e.isFullscreen}`),this.event("fullscreenToggled").raise(e.isFullscreen),this.liveStreamStatistic.registerFullScreenChange(e.isFullscreen)}onPotentialMediaFreeze(){this.logger.warn("Player detected a potential media freeze"),this.liveStreamStatistic.registerPotentialMediaFreeze()}onMute(){this.liveStreamStatistic.registerMute(!0)}onUnmute(){this.liveStreamStatistic.registerMute(!1)}onVolumeChange(e){this.liveStreamStatistic.registerVolumeChange(e.value)}stringifyPlayerError(e){return JSON.stringify(e,(function(e,t){return"errorCode"===e?t.toString(16):t}))}async handlePlaybackError(e){const t=4194307;this.playerState="Error";const i=this.stringifyPlayerError(e);if(this.logger.info(`Playback error ${i}`),!e.errorCode&&null==e.fatal)return void this.logger.error("onError: error details are not available");if((e.errorCode&t)===t)return this.isPlaybackUnsupported=!0,this.raisePlaybackError("UnsupportedPlatform",i),void this.destroy("PlaybackError");this.lastKnownPlayTime=this.getCurrentTime()||this.lastKnownPlayTime;const n=e.errorCode,r=268435455&n;this.logger.error(`onError: errorCode: 0x${n.toString(16)}, errorCodeExcludingTech: 0x${r.toString(16)}, message: ${e.message}`),this.retryCount<this.configProvider.config.maxRetryCount&&(!1===e.fatal||-1!==(0,Ci.indexOf)(Bi,r))?setTimeout((async()=>{this.logger.info(`Retry loading stream because of error code: 0x${n.toString(16)}`),this.retryCount++,this.raisePlaybackError("PlaybackRetried",i),this.setPlayerSource(this.selectedStreamDetails)}),this.configProvider.config.ampSettings.sourceResetTimeoutInMs):await this.switchStreamingUrl(r,e.fatal)?this.configProvider.config.ampSettings.resetStreamingUrlSwitchCount&&(this.streamingUrlSwitchCount=0):(r===$i||e.message?.includes($i.toString(16))?this.raisePlaybackError("NetworkError",i):this.raisePlaybackError("PlaybackError",i),this.destroy("PlaybackError"))}raisePlaybackError(e,t){this.liveStreamStatistic.registerPlaybackError(e,t),this.event("playbackError").raise(e,t)}},Gi=class extends Ye{constructor(e,t){super(),this.logger=e,this.telemetryLogger=t,this.playbackState="Destroyed",this.playerSubs=[],this.isFinalTelemetrySent=!1,this.captionsTimestamp=0}initialize(e,t,i,n){this.getTelemetryReportFn=e,this.getSnapshotTelemetryReportFn=t,this.disposePlayerFn=i,this.releaseFn=n}startTelemetryGathering(){let e,t;this.statsSub=window.setTimeout((async()=>{clearTimeout(this.statsSub),this.logger.debug(`initial telemetry report after ${this.configProvider.config.sendInitialTelemetryAfterMs} ms`),this.sendTelemetry(!1)}),this.configProvider.config.sendInitialTelemetryAfterMs),1===this.configProvider.playerConfig.playerType?(e=this.configProvider.config.hydraPlayerHlsSettings?.ecsSettings?.sendSnapshotTelemetry||this.configProvider.config.sendSnapshotTelemetry,t=this.configProvider.config.hydraPlayerHlsSettings?.ecsSettings?.sendSnapshotTelemetryEveryMs||this.configProvider.config.sendSnapshotTelemetryEveryMs):(e=this.configProvider.config.hydraPlayerUmsSettings?.ecsSettings?.sendSnapshotTelemetry||this.configProvider.config.sendSnapshotTelemetry,t=this.configProvider.config.hydraPlayerUmsSettings?.ecsSettings?.sendSnapshotTelemetryEveryMs||this.configProvider.config.sendSnapshotTelemetryEveryMs),e&&(this.diagSub=window.setInterval((async()=>{this.sendSnapshotTelemetry()}),t))}stop(){this.clearPlayerEventSubscribers(),this.destroyPlayer()}destroyPlayer(){this.renderer&&(this.renderer.dispose(),this.renderer=null),this.statsSub&&(clearTimeout(this.statsSub),this.statsSub=null),this.diagSub&&(clearInterval(this.diagSub),this.diagSub=null),this.disposePlayerFn(),this.sendFinalTelemetry(),this.releaseFn()}getPlaybackState(){return this.playbackState}getCaptionsTimestamp(){return this.captionsTimestamp}sendFinalTelemetry(){this.isFinalTelemetrySent||(this.isFinalTelemetrySent=!0,this.sendTelemetry(!0))}sendTelemetry(e){if(this.configProvider.config.sendTelemetry&&this.telemetryLogger){const t={...this.getTelemetryReportFn(),isFinal:e,threadId:this.threadId,tsCallingVersion:"2024.13.01.19",correlationId:this.streamOptions.correlationId};this.logger.debug("generated live stream report: ",t),this.telemetryLogger.sendEvent({eventName:"live_events",props:t})}else this.logger.info("telemetry not sent")}sendSnapshotTelemetry(){if(this.telemetryLogger){const e={...this.getSnapshotTelemetryReportFn(),isFinal:!1,threadId:this.threadId,tsCallingVersion:"2024.13.01.19",correlationId:this.streamOptions.correlationId};this.logger.debug("sending snapshot telemetry: ",e),this.telemetryLogger.sendEvent({eventName:"live_events",props:e})}else this.logger.error("snapshot telemetry not sent, telemetryLogger is not set")}clearPlayerEventSubscribers(){for(const e of this.playerSubs)e.dispose();this.playerSubs=[]}onPlaybackSeeked(e){this.captionsTimestamp=e}onUrlSwitched(e){this.event("urlSwitched").raise(e)}onSdnPluginLoadSkipped(e){this.event("sdnPluginLoadSkipped").raise(e)}onSdnPluginLoadFailed(e){this.event("sdnPluginLoadFailed").raise(e)}onPlaybackStarted(){this.event("playbackStarted").raise()}},Wi=T(Q());function qi(e){if(e.playbackCoordinates)return e.playbackCoordinates;if(!e.url&&!e.hlsUrls)return[];const t=[];return(e.hlsUrls?e.hlsUrls:[e.url]).forEach((i=>{t.push({url:i,ecdnProviderData:e.sdnContext})})),t}function zi(e){return e.url?[{url:e.url,ecdnProviderData:e.sdnContext}]:[]}var Ki=class extends Gi{constructor(e,t,i){super(e,i),this.eventHandler=new Ji,this.playerLoaded=!1,this.initialize(this.getTelemetryReport.bind(this),this.getSnapshotTelemetryReport.bind(this),this.disposePlayer.bind(this),this.releasePlayer.bind(this)),this.addPlayerEventSubscribers(),this.configProvider=t;const n=this.createHydraPlayerSettings(t);this.hydraPlayer=new Wi.HlsHydraPlayer(n,this.eventHandler)}async configure(e){if(this.streamOptions=e,this.threadId=e.threadId,this.playerLoaded){const t=this.createHydraStreamOptions(e);await this.hydraPlayer.callPlayerApi("configureHydraPlayer",t)}}async loadPlayer(e){if(!await this.hydraPlayer.setup(e))return{setupSucceeded:!1,playerSetupError:{errorType:"HydraRuntimeLoadFailed",errorMessage:"Failed to create IFrame with Hydra runtime script"}};if(this.streamOptions){const e=this.createHydraStreamOptions(this.streamOptions);await this.hydraPlayer.callPlayerApi("configureHydraPlayer",e)}else this.logger.warn("No stream options configured before Hydra player loaded");const t=await this.hydraPlayer.callPlayerApi("loadHydraPlayer");return t.setupSucceeded&&(this.playerLoaded=!0,this.startTelemetryGathering()),this.getHydraPlayerSetupResult(t)}onCaptionsToggled(e,t,i){this.captionsControl&&this.captionsControl.toggleCaptions(e,t),this.event("captionsToggled").raise(e,t,i)}getTelemetryReport(){return this.hydraPlayer?.getFullTelemetryReport()}getSnapshotTelemetryReport(){return this.hydraPlayer?.getSnapshotTelemetryReport()}getCaptionsControl(){if(!this.captionsControl&&this.hydraPlayer){const e=this.streamOptions?.supportedSubtitleLanguages?this.streamOptions.supportedSubtitleLanguages.map((e=>e.culture)):["en","es"];this.captionsControl=new Yi(this.hydraPlayer,e)}return this.captionsControl}addPlayerEventSubscribers(){this.playerSubs.push(this.eventHandler.on("playbackStateChanged",(e=>{this.onPlaybackStateChanged(e)}))),this.playerSubs.push(this.eventHandler.on("playbackError",((e,t)=>{this.onPlaybackError(e,t)}))),this.playerSubs.push(this.eventHandler.on("playbackSeeked",(e=>{this.onPlaybackSeeked(e)}))),this.playerSubs.push(this.eventHandler.on("urlSwitched",(e=>{this.onUrlSwitched(e)}))),this.playerSubs.push(this.eventHandler.on("sdnPluginLoadSkipped",(e=>{this.onSdnPluginLoadSkipped(e)}))),this.playerSubs.push(this.eventHandler.on("sdnPluginLoadFailed",(e=>{this.onSdnPluginLoadFailed(e)}))),this.playerSubs.push(this.eventHandler.on("playbackStarted",(()=>{this.onPlaybackStarted()}))),this.playerSubs.push(this.eventHandler.on("captionsToggled",((e,t,i)=>{this.onCaptionsToggled(e,t,i)}))),this.playerSubs.push(this.eventHandler.on("statsUpdated",(e=>{this.onStatsUpdated(e)}))),this.playerSubs.push(this.eventHandler.on("log",((e,t)=>{this.onLog(e,t)})))}createHydraPlayerSettings(e){return{hlsJsSources:e.playerConfig?.src,hydraRuntimeFetchTimeout:e.playerConfig?.hydraRuntimeFetchTimeout,capturePlayerLogs:e.config.capturePlayerLogs,allowSdnPlugins:e.config.allowSdnPlugins,debugLogging:e.config.debug??!1,muteVideo:e.playerConfig?.muteVideo??!1,videoLang:e.playerConfig?.lang,videoElementStyles:e.playerConfig?.styles,maxPlayerDiagnosticsCount:e.config.maxPlayerDiagnosticsCount,maxPlayerMemoryTraceLogCount:e.config.maxPlayerMemoryTraceLogCount,maxPlayerPlaybackEventCount:e.config.maxPlayerPlaybackEventCount,maxPlayerExperimentalEvents:e.config.hlsSettings.maxPlayerExperimentalEvents,maxRetryCount:e.config.maxRetryCount,playerTelemetryTickMs:e.config.playerTelemetryTickMs,removeEmptyDefaultTextTrack:e.config.removeEmptyDefaultTextTrack,maxRetryCountForLoadingResources:e.config.maxRetryCountForLoadingResources,maxVideoTrackHistoryLogCount:e.config.maxVideoTrackHistoryLogCount,maxStreamConnectionResultsLogCount:e.config.hlsSettings.maxStreamConnectionResultsLogCount,maxAbsoluteTimeOffsetEstimationResultsLogCount:e.config.hlsSettings.maxAbsoluteTimeOffsetEstimationResultsLogCount,skipNonce:e.config.hlsSettings.skipNonce,configIds:e.configIds,estimateAbsoluteTime:e.config.hlsSettings.estimateAbsoluteTime,playlistInitialSequenceNumber:e.config.hlsSettings.playlistInitialSequenceNumber,timeoutForSwitchingUrl:e.config.hlsSettings.timeoutForSwitchingUrl,hlsConfig:e.config.hlsSettings.hlsConfig,logHlsJsEvents:e.config.hlsSettings.logHlsJsEvents,logHlsJsEventsEveryMs:e.config.hlsSettings.logHlsJsEventsEveryMs,switchingPolicy:e.config.hydraPlayerHlsSettings?.ecsSettings?.switchingPolicy,enableUuidTrace:e.config.hlsSettings.enableUuidTrace,thaScript:e.config.hlsSettings.thaScript,enableOffsetComputeBasedOfStreamTime:e.config.hlsSettings.enableOffsetComputeBasedOfStreamTime,stopCrash:e.config.stopCrash,stopTerminating:e.config.hlsSettings.stopTerminating,stallDetectionPolicy:e.config.hydraPlayerHlsSettings?.ecsSettings?.stallDetectionPolicy,playerRuntimeJsUrls:e.config.hydraPlayerHlsSettings?.runtimeUrls??e.playerConfig.hydraPlayerWebSdkUrls,disableSandbox:e.config.hlsSettings.disableSandbox,ecsSettings:e.config.hydraPlayerHlsSettings?.ecsSettings}}createHydraStreamOptions(e){let t=Wi.HydraStreamingEventType.TLE;return t=e.streamingEventType?this.convertStreamingEventType(e.streamingEventType):e.overflow?Wi.HydraStreamingEventType.Overflow:Wi.HydraStreamingEventType.TLE,{stream:{playbackCoordinates:qi(e.stream),urls:e.stream.hlsUrls?e.stream.hlsUrls:[e.stream.url],keyAuthorizationToken:e.stream.keyAuthorizationToken,keyDeliveryUrl:e.stream.keyDeliveryUrl,sdnContext:e.stream.sdnContext,streamDeliveryPipeline:e.stream.streamDeliveryPipeline?this.convertStreamDeliveryPipeline(e.stream.streamDeliveryPipeline):void 0},altStream:e.altStream?{playbackCoordinates:qi(e.altStream),urls:e.altStream.hlsUrls?e.altStream.hlsUrls:[e.altStream.url],keyAuthorizationToken:e.altStream.keyAuthorizationToken,keyDeliveryUrl:e.altStream.keyDeliveryUrl,sdnContext:e.altStream.sdnContext,streamDeliveryPipeline:e.altStream.streamDeliveryPipeline?this.convertStreamDeliveryPipeline(e.altStream.streamDeliveryPipeline):void 0}:void 0,supportedSubtitleLanguages:e.supportedSubtitleLanguages,streamingEventType:t,allowPlayerControls:e.allowPlayerControls,sdn:e.sdn?{name:e.sdn.name,url:e.sdn.url,plugin:e.sdn.plugin}:void 0,thaContext:e.thaContext?{eventId:e.thaContext.eventId,organizer:{userId:e.thaContext.organizer?.userId,tenantId:e.thaContext.organizer?.tenantId},attendee:{userId:e.thaContext.attendee?.userId,tenantId:e.thaContext.attendee?.tenantId},coOrganizers:e.thaContext.coOrganizers}:void 0,meetingMetadata:e.meetingMetadata}}convertStreamDeliveryPipeline(e){switch(e){case"AMS":return Wi.HydraStreamDeliveryPipeline.AMS;case"MiddleLaneHttpLiveStreaming":return Wi.HydraStreamDeliveryPipeline.HLS;case"MiddleLaneUltraLowLatency":return Wi.HydraStreamDeliveryPipeline.Ums;default:throw new Error(`Unable to convert StreamDeliveryPipeline ${e} to HydraStreamDeliveryPipeline`)}}convertStreamingEventType(e){switch(e){case"TLE":return Wi.HydraStreamingEventType.TLE;case"Overflow":return Wi.HydraStreamingEventType.Overflow;case"TownHall_Basic":return Wi.HydraStreamingEventType.TownHallBasic;case"TownHall_Premium":return Wi.HydraStreamingEventType.TownHallPremium;case"TownHall":return Wi.HydraStreamingEventType.TownHall;default:throw new Error(`Unable to convert StreamingEventType ${e} to HydraStreamingEventType`)}}getHydraPlayerSetupResult(e){return{setupSucceeded:e.setupSucceeded,playerSetupError:e.playerSetupError?{errorType:this.convertHydraPlayerSetupError(e.playerSetupError.errorType),errorMessage:e.playerSetupError.errorMessage}:void 0}}convertHydraPlayerSetupError(e){switch(e){case Wi.HydraPlayerSetupErrorType.InvalidStream:return"InvalidStream";case Wi.HydraPlayerSetupErrorType.MultiplePlayerLoad:return"MultiplePlayerLoad";case Wi.HydraPlayerSetupErrorType.PlayerInitializationFailed:return"PlayerInitializationFailed";case Wi.HydraPlayerSetupErrorType.SetSourceFailed:return"SetSourceFailed";default:return}}getRenderer(){return!this.renderer&&this.hydraPlayer&&(this.renderer=new Ui(this,this.logger.createChild("LiveStreamRenderer"))),this.renderer}onStatsUpdated(e){this.playerStats=e}getStats(){return this.playerStats}onLog(e,t){this.logger[e](t)}onPlaybackStateChanged(e){try{this.playbackState=this.convertHydraPlaybackState(e),this.event("playbackStateChanged").raise()}catch(e){this.logger.warn(`Not handling playback state changed event: ${Ge(e)}`)}}convertHydraPlaybackState(e){switch(e){case Wi.HydraPlayerPlaybackState.LoadStart:return"LoadStart";case Wi.HydraPlayerPlaybackState.LoadedData:return"LoadedData";case Wi.HydraPlayerPlaybackState.LoadedMetadata:return"LoadedMetadata";case Wi.HydraPlayerPlaybackState.Start:return"Start";case Wi.HydraPlayerPlaybackState.CanPlayThrough:return"Ready";case Wi.HydraPlayerPlaybackState.Play:return"Play";case Wi.HydraPlayerPlaybackState.Playing:return"Playing";case Wi.HydraPlayerPlaybackState.Pause:return"Paused";case Wi.HydraPlayerPlaybackState.Waiting:return"Buffering";case Wi.HydraPlayerPlaybackState.Seeking:return"Seeking";case Wi.HydraPlayerPlaybackState.Seeked:return"Seeked";case Wi.HydraPlayerPlaybackState.Ended:return"Ended";case Wi.HydraPlayerPlaybackState.Error:return"Error";case Wi.HydraPlayerPlaybackState.Destroyed:return"Destroyed";case Wi.HydraPlayerPlaybackState.Initialized:return"Initialized";case Wi.HydraPlayerPlaybackState.Stalled:return"Stalled";default:throw new Error(`Unable to convert HydraPlayerPlaybackState ${e} to PlaybackState`)}}onPlaybackError(e,t){try{const i=this.convertHydraPlaybackErrorType(e);this.event("playbackError").raise(i,t)}catch(e){this.logger.warn(`Not handling playback error event: ${Ge(e)}`)}}convertHydraPlaybackErrorType(e){switch(e){case Wi.HydraPlayerPlaybackErrorType.UnsupportedPlatform:return"UnsupportedPlatform";case Wi.HydraPlayerPlaybackErrorType.NetworkError:return"NetworkError";case Wi.HydraPlayerPlaybackErrorType.PlaybackRetried:return"PlaybackRetried";case Wi.HydraPlayerPlaybackErrorType.PlaybackError:return"PlaybackError";case Wi.HydraPlayerPlaybackErrorType.Unknown:return"Unknown";default:throw new Error(`Unable to convert HydraPlayerPlaybackErrorType ${e} to PlaybackErrorType`)}}getStreamSize(){return this.playerStats?{width:this.playerStats.mediaWidth,height:this.playerStats.mediaHeight}:{width:0,height:0}}isRendering(){const e=this.getStreamSize();return e.width>0&&e.height>0}disposePlayer(){this.hydraPlayer?.dispose()}releasePlayer(){this.hydraPlayer&&(this.hydraPlayer.release(),this.hydraPlayer=null),this.captionsControl&&(this.captionsControl.dispose(),this.captionsControl=null)}},Ji=class extends Ye{constructor(){super()}playbackStateChanged(e){this.event("playbackStateChanged").raise(e)}playbackSeeked(e){this.event("playbackSeeked").raise(e)}log(e,t){this.event("log").raise(e,t)}playbackError(e,t){this.event("playbackError").raise(e,t)}captionsToggled(e,t,i){this.event("captionsToggled").raise(e,t,i)}urlSwitched(e){this.event("urlSwitched").raise(e)}sdnPluginLoadSkipped(e){this.event("sdnPluginLoadSkipped").raise(e)}sdnPluginLoadFailed(e){this.event("sdnPluginLoadFailed").raise(e)}statsUpdated(e){this.event("statsUpdated").raise(e)}playbackStarted(){this.event("playbackStarted").raise()}},Yi=class{constructor(e,t){this.hydraPlayer=e,this.availableCultures=t,this.selectedCulture=""}async addCues(e){const t=this.convertCues(e);await this.hydraPlayer.callPlayerApi("addHydraPlayerCues",t)}convertCues(e){const t=[];return e.forEach((e=>{t.push({start:e.start,end:e.end,text:e.text})})),t}async clearCues(){await this.hydraPlayer.callPlayerApi("clearHydraPlayerCues")}async showCaptions(e){await this.hydraPlayer.callPlayerApi("showHydraPlayerCaptions",e)}getSelectedCulture(){return this.selectedCulture}getAvailableCultures(){return this.availableCultures}dispose(){this.hydraPlayer=null}toggleCaptions(e,t){this.selectedCulture=e?t:""}},Qi=T(X()),Xi=class extends Gi{constructor(e,t,i){super(e,i),this.eventHandler=new en,this.playerLoaded=!1,this.initialize(this.getTelemetryReport.bind(this),this.getSnapshotTelemetryReport.bind(this),this.disposePlayer.bind(this),this.releasePlayer.bind(this)),this.addPlayerEventSubscribers(),this.configProvider=t;const n=this.createHydraPlayerSettings(t);this.hydraPlayer=new Qi.UmsHydraPlayer(n,this.eventHandler)}get tracks(){return this.trackInfo}async configure(e){if(this.streamOptions=e,this.threadId=e.threadId,this.playerLoaded){const t=this.createHydraStreamOptions(e);await this.hydraPlayer.callPlayerApi("configureHydraPlayer",t)}}async loadPlayer(e){if(!await this.hydraPlayer.setup(e))return{setupSucceeded:!1,playerSetupError:{errorType:"HydraRuntimeLoadFailed",errorMessage:"Failed to create IFrame with Hydra runtime script"}};if(this.streamOptions){const e=this.createHydraStreamOptions(this.streamOptions);await this.hydraPlayer.callPlayerApi("configureHydraPlayer",e)}else this.logger.warn("No stream options configured before Hydra player loaded");const t=await this.hydraPlayer.callPlayerApi("loadHydraPlayer");return t.setupSucceeded&&(this.playerLoaded=!0,this.startTelemetryGathering()),this.getHydraPlayerSetupResult(t)}getTelemetryReport(){return this.hydraPlayer?.getFullTelemetryReport()}getSnapshotTelemetryReport(){return this.hydraPlayer?.getSnapshotTelemetryReport()}getCaptionsControl(){return!this.captionsControl&&this.hydraPlayer&&(this.captionsControl=new Zi(this.hydraPlayer,this.logger.createChild("CaptionsControl"))),this.captionsControl}addPlayerEventSubscribers(){this.playerSubs.push(this.eventHandler.on("playbackStateChanged",(e=>{this.onPlaybackStateChanged(e)}))),this.playerSubs.push(this.eventHandler.on("playbackError",((e,t)=>{this.onPlaybackError(e,t)}))),this.playerSubs.push(this.eventHandler.on("playbackSeeked",(e=>{this.onPlaybackSeeked(e)}))),this.playerSubs.push(this.eventHandler.on("urlSwitched",(e=>{this.onUrlSwitched(e)}))),this.playerSubs.push(this.eventHandler.on("sdnPluginLoadSkipped",(e=>{this.onSdnPluginLoadSkipped(e)}))),this.playerSubs.push(this.eventHandler.on("sdnPluginLoadFailed",(e=>{this.onSdnPluginLoadFailed(e)}))),this.playerSubs.push(this.eventHandler.on("playbackStarted",(()=>{this.onPlaybackStarted()}))),this.playerSubs.push(this.eventHandler.on("statsUpdated",(e=>{this.onStatsUpdated(e)}))),this.playerSubs.push(this.eventHandler.on("trackListUpdated",(e=>{this.onTrackListUpdated(e)}))),this.playerSubs.push(this.eventHandler.on("trackSelected",(e=>{this.onTrackSelected(e)}))),this.playerSubs.push(this.eventHandler.on("log",((e,t)=>{this.onLog(e,t)})))}onTrackListUpdated(e){this.trackInfo=e;const t=Ge(e);this.logger.info(`[onTrackListUpdated]: Track list updated to: ${t}`)}onTrackSelected(e){const t=Ge(e);this.logger.info(`[onTrackSelected]: Track selected: ${t}`)}createHydraPlayerSettings(e){return{hydraRuntimeFetchTimeout:e.playerConfig?.hydraRuntimeFetchTimeout,allowSdnPlugins:e.config.allowSdnPlugins,debugLogging:e.config.debug??!1,muteVideo:e.playerConfig?.muteVideo??!1,videoLang:e.playerConfig?.lang,videoElementStyles:e.playerConfig?.styles,maxPlayerDiagnosticsCount:e.config.maxPlayerDiagnosticsCount,maxPlayerMemoryTraceLogCount:e.config.maxPlayerMemoryTraceLogCount,maxPlayerPlaybackEventCount:e.config.maxPlayerPlaybackEventCount,maxPlayerExperimentalEvents:e.config.umsSettings.maxPlayerExperimentalEvents,maxRetryCount:e.config.maxRetryCount,playerTelemetryTickMs:e.config.playerTelemetryTickMs,maxRetryCountForLoadingResources:e.config.maxRetryCountForLoadingResources,maxVideoTrackHistoryLogCount:e.config.maxVideoTrackHistoryLogCount,maxStreamConnectionResultsLogCount:e.config.umsSettings.maxStreamConnectionResultsLogCount,configIds:e.configIds,timeoutForSwitchingUrl:e.config.umsSettings.timeoutForSwitchingUrl,minTargetEdgeLatency:e.config.umsSettings.minTargetEdgeLatency,latencyCompensationThreshold:e.config.umsSettings.latencyCompensationThreshold,maxEdgeLatencyHistoryLength:e.config.umsSettings.maxEdgeLatencyHistoryLength,switchingPolicy:e.config.hydraPlayerUmsSettings?.ecsSettings?.switchingPolicy,enableUuidTrace:e.config.umsSettings.enableUuidTrace,thaScript:e.config.umsSettings.thaScript,stopCrash:e.config.stopCrash,stopTerminating:e.config.umsSettings.stopTerminating,stallDetectionPolicy:e.config.hydraPlayerUmsSettings?.ecsSettings?.stallDetectionPolicy,playerRuntimeJsUrls:e.config.hydraPlayerUmsSettings?.runtimeUrls??e.playerConfig.hydraPlayerWebSdkUrls,disableSandbox:e.config.hlsSettings.disableSandbox,ecsSettings:e.config.hydraPlayerUmsSettings?.ecsSettings}}createHydraStreamOptions(e){let t=Qi.HydraStreamingEventType.TLE;return t=e.streamingEventType?this.convertStreamingEventType(e.streamingEventType):e.overflow?Qi.HydraStreamingEventType.Overflow:Qi.HydraStreamingEventType.TLE,{stream:{playbackCoordinates:zi(e.stream),urls:[e.stream.url],decryptionKey:e.stream.decryptionKey,sdnContext:e.stream.sdnContext,streamDeliveryPipeline:e.stream.streamDeliveryPipeline?this.convertStreamDeliveryPipeline(e.stream.streamDeliveryPipeline):void 0},altStream:e.altStream?{urls:[e.altStream.url],playbackCoordinates:zi(e.altStream),decryptionKey:e.altStream.decryptionKey,sdnContext:e.altStream.sdnContext,streamDeliveryPipeline:e.altStream.streamDeliveryPipeline?this.convertStreamDeliveryPipeline(e.altStream.streamDeliveryPipeline):void 0}:void 0,streamingEventType:t,allowPlayerControls:e.allowPlayerControls,sdn:e.sdn?{name:e.sdn.name,url:e.sdn.url,plugin:e.sdn.plugin}:void 0,thaContext:e.thaContext?{eventId:e.thaContext.eventId,organizer:{userId:e.thaContext.organizer?.userId,tenantId:e.thaContext.organizer?.tenantId},attendee:{userId:e.thaContext.attendee?.userId,tenantId:e.thaContext.attendee?.tenantId},coOrganizers:e.thaContext.coOrganizers}:void 0,meetingMetadata:e.meetingMetadata}}convertStreamDeliveryPipeline(e){switch(e){case"AMS":return Qi.HydraStreamDeliveryPipeline.AMS;case"MiddleLaneHttpLiveStreaming":return Qi.HydraStreamDeliveryPipeline.HLS;case"MiddleLaneUltraLowLatency":return Qi.HydraStreamDeliveryPipeline.Ums;default:throw new Error(`Unable to convert StreamDeliveryPipeline ${e} to HydraStreamDeliveryPipeline`)}}convertStreamingEventType(e){switch(e){case"TLE":return Qi.HydraStreamingEventType.TLE;case"Overflow":return Qi.HydraStreamingEventType.Overflow;case"TownHall_Basic":return Qi.HydraStreamingEventType.TownHallBasic;case"TownHall_Premium":return Qi.HydraStreamingEventType.TownHallPremium;case"TownHall":return Qi.HydraStreamingEventType.TownHall;default:throw new Error(`Unable to convert StreamingEventType ${e} to HydraStreamingEventType`)}}getHydraPlayerSetupResult(e){return{setupSucceeded:e.setupSucceeded,playerSetupError:e.playerSetupError?{errorType:this.convertHydraPlayerSetupError(e.playerSetupError.errorType),errorMessage:e.playerSetupError.errorMessage}:void 0}}convertHydraPlayerSetupError(e){switch(e){case Qi.HydraPlayerSetupErrorType.InvalidStream:return"InvalidStream";case Qi.HydraPlayerSetupErrorType.MultiplePlayerLoad:return"MultiplePlayerLoad";case Qi.HydraPlayerSetupErrorType.PlayerInitializationFailed:return"PlayerInitializationFailed";case Qi.HydraPlayerSetupErrorType.SetSourceFailed:return"SetSourceFailed";default:return}}getRenderer(){return!this.renderer&&this.hydraPlayer&&(this.renderer=new Ui(this,this.logger.createChild("LiveStreamRenderer"))),this.renderer}onStatsUpdated(e){this.playerStats=e}getStats(){return this.playerStats}onLog(e,t){this.logger[e](t)}onPlaybackStateChanged(e){try{this.playbackState=this.convertHydraPlaybackState(e),this.event("playbackStateChanged").raise()}catch(e){this.logger.warn(`Not handling playback state changed event: ${Ge(e)}`)}}convertHydraPlaybackState(e){switch(e){case Qi.HydraPlayerPlaybackState.LoadStart:return"LoadStart";case Qi.HydraPlayerPlaybackState.LoadedData:return"LoadedData";case Qi.HydraPlayerPlaybackState.LoadedMetadata:return"LoadedMetadata";case Qi.HydraPlayerPlaybackState.Start:return"Start";case Qi.HydraPlayerPlaybackState.CanPlayThrough:return"Ready";case Qi.HydraPlayerPlaybackState.Play:return"Play";case Qi.HydraPlayerPlaybackState.Playing:return"Playing";case Qi.HydraPlayerPlaybackState.Pause:return"Paused";case Qi.HydraPlayerPlaybackState.Waiting:return"Buffering";case Qi.HydraPlayerPlaybackState.Seeking:return"Seeking";case Qi.HydraPlayerPlaybackState.Seeked:return"Seeked";case Qi.HydraPlayerPlaybackState.Ended:return"Ended";case Qi.HydraPlayerPlaybackState.Error:return"Error";case Qi.HydraPlayerPlaybackState.Destroyed:return"Destroyed";case Qi.HydraPlayerPlaybackState.Initialized:return"Initialized";case Qi.HydraPlayerPlaybackState.Stalled:return"Stalled";default:throw new Error(`Unable to convert HydraPlayerPlaybackState ${e} to PlaybackState`)}}onPlaybackError(e,t){try{const i=this.convertHydraPlaybackErrorType(e);this.event("playbackError").raise(i,t)}catch(e){this.logger.warn(`Not handling playback error event: ${Ge(e)}`)}}convertHydraPlaybackErrorType(e){switch(e){case Qi.HydraPlayerPlaybackErrorType.UnsupportedPlatform:return"UnsupportedPlatform";case Qi.HydraPlayerPlaybackErrorType.NetworkError:return"NetworkError";case Qi.HydraPlayerPlaybackErrorType.PlaybackRetried:return"PlaybackRetried";case Qi.HydraPlayerPlaybackErrorType.PlaybackError:return"PlaybackError";case Qi.HydraPlayerPlaybackErrorType.Unknown:return"Unknown";default:throw new Error(`Unable to convert HydraPlayerPlaybackErrorType ${e} to PlaybackErrorType`)}}getStreamSize(){return this.playerStats?{width:this.playerStats.mediaWidth,height:this.playerStats.mediaHeight}:{width:0,height:0}}isRendering(){const e=this.getStreamSize();return e.width>0&&e.height>0}disposePlayer(){this.hydraPlayer?.dispose()}releasePlayer(){this.hydraPlayer&&(this.hydraPlayer.release(),this.hydraPlayer=null)}},Zi=class{constructor(e,t){this.hydraPlayer=e,this.logger=t}async addCues(e){this.logger.warn("[addCues]: not implemented for UMS player")}async clearCues(){this.logger.warn("[clearCues]: not implemented for UMS player")}async showCaptions(e){await this.hydraPlayer.callPlayerApi("toggleHydraPlayerCaptions",e)}getSelectedCulture(){return this.logger.warn("[getSelectedCulture]: not implemented for UMS player"),""}getAvailableCultures(){return this.logger.warn("[getAvailableCultures]: not implemented for UMS player"),[]}dispose(){this.hydraPlayer=null}async selectTextTrack(e){await this.hydraPlayer.callPlayerApi("selectHydraPlayerTextTrack",e)}},en=class extends Ye{constructor(){super()}playbackStateChanged(e){this.event("playbackStateChanged").raise(e)}playbackSeeked(e){this.event("playbackSeeked").raise(e)}log(e,t){this.event("log").raise(e,t)}playbackError(e,t){this.event("playbackError").raise(e,t)}trackListUpdated(e){this.event("trackListUpdated").raise(e)}trackSelected(e){this.event("trackSelected").raise(e)}urlSwitched(e){this.event("urlSwitched").raise(e)}sdnPluginLoadSkipped(e){this.event("sdnPluginLoadSkipped").raise(e)}sdnPluginLoadFailed(e){this.event("sdnPluginLoadFailed").raise(e)}statsUpdated(e){this.event("statsUpdated").raise(e)}playbackStarted(){this.event("playbackStarted").raise()}},tn=class extends Ye{constructor(e,t,i){super(),this.configProvider=e,this.logger=t,this.getTelemetryLogger=i,this.isAvailable=!0,this._isStreaming=!1,this.playerSubs=[],this.isFinalTelemetrySent=!1,this.telemetryLogger=this.getTelemetryLogger(),1===this.configProvider.playerConfig.playerType?this.player=new Ki(this.logger.createChild("HlsHydraLiveStreamPlayer"),this.configProvider,this.telemetryLogger):2===this.configProvider.playerConfig.playerType?this.player=new Xi(this.logger.createChild("UmsHydraLiveStreamPlayer"),this.configProvider,this.telemetryLogger):(this.initializeAmpTelemetry(),this.player=new ji(this.logger.createChild("AmpLiveStreamPlayer"),this.liveStreamStatistic,this.configProvider)),this.subscribeForPlayerEvents()}get isStreaming(){return this._isStreaming}isActive(){return this.isAvailable&&this.isStreaming}async start(e,t){await this.setOptions(t),this.isFinalTelemetrySent=!1;const i=await this.player.loadPlayer(e);if(!i.setupSucceeded){this.player.stop(),this.logger.error("playerLoadFailed");const e=JSON.stringify(i.playerSetupError);throw this.sendFinalTelemetry(e),new Error(e)}return this._isStreaming=!0,this.liveStreamStatistic&&(this.statsSub=window.setTimeout((()=>{clearTimeout(this.statsSub),this.logger.debug(`initial telemetry report after ${this.configProvider.config.sendInitialTelemetryAfterMs} ms`),this.sendTelemetry(!1)}),this.configProvider.config.sendInitialTelemetryAfterMs),this.configProvider.config.sendSnapshotTelemetry&&(this.diagSub=window.setInterval((()=>{this.sendSnapshotTelemetry()}),this.configProvider.config.sendSnapshotTelemetryEveryMs))),this.player.getRenderer()}initializeAmpTelemetry(){this.liveStreamStatistic=new yi(this.configProvider.config,this.logger.createChild("LiveStreamStatistic"),{perceivedBandwidth:[],videoBufferLength:[],videoCachedLength:[],videoEdgeLatency:[],playerHeight:[],playerWidth:[],mediaHeight:[],mediaWidth:[],windowHeight:[],windowWidth:[],playbackRate:[],currentPlayPosition:[],currentMediaTime:[],statsInterval:[]})}async stop(){}async setOptions(e){return void 0!==e.overflow&&(e.streamingEventType||(e.streamingEventType=e.overflow?"Overflow":"TLE"),delete e.overflow),this.options=e,this.player.configure(e)}getStats(){return this.liveStreamStatistic?this.liveStreamStatistic.getPlayerDiagnosticSnapshot():this.player?.getStats?.()}dispose(){this.unsubscribeFromPlayerEvents(),this.player.stop(),this.statsSub&&(clearTimeout(this.statsSub),this.statsSub=null),this.diagSub&&(clearInterval(this.diagSub),this.diagSub=null),this.logger.debug("stopping live event"),this.sendFinalTelemetry("graceful disposed"),super.dispose()}sendFinalTelemetry(e){this.isFinalTelemetrySent||(this.isFinalTelemetrySent=!0,this.sendTelemetry(!0,e))}sendTelemetry(e,t){if(this.liveStreamStatistic)if(this.configProvider.config.sendTelemetry&&this.telemetryLogger){const i={configIds:this.configProvider.configIds,playerId:this.player.playerId,correlationId:this.options?.correlationId,eTag:this.configProvider.etag,isFinal:e,threadId:this.options?.threadId,disableFullscreenButton:this.configProvider.playerConfig.disableFullscreenButton,callendReason:t},n=this.liveStreamStatistic?.getReport(i);this.logger.debug("generated live stream report",n),this.telemetryLogger.sendEvent({eventName:"live_events",props:n})}else this.logger.info("telemetry not sent");else this.logger.info("telemetry not tracked in ILiveStream object")}sendSnapshotTelemetry(){if(this.liveStreamStatistic)if(this.telemetryLogger){const e=this.liveStreamStatistic.getSnapshotReport({configIds:this.configProvider.configIds,playerId:this.player.playerId,correlationId:this.options?.correlationId,eTag:this.configProvider.etag,isFinal:!1,threadId:this.options?.threadId,disableFullscreenButton:this.configProvider.playerConfig.disableFullscreenButton});this.logger.debug("sending snapshot telemetry: ",e),this.telemetryLogger.sendEvent({eventName:"live_events",props:e})}else this.logger.error("snapshot telemetry not sent, telemetryLogger is not set");else this.logger.info("telemetry not tracked in ILiveStream object")}subscribeForPlayerEvents(){this.playerSubs.push(this.player.on("playbackStateChanged",(()=>{this.onPlaybackStateChanged()}))),this.playerSubs.push(this.player.on("playbackError",((e,t)=>{this.onPlaybackError(e,t)}))),this.playerSubs.push(this.player.on("urlSwitched",(e=>{this.onUrlSwitched(e)}))),this.playerSubs.push(this.player.on("sdnPluginLoadSkipped",(e=>{this.onSdnPluginLoadSkipped(e)}))),this.playerSubs.push(this.player.on("sdnPluginLoadFailed",(e=>{this.onSdnPluginLoadFailed(e)}))),this.playerSubs.push(this.player.on("playbackStarted",(()=>{this.onPlaybackStarted()})))}unsubscribeFromPlayerEvents(){for(const e of this.playerSubs)e.dispose();this.playerSubs=[]}onPlaybackStarted(){this.event("playbackStarted").raise()}onPlaybackStateChanged(){const e=this.player.getPlaybackState();switch(e){case"Start":this.event("playbackStarted").raise();break;case"Ended":this.event("playbackNotLive").raise(),this.sendFinalTelemetry("playback ended");break;case"Seeked":this.event("playbackSeeked").raise(this.player.getCaptionsTimestamp());break;default:this.logger.debug(`playbackStateChanged: ${e}`)}this.event("playbackStateChanged").raise(this.player.getPlaybackState())}onPlaybackError(e,t){this.event("error").raise(e,t)}onUrlSwitched(e){this.event("urlSwitched").raise(e)}onSdnPluginLoadSkipped(e){this.event("sdnPluginLoadSkipped").raise(e)}onSdnPluginLoadFailed(e){this.event("sdnPluginLoadFailed").raise(e)}},nn=class{constructor(e,t,i){this.ecsConfig=e,this.logger=t,this.getTelemetryLogger=i}configure(e){this.configuration=e}async initialize(){const e="MDN_MIDDLELANE_TEAMS",t="liveStream",i=this.ecsConfig.getString(e,t);let n={};try{n=JSON.parse(i)}catch(i){this.logger.warn(`failed to parse ECS configuration for ${e}/${t}`)}const r=this.ecsConfig.getString("ConfigIDs",e);this._configProvider=new ui(n,this.configuration,r,this.logger.createChild("LiveStreamConfigProvider"))}createLiveStream(){return new tn(this._configProvider,this.logger.createChild("LiveStream"),this.getTelemetryLogger)}dispose(){}},rn=class extends Ye{constructor(){super(...arguments),this.isAudioOutputSelectionSupported=!1}createAudioPlayer(){return null}createAudioRenderer(){return null}getRawDeviceMediaStream(e){return null}askDevicePermission(){return Promise.resolve({audio:!1,video:!1})}getPermissionState(e){return"granted"}enumerateDevicesAsync(){return Promise.resolve([])}getPreferredCamera(){return null}selectDevices(){}getSelectedDevices(){return{}}createPreview(){return Promise.resolve(new sn)}createPreviewRenderer(){return Promise.resolve(new sn)}createScreenSharingPreviewRenderer(){return Promise.resolve(new sn)}getDeviceNameAsync(){return Promise.resolve("")}setDeviceEffectsAsync(){return Promise.resolve()}getDeviceEffectsCapabilityAsync(){return Promise.resolve(0)}setBackgroundImageAsync(){return Promise.resolve()}getImagePropertyAsync(){return Promise.resolve({width:0,height:0,uri:" "})}getMicrophoneGeometryArrayInfoAsync(e){return Promise.resolve({})}transformImageAsync(){return Promise.resolve(!1)}sendMessageDeviceVideoEffectsAsync(){return Promise.resolve({code:0})}sendMessageDeviceVideoExtensibilityAsync(){return Promise.resolve({code:0,type:"Error",response:{details:"The API has not been implemented."}})}setVideoCaptureConfigAsync(){return Promise.resolve()}captureVideoFrameWithoutEffectsAsync(){return Promise.resolve(new ImageData(0,0))}setAudioProcessingFlags(e){}getSpeakerVolume(){return Promise.resolve(0)}getSpeakerSystemVolume(){return Promise.resolve(0)}setSpeakerVolume(e){return Promise.resolve()}setSpeakerSystemVolume(e){return Promise.resolve()}unmuteMicrophone(){return Promise.resolve()}unmuteSpeaker(){return Promise.resolve()}getNrgLevelsForDeviceTuner(e){return Promise.resolve(0)}setAudioEffectsAsync(){return Promise.resolve()}getAudioFeatureCapability(e){return Promise.resolve(0)}getMicrophoneVolume(){return Promise.resolve(0)}setMicrophoneVolume(e){return Promise.resolve()}setDeviceTelemetryData(e,t,i,n=0){return Promise.resolve()}getSpeakerDeviceDomIdAsync(e,t){return Promise.reject()}getSourceFormats(e){return Promise.resolve([])}enableShellSharing(){return Promise.resolve()}disableShellSharing(){return Promise.resolve()}enableParticipantCameras(){return Promise.resolve()}registerDerivedSource(e,t){return Promise.resolve()}unregisterDerivedSource(e){return Promise.resolve()}startAudioLoopbackDevice(e){return Promise.resolve()}async dispose(e){return Promise.resolve()}},sn=class extends Ye{constructor(){super(...arguments),this.isRendering=!1,this.streamSize={width:0,height:0},this.rendererType=-1,this.frameType=-1}captureFrame(){return Promise.resolve(new an)}getStats(){return Promise.resolve({framesDropped:0,framesTotal:0})}setScalingMode(){return Promise.resolve()}cameraAutoControl(e){return Promise.resolve(!1)}getCameraManualControlStates(e){return Promise.resolve([])}setCameraManualControlStates(e){return Promise.resolve([])}enumerateCameraManualControls(){return Promise.resolve([])}dispose(){}},an=class extends Ye{getSize(){return{width:0,height:0}}isMirrored(){return!1}},on="skypecosi_concore_web_ts_calling_registry",ln="*11",dn="*12",cn="*13",hn="*14",un={totalParticipants:0,preheatedParticipants:0,lobbyParticipants:0,totalPresenters:0,requestingAttentionPresenters:0,totalAttendees:0,requestingAttentionAttendees:0,overflowAttendees:0},pn=i(174958),gn=class{constructor(e,t,i,n,r){this.eventName=e,this.eventStartTime=t,this.type=i,this.causeId=n,this.status="Pending",this.eventStartTimestamp=(new Date).getTime(),this.data=[],"Event"===this.type&&delete this.status,r&&this.data.push(r)}set variant(e){this.eventVariant=e}recordSuccess(e,t){this.recordResult("Success",e,t)}recordFailure(e,t){this.recordResult("Failure",e,t)}recordTimeout(e,t){this.recordResult("Timeout",e,t)}addData(e){this.data.push(e)}isPending(){return"Pending"===this.status}getEvent(){const e={start:this.eventStartTime,duration:this.duration,status:this.status,result:this.result,causeId:this.causeId,resultCauseId:this.resultCauseId,variant:this.eventVariant,data:this.data.map((e=>this.prepareData(e,!0))).filter((e=>!!e))};return"Event"===this.type&&delete e.status,e.data.length||delete e.data,e.causeId||delete e.causeId,e.resultCauseId||delete e.resultCauseId,e.result||delete e.result,e.variant||delete e.variant,{[this.eventName]:e}}recordResult(e,t,i){this.status=e,this.result=this.prepareData(t),this.causeId!==i&&(this.resultCauseId=i),this.duration=(new Date).getTime()-this.eventStartTimestamp}prepareData(e,t=!1){if(null==e)return"";if("string"==typeof e)return ke(e);if("number"==typeof e||"boolean"==typeof e)return String(e);if("function"==typeof e)return"";if(e instanceof Error)return e.toString();try{return Object.keys(e).length?t?e:Fe(e):""}catch(e){return"invalid"}}},mn=class{constructor(e,t,i,n){this.logger=e,this.startTime=t,this.maxEventsExceeded=i,this.perfModule=n,this.recordedEvents=[],this.ipcStats=[],this.ongoingOperations={}}recordEvent(e,t,i=Re()){this.logger.debug("Event:",e,pn.pii.Omit(t));const n=new gn(e,this.getEventStartTime(),"Event",i,t);return this.pushToRecordedEvents(n),n}recordOperationSuccess(e,t=null,i,n,r){this.logger.info("Event success:",n,e,pn.pii.Omit(i),pn.pii.Omit(t)),this.recordOperationResult(e,t,"Success",i,n,r)}recordOperationFailure(e,t,i,n,r){this.logger.info("Event failure:",e,pn.pii.Omit(i),t),this.recordOperationResult(e,t,"Failure",i,n,r)}recordOperationTimeout(e,t,i,n,r){this.logger.info("Event timeout:",e,pn.pii.Omit(i),t),this.recordOperationResult(e,t,"Timeout",i,n,r)}maybeRecordOperationSuccess(e,t=null,i,n,r){this.hasOngoingEvent(e,i)&&this.recordOperationSuccess(e,t,i,n,r)}maybeRecordOperationFailure(e,t,i,n,r){this.hasOngoingEvent(e,i)&&this.recordOperationFailure(e,t,i,n,r)}maybeRecordOperationTimeout(e,t,i,n,r){this.hasOngoingEvent(e,i)&&this.recordOperationTimeout(e,t,i,n,r)}recordOperationResult(e,t,i,n,r,s){this.hasOngoingEvent(e,n)||this.recordOperation(e,r,n);let a=this.ongoingOperations[e];switch(n&&(a=a[n]),s&&a.addData(s),i){case"Success":a.recordSuccess(t,r);break;case"Failure":a.recordFailure(t,r);break;case"Timeout":a.recordTimeout(t,r);break;default:this.logger.error("Unknown operation record state in record operation result.")}n?delete this.ongoingOperations[e][n]:delete this.ongoingOperations[e]}recordOperation(e,t,i,n){this.logger.debug("Event create:",t,e,pn.pii.Omit(i),n);const r=new gn(e,this.getEventStartTime(),"Operation",t,n);return this.ongoingOperations[e]||(this.ongoingOperations[e]={}),i?this.ongoingOperations[e][i]=r:this.ongoingOperations[e]=r,this.pushToRecordedEvents(r),r}setOperationVariant(e,t,i){let n;n=i?this.ongoingOperations[e][i]:this.ongoingOperations[e],n?n.variant=t:this.logger.error(`Could not find operation ${e} to set variant ${t}`)}updateOperationData(e,t,i,n){try{if(!this.ongoingOperations[e])return void this.recordEvent(e,t,i);n?this.ongoingOperations[e][n]&&this.ongoingOperations[e][n].addData(t):this.ongoingOperations[e].addData(t)}catch(t){return void this.logger.info(`Unable to update operation: ${e} data`)}}pushToRecordedEvents(e){if(this.maxEventsExceeded&&this.maxEventsExceeded()&&this.recordedEvents.shift(),this.recordedEvents.push(e),this.perfModule&&this.ipcStats.length<=30){const e=this.perfModule.getIpcStats();e&&this.ipcStats.push({ingestionTime:this.getEventStartTime(),stats:e})}}hasOngoingEvent(e,t){return this.ongoingOperations[e]?!(t&&!this.ongoingOperations[e][t]&&(this.logger.warn(`Unable to find event for name\\id ${e}\\${pn.pii.Omit(t)}`),1)):(this.logger.warn(`Unable to find event for name ${e}`),!1)}getEventStartTime(){return(new Date).getTime()-this.startTime}getEventTimestampBag(e,t){const i=t?[t.getEvent()]:this.recordedEvents.filter((t=>!e||!t.isPending())).map((e=>e.getEvent())),n=JSON.stringify({eventStart:this.startTime,events:i});return this.logger.info(`Call eventTimestampBag ${pn.pii.Omit(n)}`),n}getIPCStats(){return 0!==this.ipcStats.length?JSON.stringify(this.ipcStats):""}removeRecordedEvent(e){const t=this.recordedEvents.indexOf(e);t>-1&&this.recordedEvents.splice(t,1)}},fn=class extends mn{constructor(e,t){super(e,t,(()=>this.recordedEvents.length>150)),this.getHostName=()=>{try{return"localhost"===location.hostname||"127.0.0.1"===location.hostname?"localhost":"<redacted>"}catch(e){return"unknown"}},this.tsCallingVersion="2024.13.01.19",this.logger=e.createChild("CallRegistryTelemetry")}setClientType(e){this.clientType=e}setEndpointId(e){this.endpointId=e}setSkypeId(e){this.skypeId=ke(e)}setApplicationType(e){this.applicationType=e}setRing(e){this.ring=e}setTenantId(e){this.tenantId=e}setUserHexCID(e){this.userHexCID=e}setAcsResourceId(e){this.acsResourceId=e}setRegion(e){this.region=e}setPartition(e){this.partition=e}getEvent(e,t){const i=e=>void 0===e?"":e;return{EndpointId:i(this.endpointId),SkypeId:i(this.skypeId),ApplicationType:i(this.applicationType),Ring:i(this.ring),TenantId:i(this.tenantId),userHexCID:i(this.userHexCID),AcsResourceId:i(this.acsResourceId),Region:i(this.region),Partition:i(this.partition),TsCallingVersion:i(this.tsCallingVersion),HostName:this.getHostName(),EventTimestampBag:this.getEventTimestampBag(e,t),DiagnosticInfo:this.callEndDiagnosticInfo,ClientType:i(this.clientType)}}removeNonPendingOperations(){this.recordedEvents=this.recordedEvents.filter((e=>e.isPending()))}},Sn=class extends mn{constructor(e,t,i){super(e,t,(()=>this.inCallMode&&this.recordedEvents.length>150),i),this.inCallMode=!1,this.tsCallingVersion="2024.13.01.19",this.logger=e.createChild("CallTelemetry")}setClientType(e){this.clientType=e}setCallId(e){this.currentCallId&&(this.previousCallId=this.currentCallId),this.currentCallId=e}setConsultativeCallId(e){this.consultativeCallId=e}setEndpointId(e){this.endpointId=e}setParticipantId(e){this.participantId=e}setPreheatFlags(e){this.preheatFlags=e}setCallOrigin(e){this.origin=e}setGroupId(e){this.groupId=e}setThreadId(e){this.threadId=e}setBackroomThreadId(e){this.backroomThreadId=e}setComplianceRecordingContentLength(e){this.complianceRecordingContentLength=e}setMesageId(e){this.messageId=e}setSkypeId(e){this.skypeId=ke(e)}setApplicationType(e){this.applicationType=e}setRing(e){this.ring=e}setTenantId(e){this.tenantId=e}setUserHexCID(e){this.userHexCID=e}setAcsResourceId(e){this.acsResourceId=e}setRegion(e){this.region=e}setPartition(e){this.partition=e}setFailureType(e){this.failureType=e}setIsCast(e){this.isCast=e?"True":"False"}setIsHuddleGroupCall(e){this.isHuddleGroupCall=e?"True":"False"}setIsEmergency(e){this.isEmergency=e?"True":"False"}setRole(e){this.isAnonymous="admin"===e?"False":"True"}setCallType(e){this.callType=e}setConversationType(e){this.conversationType=e}setDirection(e){this.direction=e}setSelfParticipantRole(e){this.selfParticipantRole=e}setTerminationState(e){this.terminationState=e}setTerminationReason(e){this.terminationReason=e}setCallEndDiagnosticInfo(e){this.callEndDiagnosticInfo=e}setStackConfig(e){this.stackConfig=e}setJoinedFrom(e){this.joinedFrom=e}setMeetingCode(e){this.meetingCode=e}setMeetingUrl(e){this.meetingUrl=e}setHasMeetingRegistrationId(e){this.hasMeetingRegistrationId=e?"True":"False"}setHasParticipantPin(e){this.hasParticipantPin=e?"True":"False"}getEvent(e,t){const i=e=>void 0===e?"":e;return{CorrelationId:i(this.currentCallId),PreviousCorrelationId:i(this.previousCallId),ConsultativeCallId:i(this.consultativeCallId),EndpointId:i(this.endpointId),SkypeId:i(this.skypeId),ParticipantId:i(this.participantId),PreheatFlags:i(this.preheatFlags),CallType:i(this.callType),ConversationType:i(this.conversationType),Direction:i(this.direction),Origin:i(this.origin),SelfParticipantRole:i(this.selfParticipantRole),IsAnonymous:i(this.isAnonymous),GroupId:ke(i(this.groupId)),ThreadId:Le(i(this.threadId)),MessageId:i(this.messageId),ApplicationType:i(this.applicationType),Ring:i(this.ring),TenantId:i(this.tenantId),userHexCID:i(this.userHexCID),AcsResourceId:i(this.acsResourceId),Region:i(this.region),Partition:i(this.partition),FailureType:i(this.failureType),IsCast:i(this.isCast),IsHuddleGroupCall:i(this.isHuddleGroupCall),IsEmergency:i(this.isEmergency),TsCallingVersion:i(this.tsCallingVersion),TerminationState:i(this.terminationState),TerminationReason:i(this.terminationReason),StackConfig:i(this.stackConfig),EventTimestampBag:this.getEventTimestampBag(e,t),HostName:this.getHostName(),DiagnosticInfo:this.callEndDiagnosticInfo,JoinedFrom:this.joinedFrom,MeetingCode:this.meetingCode,MeetingUrl:this.meetingUrl,HasMeetingRegistrationId:this.hasMeetingRegistrationId,HasParticipantPin:this.hasParticipantPin,IPCStats:this.getIPCStats(),ComplianceRecordingContentLength:i(this.complianceRecordingContentLength),BackroomThreadId:Le(i(this.backroomThreadId)),ClientType:i(this.clientType)}}switchToInCallTelemetry(){this.recordedEvents=this.recordedEvents.filter((e=>e.isPending())),this.inCallMode=!0}getHostName(){try{return location.host}catch(e){return"unknown"}}},vn=e=>Array.isArray(e)?e.map((e=>({endpointId:e.endpointId,participantId:e.participantId}))):null;function yn(e,t,i){if(!e)return i.info(`sanitizeMeetingCode[${t}] empty / undefined meeting code parameter`),e;let n=e.replace(/\s/g,"");return n=n.replace(/-/g,""),i.info(`sanitizeMeetingCode[${t}] meetingCode: ${e}, sanitizedMeetingCode: ${n}`),n}function Cn(e,t,i){if(!e)return i.info(`getMeetingCodeFromMeetingUrl[${t}] empty / undefined meeting Url parameter`),e;const n=new URL(e);let r="";if(n&&n.pathname&&n.pathname.split("/").length>=2){const e=n.pathname.split("/");"meet"===e[e.length-2]&&(r=e[e.length-1])}return i.info(`getMeetingCodeFromMeetingUrl[${t}] meetingUrl: ${e}, meetingUrlObject: ${He(n)}, meetingCode: ${r}`),r}function Tn(e,t,i,n){const r=yn(e&&e.meetingCode||"",i,n),s=yn(t&&t.meetingCode||"",i,n),a=(e,t)=>!!e&&!!t&&e===t;if(a(r,s))return!0;let o=Cn(e&&e.meetingUrl||"",i,n);o=yn(o,i,n);let l=Cn(t&&t.meetingUrl||"",i,n);if(l=yn(l,i,n),a(o,l))return!0;if(a(o,s)||a(l,r))return!0;if(e&&e.meetingUrl&&t&&t.meetingUrl){const i=new URL(e.meetingUrl),n=new URL(t.meetingUrl);if(i.hostname===n.hostname&&i.pathname===n.pathname)return!0}return!1}function En(){}var _n={SUCCESS:0,MEDIA_ERROR:410,CLIENT_ERROR_CODE:499,UNKNOWN_ERROR:497},bn={VDI_DISCONNECTED:3e3,ACTION_NOT_ALLOWED:3548,ABANDONED:4990,ENDED_BY_REMOTE_ENDPOINT:5028,BEACON:4521,UNKNOWN_FAILURE:3545},Pn=4294967294,In="_operationIdValue_",An="_causeIdValue_",Rn="_callStartOptionsValue_",wn="_clientReasonValue_";function Mn(e,t,i=!1){return xn(0,e,t,i)}function On(e,t){return xn(1,e,t)}var Dn=(e,t,i)=>{if(e[t][In])throw new Error("can not specify more than one operation id");e[t][In]=i},kn=(e,t,i)=>{if(e[t][An])throw new Error("can not specify more than one cause id");e[t][An]=i},Nn=(e,t,i)=>{if(e[t][Rn])throw new Error("can not specify options more than once");e[t][Rn]=i},Ln=(e,t,i)=>{if(e[t][wn])throw new Error("can not specify reason more than once");e[t][wn]=i},xn=(e,t,i,n=!1)=>(r,s,a)=>{const o=a.value,l=r[s]?.[In],d=r[s]?.[An],c=r[s]?.[Rn],h=r[s]?.[wn],u=i?.type||"Async";return a.value=function(...r){const s=this;let a=n?Hi():Re();void 0!==d&&(r[d]&&function(e){return new RegExp("^[a-f0-9]{8}$").test(e)&&e.length===Ae}(r[d])?a=r[d]:r[d]=a);let p,g=void 0!==l?r[l]:void 0;if(void 0!==g)if(Array.isArray(g))try{const e=g.map((e=>e.toString())).sort().concat().toString();g=function(e){let t=0;for(let i=0;i<e.length;i++)t=(t<<5)-t+e.charCodeAt(i),t|=0;return t}(e).toString()}catch{const e=`[${g}]${t} failed in array parsing in operationDecorator`,i={terminatedReason:32,terminatedReasonCode:_n.UNKNOWN_ERROR,terminatedReasonSubCode:bn.UNKNOWN_FAILURE,errorMessage:e};return Promise.reject(i)}else if(g&&"object"==typeof g)try{let e=JSON.stringify(g);i&&i.operationIdKey&&g.hasOwnProperty(i.operationIdKey)&&(e=g[i.operationIdKey]),g=e}catch{const e=`[${g}]${t} failed in object parsing in operationDecorator`,i={terminatedReason:32,terminatedReasonCode:_n.UNKNOWN_ERROR,terminatedReasonSubCode:bn.UNKNOWN_FAILURE,errorMessage:e};return Promise.reject(i)}void 0!==h&&r[h]&&(p=r[h]);const m=Fn(s,e);if(m.logOperation(a,t),i&&i.singular&&m.hasPendingOperation(t))return m.logOperation(a,t,"Not allowed, pending operation exists"),Promise.reject(60);if(i&&i.idempotencyLevel&&m.getRecord(t)>0)switch(m.logOperation(a,t,`Called multiple times, handling operation according to specified policy: idempotency=${i.idempotencyLevel}`),i.idempotencyLevel){case"NoOp":return Promise.resolve();case"Error":return Promise.reject(60)}try{void 0!==c&&r[c]&&s.processCallStartOptions(r[c],a)}catch{const e=`${t} failed in processCallStartOptions`,i={terminatedReason:32,terminatedReasonCode:_n.UNKNOWN_ERROR,terminatedReasonSubCode:bn.UNKNOWN_FAILURE,errorMessage:e};return Promise.reject(i)}const f=!(!i||!i.convertError),S=()=>"Chained"===u?m.executeChained(o.bind(this,...r),t,g,a,f,p,i):"Sync"===u?m.executeSync(o.bind(this,...r),t,g,a,f,p):m.execute(o.bind(this,...r),t,g,a,f,p,i);if("StartCall"!==t&&"JoinCall"!==t||m.hasPendingOperation("_CallStartOrJoinInitiated")||m.createPendingOperation("_CallStartOrJoinInitiated").catch(En),i&&i.triggerAttach&&(m.hasPendingOperation("_ElectronSlimcoreReady")||m.createPendingOperation("_ElectronSlimcoreReady").catch(En)),i&&"Sync"!==i.type){const e=i&&i.waitFor;if(Array.isArray(e))return Promise.all(e.map((e=>e&&m.hasPendingOperation(e)&&m.waitForOperation(e,void 0,a)))).then(S,S);if(e&&m.hasPendingOperation(e))return m.waitForOperation(e,void 0,a).then(S,S)}return S()},a},Fn=(e,t)=>{if(0===t)return e._callOperationHandler;if(1===t)return e._participantOperationHandler;throw new Error("Unsupported operation handler type!")},Un=class{constructor(e){this._disposed=!1,this._logger=e.createChild("[ASYNC]"),this._endOperationDeferred=Ei(),this._endOperationDeferred.promise.catch((e=>{this._logger.info("Rejected all operations")})),this._deferredOperations={},this._deferredOperationsWithOperationId={},this._deferredOperationsWithCauseId={},this._logger=e}registerPromise(e,t){let i=!1;const n=()=>{i=!0};t.then(n,n);const r=this._endOperationDeferred.promise.catch((t=>{if(!i)throw new Error(`Operation ${e} did not complete, reason:${t}`)}));return Promise.race([r,t])}updateOperationId(e,t){this._logger.info(`updateOperationId ${e} ${t}`),Object.keys(this._deferredOperationsWithOperationId).forEach((i=>{i&&this._deferredOperationsWithOperationId[i]&&(this._logger.info(`_deferredOperationsWithOperationId ${i}`),Object.keys(this._deferredOperationsWithOperationId[i]).forEach((n=>{n&&this._deferredOperationsWithOperationId[i][n]&&(this._logger.info(`_deferredOperationsWithOperationId ${n} ${t}`),n===e&&(this._deferredOperationsWithOperationId[i][t]=this._deferredOperationsWithOperationId[i][n],delete this._deferredOperationsWithOperationId[i][n]))})))})),Object.keys(this._deferredOperationsWithCauseId).forEach((i=>{i&&this._deferredOperationsWithCauseId[i]&&(this._logger.info(`_deferredOperationsWithCauseId ${i}`),Object.keys(this._deferredOperationsWithCauseId[i]).forEach((n=>{n&&this._deferredOperationsWithCauseId[i][n]&&(this._logger.info(`_deferredOperationsWithCauseId ${n} ${t}`),n===e&&(this._deferredOperationsWithOperationId[i][t]=this._deferredOperationsWithOperationId[i][n],delete this._deferredOperationsWithOperationId[i][n]))})))}))}createPendingOperation(e,t,i=Re(),n={}){const r=Ei();r.promise.catch(En);const s=this.getOperationInfoForLogging(i,e,t);let a;if(this._logger.info(`${s}[creating...]`),this._disposed)return this._logger.info(`${s}[create failed, call is disposed]`),Promise.reject(60);if(t){if(this._deferredOperationsWithOperationId[e]||(this._deferredOperationsWithOperationId[e]={}),this._deferredOperationsWithOperationId[e][t])return this._logger.warn(`${s} Deferred operation with given name and operation id is already defined`),Promise.reject(new Error(`Deferred operation with given name is already defined:${e}/${ke(t)}`));this._deferredOperationsWithOperationId[e][t]={deferred:r,causeId:i},this._deferredOperationsWithCauseId[i]||(this._deferredOperationsWithCauseId[i]={}),this._deferredOperationsWithCauseId[i][t]={deferred:r,options:n,operationName:e},a=this._endOperationDeferred.promise.catch((i=>{if(this.hasPendingOperationWithOperationId(e,t))throw new Error(`Operation ${e} ${t} did not complete, reason:${i}`)}))}else{if(this._deferredOperations[e])return this._logger.warn(`${s} Deferred operation with given name is already defined`),Promise.reject(new Error(`Deferred operation with given name is already defined:${e}`));this._deferredOperationsWithCauseId[i]||(this._deferredOperationsWithCauseId[i]={}),this._deferredOperationsWithCauseId[i][""]={deferred:r,options:n,operationName:e},this._deferredOperations[e]={deferred:r,causeId:i},a=this._endOperationDeferred.promise.catch((t=>{if(this.hasPendingOperation(e))throw new Error(`Operation ${e} did not complete, reason:${t}`)}))}return Promise.race([a,r.promise])}hasPendingOperation(e){return!!this._deferredOperations[e]}hasAtleastOneOfPendingOperation(e){for(const t of e)if(this.hasPendingOperation(t))return!0;return!1}hasPendingOperationWithOperationId(e,t){return!(!t||!this._deferredOperationsWithOperationId[e]||!this._deferredOperationsWithOperationId[e][t])}hasPendingOperationWithCauseId(e,t){const i=t||"";return this._deferredOperationsWithCauseId[e]&&!!this._deferredOperationsWithCauseId[e][i]}getPendingOperationWithCauseId(e,t){return this.hasPendingOperationWithCauseId(e,t)?this._deferredOperationsWithCauseId[e][t].deferred.promise:Promise.reject(`[${e}][${t}]: getPendingOperationWithCauseId for given causeId, operationId`)}resolveOperationWithCauseId(e,t,i){const n=t||"";if(this.hasPendingOperationWithCauseId(e,n)){const t=this._deferredOperationsWithCauseId[e][n],r=t.deferred.promise;return t.deferred.resolve(i),this._logger.info(`[${e}][${n}] resolved, result=${Ve(i)||"void"}`),delete this._deferredOperationsWithCauseId[e][n],r}return Promise.reject(`[${e}][${n}] resolveOperationWithCauseId failed, operation not found`)}rejectOperationWithCauseId(e,t,i){const n=t||"";if(this.hasPendingOperationWithCauseId(e,n)){const t=this._deferredOperationsWithCauseId[e][n],r=t.deferred.promise;return r.catch(En),t.deferred.reject(i),this._logger.info(`[${e}][${n}] rejected, result=${Ve(i)||"void"}`),delete this._deferredOperationsWithCauseId[e][n],r}return Promise.reject(`[${e}][${n}] rejectOperationWithCauseId failed, operation not found`)}maybeResolveOperationWithCauseId(e,t,i){this.hasPendingOperationWithCauseId(e,t)?this.resolveOperationWithCauseId(e,t,i).catch((t=>{this._logger.info(`${e}maybeResolveOperationWithCauseId failed, reason=${Ve(t)}`)})):this._logger.info(`${e}maybeResolveOperationWithCauseId ignored, operation does not exist`)}maybeRejectOperationWithCauseId(e,t,i){this.hasPendingOperationWithCauseId(e,t)?this.rejectOperationWithCauseId(e,t,i).catch(En):this._logger.info(`${e}maybeRejectOperationWithCauseId ignored, operation does not exist`)}getPendingOperation(e,t,i=Re()){return!t&&this._deferredOperations[e]?this._deferredOperations[e].deferred.promise:t&&this._deferredOperationsWithOperationId[e]&&this._deferredOperationsWithOperationId[e][t]?this._deferredOperationsWithOperationId[e][t].deferred.promise:Promise.reject(`${this.getOperationInfoForLogging(i,e,t)}: Deferred operation with given name and operation does not exist`)}waitForOperation(e,t,i=Re()){return t&&this.hasPendingOperationWithOperationId(e,t)?this._deferredOperationsWithOperationId[e][t].deferred.promise:this.hasPendingOperation(e)?this._deferredOperations[e].deferred.promise:Promise.reject(`${this.getOperationInfoForLogging(i,e,t)}failed=wait failed, operation not found`)}resolveOperation(e,t,i,n=Re(),r=!1){if(!e)return Promise.reject("Unable to resolve deferred operation with empty name");if(i&&this.hasPendingOperationWithOperationId(e,i)){const n=this._deferredOperationsWithOperationId[e][i],s=n.deferred.promise;return n.deferred.resolve(t),this._logger.info(`${this.getOperationInfoForLogging(n.causeId,e,i)}resolved, result=${Ve(t)||"void"}`),r||delete this._deferredOperationsWithOperationId[e][i],s}if(this.hasPendingOperation(e)){const n=this._deferredOperations[e],s=this._deferredOperations[e].deferred.promise;return this._deferredOperations[e].deferred.resolve(t),this._logger.info(`${this.getOperationInfoForLogging(n.causeId,e,i)}resolved, result=${Ve(t)||"void"}`),r||delete this._deferredOperations[e],s}return Promise.reject(`${this.getOperationInfoForLogging(n,e,i)}failed=resolve failed, operation not found`)}rejectOperation(e,t,i,n=Re()){if(!e)return Promise.reject("Unable to reject deferred operation with empty name");if(i&&this.hasPendingOperationWithOperationId(e,i)){const n=this._deferredOperationsWithOperationId[e][i],r=n.deferred.promise;return r.catch(En),n.deferred.reject(t),this._logger.info(`${this.getOperationInfoForLogging(n.causeId,e,i)}rejected, reason=${Ve(t)||"void"}`),delete this._deferredOperationsWithOperationId[e][i],r}if(this.hasPendingOperation(e)){const n=this._deferredOperations[e],r=n.deferred.promise;return r.catch(En),n.deferred.reject(t),this._logger.info(`${this.getOperationInfoForLogging(n.causeId,e,i)}rejected, reason=${Ve(t)||"void"}`),delete this._deferredOperations[e],r}return Promise.reject(`${this.getOperationInfoForLogging(n,e,i)}failed=reject failed, operation not found`)}maybeResolveOperation(e,t,i,n=Re()){const r=this.getOperationInfoForLogging(n,e,i);i&&this.hasPendingOperationWithOperationId(e,i)||this.hasPendingOperation(e)?this.resolveOperation(e,t,i,n).catch((e=>{this._logger.info(`${r}maybeResolveOperation failed, reason=${Ve(e)}`)})):this._logger.info(`${r}maybeResolveOperation ignored, operation does not exist`)}maybeResolveOperations(e,t,i,n=Re()){for(const r of e)this.maybeResolveOperation(r,t,i,n)}maybeRejectOperation(e,t,i,n=Re()){const r=this.getOperationInfoForLogging(n,e,i);i&&this.hasPendingOperationWithOperationId(e,i)||this.hasPendingOperation(e)?this.rejectOperation(e,t,i,n).catch(En):this._logger.info(`${r}maybeRejectOperation ignored, operation does not exist`)}maybeRejectOperations(e,t,i,n=Re()){for(const r of e)this.maybeRejectOperation(r,t,i,n)}rejectPendingOperations(e,t=Re()){this._disposed=!0,this._logger.info(`[${t}]rejectPendingOperations=${JSON.stringify(e)}`),Object.keys(this._deferredOperations).forEach((i=>{this.maybeRejectOperation(i,e,void 0,t),this._deferredOperationsWithOperationId[t]&&delete this._deferredOperationsWithOperationId[t][""]})),Object.keys(this._deferredOperationsWithOperationId).forEach((i=>{Object.keys(this._deferredOperationsWithOperationId[i]).forEach((n=>{this.maybeRejectOperation(i,e,n,t),this._deferredOperationsWithOperationId[t]&&delete this._deferredOperationsWithOperationId[t][n]}))})),this._deferredOperations={},this._deferredOperationsWithOperationId={},this._endOperationDeferred.reject(e)}maybeRejectPendingOperationsWithPredicate(e,t=Re(),i){this._logger.info(`[${t}]rejectPendingOperationsWithPredicate`),Object.keys(this._deferredOperationsWithCauseId).forEach((t=>{Object.keys(this._deferredOperationsWithCauseId[t]).forEach((n=>{const r=this._deferredOperationsWithCauseId[t][n];r&&i(r.operationName,r.options)&&(this.maybeRejectOperation(r.operationName,e,n),this.maybeRejectOperationWithCauseId(t,n,e))}))}))}getOperationInfoForLogging(e,t,i=""){return`[${e}][${t}]${i?`[${ke(i)}]`:""}`}},Vn=i(496486),Hn=class{constructor(e){this._logger=e,this._promise=Promise.resolve(void 0),this._actionQueue=[]}chainPromise(e,t,i=Re(),n=!1){const r=Date.now(),s=(("function"==typeof t?t():t)||"").toString();this._actionQueue.push(s),this._logger.info(`[${i}][${s}]enqueueing, queue=[${this._actionQueue}], reset=${n}`);const a=()=>{this._actionQueue=this._actionQueue.filter((e=>e!==s))};return n&&this.reset(i),this._promise=this._promise.catch(Vn.noop).then((()=>{const t=Date.now()-r;return this._logger.info(`[${i}][${s}]begin, delayMs=${t}`),e()})),this._promise.then((()=>{a();const e=Date.now()-r;this._logger.info(`[${i}][${s}]success, durationMs=${e}`)}),(e=>{a();const t=Date.now()-r;this._logger.warn(`[${i}][${s}]failed=${He(e)}, durationMs=${t}`)})),this._promise}reset(e){this._logger.info(`[${e}] resetting`),this._promise=Promise.resolve(void 0)}};function Bn(e){return!(!e||!e.code)}function $n(e,t){let i;return i=Bn(e)?e:{code:499,subCode:void 0!==t?t:0,phrase:"string"==typeof e?e:Ve(e)},i}var jn=class{constructor(){this.msElapsed=0,this.isPaused=!1,this._startTime=(new Date).getTime(),this.pause=()=>{this.isPaused||(this.msElapsed+=(new Date).getTime()-this._startTime,this.isPaused=!0)},this.resume=()=>{this.isPaused&&(this.isPaused=!1,this._startTime=(new Date).getTime())},this.duration=()=>this.isPaused?this.msElapsed:this.msElapsed+(new Date).getTime()-this._startTime,this.durationInMinutes=()=>{const e=this.duration()/6e4;return Math.ceil(e)},this.durationInSeconds=()=>{const e=this.duration()/1e3;return Math.ceil(e)}}get startTime(){return this._startTime}};function Gn(){return new jn}var Wn=class extends Un{constructor(e,t,i,n,r){super(e),this.callTelemetry=t,this._ecsConfig=i,this._publishCallback=n,this._preconditionFunction=r,this._record={},this.logSuccess=(e,t,i)=>{this._logger.info(`${e} execution succeeded, result=${t?this.stringifyForLogging(t):"void"}, time=${i.duration()}`)},this.logFailure=(e,t,i)=>{this._logger.info(`${e} execution failed, reason=${this.stringifyForLogging(t)}, time=${i.duration()}`)},this.logTimeout=(e,t,i)=>{this._logger.info(`${e} execution timed out, reason=${this.stringifyForLogging(t)}, time=${i.duration()}`)},this.stringifyForLogging=e=>{let t;if(e instanceof Error)t=e.toString()||"Unknown Error";else try{t=JSON.stringify(e)}catch(e){t="Unable to stringify data"}return t},this.convertToTransactionEndIfErrorOrString=(e,t,i)=>{if(this._logger.info(`ecsEnableErrorConversion in operationHandler is: ${this._ecsConfig&&this._ecsConfig.enableErrorConversion}`),t&&this._ecsConfig&&this._ecsConfig.enableErrorConversion&&("string"==typeof e||e instanceof Error)){const t=$n(e);return this._logger.info(`${i} Error converted from ${e} to ${Ve(t)}`),t}return e},this._logger=e.createChild("[Operation]"),this._chainedPromise=new Hn(this._logger.createChild("[Chained]"))}resetOperationChain(e){this._chainedPromise.reset(e)}executeSync(e,t,i,n=Re(),r,s){const a=this.getOperationInfoForLogging(n,t,i),o=Gn();this._logger.info(`${a}API calledSync`);const l=this.callTelemetry.recordOperation(t,n,i,s);let d;try{this._setRecord(t),d=e(),l.recordSuccess(d,n),this.logSuccess(a,d,o)}catch(e){const t=this.convertToTransactionEndIfErrorOrString(e,r,a);l.recordFailure(t,n),this.logFailure(a,t,o)}return d}async executeChained(e,t,i,n=Re(),r,s,a){return this.checkPendingOperationAndExecute(e,!0,t,i,n,r,s,a)}async execute(e,t,i,n=Re(),r,s,a){return this.checkPendingOperationAndExecute(e,!1,t,i,n,r,s,a)}logOperation(e,t,...i){const n=i.length&&i.map((e=>this.stringifyForLogging(ke(e))));this._logger.info(`[${e}][${t}]API called, ${n?`with args=${n}`:""}`)}rejectPendingOperations(e,t=Re(),i){if(i){for(const e of Object.keys(this._deferredOperations))this.callTelemetry.maybeRecordOperationFailure(e,i,void 0,t);for(const e of Object.keys(this._deferredOperationsWithOperationId))for(const n of Object.keys(this._deferredOperationsWithOperationId[e]))this.callTelemetry.maybeRecordOperationFailure(e,i,n,t)}super.rejectPendingOperations(e,t)}maybeRejectOperations(e,t,i,n=Re(),r){if(r)for(const t of e)this.callTelemetry.maybeRecordOperationFailure(t,r,void 0,n);super.maybeRejectOperations(e,t,i,n)}checkPendingOperationAndExecute(e,t,i,n,r=Re(),s,a,o){const l=this.getOperationInfoForLogging(r,i,n);let d=null,c=null;return this.hasPendingOperationWithOperationId(i,n)||this.hasPendingOperation(i)?(this._logger.info(`${l}already pending, returning existing operation`),d=this.waitForOperation(i,n,r)):c=this.createPendingOperation(i,n,r,o),t?(this._logger.info(`${l}chained`),this._chainedPromise.chainPromise((()=>d||this.executeInternal(c,r,e,i,n,s,a,o)),i,r)):d||this.executeInternal(c,r,e,i,n,s,a,o)}_setRecord(e){this._record.hasOwnProperty(e)||(this._record[e]=0),this._record[e]+=1}getRecord(e){return this._record[e]}_recordTelemetryTimeoutAndPublish(e,t,i,n,r,s,a){const o=e||60;return window.setTimeout((()=>{if(!this._publishCallback)return void this._logger.warn(`${r} is marked to publish telemetry but no publish callback is defined.`);if(!this.hasPendingOperationWithOperationId(n,a)&&!this.hasPendingOperation(n))return;const e=new Error(`${r} execution did not complete before telemetry timeout of ${o}s.`);this.logTimeout(r,e,s),this.callTelemetry.maybeRecordOperationTimeout(n,e,a,i),this._publishCallback(t),this.callTelemetry.removeRecordedEvent(t)}),1e3*o)}_instantTelemetryPublish(e,t){this._publishCallback?(this._publishCallback(t),this.callTelemetry.removeRecordedEvent(t)):this._logger.warn(`${e} is marked to publish telemetry but no publish callback is defined.`)}parseInstantTelemetryParameters(e){let t,i=!1;return e&&(i=e.enableInstantTelemetry,t=e.telemetryTimeout),[i,t]}async executeInternal(e,t,i,n,r,s,a,o){const l=this.getOperationInfoForLogging(t,n,r);this._logger.info(`${l} executing operation...`);const d=Gn(),c=this.callTelemetry.recordOperation(n,t,r,a),[h,u]=this.parseInstantTelemetryParameters(o);try{let e;this._setRecord(n),h&&(e=this._recordTelemetryTimeoutAndPublish(u,c,t,n,l,d,r)),o?.preconditionTags?.length&&this._preconditionFunction&&this._preconditionFunction(n,o.preconditionTags);const s=await i();e&&clearTimeout(e),this.callTelemetry.maybeRecordOperationSuccess(n,s,r),this.logSuccess(l,s,d),this.maybeResolveOperation(n,s,r,t)}catch(e){const i=this.convertToTransactionEndIfErrorOrString(e,s,l);this.callTelemetry.maybeRecordOperationFailure(n,i,r),this.logFailure(l,i,d),this.maybeRejectOperation(n,i,r,t)}return h&&this._instantTelemetryPublish(l,c),e}getEcsConfig(){return this._ecsConfig}},qn={Cancel:487,Reject:603,NoNgcEndpoint:480,Forbidden:403,PreconditionFailed:412,Success:0,CallRedirected:302,BadRequest:400,NotFound:404,NotAcceptable:406,Timeout:408,Conflict:409,MediaError:410,ConfParticipantCountLimitReached:413,CallAccepted:450,CallForwarded:451,CallForwardedToVoicemail:452,P2pRejectCall:453,P2pFallbackForScreensharing:460,P2pFallbackDueToGroupCall:461,CallLegEndedOnService:470,CallDoesNotExist:481,NotAcceptableHere:488,NetworkError:490,GlareError:491,SkypeTokenError:495,LocalHttpStackError:496,UnknownError:497,LocalError:498,InternalServerError:500,CallModalityFailure:580,ServiceUnavailable:503},zn={Success:0,CallRedirectedSuccess:3020,InsufficientCapabilities:5204,PolicyRestriction:5448,UserBlocked:10005,MaxLobbyParticipantLimitReached:5807,MaxParticipantLimitReached:5808,MaxParticipantLimitReached2:5817,SharingStolenError:10029,DowngradeToStreamingClient:3099,MediaDropDuringConnect:3100,MediaDropAfterConnect:3101,MediaAnswerProcessingError:3102,MediaFinalAnswerProcessingError:3103,MediaOfferTimeout:3104,MediaFinalAnswerTimeout:3105,MediaOfferNull:3106,MediaAudioDeviceError:3107,MediaRenegotiationError:3108,MediaPermissionError:3109,MediaUnknownError:3110,MediaOfferProcessingError:3111,MediaWhiteListingIssue:3112,MediaMuteMicrophoneError:3113,MediaMuteSpeakerError:3114,MediaUnmuteMicrophoneError:3115,MediaUnmuteSpeakerError:3115,AttachActionFailed:4103,AttachFailed:4105,PreheatedCallTimedout:4113,RemovedFromConversation:5e3,DeniedInLobby:5854,RemovedFromCall:5300,TimedOutInLobby:5855,AnonymousJoinDisabledByPolicy:5723,B2bJoinDisabledByPolicy:5724,NoLobbyForBroadcastJoin:5354,NotAllowedDueToInformationBarrier:5810,TeamParkPolicyDisabled:10193,BroadcastLimitReached:800100,Suspended:58e4},Kn={[qn.Success]:1,[qn.Cancel]:12,[qn.Reject]:10,[qn.NoNgcEndpoint]:2,[qn.Timeout]:6,[qn.CallAccepted]:30,[qn.CallRedirected]:75,[qn.NotFound]:24,[qn.CallDoesNotExist]:46,[qn.NotAcceptable]:5,[qn.BadRequest]:5,[qn.MediaError]:4,[qn.ConfParticipantCountLimitReached]:59,[qn.CallModalityFailure]:4,[qn.NetworkError]:3,[qn.LocalHttpStackError]:31,[qn.LocalError]:25,[qn.CallForwarded]:27,[qn.CallForwardedToVoicemail]:28,[qn.SkypeTokenError]:29,[qn.InternalServerError]:7,[qn.Conflict]:7,[qn.GlareError]:7,[qn.CallLegEndedOnService]:7,[qn.NotAcceptableHere]:26,[qn.UnknownError]:32,[qn.Forbidden]:8,[qn.PreconditionFailed]:65},Jn={9401:33,9422:33,6102:1,6423:14,9402:14,9432:14,6519:3,9403:15,9410:36,9411:37,1e3:2,9407:17,13430:18,6009:19,10484:19,10604:19,10404:19,10420:19,10403:20,17401:20,10408:9,10486:11,10600:11,10686:11,10487:21,10500:3,10501:3,10502:3,10503:3,10504:3,10480:22,10482:22,10603:10,13406:23,13416:23},Yn={500:39,403:41,404:42,480:40},Qn={INCOMING_SKYPE_NGC_CALL:107,INCOMING_SKYPE_NGC_GVC_CALL:109,INCOMING_PSTN_NGC_CALL:111,INCOMING_SCREENSHARE_WITH_CHAT:119,INCOMING_TFL_TFW_CALL:126},Xn={SHARED_LINE_CALL_RECORD:121,SHARED_LINE_V2_CALL_RECORD:123,MEETING_STARTED_NOTIFICATION:128},Zn={LOG_UPLOAD_EVENT:120},er="CallEndReasonUnknown",tr="CallEndReasonMediaError",ir="CallEndReasonMediaPermissionError",nr="CallEndReasonMediaDropDuringConnectError",rr="CallEndReasonMediaDropAfterConnectError",sr="CallEndReasonMediaOfferProcessingError",ar="DowngradeToStreamingClient",or="CallEndReasonIncompatibleOffer",lr="MediaWhitelistingIssue",dr="CallEndReasonAttachFailed",cr="CallEndReasonBadNotificationPayload",hr="RetargetNotSupported",ur="CallEndReasonLocalUserInitiated",pr="EndedByRemoteEndpoint",gr="CallEndReasonRedirected",mr="CallEndReasonVDIdisconnect",fr="CallEndReasonSuspended",Sr=(e=>(e.GetSignalingMediaTypes="GetSignalingMediaTypes",e.CallStart="CallStart",e.WaitForAnswer="WaitForAnswer",e.WaitForConnect="WaitForConnect",e.Accept="Accept",e))(Sr||{}),vr=(e=>(e.InitializeMediaSession="InitializeMediaSession",e.UpdateMediaModalities="UpdateMediaModalities",e.CreateOffer="CreateOffer",e.CreateAnswer="CreateAnswer",e.ProcessAnswer="ProcessAnswer",e.GetSignalingMediaTypes="GetSignalingMediaTypes",e.MuteUnmute="MuteUnmute",e.MuteUnmuteSpeakers="MuteUnmuteSpeakers",e.StartVideoSafe="StartVideoSafe",e.CompleteNegotiation="CompleteNegotiation",e.MuteInput="MuteInput",e.MuteOutput="MuteOutput",e.UnmuteInput="UnmuteInput",e.UnmuteOutput="UnmuteOutput",e.evaluateEndpointStatesForAccept="evaluateEndpointStatesForAccept",e.handleEndpointStatesForAccept="handleEndpointStatesForAccept",e))(vr||{}),yr=(e=>(e.InitializeMediaSession="InitializeMediaSession",e.ProcessOffer="ProcessOffer",e.ProcessOfferedModalities="ProcessOfferedModalities",e.TrySendingProvisionalAnswer="TrySendingProvisionalAnswer",e))(yr||{}),Cr=i(496486),Tr=T(i(496486)),Er=T(i(496486)),_r=T(ge()),br="Success",Pr="ExpectedError",Ir="UnexpectedClientError",Ar="UnexpectedServerError",Rr={INCOMING_MESSAGE_ORIGIN:{TROUTER:"Trouter",BROKER:"Broker"},INVITATION_TYPE:{NUDGE:"nudge"},KNOWN_PAYLOAD_ENCODINGS:{GZIP:!0},WEBRTC_NOTIFICATION_TYPE:{CONTROL_VIDEO_STREAMING:"ControlVideoStreaming",DOMINANT_SPEAKER_INFO:"DominantSpeakerInfo",CSRC_INFO:"CsrcInfo"},PARTICIPANT_AUDIO_STATE:{CONNECTING:"Connecting",RINGING:"Ringing",CONNECTED:"Connected",OTHER:"Other"},HEADERS:{MESSAGE_ID:"X-Microsoft-Skype-Message-ID",ORIGINAL_MESSAGE_ID:"X-Microsoft-Skype-Original-Message-ID",CONTENT_ENCODING:"X-Microsoft-Skype-Content-Encoding",CORRELATION_ID:"X-Microsoft-Skype-Chain-ID",CONTENT_SHARING_CORRELATION_ID:"X-Microsoft-Skype-ContentSharing-Chain-ID",CLIENT_USER_AGENT:"X-Microsoft-Skype-Client",SKYPE_TOKEN:"X-Skypetoken",AUTHORIZATION:"Authorization",BEARER_KEYWORD:"Bearer",AAD_KEYWORD:"Aad",CAE_KEYWORD:"Cae",SKYPE_KEYWORD:"Skype",CACHE_SKYPE_TOKEN:"X-CacheSkypeToken",AUTHENTICATE:"www-authenticate",TOKEN_MIGRATION:"X-MS-Migration",BROKER_USE_BATCHING_HEADER_NAME:"X-UseBatching",PARTICIPANT_ID:"X-Microsoft-Skype-Participant-ID",CONTENT_TYPE:"Content-Type",RING:"MS-Teams-Ring",REGION:"MS-Teams-Region",PARTITION:"MS-Teams-Partition"},KNOWN_BOTS:{VOICEMAIL_BOT_ID:"28:14524421-25b4-403a-a0f7-e62d4379cabc"},HTTP_STACK_ERROR:{NONE:0,CANNOT_CONNECT:7,REQUEST_TIMEOUT:10,ATTEMPT_TIMEOUT:30,REQUEST_ABORTED:16,ATTEMPT_ABORTED:31,ABORTED_OTHER_ATTEMPT_SUCCESSFUL:32},HTTP_STATUS_CODES:{UNKNOWN:0,OK:200,CREATED:201,BAD_REQUEST:400,UNAUTHORIZED:401,NOT_FOUND:404,FORBIDDEN:403,PRECONDITION_FAILED:412,UNPROCESSABLE_ENTITY:422,NETWORK_ERROR:490,SKYPE_TOKEN_ERROR:495,OFFLINE:496,TIMEOUT:498,ABORTED:498,OTHER:499,INTERNAL_SERVER_ERROR:500,CONFLICT:409,BAD_GATEWAY:502,SERVICE_UNAVAILABLE:503,GATEWAY_TIMEOUT:504},CALL_END_SKYPE_TOKEN_ERROR:{code:495,subCode:4507,phrase:"CallEndReasonSkypeTokenFetchError",resultCategories:[Ir]},CALL_END_TOKEN_TIMEOUT_ERROR:{code:499,subCode:3119,phrase:"CallEndReasonTokenFetchTimeout",resultCategories:[Ir]},CALL_END_UNSUPPORTED_TOKEN_ERROR:{code:499,subCode:3126,phrase:"CallEndReasonUnsupportedTokenError",resultCategories:[Ir]},CALL_END_TOKEN_ERROR:{code:499,subCode:3127,phrase:"CallEndReasonTokenFetchError",resultCategories:[Ir]},CALL_END_LOCAL_HTTP_STACK_ERROR:{code:496,subCode:4520,phrase:"LocalHTTPStackError",resultCategories:[Ir]},CALL_END_UNKNOWN_ERROR:{code:497,subCode:3121,phrase:"CallEndReasonUnknownError",resultCategories:[Ir]},CALL_END_NETWORK_ERROR:{code:490,subCode:4502,phrase:"CallEndReasonNetworkError",resultCategories:[Ir]},CALL_END_LOCAL_DECLINE:{code:486,subCode:4508,phrase:"LocalDecline",resultCategories:[br]},RESOURCE_NOT_FOUND_ERROR:{code:404,subCode:404,phrase:"ResourceNotFound",resultCategories:[Pr]},CALL_STATUS:{IDLE:"Idle",RINGING:"Ringing",CONNECTING:"Connecting",CONNECTED:"Connected",CONNECTED_FOR_ROSTER_ONLY:"ConnectedForRosterOnly",LOCAL_TERMINATED:"LocalTerminated",REMOTE_TERMINATED:"RemoteTerminated"},MEDIA_TYPES:{AUDIO:"Audio",VIDEO:"Video",SCREEN_SHARER:"ScreenSharer",SCREEN_VIEWER:"ScreenViewer"},MUTE_SCOPE:{MYSELF:"Myself",EVERYONE_ELSE:"EveryoneElse",SPECIFIED_PARTICIPANTS:"SpecifiedParticipants"},URL_BASE:{CALLAGENT:"callAgent"},LINKS:{HANGUP:"hangup",MEDIA_REJECTION:"mediaRejection",MEDIA_ANSWER:"mediaAnswer",MEDIA_RENEGOTIATION:"mediaRenegotiation",ACCEPT:"accept",ATTACH:"attach",REJECT:"reject",REDIRECT:"redirect",REPLACE:"replace",TRANSFER:"transfer",NEW_OFFER:"newOffer",TRANSFER_ACCEPTANCE:"transferAcceptance",TRANSFER_COMPLETION:"transferCompletion",CONVERSATION_CONTROLLER:"conversationController",ADD_PARTICIPANT:"addParticipant",ADD_PARTICIPANTS_AND_MODALITY:"addParticipantsAndModality",LEAVE:"leave",NOTIFICATION_LINKS:"notificationLinks",REMOVE_PARTICIPANT:"removeParticipant",KEEPALIVE:"keepAlive",ADD_MODALITY:"AddModality",REMOVE_MODALITY:"RemoveModality",CONTENT_SHARING_CONTROLLER:"contentSharingController",CONTENT_SHARING_TAKE_CONTROL:"contentSharingTakeControl",CONTENT_SHARING_UPDATE_SESSION_STATE:"contentSharingUpdateSessionState",CONTENT_SHARING_UPDATE_PARTICIPANT_STATE:"contentSharingUpdateParticipantState",CONTENT_SHARING_NOTIFICATION_LINKS:"contentSharingNotificationLinks",CONTENT_SHARING_LEAVE:"contentSharingLeave",MUTE:"mute",UNMUTE:"unmute",ADMIT:"admit",ADMIT_ALL:"admitAll",CONTROL_VIDEO_STREAMING:"controlVideoStreaming",APPLY_CHANNEL_PARAMETERS:"applyChannelParameters",UPDATE_ENDPOINT_STATE:"updateEndpointState",UPDATE_ENDPOINT_METADATA:"updateEndpointMetadata",LMC_NOTIFICATION_LINKS:"lmcNotificationLinks",UPDATE_PARTICIPANT_ROLE:"updateParticipantRole",PUBLISH_STATE:"publishState",REMOVE_STATE:"removeState",UPDATE_MEETING_SETTINGS:"updateMeetingSettings",SEARCH_PARTICIPANTS:"searchParticipants",GET_ALL_PARTICIPANTS:"getAllParticipants",PARK:"park",UNPARK:"unpark",UPDATE_MEETING_LIVE_STATE:"updateMeetingLiveState",UPDATE_MEETING_GROUPS:"updateMeetingGroups",SET_MEETING_LAYOUT:"setMeetingLayout",UPDATE_PARTICIPANT_INTERPRETATION_STATE:"updateParticipantInterpretationState",JOIN_MEETING_GROUP:"joinMeetingGroup",LEAVE_MEETING_GROUP:"leaveMeetingGroup",SEND_MESSAGE:"sendMessage",UPDATE_PARTICIPANTS_PROPERTIES:"updateParticipantsProperties",UPDATE_MEDIA_DESCRIPTIONS:"updateMediaDescriptions",UPDATE_MEETING_STATES:"updateMeetingStates"},CONTENT_TYPE:{JSON:"application/json",SDP:"application/sdp"},TROUTER_EVENT_TYPE:{SKYPE_SKYPE_CALL:107,LYNC_SKYPE_CALL:105},MISC:{CONVERSATION:"conversation",LOBBY_CALL_CONTROLLER:"lobby",LOBBY_PARTICIPANT_STATE:"lobby"},SIGNALING_FSM_STATE:{IDLE:"Idle",INCOMING:"Incoming",WAITING_CALL_ACCEPTANCE_ACK:"WaitingCallAcceptanceAck",OUTGOING:"Outgoing",CONNECTED:"Connected",OUTGOING_FOR_ROSTER_ONLY:"OutgoingForRosterOnly",CONNECTED_FOR_ROSTER_ONLY:"ConnectedForRosterOnly"},MEDIA_RENEGOTIATION_FSM_STATE:{IDLE:"Idle",CALL_CONNECTED:"Connected",INCOMING_RENEGOTIATION:"IncomingRenegotiation",OUTGOING_RENEGOTIATION:"OutgoingRenegotiation",RENEGOTIATION_GLARE:"RenegotiationGlare"},CONTENT_SHARING_FSM_STATE:{IDLE:"Idle",CONTENT_SHARING_START_INITIATED:"ContentSharingStartInitiated",CONTENT_SHARING_JOIN_INITIATED:"ContentSharingJoinInitiated",CONTENT_SHARING_LEAVE_INITIATED:"ContentSharingLeaveInitiated",CONTENT_SHARING_DELETE_INITIATED:"ContentSharingDeleteInitiated",CONTENT_SHARING_CONNECTED:"ContentSharingConnected"},TIMEOUT_OPERATIONS:{ADD_PARTICIPANT:"AddParticipant",NUDGE_PARTICIPANT:"NudgeParticipant",REMOVE_PARTICIPANT:"RemoveParticipant",ADMIT_PARTICIPANT:"AdmitParticipant",ADMIT:"Admit",CALL_REDIRECT:"CallRedirect",CALL_ME_BACK:"CallMeBack",INCOMING_CALL_ESTABLISHMENT:"IncomingCallEstablishment",OUTGOING_CALL_ESTABLISHMENT:"OutgoingCallEstablishment",MEDIA_ANSWER:"MediaAnswer",MEDIA_ANSWER_ACKNOWLEDGEMENT:"MediaAnswerAcknowledgement",ADD_MODALITY:"AddModality",UNMUTE:"Unmute",UPDATE_MEETING_ROLE:"UpdateMeetingRole",MAX_PREAHEATED_TIMEOUT:"MaxPreheateadTimeout",PARK_COMPLETION:"ParkCompletion",UNPARK_COMPLETION:"UnparkCompletion",UPDATE_MEETING_LIVE_STATE_COMPLETION:"UpdateMeetingLiveStateCompletion",UPDATE_MEETING_GROUPS_COMPLETION:"UpgradeMeetingGroupsCompletion",UPDATE_PARTICIPANT_INTERPRETATION_STATE_COMPLETION:"UpdateParticipantInterpretationStateCompletion",UPDATE_PARTICIPANTS_PROPERTIES_COMPLETION:"UpdateParticipantsPropertiesCompletion",JOIN_MEETING_GROUP_COMPLETION:"JoinMeetingGroupCompletion",LEAVE_MEETING_GROUP_COMPLETION:"LeaveMeetingGroupCompletion",SET_MEETING_LAYOUT_COMPLETION:"SetMeetingLayoutCompletion",SEND_MESSAGE_COMPLETION:"SendMessageCompletion",DISABLE_PREHEAT_ASYNC_TIMEOUT:"DisablePreheatAsyncTimeout",UPDATE_MEETING_STATES_COMPLETION:"UpdateMeetingStatesCompletion"},TIMEOUT_VALUES_IN_SECONDS:{ADD_PARTICIPANT_TIMEOUT:130,REMOVE_PARTICIPANT_TIMEOUT:60,INCOMING_CALL_ESTABLISHMENT_TIMEOUT:75,OUTGOING_CALL_ESTABLISHMENT_TIMEOUT:90,LONGER_OUTGOING_CALL_ESTABLISHMENT_TIMEOUT:185,MEDIA_ANSWER_TIMEOUT:35,MEDIA_ANSWER_ACKNOWLEDGEMENT_TIMEOUT:15,ADD_MODALITY_TIMEOUT:65,UNMUTE_TIMEOUT:35,ADMIT_PARTICIPANT_TIMEOUT:120,ADMIT_TIMEOUT:60,UPDATE_MEETING_ROLE_TIMEOUT:15,NUDGE_PARTICIPANT_TIMEOUT:60,CALL_ME_BACK_TIMEOUT:120,MAX_PREAHEATED_TIMEOUT:90,PARK_COMPLETION_TIMEOUT:45,UNPARK_COMPLETION_TIMEOUT:45,UPDATE_MEETING_LIVE_STATE_COMPLETION_TIMEOUT:45,UPDATE_MEETING_GROUPS_COMPLETION_TIMEOUT:45,SET_MEETING_LAYOUT_COMPLETION_TIMEOUT:45,UPDATE_PARTICIPANT_INTERPRETATION_STATE_COMPLETION_TIMEOUT:45,UPDATE_PARTICIPANTS_PROPERTIES_COMPLETION_TIMEOUT:45,JOIN_MEETING_GROUP_COMPLETION_TIMEOUT:45,LEAVE_MEETING_GROUP_COMPLETION_TIMEOUT:45,CONVERSATION_KEEP_ALIVE_TIMEOUT:2700,TOKEN_REQUIRED_TIMEOUT:20,SEND_MESSAGE_COMPLETION_TIMEOUT:15,DISABLE_PREHEAT_TIMEOUT:45,UPDATE_MEETING_STATES_COMPLETION_TIMEOUT:45},CALL_END_CODE:{REJECT:603,SUCCESS:0,CALL_REDIRECTED:302,CANCEL:487,TIMEOUT:408,SERVICE_UNAVAILABLE:500,BAD_REQUEST:406,NO_NGC_ENDPOINT:480,P2P_FALLBACK_FOR_SCREENSHARING:460,CONFLICT:409,MEDIA_ERROR:410,CONF_PARTICIPANT_COUNT_LIMIT_REACHED:413,CALL_DOES_NOT_EXIST:481,CALL_ACCEPTED:450,CALL_FORWARDED:451,CALL_FORWARDED_TO_VOICEMAIL:452,P2P_REJECT_CALL:453,P2P_FALLBACK_DUE_TO_GROUPCALL:461,CALL_LEG_ENDED_ON_SERVICE:470,NOT_ACCEPTABLE_HERE:488,NETWORK_ERROR:490,UNKNOWN_ERROR:497,LOCAL_ERROR:498,CALL_MODALITY_FAILURE:580,ATC_CONTROLLER_FAILURE:581,CVA_CONTROLLER_FAILURE:586,GLARE_ERROR:491,NOT_FOUND:404,SKYPE_TOKEN_ERROR:495,LOCAL_HTTP_STACK_ERROR:496,HTTP_OTHER_ERROR:499,DECODING_FAILED:407,NOT_AUTHORIZED:403,BAD_SERVICE_RESPONSE:400},CALL_END_SUB_CODE:{SUCCESS:0,CALL_REDIRECTED_SUCCESS:3020,DOWNGRADE_TO_STREAMING_CLIENT:3099,MEDIA_DROP_DURING_CONNECT:3100,MEDIA_DROP_AFTER_CONNECT:3101,MEDIA_ANSWER_PROCESSING_ERROR:3102,MEDIA_FINAL_ANSWER_PROCESSING_ERROR:3103,MEDIA_OFFER_TIMEOUT:3104,MEDIA_FINAL_ANSWER_TIMEOUT:3105,MEDIA_OFFER_NULL:3106,MEDIA_AUDIO_DEVICE_ERROR:3107,MEDIA_RENEGOTIATION_ERROR:3108,MEDIA_PERMISSION_ERROR:3109,MEDIA_UNKNOWN_ERROR:3110,MEDIA_OFFER_PROCESSING_ERROR:3111,MEDIA_WHITELISTING_ISSUE:3112,MEDIA_MUTE_MICROPHONE_ERROR:3114,MEDIA_MUTE_SPEAKER_ERROR:3115,MEDIA_UNMUTE_MICROPHONE_ERROR:3116,MEDIA_UNMUTE_SPEAKER_ERROR:3117,MEDIA_GLARE_ERROR:3118,CONVERSATION_TERMINATION_UNKNOWN_ERROR:3121,CONVERSATION_NOTIFICATION_TIMEOUT:3125,CALL_NOT_ATTEMPTED:4500,CONV_URL_NOT_SET:4501,FAILED_TO_REACH_SERVICE:4502,PLACE_CALL_FAILED:4503,ATTACH_CALL_FAILED:4504,BAD_NOTIFICATION_PAYLOAD:4505,CALL_ESTABLISHMENT_TIMEOUT:4506,SKYPE_TOKEN_ERROR:4507,CONVERSATION_RESOLUTION_CONFLICT:5704,CALL_PARTICIPANT_REMOVAL_TIMEOUT:4507,UNMUTE_REQUEST_TIMEOUT:4509,UNMUTE_REQUEST_REJECTED:4510,CONFLICT_IN_NG:4090,CONFLICT_WITH_P2P:4091,CONVERSATION_END_RECEIVED_FROM_SERVICE:4100,TRANSFER_COMPLETE_TIMEOUT:4101,ATTACH_TO_NON_EXISTENT_CALL:4102,ATTACH_ACTION_FAILED:4103,ATTACH_FAILED:4105,CONVERSATION_ESTABLISHMENT_FAILED:4106,BEFORE_CONNECT:4107,AFTER_CONNECT:4108,AFTER_ACCEPT:4109,TROUTER_CONNECTION_DROPPED:4111,DUE_TO_CALL_ASSIMILATION:4112,PREHEATED_CALL_TIMEDOUT:4113,UNPARK_COMPLETION_TIMEOUT:4114,PARK_COMPLETION_TIMEOUT:4115,UPDATE_MEETING_LIVE_STATE_COMPLETION_TIMEOUT:4116,UPDATE_MEETING_GROUPS_COMPLETION_TIMEOUT:4117,SET_MEETING_LAYOUT_COMPLETION_TIMEOUT:4118,UPDATE_PARTICIPANT_INTERPRETATION_STATE_TIMEOUT:4119,JOIN_MEETING_GROUP_TIMEOUT:4120,LEAVE_MEETING_GROUP_TIMEOUT:4121,UPDATE_PARTICIPANTS_PROPERTIES_TIMEOUT:4122,UPDATE_MEETING_STATES_COMPLETION_TIMEOUT:4123,MISSING_REQUEST_URI:4511,LOCAL_HTTP_STACK_ERROR:4520,BEACON:4521,CONVERSATION_ENDED_NO_NEW_OWNER_FOUND:5014,UNABLE_TO_GENERATE_MEETUP_ID:5015,UPDATE_MEETING_ROLE_REJECTED:5651,UPDATE_MEETING_ROLE_TIMEOUT:5652,PUBLISH_STATE_LINK_MISSING:5653,PUBLISH_STATE_INVALID_CONTENT:5654,PUBLISH_STATE_INVALID_SERVICE_RESPONSE:5655,REMOVE_STATE_LINK_MISSING:5656,REMOVE_STATE_MISSING_ARGUMENTS:5657,UPDATE_MEETING_SETTINGS_LINK_MISSING:5658,UPDATE_MEETING_SETTINGS_MISSING_ARGUMENTS:5659,ADMIT_ALL_LINK_MISSING:5660,ADMIT_TIMEOUT:5661,CALL_ACCEPTANCE_INVALID_SERVICE_RESPONSE:5670,ROSTER_HANDLING_INVALID_SERVICE_RESPONSE:5671,SEARCH_PARTICIPANTS_LINK_MISSING:5672,SEARCH_PARTICIPANTS_INVALID_SERVICE_RESPONSE:5673,GET_ALL_PARTICIPANTS_LINK_MISSING:5674,GET_ALL_PARTICIPANTS_INVALID_SCOPE:5675,GET_ALL_PARTICIPANTS_INVALID_SERVICE_RESPONSE:5676,PARK_UNPARK_TYPE_MISSING:5680,PARK_UNPARK_V2_DISABLED:5682,UPDATE_PARTICIPANTS_PROPERTIES_LINK_MISSING:5683,DISABLE_PREHEAT_TIMEOUT:5684,CALL_ENDED_BY_PLATFORM_AGENT:7e3},CALL_END_PHRASE:{UNKNOWN:"CallEndReasonUnknown",MEDIA_ERROR:"CallEndReasonMediaError",MEDIA_OFFER_TIMEOUT:"CallEndReasonMediaOfferTimeout",MEDIA_FINAL_ANSWER_TIMEOUT:"CallEndReasonMediaFinalAnswerTimeout",MEDIA_ANSWER_ERROR:"CallEndReasonMediaAnswerError",MEDIA_FINAL_ANSWER_ERROR:"CallEndReasonFinalAnswerError",MEDIA_PERMISSION_ERROR:"CallEndReasonMediaPermissionError",MEDIA_RENEGOTIATION_ERROR:"CallEndReasonRenegotiationError",MEDIA_DROP_DURING_CONNECT:"CallEndReasonMediaDropDuringConnectError",MEDIA_DROP_AFTER_CONNECT:"CallEndReasonMediaDropAfterConnectError",MEDIA_OFFER_PROCESSING_ERROR:"CallEndReasonMediaOfferProcessingError",MEDIA_WHITELISTING_ISSUE:"MediaWhitelistingIssue",AUDIO_ERROR:"CallEndReasonAudioDeviceError",CONVERSATION_NOTIFICATION_TIMEOUT:"ConversationNotificationTimeout",BAD_NOTIFICATION_PAYLOAD:"BadCallNotificationPayload",NETWORK_ERROR:"CallEndReasonNetworkError",LOCAL_USER_INITIATED:"CallEndReasonLocalUserInitiated",REMOTE_USER_INITIATED:"CallEndReasonRemoteUserInitiated",ESTABLISHMENT_TIMEOUT:"CallEndReasonEstablishmentTimeout",PARTICIPANT_REMOVAL_TIMEOUT:"CallParticipantRemovalTimeout",LOCAL_ERROR:"CallEndReasonLocalError",CALL_UPDATE_ERROR:"CallEndReasonCallUpdateError",CALL_REDIRECT_IS_NOT_ALLOWED:"CallRedirectisNotAllowed",P2P_FORK_CONNECTED:"CallEndReasonP2pForkConnected",P2P_FORK_FORWARDED:"CallEndReasonP2pForkForwarded",P2P_FORK_FORWARDED_TO_VOICEMAIL:"CallEndReasonP2pForkForwardedToVoiceMail",P2P_FALLBACK_FOR_SCREENSHARING:"CallEndReasonP2pFallbackForScreensharing",P2P_FALLBACK_FOR_GROUPCALL:"CallEndReasonP2pFallbackForGroupCall",P2P_FALLBACK_FOR_CALL_ASSIMILATION:"CallEndReasonP2pFallbackForCallAssimilation",P2P_FALLBACK_FOR_TRANSLATION:"CallEndReasonP2pFallbackForCallTranslation",P2P_FORK_REJECTED:"CallEndReasonP2pForkRejected",TROUTER_CONNECTION_DROPPED:"CallEndReasonTrouterConnectionDropped",REMOVED_FROM_CALL:"CallEndReasonRemovedFromCall",TRANSFER_COMPLETION_TIMEOUT:"CallEndReasonTransferCompletionTimeout",CALL_DOES_NOT_EXIST:"CallEndReasonCallDoesNotExist",ATTACH_ACTION_FAILED:"CallEndReasonAttachActionFailed",ATTACH_FAILED:"CallEndReasonAttachFailed",CONVERSATION_ESTABLISHMENT_FAILED:"CallEndReasonConversationEstablishmentFailed",CONV_END_FROM_SERVICE:"CallEndReasonConversationEndReceivedFromService",CONV_END_FROM_SERVICE_WITH_ERROR:"CallEndReasonConversationEndReceivedFromServiceWithError",SERVICE_ERROR:"CallEndReasonServiceError",CONFLICT:"CallEndReasonConflict",CALL_ALREADY_IN_P2P:"CallEndReasonCallAlreadyExistsInP2p",CONV_END_NO_MODALITY:"ConversationEndNoModalityConnected",CONV_END_FOR_ALL_INITIATED:"ConversationEndForAllInitiated",RENEGOTIATION_IN_PROGRESS:"NegotiationIsInProgress",ADD_PARTICIPANT_URL_MISSING:"AddParticipantUrlMissing",ADMIT_PARTICIPANT_URL_MISSING:"AdmitParticipantUrlMissing",ADMIT_ALL_URL_MISSING:"AdmitAllUrlMissing",UPDATE_PARTICIPANT_INTERPRETATION_STATE_URL_MISSING:"UpdateParticipantInterpretationStateUrlMissing",UPDATE_PARTICIPANTS_PROPERTIES_URL_MISSING:"UpdateParticipantsPropertiesUrlMissing",ADMIT_TIMEOUT:"AdmitTimeout",UNABLE_TO_GENERATE_MEETUP_ID:"Unable to generate GroupChat meetup id.",ENDED_BY_PMA:"Call ended by media agent.",OWNERSHIP_RESOLUTION_CONFLICT:"Conversation cannot be created due to a failure to resolve ownership.",CONVERSATION_ENDED_NO_NEW_OWNER_FOUND:"This conversation has ended since we were unable to determine a potential host for the group call.",UNMUTE_REQUEST_TIMEOUT:"UnmuteRequestTimeout",UNMUTE_REQUEST_REJECTED:"UnmuteRequestRejected",UPDATE_MEETING_ROLE_TIMEOUT:"UpdateMeetingRoleTimeout",UPDATE_MEETING_ROLE_REJECTED:"Update meeting role operation failed due to insufficient privileges.",PARK_REQUEST_FAILED:"Park Request Failed",PARK_COMPLETION_TIMEOUT:"ParkCompletionTimeout",PARK_COMPLETION_FAILED:"ParkCompletionFailed",UNPARK_REQUEST_FAILED:"UnparkFailed",UNPARK_COMPLETION_TIMEOUT:"UnparkCompletionTimeout",UNPARK_COMPLETION_FAILED:"UnparkCompletionFailed",BAD_SERVICE_RESPONSE:"BadServiceResponse",UPDATE_MEETING_LIVE_STATE_COMPLETION_TIMEOUT:"UpdateMeetingLiveStateCompletionTimeout",UPDATE_MEETING_GROUPS_COMPLETION_TIMEOUT:"UpdateMeetingGroupsCompletionTimeout",SET_MEETING_LAYOUT_COMPLETION_TIMEOUT:"SetMeetingLayoutCompletionTimeout",UPDATE_PARTICIPANT_INTERPRETATION_STATE_TIMEOUT:"UpdateParticipantInterpretationTimeout",JOIN_MEETING_GROUP_TIMEOUT:"JoinMeetingGroupTimeout",LEAVE_MEETING_GROUP_TIMEOUT:"LeaveMeetingGroupTimeout",DOWNGRADE_TO_STREAMING_CLIENT:"DowngradeToStreamingClient",MESSAGE_STATUS_WITH_FAILURE_COUNT:"NotZeroFailureCount",UPDATE_PARTICIPANTS_PROPERTIES_TIMEOUT:"UpdateParticipantsPropertiesTimeout",DISABLE_PREHEAT_TIMEOUT:"DisablePreheatTimeout",UPDATE_MEETING_STATES_COMPLETION_TIMEOUT:"UpdateMeetingStatesCompletionTimeout"},TRANSACTION_END_CODE:{SUCCESS:0},URL_DEFAULTS:{UPLOAD_LOG_URL:"https://api.cc.skype.com/cc/v1/uploadlog/"},SUCCESS_TRANSACTION_END:{code:0,resultCategories:[br]},VALIDATION:{VALIDATION_FAILED:6e3,NULL_OR_EMPTY:6001}},wr={REQUEST_TIMEOUT:{status:Rr.HTTP_STATUS_CODES.TIMEOUT,statusText:"Request timed out",readyState:0,response:Rr.HTTP_STACK_ERROR.REQUEST_TIMEOUT},ATTEMPT_TIMEOUT:{status:Rr.HTTP_STATUS_CODES.TIMEOUT,statusText:"Attempt timed out",readyState:0,response:Rr.HTTP_STACK_ERROR.ATTEMPT_TIMEOUT},REQUEST_ABORTED:{status:Rr.HTTP_STATUS_CODES.ABORTED,statusText:"Request Aborted",readyState:0,response:Rr.HTTP_STACK_ERROR.REQUEST_ABORTED},ATTEMPT_ABORTED:{status:Rr.HTTP_STATUS_CODES.ABORTED,statusText:"Attempt Aborted",readyState:0,response:Rr.HTTP_STACK_ERROR.ATTEMPT_ABORTED}},Mr={MEDIA_ACKNOWLEDGEMENT:"/call/mediaAcknowledgement/",MEDIA_REJECTION:"/call/rejection/",ACKNOWLEDGEMENT:"/call/acknowledgement/",MEDIA_RENEGOTIATION:"/call/mediaRenegotiation/",REPLACE:"/call/replacement/",PROGRESS:"/call/progress/",MEDIA_ANSWER:"/call/mediaAnswer/",NEW_MEDIA_OFFER:"/call/newMediaOffer/",REDIRECTION:"/call/redirection/",BALANCE_UPDATE:"/call/balanceUpdate/",ACCEPT:"/call/acceptance/",CONTROL_VIDEO_STREAMING:"/call/controlVideoStreaming/",DOMINANT_SPEAKER_INFO:"/call/dominantSpeakerInfo/",CSRC_INFO:"/call/csrcInfo/",END:"/call/end/",RETARGET_COMPLETION:"/call/retargetCompletion/",TRANSFER:"/call/transfer/",TRANSFER_ACCEPTANCE:"/call/transferAcceptance/",TRANSFER_COMPLETION:"/call/transferCompletion/",PARK_COMPLETION:"/call/holdCompletion/",UNPARK_COMPLETION:"/call/resumeCompletion/",UPDATE_MEDIA_DESCRIPTIONS:"/call/updateMediaDescriptions"},Or={CONV_END:"/conversation/conversationEnd/",CONV_UPDATE:"/conversation/conversationUpdate/",CONV_LOCAL_PARTICIPANT_UPDATE:"/conversation/localParticipantUpdate/",CONV_ROSTER_UPDATE:"/conversation/rosterUpdate/",CONV_ADD_PARTICIPANT_SUCCESS:"/conversation/addParticipantSuccess/",CONV_ADD_PARTICIPANT_FAILURE:"/conversation/addParticipantFailure/",CONV_NUDGE_PARTICIPANT_SUCCESS:"/conversation/nudgeParticipantSuccess/",CONV_NUDGE_PARTICIPANT_FAILURE:"/conversation/nudgeParticipantFailure/",CONV_ADMIT_PARTICIPANT_SUCCESS:"/conversation/admitParticipantSuccess/",CONV_ADMIT_PARTICIPANT_FAILURE:"/conversation/admitParticipantFailure/",CONV_ADMIT_ALL_STATUS:"/conversation/admitAllStatus/",CONV_REMOVE_PARTICIPANT_SUCCESS:"/conversation/removeParticipantSuccess/",CONV_REMOVE_PARTICIPANT_FAILURE:"/conversation/removeParticipantFailure/",CONV_ADD_MODALITY_SUCCESS:"/conversation/addModalitySuccess/",CONV_ADD_MODALITY_FAILURE:"/conversation/addModalityFailure/",CONV_CONTENT_SHARING_UPDATE:"/conversation/contentSharingUpdate/",CONV_CONTENT_SHARING_END:"/conversation/contentSharingEnd/",CONV_BROADCAST_UPDATE:"/conversation/broadcastUpdate/",CONV_CONFIRM_UNMUTE:"/conversation/confirmUnmute/",CONV_UNMUTE_SUCCESS:"/conversation/unmuteSuccess/",CONV_UNMUTE_FAILURE:"/conversation/unmuteFailure/",UPDATE_MEETING_LIVE_STATE_STATUS:"/conversation/updateMeetingLiveStateStatus/",UPDATE_MEETING_GROUPS_STATUS:"/conversation/updateMeetingGroupsStatus/",SET_MEETING_LAYOUT_STATUS:"/conversation/setMeetingLayoutStatus/",UPDATE_PARTICIPANT_INTERPRETATION_STATE_STATUS:"/conversation/updateParticipantInterpretationStateStatus/",UPDATE_PARTICIPANT_PROPERTIES_STATUS:"/conversation/updateParticipantPropertiesStatus/",JOIN_MEETING_GROUP_STATUS:"/conversation/joinMeetingGroupStatus/",LEAVE_MEETING_GROUP_STATUS:"/conversation/leaveMeetingGroupStatus/",RECEIVE_MESSAGE:"/conversation/receiveMessage/",SEND_MESSAGE_STATUS:"/conversation/sendMessageStatus/",DISABLE_PREHEAT_ASYNC_STATUS:"/conversation/disablePreheatAsyncStatus/",UPDATE_MEETING_STATES_STATUS:"/conversation/updateMeetingStatesStatus/",MUTE_UNMUTE_ASYNC:"/conversation/muteUnmuteAsync/"},Dr={...Mr,...Or},kr="callNotification",Nr="mediaAnswer",Lr="mediaAcknowledgement",xr="callAcceptance",Fr="callEnd",Ur="callProgress",Vr="callAcceptanceAcknowledgement",Hr="mediaNegotiation",Br="mediaNegotiationFailure",$r="balanceUpdate",jr="retargetCompleted",Gr="callTransfer",Wr="transferCompletion",qr="transferAcceptance",zr="holdCompletion",Kr="resumeCompletion",Jr="updateMeetingLiveStateResponse",Yr="updateMeetingGroupsResponse",Qr="setMeetingLayoutResponse",Xr="updateMeetingStatesResponse",Zr=Rr,es=T(i(496486)),ts=class e{constructor(e){this.headers={},e&&Object.keys(e).forEach((t=>{this.headers[this.getLowerCaseName(t)]=e[t]}))}isEmpty(){return es.isEmpty(this.headers)}set(e,t){this.headers[this.getLowerCaseName(e)]=t}get(t,i){return i?e.getHeaderValue(this.headers,t)||i:e.getHeaderValue(this.headers,t)}delete(e){delete this.headers[e],delete this.headers[e.toLowerCase()]}hasOwnPropertyCaseInsensitive(e){return Object.keys(this.headers).filter((function(t){return t.toUpperCase()===e.toUpperCase()})).length>0}getAll(){return this.headers}getLowerCaseName(t){return e.useLowerCaseHeaders?t.toLowerCase():t}static getHeaderValue(e,t){return e.hasOwnProperty(t)?e[t]:e.hasOwnProperty(t.toLowerCase())?e[t.toLowerCase()]:void 0}};function is(e,t,i=os()){return cs(t,"trailingPath cannot be null"),hs(e,"signalingSession cannot be null"),hs(e.baseMessagingChannelUrl,"messaging channel url is not set"),`${e.baseMessagingChannelUrl}${Zr.URL_BASE.CALLAGENT}/${e.sessionId}/${i}${t}`}function ns(e){let t=1;return e.callingServiceSupportsAADTokens&&(t|=4),e.callingServiceSupportsCAETokens&&(t|=8),t}function rs(e){const t=e.toLowerCase(),i='token_types="',n=t.indexOf(i);if(-1===n)return[];const r=t.indexOf('"',n+13);if(-1===r)return[];const s=t.substring(n+13,r).trim();return""===s?[]:s.split(" ")}function ss(e){return!!e.match(/^8:/)}function as(e){return e.replace(/^\d+:/,"")}function os(){return ls().substr(0,8)}function ls(){const e="0123456789abcdef";let t="",i=0,n=0;for(;n<36;){const r="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx"[n];switch(i=n%8==0?4294967295*Math.random()|0:i>>4,r){case"x":t+=e[15&i];break;case"y":t+=e[3&i|8];break;case"4":case"-":t+=r}n++}return t}function ds(e,t){if(!e)throw new Error("Assert failed"+(void 0!==t?`:${t}`:""))}function cs(e,t){if(!e||e instanceof String&&""===e||e instanceof Array&&0===e.length)throw new Error("AssertNotNullOrEmpty failed. "+(void 0!==t?`: ${t}`:""))}function hs(e,t){if(!e)throw new Error("AssertNotNull failed. "+(void 0!==t?`: ${t}`:""))}function us(e){if(cs(e,"callEndReason cannot be null or empty"),void 0===e.code||void 0===e.subCode||void 0===e.phrase||e.code<0||e.subCode<0||" "===e.phrase)throw new Error(`callEndReason must specify code, subCode and phrase. Invalid reason : ${Ve(e)}`)}function ps(e){hs(e,"MediaTypes passed cannot be null");const t=[],i=Zr.MEDIA_TYPES;for(const n of Object.keys(i))fs(e,i[n])&&t.push(i[n]);return t}function gs(e,t){const i={};for(const n of Object.values(t)){const t=n.split("/");i[t[t.length-2]]=is(e,n)}return i}function ms(e,t){return e.length>=t.length&&e.indexOf(t,e.length-t.length)>-1}function fs(e,t){const i=t.toString().toLowerCase();return e.map((e=>e.toString().toLowerCase())).indexOf(i)>-1}function Ss(e,t,i){return!e.hasOwnProperty(t)&&(e[t]=i,!0)}function vs(e,t){return!!e.hasOwnProperty(t)&&(delete e[t],!0)}function ys(e){let t=null;try{return t=JSON.parse(e),"object"==typeof t?t:null}catch(e){return null}}function Cs(e,t){if(!e)return{telemetryEndSubCode:Zr.CALL_END_CODE.UNKNOWN_ERROR,error:Zr.CALL_END_UNKNOWN_ERROR};let i;if("object"==typeof e.response)i=e.response;else try{i=JSON.parse(e.response)}catch(e){}if(e.skypeTokenError)return{telemetryEndSubCode:Zr.CALL_END_CODE.SKYPE_TOKEN_ERROR,error:Zr.CALL_END_SKYPE_TOKEN_ERROR};if(e.tokenTimeoutError)return{telemetryEndSubCode:Zr.CALL_END_CODE.HTTP_OTHER_ERROR,error:Zr.CALL_END_TOKEN_TIMEOUT_ERROR};if(e.tokenError)return{telemetryEndSubCode:Zr.CALL_END_CODE.HTTP_OTHER_ERROR,error:Zr.CALL_END_TOKEN_ERROR};if(i&&(i.operationFailure||i.broadcastOperationFailure)){const e=i.operationFailure||i.broadcastOperationFailure;return{telemetryEndSubCode:e.code,error:e}}return i?.code?{telemetryEndSubCode:i.code,error:i}:isNaN(e.status)||e.status!==Zr.CALL_END_CODE.NOT_FOUND?!isNaN(e.status)&&e.status?{telemetryEndSubCode:e.status,error:{code:e.status,subCode:isNaN(e.response)?0:e.response,phrase:e.statusText,resultCategories:[Ir]}}:!isNaN(e.response)&&e.response?{telemetryEndSubCode:0,error:{code:0,subCode:e.response,phrase:e.statusText,resultCategories:[Ir]}}:{telemetryEndSubCode:Zr.CALL_END_CODE.NETWORK_ERROR,error:Zr.CALL_END_NETWORK_ERROR}:{telemetryEndSubCode:Zr.CALL_END_CODE.NOT_FOUND,error:Zr.RESOURCE_NOT_FOUND_ERROR}}function Ts(e,t){if(e&&!e.isEmpty()&&t){const i=e.get(Zr.HEADERS.ORIGINAL_MESSAGE_ID),n=e.get(Zr.HEADERS.MESSAGE_ID);if(n&&fs(t,n)||i&&fs(t,i))return!0;t.length>9&&t.shift(),t.push(i||n)}return!1}function Es(e){const t="unknown";return e.headers?e.headers.get(Zr.HEADERS.ORIGINAL_MESSAGE_ID,t):t}function _s(e){try{return e.headers.get(Zr.HEADERS.ORIGINAL_MESSAGE_ID).replace("-","").substr(0,8)}catch(e){return os()}}function bs(e){return e&&e.hasOwnPropertyCaseInsensitive(Zr.HEADERS.CONTENT_ENCODING)}function Ps(e){return e&&Zr.KNOWN_PAYLOAD_ENCODINGS.hasOwnProperty(e.get(Zr.HEADERS.CONTENT_ENCODING).toUpperCase())}function Is(e){const t=atob(e);return _r.inflate(t,{to:"string"})}function As(){let e,t,i=!0;return{isPending:()=>i,promise:new Promise(((i,n)=>{e=i,t=n})),resolve:t=>{i&&(e(t),i=!1)},reject:e=>{i&&(t(e),i=!1)}}}function Rs(e){let t=!1;try{if(t=e&&2===e.state(),navigator.onLine&&t)return 3;if(!navigator.onLine&&t)return 2;if(navigator.onLine&&!t)return 1}catch{}return 0}function ws(e){return[Zr.HTTP_STATUS_CODES.UNKNOWN,Zr.HTTP_STATUS_CODES.UNAUTHORIZED,Zr.HTTP_STATUS_CODES.NETWORK_ERROR,Zr.HTTP_STATUS_CODES.OFFLINE,Zr.HTTP_STATUS_CODES.TIMEOUT,Zr.HTTP_STATUS_CODES.INTERNAL_SERVER_ERROR,Zr.HTTP_STATUS_CODES.BAD_GATEWAY,Zr.HTTP_STATUS_CODES.SERVICE_UNAVAILABLE,Zr.HTTP_STATUS_CODES.GATEWAY_TIMEOUT].indexOf(e)>=0}function Ms(e,t){switch(e){case Zr.HEADERS.CAE_KEYWORD.toLowerCase():return 8;case Zr.HEADERS.AAD_KEYWORD.toLowerCase():return 4;case Zr.HEADERS.SKYPE_KEYWORD.toLowerCase():return 1;default:return t?.info("unexpected: unrecognized token type ${tokenType}"),null}}function Os(e){switch(e){case 0:return"GET";case 1:return"POST";case 2:return"PUT";case 3:return"DELETE"}}function Ds(e,t,i,n,r=!1,s,a){a?.createChild("[utils.ts]");const o={verb:Os(i),path:n.url},l=JSON.stringify(o),d=function(e){let t={};if(e){const i=ts.getHeaderValue(e,Zr.HEADERS.AUTHENTICATE);i&&(t={authenticationHeaders:[i]})}return t}(s),c=function(e,t,i,n,r){if(!t)return 1;const{callingServiceSupportsAADTokens:s,callingServiceSupportsCAETokens:a,supportMissingTokenTypesInResponse:o,useSkypeTokenWhenNoAuthenticateHeader:l}=e,d=r?.authenticationHeaders;n?.info(`[getAuthHeadersTokenTypes] UnauthorizedResponse=${i} and authHeaders=${d}`);let c=null;if(!d&&i)l?(n?.info("[getAuthHeadersTokenTypes] no www-authenticate header received, fallback to skype token"),c=1):(n?.info("[getAuthHeadersTokenTypes] Service has not provided www-authenticate headers. use client supported tokens"),c=ns(e));else if(d||i){if(d&&i)for(const t of d){const i=rs(t);if(o&&0===i.length)n?.info("[getAuthHeadersTokenTypes] Service has www-authenticate header, but no token types. Use client supported tokens"),c=ns(e);else for(const e of i){const t=Ms(e.toLowerCase(),n);a&&8===t&&(c|=8),s&&4===t&&(c|=4),1===t&&(c|=1)}}}else n?.info("[getAuthHeadersTokenTypes] first time requesting token, request client supported token types"),c=ns(e);return c}(e,t,r,a,d);return a?.info(`[getTokenMetadata] return token type=${c}, factoJson=${l}, headers=${d?.authenticationHeaders}`),{tokenType:c,factorsJson:l,requestMetadataJson:d,isUnauthorized:r}}function ks(){return Math.floor(Date.now()/1e3)}function Ns(e){return 1e3*e}function Ls(e){switch(e){case"none":return"None";case"teamPark":return"TeamPark";case"callPark":return"CallParkV2";case"serverHold":return"ServerHold";case"serverHoldV2":return"MusicOnHoldV2";case"sharedLinePark":return"SharedLinePark";case"sharedLineParkV2":return"SharedLineAppearanceV2";default:return"UnknownType"}}function xs(e){switch(e){case"raiseHands":return"raiseHands";case"ufd":return"ufd";case"attendeeModalitiesUnrestricted":return"attendeeModalitiesUnrestricted";case"attendeeAudioRestricted":return"attendeeAudioRestricted";case"attendeeVideoRestricted":return"attendeeVideoRestricted";case"attendeeVideoUnrestricted":return"attendeeVideoUnrestricted";case"spotlight":return"spotlight";case"weatherPerson":return"weatherPerson";case"sharingLayoutType":return"sharingLayoutType";case"manageBreakoutRooms":return"manageBreakoutRooms";case"togetherMode":return"togetherMode";case"consentToRecording":return"consentToRecording";case"denyConsentToRecording":return"denyConsentToRecording";case"clientMediaUfd":return"clientMediaUfd";case"serverMediaUfd":return"serverMediaUfd";default:throw"Invalid state type when converting PublishType to PublishStateType."}}function Fs(e){switch(e){case"raiseHands":return"raiseHands";case"ufd":return"ufd";case"attendeeModalitiesUnrestricted":return"attendeeModalitiesUnrestricted";case"attendeeAudioRestricted":return"attendeeAudioRestricted";case"attendeeVideoRestricted":return"attendeeVideoRestricted";case"attendeeVideoUnrestricted":return"attendeeVideoUnrestricted";case"spotlight":return"spotlight";case"weatherPerson":return"weatherPerson";case"sharingLayoutType":return"sharingLayoutType";case"manageBreakoutRooms":return"manageBreakoutRooms";case"togetherMode":return"togetherMode";case"consentToRecording":return"consentToRecording";case"denyConsentToRecording":return"denyConsentToRecording";case"clientMediaUfd":return"clientMediaUfd";case"serverMediaUfd":return"serverMediaUfd";default:throw"Invalid state type when converting PublishStateType to PublishType."}}var Us=class e{static isInLobby(e,t){for(const i of e)if(i.endpointId===t&&i.isLobby)return!0;return!1}static isParticipantServerMuted(e){for(const t of e)if(t.mediaStreams&&!t.mappedTo)for(const e of t.mediaStreams)if("audio"===e.type&&!0===e.serverMuted)return!0;return!1}static fromWireParticipant(t){return hs(t,"invalid wireParticipant"),cs(t.id,"participant must have valid Id"),new e({id:t.id,displayName:t.displayName,languageId:t.languageId,acceptedBy:t.acceptedBy})}static getPluginlessStateTypeFromWire(e){return xs(e)}static findOrCreateTypeState(e,t){let i=t.typeStates.findIndex((t=>t.type===e));if(-1===i){const n={participantStates:[],type:e};t.typeStates.push(n),i=t.typeStates.length-1}return i}static processPublishedStates(e,t){const i={typeStates:[]},n=e;return Tr.forEach(n,(e=>{const n=this.findOrCreateTypeState(this.getPluginlessStateTypeFromWire(e.stateType),i),r={id:t,publishedState:{content:e.content,stateId:e.stateId,typeRank:e.typeRank}};i.typeStates[n].participantStates.push(r)})),i}static fromRosterEndpoints(e){let t=[],i=!1,n=!1,r=!1,s=!1;return t=Object.keys(e).map((t=>{let a,o,l=[],d=!1,c=0;if(e[t].call&&(i=!0,l=e[t].call.mediaStreams||null,c=e[t].call.serverMuteVersion||0,o=e[t].call.appliedInteractivityLevel||"unknown"),e[t].lobby&&(d=!0,n=!0,l=e[t].lobby.mediaStreams||null),e[t].broadcast?.sessionInformation&&(a=e[t].broadcast.sessionInformation.role||null),e[t].mappedParticipant&&(r=!0,l=e[t].mappedParticipant.mediaStreams||null),!e[t].capabilities&&e[t].endpointCapabilities){const i=e[t].endpointCapabilities;e[t].capabilities={implicitCallback:16&i?"enabled":"disabled",cloudAudioVideoConference:1&i?"enabled":"disabled",cloudScreenSharing:2&i?"enabled":"disabled",hostlessConference:4&i?"enabled":"disabled",autoJoinOnConflict:32&i?"enabled":"disabled",serverMuteUnmute:64&i?"enabled":"disabled",supportsCompressedServicePayload:128&i?"enabled":"disabled",cloudMerge:8&i?"enabled":"disabled"}}return s=s||!!e[t].streamLobby||!!e[t].stream,{endpointId:t,participantId:e[t].participantId||null,clientVersion:e[t].clientVersion||null,endpointMetadata:e[t].endpointMetadata||null,originalId:e[t].originalId||null,contentSharing:e[t].contentSharing||null,capabilities:e[t].capabilities||null,endpointType:e[t].endpointType||"default",deviceType:e[t].deviceType||void 0,clientEndpointCapabilities:e[t].clientEndpointCapabilities||void 0,mediaStreams:l,serverMuteVersion:c,broadcastMeetingRole:a,isLobby:d,endpointState:e[t].endpointState||null,publishedStates:e[t].publishedStates||null,callLinks:e[t].callLinks||null,appliedInteractivityLevel:o||"unknown",mappedTo:e[t].mappedTo||null,meetingGroupDetails:e[t].meetingGroupDetails,streamInformation:e[t].streamInformation,propertyBag:e[t].propertyBag,streamLobby:e[t].streamLobby,stream:e[t].stream}})),{endpointDetails:t,participantHasCallModality:i,participantIsInLobby:n,participantHasMappedEndpoint:r,participantHasStreamEndpoint:s}}static fromRoster(t,i=!1){hs(t,`invalid rosterParticipant ${JSON.stringify(t)}`),cs(t.details.id,"participant must have valid Id");const n=t.endpoints||{},r=this.fromRosterEndpoints(n),s=r.endpointDetails,a=r.participantHasCallModality,o=r.participantHasMappedEndpoint,l=r.participantHasStreamEndpoint;let d=r.participantIsInLobby;return a||d||o||i||l?(a&&(d=!1),new e({id:t.details.id,displayName:t.details.displayName,version:t.version||0,propertyBag:t.details.propertyBag||null,languageId:t.details.languageId,role:t.role||"",tenantId:t.details.tenantId||"",endpointDetails:s||[],acceptedBy:t.acceptedBy||"",isLobby:d,meetingRole:t.meetingRole,advancedMeetingRole:t.advancedMeetingRole,participantType:t.details.participantType,publishedStates:t.publishedStates||null,isIdentityMasked:t.details.isIdentityMasked,nonMaskedId:t.details.nonMaskedId||"",nonMaskedObjectId:t.details.nonMaskedObjectId||"",nonMaskedDisplayName:t.details.nonMaskedDisplayName||"",maskedIdSeqNumber:t.details.maskedIdSeqNumber||0,maskedId:t.details.maskedId||"",joinAsStreamingUser:t.joinAsStreamingUser,enableCaptcha:t.enableCaptcha})):null}static fromRosterSearchResults(e){hs(e,`invalid rosterParticipant ${JSON.stringify(e)}`),cs(e.details.id,"participant must have valid Id");const t=e.endpoints,i=this.fromRosterEndpoints(t),n=i.endpointDetails,r=i.participantHasCallModality,s=i.participantIsInLobby,a=i.participantHasMappedEndpoint;let o=0;return r?o=3:s?o=10:a&&(o=3),{id:e.details.id,state:o,tenantId:e.details.tenantId||"",displayName:e.details.displayName,role:e.role||"",meetingRole:e.meetingRole,advancedMeetingRole:e.advancedMeetingRole,participantType:e.details.participantType,isServerMuted:this.isParticipantServerMuted(n),publishedStates:this.processPublishedStates(e.publishedStates,e.details.id),endpoints:n||[],isIdentityMasked:e.details.isIdentityMasked,nonMaskedId:e.details.nonMaskedId||"",nonMaskedDisplayName:e.details.nonMaskedDisplayName||"",nonMaskedObjectId:e.details.nonMaskedObjectId||"",maskedIdSeqNumber:e.details.maskedIdSeqNumber||0,maskedId:e.details.maskedId||"",joinAsStreamingUser:e.joinAsStreamingUser}}constructor(e){this.id=e.id,this.displayName=e.displayName||"",this.version=e.version,this.propertyBag=e.propertyBag,this.languageId=e.languageId||null,this.endpointDetails=e.endpointDetails||[],this.acceptedBy=e.acceptedBy,this.role=e.role,this.tenantId=e.tenantId,this.isLobby=e.isLobby,this.meetingRole=e.meetingRole,this.advancedMeetingRole=e.advancedMeetingRole,this.participantType=e.participantType,this.publishedStates=e.publishedStates,this.isIdentityMasked=e.isIdentityMasked,this.nonMaskedId=e.nonMaskedId,this.nonMaskedDisplayName=e.nonMaskedDisplayName,this.nonMaskedObjectId=e.nonMaskedObjectId,this.maskedIdSeqNumber=e.maskedIdSeqNumber,this.maskedId=e.maskedId,this.joinAsStreamingUser=e.joinAsStreamingUser,this.enableCaptcha=e.enableCaptcha}},Vs="HandleMediaAcknowledgement",Hs="HandleMediaNegotiationFailure",Bs="HandleMediaAnswer",$s="HandleMediaAnswerFailed",js="HandleMediaOffer",Gs="RejectRenegotiation",Ws="HandleRetargetCompleted",qs="HandleMediaAnswerTimeout",zs="HandleMediaAcknowledgementTimeout",Ks="AcceptRenegotiation",Js="StartRenegotiation",Ys="MediaFsmStateChanged",Qs="AddModalityTimeout",Xs="AddParticipant",Zs="AddParticipantTimeout",ea="AddParticipantWithReplaces",ta="AddParticipantWithReplacesTimeout",ia="AddParticipantsAndModality",na="AdmitParticipant",ra="AdmitParticipantTimeout",sa="Admit",aa="AdmitTimeout",oa="AdmitFailure",la="AdmitSuccess",da="CallMeBack",ca="CallMeBackTimeout",ha="RemoveParticipant",ua="RemoveParticipantOthers",pa="RemoveParticipantSpecified",ga="RemoveParticipantTimeout",ma="HandleAddParticipantSuccess",fa="HandleAddParticipantFailure",Sa="HandleAdmitParticipantSuccess",va="HandleAdmitParticipantFailure",ya="HandleAddParticipantModalityFailure",Ca="HandleRemoveParticipantSuccess",Ta="HandleRemoveParticipantFailure",Ea="HandleRosterUpdate",_a="HandleRosterUpdateFail",ba="HandleConversationUpdate",Pa="HandleLocalParticipantUpdate",Ia="SetSubject",Aa="SetJoinedFrom",Ra="SetDeviceType",wa="GetEmergencyContent",Ma="SetMultiparty",Oa="SetGroupId",Da="SetThreadId",ka="SetCallOptions",Na="SetTransferContext",La="StartCall",xa="JoinCall",Fa="JoinConversationWithoutCallModality",Ua="HandleIncomingCall",Va="EndCall",Ha="EndWithBeacon",Ba="ConflictedCall",$a="SetProvisionalAnswer",ja="SetProvisionalAnswerFailed",Ga="AcceptCall",Wa="AcceptCallFailed",qa="HandleCallAcceptanceAck",za="HandleCallAcceptance",Ka="HandleCallAcceptanceSync",Ja="HandleCallAcceptanceFailed",Ya="HandleCallEstablishmentTimeout",Qa="HandleCallEnd",Xa="HandleCallProgress",Za="TrouterUrlChanged",eo="TrouterStateChanged",to="TrouterUrlChangedToInvalid",io="TrouterUrlUpdateFailed",no="AddContentSharingModality",ro="AcceptedBeforeRinging",so="DeleteContentSharing",ao="TakeControlContentSharing",oo="UpdateSessionStateContentSharing",lo="JoinContentSharing",co="UpdateParticipantStateContentSharing",ho="HandleContentSharingUpdate",uo="HandleContentSharingEnd",po="ContentSharingStartFromRoster",go="ContentSharingEndFromRoster",mo="HandleAddModalitySuccess",fo="HandleAddModalityFailure",So="AddBroadcastModality",vo="UpdateBroadcastDetails",yo="WaitingForAddBroadcastModalityCompletion",Co="Mute",To="NudgeParticipantTimeout",Eo="Unmute",_o="UnmuteTimeout",bo="HandleUnmuteConfirm",Po="ApproveUnmute",Io="RejectUnmute",Ao="HandleControlVideoStreaming",Ro="HandleDominantSpeakerChangedCount",wo="HandleCsrcInfo",Mo="SendWebRtcMediaNotification",Oo="TransferCall",Do="ParkCall",ko="CallRedirect",No="CallRedirectRequestFailed",Lo="TransferCompletionFailed",xo="TransferRequestReceived",Fo="HandleParkRequested",Uo="DuplicateMessageIgnored",Vo="CorrelationIdUpdated",Ho="UnkownMessageType",Bo="FailedToHandleMessage",$o="ConnectivityChanged",jo="TrouterDecodePayloadFailure",Go="UpdateEndpointState",Wo="BrokerDecodePayloadFailure",qo="BrokerSubscriptionTimeout",zo="BrokerSubscriptionSuccessful",Ko="BrokerSubscriptionFailed",Jo="FailedToHandleTrouterMessage",Yo="FailedToHandleBrokerMessage",Qo="BrokerDisabledSubscribeUrlPresent",Xo="Connected",Zo="InLobby",el="Staging",tl="MessageMissingBody",il="BroadcastStateChanged",nl="HandleCallNotification",rl="HandleIncomingCallReplacement",sl="HandlePstnBalanceUpdate",al="IgnoreOldRoster",ol="HandleMediaAck",ll="HandleMediaProvisionalAck",dl="UpdateCallStatus",cl="SendAttach",hl="RequestNewOffer",ul="HandleNewOffer",pl="UpdateConversationLinks",gl="UpdateConversationLinksSuccess",ml="UpdateConversationLinksFailed",fl="ProcessInitialOffer",Sl="SendProgress",vl="SendProgressFailed",yl="ProcessCallAcceptance",Cl="AcceptanceUserInLobby",Tl="RejectIncomingCall",El="SendKeepAlive",_l="SendKeepAliveFailed",bl="StartAudio",Pl="StopAudio",Il="UpdateMeetingRole",Al="EnablingPreheat",Rl="DisablingPreheat",wl="PreheatDisabled",Ml="TransferRequestSent",Ol="CallRedirectRequestSent",Dl="TransferRequestFailed",kl="SendAcceptTransfer",Nl="SendAcceptTransferFail",Ll="WaitingForTransferCompletion",xl="WaitingForTransferCompletionFail",Fl="WaitingForTransferAcceptanceFail",Ul="WaitingForTransferAcceptance",Vl="TransferCompleted",Hl="SendCompleteTransfer",Bl="SendCompleteTransferFailed",$l="PickupCodeSet",jl="AddParticipantWithPickupCode",Gl="AddParticipantWithPickupCodeTimeout",Wl="PublishState",ql="PublishStateFailure",zl="RemoveState",Kl="RemoveStateFailure",Jl="UpdateMeetingSettings",Yl="UpdateMeetingSettingsFailure",Ql="UpdateEndpointMetadataSuccess",Xl="UpdateEndpointMetadataFailure",Zl="SearchParticipants",ed="GetAllParticipants",td="SearchParticipantsFailure",id="GetAllParticipantsFailure",nd="ParkRequestFailed",rd="WaitingForParkCompletion",sd="WaitingForParkCompletionTimeout",ad="ParkCompleted",od="ParkFailed",ld="UnparkRequestFailed",dd="WaitingForUnparkCompletion",cd="WaitingForUnparkCompletionTimeout",hd="UnparkCompleted",ud="UnparkFailed",pd="UpdateMeetingLiveState",gd="WaitingForUpdateMeetingLiveStateCompletion",md="UpdateMeetingLiveStateRequestFailed",fd="UpdateMeetingLiveStateResponseFailure",Sd="UpdateMeetingLiveStateResponseSuccess",vd="UpdateMeetingGroups",yd="UpdateParticipantInterpretationState",Cd="UpdateParticipantsProperties",Td="JoinMeetingGroup",Ed="LeaveMeetingGroup",_d="incomingProxiedMessages",bd="WaitingForUpdateMeetingGroupsCompletion",Pd="UpdateMeetingGroupsRequestFailed",Id="UpdateMeetingGroupsRequestFailure",Ad="UpdateMeetingGroupsResponseSuccess",Rd="SetMeetingLayout",wd="WaitingForSetMeetingLayoutCompletion",Md="SetMeetingLayoutRequestFailed",Od="SetMeetingLayoutResponseFailure",Dd="SetMeetingLayoutResponseSuccess",kd="UpdateParticipantInterpretationStateTimeout",Nd="UpdateParticipantInterpretationStateResponseFailed",Ld="UpdateParticipantInterpretationStateResponseCompleted",xd="UpdateParticipantsPropertiesTimeout",Fd="UpdateParticipantsPropertiesResponseFailed",Ud="UpdateParticipantsPropertiesResponseCompleted",Vd="WaitingForJoinMeetingGroupCompletion",Hd="JoinMeetingGroupRequestFailed",Bd="JoinMeetingGroupRequestFailed",$d="JoinMeetingGroupRequestCompleted",jd="WaitingForLeaveMeetingGroupCompletion",Gd="LeaveMeetingGroupRequestFailed",Wd="LeaveMeetingGroupRequestFailed",qd="LeaveMeetingGroupRequestCompleted",zd="SubscribeUrlFound",Kd="SubscribeUrlMissing",Jd="SendMessageCompletion",Yd="SendMessageTimeout",Qd="DiablePreheatSucceeded",Xd="AsyncDisablePreheatSucceeded",Zd="DiablePreheatFailed",ec="AsyncDiablePreheatFailed",tc="DisablePreheatResponseReceived",ic="StreamInformationReceived",nc="UpdateMediaDescriptions",rc="UpdateMediaDescriptionsFailed",sc="NudgeToJoinAsRealtime",ac="UpdateMeetingStates",oc="WaitingForUpdateMeetingStatesCompletion",lc="UpdateMeetingStatesResponseSuccess",dc="UpdateMeetingStatesResponseFailure",cc={SEND_MEDIA_ANSWER:{name:"SendMediaAnswer",controller:0},START_RENEGOTIATION:{name:"StartRenegotiation",controller:0},SEND_MEDIA_ACKNOWLEDGEMENT:{name:"SendMediaAcknowledgement",controller:0},SEND_MEDIA_REJECTION:{name:"SendMediaRejection",controller:0},ADD_PARTICIPANT:{name:"AddParticipant",controller:1},ADD_PARTICIPANT_WITH_REPLACES:{name:"AddParticipantWithReplaces",controller:1},NUDGE_PARTICIPANT:{name:"NudgeParticipant",controller:1},REMOVE_PARTICIPANT_NONE:{name:"RemoveParticipant",controller:1},REMOVE_PARTICIPANT_OTHERS:{name:"RemoveParticipantOthers",controller:1},REMOVE_PARTICIPANT_SPECIFIED:{name:"RemoveParticipantSpecified",controller:1},ADMIT_PARTICIPANT:{name:"AdmitParticipant",controller:1},ADMIT:{name:"Admit",controller:1},BROKER_SUBSCRIBE:{name:"BrokerSubscribe",controller:2},CALL_ME_BACK:{name:"CallMeBack",controller:1},SEND_ACCEPTANCE:{name:"SendAcceptance",controller:0},SEND_ACCEPTANCE_ACKNOWLEDGEMENT:{name:"SendAcceptanceAcknowledgement",controller:0},END_CALL:{name:"EndCall",controller:1},CANCEL_CALL:{name:"CancelCall",controller:1},REJECT_CALL:{name:"RejectCall",controller:0},JOIN_CONVERSATION:{name:"JoinConversation",controller:1},JOIN_CONVERSATION_WITHOUT_CALL_MODALITY:{name:"JoinConversationWithoutCallModality",controller:1},LEAVE_CONVERSATION:{name:"LeaveConversation",controller:1},DELETE_CONVERSATION:{name:"DeleteConversation",controller:1},START_CALL:{name:"StartCall",controller:1},PLACE_NUDGE_CALL:{name:"PlaceNudgeCall",controller:5},UPDATE_CONVERSATION_LINKS:{name:"UpdateConversationLinks",controller:1},SEND_CONVERSATION_KEEP_ALIVE:{name:"SendConversationKeepAlive",controller:1},SEND_CALL_ATTACH:{name:"SendCallAttach",controller:0},SEND_CALL_PROGRESS:{name:"SendCallProgress",controller:0},SEND_KEEP_ALIVE:{name:"SendKeepAlive",controller:0},ADD_CONTENT_SHARING_MODALITY:{name:"AddContentSharingModality",controller:1},DELETE_CONTENT_SHARING:{name:"DeleteContentSharing",controller:3},TAKE_CONTROL_CONTENT_SHARING:{name:"TakeControlContentSharing",controller:3},UPDATE_SESSION_STATE_CONTENT_SHARING:{name:"UpdateSessionStateContentSharing",controller:3},JOIN_CONTENT_SHARING:{name:"JoinContentSharing",controller:3},UPDATE_PARTICIPANT_STATE_CONTENT_SHARING:{name:"UpdateParticipantStateContentSharing",controller:3},UPDATE_CONTENT_SHARING_NOTIFICATION_LINKS:{name:"UpdateContentSharingNotificationLinks",controller:3},MUTE_ALL:{name:"MuteAll",controller:1},MUTE_ALL_SYNC:{name:"MuteAllSync",controller:1},MUTE_SPECIFIED:{name:"MuteSpecified",controller:1},MUTE_SPECIFIED_SYNC:{name:"MuteSpecifiedSync",controller:1},MUTE_MYSELF:{name:"MuteMyself",controller:1},UNMUTE:{name:"Unmute",controller:1},UNMUTE_SYNC:{name:"UnmuteMyselfSync",controller:1},SEND_CONTROL_VIDEO_STREAMING:{name:"SendControlVideoStreaming",controller:0},SEND_APPLY_CHANNEL_PARAMETERS:{name:"SendApplyChannelParameters",controller:0},APPROVE_UNMUTE:{name:"ApproveUnmute",controller:5},REJECT_UNMUTE:{name:"RejectUnmute",controller:5},SEND_CALL_REDIRECT_REQUEST:{name:"SendCallRedirectRequest",controller:0},SEND_TRANSFER_REQUEST:{name:"SendTransferRequest",controller:0},SEND_PARK_REQUEST:{name:"SendParkRequest",controller:0},SEND_SHARED_LINE_PARK_REQUEST:{name:"SharedLinePark",controller:0},SEND_SERVER_HOLD_REQUEST:{name:"ServerHoldRequest",controller:0},PARK_REQUEST:{name:"ParkRequest",controller:0},SEND_UNPARK_REQUEST:{name:"UnparkRequest",controller:0},TRANSFER_ACCEPTANCE:{name:"TransferAcceptance",controller:0},TRANSFER_COMPLETION:{name:"TransferCompletion",controller:0},TRANSFER_COMPLETION_FAILED:{name:"TransferCompletionFailed",controller:0},UPDATE_ENDPOINT_STATE:{name:"UpdateEndpointState",controller:1},DISABLE_PREHEAT:{name:"DisablePreheat",controller:5},REQUEST_NEW_OFFER:{name:"RequestNewOffer",controller:0},UPDATE_ENDPOINT_METADATA:{name:"UpdateEndpointMetadata",controller:1},UPDATE_MEETING_ROLE_ATTENDEE:{name:"UpdateMeetingRoleToAttendee",controller:1},UPDATE_MEETING_ROLE_PRESENTER:{name:"UpdateMeetingRoleToPresenter",controller:1},UPDATE_MEETING_ROLE_ORGANIZER:{name:"UpdateMeetingRoleToOrganizer",controller:1},ADD_PARTICIPANT_WITH_PICKUP_CODE:{name:"AddParticipantWithPickupCode",controller:1},PUBLISH_STATE:{name:"PublishState",controller:1},REMOVE_STATE:{name:"RemoveState",controller:1},UPDATE_MEETING_SETTINGS:{name:"UpdateMeetingSettings",controller:1},ADD_PARTICIPANTS_AND_MODALITY:{name:"AddParticipantsAndModality",controller:1},ADD_BROADCAST_MODALITY:{name:"AddBroadcastModality",controller:1},SEARCH_PARTICIPANTS:{name:"SearchParticipants",controller:1},GET_ALL_PARTICIPANTS:{name:"GetAllParticipants",controller:1},UPDATE_MEETING_LIVE_STATE:{name:"UpdateMeetingLiveState",controller:1},UPDATE_MEETING_GROUPS:{name:"UpdateMeetingGroups",controller:1},SET_MEETING_LAYOUT:{name:"SetMeetingLayout",controller:1},UPDATE_PARTICIPANT_INTERPRETATION_STATE:{name:"UpdateParticipantInterpretationState",controller:1},JOIN_MEETING_GROUP:{name:"JoinMeetingGroup",controller:1},LEAVE_MEETING_GROUP:{name:"LeaveMeetingGroup",controller:1},SEND_PROXIED_MESSAGE:{name:"SendProxiedMessage",controller:1},UPDATE_PARTICIPANTS_PROPERTIES:{name:"UpdateParticipantsProperties",controller:1},UPDATE_MEDIA_DESCRIPTIONS:{name:"UpdateMediaDescriptions",controller:0},UPDATE_MEETING_STATES:{name:"UpdateMeetingStates",controller:1}},hc={EVENT_SOURCE:{TROUTER:"Trouter",BROKER:"Broker",UDP:"UDP",LOCAL:"Local"},SOURCE:{NGC_SOURCE:"SkypeConcore"},EVENT_TYPE:{CONVERSATION_CALL_MODALITY:"skypecosi_concore_web_csa_conversation_callmodality",CONVERSATION_CONTENT_SHARING:"skypecosi_concore_web_csa_conversation_contentsharing",CONVERSATION_HTTP_REQUEST:"skypecosi_concore_web_csa_conversation_httprequest",CONVERSATION_TOKEN:"skypecosi_concore_web_csa_conversation_token"},EXTENSIONS:{DATA_VERSION:"DataVersion",DIRECTION:"Direction",CONTENT_SHARING_DIRECTION:"ContentSharingDirection",CONNECTED_DURATION_IN_MS:"ConnectedDurationInMsecs",PREHEATED_CALL_SETUP_DURATION_IN_S:"PreheatedCallSetupDurationInSeconds",CALL_CANCELATION_DURATION_IN_S:"CallCancelationDurationInSeconds",IS_PREHEATED:"IsPreheated",TIME_TO_RING_IN_MS:"TimeToRingInMsecs",CALL_TERMINATING_END:"CallTerminatingEnd",NETWORK_REQUESTS_PENDING:"NetworkRequestsPending",NETWORK_REQUESTS_COMPLETED:"NetworkRequestsCompleted",LOCAL_OPERATIONS_PERFORMED:"LocalOperationsPerformed",TROUTER_WAIT_OPERATIONS:"TrouterWaitOperations",CALL_START_TIME:"CallStartTime",CALL_END_TIME:"CallEndTime",IS_GROUP_CALL:"IsGroupCall",IS_HOSTLESS_CALL:"IsHostLessCall",IS_CAST_CALL:"IsCastCall",IS_HUDDLE_GROUP_CALL:"IsHuddleGroupCall",IS_MEETUP_CALL:"IsMeetupCall",IS_ON_BEHALF_OF_CALL:"IsOnBehalfOfCall",IS_SDP_IN_CALL_NOTIFICATION:"SdpInCallNotification",CALL_END_CODE:"Code",CALL_END_SUB_CODE:"SubCode",CALL_PHRASE:"Phrase",CALL_END_RESULT_CATEGORIES:"ResultCategories",CALL_END_CAUSE_ID:"CauseId",CONTENT_SHARING_END_CODE:"ContentSharingEndReasonServiceCode",CONTENT_SHARING_END_SUB_CODE:"ContentSharingEndReasonServiceSubCode",CONVERSATION_SERVICE_URL:"ConversationServiceUrl",CONTENT_SHARING_SERVICE_URL:"ContentSharingServiceUrl",MEETING_INFO:"MeetingInfo",JOINED_FROM:"JoinedFrom",RESULT_VALUE:"ResultValue",RESULT_DETAIL:"ResultDetail",RESULT_CAUSE_ID:"ResultCauseId",RESULT_CODE:"ResultCode",LOCAL_OFFER_ANSWER_GENERATION_TIMESTAMPS:"LocalOfferAnswerGenerationTimestamps",SELF_PARTICIPANT_ROLE:"SelfParticipantRole",SCENARIO:"Scenario",CALLER_TYPE:"Caller_Type",CALLEE_TYPE:"Callee_Type",CALL_TYPE:"Call_Type",TEST_CONTEXT_ID:"Test_Context_Id",OUTGOING_MODALITIES:"Outgoing_Modalities",INCOMING_MODALITIES:"Incoming_Modalities",OFFERED_MODALITIES:"CallOfferredModalities",ANSWERED_MODALITIES:"CallAnsweredModalities",VBSS_OPERATIONS:"VBSS_Operations",CHANGING_CORRELATION_ID_NEW_ID:"ChangingCorrelationId_NewId",CHANGING_CORRELATION_ID_OLD_ID:"ChangingCorrelationId_OldId",MESSAGING_CHANNEL:"MessagingChannel",EVENT_TIMESTAMP_BAG:"EventTimestampBag",ROSTER_UPDATES_BAG:"RosterUpdatesBag",NETWORK_REQUESTS_BAG:"NetworkRequestBag",CLIENT_INFORMATION:"ClientInformation",ECS_ETAG:"EcsEtag",APPLICATION_TYPE:"ApplicationType",RING:"Ring",TENANT_ID:"TenantId",USER_HEX_CID:"UserHexCID",ACS_RESOURCE_ID:"AcsResourceId",REGION:"Region",PARTITION:"Partition",CALL_END_CLIENT_SUB_CODE:"CallEventCallEndClientSubCode",CALL_END_CLIENT_PHRASE:"CallEventCallEndClientPhrase",MEETING_CODE:"MeetingCode",MEETING_URL:"MeetingJoinUrl",BROADCAST_MEETING_ROLE:"BroadcastMeetingRole",MEETING_ROLE:"MeetingRole",ADVANCED_MEETING_ROLE:"AdvancedMeetingRole",PARTICIPANT_TYPE:"ParticipantType",AUDIO_ONLY_WATERMARK:"ClientSupportsAudioOnlyWatermark",CLIENT_SUPPORT_WATERMARK:"ClientSupportsWatermark",TARGET_APPLICATION_TYPE:"TargetApplicationType",IS_REINVITELESS:"IsReinviteless",CLIENT_TYPE:"ClientType"},MESSAGING_CHANNEL:{TROUTER:"Trouter",BROKER:"Broker"},SIGNALING_CONFIG:"JsCsaConfig",SIGNALING_CONFIG_FLAGS:{BROKER_OUTGOING_ENABLED:"BrokerOutgoingEnabled",BROKER_INCOMING_ENABLED:"BrokerIncomingEnabled",BROKER_REQUEST_BATCHING_ENABLED:"BrokerRequestBatchingEnabled",BROKER_EXCLUSIVELY_ENABLED:"BrokerExclusivelyEnabled",SUPPORTS_COMPRESSED_PAYLOAD:"SupportsCompressedPayload",SYNC_TROUTER_RESPONSE:"SyncTrouterResponse",SERVER_MUTE_UNMUTE:"serverMuteUnmute",HANDLE_OFFER_FROM_NOTIFICATION:"handleMediaOfferFromPushNotification",HANDLE_NEW_OFFER_REQUEST:"handleNewOfferRequest",SEND_PROGRESS_FROM_CC:"sendProgressFromCC",INTERNAL_HTTP_DISPATCHER:"internalHttpDispatcher",ENABLE_TOKEN_CACHE:"enableTokenCache",ENABLE_TOKEN_PREFETCH:"enableTokenPrefetch",REQUEST_HEDGING:"requestHedging",SUPPORT_MEDIA_RETARGET_WHILE_INCOMING_RENEGOTIATION:"supportMediaRetargetWhileIncomingRenegotiation",ENABLE_ERROR_CODE_IMPROVEMENTS_FOR_NETWORK_FAILURES:"enableErrorCodeImprovementsForNetworkFailures",ENABLE_CALL_ESTABLISHMENT_TIMEOUTS_FOR_START_OR_JOIN_CALL:"enableCallEstablishmentTimeoutsForStartJoinCall",ENABLE_TOKEN_CACHE_FOR_GENERIC_TOKEN_API:"enableTokenCacheForGenericTokenAPI",ENABLE_LONG_OUTGOING_1TO1_SETUP:"enableLongOutgoing1To1SetupTimeoutForWeb"},CONTEXT_ID:{CORRELATION_ID:"CorrelationId",SHARED_CORRELATION_ID:"SharedCorrelationId",SIGNALING_SESSION_ID:"SignalingSessionId",GROUP_ID:"GroupId",THREAD_ID:"ThreadId",TEAMS_MESSAGEID:"TeamsMessageId",TEAMS_MEETINGINFO:"TeamsMeetingInfo",ENDPOINT_ID:"EndpointId",PARTICIPANT_ID:"ParticipantId",DATA_VERSION:"DataVersion",CONTENT_SHARING_ID:"ContentSharingSessionId",CONTENT_SHARING_CORRELATION_ID:"ContentSharingCorrelationId"},CALL_TERMINATING_END:{LOCAL:"Local",REMOTE:"Remote"},RESULT_VALUE:{SUCCESS:"Success",FAILURE:"Failure"},DIRECTION:{INCOMING:"Incoming",OUTGOING:"Outgoing"},ROLE:{CALLER:"caller",CALLEE:"callee",JOIN:"join",JOIN_FOR_ROSTER_ONLY:"joinForRosterOnly",PREHEAT:"preheat"},VBSS_OPERATION:{START:"Start",STOP:"Stop",REJECTED:"Rejected",REMOTE_START:"RemoteStart",TIMEOUT:"Timeout",CALL_END:"CallEnd"},LOCAL_OFFER_ANSWER_OPERATIONS:{INITIAL_OFFER_GENERATION_STARTED:"InitialOfferGenerationStarted",INITIAL_OFFER_GENERATION_ENDED:"InitialOfferGenerationEnded",FINAL_ANSWER_PROCESSING_STARTED:"FinalAnswerProcessingStarted",FINAL_ANSWER_PROCESSING_ENDED:"FinalAnswerProcessingEnded",PROVISIONAL_ANSWER_PROCESSING_STARTED:"ProvisonalAnswerProcessingStarted",PROVISIONAL_ANSWER_PROCESSING_ENDED:"ProvisonalAnswerProcessingEnded",NEGOTIATION_COMPLETED:"NegotiationCompleted",INITIAL_OFFER_PROCESSING_STARTED:"InitialOfferProcessingStarted",INITIAL_OFFER_PROCESSING_ENDED:"InitialOfferProcessingEnded",FINAL_ANSWER_GENERATION_STARTED:"FinalAnswerGenerationStarted",FINAL_ANSWER_GENERATION_ENDED:"FinalAnswerGenerationEnded",PROVISIONAL_ANSWER_GENERATION_STARTED:"ProvisionalAnswerGenerationStarted",PROVISIONAL_ANSWER_GENERATION_ENDED:"ProvisionalAnswerGenerationEnded",RENEGOTIATION_OFFER_GENERATION_STARTED:"RenegotiationOfferGenerationStarted",RENEGOTIATION_OFFER_GENERATION_ENDED:"RenegotiationOfferGenerationEnded",RENEGOTIATION_ANSWER_PROCESSING_STARTED:"RenegotiationAnswerProcessingStarted",RENEGOTIATION_ANSWER_PROCESSING_ENDED:"RenegotiationAnswerProcessingEnded",RENEGOTIATION_OFFER_PROCESSING_STARTED:"RenegotiationOfferProcessingStarted",RENEGOTIATION_OFFER_PROCESSING_ENDED:"RenegotiationOfferProcessingEnded",RENEGOTIATION_ANSWER_GENERATION_STARTED:"RenegotiationAnswerGenerationStarted",RENEGOTIATION_ANSWER_GENERATION_ENDED:"RenegotiationAnswerGenerationEnded"},TROUTER_WAIT_OPERATION:{STARTED:"Started",ENDED:"Ended",FAILED:"Failed"},TOKEN_TELEMETRY_EVENT:{TOKEN_TELEMETRY:"TokenTelemetry"}};function uc(e){var t,i;e.cloudScreenSharingFlag="disabled"===e.cloudScreenSharingFlag?e.cloudScreenSharingFlag:"enabled",e.isWebRtcEnabled="undefined"==typeof RTCIceGatherer,e.shouldServiceSendNGCUpgradeMessages=pc(e.shouldServiceSendNGCUpgradeMessages,!0),e.isGVCOutgoingEnabled=pc(e.isGVCOutgoingEnabled,!0),e.supportsCompressedServicePayload=pc(e.supportsCompressedServicePayload,!0),e.supportsSynchronousTrouterResponse=pc(e.supportsSynchronousTrouterResponse,!0),e.supportsHostlessGroupCalls=pc(e.supportsHostlessGroupCalls,!0),e.doHostlessCalling=pc(e.doHostlessCalling,!1),e.brokerExclusively=pc(e.brokerExclusively,!1),e.brokerEnabledOutgoing=pc(e.brokerEnabledOutgoing,!0),e.brokerEnabledIncoming=pc(e.brokerEnabledIncoming,!0),e.brokerRequestBatching=pc(e.brokerRequestBatching,!0),e.handleMediaOfferFromPushNotification=pc(e.handleMediaOfferFromPushNotification,!0),e.handleNewOfferRequest=pc(e.handleNewOfferRequest,!1),e.autoJoinOnConflict=pc(e.autoJoinOnConflict,!0),e.endConflictedCall=pc(e.endConflictedCall,!1),e.autoResolveConflictedCall=pc(e.autoResolveConflictedCall,!1),e.shouldServiceSendCallEventMessages=pc(e.shouldServiceSendCallEventMessages,!1),e.forceTrouterReconnectOnNetworkOnline=pc(e.forceTrouterReconnectOnNetworkOnline,!0),e.attemptHttpRequestWithCachedSkypetoken=pc(e.attemptHttpRequestWithCachedSkypetoken,!0),e.useInternalHttpDispatcher=pc(e.useInternalHttpDispatcher,!1),e.enableTokenCache=pc(e.enableTokenCache,!1),e.enableTokenPrefetch=pc(e.enableTokenPrefetch,!1),e.hedgeDelayMs=pc(e.hedgeDelayMs,4e3),e.hedgeMaxParallelAttempts=pc(e.hedgeMaxParallelAttempts,3),e.useInternalHttpDispatcher&&(e.httpRequestDispatcher=new We(e.logger)),e.enableQuickSendAcceptanceAck=pc(e.enableQuickSendAcceptanceAck,!1),e.supportMediaRetargetWhileIncomingRenegotiation=pc(e.supportMediaRetargetWhileIncomingRenegotiation,!1),e.callingServiceSupportsAADTokens=pc(e.callingServiceSupportsAADTokens,!1),e.callingServiceSupportsCAETokens=pc(e.callingServiceSupportsCAETokens,!1),e.aadTokenExpirationTimeInSeconds=pc(e.aadTokenExpirationTimeInSeconds,3600),e.caeTokenExpirationTimeInSeconds=pc(e.caeTokenExpirationTimeInSeconds,86400),e.disableTokenMigrationHeader=pc(e.disableTokenMigrationHeader,!1),e.enablePublishTokenTelemetry=pc(e.enablePublishTokenTelemetry,!1),e.forceClearExpiredTokens=pc(e.forceClearExpiredTokens,!1),e.enableRefreshToken=pc(e.enableRefreshToken,!0),e.refreshTimeBeforeTokenTimeoutInSeconds=pc(e.refreshTimeBeforeTokenTimeoutInSeconds,30),e.enableCallEstablishmentTimeoutsForStartJoinCall=pc(e.enableCallEstablishmentTimeoutsForStartJoinCall,!1),e.csaTimeoutConfiguration=(t=e.csaTimeoutConfiguration,((i={conversationKeepAliveTimeoutSec:2700,promotionUnmuteTimeoutSec:1e4})||t)&&{...i,...t}),e.reportPreviousErrorsForTimeout=pc(e.reportPreviousErrorsForTimeout,!1),e.callingTokenLogicalUrl=pc(e.callingTokenLogicalUrl,"https://calling.teams.microsoft.com"),e.enableAsyncDisablePreheat=pc(e.enableAsyncDisablePreheat,!1),e.forceLowercaseHttpHeaders=pc(e.forceLowercaseHttpHeaders,!1),e.enableResolveScreenSharingWhenNegotiationComplete=pc(e.enableResolveScreenSharingWhenNegotiationComplete,!1),e.maxReinvitelessMediaForVideoForWeb=pc(e.maxReinvitelessMediaForVideoForWeb,0),e.maxReinvitelessMediaForVBSSForWeb=pc(e.maxReinvitelessMediaForVBSSForWeb,0),e.enableRefreshTokenRetry=pc(e.enableRefreshTokenRetry,!0),e.enableRefreshTokenRetryInSeconds=pc(e.enableRefreshTokenRetryInSeconds,60),e.enableConversationTypeUpdateOnCallEnd=pc(e.enableConversationTypeUpdateOnCallEnd,!1),e.supportMissingTokenTypesInResponse=pc(e.supportMissingTokenTypesInResponse,!0),e.useSkypeTokenWhenNoAuthenticateHeader=pc(e.useSkypeTokenWhenNoAuthenticateHeader,!1),e.enableAutoPromotion=pc(e.enableAutoPromotion,!1),e.enableBatchedSendMessageStatus=pc(e.enableBatchedSendMessageStatus,!1),e.enableBatchedReceiveMessage=pc(e.enableBatchedReceiveMessage,!1),e.enableAddParticipantEnhancements=pc(e.enableAddParticipantEnhancements,!1),e.enableTokenCacheForGenericTokenAPI=pc(e.enableTokenCacheForGenericTokenAPI,!1),e.disableRealTimeModeFromRoster=pc(e.disableRealTimeModeFromRoster,!0),e.enableLongOutgoing1To1SetupTimeoutForWeb=pc(e.enableLongOutgoing1To1SetupTimeoutForWeb,!1)}function pc(e,t){return null==e?t:e}var gc=class{constructor(){this.skypeTokenContext={},this.aadTokenContext={},this.caeTokenContext={}}getTokenContext(e){return 4===e?this.aadTokenContext:8===e?this.caeTokenContext:1===e?this.skypeTokenContext:void 0}getTokenExpiry(e,t){return 4===e?this.aadTokenContext?.expiryTime:8===e?this.caeTokenContext?.expiryTime:1===e?this.skypeTokenContext?.expiryTime:(t.info("[getTokenExpiry] unrecognized token type, return Number.MAX_VALUE"),Number.MAX_VALUE)}getToken(e,t,i,n){return 8&e&&this.caeTokenContext?.token&&this.caeTokenContext.token!==n?{token:this.caeTokenContext.token,tokenType:8}:4&e&&this.aadTokenContext?.token&&this.aadTokenContext.token!==n?{token:this.aadTokenContext.token,tokenType:4}:1&e&&this.skypeTokenContext?.token&&this.skypeTokenContext.token!==n?{token:this.skypeTokenContext.token,tokenType:1}:(i.info("[getToken] no cached token found of token type: ${tokenType}"),null)}setToken(e,t,i,n){switch(e){case 4:this.aadTokenContext.factorsJson=i,this.aadTokenContext.tokenType=e,this.aadTokenContext.token=t,this.aadTokenContext.expiryTime=n;break;case 1:this.skypeTokenContext.factorsJson=i,this.skypeTokenContext.tokenType=e,this.skypeTokenContext.token=t,this.skypeTokenContext.expiryTime=n;break;case 8:this.caeTokenContext.factorsJson=i,this.caeTokenContext.tokenType=e,this.caeTokenContext.token=t,this.caeTokenContext.expiryTime=n;break;default:throw new Error(`Invalid tokenType ${e}`)}}clearExpiredTokens(e){const t=Math.round(Date.now()/1e3);this.caeTokenContext?.expiryTime<=t&&(this.resetToken(8),e?.info("[cacheTokenManager] reset expired cae token")),this.aadTokenContext?.expiryTime<=t&&(this.resetToken(4),e?.info("[cacheTokenManager] reset expired aad token")),this.skypeTokenContext?.expiryTime<=t&&(this.resetToken(1),e?.info("[cacheTokenManager] reset expired skype token"))}resetToken(e){8===e?this.caeTokenContext={}:4===e?this.aadTokenContext={}:1===e&&(this.skypeTokenContext={})}},mc=class{constructor(e){this.timers={},this.startTimer=(e,t,i,n)=>{this.logger.info(`startTimer called for :  ${e}`);const r=window.setTimeout(t,1e3*i),s=n?`${e}${n}`:e;this.timers[s]=r},this.stopTimer=(e,t)=>{this.logger.info(`stopTimer called for : ${e}`);const i=t?`${e}${t}`:e;this.timers.hasOwnProperty(i)&&(clearTimeout(this.timers[i]),delete this.timers[i])},this.dispose=()=>{this.logger.info("timeoutManager :: dispose"),Object.keys(this.timers).forEach((e=>{this.stopTimer(e)}))},this.logger=e}},fc=class{constructor(e,t,i,n){this.tokenProvider=t,this.tokenCachingEnabled=!1,this.enableTokenCacheForGenericTokenAPI=!1,this.cachedToken="",this.lastTokenType=1,this.lastToken="",this.clientSupportsGenericTokenAPI=!1,this.stopTimerFlag=!1,this.tokensPromiseMap={},this.logger=e.createChild("TokenManager"),i&&this.updateTokenSettings(i),this.cacheTimers=new mc(e),this.cacheTokenManager=new gc,this.telemetryManager=n,this.nextRefreshTimePointInSeconds=Number.MAX_VALUE}deletePromisesByTriggeredByRefresh(e,t){if(this.tokensPromiseMap[e]){const i=this.tokensPromiseMap[e];for(let n=i.length-1;n>=0;n--)i[n]?.tokenRequestOptions.triggeredByRefresh===t&&this.tokensPromiseMap[e].splice(n,1)}}startTokenRefreshTimer(e){const t="startTokenRefreshTimer";if(!this.enableRefreshToken)return void this.logger.info("[startTokenRefreshTimer] token refresh is disabled");if(this.stopTimerFlag)return this.logger.info("[startTokenRefreshTimer] stopTimerFlag=true so cancel timer"),void this.cacheTimers.dispose();this.logger.info(`[startTokenRefreshTimer] starting token refresh timer timeToStartInMilliseconds=${e}`);const i=ks(),n=e/1e3,r=i+n;this.nextRefreshTimePointInSeconds===Number.MAX_VALUE||this.nextRefreshTimePointInSeconds<i||r<this.nextRefreshTimePointInSeconds?(this.logger.info("[startTokenRefreshTimer] cancelling current refresh timer to create new one with shorter time"),this.cacheTimers.stopTimer(t),this.nextRefreshTimePointInSeconds=r,this.logger.info(`[startTokenRefreshTimer] start new timer with timeout=${n} at time=${i}`),this.cacheTimers.startTimer(t,(()=>{this.nextRefreshTimePointInSeconds=Number.MAX_VALUE,this.refreshToken()}),n)):this.logger.info("[startTokenRefreshTimer] no need to set a new refresh timer")}async refreshTokenWithContext(e){const t={triggeredByRefresh:!0},i=ls(),n={causeId:i},r=Date.now();let s,a,o,l=2;this.logger.info(`[${i}][refreshTokenWithContext] refreshing token tokenType=${e.tokenType} factorsJson=${e.factorsJson}`);try{const t=this.onTokenRequired({factorsJson:e.factorsJson,tokenType:e.tokenType,requestMetadataJson:n,invalidToken:void 0,isUnauthorized:void 0,triggeredByRefresh:!0}),r=await this.timeoutPromiseRace(t,this.enableRefreshTokenRetryInSeconds,"ActiveRefresh Token Timeout");s=Date.now(),o=r?.causeId,this.lastTokenType=r?.tokenType,l=1,s=Date.now(),this.logger.info(`[${i}][refreshTokenWithContext] refresh token success for factorsJson ${e.factorsJson} and tokenType ${e.tokenType}`)}catch(t){a=t,o=a?.causeId,t?.timeOut?(this.logger.info(`[${i}][refreshTokenWithContext] refresh token timeout, UI did not respond with token in time ${Ve(t)}`),l=5):(this.logger.info(`[${i}][refreshTokenWithContext] failed to refresh token, UI did not respond with token ${Ve(t)}`),l=2),s=Date.now(),this.deletePromisesByTriggeredByRefresh(e.factorsJson,!0)}finally{t&&(t.requestCauseId=i,t.responseCauseId=o,t.supportTokenApi=this.clientSupportsGenericTokenAPI,t.requestTokenFactors=e.factorsJson,t.tokenRequestTime=r,t.tokenResponseTime=s,t.tokenRequestStatus=l,t.requestTokenType=e.tokenType,t.foundInCache=!1,t.responseTokenType=e.tokenType,t.errorCode=a?.errorCode,t.errorSubCode=a?.errorSubCode,this.sendTokenTelemetry(t))}}refreshToken(){const e=this.cacheTokenManager.getTokenContext(4),t=this.cacheTokenManager.getTokenContext(8),i=this.cacheTokenManager.getTokenContext(1);if(!this.clientSupportsGenericTokenAPI)return void this.logger.info("[refreshToken] new Token Api is not spported");if(!e&&!t&&!i)return void this.logger.info("[refreshToken] no cached tokens available to refresh");const n=ks()+this.refreshTimeBeforeTokenTimeoutInSeconds;let r=Number.MAX_VALUE,s=!1;if(e)if(e.expiryTime>n){const t=e?.expiryTime-n;t<r&&(r=t)}else e.expiryTime<=n&&(this.refreshTokenWithContext(e),s=!0);if(t)if(t.expiryTime>n){const e=t?.expiryTime-n;e<r&&(r=e)}else t.expiryTime<=n&&(this.refreshTokenWithContext(t),s=!0);if(i)if(i.expiryTime>n){const e=i?.expiryTime-n;e<r&&(r=e)}else i.expiryTime<=n&&(this.refreshTokenWithContext(i),s=!0);s&&this.enableRefreshTokenRetry&&this.enableRefreshTokenRetryInSeconds>0&&this.enableRefreshTokenRetryInSeconds<r&&(r=this.enableRefreshTokenRetryInSeconds),r>=0&&r!==Number.MAX_VALUE&&this.startTokenRefreshTimer(Ns(r))}async getTokenWithTokenType(e,t=!1,i,n){this.logger.info(`[${e}][getTokenWithTokenType] call with factorJson=${i?.factorsJson} and request tokenType ${i?.tokenType}`);const{factorsJson:r,requestMetadataJson:s,invalidToken:a,isUnauthorized:o}=i||{},l=Date.now(),d=i?.tokenType;let c,h,u,p=2;this.clearExpiredTokens(),this.startTokenRefreshTimer(1);try{if(t)this.invalidateCachedTokenWithTokenType(d,a,r);else if(this.enableTokenCacheForGenericTokenAPI){const t=this.cacheTokenManager.getToken(d,r,this.logger,a);if(t?.token)return this.logger.info(`[${e}][getTokenWithTokenType] returning cached token for factorsJson ${r} and request tokenType ${d}, response tokenType ${t.tokenType}`),p=3,c=Date.now(),this.lastTokenType=t.tokenType,t}this.logger.info(`[${e}][getTokenWithTokenType] fetching new token for factorsJson ${r} and tokenType ${d}`);const i=s||{};i.causeId=e;const n=this.onTokenRequired({factorsJson:r,tokenType:d,requestMetadataJson:i,invalidToken:a,isUnauthorized:o,triggeredByRefresh:!1}),l=await this.timeoutPromiseRace(n,Zr.TIMEOUT_VALUES_IN_SECONDS.TOKEN_REQUIRED_TIMEOUT,"Token not received from UI in time");return c=Date.now(),u=l?.causeId,this.lastTokenType=l?.tokenType,p=1,this.logger.info(`[${e}][getTokenWithTokenType] fetching new token success for factorsJson ${r} and tokenType ${d}`),l}catch(t){throw this.logger.info(`[${e}][getTokenWithTokenType] failed to fetch token ${Ve(t)}`),h=t,u=h?.causeId,h.timeOut&&(p=4),this.deletePromisesByTriggeredByRefresh(r,!1),t}finally{const t=!n?.tokenTelemetryData,r=t?{}:n?.tokenTelemetryData;r&&(r.requestCauseId=e,r.responseCauseId=u,r.supportTokenApi=this.clientSupportsGenericTokenAPI,r.requestTokenFactors=i?.factorsJson,r.tokenRequestTime=l,r.tokenResponseTime=c,r.tokenRequestStatus=p,r.requestTokenType=i?.tokenType,r.foundInCache=3===p,r.responseTokenType=this.lastTokenType,r.timeToResponse=c?c-l:c,r.errorCode=h?.errorCode,r.errorSubCode=h?.errorSubCode),(!n||t&&!n.signalingSession)&&(this.logger.info("[getTokenWithTokenType] TokenContext is not provided, sending token telemetry to Token table"),this.sendTokenTelemetry(r))}}async onTokenRequired(e){const{factorsJson:t,tokenType:i,requestMetadataJson:n,invalidToken:r,isUnauthorized:s,triggeredByRefresh:a}=e;if(this.logger.info(`[onTokenRequired] factorsJson=${t} tokenType=${i}`),!i)return this.logger.info(`[onTokenRequired] factorsJson=${t} with no token type`),Promise.reject({errorCode:Zr.HTTP_STATUS_CODES.UNAUTHORIZED,errorSubCode:0,causeId:n?.causeId});if(this.tokensPromiseMap[t]&&!a)for(const e of this.tokensPromiseMap[t])if(e.tokenRequestOptions.tokenType===i)return this.logger.info(`[onTokenRequired] factorsJson=${t} and tokenType ${i} has pending request`),e.defered.promise;this.tokensPromiseMap[t]||(this.tokensPromiseMap[t]=[]);const o=Ei();return this.tokensPromiseMap[t].push({tokenRequestOptions:e,defered:o}),this.tokenCallback({factorsJson:t,tokenType:i,requestMetadataJson:n,invalidToken:r,isUnauthorized:s}),o.promise}setTokenCaching(e,t){this.tokenCachingEnabled!==e&&(this.logger.info(`[authTokenManager]setTokenCaching=${e}`),this.tokenCachingEnabled=e)}setTokenCachingForGenericTokenAPI(e,t){this.enableTokenCacheForGenericTokenAPI!==e&&(this.logger.info(`[authTokenManager]setTokenCachingForGenericTokenAPI=${e}`),this.enableTokenCacheForGenericTokenAPI=e)}calculateTokenExpiry(e,t,i){const{factorsJson:n,tokenType:r}=t;let s=i-ks(),a=s,o=i;if(s&&s>0&&s>this.refreshTimeBeforeTokenTimeoutInSeconds){switch(r){case 4:s>this.aadTokenExpirationTimeInSeconds&&(s=this.aadTokenExpirationTimeInSeconds);break;case 8:s>this.caeTokenExpirationTimeInSeconds&&(s=this.caeTokenExpirationTimeInSeconds);break;default:s>3600&&(s=3600)}a=s-this.refreshTimeBeforeTokenTimeoutInSeconds,o=a+ks()}return this.logger.info(`[${e}][calculateTokenExpiry] calculate expiry to ${o} tokenType=${r} factorsJson=${n}`),o}addToCache(e,t,i,n){this.clearExpiredTokens(),this.cacheTokenManager.setToken(e,t,i,n)}clearExpiredTokens(){this.forceClearExpiredTokens&&this.cacheTokenManager.clearExpiredTokens(this.logger)}async getToken(e,t=!1,i,n){if(this.clientSupportsGenericTokenAPI){this.logger.info(`[${e}][getToken] callingTokenAPI is enabled so using new API to fetch it`);const{token:r}=await this.getTokenWithTokenType(e,t,i,n);return r}const r=Date.now();let s,a,o=2;try{if(t&&this.invalidateCachedToken(e),this.cachedToken&&this.tokenCachingEnabled)return this.logger.info(`[${e}][getToken] returning cached token`),o=3,Promise.resolve(this.cachedToken);this.logger.info(`[${e}][getToken] fetching new token`);const i=await this.tokenProvider();return s=Date.now(),i?(this.tokenCachingEnabled&&(this.cachedToken=i),o=1,this.lastToken=i,this.lastTokenType=1,this.logger.info(`[${e}][getToken] fetching new token success`),i):(this.logger.info(`[${e}][getToken] received empty token`),Promise.reject("Received empty token"))}catch(t){throw this.logger.info(`[${e}][getToken] failed to fetch token=${Ve(t)}`),a=t,this.cachedToken="",t}finally{const t=n?.tokenTelemetryData;t&&(t.requestCauseId=e,t.supportTokenApi=this.clientSupportsGenericTokenAPI,t.requestTokenFactors=i?.factorsJson,t.tokenRequestTime=r,t.tokenResponseTime=s,t.tokenRequestStatus=o,t.requestTokenType=i?.tokenType,t.foundInCache=3===o,t.responseTokenType=this.lastTokenType,t.timeToResponse=s?s-r:s,t.errorCode=a?.errorCode,t.errorSubCode=a?.errorSubCode)}}invalidateCachedToken(e){this.cachedToken&&(this.logger.info(`[${e}][invalidateCachedToken]`),this.cachedToken="")}invalidateCachedTokenWithTokenType(e,t,i){8===e&&this.cacheTokenManager.getToken(8,i,this.logger)?.token===t&&(this.cacheTimers.stopTimer(i,e.toString()),this.cacheTokenManager.resetToken(8)),4===e&&this.cacheTokenManager.getToken(4,i,this.logger)?.token===t&&(this.cacheTimers.stopTimer(i,e.toString()),this.cacheTokenManager.resetToken(4)),1===e&&this.cacheTokenManager.getToken(1,i,this.logger)?.token===t&&(this.cacheTimers.stopTimer(i,e.toString()),this.cacheTokenManager.resetToken(1))}getLastToken(e){return this.logger.info(`[${e}][getLastToken]`),this.lastToken}getLastTokenWithTokenType(e,t,i){return this.logger.info(`[${e}][getLastTokenWithTokenType] with Token Type: ${t}`),this.cacheTokenManager.getToken(t,i,this.logger)?.token}async timeoutPromiseRace(e,t,i){let n;const r=new Promise(((e,r)=>{n=window.setTimeout((()=>{r({phrase:i,timeOut:!0})}),Ns(t))}));return Promise.race([e.then((e=>(clearTimeout(n),e))),r])}getLastTokenType(e){return this.logger.info(`[${e}][getLastTokenType] lastTokenType=${this.lastTokenType}`),this.lastTokenType}updateTokenSettings(e){const{clientSupportsGenericTokenAPI:t,aadTokenExpirationTimeInSeconds:i,caeTokenExpirationTimeInSeconds:n,refreshTimeBeforeTokenTimeoutInSeconds:r,enablePublishTokenTelemetry:s,enableRefreshToken:a,forceClearExpiredTokens:o,enableRefreshTokenRetry:l,enableRefreshTokenRetryInSeconds:d}=e;this.logger.info(`updateTokenSettings ${JSON.stringify(e)}`),this.clientSupportsGenericTokenAPI=t??this.clientSupportsGenericTokenAPI,this.aadTokenExpirationTimeInSeconds=i??this.aadTokenExpirationTimeInSeconds,this.caeTokenExpirationTimeInSeconds=n??this.caeTokenExpirationTimeInSeconds,this.refreshTimeBeforeTokenTimeoutInSeconds=r??this.refreshTimeBeforeTokenTimeoutInSeconds,this.enablePublishTokenTelemetry=s??this.enablePublishTokenTelemetry,this.forceClearExpiredTokens=o??this.forceClearExpiredTokens,this.enableRefreshToken=a??this.enableRefreshToken,this.enableRefreshTokenRetry=l??this.enableRefreshTokenRetry,this.enableRefreshTokenRetryInSeconds=d??this.enableRefreshTokenRetryInSeconds}updateToken(e,t,i,n,r){if(this.logger.info(`[${n}][updateToken] UI replies a token with factorsJson=${e} updateMetadata=${JSON.stringify(t)} tokenExpirySecSinceEpoch?=${r}`),t.error){this.logger.info(`[${n}][updateToken] UI replies with error ${t.error} for factorsJson ${e}`);for(const i of this.tokensPromiseMap[e])i.tokenRequestOptions.requestMetadataJson.causeId===n&&i.defered.reject({phrase:t.error?.phrase,errorCode:t.error?.code,errorSubCode:t.error?.subCode,causeId:n});return}if(!i){this.logger.info(`[${n}][updateToken] received empty token`);for(const t of this.tokensPromiseMap[e])t.tokenRequestOptions.requestMetadataJson.causeId===n&&t.defered.reject({phrase:"Received empty token",causeId:n});return}if(r>ks()&&this.enableTokenCacheForGenericTokenAPI){this.logger.info(`[${n}][updateToken] caching Token with tokenType=${t.tokenType}`);const s={factorsJson:e,tokenType:t.tokenType,invalidToken:i};this.addToCache(t.tokenType,i,e,this.calculateTokenExpiry(n,s,r))}if(!this.tokensPromiseMap[e]){this.logger.warn(`[updateToken]: UI try to update token with invalid factorsJson=${e}`);const i={responseCauseId:n,supportTokenApi:this.clientSupportsGenericTokenAPI,requestTokenFactors:e,tokenResponseTime:Date.now(),tokenRequestStatus:6,responseTokenType:t.tokenType};return void this.sendTokenTelemetry(i)}if(this.tokensPromiseMap[e]){const r=this.tokensPromiseMap[e];for(let s=r.length-1;s>=0;s--)(r[s]?.tokenRequestOptions.tokenType&t.tokenType)>0&&(r[s].defered.resolve({token:i,tokenType:t.tokenType,causeId:n}),this.tokensPromiseMap[e].splice(s,1))}if(this.logger.info(`[${n}][updateToken] resolved and upateToken with factorsJson=${e} tokenType=${t.tokenType}`),0===this.tokensPromiseMap[e].length&&delete this.tokensPromiseMap[e],4!==t.tokenType&&8!==t.tokenType&&1!==t.tokenType)return;if(Object.keys(this.tokensPromiseMap).length>0)for(const r of Object.values(this.tokensPromiseMap))for(let s=r.length-1;s>=0;s--){const a=r[s];a.tokenRequestOptions.factorsJson!==e&&(a.tokenRequestOptions.tokenType&t.tokenType)>0&&!a.tokenRequestOptions.isUnauthorized&&(a.defered.resolve({token:i,tokenType:t.tokenType,causeId:n}),r.splice(s,1))}for(const e of Object.keys(this.tokensPromiseMap))0===this.tokensPromiseMap[e].length&&delete this.tokensPromiseMap[e];const s=r-ks();this.startTokenRefreshTimer(s>=0?Ns(s):0)}setTokenRequiredCallBack(e){this.tokenCallback=e}setDisableTimerFlag(e){this.logger.info(`[setDisableTimerFlag] set disableTimerFlag to ${e}`),this.stopTimerFlag=e}sendTokenTelemetry(e){if(!this.enablePublishTokenTelemetry)return;const t={};t[hc.TOKEN_TELEMETRY_EVENT.TOKEN_TELEMETRY]=JSON.stringify(e),this.telemetryManager?(this.logger.info("[sendTokenTelemetry] sending token telemetry:",t),this.telemetryManager.sendEvent(hc.EVENT_TYPE.CONVERSATION_TOKEN,t)):this.logger.warn("[sendTokenTelemetry] telemetryManager is undefined, cannot send token telemetry")}dispose(){this.cacheTimers&&this.cacheTimers.dispose()}},Sc=(e,t,i,n)=>new fc(e,t,i,n),vc=class{constructor(e){this.piiScrubber=this.getPiiScrubber(e)}scrubParticipantsList(e){const t=[];return Array.isArray(e)&&e.forEach((e=>t.push(this.scrubMriOrOmit(e)))),t}scrubMriOrOmit(e){return"string"==typeof e?this.piiScrubber.mri(e):this.piiScrubber.omit(e)}static scrubDisplayNamesFromResponse(e){return He(e).replace(/"displayName": "[a-z]+"/gi,'"displayName": "(redacted)"')}getPiiScrubber(e){return e&&"function"==typeof e.omit&&"function"==typeof e.mri?e:{omit:()=>"<pii:omit/>",mri:()=>"<pii:mri/>"}}},yc=T(i(496486));function Cc(e){switch(e){case 0:return"main-audio";case 1:return"main-video";case 2:return"applicationsharing-video";case 3:return"data"}throw new Error("Invalid media type")}function Tc(e){switch(e){case"audio":return 0;case"video":return 1;case"applicationsharing-video":return 2;case"data":return 3;default:return}}function Ec(e,t){return e.endpoints?.endpointDetails.find((e=>e.participantId===t))}function _c(e,t){return e.participants.find((e=>function(e,t){return e.endpoints?.endpointDetails?.some((e=>e.participantId===t))??!1}(e,t)))}function bc(e){return!!e?.meetingGroupDetails?.groups&&Object.keys(e.meetingGroupDetails.groups).some((e=>"stagingGroup"===e))}function Pc(e,t){let i=-1;try{if(e.endpoints)e:for(const n of e.endpoints.endpointDetails)if(null!==n&&void 0!==n.mediaStreams){for(const e of n.mediaStreams)if(Tc(e.type)===t){i=e.sourceId;break e}}else i=Pn}catch(e){return-1}return i}function Ic(e,t,i){try{if(!e.endpoints)return;for(const n of e.endpoints.endpointDetails)if(n?.mediaStreams)for(const e of n.mediaStreams)if(i===e.sourceId&&Tc(e.type)===t)return n.participantId??null;return}catch(e){return}}function Ac(e){return"sendonly"===e.direction&&"applicationsharing-video"===e.label}function Rc(e){if(e.endpoints?.endpointDetails)return 1===e.endpoints.endpointDetails.length?e.endpoints.endpointDetails[0].participantId:e.endpoints.endpointDetails.find((e=>e?.mediaStreams?.some(Ac)))?.participantId}function wc(e){let t={};if(e.stateId)t.result=e.stateId;else if(e.results){const{results:i}=e;1===i.length&&i[0].stateId&&(t.result=i[0].stateId);const n={};e.results.forEach((e=>{const{result:i}=e,r=function(e){return e.participantId||e.participant&&e.participant.id}(e);(void 0===t.code||i.code>t.code)&&(t.code=i.code,t.subCode=i.subCode),n[r]=e})),t.result=JSON.stringify(n)}else e.result&&(t={code:e.result.code,phrase:e.result.phrase,subCode:e.result.subCode,resultCategories:e.result.resultCategories},e.additionalDetail&&(t.result=e.additionalDetail));return t}var Mc=class{constructor(e,t){this.broadcastContext=null,this.broadcastControllerUrl="",this.broadcastCallbackUrl="",this.broadcastState=null,this.setContext=(e=null)=>{this.logger.info("BroadcastSession :: set broadcast context",e),this.broadcastContext=e},this.getContext=()=>(this.logger.info("BroadcastSession :: get broadcast context",this.broadcastContext||null),this.broadcastContext||null),this.signalingSession=e,this.signalingSessionCallback=t,this.logger=e.logger.createChild((()=>"[Broadcast]"))}handleBroadcastStateChanged(e){const t=e.body;this.broadcastState=t;const i=_s(e);this.signalingSession.telemetryHelper.recordIncomingEvent(il,e),this.logger.info(`[${i}] broadcast state changed=${this.broadcastState}`),this.updateBroadcastMetadata(i)}updateBroadcastCallbackUrl(e){const t=is(this.signalingSession,Dr.CONV_BROADCAST_UPDATE);this.broadcastCallbackUrl!==t&&(this.broadcastCallbackUrl=t,this.logger.info(`[${e}] broadcast callback url changed=${this.broadcastCallbackUrl}`),this.updateBroadcastMetadata(e))}handleBroadcastDetailsChanged(e,t){this.signalingSession.telemetryHelper.recordEvent(vo,{causeId:t}),e.activeModalities&&e.activeModalities.broadcast&&e.activeModalities.broadcast.controller!==this.broadcastControllerUrl&&(this.broadcastControllerUrl=e.activeModalities.broadcast.controller,this.broadcastAdditionalData=e.activeModalities.broadcast,this.logger.info(`[${t}] broadcast controller changed=${this.broadcastControllerUrl}`),this.signalingSessionCallback.onBroadcastMeetingConnected(Zr.SUCCESS_TRANSACTION_END,t),this.updateBroadcastMetadata(t)),!this.broadcastControllerUrl||e.activeModalities&&e.activeModalities.broadcast||(this.broadcastControllerUrl="",this.broadcastContext=null,this.logger.info(`[${t}] broadcast controller changed=${this.broadcastControllerUrl}`),this.updateBroadcastMetadata(t),this.signalingSessionCallback.onBroadcastMeetingEnded(Zr.SUCCESS_TRANSACTION_END,t))}handleAddBroadcastModalitySuccess(e,t){this.logger.info(`[${t}][handleAddBroadcastModalitySuccess]`)}handleAddBroadcastModalityFailure(e,t){this.logger.info(`[${t}][handleAddBroadcastModalityFailure]`);const i={...e.modalityFailure.broadcast};this.signalingSessionCallback.onBroadcastMeetingEnded(i,t)}updateBroadcastMetadata(e){const t={broadcastControllerUrl:this.broadcastControllerUrl,broadcastStateCallbackUrl:this.broadcastCallbackUrl,broadcastState:this.broadcastState,broadcastAdditionalData:this.broadcastAdditionalData};this.logger.info(`[${e}] update broadcast metadata=${t}`),this.signalingSessionCallback.onBroadcastMeetingUpdated&&this.signalingSessionCallback.onBroadcastMeetingUpdated(t,e)}},Oc=class{static build(e,t){return new Dc(e,t)}},Dc=class{constructor(e,t){this.ontimeout=e,this.name=t}start(e){if(void 0!==this.timeoutId)throw new Error(`Timer ${this.name} already started`);return this.timeoutId=window.setTimeout((()=>this.ontimeout()),e),this}stop(){if(void 0===this.timeoutId)throw new Error(`Timer ${this.name} is not defined`);clearTimeout(this.timeoutId),this.timeoutId=void 0}},kc=class{constructor(e){this._signalingSession=e,this.baseUrl="http://broker.invalid/",this.currentSubscriptionUrl=null,this._currentSubscriptionTimeoutInSec=30,this._subscribers=[],this._disposed=!1,this._reportedResultCount=0,this._subscriptionRetryBackoffInSec=5,this._notifySubscribers=e=>{this._logger.info("_notifySubscribers"),Promise.resolve().then((()=>{e.split(",").forEach((e=>{const t=function(e){const t=e.split(/\r?\n\r?\n/),i=t[0].split(/\r?\n/),n=t[1].split(/\r?\n/),r=i.shift().split(" "),s=r[0],a=r[1]||"",o=new ts;for(const e of i)try{const[t,i]=e.split(":").map((e=>Er.trim(e)));o.set(t,i)}catch(t){throw new Error(`Malformed header: ${e+t}`)}return{url:a,headers:o,method:s,body:n.join("")}}(Is(e));let i=t.body;bs(t.headers)&&Ps(t.headers)&&(i=Is(i));const n={url:t.url,body:JSON.parse(i),headers:t.headers};this._logger.info("message length=",i.length,"n. of subscribers",this._subscribers.length),this._subscribers.forEach((e=>e(n)))}))})).catch((e=>{this._logger.error("_notifySubscribers, failed to decode message",e),this._signalingSession.telemetryHelper.recordEvent(Wo)}))},this._subscribeToBroker=(e,t)=>{if(this._disposed)return void this._logger.warn("_subscribeToBroker, disposed, ignore subscription");const i=os();this._logger.info("_subscribeToBroker, url: ",e,",timeout in sec",t),this.currentSubscriptionUrl=e,this._currentSubscriptionTimeoutInSec=t,this._clearAllPendingTimeouts(),this._setSubscriptionTimeout(t),this._signalingSession.http.sendGetRequest({url:this.currentSubscriptionUrl,requestName:cc.BROKER_SUBSCRIBE.name,customHeaders:this._getBrokerRequestHeaders(i),payload:null,skipHttpTelemetry:!this._reportSubscriptionInTelemetry(),causeId:os(),operationType:"BrokerSubscribe"}).then(this._handleSubscriptionSuccess).catch(this._handleSubscriptionFailure)},this._clearAllPendingTimeouts=()=>{this._cancelRequestTimer&&(this._cancelRequestTimer.stop(),this._cancelRequestTimer=null),this._retryRequestTimer&&(this._retryRequestTimer.stop(),this._retryRequestTimer=null)},this._abortPendingRequest=()=>{this._signalingSession.http.cancelRequestIfPending(cc.BROKER_SUBSCRIBE.name,os())},this._setSubscriptionTimeout=e=>{this._cancelRequestTimer=Oc.build((()=>{this._disposed||(this._signalingSession.http.hasPendingRequest(cc.BROKER_SUBSCRIBE.name)?(this._logger.warn("timeout subscription"),this._signalingSession.telemetryHelper.recordEvent(qo),this._signalingSession.http.cancelRequestIfPending(cc.BROKER_SUBSCRIBE.name,os())):this._logger.error("Unable to resolve timeout deferred, it is not defined!"))}),"TIMEOUT").start(1e3*e)},this._handleSubscriptionSuccess=e=>{if(this._disposed)this._logger.warn("_handleSubscriptionSuccess, disposed, ignore subscription success");else if(this._reportSubscriptionInTelemetry(e)&&this._signalingSession.telemetryHelper.recordEvent(zo),e&&e.response){const t=e.response;this._logger.info("_handleSubscriptionSuccess, response",t),t.message&&this._notifySubscribers(t.message);const i=t.nextSubscribeUrl||this.currentSubscriptionUrl,n=t.expirationTimeInSec||this._currentSubscriptionTimeoutInSec;this._subscribeToBroker(i,n)}else this._logger.info("_handleSubscriptionSuccess, empty response")},this._handleSubscriptionFailure=e=>{if(this._disposed)return void this._logger.warn("_handleSubscriptionFailure, disposed, ignore subscription");if(e.status>=400&&e.status<500&&401!==e.status&&this.isNotNetworkErrors(e.status))return void this._logger.warn(`_handleSubscriptionFailure, received status ${e.status}, stop subscribing`);const t=Ve(e);this._logger.error("_handleSubscriptionFailure failed, re-subscribing",t),this._reportSubscriptionInTelemetry()&&this._signalingSession.telemetryHelper.recordEvent(Ko),this._retryRequestTimer=Oc.build((()=>{this._subscribeToBroker(this.currentSubscriptionUrl,this._currentSubscriptionTimeoutInSec)}),"RETRY").start(1e3*this._subscriptionRetryBackoffInSec)},this._reportSubscriptionInTelemetry=e=>(this._reportedResultCount++,this._reportedResultCount<=1),this._getBrokerRequestHeaders=e=>{const t=new ts;return t.set(Zr.HEADERS.CONTENT_TYPE,Zr.CONTENT_TYPE.JSON),this._signalingSession.signalingAgentConfig.brokerRequestBatching&&t.set(Zr.HEADERS.BROKER_USE_BATCHING_HEADER_NAME,"1"),t},this._logger=this._signalingSession.logger.createChild("Broker"),this._signalingSession.signalingAgentConfig.csaTimeoutConfiguration?.brokerRetryBackOffInSec&&(this._subscriptionRetryBackoffInSec=this._signalingSession.signalingAgentConfig.csaTimeoutConfiguration.brokerRetryBackOffInSec)}subscribeToBroker(e){this._logger.info("subscribeToBroker called."),this._abortPendingRequest(),this._clearAllPendingTimeouts(),this._subscribeToBroker(e,this._currentSubscriptionTimeoutInSec)}onBrokerMessage(e){this._logger.info("onBrokerMessage callback added"),this._subscribers.push(e)}dispose(){this._disposed=!0,this._logger.info("dispose"),this._subscribers=[],this._clearAllPendingTimeouts(),this._abortPendingRequest()}isNotNetworkErrors(e){return 490!==e&&496!==e&&498!==e&&499!==e}},Nc=class{constructor(e){this.requests={},this.logger=e}clear(e,t){const i=t||{code:Zr.CALL_END_CODE.SUCCESS,subCode:Zr.CALL_END_SUB_CODE.SUCCESS,phrase:Zr.CALL_END_PHRASE.LOCAL_USER_INITIATED};Object.keys(this.requests).forEach((t=>{try{const n=parseInt(t,10);Object.keys(this.requests[n]).forEach((t=>{this.rejectOperation(n,t,e,i)}))}catch(e){this.logger.warn(`CallOperations: clear error = ${e}`)}}))}hasOperation(e,t){return this.requests.hasOwnProperty(e.valueOf())&&this.requests[e.valueOf()].hasOwnProperty(t)}getAllOperations(){return this.requests}getOperation(e,t){return this.hasOperation(e,t)?this.requests[e.valueOf()][t]:null}setOperation(e,t,i){return!this.hasOperation(e,t)&&(this.hasOwnProperty(e.valueOf())||(this.requests[e.valueOf()]={}),this.requests[e.valueOf()][t]=i,!0)}rejectOperation(e,t,i,n){if(this.hasOperation(e,t)){const i=e.valueOf(),r=this.requests[i][t].promise;delete this.requests[i][t],r.reject(n)}}resolveOperation(e,t,i,n){if(this.hasOperation(e,t)){const n=e.valueOf(),r=this.requests[n][t].promise;delete this.requests[n][t],r.resolve(i)}}},Lc=class{constructor(e){this.logger=e,this.localRequests=new Nc(e)}dispose(e,t,i){this.logger.info(`[${i}][dispose]`),this.rejectAllPendingOperations(e,t)}hasPendingOperation(e,t,i){return this.logger.info(`[${i}][hasPendingOperation] ${e} ${ke(t)}}`),this.localRequests.hasOperation(e,t)}rejectPendingOperation(e,t,i,n,r){this.logger.info(`[${r}][rejectPendingOperation] ${e} ${t} reason: ${i} endCode: ${n}`),this.localRequests.rejectOperation(e,t,i,n)}resolvePendingOperation(e,t,i,n){this.logger.info(`[${n}][resolvePendingOperation]: ${ke(t)}`),this.localRequests.resolveOperation(e,t,i,n)}setPendingOperation(e,t,i,n){return this.logger.info(`[${n}][setPendingOperation] ${e} value: ${i}`),this.localRequests.setOperation(e,t,i)}rejectAllPendingOperations(e,t){this.logger.info("rejectLocalQueuedOperations"),this.localRequests.clear(e,t)}};function xc(e,t){return hs(e,"signalingSession cannot be null"),hs(t,"content cannot be null"),{payload:{participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},to:[]},contentSharing:{identifier:t.contentIdentifier,subject:t.subject,sessionState:t.sessionState,sequenceNumber:t.sequenceNumber,links:{sessionUpdate:is(e,Dr.CONV_CONTENT_SHARING_UPDATE),sessionEnd:is(e,Dr.CONV_CONTENT_SHARING_END)}},links:{addModalitySuccess:is(e,Dr.CONV_ADD_MODALITY_SUCCESS),addModalityFailure:is(e,Dr.CONV_ADD_MODALITY_FAILURE)}}}}function Fc(e,t,i){return hs(e,"signalingSession cannot be null"),hs(t,"sessionState cannot be null"),hs(i,"sequenceNumber cannot be null"),{payload:{sessionUpdateSequenceNumber:i,sessionState:t,participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId}}}}}var Uc=class{constructor(){this.msElapsed=0,this.isPaused=!1,this.startTime=(new Date).getTime(),this.pause=()=>{this.isPaused||(this.msElapsed+=(new Date).getTime()-this.startTime,this.isPaused=!0)},this.resume=()=>{this.isPaused&&(this.isPaused=!1,this.startTime=(new Date).getTime())},this.duration=()=>this.isPaused?this.msElapsed:this.msElapsed+(new Date).getTime()-this.startTime,this.durationInMinutes=()=>{const e=this.duration()/6e4;return Math.ceil(e)},this.durationInSeconds=()=>{const e=this.duration()/1e3;return Math.ceil(e)}}};function Vc(){return new Uc}var Hc=class{constructor(e,t,i,n){this.signalingSession=e,this.correlationId=t,this.sessionId=null,this.fsmState=Zr.CONTENT_SHARING_FSM_STATE.IDLE,this.addSessionPromise=null,this.removeSessionPromise=null,this.confirmInRosterPromise=null,this.links={},this.lastUpdateSequenceNumber=-1,this.nextClientSequenceNumberToUse=1,this.disposed=!1,this.isPresenter=!1,this.FSM_STATES=Zr.CONTENT_SHARING_FSM_STATE,this.logger=e.logger.createChild((()=>`[${this.fsmState}][cs=${this.sessionId}][cc=${this.correlationId}]`)),i&&(this.sessionId=i),n&&(this.links=n)}start(e,t,i,n){if(this.logger.info(`[${n}][start]`),cs(e,"Correct addModality url is not provided"),!this.checkState("start",this.FSM_STATES.IDLE,this.addSessionPromise))return Promise.reject(null);this.addSessionPromise=i,this.confirmInRosterPromise=As(),this.fsmState=this.FSM_STATES.CONTENT_SHARING_START_INITIATED,this.addTelemetryOperation(cc.ADD_CONTENT_SHARING_MODALITY.name,{causeId:n});const r=new ts;return r.set(Zr.HEADERS.CONTENT_SHARING_CORRELATION_ID,this.correlationId),this.signalingSession.http.sendPostRequest({url:e,payload:xc(this.signalingSession,t),requestName:cc.ADD_CONTENT_SHARING_MODALITY.name,customHeaders:r,onceTrouterReady:()=>{this.startContentSharingTimer(n)},causeId:n}).then((()=>{this.disposed||(this.presenterMri=this.signalingSession.participantManager.localParticipant.id,this.isPresenter=!0)})).catch((e=>{const t=Cs(e,this.signalingSession.signalingAgentConfig);return this.logger.info(`[${n}][start] error: ${Ve(t)}`),this.disposed||(this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.ADD_MODALITY),this.rejectPendingPromise(Ve(e),t.error)),Promise.reject(null)}))}delete(e,t){this.logger.info(`[${t}][delete]`);let i=!1;if(this.fsmState===this.FSM_STATES.IDLE)return this.logger.info(`[${t}][delete] skipped because state is already ${this.fsmState}`),e.resolve(),Promise.resolve();if(this.fsmState===this.FSM_STATES.CONTENT_SHARING_START_INITIATED)i=!0,this.rejectPendingPromise("Session delete called before start was finished");else if(!this.checkState("delete",this.FSM_STATES.CONTENT_SHARING_CONNECTED,e))return Promise.reject(null);i||cs(this.links[Zr.LINKS.CONTENT_SHARING_CONTROLLER],"Correct controller url is not set"),this.removeSessionPromise=e,this.fsmState=this.FSM_STATES.CONTENT_SHARING_DELETE_INITIATED;const n=Vc(),r=this.addTelemetryOperation(cc.DELETE_CONTENT_SHARING.name,{causeId:t});var s,a;return(i?Promise.resolve(void 0):this.signalingSession.http.sendDeleteRequest({url:this.links[Zr.LINKS.CONTENT_SHARING_CONTROLLER],requestName:cc.DELETE_CONTENT_SHARING.name,payload:(s=this.signalingSession,a={code:Zr.CALL_END_CODE.SUCCESS,subCode:Zr.CALL_END_SUB_CODE.SUCCESS,phrase:Zr.CALL_END_PHRASE.LOCAL_USER_INITIATED},hs(s,"signalingSession cannot be null"),us(a),{payload:{contentSharingTransactionEnd:a,participants:{from:{id:s.participantManager.localParticipant.id,displayName:s.participantManager.localParticipant.displayName,endpointId:s.participantManager.localParticipant.endpointId,participantId:s.participantManager.localParticipant.participantId,languageId:s.participantManager.localParticipant.languageId}}}}),causeId:t})).then((()=>{if(!this.disposed){const e={success:!0,duration:n.duration()};i&&(e.skipReason="Session delete called before start was finished"),this.updateTelemetryOperation(r,e),this.fsmState=this.FSM_STATES.IDLE,this.resolvePendingPromise()}})).catch((e=>{const i=Cs(e,this.signalingSession.signalingAgentConfig);if(this.logger.info(`[${t}][delete] error: ${Ve(i)}`),!this.disposed){const e={success:!1,duration:n.duration()};this.updateTelemetryOperation(r,e),this.fsmState=this.FSM_STATES.IDLE,this.resolvePendingPromise()}return Promise.reject(null)}))}join(e,t){if(this.logger.info(`[${t}][join]`),cs(this.links[Zr.LINKS.CONTENT_SHARING_CONTROLLER],"Correct joinContentSharing url is not provided"),!this.checkState("join",this.FSM_STATES.IDLE,e))return;this.lastUpdateSequenceNumber=-1,this.nextClientSequenceNumberToUse=1,this.addSessionPromise=e,this.fsmState=this.FSM_STATES.CONTENT_SHARING_JOIN_INITIATED;const i=Vc(),n=this.addTelemetryOperation(cc.JOIN_CONTENT_SHARING.name,{causeId:t});var r;this.signalingSession.http.sendPostRequest({url:this.links[Zr.LINKS.CONTENT_SHARING_CONTROLLER],payload:(r=this.signalingSession,hs(r,"signalingSession cannot be null"),{payload:{contentSharing:{links:{sessionUpdate:is(r,Dr.CONV_CONTENT_SHARING_UPDATE),sessionEnd:is(r,Dr.CONV_CONTENT_SHARING_END)}},participants:{from:{id:r.participantManager.localParticipant.id,displayName:r.participantManager.localParticipant.displayName,endpointId:r.participantManager.localParticipant.endpointId,participantId:r.participantManager.localParticipant.participantId,languageId:r.participantManager.localParticipant.languageId}}}}),requestName:cc.JOIN_CONTENT_SHARING.name,causeId:t}).then((e=>{if(!this.disposed){const t={success:!0,duration:i.duration()};this.updateTelemetryOperation(n,t),this.processStartOrJoinSuccess(e.response),this.resolvePendingPromise(e.response)}})).catch((e=>{const r=Cs(e,this.signalingSession.signalingAgentConfig);if(this.logger.info(`[${t}][join] error: ${Ve(r)}`),!this.disposed){const t={success:!1,duration:i.duration()};this.updateTelemetryOperation(n,t);const s=r.error;this.rejectPendingPromise(Ve(e),s)}}))}takeControl(e,t){if(this.logger.info(`[${t}][takeControl]`),cs(this.links[Zr.LINKS.CONTENT_SHARING_TAKE_CONTROL],"correct contentSharingTakeControl url is not provided"),!this.checkState("takeControl",this.FSM_STATES.CONTENT_SHARING_CONNECTED,e))return;const i=Vc(),n=this.addTelemetryOperation(cc.TAKE_CONTROL_CONTENT_SHARING.name,{causeId:t});var r;this.signalingSession.http.sendPostRequest({url:this.links[Zr.LINKS.CONTENT_SHARING_TAKE_CONTROL],payload:(r=this.signalingSession,hs(r,"signalingSession cannot be null"),{payload:{participants:{from:{id:r.participantManager.localParticipant.id,displayName:r.participantManager.localParticipant.displayName,endpointId:r.participantManager.localParticipant.endpointId,participantId:r.participantManager.localParticipant.participantId,languageId:r.participantManager.localParticipant.languageId}}}}),requestName:cc.TAKE_CONTROL_CONTENT_SHARING.name,withoutTrouter:!0,causeId:t}).then((t=>{if(!this.disposed){const r={success:!0,duration:i.duration()};this.updateTelemetryOperation(n,r);const s={contentIdentifier:t.response.identifier,presenter:t.response.presenter.id,subject:t.response.subject||null,sessionState:t.response.sessionState||null};e.resolve(s)}})).catch((r=>{const s=Cs(r,this.signalingSession.signalingAgentConfig);if(this.logger.info(`[${t}][takeControl] error: ${Ve(s)}`),!this.disposed){const t={success:!1,duration:i.duration()};this.updateTelemetryOperation(n,t);const a=new Error(Ve(r));a.endCode=s.error,e.reject(a)}}))}updateSessionState(e,t,i){if(this.logger.info(`[${i}][updateSessionState]`),cs(this.links[Zr.LINKS.CONTENT_SHARING_UPDATE_SESSION_STATE],"Correct sendUpdateSessionState url is not provided"),!this.checkState("updateSessionState",this.FSM_STATES.CONTENT_SHARING_CONNECTED,t))return;const n=Vc(),r=this.addTelemetryOperation(cc.UPDATE_SESSION_STATE_CONTENT_SHARING.name,{causeId:i});this.signalingSession.http.sendPostRequest({url:this.links[Zr.LINKS.CONTENT_SHARING_UPDATE_SESSION_STATE],payload:Fc(this.signalingSession,e,this.nextClientSequenceNumberToUse++),requestName:cc.UPDATE_SESSION_STATE_CONTENT_SHARING.name,causeId:i}).then((()=>{if(!this.disposed){const e={success:!0,duration:n.duration()};this.updateTelemetryOperation(r,e),t.resolve()}})).catch((e=>{const s=Cs(e,this.signalingSession.signalingAgentConfig);if(this.logger.info(`[${i}][updateSessionState] error: ${Ve(s)}`),!this.disposed){const i={success:!1,duration:n.duration()};this.updateTelemetryOperation(r,i);const a=new Error(Ve(e));a.endCode=s.error,t.reject(a)}}))}updateParticipantState(e,t){if(this.logger.info(`[${t}][updateParticipantState]`),cs(this.links[Zr.LINKS.CONTENT_SHARING_UPDATE_PARTICIPANT_STATE],"correct confirmContentSharingView url is not provided"),!this.checkState("updateParticipantState",this.FSM_STATES.CONTENT_SHARING_CONNECTED,e))return;const i=Vc(),n=this.addTelemetryOperation(cc.UPDATE_PARTICIPANT_STATE_CONTENT_SHARING.name,{causeId:t});var r;this.signalingSession.http.sendPostRequest({url:this.links[Zr.LINKS.CONTENT_SHARING_UPDATE_PARTICIPANT_STATE],payload:(r=this.signalingSession,hs(r,"signalingSession cannot be null"),{payload:{participants:{from:{id:r.participantManager.localParticipant.id,displayName:r.participantManager.localParticipant.displayName,endpointId:r.participantManager.localParticipant.endpointId,participantId:r.participantManager.localParticipant.participantId,languageId:r.participantManager.localParticipant.languageId}}}}),requestName:cc.UPDATE_PARTICIPANT_STATE_CONTENT_SHARING.name,withoutTrouter:!0,causeId:t}).then((()=>{if(!this.disposed){const t={success:!0,duration:i.duration()};this.updateTelemetryOperation(n,t),e.resolve()}})).catch((r=>{const s=Cs(r,this.signalingSession.signalingAgentConfig);if(this.logger.info(`[${t}][updateParticipantState] error: ${Ve(s)}`),!this.disposed){const t={success:!1,duration:i.duration()};this.updateTelemetryOperation(n,t);const a=new Error(Ve(r));a.endCode=s.error,e.reject(a)}}))}updateNotificationLinks(e){if(this.logger.info(`[${e}][updateNotificationLinks]`),cs(this.links[Zr.LINKS.CONTENT_SHARING_NOTIFICATION_LINKS],"correct notificationLinks url is not provided"),!this.checkState("updateState",this.FSM_STATES.CONTENT_SHARING_CONNECTED))return;const t=Vc(),i=this.addTelemetryOperation(cc.UPDATE_CONTENT_SHARING_NOTIFICATION_LINKS.name,{causeId:e});var n;this.signalingSession.http.sendPostRequest({url:this.links[Zr.LINKS.CONTENT_SHARING_NOTIFICATION_LINKS],payload:(n=this.signalingSession,hs(n,"signalingSession cannot be null"),{payload:{participants:{from:{id:n.participantManager.localParticipant.id,displayName:n.participantManager.localParticipant.displayName,endpointId:n.participantManager.localParticipant.endpointId,participantId:n.participantManager.localParticipant.participantId,languageId:n.participantManager.localParticipant.languageId}},links:{sessionUpdate:is(n,Dr.CONV_CONTENT_SHARING_UPDATE),sessionEnd:is(n,Dr.CONV_CONTENT_SHARING_END)}}}),requestName:cc.UPDATE_CONTENT_SHARING_NOTIFICATION_LINKS.name,withoutTrouter:!0,causeId:e}).then((()=>{if(!this.disposed){const e={success:!0,duration:t.duration()};this.updateTelemetryOperation(i,e)}})).catch((n=>{const r=Cs(n,this.signalingSession.signalingAgentConfig);if(this.logger.info(`[${e}][updateNotificationLinks] error: ${Ve(r)}`),!this.disposed){const e={success:!1,duration:t.duration()};this.updateTelemetryOperation(i,e)}}))}confirmInRoster(){this.confirmInRosterPromise&&this.confirmInRosterPromise.isPending&&(this.logger.info("Confirmed in roster"),this.confirmInRosterPromise.resolve())}handleAddModalitySuccess(e,t){return this.logger.info(`[${t}][handleAddModalitySuccess]`),this.checkState("handleAddModalitySuccess",this.FSM_STATES.CONTENT_SHARING_START_INITIATED)?e.modalitySuccess&&e.modalitySuccess.contentSharing?(this.addTelemetryOperation(mo,{causeId:t}),this.processStartOrJoinSuccess(e.modalitySuccess.contentSharing),this.confirmInRosterPromise.promise.then((()=>{delete this.confirmInRosterPromise,this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.ADD_MODALITY),this.resolvePendingPromise(e.modalitySuccess.contentSharing)})),!0):(this.addTelemetryOperation(mo,{causeId:t,skipReason:"no content sharing blob"}),this.logger.info(`[${t}][handleAddModalitySuccess] ignored because modalitySuccess was missing or did not contain content sharing blob`),!1):(this.logger.info(`[${t}][handleAddModalitySuccess] ignored because session is not waiting to start`),!1)}handleAddModalityFailure(e,t){if(this.logger.info(`[${t}][handleAddModalityFailure]`),!this.checkState("handleAddModalityFailure",[this.FSM_STATES.CONTENT_SHARING_START_INITIATED,this.FSM_STATES.CONTENT_SHARING_CONNECTED]))return!1;if(!e.modalityFailure||!e.modalityFailure.contentSharing)return this.addTelemetryOperation(fo,{causeId:t,skipReason:"no content sharing blob"}),!1;const i=e.modalityFailure.contentSharing;this.addTelemetryOperation(fo,{reason:i,causeId:t});const n={...i};return this.sendTelemetryData(n),this.rejectPendingPromise(n.phrase,n),this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.ADD_MODALITY),!0}handleStartFromRoster(e,t){this.logger.info(`[${t}][handleStartFromRoster]`),this.addTelemetryOperation(po,{causeId:t})}handleStopFromRoster(e,t){this.logger.info(`[${t}][handleStopFromRoster]`),this.addTelemetryOperation(go,{causeId:t}),this.sendTelemetryData(e)}handleStop(e,t){if(this.logger.info(`[${t}][handleStop]`),this.isSelfInitiatedAction(e))return this.logger.info(`[${t}][handleStop]handleStop skipped because session was ended by self`),!1;const i={...e.contentSharingTransactionEnd};return this.addTelemetryOperation(uo,{causeId:t}),this.sendTelemetryData(i),!0}handleUpdate(e,t){return this.logger.info(`[${t}][handleUpdate]`),e.sequenceNumber<=this.lastUpdateSequenceNumber?(this.logger.info(`handleUpdate skipped because of old sequence number: last received ${this.lastUpdateSequenceNumber}, update contained ${e.sequenceNumber}`),this.addTelemetryOperation(ho,{causeId:t,skipReason:"old sequence number"}),!1):(this.lastUpdateSequenceNumber=e.sequenceNumber,this.isPresenter=e.presenter.id===this.signalingSession.participantManager.localParticipant.id,this.addTelemetryOperation(ho,{causeId:t}),!0)}dispose(e,t){this.logger.info(`[${t}][dispose]`),this.disposed=!0,this.rejectPendingPromise("call ended",e||{code:Zr.CALL_END_CODE.SUCCESS,subCode:Zr.CALL_END_SUB_CODE.SUCCESS,phrase:Zr.CALL_END_PHRASE.LOCAL_USER_INITIATED}),this.addTelemetryOperation(Qa,{causeId:t}),this.sendTelemetryData(e)}rejectPendingPromise(e,t){this.logger.info("rejectPendingPromise");const i=new Error(e);t&&(i.endCode=t),this.removeSessionPromise&&(this.removeSessionPromise.reject(i),this.removeSessionPromise=null),this.addSessionPromise&&(this.addSessionPromise.reject(i),this.addSessionPromise=null)}resolvePendingPromise(e){this.logger.info("resolvePendingPromise");let t=null;e&&(t={sessionId:e.sessionId,correlationId:e.contentSharingCorrelationId,contentIdentifier:e.identifier,presenter:e.presenter.id,subject:e.subject||null,sessionState:e.sessionState||null}),this.removeSessionPromise&&(this.removeSessionPromise.resolve(t),this.removeSessionPromise=null),this.addSessionPromise&&(this.addSessionPromise.resolve(t),this.addSessionPromise=null)}processStartOrJoinSuccess(e){this.logger.info("processStartOrJoinSuccess"),this.sessionId=e.sessionId,this.fsmState=this.FSM_STATES.CONTENT_SHARING_CONNECTED,this.lastUpdateSequenceNumber=-1,this.links[Zr.LINKS.CONTENT_SHARING_CONTROLLER]=e.links.contentSharingController,this.links[Zr.LINKS.CONTENT_SHARING_TAKE_CONTROL]=e.links.takeControl,this.links[Zr.LINKS.CONTENT_SHARING_UPDATE_SESSION_STATE]=e.links.updateSessionState,this.links[Zr.LINKS.CONTENT_SHARING_UPDATE_PARTICIPANT_STATE]=e.links.sync,this.links[Zr.LINKS.CONTENT_SHARING_NOTIFICATION_LINKS]=e.links.notificationLinks,this.links[Zr.LINKS.CONTENT_SHARING_LEAVE]=e.links.leave}checkState(e,t,i){let n;if(n="string"==typeof t?this.fsmState===t:t.indexOf(this.fsmState)>-1,n)return!0;{const n=`${e} requires state ${t}, but state is ${this.fsmState}`;return this.logger.error(n),i&&i.reject(n),!1}}isSelfInitiatedAction(e){return e.presenter.participantId===this.signalingSession.participantManager.localParticipant.participantId}startContentSharingTimer(e){this.logger.info("startContentSharingTimer"),this.signalingSession.timeoutManager.startTimer(Zr.TIMEOUT_OPERATIONS.ADD_MODALITY,(()=>{this.addTelemetryOperation(Qs,{causeId:e}),this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.ADD_MODALITY),this.rejectPendingPromise("timed out waiting for ContentSharing to start",{code:Zr.CALL_END_CODE.TIMEOUT,subCode:Zr.CALL_END_SUB_CODE.CALL_ESTABLISHMENT_TIMEOUT,phrase:Zr.CALL_END_PHRASE.ESTABLISHMENT_TIMEOUT})}),Zr.TIMEOUT_VALUES_IN_SECONDS.ADD_MODALITY_TIMEOUT)}addTelemetryOperation(e,t){return this.signalingSession.telemetryHelper.addContentSharingOperation(this.correlationId,e,t)}updateTelemetryOperation(e,t){this.signalingSession.telemetryHelper.updateContentSharingOperation(this.correlationId,e,t)}sendTelemetryData(e){this.signalingSession.telemetryHelper.sendContentSharingTelemetryData(this.correlationId,this.signalingSession.sessionId,this.isPresenter,e,this.links[Zr.LINKS.CONTENT_SHARING_CONTROLLER],this.sessionId)}},Bc=class{constructor(e,t){this.contentSharingToStartCallWith=null,this.contentSharingSessions={},this.DEFAULT_STOP_REASON={code:Zr.CALL_END_CODE.SUCCESS,subCode:Zr.CALL_END_SUB_CODE.SUCCESS,phrase:Zr.CALL_END_PHRASE.REMOTE_USER_INITIATED},this.DEFAULT_STOP_ID="8:unknown",this.deleteContentSharingAsync=(e,t)=>{this.logger.info(`[${t}][deleteContentSharingAsync]`);const i=As();let n=this.contentSharingSessions[e];if(this.pendingSessionToStart&&this.pendingSessionToStart.correlationId===e&&(n=this.pendingSessionToStart),n){const r=()=>{this.contentSharingSessions[e]&&delete this.contentSharingSessions[e]};n.delete(i,t).then(r,r)}else this.rejectBecauseOfMissingSession(e,i);return i.promise},this.signalingSession=e,this.signalingSessionCallback=t,this.logger=e.logger.createChild((()=>"[ContentSharingManager]")),this.lastProcessedSequenceNumber=-1,this.lastProcessedSequenceNumberForParticipant={}}startContentSharingAsync(e,t,i,n,r,s,a){if(this.logger.info(`startContentSharingAsync called for: ${e}`),this.pendingSessionToStart){const e="There is already a ContentSharing session start pending";return this.logger.error(e),Promise.reject(new Error(e))}const o={contentIdentifier:e,subject:i||null,sessionState:t||null,sequenceNumber:1},l=As(),d=new Hc(this.signalingSession,a||ls());return this.pendingSessionToStart=d,r?(this.logger.info("Call connected, send content sharing request out immediately"),d.start(n,o,l,s)):(this.logger.info("Content sharing is to be started when startOutgoingCall is called"),d.addSessionPromise=l,d.fsmState=Zr.CONTENT_SHARING_FSM_STATE.CONTENT_SHARING_START_INITIATED,this.contentSharingToStartCallWith=o),l.promise.then((()=>{this.contentSharingSessions.hasOwnProperty(d.correlationId)||(this.contentSharingSessions[d.correlationId]=d),this.pendingSessionToStart=null})).catch((()=>{this.pendingSessionToStart=null})),l.promise}joinContentSharingAsync(e,t){this.logger.info(`[${t}][joinContentSharingAsync]`);const i=As(),n=this.contentSharingSessions[e];return n?n.join(i,t):this.rejectBecauseOfMissingSession(e,i),i.promise}updateContentSharingSessionStateAsync(e,t,i){this.logger.info(`[${i}][updateContentSharingSessionStateAsync][sessionState=${JSON.stringify(t)}]`);const n=As(),r=this.contentSharingSessions[e];return r?r.updateSessionState(t,n,i):this.rejectBecauseOfMissingSession(e,n),n.promise}takeContentSharingControlAsync(e,t){this.logger.info(`[${t}][takeContentSharingControlAsync]`);const i=As(),n=this.contentSharingSessions[e];return n?n.takeControl(i,t):this.rejectBecauseOfMissingSession(e,i),i.promise}updateContentSharingParticipantStateAsync(e,t){this.logger.info(`[${t}][updateContentSharingParticipantStateAsync]`);const i=As(),n=this.contentSharingSessions[e];return n?n.updateParticipantState(i,t):this.rejectBecauseOfMissingSession(e,i),i.promise}updateContentSharingNotificationLinksAsync(e){this.logger.info(`[${e}][updateContentSharingNotificationLinksAsync]`);for(const t of Object.keys(this.contentSharingSessions))if(this.contentSharingSessions.hasOwnProperty(t)){const i=this.contentSharingSessions[t];i&&i.updateNotificationLinks(e)}}getContentSharingInfoToStartSharing(){if(this.contentSharingToStartCallWith){const e=this.pendingSessionToStart,t=Zr.CONTENT_SHARING_FSM_STATE.CONTENT_SHARING_START_INITIATED;e&&e.fsmState===t||(this.contentSharingToStartCallWith=null,this.pendingSessionToStart=null)}return this.contentSharingToStartCallWith}dispose(e,t){this.logger.info(`[${t}][dispose]`);for(const i of Object.keys(this.contentSharingSessions))if(this.contentSharingSessions.hasOwnProperty(i)){const n=this.contentSharingSessions[i];n&&n.dispose(e,t)}}handleContentSharingUpdate(e){const t=e.body,i=_s(e),n=this.contentSharingSessions[t.contentSharingCorrelationId];n?n.handleUpdate(t,i)&&this.signalingSessionCallback.onContentSharingUpdated({sessionId:t.sessionId,correlationId:t.contentSharingCorrelationId,contentIdentifier:t.identifier,presenter:t.presenter.id,subject:t.subject||null,sessionState:t.sessionState||null},i):this.logger.info(`[${i}][handleContentSharingUpdate][failed][reason=no session with correlation ID ${t.correlationId}]`)}handleAddModalitySuccess(e,t){this.logger.info(`[${t}][handleAddModalitySuccess]`);const i=this.pendingSessionToStart;i?i.handleAddModalitySuccess(e,t):this.logger.info(`[${t}][handleAddModalitySuccess]Ignoring handleAddModalitySuccess because not waiting for one`)}handleAddModalityFailure(e,t){this.logger.info(`[${t}][handleAddModalityFailure]`);const i=this.pendingSessionToStart;i?i.handleAddModalityFailure(e,t):this.logger.info(`[${t}][handleAddModalityFailure]Ignoring handleAddModalityFailure because not waiting for one`)}handleIncomingContentSharingFromRoster(e,t,i){if(this.logger.info(`[${i}] handleIncomingContentSharingFromRoster: isFullRoster ${t} content ${Ve(e)}`),("MultiPartyEndpoint"===e.type||t)&&this.lastProcessedSequenceNumber>e.sequenceNumber)return void this.logger.info(`[${i}] handleIncomingContentSharingFromRoster invalid roster current sequenceNumber ${e.sequenceNumber} lastProcessedSequenceNumber ${this.lastProcessedSequenceNumber}`);const{sessionsWithPresenters:n,sessionsWithoutPresenters:r}=this.parseContentSharingSessionsFromRoster(e);this.startSessionsFromRoster(n,i),this.stopSessionsFromRoster(r,i),this.lastProcessedSequenceNumber=e.sequenceNumber}handleContentSharingEnd(e){const t=e.body,i=_s(e);this.logger.info("handleContentSharingEnd : ",Ve(t));const n=this.contentSharingSessions[t.contentSharingCorrelationId];if(!n)return void this.logger.info("Ignoring contentSharingEnd since there is no corresponding sharing ongoing");if(!n.handleStop(t,i))return;const r={...t.contentSharingTransactionEnd};this.raiseContentSharingStopped(t.contentSharingCorrelationId,i,t.presenter.id,r)}parseContentSharingSessionsFromRoster(e){const t={},i={},n=new Set;for(const i of Object.keys(e.participants)){const r=e.participants[i];if("Delta"===e.type&&this.lastProcessedSequenceNumberForParticipant.hasOwnProperty(i)&&r.version<=this.lastProcessedSequenceNumberForParticipant[i])continue;if(r.version=r.version||-1,this.lastProcessedSequenceNumberForParticipant[i]=r.version,n.add(r.details.id),!r.endpoints)continue;const s=this.signalingSession.participantManager.localParticipant.participantId;for(const e of Object.keys(r.endpoints)){const i=r.endpoints[e],n=i?.contentSharing?.sessionInformation;"presenter"===n?.role&&(t[n.contentSharingCorrelationId]={presenterId:r.details.id,sessionInfo:n,selfEndpointIsPresenter:i.participantId===s})}}for(const e of Object.keys(this.contentSharingSessions))!t[e]&&n.has(this.contentSharingSessions[e].presenterMri)&&(i[e]=this.contentSharingSessions[e]);return{sessionsWithPresenters:t,sessionsWithoutPresenters:i}}stopSessionsFromRoster(e,t){this.logger.info(`[${t}][stopSessionsFromRoster]`);for(const i of Object.keys(e))this.logger.info(`[${t}][stopSessionsFromRoster] stopping session with correlationId ${i}`),this.stopSession(e[i],t)}stopSession(e,t){this.logger.info(`[${t}][stopSession] Stopping session ${e.sessionId}`),e.handleStopFromRoster(this.DEFAULT_STOP_REASON,t),this.raiseContentSharingStopped(e.correlationId,t)}startSessionsFromRoster(e,t){this.logger.info(`[${t}][startSessionsFromRoster]`);for(const i of Object.keys(e)){this.logger.info(`[${t}][startSessionsFromRoster]`);const n=this.contentSharingSessions[i],r=e[i];if(this.pendingSessionToStart&&this.pendingSessionToStart.correlationId===i?this.pendingSessionToStart.confirmInRoster():n&&n.confirmInRoster(),n)n&&(this.contentSharingSessions[i].presenterMri=r.presenterId,this.logger.info(`[${t}][startSessionsFromRoster]Session ${i} is already present locally`));else{if(r.selfEndpointIsPresenter){this.logger.info(`[${t}][startSessionsFromRoster]This endpoint is presenting, dont fire callback`);continue}this.logger.info(`[${t}][startSessionsFromRoster]New sharing session found. Raising ContentSharingStarted`),this.raiseContentSharingStarted(r.presenterId,r.sessionInfo,t).handleStartFromRoster(r.presenterId,t)}}}raiseContentSharingStopped(e,t,i,n){this.logger.info(`[${t}][raiseContentSharingStopped]`),this.signalingSessionCallback.onContentSharingStopped({sessionId:this.contentSharingSessions[e].sessionId,correlationId:e,endedBy:i||this.DEFAULT_STOP_ID,reason:n||this.DEFAULT_STOP_REASON},t),delete this.contentSharingSessions[e]}raiseContentSharingStarted(e,t,i){this.logger.info(`[${i}][raiseContentSharingStarted]`);const n=new Hc(this.signalingSession,t.contentSharingCorrelationId,t.contentSharingSessionId,{[Zr.LINKS.CONTENT_SHARING_CONTROLLER]:t.contentSharingController});n.presenterMri=e,this.contentSharingSessions[n.correlationId]=n;const r={sessionId:t.contentSharingSessionId,correlationId:t.contentSharingCorrelationId,contentIdentifier:t.identifier,presenter:e,subject:t.subject||null,sessionState:t.sessionState||null};return this.signalingSessionCallback.onContentSharingStarted(r,i),n}rejectBecauseOfMissingSession(e,t){const i=`There is no ContentSharing session with the correlation ID ${e}`;this.logger.error(i),t&&t.reject(new Error(i))}},$c={Default:{retryIntervalsMs:[200,1e3,5e3],maxRequestAttempts:4,perRequestTimeoutMs:45e3,perAttemptTimeoutMs:15e3,perRequestTimeoutWithHedgingMs:45e3,perAttemptTimeoutWithHedgingMs:3e4,hedgeDelayMs:4e3},BrokerSubscribe:{retryIntervalsMs:[100,200,500],maxRequestAttempts:4,perRequestTimeoutMs:3e4,perAttemptTimeoutMs:3e4,perRequestTimeoutWithHedgingMs:45e3,perAttemptTimeoutWithHedgingMs:3e4}},jc={CallSetup:{requestHedgingCapability:["disabled"],hedgeDelayMs:4e3},Other:{requestHedgingCapability:["disabled"]},BrokerSubscribe:{requestHedgingCapability:["disabled"]}},Gc="HttpRequestDispatcherFactory";function Wc(e,t,i){t?.signalingSession?t.signalingSession.telemetryHelper?.addTokenTelemetry(e,t?.tokenTelemetryData):i?.info("[reportTokenTelemetryData] signaling session is not available, cannot send token telemetry")}function qc(e,t){const{signalingSession:i,operation:n,causeId:r,data:s,customHeaders:a={},forceFetchToken:o,tokenRequestOptions:l}=e;if(i.disposed)return Promise.reject("Session already disposed");const d=e=>{const t="string"==typeof e?new Error(e):e;throw i.signalingAgent.clientSupportsGenericTokenAPI?e.timeOut?t.tokenTimeoutError=!0:t.tokenError=!0:t.skypeTokenError=!0,t};let c=!1;const h={signalingSession:i,tokenTelemetryData:{}};return i.signalingAgent.authTokenManager.getToken(r,o,l,h).catch((n=>(Wc(e.requestId,h,t),!o&&function(e){const t=Rs(e.signalingAgentConfig.trouterServiceProvider);return 3===t||1===t}(i)&&i.signalingAgentConfig.attemptHttpRequestWithCachedSkypetoken&&i.signalingAgent.authTokenManager.getLastToken(r)?(c=!0,Promise.resolve(i.signalingAgent.authTokenManager.getLastToken(r))):(t?.info(`[${r}] getToken failed with error ${n}`),d(n))))).then((o=>{if(i.disposed)throw new Error("token returned too late. Object is already disposed");Wc(e.requestId,h,t);const l=new ts;if(l.set(Zr.HEADERS.CORRELATION_ID,i.correlationId),l.set(Zr.HEADERS.MESSAGE_ID,function(e){return e&&/^[a-z0-9]{8}$/.test(e)?e+ls().substr(8):ls()}(r)),l.set(Zr.HEADERS.CLIENT_USER_AGENT,i.signalingAgentConfig.clientInformation),i.signalingAgent.clientSupportsGenericTokenAPI){const e=i.signalingAgent.authTokenManager.getLastTokenType(r);switch(i.signalingAgentConfig.disableTokenMigrationHeader||l.set(Zr.HEADERS.TOKEN_MIGRATION,"True"),e){case 8:case 4:l.set(Zr.HEADERS.AUTHORIZATION,`${Zr.HEADERS.BEARER_KEYWORD} ${o}`),l.delete(Zr.HEADERS.SKYPE_TOKEN);break;case 1:l.set(Zr.HEADERS.SKYPE_TOKEN,o),l.delete(Zr.HEADERS.AUTHORIZATION);break;default:throw new Error(`Error in RequestBuilder. TokenType ${e} is not supported`)}}else l.set(Zr.HEADERS.SKYPE_TOKEN,o);const d=i.participantManager.localParticipant;d&&(d.ring&&l.set(Zr.HEADERS.RING,d.ring),d.region&&l.set(Zr.HEADERS.REGION,d.region),d.partition&&l.set(Zr.HEADERS.PARTITION,d.partition));const u=s?.payload?JSON.stringify(s.payload):null,p={headers:{...l?.getAll(),...a},payload:u,usedCachedSkypetoken:c,reporting:{serviceName:n?`${Gc}-${n}`:Gc}};return i.telemetryHelper.addNetworkOperationStarted(n),p})).catch(d)}var zc=class{constructor(e,t,i,n,r,s,a,o,l){this.causeId=e,this.logger=t,this.dispatcher=i,this.requestType=n,this.url=r,this.request=s,this.onRequestFailed=a,this.authRequiredCallback=o,this.settings=l,this.requestsSent=0,this.otherAttemptSuccessful=!1,this.pendingAttempts=[],this.hedgeDelayMs=3e3,this.hedgeMaxParallelAttempts=3,this.stopStandardRetryTimer=()=>{this.standardRetryTimer&&(this.standardRetryTimer.stop(),this.standardRetryTimer=null)},this.stopHedgeTimer=()=>{this.hedgeTimer&&(this.hedgeTimer.stop(),this.hedgeTimer=null)},this.stopAttemptTimeoutTimer=e=>{try{e.timeoutTimer&&(e.timeoutTimer.stop(),this.logger.info("attempt timer stopped"))}catch(e){this.logger.info(`stopAttemptTimeoutTimer error ${e}`)}},this.stopRequestTimer=()=>{try{this.requestTimer&&(this.requestTimer.stop(),this.logger.info("Request timer stopped"))}catch(e){this.logger.info(`stopRequestTimer error ${e}`)}this.requestTimer=null},this.canScheduleNextAttempt=()=>{if(this.stackError===Zr.HTTP_STACK_ERROR.REQUEST_ABORTED||this.otherAttemptSuccessful||this.requestsSent>=this.settings.maxRequestAttempts)return this.logger.info(`canScheduleNextAttempt stack error ${this.stackError} otherAttemptSuccessful ${this.otherAttemptSuccessful} exceeded max attempt ${this.requestsSent>=this.settings.maxRequestAttempts}`),!1;if(this.settings.enableRequestHedging){const e=this.pendingAttempts.length<this.hedgeMaxParallelAttempts;return e||this.logger.info(`canScheduleNextAttempt enableRequestHedging attempts sent: ${this.pendingAttempts.length} max attempts: ${this.hedgeMaxParallelAttempts}`),e}{const e=this.requestsSent<this.settings.retryIntervalsMs.length;return e||this.logger.info(`canScheduleNextAttempt attempts sent: ${this.requestsSent} max attempts: ${this.settings.retryIntervalsMs.length}`),e}},this.scheduleNextRequest=e=>{this.settings.enableRequestHedging?(this.logger.info("scheduleNextRequest with hedging"),this.hedgeTimer=Oc.build((()=>{this.attempt(),this.canScheduleNextAttempt()&&this.scheduleNextRequest(!1)}),"HEDGE").start(this.getNextDelay(e))):(this.logger.info("scheduleNextRequest with retry"),this.standardRetryTimer=Oc.build((()=>{this.attempt()}),"RETRY").start(this.getNextDelay(e)))},this.standardizeFailedRequest=(e,t)=>{let i;const n=this.logger.createChild("[standardizeFailedRequest]");try{if(this.stackError===Zr.HTTP_STACK_ERROR.REQUEST_TIMEOUT)n.info("request timed out"),i=wr.REQUEST_TIMEOUT;else if(this.stackError===Zr.HTTP_STACK_ERROR.REQUEST_ABORTED)n.info("request aborted"),i=wr.REQUEST_ABORTED;else if(t&&t.status===Zr.HTTP_STACK_ERROR.ATTEMPT_TIMEOUT)n.info("request attempt timed out"),i=wr.ATTEMPT_TIMEOUT;else if(t&&[Zr.HTTP_STACK_ERROR.ATTEMPT_ABORTED,Zr.HTTP_STACK_ERROR.ABORTED_OTHER_ATTEMPT_SUCCESSFUL].indexOf(t.status)>-1)n.info("request attempt aborted"),i=wr.ATTEMPT_ABORTED;else if(e){if(n.info(`request ${He(e)}`),"function"==typeof XMLHttpRequest&&e instanceof XMLHttpRequest)i=e;else if("function"==typeof XMLHttpRequest&&e&&e.request instanceof XMLHttpRequest){const t=e;i={response:{...t?.request?.response,headers:t.response?.headers},status:t.request.status,statusText:t.request.statusText,readyState:t.request.readyState}}else e.status||e.statusCode||e.response?i={response:e.response,status:[void 0,null,""].indexOf(e.status)>-1?e.statusCode:e.status,statusText:e.statusText,readyState:e.readyState}:(n.info("Local http stack error"),i={response:Zr.CALL_END_SUB_CODE.LOCAL_HTTP_STACK_ERROR,status:Zr.CALL_END_CODE.LOCAL_HTTP_STACK_ERROR,statusText:"LocalHTTPStackError",readyState:e.readyState||0});this.isBrowserOffline()&&0===i.status&&4===i.readyState&&(n.info("offline"),i={response:Zr.HTTP_STACK_ERROR.CANNOT_CONNECT,status:Zr.HTTP_STATUS_CODES.OFFLINE,statusText:"offline",readyState:i.readyState}),e.response?.message&&(e.response.message.operationFailure||e.response.message.broadcastOperationFailure)?i={response:e.response.message}:!e.response&&e.body?.operationFailure&&(i={response:e.body})}else n.info("no response"),i={response:Zr.HTTP_STACK_ERROR.NONE,status:Zr.HTTP_STATUS_CODES.OTHER,statusText:"Empty Response",readyState:0}}catch(e){n.info(`Failed to handle error ${e}`),i={response:"",status:Zr.HTTP_STATUS_CODES.OTHER,statusText:"FailedToHandleError",readyState:0}}return i},this.hasPendingAttempts=()=>this.pendingAttempts.some((e=>e.pending)),this.getRequestFromStatus=e=>e&&e.request&&e.request.status||0,this.isBrowserOffline=()=>navigator&&!1===navigator.onLine,this.logger=t.createChild(`[${this.causeId}][Dispatcher]`),this.logger.info(`created request, url=${r}`),!isNaN(this.settings.hedgeDelayMs)&&this.settings.hedgeDelayMs>=500&&this.settings.hedgeDelayMs<=1e4&&(this.hedgeDelayMs=this.settings.hedgeDelayMs),!isNaN(this.settings.hedgeMaxParallelAttempts)&&this.settings.hedgeMaxParallelAttempts>=0&&this.settings.hedgeMaxParallelAttempts<=4&&(this.hedgeMaxParallelAttempts=this.settings.hedgeMaxParallelAttempts),(isNaN(this.settings.perAttemptTimeoutMs)||this.settings.perAttemptTimeoutMs<=0)&&(this.settings.perAttemptTimeoutMs=15e3),(isNaN(this.settings.perRequestTimeoutMs)||this.settings.perRequestTimeoutMs<=0)&&(this.settings.perRequestTimeoutMs=45e3),(isNaN(this.settings.maxRequestAttempts)||this.settings.maxRequestAttempts<=0)&&(this.settings.maxRequestAttempts=4),(isNaN(this.settings.perRequestTimeoutWithHedgingMs)||this.settings.perRequestTimeoutWithHedgingMs<=0)&&(this.settings.perRequestTimeoutWithHedgingMs=45e3),(isNaN(this.settings.perAttemptTimeoutWithHedgingMs)||this.settings.perAttemptTimeoutWithHedgingMs<=0)&&(this.settings.perAttemptTimeoutWithHedgingMs=3e4)}sendRequest(){return this.stackError=Zr.HTTP_STACK_ERROR.NONE,this.logger.info("send api called"),this.requestTimer=Oc.build((()=>{this.stackError=Zr.HTTP_STACK_ERROR.REQUEST_TIMEOUT,this.cancelAllAttempts(Zr.HTTP_STACK_ERROR.REQUEST_TIMEOUT)}),"REQUEST_TIMEOUT").start(this.settings.enableRequestHedging?this.settings.perRequestTimeoutWithHedgingMs:this.settings.perRequestTimeoutMs),new Promise(((e,t)=>{this.resolve=e,this.reject=t,this.scheduleNextRequest(!0)}))}cancelRequest(){this.logger.info("cancelRequest"),this.stackError=Zr.HTTP_STACK_ERROR.REQUEST_ABORTED,this.cancelAllAttempts(Zr.HTTP_STACK_ERROR.ATTEMPT_ABORTED)}cancelOtherAttempts(e){this.pendingAttempts.splice(e-1,1),this.cancelAllAttempts(Zr.HTTP_STACK_ERROR.ABORTED_OTHER_ATTEMPT_SUCCESSFUL)}cancelAllAttempts(e){this.stopHedgeTimer(),this.stopStandardRetryTimer(),this.pendingAttempts.forEach((t=>{t.status=e,t.cancelDeferred.resolve(),this.stopAttemptTimeoutTimer(t)})),this.stopRequestTimer()}getRequestMethod(e){switch(e){case 0:return this.dispatcher.getAsync.bind(this.dispatcher);case 1:return this.dispatcher.postAsync.bind(this.dispatcher);case 2:return this.dispatcher.putAsync.bind(this.dispatcher);case 3:return this.dispatcher.removeAsync.bind(this.dispatcher);default:return null}}async queueAttempt(e){const t=e&&this.isNotRetryable(e);if(this.logger.info("queueAttempt"),t||!this.canScheduleNextAttempt())return this.logger.info(`unable to retry isNotRetryable ${t} ${JSON.stringify(e)}`),this.stopHedgeTimer(),this.stopRequestTimer(),void(this.hasPendingAttempts()||(this.settings.reportPreviousErrorsForTimeout&&e===wr.ATTEMPT_TIMEOUT&&this.previousAttempt?this.reject(this.previousAttempt):this.reject(e)));if(this.isAuthFailedStatus(e)){this.logger.info("auth failed"),this.stopHedgeTimer(),this.stopStandardRetryTimer(),this.stopRequestTimer();try{const t=e?.response?.headers,i=function(e){const t=ts.getHeaderValue(e,Zr.HEADERS.SKYPE_TOKEN);if(t)return t;const i=ts.getHeaderValue(e,Zr.HEADERS.AUTHORIZATION);if(i){const e=i.split(" ");if(2===e.length)return e[1]}}(this.request?.headers),n=await this.authRequiredCallback(t,i);this.request=n}catch(t){return void this.reject(e)}}this.previousAttempt=e,this.hedgeTimer?this.logger.info("scheduleNextRequest ignored as there's already active hedge timer"):this.scheduleNextRequest(!1)}attempt(){if(this.logger.info("attempt to send request"),this.stackError===Zr.HTTP_STACK_ERROR.REQUEST_ABORTED||this.otherAttemptSuccessful)return;const e=(new Date).getTime();this.requestsSent++;const t=this.requestsSent,i=As();this.request.timeout=i.promise;const n={cancelDeferred:i,status:Zr.HTTP_STACK_ERROR.NONE,timeoutTimer:null,pending:!0},r=Oc.build((()=>{n.status=Zr.HTTP_STACK_ERROR.ATTEMPT_TIMEOUT,n.cancelDeferred.resolve()}),"ATTEMPT_TIMEOUT").start(this.settings.enableRequestHedging?this.settings.perAttemptTimeoutWithHedgingMs:this.settings.perAttemptTimeoutMs);n.timeoutTimer=r,this.pendingAttempts.push(n),this.getRequestMethod(this.requestType)(this.url,this.request).then((i=>{if(this.logger.info(`attempt successful, request response=${vc.scrubDisplayNamesFromResponse(i)} status=${this.getRequestFromStatus(i)}`),this.otherAttemptSuccessful)throw"Other attempt succesful";if(this.stackError===Zr.HTTP_STACK_ERROR.REQUEST_ABORTED)throw"Session disposed";if(!i)throw"Invalid response";n.pending=!1,this.otherAttemptSuccessful=!0,this.stopRequestTimer(),this.stopHedgeTimer(),this.stopAttemptTimeoutTimer(n),this.cancelOtherAttempts(t),this.resolve({success:!0,request:i.request,response:i.response,attempt:this.requestsSent,attemptStartTimestamp:e,attemptResponseTimestamp:(new Date).getTime()})})).catch((t=>{n.pending=!1,this.stopAttemptTimeoutTimer(n);const i=this.standardizeFailedRequest(t,n);this.logger.info(`attempt failed, request: ${He(t)} status=${i.status}`),this.onRequestFailed({abandoned:this.otherAttemptSuccessful,success:!1,request:i,attempt:this.requestsSent,attemptStartTimestamp:e,attemptResponseTimestamp:(new Date).getTime()}),this.queueAttempt(i)}))}getNextDelay(e){let t;if(e)t=0;else if(this.settings.enableRequestHedging)t=this.hedgeDelayMs;else{if(!(this.requestsSent<=this.settings.retryIntervalsMs.length))throw"Unable to get next delay";t=this.settings.retryIntervalsMs[this.requestsSent-1]}return this.logger.info(`next delay= ${t} ms`),t}isRequestWithStatus(e,t){return!!e&&t.indexOf(e.status)>-1}isNotRetryable(e){return!ws(e&&e.status)}isAuthFailedStatus(e){return this.isRequestWithStatus(e,[Zr.HTTP_STATUS_CODES.UNAUTHORIZED])}},Kc={1:"POST",0:"GET",2:"PUT",3:"DELETE"},Jc=class{constructor(e,t){this.signalingSession=e,this.callStartTime=t,this.pendingRequests={},this.sendGetRequest=e=>this.sendRequest(0,e),this.sendPostRequest=e=>this.sendRequest(1,e),this.sendPutRequest=e=>this.sendRequest(2,e),this.sendDeleteRequest=e=>this.sendRequest(3,e),this.cancelRequestIfPending=(e,t,i,n)=>{this.logger.info(`[${t}][cancelRequestIfPending]`),this.pendingRequests[e]?i?this.hasPendingRequest(e,i)&&this.cancelRequest(e,i,t,n):Object.keys(this.pendingRequests[e]).forEach((i=>this.cancelRequest(e,i,t,n))):this.logger.info(`[${t}][cancelRequestIfPending]no pending request with name=${e}`)},this.cancelAllRequests=e=>{this.logger.info(`[${e}][cancelAllRequests]`);const t=[];return Object.keys(this.pendingRequests).forEach((i=>{Object.keys(this.pendingRequests[i]).forEach((n=>{t.push(this.cancelRequest(i,n,e))}))})),Promise.all(t).catch((()=>{}))},this.hasPendingRequest=(e,t)=>!!this.pendingRequests[e]&&Boolean(t?this.pendingRequests[e][t]:this.pendingRequests[e]),this.cancelRequest=(e,t,i,n)=>{try{return this.pendingRequests[e][t].dispatcher&&this.pendingRequests[e][t].dispatcher.cancelRequest(),this.pendingRequests[e][t].aborted=!0,this.pendingRequests[e][t].errorDetails=n,this.logger.info(`[${i}][cancelRequest]Request=${e} aborted ${n?`with errorDetails ${JSON.stringify(n)}`:""}`),this.pendingRequests[e][t].requestPromise.catch((()=>{}))}catch(n){return this.logger.warn(`[${i}][cancelRequest]Unable to cancel request=${e}, requestId=${t}`),Promise.resolve()}},this.buildRequestTelemetry=(e,t,i,n)=>({name:`${Kc[e]}-${t.requestName}`,url:t.url,eventStart:i-this.callStartTime,trouterReady:-1,requestReady:-1,status:-1,attempts:[],rtt:-1,uid:t.requestId,causeId:t.causeId,requestDispatcherConfig:n,enableRequestHedging:this.shouldEnableRequestHedging(n)}),this.addPendingRequest=e=>(this.pendingRequests[e.requestName]||(this.pendingRequests[e.requestName]={}),this.pendingRequests[e.requestName][e.requestId]={dispatcher:null,requestPromise:null,aborted:!1},this.pendingRequests[e.requestName][e.requestId]),this.sendRequest=(e,t)=>{if(!t.url){this.logger.error(t.requestName,"Link does not exist");const e={code:Zr.CALL_END_CODE.HTTP_OTHER_ERROR,subCode:Zr.CALL_END_SUB_CODE.MISSING_REQUEST_URI,phrase:`Link does not exist for requestName: ${t.requestName}.`};return Promise.reject(e)}t.requestId||(t.requestId=ls()),t.causeId||(t.causeId=os());const i=this.logger.createChild(`[${t.causeId}][${t.requestName}]`);i.info("[scheduled]");const n=this.getInternalHttpDispatcherConfig(t.requestName,t.operationType);let r;t.skipHttpTelemetry||(t.skipHttpTelemetry=!1);const s=Vc(),a=(new Date).getTime(),o=[],l=this.buildRequestTelemetry(e,t,a,n),d=()=>{this.signalingSession.disposed?this.logger.info("Unable to record telemetry, session disposed"):this.signalingSession.telemetryHelper.updateNetworkRequest(l)},c=()=>{this.signalingSession.telemetryHelper.deleteNetworkRequest(l)};d();const h=(e,n)=>{if(!e?.request)return void this.logger.warn(t.requestName,"missing request details, unable to record for telemetry!");i.info(`[finished][status=${e.request.status}][statusText=${e.request.statusText}][retryCount=${e.attempt}]`);const r={status:e.request.status,statusSubCode:e.request.response?.operationFailure?.subCode,start:e.attemptStartTimestamp-a,end:e.attemptResponseTimestamp-a,online:Rs(this.signalingSession.signalingAgentConfig.trouterServiceProvider)};e.abandoned&&(r.abandoned=!0),e.request.statusText&&(r.statusText=e.request.statusText),(n||-1===l.status)&&(l.status=e.request.status),l.attempts.push(r),d()};if(this.hasPendingRequest(t.requestName,t.requestId))return this.logger.warn(t.requestName,t.requestId,"is already pending request!!"),this.pendingRequests[t.requestName][t.requestId].requestPromise;r=this.addPendingRequest(t);const u=(e,n,r,a)=>{if(e&&t.skipHttpTelemetry)return this.logger.info("Skipping telemetry"),void c();i.info(`[steps=${o}]`),this.pendingRequests[t.requestName][t.requestId].aborted&&(l.aborted=!0),this.hasPendingRequest(t.requestName,t.requestId)?(delete this.pendingRequests[n][r],Object.keys(this.pendingRequests[n]).length||delete this.pendingRequests[n]):this.logger.warn("Unable to clean up!"),this.signalingSession.disposed||(a&&(l.error=a),l.rtt=s.duration(),this.signalingSession.telemetryHelper.addNetworkOperationCompleted(t.requestName,e,s.duration()),d(),this.signalingSession.telemetryHelper.sendHttpTelemetryData(l.uid))},p=e=>(...n)=>{if(this.signalingSession.disposed){const e=`[${t.causeId}][${t.requestName}][failed][reason=Session disposed]`;throw i.info("[failed][reason=Session disposed]"),new Error(e)}if(this.hasPendingRequest(t.requestName,t.requestId)&&this.pendingRequests[t.requestName][t.requestId].aborted){let e;const n=`[${t.causeId}][${t.requestName}][failed][reason=request already aborted]`,r=this.pendingRequests[t.requestName][t.requestId].errorDetails;throw r?(e=r,e.phrase=n):e=n,i.info(`${n}`),new Error(JSON.stringify(e))}return e(...n)},g=p((()=>(o.push("[waitForTrouter]"),t.withoutTrouter?Promise.resolve():this.signalingSession.ensureMessageChannelReady(t.requestName)))),m=p((()=>(o.push("[trouterReady]"),l.trouterReady=s.duration(),t.onceTrouterReady&&t.onceTrouterReady(),d(),Promise.resolve()))),f=p((()=>{const i=this.signalingSession.signalingAgent.clientSupportsGenericTokenAPI,n=Ds(this.signalingSession.signalingAgentConfig,i,e,t,!1,void 0,this.logger);return o.push("[buildRequest]"),qc({signalingSession:this.signalingSession,operation:t.requestName,data:t.payload,customHeaders:t.customHeaders?.getAll(),causeId:t.causeId,tokenRequestOptions:n,requestId:t.requestId},this.logger)})),S=p((e=>{o.push("[failedToBuildRequestOptions]");const t={request:{status:Zr.HTTP_STATUS_CODES.OTHER,statusText:"Local error"},attempt:1,success:!1,attemptResponseTimestamp:(new Date).getTime(),attemptStartTimestamp:(new Date).getTime()};return e&&(e.skypeTokenError?t.request={status:Zr.CALL_END_SKYPE_TOKEN_ERROR.code,statusText:Zr.CALL_END_SKYPE_TOKEN_ERROR.phrase}:e.tokenError?t.request={status:Zr.CALL_END_TOKEN_ERROR.code,statusText:Zr.CALL_END_TOKEN_ERROR.phrase}:e.tokenTimeoutError&&(t.request={status:Zr.CALL_END_TOKEN_TIMEOUT_ERROR.code,statusText:Zr.CALL_END_TOKEN_TIMEOUT_ERROR.phrase})),h(t,!1),Promise.reject(e)})),v=p((e=>(o.push("[requestBuilt]"),l.requestReady=s.duration(),e.usedCachedSkypetoken&&(l.usedCachedSkypetoken=e.usedCachedSkypetoken),d(),Promise.resolve(e)))),y=(i,n)=>{o.push("[authRequired]");const r=this.signalingSession.signalingAgent.clientSupportsGenericTokenAPI,s=Ds(this.signalingSession.signalingAgentConfig,r,e,t,!0,i,this.logger);return s.invalidToken=n,qc({signalingSession:this.signalingSession,operation:t.requestName,data:t.payload,customHeaders:t.customHeaders?.getAll(),causeId:t.causeId,forceFetchToken:!0,tokenRequestOptions:s,requestId:t.requestId},this.logger)},C=p((i=>{o.push("[sendRequest]");const s={...n,enableRequestHedging:this.shouldEnableRequestHedging(n),hedgeDelayMs:n.hedgeDelayMs,hedgeMaxParallelAttempts:this.signalingSession.signalingAgentConfig.hedgeMaxParallelAttempts,retryIntervalsMs:t.disableRetry||!n.retryIntervalsMs?[]:n.retryIntervalsMs,reportPreviousErrorsForTimeout:this.signalingSession.signalingAgentConfig.reportPreviousErrorsForTimeout},a=(l={logger:this.logger,causeId:t.causeId,dispatcher:this.signalingSession.signalingAgentConfig.httpRequestDispatcher,url:t.url,request:i,requestType:e,authRequiredCallback:y,attemptFailureCallback:e=>{h(e,!1)},settings:s},new zc(l.causeId,l.logger,l.dispatcher,l.requestType,l.url,l.request,l.attemptFailureCallback,l.authRequiredCallback,l.settings));var l;return r.dispatcher=a,d(),a.sendRequest()})),T=p((async e=>(h(e,!0),i.info("[success]"),u(!0,t.requestName,t.requestId),e))),E=Promise.resolve().then(g).then(m).then(f).catch(S).then(v).then(C).then(T).catch((e=>{const n=Ve(e);return u(!1,t.requestName,t.requestId,n),!e||e.readyState||e.status?i.info(`[failed][reason=${n}]`):i.info(`[failed][offline][reason=${n}]`),Promise.reject(e)}));return r.requestPromise=E,E},this.logger=this.signalingSession.logger.createChild("[HTTP]")}getInternalHttpDispatcherConfig(e,t="Other"){let i={...$c.Default,...jc[t],...$c[e]};return this.signalingSession&&this.signalingSession.signalingAgentConfig&&this.signalingSession.signalingAgentConfig.operationTypeHttpDispatcherConfigMap&&(i={...i,...this.signalingSession.signalingAgentConfig.operationTypeHttpDispatcherConfigMap[t]}),this.signalingSession&&this.signalingSession.signalingAgentConfig&&this.signalingSession.signalingAgentConfig.requestTypeHttpDispatcherConfigMap&&(i={...i,...this.signalingSession.signalingAgentConfig.requestTypeHttpDispatcherConfigMap.Default,...this.signalingSession.signalingAgentConfig.requestTypeHttpDispatcherConfigMap[e]}),this.logger.info(`getInternalHttpDispatcherConfig request type: ${e} config: ${He(i)}`),i}shouldEnableRequestHedging(e){return!!(this.signalingSession.getMeetingInfo()&&e.requestHedgingCapability.indexOf("enabledForMeetings")>-1)||!this.signalingSession.multiParty&&e.requestHedgingCapability.indexOf("enabledForP2PCalls")>-1||!!(this.signalingSession.multiParty&&e.requestHedgingCapability.indexOf("enabledForGroupCalls")>-1)||e.requestHedgingCapability.indexOf("enabled")>-1}};function Yc(e,t,i){hs(e,"signalingSession cannot be null");let n=[];i&&(n=ps(i),e.telemetryHelper.addOutgoingModalities(n));const r=os();return{payload:{mediaNegotiation:{callModalities:n,sender:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},links:{mediaAnswer:is(e,Dr.MEDIA_ANSWER,r),rejection:is(e,Dr.MEDIA_REJECTION,r)},mediaContent:t}}}}function Qc(e,t){return hs(e,"signalingSession cannot be null"),us(t),{payload:{mediaNegotiationFailure:{sender:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},code:t.code,subCode:t.subCode,phrase:t.phrase},debugContent:{callId:e.correlationId,endpointId:e.participantManager.localParticipant.endpointId}}}}function Xc(e,t,i){hs(e,"signalingSession cannot be null");let n=[];return i&&(n=ps(i),e.telemetryHelper.addOutgoingModalities(n)),{payload:{mediaAnswer:{callModalities:n,sender:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},links:{mediaAcknowledgement:is(e,Dr.MEDIA_ACKNOWLEDGEMENT)},clientContentForMediaController:e.webRtcSignalingManager.getClientUrls(),mediaContent:t},debugContent:{callId:e.correlationId,endpointId:e.participantManager.localParticipant.endpointId}}}}var Zc=class{constructor(e,t,i){this.telemetryHelper=i,this.vbssInitiated=!1,this.disposed=!1,this.fsmState=Zr.MEDIA_RENEGOTIATION_FSM_STATE.IDLE,this.fsmStateCauseId="",this.links={},this.renegotiationOffersSeenSoFar=[],this.isOutgoingRenegotiationInProgress=()=>this.fsmState===Zr.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION||this.fsmState===Zr.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE,this.isIncomingRenegotiationInProgress=()=>this.fsmState===Zr.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION||this.fsmState===Zr.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE,this.acceptRenegotiationAsync=(e,t,i)=>{this.logger.info(`[${i}][acceptRenegotiationAsync][mediaTypes=${t}]`),this.signalingSession.telemetryHelper.recordEvent(Ks,{mediaTypes:t,causeId:i}),cs(this.links[Zr.LINKS.MEDIA_ANSWER],"MediaAnswer link not set");const n=As();switch(this.fsmState){case Zr.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION:this.setFsmState(Zr.MEDIA_RENEGOTIATION_FSM_STATE.CALL_CONNECTED,i);break;case Zr.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE:this.setFsmState(Zr.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION,i);break;default:return this.logger.info(`[${i}][acceptRenegotiationAsync]there is no incoming media renegotiation offer to accept`),n.reject(new Error("there is no incoming media renegotiation offer to accept")),n.promise}return this.signalingSession.http.sendPostRequest({url:this.links[Zr.LINKS.MEDIA_ANSWER],payload:Xc(this.signalingSession,e,t),requestName:cc.SEND_MEDIA_ANSWER.name,onceTrouterReady:()=>{this.signalingSession.timeoutManager.startTimer(Zr.TIMEOUT_OPERATIONS.MEDIA_ANSWER_ACKNOWLEDGEMENT,this.handleMediaAnswerAcknowledgmentTimeout.bind(this,i),Zr.TIMEOUT_VALUES_IN_SECONDS.MEDIA_ANSWER_ACKNOWLEDGEMENT_TIMEOUT)},causeId:i}).then((e=>{n.resolve(e.response)})).catch((e=>{const t=Cs(e,this.signalingSession.signalingAgentConfig);this.logger.info(`[${i}][acceptRenegotiationAsync] error: ${Ve(t)}`),this.disposed||this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.MEDIA_ANSWER_ACKNOWLEDGEMENT),n.reject(new Error(`acceptRenegotiationAsync failed because : ${Ve(e)}`))})),n.promise},this.startRenegotiationAsync=(e,t,i,n)=>{this.logger.info(`[${n}][startRenegotiationAsync][mediaTypes=${i}]`),this.signalingSession.telemetryHelper.recordEvent(Js,{causeId:n,mediaTypes:i}),cs(t,"MediaRenegotiation link not set");const r=As();switch(this.fsmState){case Zr.MEDIA_RENEGOTIATION_FSM_STATE.CALL_CONNECTED:this.setFsmState(Zr.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION,n);break;case Zr.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION:case Zr.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION:case Zr.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE:return this.logger.info(`[${n}][startRenegotiationAsync][failed] can only be performed with no current outstanding renegotiations, previous negotiation causeId=${this.fsmStateCauseId}`),this.signalingSessionCallback.onMediaRenegotiationRejection(this.getGlareError(),n),Promise.resolve(null);default:return this.logger.info(`[${n}][startRenegotiationAsync][failed] can only be performed on an established call`),r.reject(new Error("media renegotiation can only be performed on an established call")),r.promise}const s=i&&fs(i,Zr.MEDIA_TYPES.SCREEN_SHARER);return s?(this.vbssInitiated=!0,this.signalingSession.telemetryHelper.addVbssOperations(hc.VBSS_OPERATION.START)):!s&&this.vbssInitiated&&(this.vbssInitiated=!1,this.signalingSession.telemetryHelper.addVbssOperations(hc.VBSS_OPERATION.STOP)),this.signalingSession.http.sendPostRequest({url:t,payload:Yc(this.signalingSession,e,i),requestName:cc.START_RENEGOTIATION.name,onceTrouterReady:()=>{this.signalingSession.timeoutManager.startTimer(Zr.TIMEOUT_OPERATIONS.MEDIA_ANSWER,this.handleMediaAnswerTimeout.bind(this),Zr.TIMEOUT_VALUES_IN_SECONDS.MEDIA_ANSWER_TIMEOUT)},causeId:n}).then((e=>{r.resolve(e.response)})).catch((e=>{const t=Cs(e,this.signalingSession.signalingAgentConfig);if(this.logger.info(`[${n}][startRenegotiationAsync] error: ${Ve(t)}`),!this.disposed){switch(this.fsmState){case Zr.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION:this.setFsmState(Zr.MEDIA_RENEGOTIATION_FSM_STATE.CALL_CONNECTED,n);break;case Zr.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE:this.setFsmState(Zr.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION,n)}this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.MEDIA_ANSWER)}r.reject(new Error(`startRenegotiationAsync failed because : ${Ve(e)}`))})),r.promise},this.handleMediaAcknowledgment=(e,t)=>{this.signalingSession.telemetryHelper.recordEvent(Vs,{causeId:t}),this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.MEDIA_ANSWER_ACKNOWLEDGEMENT),this.signalingSession.saveMediaControllerLinksIfAny(e),this.signalingSession.saveUpdatedCallLinksIfAny(e),this.signalingSessionCallback.onMediaAcknowledgementSuccess(!0,t)},this.onCallConnected=e=>{this.logger.info("onCallConnected"),this.setFsmState(Zr.MEDIA_RENEGOTIATION_FSM_STATE.CALL_CONNECTED,e)},this.handleMediaNegotiationFailure=e=>{const t=_s(e);this.signalingSession.telemetryHelper.recordIncomingEvent(Hs,e),this.handleMediaNegotiationFailureInternal(e.body.mediaNegotiationFailure,e.origin,t)},this.handleMediaAnswer=(e,t)=>{switch(this.logger.info(`[${t}][handleMediaAnswer]`),this.signalingSession.telemetryHelper.recordEvent(Bs,{causeId:t}),this.fsmState){case Zr.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION:this.setFsmState(Zr.MEDIA_RENEGOTIATION_FSM_STATE.CALL_CONNECTED,t);break;case Zr.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE:this.setFsmState(Zr.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION,t);break;default:return}this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.MEDIA_ANSWER);let i=[];e.mediaAnswer.callModalities&&e.mediaAnswer.callModalities.length>0&&(i=ps(e.mediaAnswer.callModalities),this.signalingSession.telemetryHelper.addIncomingModalities(i));const n={provisional:!1,renegotiation:!0,mediaTypes:i,remoteParticipantId:this.signalingSession.getParticipantIdForOfferAnswer(e.mediaAnswer.mediaContent),mediaContent:e.mediaAnswer.mediaContent};this.signalingSession.http.sendPostRequest({url:e.mediaAnswer.links.mediaAcknowledgement,payload:null,requestName:cc.SEND_MEDIA_ACKNOWLEDGEMENT.name,causeId:t}).catch((e=>{const i=Cs(e,this.signalingSession.signalingAgentConfig);this.logger.info(`[${t}][handleMediaAnswer] error: ${Ve(i)}`),this.signalingSession.disposed||this.signalingSession.telemetryHelper.recordEvent($s,{causeId:t})})),this.signalingSessionCallback.onAnswer(n,t)},this.handleMediaNegotiationOffer=e=>{const t=e.body,i=e.headers,n=_s(e);this.logger.info(`[${n}][handleMediaNegotiationOffer]`),this.signalingSession.telemetryHelper.recordIncomingEvent(js,e);const r=Ts(i,this.renegotiationOffersSeenSoFar);switch(this.fsmState){case Zr.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION:this.setFsmState(Zr.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE,n),this.raiseMediaRenegotiationOffer(t,n);break;case Zr.MEDIA_RENEGOTIATION_FSM_STATE.CALL_CONNECTED:this.setFsmState(Zr.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION,n),this.raiseMediaRenegotiationOffer(t,n);break;case Zr.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION:if(this.signalingSession&&this.signalingSession.signalingAgentConfig&&this.signalingSession.signalingAgentConfig.supportMediaRetargetWhileIncomingRenegotiation){this.raiseMediaRenegotiationOffer(t,n);break}this.rejectAndLog(n,r,t);break;default:this.rejectAndLog(n,r,t)}},this.rejectRenegotiationAsync=(e,t)=>{this.logger.info(`[${t}][rejectRenegotiationAsync]`),this.signalingSession.telemetryHelper.recordEvent(Gs,{rejectionData:e,causeId:t}),cs(this.links[Zr.LINKS.MEDIA_REJECTION],"MediaRejection link not set");const i=e||{code:Zr.CALL_END_CODE.NOT_ACCEPTABLE_HERE,subCode:Zr.CALL_END_SUB_CODE.MEDIA_ANSWER_PROCESSING_ERROR,phrase:Zr.CALL_END_PHRASE.MEDIA_ANSWER_ERROR};switch(this.fsmState){case Zr.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION:return this.setFsmState(Zr.MEDIA_RENEGOTIATION_FSM_STATE.CALL_CONNECTED,t),this.rejectMediaRenegotiation(this.links[Zr.LINKS.MEDIA_REJECTION],i,t);case Zr.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE:return this.setFsmState(Zr.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION,t),this.rejectMediaRenegotiation(this.links[Zr.LINKS.MEDIA_REJECTION],i,t);default:return this.logger.error(`[${t}][rejectRenegotiationAsync][failed] There is no incoming media renegotiation offer to reject`),Promise.resolve(null)}},this.handleRetargetCompleted=e=>{const t=e.body.retargetCompleted,i=_s(e);this.logger.info(`[${i}][handleRetargetCompleted][details=${Ve(t)}]`),this.signalingSession.telemetryHelper.recordIncomingEvent(Ws,e,Fe(t)),0===t.code?this.signalingSessionCallback.onReTargetCompletedSuccess(i):this.signalingSessionCallback.onReTargetCompletedFailure(t,i)},this.dispose=()=>{this.logger.info("mediaRenegotiationManager :: dispose"),this.disposed=!0},this.getGlareError=()=>({code:Zr.CALL_END_CODE.GLARE_ERROR,subCode:Zr.CALL_END_SUB_CODE.MEDIA_GLARE_ERROR,phrase:Zr.CALL_END_PHRASE.RENEGOTIATION_IN_PROGRESS,previousNegotiationCauseId:this.fsmStateCauseId}),this.handleMediaNegotiationFailureInternal=(e,t,i)=>{switch(this.logger.info(`[${i}][handleMediaNegotiationFailureInternal][failureData=${Fe(e)}]`),this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.MEDIA_ANSWER),this.fsmState){case Zr.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION:this.setFsmState(Zr.MEDIA_RENEGOTIATION_FSM_STATE.CALL_CONNECTED,i);break;case Zr.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE:this.setFsmState(Zr.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION,i);break;default:return}this.vbssInitiated&&(this.vbssInitiated=!1,this.signalingSession.telemetryHelper.addVbssOperations(hc.VBSS_OPERATION.REJECTED)),this.signalingSession.telemetryHelper.addIncomingModalities(["Rejected"]),this.signalingSessionCallback.onMediaRenegotiationRejection({code:e.code,subCode:e.subCode,phrase:e.phrase},i)},this.signalingSession=e,this.signalingSessionCallback=t,this.logger=e.logger.createChild((()=>`[RenegotiationManager][${this.fsmState}][stateCauseId=${this.fsmStateCauseId}]`))}rejectAndLog(e,t,i){this.logger.error(`[${e}][handleMediaNegotiationOffer] Cannot handle the incoming mediaRenegotiation offer in present callstate. Either call not connected or renegotiation in progress. isDuplicateOffer=${t}`),t||this.rejectMediaRenegotiation(i.mediaNegotiation.links.rejection,this.getGlareError(),e)}setFsmState(e,t){this.fsmState=e,this.fsmStateCauseId=t,this.logger.info(`[setFsmState]state=${e}`),this.telemetryHelper.recordEvent(Ys,{state:e,causeId:t})}raiseMediaRenegotiationOffer(e,t){this.logger.info(`[${t}][raiseMediaRenegotiationOffer]`),this.links[Zr.LINKS.MEDIA_ANSWER]=e.mediaNegotiation.links.mediaAnswer,this.links[Zr.LINKS.MEDIA_REJECTION]=e.mediaNegotiation.links.rejection;let i=[];e.mediaNegotiation.callModalities&&e.mediaNegotiation.callModalities.length>0&&(i=ps(e.mediaNegotiation.callModalities),this.signalingSession.telemetryHelper.addIncomingModalities(i),fs(i,Zr.MEDIA_TYPES.SCREEN_SHARER)&&this.signalingSession.telemetryHelper.addVbssOperations(hc.VBSS_OPERATION.REMOTE_START));const n={mediaTypes:i,remoteParticipantId:this.signalingSession.getParticipantIdForOfferAnswer(e.mediaNegotiation.mediaContent),mediaContent:e.mediaNegotiation.mediaContent,renegotiation:!0};this.signalingSessionCallback.onOffer(n,t)}rejectMediaRenegotiation(e,t,i){this.logger.info(`[${i}][rejectMediaRenegotiation][rejectionData=${Fe(t)}]`);const n=As();return this.signalingSession.http.sendPostRequest({url:e,payload:Qc(this.signalingSession,t),requestName:cc.SEND_MEDIA_REJECTION.name,causeId:i}).then((e=>{n.resolve(e.response)})).catch((e=>{const t=Cs(e,this.signalingSession.signalingAgentConfig);this.logger.info(`[${i}][rejectMediaRenegotiation] error: ${Ve(t)}`),n.reject(new Error(`rejectMediaRenegotiation failed because : ${Ve(e)}`))})),n.promise}handleMediaAnswerTimeout(e){this.logger.info(`[${e}][handleMediaAnswerTimeout]`),this.vbssInitiated&&(this.vbssInitiated=!1,this.signalingSession.telemetryHelper.addVbssOperations(hc.VBSS_OPERATION.TIMEOUT)),this.signalingSession.telemetryHelper.addIncomingModalities(["Timeout"]),this.signalingSession.telemetryHelper.recordEvent(qs),this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.MEDIA_ANSWER),this.handleMediaNegotiationFailureInternal({code:Zr.CALL_END_CODE.TIMEOUT,subCode:Zr.CALL_END_SUB_CODE.MEDIA_FINAL_ANSWER_TIMEOUT,phrase:Zr.CALL_END_PHRASE.MEDIA_FINAL_ANSWER_TIMEOUT},hc.EVENT_SOURCE.LOCAL,e)}handleMediaAnswerAcknowledgmentTimeout(e){this.logger.info(`[${e}][handleMediaAnswerAcknowledgmentTimeout]`),this.signalingSession.telemetryHelper.recordEvent(zs),this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.MEDIA_ANSWER_ACKNOWLEDGEMENT),this.signalingSessionCallback.onMediaAcknowledgementFailure(!0,{reason:"timed out waiting for Media Answer Acknowledgement"},e)}},eh=class{constructor(){this.requests={}}clear(e,t){const i=t||{code:Zr.CALL_END_CODE.SUCCESS,subCode:Zr.CALL_END_SUB_CODE.SUCCESS,phrase:Zr.CALL_END_PHRASE.LOCAL_USER_INITIATED};Object.keys(this.requests).forEach((t=>{this.rejectOperation(t,e,i)}))}hasOperation(e){return this.requests.hasOwnProperty(e)}getAllOperations(){return this.requests}getOperation(e){return this.hasOperation(e)?this.requests[e]:null}setOperation(e,t){return!this.hasOperation(e)&&(this.requests[e]=t,!0)}rejectOperation(e,t,i){const n=new Error(t);if(i&&(n.endCode=i),this.hasOperation(e)){const t=this.requests[e].promise;delete this.requests[e],t.reject(n)}}resolveOperation(e,t){if(this.hasOperation(e)){const i=this.requests[e].promise;delete this.requests[e],i.resolve(t)}}},th=class{constructor(e){this.logger=e,this.localAddParticipantRequests=new eh,this.localAdmitParticipantRequests=new eh,this.localCallMeBackRequests=new eh,this.localRemoveParticipantEndpointRequests=new eh,this.localRemoveParticipantRequests=new eh,this.localUpdateParticipantInterpretationStateRequest=new eh,this.participantIdMriMap=new Map}dispose(e,t,i){this.logger.info(`[${i}][dispose]`),this.rejectAllPendingOperations(e,t)}getAllPendingOperations(e,t){this.logger.info(`[${t}][getAllPendingOperations] ${e}`);const i=this.getOperationTable(e);return i?i.getAllOperations():null}getPendingOperation(e,t,i){this.logger.info(`[${i}][getPendingOperation] ${e} ${t}`);const n=this.getOperationTable(e);return n?n.getOperation(t):null}getRnlMri(e,t){this.logger.info(`[${t}][getRnlMri] ${e}`);for(const t of e)if(this.participantIdMriMap.has(t))return this.participantIdMriMap.get(t);return""}hasPendingOperation(e,t,i){this.logger.info(`[${i}][hasPendingOperation] ${e} ${ke(t)}`);const n=this.getOperationTable(e);return!!n&&n.hasOperation(t)}rejectPendingOperation(e,t,i,n,r){this.logger.info(`[${r}][rejectPendingOperation] ${e} ${ke(t)} reason: ${i}`);const s=this.getOperationTable(e);s&&s.rejectOperation(t,i,n)}resolvePendingOperation(e,t,i,n){this.logger.info(`[${n}][resolvePendingOperation]: ${ke(t)}`);const r=this.getOperationTable(e);r&&r.resolveOperation(t,i)}setPendingOperation(e,t,i,n){this.logger.info(`[${n}][setPendingOperation] ${e} ${ke(t)} value: ${i}`);const r=this.getOperationTable(e);if(!r)return!1;if(0===e){const e=i&&i.participant&&i.participant.participantId;e&&this.participantIdMriMap.set(e,t)}return r.setOperation(t,i)}setParticipantIdToMriMapping(e,t,i,n){n?(this.logger.info(`[${i}][setParticipantIdMriMap] ${Ne(e)}: ${ke(t)} clear mapping.`),this.participantIdMriMap.delete(e)):e&&t&&(this.logger.info(`[${i}][setParticipantIdMriMap] ${Ne(e)}: ${ke(t)}`),this.participantIdMriMap.set(e,t))}getOperationTable(e){switch(e){case 0:return this.localAddParticipantRequests;case 1:return this.localAdmitParticipantRequests;case 2:return this.localCallMeBackRequests;case 4:return this.localRemoveParticipantEndpointRequests;case 3:return this.localRemoveParticipantRequests;case 5:return this.localUpdateParticipantInterpretationStateRequest;default:return null}}rejectAllPendingOperations(e,t){this.logger.info("rejectLocalQueuedOperations"),this.localAddParticipantRequests.clear(e,t),this.localAdmitParticipantRequests.clear(e,t),this.localCallMeBackRequests.clear(e,t),this.localRemoveParticipantRequests.clear(e,t),this.localRemoveParticipantEndpointRequests.clear(e,t),this.localUpdateParticipantInterpretationStateRequest.clear(e,t)}};function ih(e,t,i,n){hs(e,"signalingSession cannot be null");const r=i.groupId?{id:i.groupId}:null,s=i.threadId?{threadId:i.threadId,messageId:i.messageId||null}:null;let a=[],o={};t&&t.length>0?(a=t.map((t=>({id:t.nonMaskedId?t.nonMaskedId:t.id,assertedId:t.assertedId,displayName:t.displayName,participantId:t.participantId,replacementDetails:3===i.replacementType?e.getReplacementDetailsByParticipantLegOfCall(i.callIdToReplace,t.id,t.replacementParticipantId):void 0}))),o={addParticipantSuccess:is(e,Dr.CONV_ADD_PARTICIPANT_SUCCESS),addParticipantFailure:is(e,Dr.CONV_ADD_PARTICIPANT_FAILURE)}):o={addModalitySuccess:is(e,Dr.CONV_ADD_MODALITY_SUCCESS),addModalityFailure:is(e,Dr.CONV_ADD_MODALITY_FAILURE)};const l={payload:{disableUnmute:i&&i.disableUnmute,participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},to:a},participantInvitationData:i.additionalData,replacementDetails:3===i.replacementType?void 0:n,groupContext:r,groupChat:s,links:o}};return i&&i.alternateId&&(l.payload.participants.from.alternateId=i.alternateId),i?.clientScenario&&(l.payload.debugContent={clientScenario:i.clientScenario}),l}function nh(e,t,i){return hs(e,"signalingSession cannot be null"),hs(t,"remoteParticipant cannot be null"),{payload:{participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},to:[{id:t.id,displayName:t.displayName}]},links:{admitFailure:is(e,Dr.CONV_ADMIT_PARTICIPANT_FAILURE),admitSuccess:is(e,Dr.CONV_ADMIT_PARTICIPANT_SUCCESS)},debugContent:{causeId:i}}}}function rh(e,t,i){return hs(e,"signalingSession cannot be null"),hs(t,"remoteParticipant cannot be null"),{payload:{participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},scope:i,toEndpoints:[{id:t.id,endpointId:t.endpointId}]},links:{removeParticipantSuccess:is(e,Dr.CONV_REMOVE_PARTICIPANT_SUCCESS),removeParticipantFailure:is(e,Dr.CONV_REMOVE_PARTICIPANT_FAILURE)}}}}function sh(e,t){return hs(e,"signalingSession cannot be null"),hs(t,"remoteParticipant cannot be null"),{payload:{participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},to:[{id:t.id,displayName:t.displayName}]},links:{removeParticipantSuccess:is(e,Dr.CONV_REMOVE_PARTICIPANT_SUCCESS),removeParticipantFailure:is(e,Dr.CONV_REMOVE_PARTICIPANT_FAILURE)}}}}function ah(e,t,i,n=""){hs(i&&"specified"===i,"Only non-null non-empty scope of 'specified' is supported."),hs(e,"signalingSession cannot be null"),hs(t,"participantsIds cannot be null");const r=[];return t.forEach((e=>{const t={id:e,meetingRole:n};r.push(t)})),{payload:{from:{id:e.participantManager.localParticipant.id,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},scope:i,to:r}}}var oh=T(i(496486)),lh=class{constructor(e,t){this.participantManager=e,this.logger=t,this.setStaleCheckForFullRoster=e=>{this.checkStaleRosterFromFull=e},this.handleRosterUpdate=(e,t,i,n)=>{if("Delta"===e.type||"MultiPartyEndpoint"===e.type){if(void 0===e.sequenceNumber&&(e.sequenceNumber=this.lastRosterUpdateSeqNumber),this.logger.info(`[${n}][handleRosterUpdate][sequenceNumber=${e.sequenceNumber}]`),this.rostersInLifetime.add(e.sequenceNumber),"Delta"===e.type)this.logger.info(`[${n}][handleRosterUpdate], RosterType: Delta, isFullRoster: ${i}`),this.handleDeltaRoster(e,i,t,n);else{if(this.logger.info(`[${n}][handleRosterUpdate], RosterType: MultiPartyEndpoint`),this.isRosterStale(e,n))return this.participantManager.signalingSession.telemetryHelper.recordEvent(al,{lastRosterUpdateSeqNumber:this.lastRosterUpdateSeqNumber,sequenceNumber:e.sequenceNumber,causeId:n}),void this.logger.info(`[${n}][handleRosterUpdate] Ignoring old roster update: received ${e.sequenceNumber}, but already handled ${this.lastRosterUpdateSeqNumber}`);for(const i of Object.keys(e.participants)){const r=Us.fromRoster(e.participants[i]);this.handleRosterParticipant(r,t,n)}this.checkForRemovedParticipants(t,e.participants,n),this.participantManager.signalingSessionCallback.onParticipantCountsUpdated(e.participantCounts,n)}if(e.sequenceNumber>this.lastRosterUpdateSeqNumber){this.checkStaleRosterFromFull&&this.participantManager.signalingSessionCallback.onParticipantCountsUpdated(e.participantCounts,n),this.lastRosterUpdateSeqNumber=e.sequenceNumber,this.firstRosterUpdateSeqNumber<0&&(this.firstRosterUpdateSeqNumber=this.lastRosterUpdateSeqNumber);const t=Object.keys(e.participants||0).length;this.participantCountInFirstRoster<0&&(this.participantCountInFirstRoster=t),this.maxConcurrentParticipantsDuringLeg=Math.max(this.maxConcurrentParticipantsDuringLeg,t)}this.recordTelemetry(e,i,n),this.participantManager.signalingSessionCallback.onRosterHandlingComplete()}else this.logger.warn(`[${n}][handleRosterUpdate][sequenceNumber=${e.sequenceNumber}] invalid roster type ${e.type}`)},this.isRosterStaleFromFull=(e,t)=>!!this.checkStaleRosterFromFull&&(this.logger.info(`[${t}][isRosterStale] ${e.sequenceNumber<this.lastFullRosterSeqNumber}`),e.sequenceNumber<this.lastFullRosterSeqNumber),this.isRosterStale=(e,t)=>(this.logger.info(`[${t}][isRosterStale] ${e.sequenceNumber<this.lastRosterUpdateSeqNumber}`),e.sequenceNumber<this.lastRosterUpdateSeqNumber),this.updateLocalParticipantFromSubscribe=(e,t)=>{this.logger.info(`[${t}][updateLocalParticipantFromSubscribe]`),this.updateLocalParticipant(e,t)},this.handleParticipantAcceptedBy=(e,t,i)=>{const n=t.hasOwnProperty(e.id),r=e.id===e.acceptedBy.id;this.logger.info(`[${i}][RosterManager::handleParticipantAcceptedBy] oldParticipantInRoster: ${n}`),this.participantManager.participantOperationHandler.setParticipantIdToMriMapping(e.participantId,e.id,i,!0),n&&!r&&this.handleRemovedDeltaRosterParticipant(new Us({id:e.id}),this.lastRosterUpdateSeqNumber,t,i)},this.lastRosterUpdateSeqNumber=-1,this.lastFullRosterSeqNumber=-1,this.firstRosterUpdateSeqNumber=-1,this.tombstoneSequence=new Map,this.latestRosterVersionForActiveParticipants=new Map,this.rostersInLifetime=new Set,this.maxConcurrentParticipantsDuringLeg=-1,this.participantCountInFirstRoster=-1,this.checkStaleRosterFromFull=!1}recordTelemetry(e,t,i){const n={participantCountInLastRoster:Object.keys(e.participants||0).length,participantCountInFirstRoster:this.participantCountInFirstRoster,sequenceNumberOfLastRoster:this.lastRosterUpdateSeqNumber,sequenceNumberOfLastFullRoster:this.lastFullRosterSeqNumber,sequenceNumberOfFirstRoster:this.firstRosterUpdateSeqNumber,rosterType:e.type,isFullRoster:t,maxConcurrentParticipantsDuringLeg:this.maxConcurrentParticipantsDuringLeg,totalParticipantsDuringLifetimeOfLeg:this.tombstoneSequence.size+this.latestRosterVersionForActiveParticipants.size,countOfMissingNotifications:this.getMissingNotificiations()};this.logger.info(`[recordTelemetry] data ${JSON.stringify(n,null,4)}`),this.participantManager.signalingSession.telemetryHelper.recordRosterEvent(n,Ea,i)}getMissingNotificiations(){const e=this.lastRosterUpdateSeqNumber-this.firstRosterUpdateSeqNumber+1-this.rostersInLifetime.size;return e>0?e:0}isParticipantRosterStale(e,t){if(this.logger.info(`[isParticipantRosterStale], rosterParticipantVersion ${t}`),t){if(this.tombstoneSequence.has(e))return t<=this.tombstoneSequence.get(e);if(this.latestRosterVersionForActiveParticipants.has(e))return t<=this.latestRosterVersionForActiveParticipants.get(e)}return!1}handleDeltaRoster(e,t,i,n){if(this.logger.info(`[${n}][handleDeltaRoster] isFullRoster ${t}`),this.isRosterStaleFromFull(e,n))return this.participantManager.signalingSession.telemetryHelper.recordEvent(al,{lastRosterUpdateSeqNumber:this.lastRosterUpdateSeqNumber,lastFullRosterSeqNumber:this.lastFullRosterSeqNumber,sequenceNumber:e.sequenceNumber,causeId:n}),void this.logger.info(`[${n}][handleRosterUpdate] Ignoring old roster update: received ${e.sequenceNumber}, but already handled full roster ${this.lastFullRosterSeqNumber}`);if(t){if(!this.checkStaleRosterFromFull&&this.isRosterStale(e,n))return this.participantManager.signalingSession.telemetryHelper.recordEvent(al,{lastRosterUpdateSeqNumber:this.lastRosterUpdateSeqNumber,sequenceNumber:e.sequenceNumber,causeId:n}),void this.logger.info(`[${n}][handleRosterUpdate] Ignoring old roster update: received ${e.sequenceNumber}, but already handled ${this.lastRosterUpdateSeqNumber}`);for(const t of Object.keys(i))if(!(e.participants.hasOwnProperty(t)||this.checkStaleRosterFromFull&&this.isParticipantRosterStale(t,e.sequenceNumber))){const r=new Us({id:t});this.logger.info(`[${n}][handleRosterUpdate] participant missing from delta, full roster`),this.handleRemovedDeltaRosterParticipant(r,e.sequenceNumber,i,n)}this.lastFullRosterSeqNumber=e.sequenceNumber}else if(!e?.participants)return void this.logger.warn(`[${n}][handleRosterUpdate] participants blob empty in delta roster`);for(const t of Object.keys(e.participants)){const r=e.participants[t];if(!this.isParticipantRosterStale(t,r.version)){let e=Us.fromRoster(r);r.state&&"active"===r.state?(this.logger.info(`[${n}][handleDeltaRoster] participant active`),this.handleRosterParticipant(e,i,n),this.tombstoneSequence.has(t)&&this.tombstoneSequence.delete(t),this.latestRosterVersionForActiveParticipants.set(t,r.version)):r.state&&"inactive"===r.state?(e=e||new Us({id:r.details.id}),this.logger.info(`[${n}][handleDeltaRoster] participant inactive`),this.handleRemovedDeltaRosterParticipant(e,r.version,i,n)):this.logger.info(`[${n}][handleDeltaRoster] unexpected participant state ${r.state}`)}}this.handleRemoveParticipantRequests(this.getActiveParticipants(e.participants),n),this.checkStaleRosterFromFull||this.participantManager.signalingSessionCallback.onParticipantCountsUpdated(e.participantCounts,n)}getRnlMri(e,t){const i=this.participantManager.participantOperationHandler;if(e){const n=this.getRnlParticipantIdsFromRoster(e,t);return i.getRnlMri(n,t)}return""}handleRemovedDeltaRosterParticipant(e,t,i,n){const r=e.id,s=this.getRnlMri(e,n);let a="";i.hasOwnProperty(r)?a=r:i.hasOwnProperty(s)&&(a=s),a&&this.handleRemovedParticipant(i,a,n),this.tombstoneSequence.set(r,t),this.latestRosterVersionForActiveParticipants.has(r)&&this.latestRosterVersionForActiveParticipants.delete(r)}handleRemovedParticipant(e,t,i){const n=this.participantManager.signalingSessionCallback,r=this.participantManager.signalingSession;!1!==e[t]&&(vs(this.participantManager.connectedRemoteParticipantIds,t),this.logger.info(`[${i}][handleRemovedParticipant] ${ke(t)} removed from roster`),n.onParticipantRemoved({id:t},i),r.clearParticipantCallLinks(t))}getActiveParticipants(e){const t={};for(const i of Object.keys(e))"inactive"!==e[i].state&&(t[i]=e[i]);return t}handleRosterParticipant(e,t,i){if(!e)return void this.logger.info(`[handleRosterParticipant][${i}] rosterParticipant processing skipped because null.`);if(e.id===this.participantManager.localParticipant.id){this.updateLocalParticipant(e,i);const t=this.getLocalEndpoint(),n=!(!t?.stream&&!t?.streamLobby),r=0===this.participantManager.signalingSession.callMode;return this.logger.info(`[handleRosterParticipant][${i}] isStreaming:${n} isInitialMode:${r}`),void(n&&r?this.participantManager.signalingSession.configureStreamingMode(i):n||this.participantManager.signalingSession.setRealTimeState(1,i))}const n=this.participantManager.participantOperationHandler,r=this.participantManager.signalingSession,s=this.participantManager.signalingSessionCallback,a=e.id,o=this.getRnlMri(e,i),l=this.getRnlParticipantIdsFromRoster(e,i);r.remoteCaller&&-1!==l.indexOf(r.remoteCaller.participantId)&&(e.displayName=r.remoteCaller.displayName),Ss(this.participantManager.connectedRemoteParticipantIds,e.id,!0);const d=t.hasOwnProperty(e.id),c=t.hasOwnProperty(o);(d||c)&&(t[e.id]=!1),n.hasPendingOperation(0,e.id,i)&&this.isParticipantInCall(e)?(this.logger.info(`participant ${ke(e.id)} appears in roster. Resolving AddParticipant request`),r.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,e.id),n.resolvePendingOperation(0,e.id,e,i)):o&&n.hasPendingOperation(0,o,i)&&this.isParticipantInCall(e)?(this.logger.info(`RNL participant ${ke(o)} appears in roster. Resolving AddParticipant request`),r.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,o),n.resolvePendingOperation(0,o,e,i)):n.hasPendingOperation(1,e.id,i)&&this.isParticipantInCall(e)&&(this.logger.info(`participant: ${ke(e.id)} appears in roster. Resolving AdmitParticipant request`),r.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.ADMIT_PARTICIPANT,e.id),n.resolvePendingOperation(1,e.id,e,i));for(const t of e.endpointDetails)n.hasPendingOperation(0,t.participantId,i)&&this.isParticipantInCall(e)&&(this.logger.info(`participant ${ke(e.id)} appears in roster. Resolving AddParticipant request`),r.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,t.participantId),n.resolvePendingOperation(0,t.participantId,e,i));d?(this.logger.info(`participantIds=[${l}] updated ${ke(e.id)}`),s.onParticipantUpdated(e,i),r.setParticipantCallLinks(e)):c?(this.logger.info(`RNL participant participantIds=[${l}] removed old ${ke(o)} and added new ${ke(a)}`),s.onParticipantRemoved({id:o},i,!0),r.clearParticipantCallLinks(o),s.onParticipantJoined(e,i),r.setParticipantCallLinks(e)):n.hasPendingOperation(3,e.id,i)?this.logger.info(`participantIds=[${l}] ignored ${ke(e.id)}`):(this.logger.info(`participantIds=[${l}] joined ${ke(e.id)}`),s.onParticipantJoined(e,i),r.setParticipantCallLinks(e))}getLocalEndpoint(){return oh.find(this.participantManager.localParticipant.endpointDetails,(e=>this.participantManager.localParticipant.endpointId===e.endpointId))}getRnlParticipantIdsFromRoster(e,t){const i=[];for(const t of e.endpointDetails)i.push(t.participantId);return this.logger.info(`[${t}][getRnlParticipantIdsFromRoster] ${JSON.stringify(i)}`),i}isParticipantInCall(e){return e.endpointDetails?.[0]&&!e.endpointDetails[0].isLobby}updateLocalParticipant(e,t){const i=this.participantManager.localParticipant,n=this.participantManager.signalingSession,r=this.participantManager.signalingSessionCallback;n.setParticipantCallLinks(e),this.logger.info(`[${t}][updateLocalParticipant]`);let s=!1;if(e?.endpointDetails){const a=oh.find(e.endpointDetails,(e=>i.endpointId===e.endpointId)),o=oh.find(i.endpointDetails,(e=>i.endpointId===e.endpointId));s=bc(a),a?.isLobby&&!o?.isLobby?n.telemetryHelper.recordEvent(Zo,{causeId:t}):!a||a.isLobby||o&&!o.isLobby||(s?n.telemetryHelper.recordEvent(el,{causeId:t}):n.telemetryHelper.recordEvent(Xo,{causeId:t})),a?.broadcastMeetingRole&&i&&i.broadcastMeetingRole!==a.broadcastMeetingRole&&(i.broadcastMeetingRole=a.broadcastMeetingRole,n.telemetryHelper.setBroadcastMeetingRole(a.broadcastMeetingRole)),r.onMeetingGroupDetailsUpdated(a?.meetingGroupDetails,t)}if(e?.meetingRole&&n.telemetryHelper.setMeetingRole(e.meetingRole),e?.advancedMeetingRole&&n.telemetryHelper.setAdvancedMeetingRole(e.advancedMeetingRole),e?.participantType&&n.telemetryHelper.setParticipantType(e.participantType),e&&(i.endpointDetails=e.endpointDetails||[],i.acceptedBy=e.acceptedBy,i.role=e.role,i.meetingRole=e.meetingRole,i.advancedMeetingRole=e.advancedMeetingRole,i.participantType=e.participantType,i.tenantId=e.tenantId,i.isLobby=e.isLobby,i.publishedStates=e.publishedStates,i.isStaging=s,i.version=e.version,i.propertyBag=e.propertyBag,i.isIdentityMasked=e.isIdentityMasked,i.maskedIdSeqNumber=e.maskedIdSeqNumber,i.maskedId=e.maskedId,void 0!==e?.joinAsStreamingUser&&(i.joinAsStreamingUser=e.joinAsStreamingUser),void 0!==e?.enableCaptcha&&(i.enableCaptcha=e.enableCaptcha),this.participantManager.localParticipant.fromRoster=!0,r.onSelfParticipantUpdated(i,t)),this.isParticipantInCall(e)){const i=this.participantManager.participantOperationHandler,r=this.getRnlMri(e,t);r&&i.hasPendingOperation(0,r,t)&&(this.logger.info(`RNL participant ${ke(r)} appears in roster. Resolving AddParticipant request`),n.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,r),i.resolvePendingOperation(0,r,e,t))}}checkForRemovedParticipants(e,t,i){const n=this.participantManager.signalingSessionCallback,r=this.participantManager.signalingSession,s=this.participantManager.participantOperationHandler;this.logger.info(`[${i}][checkForRemovedParticipants]`);for(const t of Object.keys(e))e.hasOwnProperty(t)&&!1!==e[t]&&!s.hasPendingOperation(0,t,i)&&(vs(this.participantManager.connectedRemoteParticipantIds,t),this.logger.info(`[${i}][checkForRemovedParticipants] ${ke(t)} removed from roster`),n.onParticipantRemoved({id:t},i),r.clearParticipantCallLinks(t));this.handleRemoveParticipantRequests(t,i)}handleRemoveParticipantRequests(e,t){const i=this.participantManager.signalingSession,n=this.participantManager.participantOperationHandler;this.logger.info(`handleRemoveParticipantRequests [${t}] dynamicRosterParticipants`);const r=[];Object.keys(e).forEach((t=>{const i=Us.fromRoster(e[t]);i&&i.endpointDetails&&i.endpointDetails.forEach((e=>{e.originalId&&r.push(e.originalId)}))}));const s=n.getAllPendingOperations(3,t);for(const a of Object.keys(s))-1!==r.indexOf(a)||e.hasOwnProperty(a)||(this.logger.info(`[${t}][handleRemoveParticipantRequests] ${ke(a)} no longer appears in roster. Resolving RemoveParticipant request`),vs(this.participantManager.connectedRemoteParticipantIds,a),i.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.REMOVE_PARTICIPANT,a),n.resolvePendingOperation(3,a,{id:a},t))}},dh=class{constructor(e,t,i,n){this.connectedRemoteParticipantIds={},this.disposed=!1,this.unmuteApprovalLinks={},this._asyncMuteUnmuteDefers=new Map,this.muteAsyncEnabled=!1,this.unmuteAsyncEnabled=!1,this.setLocalParticipantId=(e,t)=>{e&&(this.logger.info(`[${t}][setLocalParticipantId][participantId=${e}]`),this.localParticipant.participantId=e,this.signalingSession.telemetryHelper.setParticipantId(this.localParticipant.participantId))},this.setStaleCheckForFullRoster=e=>{this.rosterManager.setStaleCheckForFullRoster(e)},this.setEnableMuteAsync=e=>{this.muteAsyncEnabled=e},this.setEnableUnmuteAsync=e=>{this.unmuteAsyncEnabled=e},this.admitParticipantAsync=(e,t,i)=>{const n=`[${i}][admitParticipantAsync]`;this.logger.info(`${n}${this.piiUtils.scrubMriOrOmit(e.id)}`);const r=As();return this.participantOperationHandler.hasPendingOperation(1,e.id,i)?(this.logger.info(`${n}there is an existing pending request to admit the participant ${this.piiUtils.scrubMriOrOmit(e.id)}`),r.reject(new Error("there is an existing pending request to admit the participant"))):(this.participantOperationHandler.setPendingOperation(1,e.id,{participant:e,promise:r,causeId:i},i),this.sendNetworkRequestForAdmittingParticipant(e,t,i)),r.promise},this.addParticipantsAsync=(e,t,i,n,r)=>{const s=`[${r}][addParticipantsAsync]`,a=e.map((e=>this.piiUtils.scrubMriOrOmit(e.id)));this.logger.info(`${s} remoteParticipantsIds: ${a}`);const o=[],l=[];return e.forEach((e=>{const t=As(),i=3===n.replacementType?e.participantId:e.id;this.connectedRemoteParticipantIds.hasOwnProperty(e.id)?(this.logger.info(`${s}the given participant is already connected to the call ${this.piiUtils.scrubMriOrOmit(e.id)}`),t.reject(new Error("the given participant is already connected to the call"))):this.participantOperationHandler.hasPendingOperation(0,i,r)?(this.logger.info(`${s}there is an existing pending request to add the participant ${this.piiUtils.scrubMriOrOmit(e.id)}`),t.reject(new Error("there is an existing pending request to add the participant"))):(e.participantId||(e.participantId=ls(),this.logger.info(`participantId created ${e.participantId}`)),this.participantOperationHandler.setPendingOperation(0,i,{participant:e,promise:t,causeId:r},r),o.push(e)),l.push(t.promise)})),i&&this.sendNetworkRequestForAddingParticipant(o,t,n,r),l},this.nudgeParticipantsAsync=(e,t,i,n,r,s,a,o)=>(this.logger.info(`[${n}][nudgeParticipantAsync] ${this.piiUtils.scrubParticipantsList(e)}`),i?this.sendNetworkRequestForNudgingParticipants(e,t,n,r,s,a,o):Promise.reject(`[${n}][nudgeParticipantAsync] Call not started`)),this.updateMeetingRolesAsync=(e,t,i,n=os())=>{const r=As();if(!e||e.length<1){const e=`[${n}][updateMeetingRolesAsync] participantsInfo cannot be empty or null`,t=new Error(e);t.endCode={code:Zr.CALL_END_CODE.REJECT,subCode:Zr.CALL_END_SUB_CODE.UPDATE_MEETING_ROLE_REJECTED,phrase:e},this.logger.info(e),r.reject(t)}else if(t)if(i){let s;"attendee"===t?s=cc.UPDATE_MEETING_ROLE_ATTENDEE.name:"presenter"===t?s=cc.UPDATE_MEETING_ROLE_PRESENTER.name:"organizer"===t?s=cc.UPDATE_MEETING_ROLE_ORGANIZER.name:r.reject(new Error(`[${n}] Invalid meetingRole value(${t})`)),this.logger.info(`[${n}][updateMeetingRolesAsync][meetingRole=${t}]`),this.signalingSession.ensureMessageChannelReady(s).then((()=>{this.sendNetworkRequestForUpdatingMeetingRoles(e,t,i,s,n,r)})).catch((e=>{const t=Ve(e);this.logger.info(`[${n}][updateMeetingRolesAsync][failed][reason=${t}]`);const i={...Cs(e,this.signalingSession.signalingAgentConfig).error};r.reject(i)}))}else{const e=`[${n}][updateMeetingRolesAsync] updateMeetingRoleUrl cannot be empty or null`,t=new Error(e);t.endCode={code:Zr.CALL_END_CODE.REJECT,subCode:Zr.CALL_END_SUB_CODE.UPDATE_MEETING_ROLE_REJECTED,phrase:e},this.logger.info(e),r.reject(t)}else{const e=`[${n}][updateMeetingRolesAsync] meetingRole cannot be empty or null`,t=new Error(e);t.endCode={code:Zr.CALL_END_CODE.REJECT,subCode:Zr.CALL_END_SUB_CODE.UPDATE_MEETING_ROLE_REJECTED,phrase:e},this.logger.info(e),r.reject(t)}return r.promise},this.updateParticipantInterpretationStateAsync=(e,t,i)=>{const n=`[${i}][updateParticipantInterpretationStateAsync]`,r=e.map((e=>this.piiUtils.scrubMriOrOmit(e.id)));this.logger.info(`${n} remoteParticipantsIds: ${r}`);const s=[],a=[];return e.forEach((e=>{const t=As();this.participantOperationHandler.hasPendingOperation(5,e.id,i)?(this.logger.info(`${n}there is an existing pending request to update the participant ${this.piiUtils.scrubMriOrOmit(e.id)}`),t.reject(new Error("there is an existing pending request to update the participant"))):(this.participantOperationHandler.setPendingOperation(5,e.id,{option:e,promise:t,causeId:i},i),s.push(e)),a.push(t.promise)})),this.sendNetworkRequestToUpdateParticipantInterpretationState(s,t,e,i),a},this.callMeBackAsync=(e,t,i)=>{this.logger.info(`[${i}][callMeBackAsync] ${this.piiUtils.scrubMriOrOmit(e.id)}`);const n=As();return this.connectedRemoteParticipantIds.hasOwnProperty(e.id)?(this.logger.info(`the given participant is already connected to the call : ${this.piiUtils.scrubMriOrOmit(e.id)}`),n.reject(new Error("the given participant is already connected to the call"))):this.participantOperationHandler.hasPendingOperation(2,e.id,i)?(this.logger.info(`there is an existing pending request to call back the participant : ${this.piiUtils.scrubMriOrOmit(e.id)}`),n.reject(new Error("there is an existing pending request to call back the participant"))):(this.participantOperationHandler.setPendingOperation(2,e.id,{participant:e,promise:n},i),this.sendNetworkRequestForCallMeBack(e,t,i)),n.promise},this.isRosterStale=(e,t)=>this.rosterManager.isRosterStale(e,t),this.removeParticipantAsync=(e,t,i)=>{this.logger.info(`[${i}][removeParticipantAsync] ${this.piiUtils.scrubMriOrOmit(e.id)}`),cs(t,"correct removeParticipantUrl is not provided");const n=As();if(this.participantOperationHandler.hasPendingOperation(3,e.id,i))this.logger.info(`there is an existing pending request to remove the participant ${this.piiUtils.scrubMriOrOmit(e.id)}`),n.reject(new Error("there is an existing pending request to remove the participant"));else{this.participantOperationHandler.setPendingOperation(3,e.id,{participant:e,promise:n},i);const r=()=>{this.signalingSession.timeoutManager.startTimer(Zr.TIMEOUT_OPERATIONS.REMOVE_PARTICIPANT,(()=>{this.signalingSession.telemetryHelper.recordEvent(ga),this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.REMOVE_PARTICIPANT,e.id),this.participantOperationHandler.rejectPendingOperation(3,e.id,"timed out waiting for participant to not show up in roster",{code:Zr.CALL_END_CODE.TIMEOUT,subCode:Zr.CALL_END_SUB_CODE.CALL_PARTICIPANT_REMOVAL_TIMEOUT,phrase:Zr.CALL_END_PHRASE.PARTICIPANT_REMOVAL_TIMEOUT},i)}),Zr.TIMEOUT_VALUES_IN_SECONDS.REMOVE_PARTICIPANT_TIMEOUT,e.id)};this.signalingSession.http.sendPostRequest({url:t,payload:sh(this.signalingSession,e),requestName:cc.REMOVE_PARTICIPANT_NONE.name,onceTrouterReady:r,causeId:i}).catch((t=>{const n=Cs(t,this.signalingSession.signalingAgentConfig);this.logger.info(`[${i}][removeParticipantAsync][failed][reason=${Ve(n)}]`),this.disposed||(this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.REMOVE_PARTICIPANT,e.id),this.participantOperationHandler.rejectPendingOperation(3,e.id,t,n.error,i))}))}return n.promise},this.removeParticipantEndpointAsync=(e,t,i,n)=>{this.logger.info(`[${n}][removeParticipantEndpointAsync] ${Be(e.endpointId)} [endPointScope] ${i}`),cs(t,"correct removeParticipantUrl is not provided");const r=As();let s="";switch(i){case"all":s=cc.REMOVE_PARTICIPANT_OTHERS.name;break;case"specified":s=cc.REMOVE_PARTICIPANT_SPECIFIED.name;break;default:return Promise.reject(`invalid scope ${i} removeParticipantEndpointAsync`)}return this.participantOperationHandler.setPendingOperation(4,e.endpointId,{participant:e,promise:r,scope:i},n),this.signalingSession.http.sendPostRequest({url:t,payload:rh(this.signalingSession,e,i),requestName:s,onceTrouterReady:()=>{this.signalingSession.timeoutManager.startTimer(Zr.TIMEOUT_OPERATIONS.REMOVE_PARTICIPANT,(()=>{this.signalingSession&&!this.signalingSession.disposed&&(this.signalingSession.telemetryHelper.recordEvent(ga),this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.REMOVE_PARTICIPANT,e.endpointId),this.participantOperationHandler.rejectPendingOperation(4,e.endpointId,"timed out waiting for participant endpoint sync response from service",{code:Zr.CALL_END_CODE.TIMEOUT,subCode:Zr.CALL_END_SUB_CODE.CALL_PARTICIPANT_REMOVAL_TIMEOUT,phrase:Zr.CALL_END_PHRASE.PARTICIPANT_REMOVAL_TIMEOUT},n))}),Zr.TIMEOUT_VALUES_IN_SECONDS.REMOVE_PARTICIPANT_TIMEOUT,e.endpointId)},causeId:n}).then((e=>{if(e.response?.code)if(-1!==[Zr.HTTP_STATUS_CODES.OK,Zr.HTTP_STATUS_CODES.CREATED].indexOf(e.response.code))this.logger.info(`[${n}][removeParticipantEndpointAsync][endPointScope] ${i} [passed][reason=${Ve(e.response)}]`),r.resolve(e.response);else{const t=new Error("invalid service response for removeParticipantEndpoint");t.endCode={code:e.response.code,subCode:e.response.subcode,phrase:e.response.reason},this.logger.info(`[${n}][removeParticipantEndpointAsync][endPointScope] ${i} [failed][reason=${Ve(e.response)}]`),r.reject(t)}r.resolve()})).catch((t=>{const r=Cs(t,this.signalingSession.signalingAgentConfig);this.logger.info(`[${n}][removeParticipantEndpointAsync][endPointScope] ${i} [failed][reason=${Ve(r)}]`),this.disposed||(this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.REMOVE_PARTICIPANT,e.endpointId),this.participantOperationHandler.rejectPendingOperation(4,e.endpointId,Ve(t),r.error,n))})),r.promise},this.getParticipantsToInitiateCallWith=()=>{this.logger.info("getParticipantsToInitiateCallWith");const e=[],t=this.participantOperationHandler.getAllPendingOperations(0,os());for(const i of Object.keys(t))t.hasOwnProperty(i)&&t[i]&&e.push(t[i].participant);return e},this.initializeForIncomingCall=e=>{this.logger.info("initializeForIncomingCall"),this.participantOperationHandler.dispose("incoming calls cannot add/remove participants until call is connected",null,os())},this.handleAddParticipantSuccess=e=>{const t=e.body,i=_s(e);this.logger.info(`[${i}][handleAddParticipantSuccess(${t.participantInfos?"new format":"old format"})]${Ve(t)}]`),this.signalingSession.telemetryHelper.recordIncomingEvent(ma,e),this.internalHandleCallMeBackSuccess(t,i)||this.signalingSession.telemetryHelper.recordEvent(ma),this.signalingSession.signalingAgentConfig.enableAddParticipantEnhancements&&this.internalHandleAcceptedByParticipants(t,i)},this.handleAddParticipantFailure=e=>{const t=e.body,i=_s(e);this.logger.info(`[${i}][handleAddParticipantFailure(${t.participantInfos?"new format":"old format"})][${Ve(t)}]`),t.modalityFailure?(this.logger.info(`[${i}][handleAddParticipantFailure][modalityFailure=${Ve(t)}]`),this.signalingSession.telemetryHelper.recordIncomingEvent(ya,e)):this.internalHandleAddParticipantFailure(e,i)},this.handleAdmitParticipantSuccess=e=>{const t=e.body,i=_s(e);this.logger.info(`[${i}][handleAdmitParticipantSuccess][${Ve(t)}]`),this.signalingSession.telemetryHelper.recordIncomingEvent(Sa,e),t.participants&&this.internalHandleAdmitParticipantSuccess(e,i)},this.handleAdmitParticipantFailure=e=>{const t=e.body,i=_s(e);this.logger.info(`[${i}][handleAdmitParticipantFailure][${Ve(t)}]`),t.participants&&this.internalHandleAdmitParticipantFailure(e,i)},this.handleRemoveParticipantFailure=e=>{const t=e.body,i=_s(e);this.logger.info(`[${i}][handleRemoveParticipantFailure][${Ve(t)}]`),this.signalingSession.telemetryHelper.recordIncomingEvent(Ta,e);for(const e of Object.keys(t.participants))t.participants.hasOwnProperty(e)&&this.internalHandleRemoveParticipantFailure(e,t.participants[e],i)},this.handleRemoveParticipantSuccess=e=>{const t=e.body,i=_s(e);this.logger.info(`[${i}][handleRemoveParticipantSuccess][${Ve(t)}]`),this.signalingSession.telemetryHelper.recordIncomingEvent(Ca,e)},this.handleUnmuteConfirmRequest=e=>{const t=e.body,i=_s(e);this.logger.info(`[${i}][handleUnmuteConfirmRequest][${Ve(t)}]`),this.signalingSession.telemetryHelper.recordIncomingEvent(bo,e),this.unmuteApprovalLinks[t.from.id]={approve:t.links.approveUnmute,reject:t.links.rejectUnmute},this.signalingSessionCallback.onUnmuteRequested(t.from.id,i)},this.approveUnmuteRequestAsync=(e,t)=>{this.logger.info(`[${t}][approveUnmuteRequestAsync]`);const i=As();return this.unmuteApprovalLinks.hasOwnProperty(e)?(this.signalingSession.ensureMessageChannelReady(cc.APPROVE_UNMUTE.name).then((()=>{this.muteUnmute(cc.APPROVE_UNMUTE.name,function(e){return hs(e,"signalingSession cannot be null"),{payload:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},mediaTypes:["audio"]}}}(this.signalingSession),i,this.unmuteApprovalLinks[e].approve,t)})).catch((e=>{const n=Ve(e);this.logger.info(`[${t}][approveUnmuteRequestAsync][failed][reason=${n}]`),i.reject(new Error(e))})),i.promise):(i.reject(new Error("no unmute links found for given participant")),i.promise)},this.rejectUnmuteRequestAsync=(e,t,i)=>{this.logger.info(`[${t}][rejectUnmuteRequestAsync]`);const n=As();if(!this.unmuteApprovalLinks.hasOwnProperty(e))return n.reject(new Error("no unmute links found for given participant")),n.promise;const r=i||{code:Zr.CALL_END_CODE.REJECT,subCode:Zr.CALL_END_SUB_CODE.UNMUTE_REQUEST_REJECTED,phrase:Zr.CALL_END_PHRASE.UNMUTE_REQUEST_REJECTED};return this.signalingSession.ensureMessageChannelReady(cc.REJECT_UNMUTE.name).then((()=>{this.muteUnmute(cc.REJECT_UNMUTE.name,function(e,t){return hs(e,"signalingSession cannot be null"),us(t),{payload:{transactionEnd:t}}}(this.signalingSession,r),n,this.unmuteApprovalLinks[e].reject,t)})).catch((e=>{const i=Ve(e);this.logger.info(`[${t}][rejectUnmuteRequestAsync][failed][reason=${i}]`),n.reject(new Error(e))})),n.promise},this.handleRosterUpdate=(e,t,i)=>{const n=this.getCurrentParticipantsInCallModality(!1);this.rosterManager.handleRosterUpdate(e,n,t,i)},this.updateLocalParticipantFromSubscribe=(e,t)=>{this.localParticipant.fromRoster||this.rosterManager.updateLocalParticipantFromSubscribe(e,t)},this.muteAsync=(e,t,i,n)=>{this.logger.info(`[${n}][muteAsync][muteScope=${t}]`);let r="specified";const s=[];let a=cc.MUTE_SPECIFIED;switch(t){case Zr.MUTE_SCOPE.MYSELF:a=cc.MUTE_MYSELF,s.push({id:this.localParticipant.id});break;case Zr.MUTE_SCOPE.EVERYONE_ELSE:a=cc.MUTE_ALL_SYNC,r="all",i.forEach((e=>{s.push({id:e})}));break;case Zr.MUTE_SCOPE.SPECIFIED_PARTICIPANTS:cs(i,`[${n}]array of participantIds must be specified for SPECIFIED_PARTICIPANTS mute scope`),a=cc.MUTE_SPECIFIED_SYNC,i.forEach((e=>{s.push({id:e})}));break;default:ds(!1,`[${n}]muteScope is a required param. please pass in a valid value.`)}const o=As();if(t===Zr.MUTE_SCOPE.SPECIFIED_PARTICIPANTS){const e=this.areParticipantsConnectedToCall(i);if(!e.result)return o.reject(new Error(`[${n}]specified participant is not connected to call yet. Id = ${e.participant}`)),o.promise}const l=this.muteAsyncEnabled&&(t===Zr.MUTE_SCOPE.SPECIFIED_PARTICIPANTS||t===Zr.MUTE_SCOPE.EVERYONE_ELSE);return this.signalingSession.ensureMessageChannelReady(a.name).then((()=>{this.muteUnmute(a.name,function(e,t,i,n=!1,r=null){hs(e,"signalingSession cannot be null"),hs(t,"muteScope be null"),hs(i,"participantList cannot be null");const s={from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},scope:t,muteParticipants:i,mediaTypes:["audio"]};return n&&(s.links={clientCallback:is(e,Dr.MUTE_UNMUTE_ASYNC,r)},s.operationId=r),{payload:s}}(this.signalingSession,r,s,l,n),o,e,n,!1,l)})).catch((e=>{const t=Ve(e),i=Cs(e,this.signalingSession.signalingAgentConfig);this.logger.info(`[${n}][muteAsync][failed][reason=${t}]`),o.reject(i)})),o.promise},this.unmuteAsync=(e,t)=>{this.logger.info(`[${t}][unmuteAsync]`);const i=As();return this.signalingSession.ensureMessageChannelReady(cc.UNMUTE_SYNC.name).then((()=>{this.muteUnmute(cc.UNMUTE_SYNC.name,function(e,t=!1,i=null){hs(e,"signalingSession cannot be null");const n={from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},mediaTypes:["audio"]};return t&&(n.links={clientCallback:is(e,Dr.MUTE_UNMUTE_ASYNC,i)},n.operationId=i),{payload:n}}(this.signalingSession,this.unmuteAsyncEnabled,t),i,e,t,!0,this.unmuteAsyncEnabled)})).catch((e=>{const n=Ve(e);this.logger.info(`[${t}][unmuteAsync][failed][reason=${n}]`),i.reject(new Error(e))})),i.promise},this.dispose=(e,t)=>{this.logger.info(`[${t}][dispose]`),this.disposed=!0,this.participantOperationHandler.dispose("call ended",e,t),this.signalingSession.telemetryHelper.setParticipantId(this.localParticipant.participantId)},this.handleMuteUnmuteAsyncResponse=e=>{const t=_s(e),i=this.logger.createFnLogger("handleMuteUnmuteAsyncResponse",t);if(!e.body)return void i.error("ignored. Empty message body.");const n={info:e.body.muteUnmuteResponseAsync,operationId:e.body.operationId};if(i.info(`Received async response for mute/unmute operation, operation id = ${n.operationId}.`),this.disposed)return void i.info("ignored. Call disposed.");if(!n.operationId)return void i.error("operationId is undefined.");const r=this._asyncMuteUnmuteDefers.get(n.operationId);r?(r.resolve(n),this._asyncMuteUnmuteDefers.delete(n.operationId)):i.warn(`cannot find deferred promise for operation id [${n.operationId}].`)},this.internalHandleAcceptedByParticipants=(e,t)=>{if(e?.participantInfos){const i=e.participantInfos,n=this.getCurrentParticipantsInCallModality(!1);this.logger.info(`[${t}][internalHandleAcceptedByParticipants] handling participants with acceptedBy blob.`);for(const e of i)if(e?.acceptedBy){const i=e.id;this.participantOperationHandler.hasPendingOperation(0,i,t)&&(this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,i),this.logger.info(`[${t}][internalHandleAcceptedByParticipants] ${this.piiUtils.scrubMriOrOmit(i)} added using a different MRI. Resolving operation.`),this.participantOperationHandler.resolvePendingOperation(0,i,void 0,t)),this.rosterManager.handleParticipantAcceptedBy(e,n,t)}}},this.internalHandleCallMeBackSuccess=(e,t)=>{let i=!1;if(e?.participantInfos){const n=e.participantInfos;for(const e of n){const n=e.id;this.internalHandleCallMeBackSuccessHelper(n,t)&&(i=!0)}}else if(e?.participants)for(const n of e.participants)this.internalHandleCallMeBackSuccessHelper(n,t)&&(i=!0);return i},this.signalingSession=e,this.signalingSessionCallback=t,this.localParticipant=i,this.localParticipant.endpointId||(this.localParticipant.endpointId=this.signalingSession.getEndpointId());const r=Be(this.localParticipant.endpointId);this.logger=n.createChild((()=>`[PM][${r}]`)),this.piiUtils=e.piiUtils,this.participantOperationHandler=new th(e.logger.createChild((()=>`[ParticipantOperationHandler][${r}]`))),this.rosterManager=new lh(this,e.logger.createChild((()=>`[RosterManager][${r}]`))),this.localParticipant.participantId||(this.localParticipant.participantId=ls()),"string"==typeof e.signalingAgentConfig.languageCode?this.localParticipant.languageId=e.signalingAgentConfig.languageCode:"function"==typeof e.signalingAgentConfig.languageCode&&(this.localParticipant.languageId=e.signalingAgentConfig.languageCode()),e.telemetryHelper.setParticipantId(this.localParticipant.participantId),e.telemetryHelper.setEndPointId(this.localParticipant.endpointId)}handleUpdateParticipantInterpretationStateCompletion(e){const t=e.body,i=_s(e),n=t.operationId;if(this.disposed)return void this.logger.info(`[${i}][handleUpdateParticipantInterpretationStateCompletion] ignored. Call disposed.`);n||this.logger.warn(`[${i}][handleUpdateParticipantInterpretationStateCompletion] operationId is undefined.`),this.logger.info(`[${i}][handleUpdateParticipantInterpretationStateCompletion] starts`);const r=e.body;if(r.participantInfos)for(const t of r.participantInfos)if(this.logger.info(t),this.participantOperationHandler.hasPendingOperation(5,t.participant.id,i))if(this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.UPDATE_PARTICIPANT_INTERPRETATION_STATE_COMPLETION,t.participant.id),t.transactionEnd.code===Zr.TRANSACTION_END_CODE.SUCCESS)this.logger.info(`[${i}]Update participant interpretation state succeeded for: ${this.piiUtils.scrubMriOrOmit(t.participant.id)}`),this.signalingSession.telemetryHelper.recordIncomingEvent(Ld,e),this.participantOperationHandler.resolvePendingOperation(5,t.participant.id,void 0,i);else{const n=t.transactionEnd.reason;this.logger.info(`[${i}]Update participant interpretation state failed for: ${this.piiUtils.scrubMriOrOmit(t.participant.id)} reason : ${Ve(n)}`);const r=this.getCallEndGivenParticipantFailure(n);this.signalingSession.telemetryHelper.recordIncomingEvent(Nd,e,r),this.participantOperationHandler.rejectPendingOperation(5,t.participant.id,r.phrase,r,i)}}areParticipantsConnectedToCall(e){this.logger.info(`areParticipantsConnectedToCall : ${Ve(e)}`);const t=this.getCurrentParticipantsInCallModality(!0);for(const i of e)if(!t.hasOwnProperty(i))return this.logger.info(`areParticipantsConnectedToCall : returning false for :${this.piiUtils.scrubMriOrOmit(i)}`),{result:!1,participant:i};return this.logger.info("areParticipantsConnectedToCall : returning true"),{result:!0}}muteUnmute(e,t,i,n,r,s,a=!1){const o=this.logger.createFnLogger("muteUnmute",r);ds(2!==this.signalingSession.callMode,"mute/unmute operations are not allowed in streaming mode"),o.info(`operation=${e}, isAsync=${a}`),n?(s&&this.signalingSession.timeoutManager.startTimer(Zr.TIMEOUT_OPERATIONS.UNMUTE,(()=>{if(this.signalingSession&&!this.signalingSession.disposed){this.signalingSession.telemetryHelper.recordEvent(_o),this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.UNMUTE);const e=new Error("timed out waiting for response to request");e.endCode={code:Zr.CALL_END_CODE.TIMEOUT,subCode:Zr.CALL_END_SUB_CODE.UNMUTE_REQUEST_TIMEOUT,phrase:Zr.CALL_END_PHRASE.UNMUTE_REQUEST_TIMEOUT},i.reject(e)}}),Zr.TIMEOUT_VALUES_IN_SECONDS.UNMUTE_TIMEOUT),a&&this._asyncMuteUnmuteDefers.set(r,i),this.signalingSession.http.sendPostRequest({url:n,payload:t,requestName:e,withoutTrouter:!0,causeId:r}).then((t=>{if(!this.disposed)if(a)o.info(`Inline response received for async operation, operation id: ${r}.`);else{if(t.response?.muteUnmuteResponse){const n={info:t.response.muteUnmuteResponse,operationId:t.response.operationId};switch(e){case cc.UNMUTE_SYNC.name:case cc.MUTE_ALL_SYNC.name:case cc.MUTE_SPECIFIED_SYNC.name:i.resolve(n)}}i.resolve()}})).catch((e=>{const t=Cs(e,this.signalingSession.signalingAgentConfig);o.info(`operation failed, reason=${Ve(t)}`),this.disposed||(s&&this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.UNMUTE),i.reject(t.error))}))):i.reject(new Error(`[${r}][muteUnmute] cannot be performed now, the link is not yet available`))}sendNetworkRequestForUpdatingMeetingRoles(e,t,i,n,r,s){if(!i){const e=`[${r}][sendNetworkRequestForUpdatingMeetingRoles] failed because correct updateMeetingRoleUrl is not provided`;new Error(e).endCode={code:Zr.CALL_END_CODE.REJECT,subCode:Zr.CALL_END_SUB_CODE.UPDATE_MEETING_ROLE_REJECTED,phrase:e},this.logger.info(e),s.reject()}if(!e){const e=`[${r}][sendNetworkRequestForUpdatingMeetingRoles] failed because participants list is empty or null`,t=new Error(e);t.endCode={code:Zr.CALL_END_CODE.REJECT,subCode:Zr.CALL_END_SUB_CODE.UPDATE_MEETING_ROLE_REJECTED,phrase:e},this.logger.info(e),s.reject(t)}this.signalingSession.http.sendPostRequest({url:i,payload:ah(this.signalingSession,e,"specified",t),requestName:n,onceTrouterReady:()=>{this.signalingSession.timeoutManager.startTimer(Zr.TIMEOUT_OPERATIONS.UPDATE_MEETING_ROLE,(()=>{if(this.signalingSession&&!this.signalingSession.disposed){this.signalingSession.telemetryHelper.recordEvent(Il,{causeId:r}),this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.UPDATE_MEETING_ROLE);const e=new Error(`[${r}] Timed out waiting for response to request`);e.endCode={code:Zr.CALL_END_CODE.TIMEOUT,subCode:Zr.CALL_END_SUB_CODE.UPDATE_MEETING_ROLE_TIMEOUT,phrase:Zr.CALL_END_PHRASE.UPDATE_MEETING_ROLE_TIMEOUT},s.reject(e)}}),Zr.TIMEOUT_VALUES_IN_SECONDS.UPDATE_MEETING_ROLE_TIMEOUT)},causeId:r}).then((e=>{s.resolve(e.response)})).catch((e=>{const t=Ve(e);this.logger.info(`[${r}][sendNetworkRequestForUpdatingMeetingRoles] failed: ${t}`);const i=new Error(`[${r}][CS response] Forbidden request`),n=Cs(e,this.signalingSession.signalingAgentConfig);i.code=n.error.code,i.subCode=n.error.subCode,i.phrase=n.error.phrase,this.disposed||(this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.UPDATE_MEETING_ROLE),s.reject(i))}))}sendNetworkRequestForNudgingParticipants(e,t,i,n,r,s,a){if(t){const o=()=>{this.signalingSession.timeoutManager.startTimer(Zr.TIMEOUT_OPERATIONS.NUDGE_PARTICIPANT,(()=>{this.signalingSession&&!this.signalingSession.disposed&&(this.signalingSession.telemetryHelper.recordEvent(To),this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.NUDGE_PARTICIPANT,e?e.join():""))}),Zr.TIMEOUT_VALUES_IN_SECONDS.NUDGE_PARTICIPANT_TIMEOUT,e?e.join():"")},l=s||r?function(e,t,i,n,r,s){hs(e,"signalingSession cannot be null"),hs(t,"participantsIds cannot be null");const a=e.groupId?{id:e.groupId}:null,o=n?{threadId:n,messageId:r||null}:null,l=[];return t.forEach((e=>{const t={id:e};l.push(t)})),{payload:{participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},invitationType:Zr.INVITATION_TYPE.NUDGE,to:l},participantInvitationData:s,groupContext:a,groupChat:o,links:{nudgeParticipantSuccess:is(e,Dr.CONV_NUDGE_PARTICIPANT_SUCCESS),nudgeParticipantFailure:is(e,Dr.CONV_NUDGE_PARTICIPANT_FAILURE)}}}}(this.signalingSession,e,0,s,a,n):function(e,t,i){hs(e,"signalingSession cannot be null"),hs(t,"participantsIds cannot be null");const n=[];return t.forEach((e=>{const t={id:e};n.push(t)})),{payload:{participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},invitationType:Zr.INVITATION_TYPE.NUDGE,to:n},participantInvitationData:i,links:{nudgeParticipantSuccess:is(e,Dr.CONV_NUDGE_PARTICIPANT_SUCCESS),nudgeParticipantFailure:is(e,Dr.CONV_NUDGE_PARTICIPANT_FAILURE),addParticipantSuccess:is(e,Dr.CONV_ADD_PARTICIPANT_SUCCESS),addParticipantFailure:is(e,Dr.CONV_ADD_PARTICIPANT_FAILURE)}}}}(this.signalingSession,e,n);return this.signalingSession.http.sendPostRequest({url:t,payload:l,requestName:cc.NUDGE_PARTICIPANT.name,onceTrouterReady:o,causeId:i}).then((()=>{})).catch((t=>{const n=Cs(t,this.signalingSession.signalingAgentConfig);return this.logger.info(`[${i}][sendNetworkRequestForNudgingParticipant][failed][reason=${Ve(n)}]`),this.disposed||this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.NUDGE_PARTICIPANT,e?e.join():""),Promise.reject(n.error)}))}return this.logger.info(`[${i}][sendNetworkRequestForNudgingParticipant] failed because correct nudgeParticipantUrl is not provided`),Promise.reject("Missing nudgeParticipant url")}sendNetworkRequestForAddingParticipant(e,t,i,n=os()){if(t){let r=cc.ADD_PARTICIPANT.name,s=Zs,a={};switch(i.replacementType){case 2:r=cc.ADD_PARTICIPANT_WITH_PICKUP_CODE.name,s=Gl,a.unparkContent={pickupCode:i.pickupCode};break;case 1:r=cc.ADD_PARTICIPANT_WITH_REPLACES.name,s=ta,a=this.signalingSession.getCallReplacementDetailsForCall(i.callIdToReplace,n);break;case 3:r=cc.ADD_PARTICIPANT_WITH_REPLACES.name,s=ta,a=this.signalingSession.getReplacementDetailsByParticipantLegOfCall(i.callIdToReplace,e[0].id,e[0].replacementParticipantId,n);break;default:r=cc.ADD_PARTICIPANT.name,s=Zs,a=null}const o=()=>{e.forEach((e=>{const t=3===i.replacementType?e.participantId:e.id;this.signalingSession.timeoutManager.startTimer(Zr.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,(()=>{this.signalingSession&&!this.signalingSession.disposed&&(this.signalingSession.telemetryHelper.recordEvent(s,{causeId:n}),this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,t),this.participantOperationHandler.rejectPendingOperation(0,t,"timed out waiting for participant to show up in roster",{code:Zr.CALL_END_CODE.TIMEOUT,subCode:Zr.CALL_END_SUB_CODE.CALL_ESTABLISHMENT_TIMEOUT,phrase:Zr.CALL_END_PHRASE.ESTABLISHMENT_TIMEOUT},n))}),Zr.TIMEOUT_VALUES_IN_SECONDS.ADD_PARTICIPANT_TIMEOUT,t)}))},l=i.threadId||i.groupId?ih(this.signalingSession,e,i,a):function(e,t,i,n){hs(e,"signalingSession cannot be null");const r=t.map((e=>(hs(e,"remoteParticipant cannot be null"),{id:e.id,assertedId:e.assertedId,displayName:e.displayName,participantId:e.participantId})));return{payload:{disableUnmute:i&&i.disableUnmute,participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId,alternateId:i?i.alternateId:null},to:r},participantInvitationData:i.additionalData,replacementDetails:n,links:{addParticipantSuccess:is(e,Dr.CONV_ADD_PARTICIPANT_SUCCESS),addParticipantFailure:is(e,Dr.CONV_ADD_PARTICIPANT_FAILURE)},debugContent:{clientScenario:i.clientScenario}}}}(this.signalingSession,e,i,a);this.signalingSession.http.sendPostRequest({url:t,payload:l,requestName:r,onceTrouterReady:o,causeId:n}).catch((t=>{const r=Cs(t,this.signalingSession.signalingAgentConfig);this.logger.info(`[${n}][sendNetworkRequestForAddingParticipant] failed:${Ve(t)}`),this.disposed||e.forEach((e=>{const s=3===i.replacementType?e.participantId:e.id;this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,s),this.participantOperationHandler.rejectPendingOperation(0,s,t,r.error,n)}))}))}else this.logger.info(`[${n}][sendNetworkRequestForAddingParticipants] failed because correct addParticipantUrl is not provided`),e.forEach((e=>{const t=3===i.replacementType?e.participantId:e.id;this.participantOperationHandler.rejectPendingOperation(0,t,"correct addParticipantUrl is not provided",{code:Zr.CALL_END_CODE.LOCAL_ERROR,subCode:Zr.CALL_END_SUB_CODE.CALL_NOT_ATTEMPTED,phrase:Zr.CALL_END_PHRASE.ADD_PARTICIPANT_URL_MISSING},n)}))}sendNetworkRequestToUpdateParticipantInterpretationState(e,t,i,n=os()){if(t){const r=cc.UPDATE_PARTICIPANT_INTERPRETATION_STATE.name,s=kd,a=()=>{const t={code:Zr.CALL_END_CODE.TIMEOUT,subCode:Zr.CALL_END_SUB_CODE.UPDATE_PARTICIPANT_INTERPRETATION_STATE_TIMEOUT,phrase:Zr.CALL_END_PHRASE.UPDATE_PARTICIPANT_INTERPRETATION_STATE_TIMEOUT};e.forEach((e=>{this.signalingSession.timeoutManager.startTimer(Zr.TIMEOUT_OPERATIONS.UPDATE_PARTICIPANT_INTERPRETATION_STATE_COMPLETION,(()=>{this.signalingSession&&!this.signalingSession.disposed&&(this.logger.info(`[${n}][sendNetworkRequestToUpdateParticipantInterpretationState] timed out`),this.signalingSession.telemetryHelper.recordEvent(s,{causeId:n}),this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.UPDATE_PARTICIPANT_INTERPRETATION_STATE_COMPLETION,e.id),this.participantOperationHandler.rejectPendingOperation(5,e.id,"timed out waiting to update particiant interpretation state",t,n))}),Zr.TIMEOUT_VALUES_IN_SECONDS.UPDATE_PARTICIPANT_INTERPRETATION_STATE_COMPLETION_TIMEOUT,e.id)}))},o=function(e,t,i){return hs(e,"signalingSession cannot be null"),hs(t,"options cannot be null"),{payload:{from:{id:e.participantManager.localParticipant.id},to:t,links:{updateParticipantInterpretationStateStatus:is(e,Dr.UPDATE_PARTICIPANT_INTERPRETATION_STATE_STATUS)},operationId:i}}}(this.signalingSession,i,n);this.signalingSession.http.sendPostRequest({url:t,payload:o,requestName:r,onceTrouterReady:a,causeId:n}).catch((t=>{const i=Cs(t,this.signalingSession.signalingAgentConfig);this.logger.info(`[${n}][sendNetworkRequestToUpdateParticipantInterpretationState] failed:${Ve(t)}`),this.disposed||e.forEach((e=>{this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.UPDATE_PARTICIPANT_INTERPRETATION_STATE_COMPLETION,e.id),this.participantOperationHandler.rejectPendingOperation(5,e.id,t,i.error,n)}))}))}else{this.logger.info(`[${n}][sendNetworkRequestToUpdateParticipantInterpretationState] failed because correct updateParticipantUrl is not provided`);const t={code:Zr.CALL_END_CODE.LOCAL_ERROR,subCode:Zr.CALL_END_SUB_CODE.CALL_NOT_ATTEMPTED,phrase:Zr.CALL_END_PHRASE.UPDATE_PARTICIPANT_INTERPRETATION_STATE_URL_MISSING};e.forEach((e=>{this.participantOperationHandler.rejectPendingOperation(5,e.id,"correct updateParticipantUrl is not provided",t,n)}))}}sendNetworkRequestForCallMeBack(e,t,i){if(t){const n=()=>{this.signalingSession.timeoutManager.startTimer(Zr.TIMEOUT_OPERATIONS.CALL_ME_BACK,(()=>{this.signalingSession&&!this.signalingSession.disposed&&(this.signalingSession.telemetryHelper.recordEvent(ca,{causeId:i}),this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.CALL_ME_BACK,e.id),this.participantOperationHandler.rejectPendingOperation(2,e.id,"timed out waiting for call me back success response",{code:Zr.CALL_END_CODE.TIMEOUT,subCode:Zr.CALL_END_SUB_CODE.CALL_ESTABLISHMENT_TIMEOUT,phrase:Zr.CALL_END_PHRASE.ESTABLISHMENT_TIMEOUT},i))}),Zr.TIMEOUT_VALUES_IN_SECONDS.CALL_ME_BACK_TIMEOUT,e.id)},r={groupId:this.signalingSession.groupId,threadId:this.signalingSession.threadId,messageId:this.signalingSession.teamsMessageId};this.signalingSession.http.sendPostRequest({url:t,payload:ih(this.signalingSession,[e],r),requestName:cc.CALL_ME_BACK.name,onceTrouterReady:n,causeId:i}).catch((t=>{const n=Cs(t,this.signalingSession.signalingAgentConfig);this.logger.info(`[${i}][sendNetworkRequestForCallMeBack] failed: ${Ve(n)}`),this.disposed||(this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.CALL_ME_BACK,e.id),this.participantOperationHandler.rejectPendingOperation(2,e.id,t,n.error,i))}))}else this.logger.info(`[${i}][sendNetworkRequestForCallMeBack] failed because correct addParticipantUrl is not provided`),this.participantOperationHandler.rejectPendingOperation(2,e.id,"correct addParticipantUrl is not provided",{code:Zr.CALL_END_CODE.LOCAL_ERROR,subCode:Zr.CALL_END_SUB_CODE.CALL_NOT_ATTEMPTED,phrase:Zr.CALL_END_PHRASE.ADD_PARTICIPANT_URL_MISSING},i)}sendNetworkRequestForAdmittingParticipant(e,t,i){if(t){const n=()=>{this.signalingSession.timeoutManager.startTimer(Zr.TIMEOUT_OPERATIONS.ADMIT_PARTICIPANT,(()=>{this.signalingSession&&!this.signalingSession.disposed&&(this.signalingSession.telemetryHelper.recordEvent(ra),this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.ADMIT_PARTICIPANT,e.id),this.participantOperationHandler.rejectPendingOperation(1,e.id,"timed out waiting for participant to show up in roster",{code:Zr.CALL_END_CODE.TIMEOUT,subCode:Zr.CALL_END_SUB_CODE.CALL_ESTABLISHMENT_TIMEOUT,phrase:Zr.CALL_END_PHRASE.ESTABLISHMENT_TIMEOUT},i))}),Zr.TIMEOUT_VALUES_IN_SECONDS.ADMIT_PARTICIPANT_TIMEOUT,e.id)};this.signalingSession.http.sendPostRequest({url:t,payload:nh(this.signalingSession,e,i),requestName:cc.ADMIT_PARTICIPANT.name,onceTrouterReady:n,causeId:i}).catch((t=>{const n=Cs(t,this.signalingSession.signalingAgentConfig);this.logger.info(`[${i}][sendNetworkRequestForAdmittingParticipant][failed][reason=${Ve(n)}]`),this.disposed||(this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.ADMIT_PARTICIPANT,e.id),this.participantOperationHandler.rejectPendingOperation(1,e.id,t,n.error,i))}))}else this.logger.info(`[${i}][sendNetworkRequestForAdmittingParticipant] failed because correct admitParticipantUrl is not provided`),this.participantOperationHandler.rejectPendingOperation(1,e.id,"correct admitParticipantUrl is not provided",{code:Zr.CALL_END_CODE.LOCAL_ERROR,subCode:Zr.CALL_END_SUB_CODE.CALL_NOT_ATTEMPTED,phrase:Zr.CALL_END_PHRASE.ADMIT_PARTICIPANT_URL_MISSING},i)}getCurrentParticipantsInCallModality(e){const t={},i=[Zr.PARTICIPANT_AUDIO_STATE.CONNECTED];return e||i.push(Zr.PARTICIPANT_AUDIO_STATE.CONNECTING,Zr.PARTICIPANT_AUDIO_STATE.RINGING),this.signalingSessionCallback.getRemoteParticipantCollection()?.forEach((e=>{i.some((t=>t===e.audioState))&&(t[e.mri]=!0)})),t}internalHandleRemoveParticipantFailure(e,t,i){if(this.participantOperationHandler.hasPendingOperation(3,e,i)){this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.REMOVE_PARTICIPANT,e),this.logger.info(`[${i}][internalHandleRemoveParticipantFailure] failed for ${this.piiUtils.scrubMriOrOmit(e)} reason ${Ve(t)}`);const n=this.getCallEndGivenParticipantFailure(t);this.participantOperationHandler.rejectPendingOperation(3,e,n.phrase,n,i)}}internalHandleCallMeBackSuccessHelper(e,t){if(this.participantOperationHandler.hasPendingOperation(2,e,t)){const i={id:e};return this.logger.info(`participant : ${this.piiUtils.scrubMriOrOmit(e)} was successfully added. Resolving CallMeBack request`),this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.CALL_ME_BACK,e),this.participantOperationHandler.resolvePendingOperation(2,i.id,i,t),!0}return!1}internalHandleAddParticipantFailure(e,t=os()){const i=e.body;if(i.participantInfos)i.participantInfos.forEach((i=>{const n=[i.participant.participantId],r=this.participantOperationHandler.getRnlMri(n,t)||i.participant.id;this.rejectAddParticipantFailure(r,i.transactionEnd,e,t)}));else if(i.participants)for(const n of Object.keys(i.participants))this.rejectAddParticipantFailure(n,i.participants[n],e,t)}rejectAddParticipantFailure(e,t,i,n){const r=this.getCallEndGivenParticipantFailure(t);this.signalingSession.telemetryHelper.recordIncomingEvent(fa,i,r),this.participantOperationHandler.hasPendingOperation(0,e,n)?(this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,e),this.logger.info(`participantAdd failed for : ${this.piiUtils.scrubMriOrOmit(e)} reason : ${Ve(t)}`),this.participantOperationHandler.rejectPendingOperation(0,e,r.phrase,r,n)):this.participantOperationHandler.hasPendingOperation(2,e,n)&&(this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.CALL_ME_BACK,e),this.logger.info(`callMeBack failed for : ${this.piiUtils.scrubMriOrOmit(e)} reason : ${Ve(t)}`),this.participantOperationHandler.rejectPendingOperation(2,e,r.phrase,r,n))}internalHandleAdmitParticipantSuccess(e,t){const i=e.body;for(const e of i.participants)this.participantOperationHandler.hasPendingOperation(1,e,t)&&(this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.ADMIT_PARTICIPANT,e),this.logger.info(`Admit participant success for : ${this.piiUtils.scrubMriOrOmit(e)}`),this.participantOperationHandler.resolvePendingOperation(1,e,void 0,t))}internalHandleAdmitParticipantFailure(e,t){const i=e.body;for(const n of Object.keys(i.participants))if(this.participantOperationHandler.hasPendingOperation(1,n,t)){this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.ADMIT_PARTICIPANT,n);const r=i.participants[n];this.logger.info(`Admit participant failed for : ${this.piiUtils.scrubMriOrOmit(n)} reason : ${Ve(r)}`);const s=this.getCallEndGivenParticipantFailure(r);this.signalingSession.telemetryHelper.recordIncomingEvent(va,e,s),this.participantOperationHandler.rejectPendingOperation(1,n,s.phrase,s,t)}}getCallEndGivenParticipantFailure(e){let t={code:e.code,subCode:e.subCode,phrase:e.phrase,resultCategories:e.resultCategories};return e.code===Zr.CALL_END_CODE.CALL_MODALITY_FAILURE&&e.callControllerTransactionEnd?t={...e.callControllerTransactionEnd}:e.code===Zr.CALL_END_CODE.ATC_CONTROLLER_FAILURE&&e.atcControllerTransactionEnd?t={...e.atcControllerTransactionEnd}:e.code===Zr.CALL_END_CODE.CVA_CONTROLLER_FAILURE&&e.cvaControllerTransactionEnd&&(t={...e.cvaControllerTransactionEnd}),t}};function ch(e,t){return`${e}-${t}`}function hh(e,t){return`${e}-${t}`}function uh(e,t,i){return`${e}_${t}_${i}`}var ph=class{constructor(e){this.signalingSession=e,this.scopeAllOperations=new Map,this.mriOperations=new Map,this.legOperations=new Map,this.logger=e.logger.createChild((()=>"[ProxiedMessageNotificationManager]"))}sendProxiedMessageAsync(e,t,i){this.logger.createChild("sendProxiedMessageAsync",e).info(`Url: ${i}`);const n=[],r=[];for(const i of t)if(0!==i.scope){if(1===i.scope)for(const t in i.to)if("participant"===i.to[t].level){const s=ch(t,i.operationId),a=As();this.mriOperations.set(s,a),n.push(a.promise),r.push(s),this.startTimeout(e,"participant",s)}else if("endpoint"===i.to[t].level)for(const s in i.to[t].participantLegIdMap){const t=hh(s,i.operationId),a=As();this.legOperations.set(t,a),n.push(a.promise),r.push(t),this.startTimeout(e,"endpoint",t)}}else{const t=As();this.scopeAllOperations.set(i.operationId,t),n.push(t.promise),r.push(i.operationId),this.startTimeout(e,"all",i.operationId)}return this.sendProxiedMessageNetworkRequest(e,t,i,r),n}sendProxiedMessageNetworkRequest(e,t,i,n){const r=function(e,t){hs(e,"signalingSession cannot be null"),cs(t,"sendMessageOptions cannot be null or empty");const i=[];for(const n of t){const t=0===n.scope?"all":"specified",r=[];n.to&&Object.keys(n.to).forEach((e=>{n.to[e].participantLegIdMap?Object.keys(n.to[e].participantLegIdMap).forEach((t=>{r.push({id:e,level:n.to[e].level,endpointId:n.to[e].participantLegIdMap[t].endpointId,participantId:t})})):r.push({id:e,level:n.to[e].level})})),i.push({links:{sendMessageStatus:is(e,Dr.SEND_MESSAGE_STATUS)},operationId:n.operationId,payload:n.payload,scope:t,to:r,type:n.type})}return{payload:{from:{displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,id:e.participantManager.localParticipant.id,languageId:e.participantManager.localParticipant.languageId??"",participantId:e.participantManager.localParticipant.participantId},messageContent:i}}}(this.signalingSession,t),s=this.logger.createChild("sendProxiedMessageNetworkRequest",e);s.info(`Url: ${i}`),this.signalingSession.http.sendPostRequest({url:i,requestName:cc.SEND_PROXIED_MESSAGE.name,payload:r,causeId:e}).catch((t=>{const i=Cs(t,this.signalingSession.signalingAgentConfig);if(s.info(`failed:${Ve(t)}`),this.signalingSession.disposed)s.info("signaling session is already disposed.");else for(const t of n){this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.SEND_MESSAGE_COMPLETION,t);let n=null;this.scopeAllOperations.has(t)?(n=this.scopeAllOperations.get(t),this.scopeAllOperations.delete(t)):this.mriOperations.has(t)?(n=this.mriOperations.get(t),this.mriOperations.delete(t)):this.legOperations.get(t)?(n=this.legOperations.get(t),this.legOperations.delete(t)):s.warn(`could not find resolveString:${t} to reject it.`),null!==n&&n.reject({transactionEnd:i.error,causeId:e,resolveString:t})}}))}startTimeout(e,t,i){const n=this.logger.createChild("startTimeout",e);n.info(`Creating timeout for level ${t} message with resolveString ${i}`),this.signalingSession.timeoutManager.startTimer(Zr.TIMEOUT_OPERATIONS.SEND_MESSAGE_COMPLETION,(()=>{this.signalingSession.telemetryHelper.recordEvent(Yd,{causeId:e,resolveString:i}),n.info(`timed out waiting for level [${t}] message with resolveString [${i}]`),this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.SEND_MESSAGE_COMPLETION,i);const r="all"===t?this.scopeAllOperations:"participant"===t?this.mriOperations:"endpoint"===t?this.legOperations:null;null!==r?r.has(i)?(r.get(i).reject({transactionEnd:{code:Zr.CALL_END_CODE.TIMEOUT,subCode:Zr.CALL_END_SUB_CODE.CONVERSATION_NOTIFICATION_TIMEOUT,phrase:Zr.CALL_END_PHRASE.CONVERSATION_NOTIFICATION_TIMEOUT},causeId:e,resolveString:i}),r.delete(i)):n.warn(`Could not find resolveString [${i}] on map for ${t}. Will not reject promise.`):n.warn(`Could not find a operations map for ${t}. Will not reject promise.`)}),Zr.TIMEOUT_VALUES_IN_SECONDS.SEND_MESSAGE_COMPLETION_TIMEOUT,i)}handleProxiedMessageNotificationItem(e,t,i){if(t.info(`Message contains ${e.participantInfos?.length} participantInfos.`),0===this.scopeAllOperations.size&&0===this.mriOperations.size&&0===this.legOperations.size)return void t.info("Received statusMessage but there is no pending operation.");const n=e.operationId;if(this.scopeAllOperations.has(n)){t.info(`Scope all resolveString:${n}`),this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.SEND_MESSAGE_COMPLETION,n);const e={transactionEnd:{code:0,subCode:0,phrase:""},causeId:i,resolveString:n};return this.scopeAllOperations.get(n).resolve(e),this.scopeAllOperations.delete(n),void this.signalingSession.telemetryHelper.recordEvent(Jd,{causeId:i,operationId:n,level:"all"})}for(const r of e.participantInfos){const e=0===r.transactionEnd?.code,s=ch(r.participant.id,n),a=hh(r.participant.participantId,n);if(s&&this.mriOperations.has(s)){t.info(`Scope mri resolveString:${s}`);const a={transactionEnd:r.transactionEnd,causeId:i,resolveString:s};e?this.mriOperations.get(s).resolve(a):this.mriOperations.get(s).reject(a),this.mriOperations.delete(s),this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.SEND_MESSAGE_COMPLETION,s),this.signalingSession.telemetryHelper.recordEvent(Jd,{causeId:i,operationId:n,level:"mri"})}else if(a&&this.legOperations.has(a)){t.info(`Scope legId resolveString:${a}`);const s={transactionEnd:r.transactionEnd,causeId:i,resolveString:a};e?this.legOperations.get(a).resolve(s):this.legOperations.get(a).reject(s),this.legOperations.delete(a),this.signalingSession.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.SEND_MESSAGE_COMPLETION,a),this.signalingSession.telemetryHelper.recordEvent(Jd,{causeId:i,operationId:n,level:"leg"})}else t.warn(`Could not map this participantInfo to any pending operation operationId:${n}`)}}handleProxiedMessageNotification(e){const t=_s(e),i=this.logger.createChild("handleProxiedMessageNotification",t);let n;n=Array.isArray(e.body?.statuses)?e.body.statuses:[e.body],i.info(`Received ${n.length} proxied message notification(s).`);for(const e of n)this.handleProxiedMessageNotificationItem(e,i,t)}};function gh(e,t,i=!0){hs(e,"signalingSession cannot be null"),hs(t,"joinUrl cannot be null");const n={type:"Delta",rosterUpdate:is(e,Dr.CONV_ROSTER_UPDATE)},r=e.getEndpointCapabilities(),s={payload:{attach:{requireMediaContent:i,links:{end:is(e,Dr.END)},locationContent:e.getLocationContent(),networkContent:e.getNetworkContent(),areaContent:e.getAreaContent()},capabilities:null,endpointCapabilities:r,additionalActions:[{input:{capabilities:null,endpointCapabilities:r,conversationRequest:{applicationType:e.participantManager.localParticipant.applicationType,roster:n,links:{conversationEnd:is(e,Dr.CONV_END),conversationUpdate:is(e,Dr.CONV_UPDATE),localParticipantUpdate:is(e,Dr.CONV_LOCAL_PARTICIPANT_UPDATE),addParticipantSuccess:is(e,Dr.CONV_ADD_PARTICIPANT_SUCCESS),addParticipantFailure:is(e,Dr.CONV_ADD_PARTICIPANT_FAILURE),receiveMessage:is(e,Dr.RECEIVE_MESSAGE)}},endpointMetadata:e.endpointMetadata,participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId}}},name:"join",url:t,waitForResponse:!0}]}};return e.signalingAgentConfig.ecsEtag&&(s.payload.debugContent={ecsEtag:e.signalingAgentConfig.ecsEtag}),s.payload.additionalActions.length>0&&e.deviceType&&"default"!==e.deviceType&&(s.payload.additionalActions[0].input.conversationRequest.deviceType=e.deviceType),s}function mh(e){return hs(e,"signalingSession cannot be null"),{payload:{callAcceptanceAcknowledgement:{links:{mediaRenegotiation:is(e,Dr.MEDIA_RENEGOTIATION),transfer:is(e,Dr.TRANSFER),replacement:is(e,Dr.REPLACE),balanceUpdate:is(e,Dr.BALANCE_UPDATE),retargetCompletion:is(e,Dr.RETARGET_COMPLETION),controlVideoStreaming:is(e,Dr.CONTROL_VIDEO_STREAMING),updateMediaDescriptions:is(e,Dr.UPDATE_MEDIA_DESCRIPTIONS)}}}}}function fh(e,t,i,n){hs(e,"signalingSession cannot be null");const r=ps(i);e.telemetryHelper.addOutgoingModalities(r);const s=e.getEndpointCapabilities();return{payload:{callAcceptance:{acceptedBy:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},acceptedCallModalities:r,capabilities:null,endpointCapabilities:s,clientEndpointCapabilities:0!==n?n:null,links:{mediaRenegotiation:is(e,Dr.MEDIA_RENEGOTIATION),transfer:is(e,Dr.TRANSFER),replacement:is(e,Dr.REPLACE),balanceUpdate:is(e,Dr.BALANCE_UPDATE),retargetCompletion:is(e,Dr.RETARGET_COMPLETION),controlVideoStreaming:is(e,Dr.CONTROL_VIDEO_STREAMING),updateMediaDescriptions:is(e,Dr.UPDATE_MEDIA_DESCRIPTIONS)},clientContentForMediaController:e.webRtcSignalingManager.getClientUrls(),mediaContent:t,pstnContent:e.pstnContent,callKeepAliveInterval:null}}}}function Sh(e,t,i){hs(e,"signalingSession cannot be null"),us(t);const n={payload:{participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,languageId:e.participantManager.localParticipant.languageId}},conversationTransactionEnd:{reason:"noError",code:Zr.CALL_END_CODE.SUCCESS,phrase:Zr.CALL_END_PHRASE.CONV_END_NO_MODALITY},callTransactionEnd:t}};return i&&t.code===Zr.CALL_END_CODE.CANCEL&&(n.payload.callTransactionEnd.callQualityDiagnosticsInformation=i),n}function vh(e,t){return{payload:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},scope:t}}}function yh(e,t,i,n,r){hs(e,"signalingSession cannot be null");const s={type:"Delta",rosterUpdate:is(e,Dr.CONV_ROSTER_UPDATE)},a=e.getEndpointCapabilities(),o=e.groupId?{id:e.groupId}:null,l=e.threadId?{threadId:e.threadId,messageId:e.teamsMessageId||null}:null,d={payload:{conversationRequest:{conversationType:n.conversationType,subject:e.convSubject,suppressDialout:n.suppressDialout,scenario:n.scenario,applicationType:n.applicationType,roster:s,properties:{allowConversationWithoutHost:e.signalingAgentConfig.doHostlessCalling,enableGroupCallEventMessages:e.signalingAgentConfig.shouldServiceSendCallEventMessages,enableGroupCallUpgradeMessage:e.signalingAgentConfig.shouldServiceSendNGCUpgradeMessages,enableGroupCallMeetupGeneration:e.enableGroupCallMeetupGeneration},links:{conversationEnd:is(e,Dr.CONV_END),conversationUpdate:is(e,Dr.CONV_UPDATE),localParticipantUpdate:is(e,Dr.CONV_LOCAL_PARTICIPANT_UPDATE),addParticipantSuccess:is(e,Dr.CONV_ADD_PARTICIPANT_SUCCESS),addParticipantFailure:is(e,Dr.CONV_ADD_PARTICIPANT_FAILURE),receiveMessage:is(e,Dr.RECEIVE_MESSAGE)}},groupContext:o,groupChat:l,participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId,meetingRegistrationId:n.meetingRegistrationId,participantPin:n.participantPin}},capabilities:null,endpointCapabilities:a,clientEndpointCapabilities:n.clientEndpointCapabilities?n.clientEndpointCapabilities:null,endpointMetadata:e.endpointMetadata,meetingInfo:e.getMeetingInfo(),meetingData:n.meetingData,meetingPreferences:n.meetingPreferences,endpointState:n.endpointState}};if(n.publishedStates?.publishedStates.length>0){let t=[];t=n.publishedStates.publishedStates.map((t=>{let i={};try{i=JSON.parse(t.content)}catch(t){e.logger.warn("joinConversationRequest getPayload() failed to parse state.content")}return{stateType:t.type,level:t.level,content:i,sequenceNumber:e.getPublishStateSequenceNumber()}})),d.payload.publishedStates=t}if(n?.applyServerMute&&(d.payload.participants.from.applyServerMute=n.applyServerMute.value,n.applyServerMute.mediaTypes&&(d.payload.participants.from.mediaTypes=n.applyServerMute.mediaTypes)),e.deviceType&&"default"!==e.deviceType&&(d.payload.conversationRequest.deviceType=e.deviceType),!n.subscribe){const r=ps(i);e.telemetryHelper.addOutgoingModalities(r),d.payload.callInvitation={callModalities:r,replaces:null,transferor:null,links:{progress:is(e,Dr.PROGRESS),mediaAnswer:is(e,Dr.MEDIA_ANSWER),acceptance:is(e,Dr.ACCEPT),redirection:is(e,Dr.REDIRECTION),end:is(e,Dr.END)},clientContentForMediaController:e.webRtcSignalingManager.getClientUrls(),mediaContent:t,pstnContent:e.pstnContent,locationContent:e.getLocationContent(),networkContent:e.getNetworkContent(),areaContent:e.getAreaContent(),sharedLineCallInvitationContent:n.sharedLineCallInvitationContent,invitationData:n.invitationData}}if(e.signalingAgentConfig.ecsEtag&&(d.payload.debugContent={ecsEtag:e.signalingAgentConfig.ecsEtag}),r&&(d.payload.debugContent||(d.payload.debugContent={}),d.payload.debugContent.causeId=r),n.clientEndpointDebugContent){d.payload.debugContent||(d.payload.debugContent={});try{d.payload.debugContent.clientDebugContent=JSON.parse(n.clientEndpointDebugContent)}catch(e){ds(!1,`Failed to parse ${n.clientEndpointDebugContent}`)}}if(n.captchaContentJson)try{d.payload.conversationRequest.captchaContent=JSON.parse(n.captchaContentJson)}catch(e){ds(!1,`Failed to parse ${n.captchaContentJson}`)}return n.callQueueContext&&(d.payload.conversationRequest.callQueueContext=n.callQueueContext),d}function Ch(e,t,i,n){hs(e,"signalingSession cannot be null"),us(t);const r={payload:{participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},scope:n&&"all"!==n?void 0:n},conversationTransactionEnd:{reason:"noError",code:Zr.CALL_END_CODE.SUCCESS,phrase:Zr.CALL_END_PHRASE.CONV_END_NO_MODALITY},callTransactionEnd:t}};return i&&t.code===Zr.CALL_END_CODE.CANCEL&&(r.payload.callTransactionEnd.callQualityDiagnosticsInformation=i),r}function Th(e,t,i){return hs(e,"signalingSession cannot be null"),hs(i,"newOfferLink cannot be null"),{payload:{mediaOfferRequirements:{compatibleContentTypes:t,links:{offerReady:is(e,Dr.NEW_MEDIA_OFFER)}}}}}function Eh(e,t,i){hs(e,"ParkRequestPayload: signalingSession cannot be null");const n={payload:{hold:{holdType:t,links:{holdCompletion:is(e,Dr.PARK_COMPLETION)}}}};return i&&(n.payload.debugContent=i),n}function _h(e,t,i,n,r,s){const a={payload:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},publishedState:{content:n,level:i,stateType:t,sequenceNumber:e.getPublishStateSequenceNumber()},scope:r}};if(s&&s.length>0){const e=s.map((e=>({id:e})));a.payload.to=e}return a}function bh(e,t){return hs(e,"signalingSession cannot be null"),us(t),{payload:{callEnd:t}}}function Ph(e,t,i,n){const r={from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},sequenceNumber:e.getPublishStateSequenceNumber(),scope:t};return"specified"===t?r.stateIds=i:r.stateType=n,{payload:r}}function Ih(e,t,i,n,r){return hs(t,"signalingSession cannot be null"),cs(e,"transferTarget cannot be null OR empty"),{payload:{callTransfer:{target:{id:e,endpointType:"TransferTypeVoicemail"===n?"voicemail":void 0},transferor:{details:{id:t.participantManager.localParticipant.id,endpointId:t.participantManager.localParticipant.endpointId,participantId:t.participantManager.localParticipant.participantId,languageId:t.participantManager.localParticipant.languageId},authorizationToken:null},links:{transferAcceptance:is(t,Dr.TRANSFER_ACCEPTANCE),transferCompletion:is(t,Dr.TRANSFER_COMPLETION)},replacementDetails:i,disableForwardingAndUnanswered:r&&r.disableForwardingAndUnanswered,transferContext:r&&r.clientTransferContext}}}}function Ah(e){return{payload:{transferCompletion:e}}}function Rh(e,t){hs(e,"ResumePayload: signalingSession cannot be null");const i={payload:{resume:{links:{resumeCompletion:is(e,Dr.UNPARK_COMPLETION)}}}};return t&&(i.payload.debugContent=t),i}function wh(e,t){return hs(t,"clientMetadataJson cannot be null"),{payload:{participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId}},endpointMetadata:t}}}function Mh(e,t,i,n){hs(t,"clientStateJson cannot be null");const r={payload:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},endpointState:t}};if(i?.publishedStates.length>0){let t=[];t=i.publishedStates.map((t=>{let i={};try{i=JSON.parse(t.content)}catch(t){e.logger.warn("updateEndpointState getPayload() failed to parse stateType.content")}return{stateType:t.type,level:t.level,content:i,sequenceNumber:e.getPublishStateSequenceNumber()}})),r.payload.publishedStates=t}return n&&(r.payload.links={updateEndpointStateStatus:is(e,Dr.DISABLE_PREHEAT_ASYNC_STATUS)}),r}function Oh(e,t){const i={};return void 0!==t.allowRaiseHands&&(i.allowRaiseHands=t.allowRaiseHands),void 0!==t.attendeeRestrictions&&(i.attendeeRestrictions=t.attendeeRestrictions),void 0!==t.lockMeeting&&(i.lockMeeting=t.lockMeeting),void 0!==t.breakoutRoomsEnabled&&(i.breakoutRoomsEnabled=t.breakoutRoomsEnabled),void 0!==t.allowPresentersToManageBreakoutRooms&&(i.allowPresentersToManageBreakoutRooms=t.allowPresentersToManageBreakoutRooms),void 0!==t.disableMdpClientAudioRecording&&(i.disableMdpClientAudioRecording=t.disableMdpClientAudioRecording),void 0!==t.refreshSettings&&(i.refreshSettings=t.refreshSettings),{payload:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},meetingSettings:i,sequenceNumber:e.getPublishStateSequenceNumber()}}}function Dh(e,t){return hs(e,"signalingSession cannot be null"),{payload:{mediaAnswer:{sender:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},mediaContent:t,pstnContent:e.pstnContent}}}}function kh(e,t){return hs(e,"signalingSession cannot be null"),{payload:{UpdateMediaDescriptions:{mediaDescriptions:t}}}}var Nh=T(i(496486)),Lh=T(ve()),xh=class{constructor(e,t){this.signalingSession=e,this.logger=t,this.logConversationCallModalityEvent=e=>{const t=this.createCallModalityEvent(e);this.logger.info("sending modality telemetry:",this.getStringifiedEventData(t)),t.hostName=this.getHostDomainInfo(),this.telemetryLogger.sendEvent(hc.EVENT_TYPE.CONVERSATION_CALL_MODALITY,t)},this.logConversationContentSharingEvent=e=>{e[hc.CONTEXT_ID.CORRELATION_ID]=this.signalingSession.correlationId,e[hc.EXTENSIONS.ECS_ETAG]=this.signalingSession.signalingAgentConfig.ecsEtag,this.logger.info("sending content sharing telemetry:",this.getStringifiedEventData(e)),e.hostName=this.getHostDomainInfo(),this.telemetryLogger.sendEvent(hc.EVENT_TYPE.CONVERSATION_CONTENT_SHARING,e)},this.logHttpTelemetryEvent=e=>{e[hc.EXTENSIONS.ECS_ETAG]=this.signalingSession.signalingAgentConfig.ecsEtag,e[hc.SIGNALING_CONFIG]=this.getSignalingAgentConfig(),this.logger.info("sending http telemetry:",this.getStringifiedEventData(e)),e.hostName=this.getHostDomainInfo(),this.telemetryLogger.sendEvent(hc.EVENT_TYPE.CONVERSATION_HTTP_REQUEST,e)},this.getHostDomainInfo=()=>"localhost"===location.hostname||"127.0.0.1"===location.hostname?"localhost":"<redacted>",this.getSignalingAgentConfig=()=>{const e=[],t=this.signalingSession.signalingAgentConfig;return t.supportsCompressedServicePayload&&e.push(hc.SIGNALING_CONFIG_FLAGS.SUPPORTS_COMPRESSED_PAYLOAD),t.brokerEnabledOutgoing&&e.push(hc.SIGNALING_CONFIG_FLAGS.BROKER_OUTGOING_ENABLED),t.brokerEnabledIncoming&&e.push(hc.SIGNALING_CONFIG_FLAGS.BROKER_INCOMING_ENABLED),t.brokerRequestBatching&&e.push(hc.SIGNALING_CONFIG_FLAGS.BROKER_REQUEST_BATCHING_ENABLED),t.brokerExclusively&&e.push(hc.SIGNALING_CONFIG_FLAGS.BROKER_EXCLUSIVELY_ENABLED),t.supportsSynchronousTrouterResponse&&e.push(hc.SIGNALING_CONFIG_FLAGS.SYNC_TROUTER_RESPONSE),t.handleMediaOfferFromPushNotification&&e.push(hc.SIGNALING_CONFIG_FLAGS.HANDLE_OFFER_FROM_NOTIFICATION),t.handleNewOfferRequest&&e.push(hc.SIGNALING_CONFIG_FLAGS.HANDLE_NEW_OFFER_REQUEST),t.sendProgressFromCC&&e.push(hc.SIGNALING_CONFIG_FLAGS.SEND_PROGRESS_FROM_CC),t.useInternalHttpDispatcher&&e.push(hc.SIGNALING_CONFIG_FLAGS.INTERNAL_HTTP_DISPATCHER),t.enableTokenCache&&e.push(hc.SIGNALING_CONFIG_FLAGS.ENABLE_TOKEN_CACHE),t.enableTokenPrefetch&&e.push(hc.SIGNALING_CONFIG_FLAGS.ENABLE_TOKEN_PREFETCH),t.supportMediaRetargetWhileIncomingRenegotiation&&e.push(hc.SIGNALING_CONFIG_FLAGS.SUPPORT_MEDIA_RETARGET_WHILE_INCOMING_RENEGOTIATION),t.enableCallEstablishmentTimeoutsForStartJoinCall&&e.push(hc.SIGNALING_CONFIG_FLAGS.ENABLE_CALL_ESTABLISHMENT_TIMEOUTS_FOR_START_OR_JOIN_CALL),t.enableTokenCacheForGenericTokenAPI&&e.push(hc.SIGNALING_CONFIG_FLAGS.ENABLE_TOKEN_CACHE_FOR_GENERIC_TOKEN_API),t.enableLongOutgoing1To1SetupTimeoutForWeb&&e.push(hc.SIGNALING_CONFIG_FLAGS.ENABLE_LONG_OUTGOING_1TO1_SETUP),e.push(hc.SIGNALING_CONFIG_FLAGS.SERVER_MUTE_UNMUTE),e.join(",")},this.getStringifiedEventData=e=>{try{return JSON.stringify(e)}catch(e){return"invalid data"}},this.telemetryLogger=this.signalingSession.signalingAgentConfig.oneDsTelemetryLogger??this.signalingSession.signalingAgentConfig.telemetryManager}createCallModalityEvent(e){const t={};t.Type=hc.SOURCE.NGC_SOURCE;const i=(i,n=!1)=>{e.hasOwnProperty(i)&&(t[i]=n?JSON.stringify(e[i]):e[i])};if(t.ResultDetail=e[hc.EXTENSIONS.RESULT_DETAIL],t.ResultValue=e[hc.EXTENSIONS.RESULT_VALUE],t.ResultCode=e[hc.EXTENSIONS.CALL_END_CODE],t.ResultCauseId=e[hc.EXTENSIONS.RESULT_CAUSE_ID],t[hc.SIGNALING_CONFIG]=this.getSignalingAgentConfig(),t[hc.CONTEXT_ID.CORRELATION_ID]=this.signalingSession.correlationId,t[hc.CONTEXT_ID.SIGNALING_SESSION_ID]=this.signalingSession.sessionId,t[hc.CONTEXT_ID.ENDPOINT_ID]=e[hc.CONTEXT_ID.ENDPOINT_ID],t[hc.CONTEXT_ID.PARTICIPANT_ID]=e[hc.CONTEXT_ID.PARTICIPANT_ID],t[hc.EXTENSIONS.ECS_ETAG]=this.signalingSession.signalingAgentConfig.ecsEtag,t[hc.EXTENSIONS.CONVERSATION_SERVICE_URL]=e[hc.EXTENSIONS.CONVERSATION_SERVICE_URL],t[hc.EXTENSIONS.CALL_START_TIME]=JSON.stringify(e[hc.EXTENSIONS.CALL_START_TIME]),t[hc.EXTENSIONS.CALL_END_TIME]=JSON.stringify(e[hc.EXTENSIONS.CALL_END_TIME]),t[hc.EXTENSIONS.MESSAGING_CHANNEL]=JSON.stringify(e[hc.EXTENSIONS.MESSAGING_CHANNEL]),t[hc.EXTENSIONS.IS_GROUP_CALL]=this.signalingSession.multiParty?"true":"false",t[hc.EXTENSIONS.IS_HOSTLESS_CALL]=this.signalingSession.isHostLessCall?"true":"false",t[hc.EXTENSIONS.IS_CAST_CALL]=this.signalingSession.isCastCall?"true":"false",t[hc.EXTENSIONS.IS_HUDDLE_GROUP_CALL]=this.signalingSession.isHuddleGroupCall?"true":"false",t[hc.EXTENSIONS.IS_ON_BEHALF_OF_CALL]=this.signalingSession.onBehalfOf?"true":"false",t[hc.EXTENSIONS.CLIENT_INFORMATION]=e[hc.EXTENSIONS.CLIENT_INFORMATION],t[hc.EXTENSIONS.IS_SDP_IN_CALL_NOTIFICATION]=e[hc.EXTENSIONS.IS_SDP_IN_CALL_NOTIFICATION],t[hc.EXTENSIONS.CALL_TERMINATING_END]=e[hc.EXTENSIONS.CALL_TERMINATING_END],t[hc.EXTENSIONS.CALL_END_CODE]=JSON.stringify(e[hc.EXTENSIONS.CALL_END_CODE]),t[hc.EXTENSIONS.CALL_END_SUB_CODE]=JSON.stringify(e[hc.EXTENSIONS.CALL_END_SUB_CODE]),i(hc.CONTEXT_ID.SHARED_CORRELATION_ID),i(hc.EXTENSIONS.DIRECTION),i(hc.EXTENSIONS.SELF_PARTICIPANT_ROLE),i(hc.EXTENSIONS.CONNECTED_DURATION_IN_MS,!0),i(hc.EXTENSIONS.TIME_TO_RING_IN_MS,!0),i(hc.EXTENSIONS.NETWORK_REQUESTS_COMPLETED),i(hc.EXTENSIONS.NETWORK_REQUESTS_PENDING),i(hc.EXTENSIONS.LOCAL_OPERATIONS_PERFORMED),i(hc.EXTENSIONS.EVENT_TIMESTAMP_BAG),i(hc.EXTENSIONS.ROSTER_UPDATES_BAG),i(hc.EXTENSIONS.NETWORK_REQUESTS_BAG),i(hc.EXTENSIONS.TROUTER_WAIT_OPERATIONS),i(hc.EXTENSIONS.LOCAL_OFFER_ANSWER_GENERATION_TIMESTAMPS),i(hc.EXTENSIONS.OUTGOING_MODALITIES),i(hc.EXTENSIONS.INCOMING_MODALITIES),i(hc.EXTENSIONS.OFFERED_MODALITIES),i(hc.EXTENSIONS.ANSWERED_MODALITIES),i(hc.EXTENSIONS.VBSS_OPERATIONS),i(hc.EXTENSIONS.CALLER_TYPE),i(hc.EXTENSIONS.CALLEE_TYPE),i(hc.EXTENSIONS.SCENARIO),i(hc.EXTENSIONS.PREHEATED_CALL_SETUP_DURATION_IN_S),i(hc.EXTENSIONS.CALL_CANCELATION_DURATION_IN_S),i(hc.EXTENSIONS.IS_PREHEATED),i(hc.EXTENSIONS.ACS_RESOURCE_ID),i(hc.EXTENSIONS.CALL_END_RESULT_CATEGORIES),i(hc.EXTENSIONS.APPLICATION_TYPE),i(hc.EXTENSIONS.RING),i(hc.EXTENSIONS.REGION),i(hc.EXTENSIONS.PARTITION),i(hc.EXTENSIONS.JOINED_FROM),i(hc.EXTENSIONS.MEETING_URL),i(hc.EXTENSIONS.MEETING_CODE),i(hc.EXTENSIONS.USER_HEX_CID),i(hc.EXTENSIONS.BROADCAST_MEETING_ROLE),i(hc.EXTENSIONS.MEETING_ROLE),i(hc.EXTENSIONS.ADVANCED_MEETING_ROLE),i(hc.EXTENSIONS.PARTICIPANT_TYPE),i(hc.EXTENSIONS.AUDIO_ONLY_WATERMARK),i(hc.EXTENSIONS.TARGET_APPLICATION_TYPE),i(hc.EXTENSIONS.IS_REINVITELESS),i(hc.EXTENSIONS.CLIENT_TYPE),this.signalingSession.callType&&(t[hc.EXTENSIONS.CALL_TYPE]=this.signalingSession.callType),this.signalingSession.signalingAgentConfig.testCall&&(t[hc.EXTENSIONS.TEST_CONTEXT_ID]="Test"),this.signalingSession.groupId&&(t[hc.CONTEXT_ID.GROUP_ID]=ke(this.signalingSession.groupId)),this.signalingSession.threadId&&(t[hc.CONTEXT_ID.THREAD_ID]=Le(this.signalingSession.threadId)),this.signalingSession.teamsMessageId&&(t[hc.CONTEXT_ID.TEAMS_MESSAGEID]=this.signalingSession.teamsMessageId),this.signalingSession.getMeetingInfo()){const e={...this.signalingSession.getMeetingInfo()};e.hasOwnProperty("organizerId")&&(e.organizerId=ke(e.organizerId)),t[hc.CONTEXT_ID.TEAMS_MEETINGINFO]=JSON.stringify(e)}return this.signalingSession.multiParty&&0===this.signalingSession.numberOfOriginalInvitees&&e.hasOwnProperty(hc.EXTENSIONS.SELF_PARTICIPANT_ROLE)&&e[hc.EXTENSIONS.SELF_PARTICIPANT_ROLE]===hc.ROLE.CALLER&&(t[hc.EXTENSIONS.IS_MEETUP_CALL]="true"),t}},Fh=class{constructor(e,t,i){this.signalingSession=e,this.callStartTime=i,this.networkRequestsCompleted=[],this.networkRequestsStarted={},this.networkRequests={},this.localOperationsPerformed=[],this.recordedEvents=[],this.rosterUpdates=[],this.contentSharingOperationsPerformed={},this.outgoingModalities=[],this.incomingModalities=[],this.offeredModalities="",this.answeredModalities="",this.vbssOperations=[],this.vbssStarted=!1,this.localOfferAnswerGenerationTimestamps=[],this.trouterWaitOperations=[],this.telemetryData={},this.contentSharingBaseTelemetryData={},this.httpRequestTelemetryData={},this.connectedStopWatch=null,this.preheatedCallSetupDurationWatch=null,this.callCancelationDurationWatch=null,this.timeToRingStopWatch=null,this.isSdpInCallNotification=!1,this.isPreheated=0,this.isReinviteless=0,this.addBrokerChannel=()=>{this.setMessagingChannel(hc.MESSAGING_CHANNEL.BROKER)},this.addTrouterChannel=()=>{this.setMessagingChannel(hc.MESSAGING_CHANNEL.TROUTER)},this.addTrouterWaitOperation=e=>{this.trouterWaitOperations.push(this.recordOperation(e))},this.recordIncomingEvent=(e,t,i)=>{const n=_s(t),r={origin:t.origin,causeId:n,data:i};i||delete r.data,this.recordEvent(e,r)},this.recordIncomingEventCount=e=>{this.localOperationsPerformed.push(this.recordOperation(e));const t=this.recordedEvents.findIndex((t=>t[e]));if(-1!==t)this.recordedEvents[t][e]+=1;else{const t={};t[e]=1,this.recordedEvents.push(t)}},this.recordEvent=(e,t)=>{this.logger.debug("Event:",e,t),this.localOperationsPerformed.push(this.recordOperation(e));const i={};i[e]=this.timeSinceCallStart(),t&&(i.data=t),this.recordedEvents.push(i)},this.recordRosterEvent=(e,t,i)=>{this.localOperationsPerformed.push(this.recordOperation(t));const n={data:e,causeId:i},r={eventName:this.timeSinceCallStart(),data:n};this.rosterUpdates.push(r)},this.addOutgoingModalities=e=>{e&&this.outgoingModalities.push(e)},this.addIncomingModalities=e=>{e&&this.incomingModalities.push(e)},this.setOfferedModalities=(e,t)=>{this.offeredModalities=this.sdpTelemetryFormat(e,t)},this.setAnsweredModalities=(e,t)=>{this.answeredModalities=this.sdpTelemetryFormat(e,t)},this.setIsSdpInCallNotification=e=>{this.isSdpInCallNotification=e},this.addVbssOperations=e=>{e&&(e===hc.VBSS_OPERATION.START?this.vbssStarted=!0:this.vbssStarted=!1,this.vbssOperations.push(this.recordOperation(e)))},this.addNetworkOperationStarted=e=>{Ss(this.networkRequestsStarted,e,this.recordOperation(e))},this.addNetworkOperationCompleted=(e,t,i)=>{const n=t?hc.RESULT_VALUE.SUCCESS:hc.RESULT_VALUE.FAILURE,r=i?`${e}:${n}:${i}`:`${e}:${n}`;this.networkRequestsCompleted.push(this.recordOperation(r)),vs(this.networkRequestsStarted,e)},this.updateNetworkRequest=e=>{this.networkRequests[e.uid]?Nh.assign(this.networkRequests[e.uid],e):this.networkRequests[e.uid]=e},this.deleteNetworkRequest=e=>{delete this.networkRequests[e.uid]},this.addContentSharingOperation=(e,t,i)=>{this.contentSharingOperationsPerformed[e]||(this.contentSharingOperationsPerformed[e]=[]);const n={[t]:this.timeSinceCallStart()};this.contentSharingOperationsPerformed[e].push(n);const r=this.contentSharingOperationsPerformed[e].length-1;return i&&this.updateContentSharingOperation(e,r,i),r},this.updateContentSharingOperation=(e,t,i)=>{if(!this.contentSharingOperationsPerformed[e])return;const n=this.contentSharingOperationsPerformed[e][t],r=[];for(const e of Object.keys(i))r.push(`${e}: ${i[e]}`);n.data=r.join(", ")},this.setDirection=e=>{this.telemetryData[hc.EXTENSIONS.DIRECTION]=e},this.setEndPointId=e=>{this.telemetryData[hc.CONTEXT_ID.ENDPOINT_ID]=e,this.contentSharingBaseTelemetryData[hc.CONTEXT_ID.ENDPOINT_ID]=e,this.httpRequestTelemetryData[hc.CONTEXT_ID.ENDPOINT_ID]=e},this.setParticipantId=e=>{this.telemetryData[hc.CONTEXT_ID.PARTICIPANT_ID]=e,this.contentSharingBaseTelemetryData[hc.CONTEXT_ID.PARTICIPANT_ID]=e,this.httpRequestTelemetryData[hc.CONTEXT_ID.PARTICIPANT_ID]=e},this.addTokenTelemetry=(e,t)=>{e?this.networkRequests?.[e]?(this.networkRequests[e].tokenTelemetries||(this.networkRequests[e].tokenTelemetries=[]),this.networkRequests[e].tokenTelemetries.push(t)):this.logger.info(`[addTokenTelemtry] httprequest: ${e} is not found in networkRequests`):this.logger.error("[addTokenTelemetry] httprequest uid is undefined")},this.setConversationServiceUrl=e=>{this.telemetryData[hc.EXTENSIONS.CONVERSATION_SERVICE_URL]=e},this.setMeetingInfo=e=>{e||(this.telemetryData[hc.EXTENSIONS.MEETING_INFO]=e)},this.setJoinedFrom=e=>{this.telemetryData[hc.EXTENSIONS.JOINED_FROM]=e},this.setMeetingCode=e=>{this.telemetryData[hc.EXTENSIONS.MEETING_CODE]=e},this.setMeetingUrl=e=>{this.telemetryData[hc.EXTENSIONS.MEETING_URL]=e},this.setBroadcastMeetingRole=e=>{this.telemetryData[hc.EXTENSIONS.BROADCAST_MEETING_ROLE]=e},this.setMeetingRole=e=>{this.telemetryData[hc.EXTENSIONS.MEETING_ROLE]=e},this.setAdvancedMeetingRole=e=>{this.telemetryData[hc.EXTENSIONS.ADVANCED_MEETING_ROLE]=e},this.setParticipantType=e=>{this.telemetryData[hc.EXTENSIONS.PARTICIPANT_TYPE]=e},this.setSelfParticipantRole=e=>{this.telemetryData[hc.EXTENSIONS.SELF_PARTICIPANT_ROLE]=e},this.setAudioOnlyWatermark=e=>{this.telemetryData[hc.EXTENSIONS.AUDIO_ONLY_WATERMARK]=e},this.setWatermarkSupport=e=>{this.telemetryData[hc.EXTENSIONS.CLIENT_SUPPORT_WATERMARK]=e},this.setScenario=e=>{this.telemetryData[hc.EXTENSIONS.SCENARIO]=e},this.setTargetApplicationType=e=>{e&&(this.telemetryData[hc.EXTENSIONS.TARGET_APPLICATION_TYPE]=e)},this.setCallerType=e=>{e&&(this.telemetryData[hc.EXTENSIONS.CALLER_TYPE]=e.split(":",1)[0])},this.setCalleeType=e=>{e&&(this.telemetryData[hc.EXTENSIONS.CALLEE_TYPE]=e.split(":",1)[0])},this.setTerminatingData=e=>{this.telemetryData[hc.EXTENSIONS.CALL_TERMINATING_END]=e.terminatingEnd,this.telemetryData[hc.EXTENSIONS.CALL_END_CODE]=e.endCode||Zr.CALL_END_CODE.SUCCESS,this.telemetryData[hc.EXTENSIONS.CALL_END_SUB_CODE]=e.endSubCode||Zr.CALL_END_SUB_CODE.SUCCESS,this.telemetryData[hc.EXTENSIONS.CALL_PHRASE]=e.phrase||Zr.CALL_END_PHRASE.UNKNOWN,this.telemetryData[hc.EXTENSIONS.RESULT_VALUE]=e.resultValue||hc.RESULT_VALUE.SUCCESS,this.telemetryData[hc.EXTENSIONS.RESULT_DETAIL]=e.resultDetail||"Call gracefully hungup",this.telemetryData[hc.EXTENSIONS.RESULT_CAUSE_ID]=e.causeId||"unknown",this.telemetryData[hc.EXTENSIONS.CALL_END_RESULT_CATEGORIES]=e.resultCategories||[],this.telemetryData[hc.EXTENSIONS.CALL_END_CLIENT_SUB_CODE]=e.clientReasonSubCode,this.telemetryData[hc.EXTENSIONS.CALL_END_CLIENT_PHRASE]=e.clientReasonPhrase},this.startCallInitializationWatch=e=>{this.timeToRingStopWatch=Vc(),e&&(this.timeToRingStopWatch.msElapsed+=e)},this.startCallConnectedWatch=()=>{this.connectedStopWatch=Vc()},this.setIsPreheated=()=>{this.isPreheated=1},this.startPreheatedCallSetupDurationWatch=()=>{this.preheatedCallSetupDurationWatch=Vc()},this.stopPreheatedCallSetupDurationWatch=()=>{this.preheatedCallSetupDurationWatch.pause()},this.startCallCancelationDurationWatch=()=>{this.callCancelationDurationWatch=Vc()},this.stopCallCancelationDurationWatch=()=>{this.callCancelationDurationWatch&&this.callCancelationDurationWatch.pause()},this.getCallCancelationDuration=()=>this.callCancelationDurationWatch?this.callCancelationDurationWatch.durationInSeconds():0,this.resetCallCancelationDurationWatch=()=>{this.callCancelationDurationWatch=null},this.setOfferAnswerGenerationTimestamps=e=>{this.localOfferAnswerGenerationTimestamps.push(this.recordOperation(e))},this.setTimeToRingDuration=()=>{this.timeToRingStopWatch&&(this.telemetryData[hc.EXTENSIONS.TIME_TO_RING_IN_MS]=this.timeToRingStopWatch.duration(),this.timeToRingStopWatch=null)},this.dispose=()=>{this.sendCallModalityTelemetryData()},this.setMessagingChannel=e=>{this.telemetryData[hc.EXTENSIONS.MESSAGING_CHANNEL]||(this.telemetryData[hc.EXTENSIONS.MESSAGING_CHANNEL]=[]),this.telemetryData[hc.EXTENSIONS.MESSAGING_CHANNEL].some((t=>-1!==t.indexOf(e)))||this.telemetryData[hc.EXTENSIONS.MESSAGING_CHANNEL].push(this.recordOperation(e))},this.sendHttpTelemetryData=e=>{const t={...this.httpRequestTelemetryData};t[hc.CONTEXT_ID.CORRELATION_ID]=this.signalingSession.correlationId,t[hc.CONTEXT_ID.SIGNALING_SESSION_ID]=this.signalingSession.sessionId,t[hc.EXTENSIONS.CLIENT_INFORMATION]=this.signalingSession.signalingAgentConfig.clientInformation;const i=JSON.stringify({eventStart:this.callStartTime,events:this.networkRequests[e]});vs(this.networkRequests,e),t[hc.EXTENSIONS.NETWORK_REQUESTS_BAG]=i,this.telemetryLogger.logHttpTelemetryEvent(t)},this.sdpTelemetryFormat=(e,t)=>{if(!e)return"";const i=e=>{switch(e){case"main-audio":return"Audio";case"main-video":return"Video";case"applicationsharing-video":return"AppSharing";default:return}},n=e=>{switch(e){case"inactive":return"Inactive";case"sendonly":return t?"ReceiveFromPeer":"SendToPeer";case"recvonly":return t?"SendToPeer":"ReceiveFromPeer";default:return"Bidirectional"}},r={"main-audio":0,"main-video":0,"applicationsharing-video":0},s=[],a=Lh.parse(e);for(const e of a.media){const t=i(e.label);if(!t)continue;const a=r[e.label]++,o=n(e.direction);s.push(`${t}[${a}] = ${o}`)}return s.join(", ")},this.setReinviteless=e=>{this.isReinviteless=e?1:0},this.logger=e.logger,this.telemetryLogger=function(e,t){return new xh(e,t)}(e,this.logger),this.telemetryData[hc.EXTENSIONS.CALL_START_TIME]=this.callStartTime,this.telemetryData[hc.EXTENSIONS.CONVERSATION_SERVICE_URL]=e.signalingAgentConfig.conversationServiceUrl,this.fillCommonData(t,this.telemetryData),this.fillCommonData(t,this.httpRequestTelemetryData),this.fillCommonData(t,this.contentSharingBaseTelemetryData)}fillCommonData(e,t){t[hc.EXTENSIONS.APPLICATION_TYPE]=e.applicationType,t[hc.EXTENSIONS.RING]=e.ring,t[hc.EXTENSIONS.TENANT_ID]=e.tenantId,t[hc.EXTENSIONS.USER_HEX_CID]=e.userHexCID,t[hc.EXTENSIONS.ACS_RESOURCE_ID]=e.acsResourceId,t[hc.EXTENSIONS.REGION]=e.region,t[hc.EXTENSIONS.PARTITION]=e.partition,t[hc.EXTENSIONS.CLIENT_TYPE]=e.clientType}addChangingCorrelationId(e,t){this.telemetryData[hc.EXTENSIONS.CHANGING_CORRELATION_ID_OLD_ID]=e,this.telemetryData[hc.EXTENSIONS.CHANGING_CORRELATION_ID_NEW_ID]=t}addSharedCorrelationId(e){this.telemetryData[hc.CONTEXT_ID.SHARED_CORRELATION_ID]=e}sendContentSharingTelemetryData(e,t,i,n,r,s){const a={...this.contentSharingBaseTelemetryData},o=this.contentSharingOperationsPerformed[e];o&&(a[hc.EXTENSIONS.EVENT_TIMESTAMP_BAG]=JSON.stringify(o)),a[hc.CONTEXT_ID.CONTENT_SHARING_CORRELATION_ID]=e,a[hc.CONTEXT_ID.SIGNALING_SESSION_ID]=t,a[hc.CONTEXT_ID.CONTENT_SHARING_ID]=s||"",a[hc.EXTENSIONS.CONTENT_SHARING_SERVICE_URL]=r,a[hc.EXTENSIONS.CONTENT_SHARING_DIRECTION]=i?hc.DIRECTION.OUTGOING:hc.DIRECTION.INCOMING,a[hc.EXTENSIONS.CALL_END_CODE]=n.code,a[hc.EXTENSIONS.CALL_END_SUB_CODE]=n.subCode,a[hc.EXTENSIONS.CALL_PHRASE]=n.phrase,a[hc.EXTENSIONS.CALL_END_RESULT_CATEGORIES]=this.getResultCategoryString(n.resultCategories),a[hc.EXTENSIONS.CALL_END_CAUSE_ID]=n.causeId,a[hc.EXTENSIONS.CLIENT_INFORMATION]=this.signalingSession.signalingAgentConfig.clientInformation,delete this.contentSharingOperationsPerformed[e],this.telemetryLogger.logConversationContentSharingEvent(a)}recordOperation(e){return`${e}:${this.timeSinceCallStart()}`}timeSinceCallStart(){return(new Date).getTime()-this.callStartTime}sendCallModalityTelemetryData(){this.vbssStarted&&this.addVbssOperations(hc.VBSS_OPERATION.CALL_END);const e=e=>"number"==typeof e?e/1e3:0;if(this.telemetryData[hc.EXTENSIONS.CLIENT_INFORMATION]=this.signalingSession.signalingAgentConfig.clientInformation,this.telemetryData[hc.EXTENSIONS.CALL_END_TIME]=(new Date).getTime(),this.connectedStopWatch&&(this.telemetryData[hc.EXTENSIONS.CONNECTED_DURATION_IN_MS]=this.connectedStopWatch.duration()),this.telemetryData[hc.EXTENSIONS.IS_PREHEATED]=this.isPreheated,this.preheatedCallSetupDurationWatch&&(this.telemetryData[hc.EXTENSIONS.PREHEATED_CALL_SETUP_DURATION_IN_S]=e(this.preheatedCallSetupDurationWatch.duration())),this.callCancelationDurationWatch&&(this.telemetryData[hc.EXTENSIONS.CALL_CANCELATION_DURATION_IN_S]=e(this.callCancelationDurationWatch.duration())),this.networkRequestsCompleted.length&&(this.telemetryData[hc.EXTENSIONS.NETWORK_REQUESTS_COMPLETED]=JSON.stringify(this.networkRequestsCompleted)),this.localOperationsPerformed.length&&(this.telemetryData[hc.EXTENSIONS.LOCAL_OPERATIONS_PERFORMED]=JSON.stringify(this.localOperationsPerformed)),this.trouterWaitOperations.length&&(this.telemetryData[hc.EXTENSIONS.TROUTER_WAIT_OPERATIONS]=JSON.stringify(this.trouterWaitOperations)),this.localOfferAnswerGenerationTimestamps.length&&(this.telemetryData[hc.EXTENSIONS.LOCAL_OFFER_ANSWER_GENERATION_TIMESTAMPS]=JSON.stringify(this.localOfferAnswerGenerationTimestamps)),this.incomingModalities.length&&(this.telemetryData[hc.EXTENSIONS.INCOMING_MODALITIES]=JSON.stringify(this.incomingModalities)),this.outgoingModalities.length&&(this.telemetryData[hc.EXTENSIONS.OUTGOING_MODALITIES]=JSON.stringify(this.outgoingModalities)),this.offeredModalities.length&&(this.telemetryData[hc.EXTENSIONS.OFFERED_MODALITIES]=this.offeredModalities),this.answeredModalities.length&&(this.telemetryData[hc.EXTENSIONS.ANSWERED_MODALITIES]=this.answeredModalities),this.telemetryData[hc.EXTENSIONS.CALL_END_RESULT_CATEGORIES]=this.getResultCategoryString(this.telemetryData[hc.EXTENSIONS.CALL_END_RESULT_CATEGORIES]),this.telemetryData[hc.EXTENSIONS.IS_SDP_IN_CALL_NOTIFICATION]=this.isSdpInCallNotification.toString(),this.vbssOperations.length&&(this.telemetryData[hc.EXTENSIONS.VBSS_OPERATIONS]=JSON.stringify(this.vbssOperations)),this.recordedEvents.length){const e=JSON.stringify({eventStart:this.callStartTime,events:this.recordedEvents});this.telemetryData[hc.EXTENSIONS.EVENT_TIMESTAMP_BAG]=e}if(this.rosterUpdates.length){const e=JSON.stringify({eventStart:this.callStartTime,events:this.rosterUpdates});this.telemetryData[hc.EXTENSIONS.ROSTER_UPDATES_BAG]=e}const t=[];for(const e of Object.keys(this.networkRequestsStarted))t.push(this.networkRequestsStarted[e]);t.length>0&&(this.telemetryData[hc.EXTENSIONS.NETWORK_REQUESTS_PENDING]=JSON.stringify(t)),this.telemetryData[hc.EXTENSIONS.IS_REINVITELESS]=this.isReinviteless,this.telemetryLogger.logConversationCallModalityEvent(this.telemetryData)}getResultCategoryString(e){return e&&Array.isArray(e)?e.join(","):""}},Uh=class{constructor(e,t){this.disposed=!1,this.lastSeenSeqNumbers={},this.isDominantSpeakerInfoLinkEnabled=!0,this.clientUrlsGenerated=!1,this.getClientUrls=()=>{this.clientUrlsGenerated=!0;let e=null;return this.isWebRtcCall&&(e={controlVideoStreaming:is(this.signalingSession,Dr.CONTROL_VIDEO_STREAMING),csrcInfo:is(this.signalingSession,Dr.CSRC_INFO)},this.isDominantSpeakerInfoLinkEnabled&&(e.dominantSpeakerInfo=is(this.signalingSession,Dr.DOMINANT_SPEAKER_INFO))),e},this.handleDominantSpeakerInfo=e=>{const t=e.body;this.logger.debug("handleDominantSpeakerInfo : ",Ve(t)),this.signalingSession.telemetryHelper.recordIncomingEventCount(Ro),this.handleWebRtcNotification(Zr.WEBRTC_NOTIFICATION_TYPE.DOMINANT_SPEAKER_INFO,t.dominantSpeakerInformation)},this.handleControlVideoStreaming=e=>{const t=e.body;this.logger.debug("handleControlVideoStreaming: ",Ve(t)),this.signalingSession.telemetryHelper.recordIncomingEvent(Ao,e),this.handleWebRtcNotification(Zr.WEBRTC_NOTIFICATION_TYPE.CONTROL_VIDEO_STREAMING,t.controlVideoStreaming,!1)},this.handleCsrcInfo=e=>{const t=e.body;this.logger.debug("handleCsrcInfo : ",Ve(t)),this.signalingSession.telemetryHelper.recordIncomingEvent(wo,e),this.handleWebRtcNotification(Zr.WEBRTC_NOTIFICATION_TYPE.CSRC_INFO,t.csrcInfo)},this.sendWebRtcMediaNotificationAsync=({operation:e,requestUrl:t,requestBody:i,stackRetry:n=!0},r)=>{this.logger.info("sendWebRtcMediaNotificationAsync"),ds(this.isWebRtcCall,"this is not a webrtc call"),cs(t,"correct media notification requestUrl is not provided"),cs(i,"media notification requestBody cannot be null or empty");const s=As(),a={url:t,payload:{payload:i},requestName:e,withoutTrouter:!0,causeId:r};return n||(a.disableRetry=!0),this.signalingSession.http.sendPostRequest(a).then((()=>{this.disposed||s.resolve()})).catch((e=>{const t=Ve(e);if(this.logger.error(`sendWebRtcMediaNotificationAsync failed because : ${t}`),!this.disposed){const t=new Error(e);t.endCode=Zr.CALL_END_NETWORK_ERROR,s.reject(t)}})),s.promise},this.dispose=()=>{this.logger.info("WebRtcSignalingManager :: dispose"),this.disposed=!0},this.signalingSession=e,this.signalingSessionCallback=t,this.isWebRtcCall=e.signalingAgentConfig.isWebRtcEnabled,this.logger=e.logger,this.lastSeenSeqNumbers[Zr.WEBRTC_NOTIFICATION_TYPE.CONTROL_VIDEO_STREAMING]=-1,this.lastSeenSeqNumbers[Zr.WEBRTC_NOTIFICATION_TYPE.DOMINANT_SPEAKER_INFO]=-1,this.lastSeenSeqNumbers[Zr.WEBRTC_NOTIFICATION_TYPE.CSRC_INFO]=-1}areClientURLsGenerated(){return this.clientUrlsGenerated}getIsDominantSpeakerInfoLinkEnabled(){return this.isDominantSpeakerInfoLinkEnabled}setIsDominantSpeakerInfoLinkEnabled(e){this.isDominantSpeakerInfoLinkEnabled=e}handleWebRtcNotification(e,t,i=!0){ds(this.isWebRtcCall,"ignoring message in non-webrtc call");const n=this.lastSeenSeqNumbers[e];i&&t.sequenceNumber<=n?this.logger.info(`ignoring ${e} . Last seen seq = ${n} current seq = ${t.sequenceNumber}`):(t.sequenceNumber<=n&&this.logger.info(`let listener to handle older ${e} . Last seen seq = ${n} current seq = ${t.sequenceNumber}`),this.lastSeenSeqNumbers[e]=Math.max(t.sequenceNumber,this.lastSeenSeqNumbers[e]),this.signalingSessionCallback.onWebRtcMediaNotification(e,t))}},Vh=class{constructor(e,t,i,n,r,s){this.disposed=!1,this.convSubject=null,this.groupId=null,this.threadId=null,this.incomingCallCallerId=null,this.incomingCallPayload=null,this.multiParty=!0,this.isIncomingCall=!1,this.isHostLessCall=!1,this.isCastCall=!1,this.isHuddleGroupCall=!1,this.numberOfOriginalInvitees=0,this.teamsMessageId=null,this.enableGroupCallMeetupGeneration=!1,this.meetingInfo=null,this.meetingDetails=null,this.emergencyContent=null,this.transferContext=null,this.callType="default",this.callMode=0,this.transferor=null,this.onBehalfOf=null,this.onBehalfOfUserDisplayName=null,this.callQueueContext=null,this.callPhoneLineType=null,this.endpointMetadata={},this.sessionId=ls(),this.remoteCaller=null,this.acceptedElsewhereBy=null,this.parkAdditionalContextJson=null,this.serverHoldLocation=null,this.breakoutDetails=null,this.callLimits=null,this.complianceRecordingContent=null,this.backroomThreadId=null,this.realTimeState=0,this.disposing=!1,this.links={},this.provisionalMediaAnswersSeenSoFar=[],this.incomingTrouterMessagesSeenSoFar=[],this.incomingBrokerMessagesSeenSoFar=[],this.currentCallStatus=null,this.fsmState=Zr.SIGNALING_FSM_STATE.IDLE,this.convJoined=!1,this.keepAliveTimer=null,this.keepAliveInterval=null,this.keepAliveCount=1,this.conversationKeepAliveTimer=null,this.conversationKeepAliveInterval=null,this.conversationKeepAliveCount=1,this.remoteUser=null,this.mediaTypesToUse=null,this.lastUsedOutgoingMediaContent=null,this.lastUsedJoinCallOptions=null,this.originalRoleBeforePreheat="",this.endpointStateSequenceNumber=0,this.publishStateSequenceNumber=0,this.requestedPublishedStatesWhileConnecting=null,this.linkUpdateRequested={conversationLinks:!1,keepAliveLinks:!1},this.incomingMessageSyncResponseCache={},this.isPreheatOnly=!1,this.callStartTime=(new Date).getTime(),this.callUsesMixer=!1,this.disablePreheatDefer=As(),this.participantReplacementDetails={},this.meetingLiveStateSequenceNumber=0,this.meetingLayoutSequenceNumber=0,this.localParticipantUpdateSequenceNumber=0,this.isRedirectAllowed=!1,this.updateSequenceNumber=-1,this.isPromotingToRealtime=!1,this.streamInformationReceived=!1,this.startOrJoinConvResponseReceived=!1,this.updateParticipantsPromises={},this.updateEndpointState=(e,t=os(),i)=>{this.logger.info(`[${t}][requestedEndpointState=${Ve(e,!0)}]`);const n=this.links[Zr.LINKS.UPDATE_ENDPOINT_STATE],r=this.getEndpointState();this.logger.info(`[${t}][currentEndpointState=${Ve(r,!0)}] startOrJoinConvResponseReceived=${this.startOrJoinConvResponseReceived}`);const s={...r,...e,endpointStateSequenceNumber:++this.endpointStateSequenceNumber};this.telemetryHelper.recordEvent(Go,{newEndpointState:s,causeId:t});const a=e=>0===e?.endpointProperties?.preheatProperties;if(a(s)&&this.isPreheatOnly&&(this.telemetryHelper.recordEvent(Rl,{causeId:t}),this.telemetryHelper.startPreheatedCallSetupDurationWatch(),this.telemetryHelper.startCallCancelationDurationWatch()),2===this.callMode&&a(s))return this.logger.info(`[${t}][updateEndpointState skipped as mode is streaming]`),this.handleEndpointStateUpdated(t,!0),Promise.resolve();if(!this.startOrJoinConvResponseReceived)return this.logger.info(`[${t}][updateEndpointState will be queued as we don't have a link yet]`),this.requestedEndpointStateWhileConnecting=e,a(s)?(this.requestedPublishedStatesWhileConnecting=i,this.disablePreheatDefer.promise):Promise.resolve();if(!this.shouldUpdateEndpointState(r,s)&&!this.http.hasPendingRequest(cc.UPDATE_ENDPOINT_STATE.name))return this.logger.info(`[${t}][updateEndpointState will ignore current update as there is nothing new to send]`),Promise.resolve();if(!n)return this.logger.info(`[${t}][updateEndpointState operation cannot be performed now, the link is not yet available]`),Promise.reject("No link");this.latestEndpointState=s;const o=this.signalingAgentConfig.enableAsyncDisablePreheat&&a(s);o&&this.timeoutManager.startTimer(Zr.TIMEOUT_OPERATIONS.DISABLE_PREHEAT_ASYNC_TIMEOUT,(()=>{const e={code:Zr.CALL_END_CODE.TIMEOUT,subCode:Zr.CALL_END_SUB_CODE.DISABLE_PREHEAT_TIMEOUT,phrase:Zr.CALL_END_PHRASE.DISABLE_PREHEAT_TIMEOUT};this.disablePreheatDefer.isPending()&&this.disablePreheatDefer.reject({response:e})}),Zr.TIMEOUT_VALUES_IN_SECONDS.DISABLE_PREHEAT_TIMEOUT);const l=this.http.sendPostRequest({url:n,requestName:cc.UPDATE_ENDPOINT_STATE.name,payload:Mh(this,s,i,o),causeId:t}).then((()=>(o&&(this.logger.info(`[${t}][updateEndpointState] asyncDisablePreheat: true`),this.telemetryHelper.recordEvent(tc,{causeId:t})),Promise.resolve()))).catch((e=>{if(!o)throw e;this.disablePreheatDefer.reject(e)}));return(o?this.disablePreheatDefer.promise:l).then((()=>{this.logger.info(`[${t}][updateEndpointState] asyncDisablePreheat: ${o}`),this.telemetryHelper.recordEvent(o?Xd:Qd,{causeId:t}),this.disposed||this.handleEndpointStateUpdated(t,a(s))})).catch((e=>{const i=Cs(e,this.signalingAgentConfig);return this.logger.info(`[${t}][updateEndpointState] error: ${Ve(i)}`),a(s)&&(this.handleDisablePreheatError(i.error,o?ec:Zd,t),this.stopCallPreheatTimer(),this.terminateEstablishedCall({code:i.error.code,subCode:i.error.subCode,phrase:i.error.phrase},{forEveryone:!1,causeId:t})),Promise.reject(i.error)}))},this.setParticipantCallLinks=e=>{e&&e.endpointDetails&&(this.participantReplacementDetails[e.id]={},e.endpointDetails.forEach((t=>{t&&t.callLinks&&(this.participantReplacementDetails[e.id][t.participantId]=t.callLinks)})))},this.clearParticipantCallLinks=e=>{this.participantReplacementDetails?.hasOwnProperty(e)&&delete this.participantReplacementDetails[e]},this.getReplacementDetailsByParticipantLeg=(e,t,i=os())=>(this.logger.info(`[${i}]getReplacementDetailsByParticipantLeg: participantMri ${Fe(e)} participantLegId ${t}`),this.participantReplacementDetails?.hasOwnProperty(e)&&this.participantReplacementDetails[e].hasOwnProperty(t)?{replaces:this.participantReplacementDetails[e][t].replacement,replacementTargetParticipantId:t}:(this.logger.info(`[${i}]getReplacementDetailsByParticipantLeg: unable to find replacement details for participantLegId ${t}`),{})),this.getReplacementDetailsByParticipantLegOfCall=(e,t,i,n=os())=>{this.logger.info(`[${n}]getReplacementDetailsByParticipantLegOfCall: callId ${e} participantMri ${Fe(t)} participantLegId ${i}`);const r=this.signalingAgent.getSignalingSession(e);return r?r.getReplacementDetailsByParticipantLeg(t,i,n):{}},this.getMriByParticipantLegOfCall=(e,t,i)=>{this.logger.info(`[${i}]getMriByParticipantLegOfCall: callId: ${e} participantLegId ${t}`);const n=this.signalingAgent.getSignalingSession(e);return n?n.getMriByParticipantLeg(t,i):""},this.getMriByParticipantLeg=(e,t)=>{this.logger.info(`getMriByParticipantLeg[${t}] participantLegId ${e}`);for(const t of Object.keys(this.participantReplacementDetails))if(t&&this.participantReplacementDetails.hasOwnProperty(t)&&this.participantReplacementDetails[t]?.hasOwnProperty(e))return t;return""},this.handleEndpointStateUpdated=(e,t)=>{this.requestedEndpointStateWhileConnecting=null,this.requestedPublishedStatesWhileConnecting=null,t&&this.handlePreheatDisabled(e)},this.handlePreheatDisabled=e=>{this.isPreheatOnly=!1,this.telemetryHelper.setSelfParticipantRole(this.originalRoleBeforePreheat),this.telemetryHelper.recordEvent(wl,{causeId:e}),this.telemetryHelper.resetCallCancelationDurationWatch(),this.telemetryHelper.stopPreheatedCallSetupDurationWatch(),this.telemetryHelper.startCallConnectedWatch(),this.stopCallPreheatTimer(),this.disablePreheatDefer.isPending()&&this.disablePreheatDefer.resolve()},this.shouldUpdateEndpointState=(e,t)=>{if(!t)return!1;const i=t.state&&t.state.isMuted?1:0,n=t.endpointProperties&&1===t.endpointProperties.preheatProperties?1:0,r=e&&e.state&&e.state.isMuted?1:0,s=e&&e.endpointProperties&&1===e.endpointProperties.preheatProperties?1:0,a=e?.endpointProperties?.additionalEndpointProperties,o=t?.endpointProperties?.additionalEndpointProperties;return!!(i^r||n^s||o!==a)},this.setInitialTelemetry=(e,t)=>{let i,n;switch(e){case"Subscribe":this.telemetryHelper.recordEvent(Fa,{causeId:t.causeId,correlationId:t.correlationId}),this.telemetryHelper.setDirection(hc.DIRECTION.INCOMING),this.telemetryHelper.setSelfParticipantRole(hc.ROLE.JOIN_FOR_ROSTER_ONLY),this.telemetryHelper.setConversationServiceUrl(t.conversationServiceUrl||this.signalingAgentConfig.conversationServiceUrl),this.telemetryHelper.setCallerType(this.participantManager.localParticipant.id);break;case"Acknowledge":this.telemetryHelper.recordEvent(Ua,{causeId:t.causeId}),this.telemetryHelper.setDirection(hc.DIRECTION.INCOMING),this.telemetryHelper.setSelfParticipantRole(hc.ROLE.CALLEE),this.telemetryHelper.setCalleeType(this.participantManager.localParticipant.id);break;case"JoinCall":i=this.gatherTelemetryForStartOrJoin(t.joinCallOptions,t.causeId,t.offerGenerationTime),this.telemetryHelper.recordEvent(xa,i),this.telemetryHelper.setDirection(hc.DIRECTION.INCOMING),this.telemetryHelper.setSelfParticipantRole(hc.ROLE.JOIN);break;case"StartCall":case"StartCallToVoiceMail":case"StartCallWithNudge":case"StartCallAndUnpark":n=this.gatherTelemetryForStartOrJoin(t.callStartOptions,t.causeId,t.offerGenerationTime),this.telemetryHelper.recordEvent(La,n),this.telemetryHelper.setDirection(hc.DIRECTION.OUTGOING),this.telemetryHelper.setSelfParticipantRole(hc.ROLE.CALLER),this.telemetryHelper.startCallInitializationWatch(t.offerGenerationTime),this.telemetryHelper.setMeetingInfo(this.getMeetingInfo())}},this.getParticipantIdForOfferAnswer=e=>{hs(e,"mediaContent should be a non null value"),this.logger.info("getParticipantIdForOfferAnswer");let t=null;return!this.remoteUser||this.groupId||this.threadId||e.newOffer||e.escalationOccurring||(t=this.remoteUser.id),t},this.getMeetingInfo=()=>this.meetingInfo,this.getEmergencyContent=()=>(this.telemetryHelper.recordEvent(wa),this.emergencyContent),this.getEndpointId=()=>this.signalingAgent.endpointId,this.getConversationUrl=()=>this.links[Zr.LINKS.CONVERSATION_CONTROLLER],this.setJoinedFrom=e=>{!this.disposed&&e&&(this.telemetryHelper.recordEvent(Aa),this.telemetryHelper.setJoinedFrom(e))},this.setMeetingCode=e=>{!this.disposed&&e&&this.telemetryHelper.setMeetingCode(e)},this.setMeetingUrl=e=>{!this.disposed&&e&&this.telemetryHelper.setMeetingUrl(e)},this.setSubject=e=>{this.disposed||(this.telemetryHelper.recordEvent(Ia),hs(e,"subject should be a non null value"),this.convSubject=e)},this.setDeviceType=e=>{this.disposed||(this.telemetryHelper.recordEvent(Ra),e&&(this.deviceType=e,this.logger.info("setDeviceType",this.deviceType)))},this.setOfferAnswerGenerationTimestamps=e=>{this.disposed||this.telemetryHelper.setOfferAnswerGenerationTimestamps(e)},this.setTimeToRingDuration=()=>{this.disposed||this.telemetryHelper.setTimeToRingDuration()},this.setGroupId=e=>{this.telemetryHelper.recordEvent(Oa),this.groupId!==e&&e&&(ds(!this.groupId,"conversation groupId has already been set. It cannot be overwritten"),this.groupId=e)},this.setThreadId=e=>{this.telemetryHelper.recordEvent(Da),hs(e,"threadId should be a non null value"),this.threadId!==e&&(ds(!this.threadId,"conversation threadId has already been set. It cannot be overwritten"),this.threadId=e)},this.setCallOptions=e=>{if(hs(e,"callOptions should be a non null value"),this.logger.info("setCallOptions",Ve(e)),this.telemetryHelper.recordEvent(ka),e){this.teamsMessageId=e.teamsMessageId,this.meetingInfo=e.meetingInfo||null,this.emergencyContent=e.emergencyContent||null,this.enableGroupCallMeetupGeneration=e.enableGroupCallMeetupGeneration||!1,e.broadcastContext&&(this.broadcastSession=new Mc(this,this.signalingSessionCallback),this.broadcastSession.setContext(e.broadcastContext));try{this.endpointMetadata=JSON.parse(e.endpointMetadata)}catch(e){this.logger.warn("Unable to parse endpoint metadata")}}},this.setTransferContext=e=>{hs(e,"transferContext should not be null"),this.logger.info("Transfer: setTransferContext",e),this.telemetryHelper.recordEvent(Na),this.transferContext=e},this.muteAsync=(e,t,i=os())=>(ds(2!==this.callMode||e!==Zr.MUTE_SCOPE.MYSELF,"mute self operation is not allowed in streaming mode"),this.logger.info(`[${i}][muteAsync][scope=${e}]`),this.telemetryHelper.recordEvent(Co,{causeId:i}),ds(this.fsmState===Zr.SIGNALING_FSM_STATE.CONNECTED,`[${i}]mute operation for all or specified only allowed in a connected call`),this.participantManager.muteAsync(this.links[Zr.LINKS.MUTE],e,t,i)),this.unmuteAsync=(e=os())=>(ds(2!==this.callMode,"unmute operation is not allowed in streaming mode"),this.logger.info(`[${e}][unmuteAsync]`),this.telemetryHelper.recordEvent(Eo,{causeId:e}),ds(this.fsmState===Zr.SIGNALING_FSM_STATE.CONNECTED,"unmute operation only allowed in a connected call"),this.participantManager.unmuteAsync(this.links[Zr.LINKS.UNMUTE],e)),this.recordTelemetryForStartAudio=(e,t)=>(this.telemetryHelper.recordEvent(bl,{mediaNegotiationStatus:e,causeId:t}),Promise.resolve(null)),this.recordTelemetryForStopAudio=(e,t)=>(this.telemetryHelper.recordEvent(Pl,{mediaNegotiationStatus:e,causeId:t}),Promise.resolve(null)),this.rejectUnmuteRequestAsync=(e,t=os(),i)=>(ds(this.fsmState===Zr.SIGNALING_FSM_STATE.CONNECTED,"rejectUnmute operation only allowed in a connected call"),cs(e,"requestor must be specified"),this.logger.info(`[${t}][rejectUnmuteRequestAsync][rejectionReason=${i}]`),this.telemetryHelper.recordEvent(Io,{causeId:t,rejectionReason:i}),this.participantManager.rejectUnmuteRequestAsync(e,t,i)),this.approveUnmuteRequestAsync=(e,t=os())=>(ds(this.fsmState===Zr.SIGNALING_FSM_STATE.CONNECTED,"approveUnmute operation only allowed in a connected call"),cs(e,"requestor must be specified"),this.logger.info(`[${t}][approveUnmuteRequestAsync]`),this.telemetryHelper.recordEvent(Po,{causeId:t}),this.participantManager.approveUnmuteRequestAsync(e,t)),this.sendWebRtcMediaNotificationAsync=(e,t,i=os())=>(ds(2!==this.callMode,"sendWebRtcMediaNotification operation is not allowed in streaming mode"),ds(this.fsmState===Zr.SIGNALING_FSM_STATE.CONNECTED,"webRtc media notification can only be sent in a connected call"),this.telemetryHelper.recordEvent(Mo,{causeId:i}),0===e?this.webRtcSignalingManager.sendWebRtcMediaNotificationAsync({operation:cc.SEND_APPLY_CHANNEL_PARAMETERS.name,requestUrl:this.links[Zr.LINKS.APPLY_CHANNEL_PARAMETERS],requestBody:t,stackRetry:!1},i):this.webRtcSignalingManager.sendWebRtcMediaNotificationAsync({operation:cc.SEND_CONTROL_VIDEO_STREAMING.name,requestUrl:this.links[Zr.LINKS.CONTROL_VIDEO_STREAMING],requestBody:t},i)),this.addParticipantsAsync=(e,t,i=os())=>{cs(e,"remoteParticipants should be a non null value"),ds(this.isCallOngoing()||this.isCallIdleOrRosterOnly(),"remoteParticipants can only be added before starting an outgoing call or to an ongoing call"),this.logger.info(`[${i}][addParticipantsAsync][addParticipantOptions=${Ve(t)}]\n            [remoteParticipantId=${e.map((e=>this.piiUtils.scrubMriOrOmit(e.id)))}]`);let n=Xs;switch(t.replacementType){case 2:n=jl;break;case 1:case 3:n=ea;break;default:n=Xs}this.telemetryHelper.recordEvent(n,{causeId:i}),t.groupId=this.groupId||t.groupId,t.threadId=this.threadId||t.threadId;const r=t.threadId||t.groupId?this.links[Zr.LINKS.ADD_PARTICIPANTS_AND_MODALITY]:this.links[Zr.LINKS.ADD_PARTICIPANT],s=this.participantManager.addParticipantsAsync(e,r,this.isCallConnectedOrConnectedForRoster(),t,i);return this.currentCallStatus||this.setMultiParty(1!==this.participantManager.getParticipantsToInitiateCallWith().length,i),s},this.addGroupModalityAsync=(e,t)=>{ds(this.isCallOngoing(),"GroupModality can only be added before starting an outgoing call or to an ongoing call"),this.logger.info(`[${t}][addGroupModalityAsync][addGroupModalityOptions=${Ve(e)}]`);const i=ia;this.telemetryHelper.recordEvent(i,{causeId:t});const n=ih(this,null,e);return this.http.sendPostRequest({url:this.links[Zr.LINKS.ADD_PARTICIPANTS_AND_MODALITY],payload:n,requestName:cc.ADD_PARTICIPANTS_AND_MODALITY.name,causeId:t}).then((()=>{yc.noop()})).catch((e=>{const i=Cs(e,this.signalingAgentConfig);throw this.logger.info(`[${t}][sendNetworkRequestForAddingParticipant] failed:${Ve(i)}`),i.error}))},this.addBroadcastModalityAsync=(e,t)=>{if(ds(this.isCallOngoing(),"BroadcastModality can only be added before starting an outgoing call or to an ongoing call"),this.logger.info(`[${t}][addBroadcastModalityAsync][addBroadcastContext=${Ve(this.addBroadcastModalityAsync)}]`),this.telemetryHelper.recordEvent(So,{causeId:t}),this.broadcastSession){const e="There is already a broadcast session";return this.logger.info(e),Promise.resolve(Zr.SUCCESS_TRANSACTION_END)}this.broadcastSession=new Mc(this,this.signalingSessionCallback),this.broadcastSession.setContext(e);const i=(r=e,hs(n=this,"signalingSession cannot be null"),hs(r,"broadcastContext cannot be null"),{payload:{participants:{from:{id:n.participantManager.localParticipant.id,displayName:n.participantManager.localParticipant.displayName,endpointId:n.participantManager.localParticipant.endpointId,participantId:n.participantManager.localParticipant.participantId,languageId:n.participantManager.localParticipant.languageId}},broadcast:r,links:{addModalitySuccess:is(n,Dr.CONV_ADD_MODALITY_SUCCESS),addModalityFailure:is(n,Dr.CONV_ADD_MODALITY_FAILURE)}}});var n,r;return this.http.sendPostRequest({url:this.links[Zr.LINKS.ADD_MODALITY],payload:i,requestName:cc.ADD_BROADCAST_MODALITY.name,causeId:t}).then((e=>(this.logger.info(`[${t}][addBroadcastModalityAsync] response: ${Ve(e)}`),this.telemetryHelper.recordEvent(yo,{causeId:t}),Zr.SUCCESS_TRANSACTION_END))).catch((e=>{const i=Cs(e);return this.logger.info(`[${t}][sendNetworkRequestForAddBroadcastModalityAsync] failed:${Ve(i)}`),this.endBroadcastMeeting(t),Promise.reject(i.error)}))},this.nudgeParticipantsAsync=e=>{if(hs(e.participantsIds,"ParticipantsIds should be a non null value"),ds(this.isCallOngoing(),"Participants can only be nudged before starting an outgoing call or to an ongoing call"),this.logger.info(`[${e.causeId}][nudgeParticipantsAsync][participantsIds=${this.piiUtils.scrubParticipantsList(e.participantsIds)}][invitationData=${e.invitationData}]`),void 0===e.participantsIds||e.participantsIds.length<1)return Promise.reject("List of participants to nudge is empty");this.telemetryHelper.recordEvent(Xs,{withNudge:Zr.INVITATION_TYPE.NUDGE,causeId:e.causeId});const t=this.groupId||e.newGroupId,i=this.threadId||e.newThreadId,n=this.teamsMessageId||e.newMessageId,r=i||t?this.links[Zr.LINKS.ADD_PARTICIPANTS_AND_MODALITY]:this.links[Zr.LINKS.ADD_PARTICIPANT];return this.participantManager.nudgeParticipantsAsync(e.participantsIds,r,this.fsmState===Zr.SIGNALING_FSM_STATE.OUTGOING||this.fsmState===Zr.SIGNALING_FSM_STATE.CONNECTED,e.causeId,e.invitationData,t,i,n)},this.callMeBackAsync=(e,t=os())=>(hs(e,"remoteParticipant should be a non null value"),this.logger.info(`[${t}][callMeBackAsync][remoteParticipantId=${this.piiUtils.scrubMriOrOmit(e.id)}]`),this.telemetryHelper.recordEvent(da,{causeId:t}),this.hasGroupModality()||ds(!1,"threadId/groupId must be set before using call me back"),this.participantManager.callMeBackAsync(e,this.links[Zr.LINKS.ADD_PARTICIPANTS_AND_MODALITY],t)),this.removeParticipantAsync=(e,t=os(),i="none")=>{switch(hs(e,"remoteParticipant should be a non null value"),ds(this.fsmState===Zr.SIGNALING_FSM_STATE.CONNECTED,"participants can only be removed from an ongoing call"),this.logger.info(`[${t}][removeParticipantAsync][remoteParticipantId=${this.piiUtils.scrubMriOrOmit(e.id)}] [removeEndpointScope] ${i}`),i){case"all":this.telemetryHelper.recordEvent(ua,{causeId:t});break;case"specified":this.telemetryHelper.recordEvent(pa,{causeId:t});break;default:this.telemetryHelper.recordEvent(ha,{causeId:t})}return"none"!==i&&e.endpointId?this.participantManager.removeParticipantEndpointAsync(e,this.links[Zr.LINKS.REMOVE_PARTICIPANT],i,t):this.participantManager.removeParticipantAsync(e,this.links[Zr.LINKS.REMOVE_PARTICIPANT],t)},this.admitParticipantAsync=(e,t=os())=>(hs(e,"remoteParticipant should be a non null value"),ds(this.fsmState===Zr.SIGNALING_FSM_STATE.CONNECTED,"remoteParticipants can only be admitted to an ongoing call"),this.hasGroupModality()||ds(!1,"threadId/groupId must be set before admitting more participants to connected call"),this.logger.info(`[${t}][admitParticipantAsync][remoteParticipantId=${this.piiUtils.scrubMriOrOmit(e.id)}]`),this.telemetryHelper.recordEvent(na,{causeId:t}),this.participantManager.admitParticipantAsync(e,this.links[Zr.LINKS.ADMIT],t)),this.admitAsync=e=>{if(this.logger.info(`[${e}][admitAsync]`),this.telemetryHelper.recordEvent(sa,{causeId:e}),!this.links[Zr.LINKS.ADMIT_ALL]){const t={code:Zr.CALL_END_CODE.REJECT,subCode:Zr.CALL_END_SUB_CODE.ADMIT_ALL_LINK_MISSING,phrase:Zr.CALL_END_PHRASE.ADMIT_ALL_URL_MISSING};return this.telemetryHelper.recordEvent(oa,{causeId:e,transactionEnd:t}),this.logger.warn(`admitAsync error ${JSON.stringify(t)}`),Promise.reject(t)}const t=As();return this.callOperationHandler.setPendingOperation(0,e,{promise:t,causeId:e},e),this.sendNetworkRequestForAdmit(e),t.promise},this.updateMeetingRolesAsync=(e,t,i=os())=>(hs(e,"participants array should be a non null value"),hs(t,"meetingRole should be a non null value"),ds(this.fsmState===Zr.SIGNALING_FSM_STATE.CONNECTED,"remote participant roles can only be updated in an ongoing call"),this.logger.info(`[${i}][updateMeetingRolesAsync][participants=${this.piiUtils.scrubMriOrOmit(e)}]`),this.participantManager.updateMeetingRolesAsync(e,t,this.links[Zr.LINKS.UPDATE_PARTICIPANT_ROLE],i)),this.startContentSharingAsync=(e,t,i,n,r=os())=>(hs(e,"contentIdentifier should be a non null value"),ds(this.isCallOngoing(),"contentSharing can only be added before starting an outgoing call or to an ongoing call"),this.logger.info(`[${r}][startContentSharingAsync]`),this.telemetryHelper.recordEvent(no,{causeId:r}),this.contentSharingManager.startContentSharingAsync(e,t,i,this.links[Zr.LINKS.ADD_MODALITY],this.fsmState===Zr.SIGNALING_FSM_STATE.CONNECTED,r,n)),this.deleteContentSharingAsync=(e,t=os())=>(this.logger.info(`[${t}][deleteContentSharingAsync][correlationId=${e}]`),this.telemetryHelper.recordEvent(so,{causeId:t,correlationId:e}),this.contentSharingManager.deleteContentSharingAsync(e,t)),this.joinContentSharingAsync=(e,t=os())=>(this.logger.info(`[${t}][joinContentSharingAsync][correlationId=${e}]`),this.telemetryHelper.recordEvent(lo,{causeId:t,correlationId:e}),this.contentSharingManager.joinContentSharingAsync(e,t)),this.updateContentSharingSessionStateAsync=(e,t,i=os())=>(hs(t,"sessionState should be a non null value"),this.telemetryHelper.recordEvent(oo,{causeId:i,correlationId:e}),this.logger.info(`[${i}][updateContentSharingSessionStateAsync][correlationId=${e}][sessionState=${t}]`),this.contentSharingManager.updateContentSharingSessionStateAsync(e,t,i)),this.takeContentSharingControlAsync=(e,t=os())=>(this.telemetryHelper.recordEvent(ao,{causeId:t,correlationId:e}),this.logger.info(`[${t}][takeContentSharingControlAsync][correlationId=${e}]`),this.contentSharingManager.takeContentSharingControlAsync(e,t)),this.updateContentSharingParticipantStateAsync=(e,t=os())=>(this.telemetryHelper.recordEvent(co,{causeId:t}),this.logger.info(`[${t}][updateContentSharingParticipantStateAsync][correlationId=${e}]`),this.contentSharingManager.updateContentSharingParticipantStateAsync(e,t)),this.configureEndpointStateForStartOrJoin=e=>{const t={endpointStateSequenceNumber:this.endpointStateSequenceNumber};let i=!1;if(e&&(e.muted&&(i=!0,Object.assign(t,{state:{isMuted:e.muted}})),e.isPreheatOnly||e.additionalEndpointProperties)){const n={};i=!0,e.isPreheatOnly&&(n.preheatProperties=1),e.additionalEndpointProperties&&(n.additionalEndpointProperties=e.additionalEndpointProperties),Object.assign(t,{endpointProperties:n})}if(i)return t},this.gatherTelemetryForStartOrJoin=(e,t,i)=>{const n={causeId:t};return e&&(e.invitationType===Zr.INVITATION_TYPE.NUDGE&&(n.withNudge=e.invitationType===Zr.INVITATION_TYPE.NUDGE),e.parkContext&&(n.unpark=!0,n.context=e.parkContext),e.isPreheatOnly&&(n.isPreheatOnly=!0),e.targetApplicationType&&(n.targetApplicationType=e.targetApplicationType,this.telemetryHelper.setTargetApplicationType(e.targetApplicationType))),n},this.startOutgoingCall=(e,t,i,n,r=os())=>{if(hs(e,"mediaContent should be a non null value"),hs(e.blob,"outgoingSdp should be a non null value"),ds(this.isCallIdleOrRosterOnly(),"a call is already in progress"),this.logger.info(`[${r}][startOutgoingCall][start] applicationType=${this.participantManager.localParticipant.applicationType}`),this.disposed)return void this.logger.warn(`[${r}][startOutgoingCall][failed][reason=Session disposed]`);this.lastUsedJoinCallOptions={muted:i?i.muted:null,scenario:i?i.scenario:null,isPreheatOnly:i?i.isPreheatOnly:null,clientEndpointCapabilities:i?i.clientEndpointCapabilities:null,clientEndpointDebugContent:i?i.clientEndpointDebugContent:null},this.originalRoleBeforePreheat=hc.ROLE.CALLER,i&&i.scenario&&this.telemetryHelper.setScenario(i.scenario),this.logger.info(`[${r}][startOutgoingCall]options=${Ve(this.gatherTelemetryForStartOrJoin(i,r,n))}`),this.isBrokerEnabledForOutgoingCall()&&this.setupBrokerChannel(),this.callUsesMixer=!(!i||!i.callUsesMixer),this.fsmState=Zr.SIGNALING_FSM_STATE.OUTGOING,this.meetingData=i?.meetingData,this.meetingPreferences=i?.meetingPreferences;const s={newCall:!0,suppressDialout:i&&i.suppressDialout||!1,conversationServiceUrl:this.signalingAgentConfig.conversationServiceUrl,onBehalfOf:i?i.onBehalfOf:null,onBehalfOfUserDisplayName:i?i.onBehalfOfUserDisplayName:null,callQueueContext:i?i.callQueueContext:null,callToVoicemail:!!i&&i.callToVoicemail,voicemailResourcePath:i?i.voicemailResourcePath:null,voicemailItemId:i?i.voicemailItemId:null,endpointState:this.configureEndpointStateForStartOrJoin(i),invitationType:i&&i.invitationType?i.invitationType:null,participantsToNudge:i&&Array.isArray(i.participantsToNudge)?i.participantsToNudge:null,routingFlags:i?i.routingFlags:null,parkContext:i?i.parkContext:null,pickupCode:i?i.pickupCode:null,scenario:i?i.scenario:null,isPreheatOnly:!!i&&i.isPreheatOnly,applicationType:this.participantManager.localParticipant.applicationType,clientEndpointCapabilities:i?i.clientEndpointCapabilities:0,clientEndpointDebugContent:i?i.clientEndpointDebugContent:null,invitationData:i?i.invitationData:null,conversationType:i?this.getConversationType(i.isEmergency,i.castCall,i.isHuddleGroupCall):null,meetingData:this.meetingData,meetingPreferences:this.meetingPreferences,alternateId:i?i.alternateId:null,meetingRegistrationId:i?i.meetingRegistrationId:null,participantPin:i?i.participantPin:null,publishedStates:i?i.publishedStates:null,targetApplicationType:i?i.targetApplicationType:null,captchaContentJson:i?i.captchaContentJson:null};this.isCastCall=i&&i.castCall,this.isHuddleGroupCall=i&&i.isHuddleGroupCall,this.onBehalfOf=s.onBehalfOf,this.onBehalfOfUserDisplayName=s.onBehalfOfUserDisplayName,this.callQueueContext=s.callQueueContext,this.startOrJoinCall(s,cc.START_CALL.name,r,e,t)},this.joinGivenConversation=(e,t,i,n,r,s={},a=os())=>{if(hs(t,"correlationId should be a non null value"),cs(e||this.getConversationUrl(),"conversationUrl should be a non null value"),hs(i,"mediaContent should be a non null value"),hs(i.blob,"outgoingSdp should be a non null value"),this.isPromotingToRealtime=2===this.callMode,ds(this.isCallIdleOrRosterOnly()||this.isPromotingToRealtime,"a call is already in progress"),this.logger.info(`[${a}][joinGivenConversation][start][correlationId=${t}] applicationType=${this.participantManager.localParticipant.applicationType}`),this.disposed)return void this.logger.warn(`[${a}][joinGivenConversation][failed][reason=Session disposed]`);const o=this.gatherTelemetryForStartOrJoin(s,a,r);this.lastUsedJoinCallOptions=s,this.originalRoleBeforePreheat=hc.ROLE.JOIN,this.telemetryHelper.startCallInitializationWatch(r),s&&s.scenario&&this.telemetryHelper.setScenario(s.scenario),this.logger.info(`[${a}][joinGivenConversation]options=${Ve(o)}`),this.isBrokerEnabledForIncomingCall()&&this.setupBrokerChannel(),this.fsmState=Zr.SIGNALING_FSM_STATE.OUTGOING,this.updateCorrelationId(t,a),this.meetingData=s?.meetingData,this.meetingPreferences=s?.meetingPreferences;const l={newCall:!1,suppressDialout:!0,conversationServiceUrl:e,endpointState:this.configureEndpointStateForStartOrJoin(s),scenario:s?s.scenario:null,isPreheatOnly:!!s&&s.isPreheatOnly,applicationType:this.participantManager.localParticipant.applicationType,clientEndpointCapabilities:s?s.clientEndpointCapabilities:0,clientEndpointDebugContent:s?s.clientEndpointDebugContent:null,conversationType:s?this.getConversationType(s.isEmergency,!1):null,meetingPreferences:this.meetingPreferences,meetingData:this.meetingData,meetingRegistrationId:s?.meetingRegistrationId,participantPin:s?.participantPin,sharedLineCallInvitationContent:s?.sharedLineCallInvitationContent,applyServerMute:s?.applyServerMute,publishedStates:s?.publishedStates,invitationData:s?.invitationData,captchaContentJson:s?.captchaContentJson,callQueueContext:s?.callQueueContext};this.isCastCall=!1,this.startOrJoinCall(l,cc.JOIN_CONVERSATION.name,a,i,n)},this.subscribeToCall=(e,t,i=0,n,r=os())=>{hs(t,"correlationId should be a non null value"),ds(this.fsmState===Zr.SIGNALING_FSM_STATE.IDLE,"a call is already in progress");let s=e;return s||(s=this.signalingAgentConfig.conversationServiceUrl,this.logger.info(`conversationServiceUrl passed is empty. so it is set to ${s}`)),cs(s,"conversationUrl should be a non null value"),this.logger.info(`[${r}][subscribeToCall][start][correlationId=${t}] applicationType=${this.participantManager.localParticipant.applicationType}`),this.disposed?(this.logger.warn(`[${r}][subscribeToCall][failed][reason=Session disposed]`),Promise.reject(Zr.CALL_END_CODE.CALL_DOES_NOT_EXIST)):(this.isBrokerEnabledForIncomingCall()&&this.setupBrokerChannel(),this.lastUsedJoinCallOptions=n||{},this.lastUsedJoinCallOptions.clientEndpointCapabilities=i||this.lastUsedJoinCallOptions?.clientEndpointCapabilities,this.meetingData=n?.meetingData,this.meetingPreferences=n?.meetingPreferences,this.fsmState=Zr.SIGNALING_FSM_STATE.OUTGOING_FOR_ROSTER_ONLY,this.updateCorrelationId(t,r),this.http.sendPostRequest({url:s,requestName:cc.JOIN_CONVERSATION_WITHOUT_CALL_MODALITY.name,operationType:"CallSetup",payload:yh(this,null,null,{subscribe:!0,clientEndpointCapabilities:i,...n,applicationType:this.participantManager.localParticipant.applicationType,endpointState:this.configureEndpointStateForStartOrJoin({additionalEndpointProperties:n?.additionalEndpointProperties})},r),causeId:r}).then((e=>{this.disposed||(this.fsmState=Zr.SIGNALING_FSM_STATE.CONNECTED_FOR_ROSTER_ONLY,this.processConversationServiceResponseHeaders(e,r),this.processConversationServiceResponse(e.response,r,1),this.onCallStatusChanged(Zr.CALL_STATUS.CONNECTED_FOR_ROSTER_ONLY,r))})).catch((e=>{if(e.stack&&!this.isFatalException(e))return Promise.resolve();const t=Cs(e,this.signalingAgentConfig);return this.logger.info(`[${r}][subscribeToCall] error: ${Ve(e)} xhrError: ${Ve(t)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.fsmState=Zr.SIGNALING_FSM_STATE.IDLE,this.telemetryHelper.setTerminatingData({terminatingEnd:hc.CALL_TERMINATING_END.LOCAL,resultValue:hc.RESULT_VALUE.FAILURE,endCode:t.telemetryEndSubCode,endSubCode:t.error.subCode,resultCategories:t.error.resultCategories,resultDetail:t.error.phrase||this.getTerminatingCallResultDetail("subscribe",t.error),causeId:r}),this.onCallStatusChanged(Zr.CALL_STATUS.LOCAL_TERMINATED,r,t.error),Promise.reject(t.error))})))},this.getCallReplacementDetailsForCall=(e,t=os())=>{this.logger.info(`[${t}] getCallReplacementDetailsForCall callId ${e}`);const i=this.signalingAgent.getSignalingSession(e);return i?i.getCallReplacementDetails(t):{replaces:""}},this.getCallReplacementDetails=(e=os())=>(this.logger.info(`[${e}] getCallReplacementDetails`),{replaces:this.links[Zr.LINKS.REPLACE]}),this.transferCallAsync=(e,t,i,n,r=os())=>{this.logger.info(`[${r}] transferCallAsync: transferTargetMri: ${this.piiUtils.scrubMriOrOmit(e)} transferType ${t} callTransferOptions: ${He(n)}`),this.transferHelper(e,t,i,n,r)},this.redirectCall=(e,t=os(),i)=>{const{id:n,endpointType:r,type:s}=e.redirectOptions;if(this.logger.info(`[${t}] redirectCall: targetId: ${this.piiUtils.scrubMriOrOmit(n)} targetEndpointType ${r}`),!this.isRedirectAllowed){const e={code:Zr.CALL_END_CODE.REJECT,phrase:Zr.CALL_END_PHRASE.CALL_REDIRECT_IS_NOT_ALLOWED};return Promise.reject(e)}this.telemetryHelper.recordEvent(ko,{causeId:t});const a=function(e,t,i,n){hs(e,"signalingSession cannot be null");const r=e.participantManager.localParticipant;return{payload:{invitationRedirection:{target:{type:t,endpointType:n,id:i},sender:{id:r.id,endpointId:r.endpointId,participantId:r.participantId,languageId:r.languageId}}}}}(this,s,n,r);return this.http.sendPostRequest({url:this.links[Zr.LINKS.REDIRECT],requestName:cc.SEND_CALL_REDIRECT_REQUEST.name,payload:a,causeId:t}).then((n=>(this.logger.info(`[${t}][redirectCall] succeeds. Leaving the call...`),this.telemetryHelper.recordEvent(Ol,{causeId:t,targetEndpointType:r}),this.terminateEstablishedCall(i,e)))).catch((e=>{const n=Cs(e);this.logger.info(`[${t}][redirectCall] error: ${Ve(n)}`);const s=n.error;return this.telemetryHelper.recordEvent(No,{causeId:t,transactionEnd:s,endpointType:r}),this.disposed||(this.telemetryHelper.setTerminatingData({terminatingEnd:hc.CALL_TERMINATING_END.LOCAL,endCode:i.code,endSubCode:i.subCode,clientReasonSubCode:i.clientReasonSubCode,clientReasonPhrase:i.clientReasonPhrase,resultDetail:i.phrase||"RedirectCall",resultCategories:i.resultCategories,causeId:t}),this.onCallStatusChanged(Zr.CALL_STATUS.LOCAL_TERMINATED,t,i),this.dispose(i,t)),Promise.reject(s)}))},this.transferHelper=(e,t,i,n,r=os())=>{ds(this.fsmState===Zr.SIGNALING_FSM_STATE.CONNECTED,"call is not connected yet");let s=!1;this.logger.info(`[${r}][transferHelper][replacementDetails=${Ve(i)}] disableForwardingAndUnanswered=${n&&n.disableForwardingAndUnanswered}`),this.telemetryHelper.recordEvent(Oo,{causeId:r}),this.timeoutManager.startTimer(Zr.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT,(()=>{this.handleCallTransferTimeout(r,s)}),Zr.TIMEOUT_VALUES_IN_SECONDS.OUTGOING_CALL_ESTABLISHMENT_TIMEOUT),this.http.sendPostRequest({url:this.links[Zr.LINKS.TRANSFER],requestName:cc.SEND_TRANSFER_REQUEST.name,payload:Ih(e,this,i,t,n),causeId:r}).then((()=>{this.telemetryHelper.recordEvent(Ul,{causeId:r}),s=!0})).catch((e=>{const t=Cs(e,this.signalingAgentConfig);this.logger.info(`[${r}][transferCallAsync] error: ${Ve(t)}`),this.disposed||(this.signalingSessionCallback.onTransferCompleted({transferCompletion:{code:Zr.CALL_END_CODE.NETWORK_ERROR,reason:Ve(e)}},r),this.telemetryHelper.recordEvent(Dl,{causeId:r,...t.error}))})),this.telemetryHelper.recordEvent(Ml,{causeId:r,transferType:t})},this.consultTransferCallAsync=(e,t,i,n,r)=>{let s,a;if(this.logger.info(`[${n}] consultTransferCallAsync: transferTargetMri: ${this.piiUtils.scrubMriOrOmit(t)} transferTargetParticipantLegId: ${i}`),i?(a=this.getMriByParticipantLegOfCall(e,i,n),s=this.getReplacementDetailsByParticipantLegOfCall(e,t,i,n)):(a=t,s=this.getCallReplacementDetailsForCall(e,n)),!a||!s){const r=s?"target mri corresponding not found":`unable to retrieve replacementDetails for transferTargetCallId: ${e}, transferTargetMri: ${t}, transferTargetParticipantLegId: ${i}`;return this.logger.info(`[${n}] consultTransferCallAsync: error: ${r}`),void this.signalingSessionCallback.onTransferCompleted({transferCompletion:{code:Zr.CALL_END_CODE.BAD_REQUEST,reason:r}},n)}this.transferHelper(a,"TransferTypeStandard",s,r,n)},this.isParkByTransfer=(e,t)=>{const i=["serverHold","sharedLinePark","teamPark"].indexOf(e)>-1;return this.logger.info(`[${t}][isParkByTransfer][context=${e}] result = ${i}`),i},this.parkCallAsync=(e,t=os())=>{if(e&&"none"===e)throw{code:Zr.CALL_END_CODE.REJECT,subCode:Zr.CALL_END_SUB_CODE.PARK_UNPARK_TYPE_MISSING,phrase:"Unpark context is missing or none"};return ds(this.fsmState===Zr.SIGNALING_FSM_STATE.CONNECTED,"call is not connected yet"),this.logger.info(`[${t}][parkCallAsync][context=${e}]`),this.telemetryHelper.recordEvent(Do,{causeId:t,parkType:Ls(e)}),this.isParkByTransfer(e,t)?this.parkByTransfer(e,t):this.park(e,t)},this.unparkAsync=(e,t=os())=>{if(e&&"none"===e)throw{code:Zr.CALL_END_CODE.REJECT,subCode:Zr.CALL_END_SUB_CODE.PARK_UNPARK_TYPE_MISSING,phrase:"Unpark context is missing or none"};if(!this.links[Zr.LINKS.UNPARK])throw{code:Zr.CALL_END_CODE.REJECT,subCode:Zr.CALL_END_SUB_CODE.PARK_UNPARK_TYPE_MISSING,phrase:"Unpark link not available"};this.logger.info(`[${t}][unparkAsync][context=${e}]`),this.timeoutManager.startTimer(Zr.TIMEOUT_OPERATIONS.UNPARK_COMPLETION,(()=>{this.handleUnparkError({code:Zr.CALL_END_CODE.TIMEOUT,subCode:Zr.CALL_END_SUB_CODE.UNPARK_COMPLETION_TIMEOUT,phrase:Zr.CALL_END_PHRASE.UNPARK_COMPLETION_TIMEOUT},cd,t,e)}),Zr.TIMEOUT_VALUES_IN_SECONDS.UNPARK_COMPLETION_TIMEOUT);const i={causeId:t};return this.http.sendPostRequest({url:this.links[Zr.LINKS.UNPARK],requestName:cc.SEND_UNPARK_REQUEST.name,payload:Rh(this,i),causeId:t}).then((e=>(this.logger.info(`[${t}][unparkAsync] response: ${Ve(e)}`),this.telemetryHelper.recordEvent(dd,{causeId:t}),Promise.resolve()))).catch((i=>{const n=Cs(i,this.signalingAgentConfig);return this.logger.info(`[${t}][unparkAsync] error: ${Ve(n)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.handleUnparkError(n.error,ld,t,e),Promise.reject(n.error))}))},this.handleUpdateParticipantsPropertiesCompletion=e=>{const t=e.body,i=_s(e),n=this.logger.createChild(`[${i}][handleUpdateParticipantsPropertiesCompletion]`,this.correlationId),r={};if(this.disposed)n.info("ignored. Call disposed.");else{if(t.operationId||n.warn("operationId is undefined."),n.info("starts"),t.participantInfos)for(const e of t.participantInfos){if(!e.participant.id){n.warn("participant id is undefined."),this.telemetryHelper.recordEvent(Fd,"participant id is undefined in response, property");continue}if(!e.participant.key){n.warn("property name (key) is undefined."),this.telemetryHelper.recordEvent(Fd,"property name (key) is undefined in response");continue}const s=uh(e.participant.id,t.operationId,e.participant.key),a={code:e.transactionEnd.code,subCode:e.transactionEnd.subCode,phrase:e.transactionEnd.phrase,resultCategories:e.transactionEnd.resultCategories};n.info(`Update participants properties completed for: ${this.piiUtils.scrubMriOrOmit(e.participant.id)} with transactionEnd ${Ve(a)}`),this.telemetryHelper.recordEvent(Ud,{causeId:i,resolveId:this.piiUtils.scrubMriOrOmit(s),property:e.participant.key,result:Ve(a)}),r[s]=a,this.updateParticipantsPromises[t.operationId].delete(s)}this.checkAndCleanupPromisesForOperationId(t.operationId),this.signalingSessionCallback.onUpdateParticipantsPropertiesCompleted(r,t.operationId,i)}},this.getCallStatus=()=>this.currentCallStatus,this.processIncomingCallRequest=(e,t,i=os())=>{if(hs(e,"request should be a non null value"),cs(e.body,"request should have a valid body"),cs(e.body.gp||e.body.cp,"request body should have payload"),ds(this.isCallIdleOrRosterOnly(),"a call is already in progress"),this.callUsesMixer=e.fromMixer,this.logger.info(`[${i}][processIncomingCallRequest][start]`),this.disposed)return void this.logger.warn("processIncomingCallRequest canceled");this.telemetryHelper.startCallInitializationWatch(),this.isIncomingCall=!0,this.isBrokerEnabledForIncomingCall()&&this.setupBrokerChannel(),this.fsmState=Zr.SIGNALING_FSM_STATE.INCOMING,this.participantManager.initializeForIncomingCall();let n={};try{t&&(n=JSON.parse(t))}catch(e){this.logger.warn("Unable to parse endpoint metadata")}this.endpointMetadata=n;try{let t;if(e?.body?.gp&&!je(e.body.gp))this.logger.info(`[${i}][processIncomingCallRequest] unencoded payload, skipping decoding.`),t=e.body.gp;else{const i=e.body.gp?atob(e.body.gp):Is(e.body.cp);t=JSON.parse(i)}if(!t.callNotification)throw this.logger.info(`[${i}][processIncomingCallRequest][failed][reason=CallNotification missing]`),new Error("CallNotification is missing");this.processIncomingCallPayload(t,i),this.incomingCallPayload=t}catch(e){this.endIncomingCallBecauseOfInvalidPayload(i)}},this.sendAttachToCall=(e=os())=>(this.logger.info(`[${e}][sendAttachToCall]`),this.incomingCallPayload?(this.onCallStatusChanged(Zr.CALL_STATUS.IDLE,e),this.sendAttachToCallInternal(e)):(this.endIncomingCallBecauseOfInvalidPayload(e),Promise.reject(Zr.CALL_END_SUB_CODE.BAD_NOTIFICATION_PAYLOAD))),this.supportsNewOfferRequest=()=>this.signalingAgentConfig.handleNewOfferRequest,this.requestNewOffer=(e,t=os())=>(this.telemetryHelper.recordEvent(hl,{compatibleContentTypes:e,causeId:t}),this.signalingAgentConfig.handleNewOfferRequest?(cs(this.links[Zr.LINKS.NEW_OFFER],"newOffer link should be a non null value"),this.http.sendPostRequest({url:this.links[Zr.LINKS.NEW_OFFER],requestName:cc.REQUEST_NEW_OFFER.name,payload:Th(this,e,this.links[Zr.LINKS.NEW_OFFER]),causeId:t}).then((e=>this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):Promise.resolve(e))).catch((e=>{const i=Cs(e,this.signalingAgentConfig);return this.logger.info(`[requestNewOffer][${t}] error ${Ve(i)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.fsmState=Zr.SIGNALING_FSM_STATE.IDLE,this.telemetryHelper.setTerminatingData({terminatingEnd:hc.CALL_TERMINATING_END.LOCAL,resultValue:hc.RESULT_VALUE.FAILURE,endCode:i.telemetryEndSubCode,endSubCode:i.error.subCode,resultCategories:i.error.resultCategories,resultDetail:i.error.phrase||this.getTerminatingCallResultDetail("requestNewOffer",i.error),causeId:t}),this.onCallStatusChanged(Zr.CALL_STATUS.LOCAL_TERMINATED,t,i.error),this.dispose(i.error,t),Promise.reject(i.error))}))):Promise.reject("Disabled")),this.endAsync=(e,t={})=>{t.causeId=t.causeId||os();const i=t.causeId;if(this.logger.info(`[${i}][endAsync][rejectionData=${e&&Ve(e)}][endCallForAll=${t.forEveryone}]`),this.disposed)return this.logger.warn(`[${i}][endAsync] canceled but session already disposed`),Promise.resolve(null);if(this.disposing=!0,this.telemetryHelper.recordEvent(Va,e?{code:e.code,subCode:e.subCode,causeId:i,callEndClientSubCode:e.clientReasonSubCode,callEndClientPhrase:e.clientReasonPhrase}:{causeId:i}),t.preventAllCallbacks){const e=Object.keys(this.signalingSessionCallback);for(const t of e)this.signalingSessionCallback[t]=yc.noop}const n=this.mediaRenegotiationManager?.isIncomingRenegotiationInProgress()||this.mediaRenegotiationManager?.isOutgoingRenegotiationInProgress();if(this.telemetryHelper.stopCallCancelationDurationWatch(),this.fsmState===Zr.SIGNALING_FSM_STATE.INCOMING)return e.code===Zr.CALL_END_CODE.CALL_REDIRECTED?this.redirectCall(t,i,e):this.rejectIncomingCall(e,i);if(this.fsmState===Zr.SIGNALING_FSM_STATE.OUTGOING||this.fsmState===Zr.SIGNALING_FSM_STATE.OUTGOING_FOR_ROSTER_ONLY)return this.cancelOutgoingCall(e,i);if(this.fsmState===Zr.SIGNALING_FSM_STATE.WAITING_CALL_ACCEPTANCE_ACK)return this.rejectIncomingCall(e,i);if((this.fsmState===Zr.SIGNALING_FSM_STATE.CONNECTED||n)&&t.forEveryone)return this.deleteConversation(e,i);if(this.fsmState===Zr.SIGNALING_FSM_STATE.CONNECTED||this.fsmState===Zr.SIGNALING_FSM_STATE.CONNECTED_FOR_ROSTER_ONLY||n)return this.terminateEstablishedCall(e,t);{this.logger.info(`[${i}][endAsync] there is no call to cancel or end or reject in current state`);const t={code:isNaN(e?.code)?Zr.CALL_END_CODE.NOT_FOUND:e.code,subCode:isNaN(e?.subCode)?Zr.CALL_END_SUB_CODE.CALL_NOT_ATTEMPTED:e.subCode,phrase:e?.phrase||Zr.CALL_END_PHRASE.CALL_DOES_NOT_EXIST,resultCategories:e?.resultCategories||[Pr],clientReasonSubCode:e?.clientReasonSubCode,clientReasonPhrase:e?.clientReasonPhrase};return this.telemetryHelper.setTerminatingData({terminatingEnd:hc.CALL_TERMINATING_END.LOCAL,resultDetail:t.phrase||"CallDoesNotExist",endCode:t.code,endSubCode:t.subCode,resultCategories:t.resultCategories,causeId:i,clientReasonSubCode:t.clientReasonSubCode,clientReasonPhrase:t.clientReasonPhrase}),this.onCallStatusChanged(Zr.CALL_STATUS.LOCAL_TERMINATED,i,t),this.dispose(t,i),Promise.resolve(null)}},this.handleIncomingMsgAsync=(e,t=Zr.INCOMING_MESSAGE_ORIGIN.TROUTER)=>{hs(e,"incoming message should be a non null value");const i=Es(e),n=As(),r=e.body,s=e.url,a={...e,origin:t},o=_s(a);if(this.logger.info(`[${o}][handleIncomingMsgAsync][url=${s}][messageId=${i}]`),!r)return this.logger.info(`[${o}][handleIncomingMsgAsync][failed][reason=received message with no body]`),this.telemetryHelper.recordEvent(tl,{origin:t,messageId:i,causeId:o}),n.reject(new Error("received message with no body")),n.promise;if(this.disposed)return this.logger.info(`[${o}][handleIncomingMsgAsync][failed][reason=call is disposed]`),n.reject(this.getCallNotFoundTransactionEnd()),n.promise;if(this.isDuplicatedIncomingMessage(a))return this.logger.info(`[${o}][handleIncomingMsgAsync][failed][reason=duplicate]`),this.telemetryHelper.recordEvent(Uo,{origin:t,messageId:i,causeId:o}),n.resolve(new Error("Message was already handled")),n.promise;this.checkCorrelationIdChange(e,o);const l={[kr]:e=>{this.handleCallNotification(e)},[Nr]:e=>{this.handleMediaAnswer(e)},[Lr]:e=>{this.handleMediaAcknowledgement(e)},[xr]:e=>{this.handleCallAcceptance(e)},[Fr]:e=>{this.handleCallEnd(e)},[Ur]:e=>{this.handleCallProgress(e)},[Vr]:e=>{this.handleCallAcceptanceAck(e)},[Hr]:e=>{this.mediaRenegotiationManager?.handleMediaNegotiationOffer(e)},[Br]:e=>{this.mediaRenegotiationManager?.handleMediaNegotiationFailure(e)},[$r]:e=>{this.handlePSTNBalanceUpdate(e)},[jr]:e=>{this.mediaRenegotiationManager?.handleRetargetCompleted(e)},[Gr]:e=>{this.handleTransferRequested(e)},[Wr]:e=>{this.handleTransferCompletion(e)},[qr]:e=>{this.handleTransferAcceptance(e)},[zr]:e=>{this.handleParkCompletion(e)},[Kr]:e=>{this.handleUnparkCompletion(e)},[Jr]:e=>{this.handleUpdateMeetingLiveStateCompletion(e)},[Yr]:e=>{this.handleUpdateMeetingGroupsCompletion(e)},[Qr]:e=>{this.handleSetMeetingLayoutCompletion(e)},[Xr]:e=>{this.handleUpdateMeetingStatesCompletion(e)}},d={[Dr.CONTROL_VIDEO_STREAMING]:e=>{this.webRtcSignalingManager.handleControlVideoStreaming(e)},[Dr.DOMINANT_SPEAKER_INFO]:e=>{this.webRtcSignalingManager.handleDominantSpeakerInfo(e)},[Dr.CSRC_INFO]:e=>{this.webRtcSignalingManager.handleCsrcInfo(e)},[Dr.CONV_ROSTER_UPDATE]:e=>{this.handleRosterUpdate(e,!1)},[Dr.NEW_MEDIA_OFFER]:e=>{this.handleNewMediaOffer(e)},[Dr.CONV_ADD_PARTICIPANT_SUCCESS]:e=>{this.participantManager.handleAddParticipantSuccess(e)},[Dr.CONV_ADD_PARTICIPANT_FAILURE]:e=>{this.participantManager.handleAddParticipantFailure(e)},[Dr.CONV_ADMIT_PARTICIPANT_SUCCESS]:e=>{this.participantManager.handleAdmitParticipantSuccess(e)},[Dr.CONV_ADMIT_PARTICIPANT_FAILURE]:e=>{this.participantManager.handleAdmitParticipantFailure(e)},[Dr.CONV_ADMIT_ALL_STATUS]:e=>{this.handleAdmitAllStatus(e)},[Dr.CONV_REMOVE_PARTICIPANT_SUCCESS]:e=>{this.participantManager.handleRemoveParticipantSuccess(e)},[Dr.CONV_REMOVE_PARTICIPANT_FAILURE]:e=>{this.participantManager.handleRemoveParticipantFailure(e)},[Dr.CONV_CONFIRM_UNMUTE]:e=>{this.participantManager.handleUnmuteConfirmRequest(e)},[Dr.CONV_UPDATE]:e=>{this.handleConversationUpdate(e)},[Dr.CONV_LOCAL_PARTICIPANT_UPDATE]:e=>{this.handleLocalParticipantUpdate(e)},[Dr.CONV_ADD_MODALITY_SUCCESS]:e=>{this.handleAddModalitySuccess(e)},[Dr.CONV_ADD_MODALITY_FAILURE]:e=>{this.handleAddModalityFailure(e)},[Dr.CONV_BROADCAST_UPDATE]:e=>{this.broadcastSession.handleBroadcastStateChanged(e)},[Dr.CONV_CONTENT_SHARING_UPDATE]:e=>{this.contentSharingManager?.handleContentSharingUpdate(e)},[Dr.CONV_CONTENT_SHARING_END]:e=>{this.contentSharingManager?.handleContentSharingEnd(e)},[Dr.CONV_END]:e=>{this.handleCallEnd(e)},[Dr.UPDATE_PARTICIPANT_INTERPRETATION_STATE_STATUS]:e=>{this.participantManager.handleUpdateParticipantInterpretationStateCompletion(e)},[Dr.UPDATE_PARTICIPANT_PROPERTIES_STATUS]:e=>{this.handleUpdateParticipantsPropertiesCompletion(e)},[Dr.JOIN_MEETING_GROUP_STATUS]:e=>{this.handleJoinMeetingGroupCompletion(e)},[Dr.LEAVE_MEETING_GROUP_STATUS]:e=>{this.handleLeaveMeetingGroupCompletion(e)},[Dr.RECEIVE_MESSAGE]:e=>{this.handleReceiveMessage(e)},[Dr.SEND_MESSAGE_STATUS]:e=>{this.proxiedMessageNotificationManager.handleProxiedMessageNotification(e)},[Dr.DISABLE_PREHEAT_ASYNC_STATUS]:e=>{this.handleDisablePreheatCompletion(e)},[Dr.MUTE_UNMUTE_ASYNC]:e=>{this.participantManager.handleMuteUnmuteAsyncResponse(e)}};try{const e=Object.keys(l).filter((e=>r.hasOwnProperty(e)))[0],t=Object.keys(d).filter((e=>a.url&&ms(a.url,e)))[0];e?l[e](a):t?d[t](a):(this.telemetryHelper.recordEvent(Ho,{messageId:i}),this.logger.info(`[${o}][handleIncomingMsgAsync][failed][reason=received unknown message]`)),n.resolve(!0)}catch(e){this.telemetryHelper.recordEvent(Bo,{messageId:i,error:Ve(e)}),this.logger.info(`[${o}][handleIncomingMsgAsync][failed][reason=${e.message}]`),n.reject(new Error(e.message))}return n.promise},this.canHandleIncomingMsgSync=e=>{if(this.signalingAgentConfig.supportsSynchronousTrouterResponse){const t=e.body;return Boolean(t.callAcceptance)}return!1},this.handleIncomingMsgSync=e=>{const t=Es(e),i=e.body,n=e.url,r=Zr.INCOMING_MESSAGE_ORIGIN.TROUTER,s={...e,origin:r},a=_s(s);this.logger.info(`[${a}][handleIncomingMsgSync][url=${n}][messageId=${t}]`);const o=s.headers;let l=Zr.HTTP_STATUS_CODES.OK,d="";const c=new ts;if(Ts(o,this.incomingTrouterMessagesSeenSoFar)){this.logger.info(`[${a}][handleIncomingMsgSync][failed][reason=duplicate]`);const e=(h=o,u=this.incomingMessageSyncResponseCache,h&&u[h.get(Zr.HEADERS.ORIGINAL_MESSAGE_ID)||h.get(Zr.HEADERS.MESSAGE_ID)||null]||null);if(e)return this.logger.info(`[${a}][handleIncomingMsgSync][cachedResponse]`),e;this.telemetryHelper.recordEvent(Uo,{origin:r,messageId:t,causeId:a}),this.logger.info(`[${a}][handleIncomingMsgSync][failed][reason=cachedResponseNotFound]`),l=Zr.HTTP_STATUS_CODES.BAD_REQUEST}else if(i){if(i.callAcceptance)try{d=He(this.handleCallAcceptanceSync(s))}catch(e){this.telemetryHelper.recordEvent(Bo,{messageId:t,origin:r,causeId:a,error:Ve(e)}),this.logger.info(`[${a}][handleIncomingMsgSync][failed][reason=${e?.message}]`),l=Zr.HTTP_STATUS_CODES.BAD_REQUEST}}else this.logger.info(`[${a}][handleIncomingMsgSync][failed][reason=received message with no body]`),this.telemetryHelper.recordEvent(tl,{origin:r,messageId:t,causeId:a}),l=Zr.HTTP_STATUS_CODES.BAD_REQUEST;var h,u;o&&(o.get(Zr.HEADERS.CORRELATION_ID)&&c.set(Zr.HEADERS.CORRELATION_ID,o.get(Zr.HEADERS.CORRELATION_ID)),o.get(Zr.HEADERS.MESSAGE_ID)&&c.set(Zr.HEADERS.MESSAGE_ID,o.get(Zr.HEADERS.MESSAGE_ID)));const p={resultCode:l,responseBody:d,responseHeaders:c.getAll()};return function(e,t,i){if(e&&t){const n=e.get(Zr.HEADERS.ORIGINAL_MESSAGE_ID)||e.get(Zr.HEADERS.MESSAGE_ID)||null;n&&(t[n]=i)}}(o,this.incomingMessageSyncResponseCache,p),this.logger.info(`[${a}][handleIncomingMsgSync][success][resultCode=${l}]`),p},this.acceptRenegotiationAsync=(e,t,i=os())=>(hs(e.blob,"finalSdp should be a non null value"),ds(this.fsmState===Zr.SIGNALING_FSM_STATE.CONNECTED,"Renegotation operations are only allowed when the call is connected and no disconnect operation is in flight"),this.logger.info(`[${i}][acceptRenegotiationAsync][mediaTypes=${t}]`),this.mediaRenegotiationManager.acceptRenegotiationAsync(e,t,i)),this.setProvisionalAnswerAsync=(e,t=os())=>{hs(e.blob,"sdp should be a non null value"),this.telemetryHelper.recordEvent($a,{causeId:t});const i=As();return this.fsmState!==Zr.SIGNALING_FSM_STATE.INCOMING?(this.logger.info(`[setProvisionalAnswerAsync][${t}] there is no incoming call to set provisional answer on.`),i.reject(new Error("there is no incoming call to set provisional answer on.")),i.promise):(this.http.sendPostRequest({url:this.links[Zr.LINKS.MEDIA_ANSWER],requestName:cc.SEND_MEDIA_ANSWER.name,payload:Dh(this,e),causeId:t}).then((e=>{this.disposed||this.onCallStatusChanged(Zr.CALL_STATUS.CONNECTING,t),i.resolve(null),this.disposed||(this.telemetryHelper.recordEvent(Vs,{causeId:t}),this.telemetryHelper.setTimeToRingDuration(),this.onCallStatusChanged(Zr.CALL_STATUS.RINGING,t),this.signalingSessionCallback.onMediaAcknowledgementSuccess(!1,t))})).catch((e=>{const n=Cs(e,this.signalingAgentConfig);this.logger.info(`[setProvisionalAnswerAsync][${t}] error: ${Ve(n)}`),this.disposed?i.reject(this.getCallNotFoundTransactionEnd()):(this.telemetryHelper.recordEvent(ja,{causeId:t}),i.reject(n.error))})),i.promise)},this.startRenegotiationAsync=(e,t,i=os())=>(hs(e,"mediaContent should be a non null value"),ds(this.fsmState===Zr.SIGNALING_FSM_STATE.CONNECTED,"Renegotation operations are only allowed when the call is connected and no disconnect operation is in flight"),this.logger.info(`[${i}][startRenegotiationAsync]`),this.mediaRenegotiationManager.startRenegotiationAsync(e,this.links[Zr.LINKS.MEDIA_RENEGOTIATION],t,i)),this.updateMediaDescriptionsAsync=(e=os(),t)=>{hs(t,"mediaDescriptions should be a non null value"),ds(this.fsmState===Zr.SIGNALING_FSM_STATE.CONNECTED,"updateMediaDescriptions operations are only allowed when the call is connected");const i=this.links[Zr.LINKS.UPDATE_MEDIA_DESCRIPTIONS];return hs(i,"updateMediaDescriptionsUrl should be a non null value"),this.telemetryHelper.recordEvent(nc,{causeId:e}),this.http.sendPostRequest({url:i,requestName:cc.UPDATE_MEDIA_DESCRIPTIONS.name,payload:kh(this,t),causeId:e}).catch((t=>{const i=Cs(t,this.signalingAgentConfig);return this.logger.info(`[updateMediaDescriptionsAsync][${e}] error: ${Ve(i)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.telemetryHelper.recordEvent(rc,{causeId:e}),Promise.reject(i.error))}))},this.acceptAsync=(e,t,i,n=os())=>{hs(e,"mediaContent should be a non null value"),hs(e.blob,"outgoingSdp should be a non null value"),this.logger.info(`[${n}][acceptAsync][mediaTypes=${t}]`),this.telemetryHelper.recordEvent(Ga,{causeId:n}),this.telemetryHelper.setAnsweredModalities(e.blob);const r=As();return this.fsmState!==Zr.SIGNALING_FSM_STATE.INCOMING?(this.logger.warn("acceptAsync, there is no incoming call to accept"),r.reject(new Error("there is no incoming call to accept")),r.promise):(this.fsmState=Zr.SIGNALING_FSM_STATE.WAITING_CALL_ACCEPTANCE_ACK,this.http.sendPostRequest({url:this.links[Zr.LINKS.ACCEPT],requestName:cc.SEND_ACCEPTANCE.name,payload:fh(this,e,t,i),causeId:n}).then((e=>{this.disposed||(this.currentCallStatus===Zr.CALL_STATUS.IDLE&&(this.telemetryHelper.setTimeToRingDuration(),this.telemetryHelper.recordEvent(ro,{causeId:n}),this.onCallStatusChanged(Zr.CALL_STATUS.CONNECTING,n)),e.response.callAcceptanceAcknowledgement&&(this.logger.info("acceptAsync, handling inlined callAcceptanceAcknowledgement"),this.internalHandleCallAcceptanceAck(e.response,n))),r.resolve(null)})).catch((e=>{const t=Cs(e,this.signalingAgentConfig);this.logger.info(`[acceptAsync][${n}] error: ${Ve(t)}`),this.disposed?r.reject(this.getCallNotFoundTransactionEnd()):(this.fsmState=Zr.SIGNALING_FSM_STATE.INCOMING,this.telemetryHelper.recordEvent(Wa,{causeId:n,xhrError:t}),r.reject(t.error))})),r.promise)},this.rejectRenegotiationAsync=(e,t=os())=>(ds(this.fsmState===Zr.SIGNALING_FSM_STATE.CONNECTED,"Renegotation operations are only allowed when the call is connected and no disconnect operation is in flight"),this.logger.info(`[${t}][rejectRenegotiationAsync][rejectionData=${e}]`),this.mediaRenegotiationManager.rejectRenegotiationAsync(e,t)),this.saveMediaControllerLinksIfAny=e=>{e.links&&(this.links[Zr.LINKS.CONTROL_VIDEO_STREAMING]=e.links.controlVideoStreaming||this.links[Zr.LINKS.CONTROL_VIDEO_STREAMING],this.links[Zr.LINKS.APPLY_CHANNEL_PARAMETERS]=e.links.applyChannelParameters||this.links[Zr.LINKS.APPLY_CHANNEL_PARAMETERS])},this.getInitialMediaOfferFromIncomingCallPayload=(e=os())=>{if(!this.signalingAgentConfig.handleMediaOfferFromPushNotification)return null;const t=this.incomingCallPayload?.callNotification?.mediaContent?this.incomingCallPayload.callNotification.mediaContent:null;return this.telemetryHelper.setIsSdpInCallNotification(!!t),t},this.updateCorrelationId=(e,t=os())=>{if(this.logger.info(`[${t}][updateCorrelationId][old=${this.correlationId}][new=${e}]`),this.correlationId!==e&&!this.disposed){const i=this.correlationId;this.correlationId=e,this.telemetryHelper&&this.telemetryHelper.recordEvent&&this.telemetryHelper.recordEvent(Vo,{newId:this.correlationId,oldId:i,causeId:t}),this.signalingSessionCallback&&this.signalingSessionCallback.onCorrelationIdUpdated&&this.signalingSessionCallback.onCorrelationIdUpdated(this.correlationId,t)}},this.endIncomingCallBecauseOfInvalidPayload=e=>{this.logger.info(`[${e}][endIncomingCallBecauseOfInvalidPayload]`),this.fsmState=Zr.SIGNALING_FSM_STATE.IDLE;const t={code:Zr.CALL_END_CODE.BAD_REQUEST,subCode:Zr.CALL_END_SUB_CODE.BAD_NOTIFICATION_PAYLOAD,phrase:Zr.CALL_END_PHRASE.BAD_NOTIFICATION_PAYLOAD,resultCategories:[Ar]};this.telemetryHelper.setTerminatingData({terminatingEnd:hc.CALL_TERMINATING_END.LOCAL,resultValue:hc.RESULT_VALUE.FAILURE,endCode:t.code,endSubCode:t.subCode,resultDetail:t.phrase||"EndIncomingCall",resultCategories:t.resultCategories,causeId:e}),this.onCallStatusChanged(Zr.CALL_STATUS.LOCAL_TERMINATED,e,t),this.dispose(t,e)},this.isDuplicatedIncomingMessage=e=>e.origin===Zr.INCOMING_MESSAGE_ORIGIN.BROKER&&Ts(e.headers,this.incomingBrokerMessagesSeenSoFar)||e.origin===Zr.INCOMING_MESSAGE_ORIGIN.TROUTER&&Ts(e.headers,this.incomingTrouterMessagesSeenSoFar),this.getEndpointState=()=>{let e;return e=this.startOrJoinConvResponseReceived?{...this.latestEndpointState}:{...this.requestedEndpointStateWhileConnecting},e},this.setMultiParty=(e,t)=>{const i=!!e;this.multiParty!==i&&(this.telemetryHelper.recordEvent(Ma,{isMultiparty:i,causeId:t}),this.multiParty=i)},this.setupTrouterChannel=()=>{this.logger.info(`Broker config: outgoing=${this.signalingAgentConfig.brokerEnabledOutgoing?"enabled":"disabled"}incoming=${this.signalingAgentConfig.brokerEnabledIncoming?"enabled":"disabled"}batching=${this.signalingAgentConfig.brokerRequestBatching?"enabled":"disabled"}exclusive=${this.signalingAgentConfig.brokerExclusively?"enabled":"disabled"}`);const e=e=>{e&&"string"==typeof e&&e.trim()&&(this.baseMessagingChannelUrl=this.previousTrouterUrl=this.currentTrouterUrl=e.trim(),this.telemetryHelper.addTrouterChannel())};this.brokerExclusiveEnabled()||(this.signalingAgentConfig.trouterServiceProvider?(2===this.signalingAgentConfig.trouterServiceProvider.state()&&this.signalingAgentConfig.trouterServiceProvider.getTrouterUrlAsync().then(e),this.signalingAgentConfig.trouterServiceProvider.onStateChanged(this.onTrouterStateChanged)):(e(this.signalingAgentConfig.trouterUrlGetter.trouterUrl()),this.signalingAgentConfig.trouterUrlGetter.trouterUrl.changed(this.onTrouterUrlChanged)))},this.isTrouterDisconnected=()=>{try{return 3===this.signalingAgentConfig.trouterServiceProvider.state()}catch(e){return!1}},this.forceTrouterConnectionCheck=()=>{try{return void this.signalingAgentConfig.trouterServiceProvider.checkConnection(!1)}catch(e){return}},this.navigatorOnlineCallback=()=>{this.disposed||(this.reportConnectivityStatus(),this.isTrouterDisconnected()&&this.signalingAgentConfig.forceTrouterReconnectOnNetworkOnline&&this.forceTrouterConnectionCheck())},this.navigatorOfflineCallback=()=>{this.reportConnectivityStatus()},this.reportConnectivityStatus=()=>{if(!this.disposed){const e=Rs(this.signalingAgentConfig.trouterServiceProvider);this.logger.info(`[Connectivity] status=${e}`),this.telemetryHelper.recordEvent($o,{status:e})}},this.onTrouterStateChanged=(e,t)=>{const i=os();this.logger.info(`[${i}][onTrouterStateChanged][state=${e}]`),this.disposed?this.logger.info("onTrouterStateChanged ignored"):(this.reportConnectivityStatus(),2===e&&(this.telemetryHelper.addTrouterChannel(),this.updateLinksToTrouter(eo,i)))},this.setupConnectionCheck=()=>{try{navigator&&navigator.onLine&&window&&window.addEventListener&&(window.addEventListener("online",this.navigatorOnlineCallback),window.addEventListener("offline",this.navigatorOfflineCallback))}catch(e){return}},this.tearDownConnectionCheck=()=>{try{navigator&&navigator.onLine&&window&&window.removeEventListener&&(window.removeEventListener("online",this.navigatorOnlineCallback),window.removeEventListener("offline",this.navigatorOfflineCallback))}catch(e){return}},this.getTrouterUrlAsync=()=>this.signalingAgentConfig.trouterServiceProvider?this.signalingAgentConfig.trouterServiceProvider.getTrouterUrlAsync():this.signalingAgentConfig.trouterUrlGetter.getTrouterUrlAsync(),this.brokerExclusiveEnabled=()=>this.signalingAgentConfig.brokerEnabledOutgoing&&this.signalingAgentConfig.brokerEnabledIncoming&&this.signalingAgentConfig.brokerExclusively,this.isBrokerEnabledForOutgoingCall=()=>this.signalingAgentConfig.brokerEnabledOutgoing,this.isBrokerEnabledForIncomingCall=()=>this.signalingAgentConfig.brokerEnabledIncoming,this.setupBrokerChannel=()=>{this.brokerService||(this.logger.info("setupBrokerChannel, Enable broker"),this.brokerService=new kc(this),this.brokerService.onBrokerMessage((e=>{this.logger.info("setupBrokerChannel, message from broker",e),this.handleIncomingMsgAsync(e,Zr.INCOMING_MESSAGE_ORIGIN.BROKER).catch((e=>{this.telemetryHelper.recordEvent(Yo),this.logger.info("setupBrokerChannel, Failed to handle message from broker",e)}))})),this.baseMessagingChannelUrl||(this.telemetryHelper.addBrokerChannel(),this.baseMessagingChannelUrl=this.brokerService.baseUrl))},this.onTrouterUrlChanged=()=>{const e=os();this.logger.info(`[${e}][onTrouterUrlChanged]`),this.disposed?this.logger.info("onTrouterUrlChanged ignored"):this.getTrouterUrlAsync().then((t=>{this.telemetryHelper.recordEvent(Za,{url:t}),this.telemetryHelper.addTrouterChannel(),this.updateLinksToTrouter(Za,e)})).catch((e=>{this.logger.info(`Failed to update links to trouter: ${e}`)}))},this.updateLinksToTrouter=(e,t)=>{this.logger.info(`[${t}][updateLinksToTrouter][tag=${e}]`),this.ensureLatestTrouterUrl(e).then((()=>{this.previousTrouterUrl!==this.currentTrouterUrl?(this.previousTrouterUrl=this.currentTrouterUrl,this.updateConversationLinks(),this.updateKeepAliveUrl(),this.contentSharingManager?.updateContentSharingNotificationLinksAsync(t),this.broadcastSession&&this.broadcastSession.updateBroadcastCallbackUrl(t)):this.logger.info(`[${t}][updateLinksToTrouter]skip updating links, url did not change`)})).catch((e=>{this.disposed||this.telemetryHelper.recordEvent(io,{causeId:t}),this.logger.info(`[${t}][updateLinksToTrouter][failed][reason=${Ve(e)}]`)}))},this.updateLinks=(e,t)=>{this.ensureLatestTrouterUrl(Za).then((()=>{e(t)})).catch((e=>{this.disposed||this.telemetryHelper.recordEvent(io,{causeId:t}),this.logger.warn("Failed to update links")}))},this.startCallPreheatTimer=e=>{this.timeoutManager.startTimer(Zr.TIMEOUT_OPERATIONS.MAX_PREAHEATED_TIMEOUT,(()=>{this.handleCallEstablishmentTimeout(e,Zr.CALL_END_SUB_CODE.PREHEATED_CALL_TIMEDOUT,"Preheat timed out!"),this.terminateEstablishedCall({code:Zr.CALL_END_CODE.TIMEOUT,subCode:Zr.CALL_END_SUB_CODE.PREHEATED_CALL_TIMEDOUT,phrase:"Preheat timed out!"},{forEveryone:!1,causeId:e})}),Zr.TIMEOUT_VALUES_IN_SECONDS.MAX_PREAHEATED_TIMEOUT)},this.stopCallPreheatTimer=()=>{this.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.MAX_PREAHEATED_TIMEOUT)},this.updateKeepAliveUrl=()=>{var e;this.logger.info("updateKeepAliveUrl"),this.links.hasOwnProperty(Zr.LINKS.KEEPALIVE)?(this.linkUpdateRequested.keepAliveLinks=!1,this.logger.info("updateKeepAliveUrl, sending request"),this.sendToKeepAliveUrl((hs(e=this,"signalingSession cannot be null"),{payload:{callParticipantUpdate:{links:gs(e,Mr),clientContentForMediaController:e.webRtcSignalingManager.getClientUrls()}}}))):this.linkUpdateRequested.keepAliveLinks=!0},this.updateConversationLinks=(e=os())=>{this.logger.info(`[${e}][updateConversationLinks]`),this.telemetryHelper.recordEvent(pl,{causeId:e}),this.links.hasOwnProperty(Zr.LINKS.NOTIFICATION_LINKS)?(this.linkUpdateRequested.conversationLinks=!1,this.logger.info("updateConversationLinks, sending request"),this.sendToUpdateConversationLinks(!0)):this.linkUpdateRequested.conversationLinks=!0},this.sendAttachToCallInternal=(e=os())=>{this.telemetryHelper.recordEvent(cl,{causeId:e}),this.logger.info(`[${e}][sendAttachToCallInternal]`);const t=new ts;return this.signalingAgentConfig.sendProgressFromCC&&t.set(Zr.HEADERS.CACHE_SKYPE_TOKEN,"1"),this.http.sendPostRequest({url:this.incomingCallPayload.callNotification.links.attach,customHeaders:t,requestName:cc.SEND_CALL_ATTACH.name,payload:gh(this,this.incomingCallPayload.conversationInvitation.conversationController,!this.getInitialMediaOfferFromIncomingCallPayload()),causeId:e}).then((t=>{if(!this.disposed){this.processAttachResponse(this.incomingCallPayload,t,e);const i=t.response.additionalActionResponses;i&&i.length>0&&this.processConversationServiceResponse(i[0].output,e,0),this.onCallStatusChanged(Zr.CALL_STATUS.RINGING,e),this.telemetryHelper.setTimeToRingDuration(),this.handleBrokerSubscription(t.response.callInvitation,e)}})).catch((t=>{const i=Cs(t,this.signalingAgentConfig);this.logger.info(`[${e}][sendAttachToCallInternal] error: ${Ve(t)} xhrError: ${Ve(i)}`),this.disposed||(this.fsmState=Zr.SIGNALING_FSM_STATE.IDLE,this.telemetryHelper.setTerminatingData({terminatingEnd:hc.CALL_TERMINATING_END.LOCAL,resultValue:hc.RESULT_VALUE.FAILURE,endCode:i.telemetryEndSubCode,endSubCode:i.error.subCode,resultCategories:i.error.resultCategories,resultDetail:i.error.phrase||this.getTerminatingCallResultDetail("attach",i.error),causeId:e}),this.onCallStatusChanged(Zr.CALL_STATUS.LOCAL_TERMINATED,e,i.error),this.dispose(i.error,e))}))},this._processCallAcceptance=(e,t)=>{if(this.logger.info(`[${t}][_processCallAcceptance]`),this.fsmState===Zr.SIGNALING_FSM_STATE.OUTGOING){this.processCallAcceptance(e.body,t),this.telemetryHelper.setTimeToRingDuration();try{this.multiParty||this.callUsesMixer||this.participantManager.handleRosterUpdate(this.getFakeRoster(e.body),!0,t)}catch(i){const n={code:Zr.CALL_END_CODE.BAD_SERVICE_RESPONSE,subCode:Zr.CALL_END_SUB_CODE.CALL_ACCEPTANCE_INVALID_SERVICE_RESPONSE,phrase:i?.toString()};throw this.logger.info(`[${t}][_processCallAcceptance] ${He(n)}`),this.telemetryHelper.recordRosterEvent(e,_a,t),n}}},this.restartKeepAliveInterval=(e=!1,t)=>{this.disposed||(e&&this.telemetryHelper.recordEvent(_l,t),this.keepAliveTimer=window.setInterval(this.sendKeepAlive.bind(this),this.keepAliveInterval))},this.isCallOngoing=()=>this.fsmState===Zr.SIGNALING_FSM_STATE.CONNECTED||this.fsmState===Zr.SIGNALING_FSM_STATE.IDLE,this.isCallIdleOrRosterOnly=()=>this.fsmState===Zr.SIGNALING_FSM_STATE.IDLE||this.fsmState===Zr.SIGNALING_FSM_STATE.OUTGOING_FOR_ROSTER_ONLY||this.fsmState===Zr.SIGNALING_FSM_STATE.CONNECTED_FOR_ROSTER_ONLY,this.isCallConnectedOrConnectedForRoster=()=>this.fsmState===Zr.SIGNALING_FSM_STATE.CONNECTED||this.fsmState===Zr.SIGNALING_FSM_STATE.CONNECTED_FOR_ROSTER_ONLY,s&&(this.callStartTime=s),this.signalingSessionCallback=t,this.signalingAgentConfig=i,this.signalingAgent=r,this.urlIdentifier=n,this.piiUtils=new vc(i.piiScrubber),this.isHostLessCall=i.doHostlessCalling||!1,this.logger=i.logger.createChild((()=>`CSA[${this.correlationId}][${this.fsmState}]`),this.correlationId,!0),this.updateCorrelationId(n),this.logger.info(`[endpointId=${Be(this.signalingAgent.endpointId)}]`),this.logger.info(`[participantId=${e.participantId}]`),this.callOperationHandler=new Lc(this.logger.createChild((()=>`[CallOperationHandler][${e.participantId}]`))),this.http=new Jc(this,this.callStartTime),this.telemetryHelper=new Fh(this,e,this.callStartTime),this.mediaRenegotiationManager=new Zc(this,t,this.telemetryHelper),this.participantManager=new dh(this,t,e,new ti(this.logger)),this.proxiedMessageNotificationManager=new ph(this),this.timeoutManager=new mc(this.logger),this.contentSharingManager=new Bc(this,t),this.webRtcSignalingManager=new Uh(this,t),this.pstnContent={emergencyCallCountry:i.emergencyCallCountry||"",platformName:i.clientInformation,publicApiCall:!1},this.setupTrouterChannel(),this.setupConnectionCheck()}onPromotionCompleted(e,t,i){this.logger.info(`[${i}][onPromotionCompleted] isFailed=${e} error=${Ve(t)}]`),this.isPromotingToRealtime=!1,this.signalingSessionCallback.onPromotionCompleted(e,t,i)}setRealTimeState(e,t){let i=e;(2===e&&1===this.realTimeState||1===e&&2===this.realTimeState)&&(i=3),i!==this.realTimeState&&(this.logger.info(`[${t}][setRealTimeState] changed: input=${e} old=${this.realTimeState}, new=${i}`),this.realTimeState=i,3===i?this.setCallMode(1,t):0!==this.callMode||2!==i&&(this.signalingAgentConfig.disableRealTimeModeFromRoster||1!==i)||this.setCallMode(1,t))}setCallMode(e,t){this.callMode!==e&&(this.logger.info(`[${t}][setCallMode] oldMode=${this.callMode}, newMode=${e}`),this.callMode=e,this.signalingSessionCallback.onCallModeChanged(this.callMode,t))}configureStreamingMode(e){2!==this.callMode?(this.logger.info(`[${e}][configureStreamingMode]`),this.setCallMode(2,e),this.cleanUpDueToStreaming(e),this.onCallStatusChanged(Zr.CALL_STATUS.CONNECTED,e)):this.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT)}updateDominantSpeakerHistoryMessageSubscription(e){this.webRtcSignalingManager.getIsDominantSpeakerInfoLinkEnabled()!==e&&(this.logger.info(`Signaling dominant speaker history subscription updated: ${e}`),this.webRtcSignalingManager.setIsDominantSpeakerInfoLinkEnabled(e),this.webRtcSignalingManager.areClientURLsGenerated()&&this.updateKeepAliveUrl())}cleanUpDueToStreaming(e){this.setRealTimeState(0,e),this.fsmState=Zr.SIGNALING_FSM_STATE.CONNECTED,this.isPromotingToRealtime=!1,this.provisionalMediaAnswersSeenSoFar=[],this.mediaRenegotiationManager?.dispose(),this.mediaRenegotiationManager=new Zc(this,this.signalingSessionCallback,this.telemetryHelper),this.keepAliveTimer&&window.clearInterval(this.keepAliveTimer),this.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT);const t={code:Zr.CALL_END_CODE.SUCCESS,subCode:Zr.CALL_END_SUB_CODE.DOWNGRADE_TO_STREAMING_CLIENT,phrase:Zr.CALL_END_PHRASE.DOWNGRADE_TO_STREAMING_CLIENT},i=cc;for(const n of Object.keys(i))0!==i[n].controller&&4!==i[n].controller&&3!==i[n].controller||this.http.cancelRequestIfPending(i[n].name,e,void 0,t)}updateEndpointMetadata(e,t=os()){let i={};try{i=JSON.parse(e)}catch(e){return Promise.reject("Invalid metadata")}return this.http.sendPutRequest({url:this.links[Zr.LINKS.UPDATE_ENDPOINT_METADATA],requestName:cc.UPDATE_ENDPOINT_METADATA.name,payload:wh(this,i),causeId:t}).then((()=>{this.telemetryHelper.recordEvent(Ql,{causeId:t})})).catch((e=>{const i=Cs(e,this.signalingAgentConfig);return this.logger.info(`[${t}][updateEndpointMetadata] error: ${Ve(i)}`),this.telemetryHelper.recordEvent(Xl,{...i.error}),Promise.reject(i.error)}))}isOneToOnePSTNCall(){return this.signalingSessionCallback.isOneToOnePstnCall()}getLocationContent(){return this.isOneToOnePSTNCall()?ys(this.locationInfoContent):null}getNetworkContent(){return this.isOneToOnePSTNCall()?ys(this.networkInfoContent):null}getAreaContent(){return this.isOneToOnePSTNCall()?ys(this.areaContent):null}setLocationInfo(e,t,i){this.locationInfoContent=e,this.networkInfoContent=t,this.areaContent=i}setStreamInformationReceived(){this.disposed||this.streamInformationReceived||(this.streamInformationReceived=!0,this.telemetryHelper.recordEvent(ic))}getEndpointCapabilities(){let e=0;return this.signalingAgentConfig.brokerEnabledIncoming&&(e|=16),this.signalingAgentConfig.isGVCJoiningEnabled&&(e|=1),"disabled"!==this.signalingAgentConfig.cloudScreenSharingFlag&&(e|=2),this.signalingAgentConfig.supportsHostlessGroupCalls&&(e|=4),this.signalingAgentConfig.autoJoinOnConflict&&(e|=32),this.signalingAgentConfig.supportsCompressedServicePayload&&(e|=128),this.signalingAgentConfig.enableAutoPromotion&&(e|=65536),this.signalingAgentConfig.enableBatchedSendMessageStatus&&(e|=16384),this.signalingAgentConfig.enableBatchedReceiveMessage&&(e|=8192),e|=64,e|=1024,this.signalingAgent?.accountConfig?.clientSupportsAudioOnlyWatermark&&(e|=4096,this.telemetryHelper.setAudioOnlyWatermark(!0)),this.signalingAgent?.accountConfig?.clientSupportsWatermark&&(e|=2048,this.telemetryHelper.setWatermarkSupport(!0)),(this.getMaxReinvitelessMediaForVBSSForWeb()||this.getMaxReinvitelessMediaForVideoForWeb())&&(this.telemetryHelper.setReinviteless(this.callUsesMixer),e|=512),e}handleAdmitAllStatus(e){const t=e.body?.transactionResponse,i=_s(e);this.logger.info(`[${i}][handleAdmitAllStatus][${Ve(t)}]`);const n=t?.operationId;if(n&&this.callOperationHandler.hasPendingOperation(0,n,i)){this.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.ADMIT,n);const e=t?.result?.code,r=t?.result?.subCode,s=t?.result?.resultCategories,a=t?.additionalDetail;if(0===e||e>=200&&e<300){const t={code:e,subCode:r,resultCategories:s,result:He(a)};this.telemetryHelper.recordEvent(la,{causeId:n,transactionEnd:t}),this.callOperationHandler.resolvePendingOperation(0,n,t,i)}else{const a={code:e||Zr.CALL_END_CODE.BAD_REQUEST,subCode:r||0,resultCategories:s,result:t,phrase:Zr.CALL_END_PHRASE.BAD_SERVICE_RESPONSE};this.telemetryHelper.recordEvent(oa,{causeId:n,transactionEnd:a}),this.callOperationHandler.rejectPendingOperation(0,n,"AdmitAllStatus response contains failure",a,i)}}else this.logger.warn(`[${i}][handleAdmitAllStatus] invalid admitAllStatus response or no pending operation. operationId=${n}`)}sendNetworkRequestForAdmit(e){var t,i;this.http.sendPostRequest({url:this.links[Zr.LINKS.ADMIT_ALL],requestName:cc.ADMIT.name,payload:(t=this,i=e,hs(t,"signalingSession cannot be null"),{payload:{participants:{from:{id:t.participantManager.localParticipant.id,displayName:t.participantManager.localParticipant.displayName,endpointId:t.participantManager.localParticipant.endpointId,participantId:t.participantManager.localParticipant.participantId,languageId:t.participantManager.localParticipant.languageId}},links:{admitAllStatus:is(t,Dr.CONV_ADMIT_ALL_STATUS)},operationId:i,debugContent:{causeId:i}}}),causeId:e,onceTrouterReady:()=>{this.timeoutManager.startTimer(Zr.TIMEOUT_OPERATIONS.ADMIT,(()=>{this.telemetryHelper.recordEvent(aa,{causeId:e}),this.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.ADMIT,e),this.callOperationHandler.rejectPendingOperation(0,e,"timed out waiting for admit operation",{code:Zr.CALL_END_CODE.TIMEOUT,subCode:Zr.CALL_END_SUB_CODE.ADMIT_TIMEOUT,phrase:Zr.CALL_END_PHRASE.ADMIT_TIMEOUT},e)}),Zr.TIMEOUT_VALUES_IN_SECONDS.ADMIT_TIMEOUT,e)}}).catch((t=>{const i=Cs(t,this.signalingAgentConfig);this.telemetryHelper.recordEvent(oa,{causeId:e,...i.error}),this.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.ADMIT,e),this.callOperationHandler.rejectPendingOperation(0,e,t,i.error,e)}))}getConversationType(e,t,i){return e?"emergencyGroupCall":t?"cast":i?"huddleGroupCall":null}getMaxReinvitelessMediaForVideoForWeb(){return this.signalingAgentConfig.maxReinvitelessMediaForVideoForWeb}getMaxReinvitelessMediaForVBSSForWeb(){return this.signalingAgentConfig.maxReinvitelessMediaForVBSSForWeb}convertParkType(e){return"teamPark"===e?"TransferTypeTeamPark":"sharedLinePark"===e?"TransferTypeSharedLinePark":"serverHold"===e?"TransferTypeServerHold":(this.logger.info(`convertParkType, parkType: ${e} is unknown`),"none")}parkByTransfer(e,t){this.timeoutManager.startTimer(Zr.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT,(()=>{this.handleCallTransferTimeout(t)}),Zr.TIMEOUT_VALUES_IN_SECONDS.OUTGOING_CALL_ESTABLISHMENT_TIMEOUT);const i=this.getNetworkRequestName(e);var n,r;return this.http.sendPostRequest({url:this.links[Zr.LINKS.TRANSFER],requestName:i,payload:(n=e,r=this,hs(r,"signalingSession cannot be null"),{payload:{callTransfer:{target:{id:r.participantManager.localParticipant.id},transferor:{details:{id:r.participantManager.localParticipant.id,endpointId:r.participantManager.localParticipant.endpointId,participantId:r.participantManager.localParticipant.participantId,languageId:r.participantManager.localParticipant.languageId},authorizationToken:null},parkType:n,links:{transferAcceptance:is(r,Dr.TRANSFER_ACCEPTANCE),transferCompletion:is(r,Dr.TRANSFER_COMPLETION)}}}}),causeId:t}).catch((e=>{const i=Cs(e,this.signalingAgentConfig);return this.logger.info(`[${t}][parkByTransfer] error: ${Ve(i)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.signalingSessionCallback.onTransferCompleted({transferCompletion:{code:Zr.CALL_END_CODE.NETWORK_ERROR,reason:Ve(e)}},t),this.telemetryHelper.recordEvent(Dl,{causeId:t,...i.error}),Promise.reject(i.error))})),this.telemetryHelper.recordEvent(Ml,{causeId:t,transferType:this.convertParkType(e)}),Promise.resolve()}park(e,t){this.logger.info(`[${t}][park] context ${e}`),this.timeoutManager.startTimer(Zr.TIMEOUT_OPERATIONS.PARK_COMPLETION,(()=>{this.handleParkError({code:Zr.CALL_END_CODE.TIMEOUT,subCode:Zr.CALL_END_SUB_CODE.PARK_COMPLETION_TIMEOUT,phrase:Zr.CALL_END_PHRASE.PARK_COMPLETION_TIMEOUT},sd,t,e)}),Zr.TIMEOUT_VALUES_IN_SECONDS.PARK_COMPLETION_TIMEOUT);const i=this.getHoldTypeInRequest(e),n={causeId:t};return this.http.sendPostRequest({url:this.links[Zr.LINKS.PARK],requestName:cc.PARK_REQUEST.name,payload:Eh(this,i,n),causeId:t}).then((e=>{this.logger.info(`[${t}][park] response: ${Ve(e)}`),this.telemetryHelper.recordEvent(rd,{causeId:t}),hs(e.response.holdResponse.links,"server response does not include park links"),this.links[Zr.LINKS.UNPARK]=e.response.holdResponse.links.resume})).catch((i=>{const n=Cs(i,this.signalingAgentConfig);return this.logger.info(`[${t}][park] error: ${Ve(n)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.handleParkError(n.error,nd,t,e),Promise.reject(n.error))})),Promise.resolve()}getHoldTypeInRequest(e){switch(e){case"serverHoldV2":return"musicOnHold";case"sharedLineParkV2":return"sharedLineAppearance";case"callPark":return"callPark";default:return null}}handleParkError(e,t,i,n){this.disposed?this.logger.info("handleParkError ignored"):(this.logger.info(`[${i}] handleParkError reject reason: ${Ve(e)}`),this.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.PARK_COMPLETION),this.signalingSessionCallback.onParkCompleted&&(this.telemetryHelper.recordEvent(t,{...e,parkContext:n,causeId:i}),this.signalingSessionCallback.onParkCompleted(e,i)),this.links[Zr.LINKS.UNPARK]=void 0)}handleParkCompletion(e){const t=e.body,i=_s(e),n=t.holdCompletion;this.handleOperationCompletionCommon(n,i,void 0,Ve(t),"handleParkCompletion",Zr.TIMEOUT_OPERATIONS.PARK_COMPLETION,ad,od,this.signalingSessionCallback.onParkCompleted,this.handleParkError.bind(this))}handleUnparkError(e,t,i,n){this.disposed?this.logger.info("handleUnparkError ignored"):(this.logger.info(`[${i}] handleUnparkError reject reason: ${e}`),this.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.UNPARK_COMPLETION),this.signalingSessionCallback.onUnparkCompleted&&(this.telemetryHelper.recordEvent(t,{...e,parkContext:n,causeId:i}),this.signalingSessionCallback.onUnparkCompleted(e,i)),this.links[Zr.LINKS.UNPARK]=void 0)}handleUnparkCompletion(e){const t=e.body,i=_s(e);if(this.disposed)return void this.logger.info(`[${i}]handleUnparkCompletion ignored`);this.logger.info(`[${i}][handleUnparkCompletion] body ${Ve(t)}`);const n=t.resumeCompletion;n.code===Zr.TRANSACTION_END_CODE.SUCCESS?(this.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.UNPARK_COMPLETION),this.telemetryHelper.recordEvent(hd,{...n,causeId:i}),this.signalingSessionCallback.onUnparkCompleted(n,i),this.links[Zr.LINKS.UNPARK]=void 0):this.handleUnparkError(n,ud,i)}getNetworkRequestName(e){return{none:null,teamPark:cc.SEND_PARK_REQUEST.name,sharedLinePark:cc.SEND_SHARED_LINE_PARK_REQUEST.name,serverHold:cc.SEND_SERVER_HOLD_REQUEST.name}[e]}updateMeetingsGroupsAsync(e,t){this.logger.info(`[${e}][updateMeetingsGroupsAsync] scope=${t.scope}`),this.telemetryHelper.recordEvent(vd,{causeId:e,options:t}),this.timeoutManager.startTimer(Zr.TIMEOUT_OPERATIONS.UPDATE_MEETING_GROUPS_COMPLETION,(()=>{this.handleUpdateMeetingGroupsError({code:Zr.CALL_END_CODE.TIMEOUT,subCode:Zr.CALL_END_SUB_CODE.UPDATE_MEETING_GROUPS_COMPLETION_TIMEOUT,phrase:Zr.CALL_END_PHRASE.UPDATE_MEETING_GROUPS_COMPLETION_TIMEOUT},bd,e,e,t)}),Zr.TIMEOUT_VALUES_IN_SECONDS.UPDATE_MEETING_GROUPS_COMPLETION_TIMEOUT);const i=function(e,t,i){hs(e,"signalingSession cannot be null");const{scope:n,toGroup:r,fromGroup:s,participants:a}=t;"specified"===n&&hs(a,"participantsIds cannot be null");const o={from:{id:e.participantManager.localParticipant.id,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId,displayName:e.participantManager.localParticipant.displayName},scope:n,fromGroup:s,toGroup:r,links:{updateMeetingGroupsStatus:is(e,Dr.UPDATE_MEETING_GROUPS_STATUS)},operationId:i};return a&&(o.to=a.map((e=>({id:e.mri,endpointId:e.endpointId,participantId:e.participantId})))),{payload:o}}(this,t,e);return this.http.sendPostRequest({url:this.links[Zr.LINKS.UPDATE_MEETING_GROUPS],requestName:cc.UPDATE_MEETING_GROUPS.name,payload:i,causeId:e}).then((t=>{this.logger.info(`[${e}][updateMeetingsGroupsAsync] response: ${Ve(t)}`),this.telemetryHelper.recordEvent(bd,{causeId:e})})).catch((i=>{const n=Cs(i,this.signalingAgentConfig);return this.logger.info(`[${e}][updateMeetingsGroupsAsync] error: ${Ve(n)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.handleUpdateMeetingGroupsError(n.error,Pd,e,e,t),Promise.reject(n.error))}))}updateParticipantInterpretationStateAsync(e,t){return cs(t,"options should be a non null value"),this.logger.info(`[${e}][updateParticipantInterpretationStateAsync]`),this.telemetryHelper.recordEvent(yd,{causeId:e,options:t}),this.participantManager.updateParticipantInterpretationStateAsync(t,this.links[Zr.LINKS.UPDATE_PARTICIPANT_INTERPRETATION_STATE],e)}async sendProxiedMessageAsync(e,t){return t&&0!==t.length?this.links[Zr.LINKS.SEND_MESSAGE]?this.proxiedMessageNotificationManager.sendProxiedMessageAsync(e,t,this.links[Zr.LINKS.SEND_MESSAGE]):Promise.reject({code:Zr.VALIDATION.VALIDATION_FAILED,subCode:Zr.VALIDATION.NULL_OR_EMPTY,phrase:"missing url for CONSTANTS.LINKS.SEND_MESSAGE"}):Promise.reject({code:Zr.VALIDATION.VALIDATION_FAILED,subCode:Zr.VALIDATION.NULL_OR_EMPTY,phrase:"options should be a non empty array"})}async updateParticipantsPropertiesAsync(e,t,i,n){this.telemetryHelper.recordEvent(Cd,{causeId:n,updateParticipantsPropertiesContext:e});const r=this.links[Zr.LINKS.UPDATE_PARTICIPANTS_PROPERTIES],s=[],a=e.scope;if("self"===a){const t={id:this.participantManager.localParticipant.id,propertyBag:e.propertyBag};s.push(t)}else{if("specified"!==a)return Promise.reject("This scope is not Supported");{const t=e.participants;for(const e of t){const t={id:e.id,propertyBag:e.propertyBag};s.push(t)}}}return this.sendNetworkRequestForUpdateParticipantsProperties(s,t,r,i,n)}sendNetworkRequestForUpdateParticipantsProperties(e,t,i,n,r){const s=this.logger.createChild(`[${r}][sendNetworkRequestForUpdateParticipantsProperties]`,this.correlationId);if(i){const a=()=>{const e={code:Zr.CALL_END_CODE.TIMEOUT,subCode:Zr.CALL_END_SUB_CODE.UPDATE_PARTICIPANTS_PROPERTIES_TIMEOUT,phrase:Zr.CALL_END_PHRASE.UPDATE_PARTICIPANTS_PROPERTIES_TIMEOUT};this.timeoutManager.startTimer(Zr.TIMEOUT_OPERATIONS.UPDATE_PARTICIPANTS_PROPERTIES_COMPLETION,(()=>{this.handleUpdateParticipantsPropertiesOnTimeout(t,e,xd,n,r)}),Zr.TIMEOUT_VALUES_IN_SECONDS.UPDATE_PARTICIPANTS_PROPERTIES_COMPLETION_TIMEOUT,n)},o=function(e,t,i){return hs(e,"signalingSession cannot be null"),{payload:{from:{id:e.participantManager.localParticipant.id,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId},to:t,links:{updateParticipantPropertiesStatus:is(e,Dr.UPDATE_PARTICIPANT_PROPERTIES_STATUS)},operationId:i}}}(this,e,n);return this.updateParticipantsPromises[n]=t,this.http.sendPostRequest({url:i,payload:o,requestName:cc.UPDATE_PARTICIPANTS_PROPERTIES.name,onceTrouterReady:a,causeId:r}).then((e=>{s.info(`response: ${Ve(e)}`)})).catch((e=>{const t=Cs(e,this.signalingAgentConfig);s.info(`failed: ${Ve(t)}`);const i={...t.error};return this.disposed||(this.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.UPDATE_PARTICIPANTS_PROPERTIES_COMPLETION,n),delete this.updateParticipantsPromises[n]),this.telemetryHelper.recordEvent(Fd,{causeId:r,transactionEnd:i}),Promise.reject(i)}))}{const e={code:Zr.CALL_END_CODE.REJECT,subCode:Zr.CALL_END_SUB_CODE.UPDATE_PARTICIPANTS_PROPERTIES_LINK_MISSING,phrase:"updateParticipantsProperties link is missing"};return s.warn(e),this.telemetryHelper.recordEvent(Fd,{causeId:r,error:e}),Promise.reject(e)}}checkAndCleanupPromisesForOperationId(e){this.updateParticipantsPromises[e]&&(0===this.updateParticipantsPromises[e].size?(delete this.updateParticipantsPromises[e],this.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.UPDATE_PARTICIPANTS_PROPERTIES_COMPLETION,e)):this.logger.info(`remaining promises for the operation  ${e} (count: ${this.updateParticipantsPromises[e].size}): \n                ${this.piiUtils.scrubMriOrOmit(He(this.updateParticipantsPromises[e]))}`))}handleUpdateParticipantsPropertiesOnTimeout(e,t,i,n,r){if(this.disposed)return void this.logger.info("handleUpdateParticipantsPropertiesOnTimeout ignored");this.logger.createChild(`[${r}][handleUpdateParticipantsPropertiesOnTimeout]`,this.correlationId).info(`reason: ${t}`),this.telemetryHelper.recordEvent(i,{...t,causeId:r});const s={};e.forEach((e=>{s[e]=t,this.updateParticipantsPromises[n].delete(e)})),this.checkAndCleanupPromisesForOperationId(n),this.signalingSessionCallback.onUpdateParticipantsPropertiesCompleted(s,n,r)}joinMeetingGroupAsync(e,t){this.logger.info(`[${e}][joinMeetingGroupAsync]`),this.telemetryHelper.recordEvent(Td,{causeId:e,options:t}),this.timeoutManager.startTimer(Zr.TIMEOUT_OPERATIONS.JOIN_MEETING_GROUP_COMPLETION,(()=>{this.handleJoinMeetingGroupError({code:Zr.CALL_END_CODE.TIMEOUT,subCode:Zr.CALL_END_SUB_CODE.JOIN_MEETING_GROUP_TIMEOUT,phrase:Zr.CALL_END_PHRASE.JOIN_MEETING_GROUP_TIMEOUT},Vd,e,e,t)}),Zr.TIMEOUT_VALUES_IN_SECONDS.JOIN_MEETING_GROUP_COMPLETION_TIMEOUT);const i=function(e,t,i){hs(e,"signalingSession cannot be null");const{meetingGroupId:n,groupPreferences:r}=t;return{payload:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},meetingGroup:n,...r&&{groupPreferences:r},links:{joinMeetingGroupStatus:is(e,Dr.JOIN_MEETING_GROUP_STATUS)},operationId:i}}}(this,t,e);return this.http.sendPostRequest({url:this.links[Zr.LINKS.JOIN_MEETING_GROUP],requestName:cc.JOIN_MEETING_GROUP.name,payload:i,causeId:e}).then((t=>{this.logger.info(`[${e}][joinMeetingGroupAsync] response: ${Ve(t)}`),this.telemetryHelper.recordEvent(Vd,{causeId:e})})).catch((i=>{const n=Cs(i,this.signalingAgentConfig);return this.logger.info(`[${e}][joinMeetingGroupAsync] error: ${Ve(n)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.handleJoinMeetingGroupError(n.error,Hd,e,e,t),Promise.reject(n.error))}))}leaveMeetingGroupAsync(e,t){this.logger.info(`[${e}][leaveMeetingGroupAsync]`),this.telemetryHelper.recordEvent(Ed,{causeId:e,options:t}),this.timeoutManager.startTimer(Zr.TIMEOUT_OPERATIONS.LEAVE_MEETING_GROUP_COMPLETION,(()=>{this.handleLeaveMeetingGroupError({code:Zr.CALL_END_CODE.TIMEOUT,subCode:Zr.CALL_END_SUB_CODE.LEAVE_MEETING_GROUP_TIMEOUT,phrase:Zr.CALL_END_PHRASE.LEAVE_MEETING_GROUP_TIMEOUT},jd,e,e,t)}),Zr.TIMEOUT_VALUES_IN_SECONDS.LEAVE_MEETING_GROUP_COMPLETION_TIMEOUT);const i=function(e,t,i){hs(e,"signalingSession cannot be null");const{meetingGroupId:n}=t;return{payload:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId},meetingGroup:n,links:{leaveMeetingGroupStatus:is(e,Dr.LEAVE_MEETING_GROUP_STATUS)},operationId:i}}}(this,t,e);return this.http.sendPostRequest({url:this.links[Zr.LINKS.LEAVE_MEETING_GROUP],requestName:cc.LEAVE_MEETING_GROUP.name,payload:i,causeId:e}).then((t=>{this.logger.info(`[${e}][leaveMeetingGroupAsync] response: ${Ve(t)}`),this.telemetryHelper.recordEvent(jd,{causeId:e})})).catch((i=>{const n=Cs(i,this.signalingAgentConfig);return this.logger.info(`[${e}][leaveMeetingGroupAsync] error: ${Ve(n)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.handleLeaveMeetingGroupError(n.error,Gd,e,e,t),Promise.reject(n.error))}))}handleUpdateMeetingGroupsError(e,t,i,n,r){this.disposed?this.logger.info(`[${i}][handleUpdateMeetingGroupsError] ignored. Call disposed, err: ${JSON.stringify(e)}`):(this.logger.info(`[${i}][handleUpdateMeetingGroupsError] reject reason: ${JSON.stringify(e)}`),this.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.UPDATE_MEETING_GROUPS_COMPLETION),this.telemetryHelper.recordEvent(t,{...e,updateMeetingGroupsOptions:r,causeId:i}),this.signalingSessionCallback.onUpdateMeetingGroupsCompleted(e,i,n))}handleUpdateMeetingGroupsCompletion(e){const t=e.body,i=_s(e),n=t.updateMeetingGroupsResponse.operationId;if(this.disposed)return void this.logger.info(`[${i}][handleUpdateMeetingGroupsCompletion] ignored. Call disposed.`);n||this.logger.warn(`[${i}][handleUpdateMeetingGroupsCompletion] operationId is undefined.`),this.logger.info(`[${i}][handleUpdateMeetingGroupsCompletion] starts`);const{updateMeetingGroupsResponse:r}=t,s=wc(r);s.code===Zr.TRANSACTION_END_CODE.SUCCESS?(this.logger.info(`[${i}][handleUpdateMeetingGroupsCompletion] update meeting group succeeded`),this.telemetryHelper.recordEvent(Ad,{...s,causeId:i})):(this.logger.info(`[${i}][handleUpdateMeetingGroupsCompletion] update meeting group failed code=${s.code} subCode=${s.subCode}`),this.telemetryHelper.recordEvent(Id,{...s,causeId:i})),this.logger.info(`[${i}][handleUpdateMeetingGroupsCompletion] completes`),this.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.UPDATE_MEETING_GROUPS_COMPLETION),this.signalingSessionCallback.onUpdateMeetingGroupsCompleted(s,i,n)}handleJoinMeetingGroupError(e,t,i,n,r){this.disposed?this.logger.info(`[${i}][handleJoinedMeetingGroupError] ignored. Call disposed, err: ${JSON.stringify(e)}`):(this.logger.info(`[${i}][handleJoinedMeetingGroupError] reject reason: ${JSON.stringify(e)}`),this.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.JOIN_MEETING_GROUP_COMPLETION),this.telemetryHelper.recordEvent(t,{...e,joinMeetingGroupOptions:r,causeId:i}),this.signalingSessionCallback.onJoinMeetingGroupCompleted(e,i,n))}handleJoinMeetingGroupCompletion(e){const t=e.body.joinMeetingGroupResponse,i=_s(e),n=t.operationId;if(this.disposed)return void this.logger.info(`[${i}][handleJoinMeetingGroupCompletion] ignored. Call disposed.`);n||this.logger.warn(`[${i}][handleJoinMeetingGroupCompletion] operationId is undefined.`),this.logger.info(`[${i}][handleJoinMeetingGroupCompletion] starts`);const r=wc(t);r.code===Zr.TRANSACTION_END_CODE.SUCCESS?(this.logger.info(`[${i}][handleJoinMeetingGroupCompletion] join meeting group succeeded`),this.telemetryHelper.recordEvent($d,{...r,causeId:i})):(this.logger.info(`[${i}][handleJoinMeetingGroupCompletion] join meeting group failed code=${r.code} subCode=${r.subCode}`),this.telemetryHelper.recordEvent(Bd,{...r,causeId:i})),this.logger.info(`[${i}][handleJoinMeetingGroupCompletion] complete`),this.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.JOIN_MEETING_GROUP_COMPLETION),this.signalingSessionCallback.onJoinMeetingGroupCompleted(r,i,n)}handleLeaveMeetingGroupError(e,t,i,n,r){this.disposed?this.logger.info(`[${i}][handleLeaveMeetingGroupError] ignored. Call disposed, err: ${JSON.stringify(e)}`):(this.logger.info(`[${i}][handleLeaveMeetingGroupError] reject reason: ${JSON.stringify(e)}`),this.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.LEAVE_MEETING_GROUP_COMPLETION),this.telemetryHelper.recordEvent(t,{...e,leaveMeetingGroupOptions:r,causeId:i}),this.signalingSessionCallback.onLeaveMeetingGroupCompleted(e,i,n))}handleLeaveMeetingGroupCompletion(e){const t=e.body.leaveMeetingGroupResponse,i=_s(e),n=t.operationId;if(this.disposed)return void this.logger.info(`[${i}][handleLeaveMeetingGroupCompletion] ignored. Call disposed.`);n||this.logger.warn(`[${i}][handleLeaveMeetingGroupCompletion] operationId is undefined.`),this.logger.info(`[${i}][handleLeaveMeetingGroupCompletion] starts`);const r=wc(t);r.code===Zr.TRANSACTION_END_CODE.SUCCESS?(this.logger.info(`[${i}][handleLeaveMeetingGroupCompletion] leave meeting group succeeded`),this.telemetryHelper.recordEvent(qd,{...r,causeId:i})):(this.logger.info(`[${i}][handleLeaveMeetingGroupCompletion] leave meeting group failed code=${r.code} subCode=${r.subCode}`),this.telemetryHelper.recordEvent(Wd,{...r,causeId:i})),this.logger.info(`[${i}][handleLeaveMeetingGroupCompletion] complete`),this.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.LEAVE_MEETING_GROUP_COMPLETION),this.signalingSessionCallback.onLeaveMeetingGroupCompleted(r,i,n)}handleDisablePreheatError(e,t,i){this.disposed?this.logger.info(`[${i}][handleDisablePreheatError] ignored. Call disposed, err: ${JSON.stringify(e)}`):(this.logger.info(`[${i}][handleDisablePreheatError] reject reason: ${JSON.stringify(e)}`),this.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.DISABLE_PREHEAT_ASYNC_TIMEOUT),this.telemetryHelper.recordEvent(t,{...e,causeId:i}),this.disablePreheatDefer.isPending()&&this.disablePreheatDefer.reject(e))}handleDisablePreheatCompletion(e){const t=e.body,i=_s(e),n=t.transactionEnd;if(this.disposed)this.logger.info(`[${i}][handleDisablePreheatCompletion] ignored. Call disposed.`);else if(this.disablePreheatDefer.isPending()){if(this.logger.info(`[${i}][handleDisablePreheatCompletion] starts`),this.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.DISABLE_PREHEAT_ASYNC_TIMEOUT),n.code===Zr.TRANSACTION_END_CODE.SUCCESS)this.logger.info(`[${i}][handleDisablePreheatCompletion] update endpoint state succeeded`),this.handleEndpointStateUpdated(i,!0);else if(this.logger.info(`[${i}][handleDisablePreheatCompletion] update endpoint state failed code=${n.code} subCode=${n.subCode}`),this.disablePreheatDefer.isPending()){const e={response:n};this.disablePreheatDefer.reject(e)}}else this.logger.info(`[${i}][handleDisablePreheatCompletion] ignored. Disable preheat promise is resolved/rejected.`)}handleReceiveMessage(e){const t=_s(e);if(this.disposed)return void this.logger.info(`[${t}][handleReceiveMessage] ignored. Call disposed.`);let i;i=Array.isArray(e.body?.messageContent)?e.body.messageContent:[e.body];let n="";const r=[];for(let e=0;e<i.length;e++){const t=i[e];n+=t?.operationId,e<i.length-1&&(n+=","),r.push({operationId:t.operationId,messageType:t.type,payload:t.payload,from:{[t.from.id]:{participantLegIdMap:{[t.from.participantId]:{...t.from.endpointId&&{endpointId:t.from.endpointId}}},level:"endpoint"}}})}this.logger.info(`[${t}][handleReceiveMessage] complete. OperationIds:${n}`),this.telemetryHelper.recordEvent(_d,{causeId:t,operationIds:n}),this.signalingSessionCallback.onIncomingProxiedMessages(r,t)}publishStateAsync(e,t,i,n,r,s){this.logger.info(`[${i}][publishStateAsync][publishType=${e} publishLevel=${t}]`),this.telemetryHelper.recordEvent(Wl,{causeId:i,publishType:e,publishLevel:t});const a=this.links[Zr.LINKS.PUBLISH_STATE];if(!a){const e={code:Zr.CALL_END_CODE.REJECT,subCode:Zr.CALL_END_SUB_CODE.PUBLISH_STATE_LINK_MISSING,phrase:"publish state link is missing"};return this.logger.warn(e),Promise.reject(e)}let o={};try{o=JSON.parse(n)}catch(e){const t={code:Zr.CALL_END_CODE.REJECT,subCode:Zr.CALL_END_SUB_CODE.PUBLISH_STATE_INVALID_CONTENT,phrase:"publish state content is invalid"};return this.logger.warn(t),Promise.reject(t)}return this.http.sendPostRequest({url:a,requestName:cc.PUBLISH_STATE.name,payload:_h(this,e,t,o,r,s),causeId:i,requestId:i}).then((e=>{if(e?.response?.publishStateResponse)return this.parsePublishStateResult(e,i);{const t=`Invalid CS response which does not contains publishStateResponse. Respone: ${e?.response?JSON.stringify(e.response):"no response"}`;throw this.logger.warn(t),{response:{code:Zr.CALL_END_CODE.DECODING_FAILED,subCode:Zr.CALL_END_SUB_CODE.PUBLISH_STATE_INVALID_SERVICE_RESPONSE,phrase:t}}}})).catch((e=>{const t=Cs(e,this.signalingAgentConfig);this.logger.info(`[${i}][publishStateAsync] error: ${Ve(t)}`);const n=t.error;return this.telemetryHelper.recordEvent(ql,{causeId:i,transactionEnd:n}),Promise.reject(n)}))}getPublishStateSequenceNumber(){return++this.publishStateSequenceNumber}parsePublishStateResult(e,t){let i={};if(e?.response?.publishStateResponse){if(e.response.publishStateResponse.stateId)return e.response.publishStateResponse.stateId;if(e.response.publishStateResponse.results){if(1===e.response.publishStateResponse.results.length){if(e.response.publishStateResponse.results[0].stateId)return e.response.publishStateResponse.results[0].stateId;this.logger.warn("invalid response format")}return e.response.publishStateResponse.results.forEach((e=>{i[e.participantId]={code:e.result.code,phrase:e.result.phrase,subCode:e.result.subCode}})),JSON.stringify(i)}if(e.response.publishStateResponse.result)return i={code:e.response.publishStateResponse.result.code,phrase:e.response.publishStateResponse.result.phrase,subCode:e.response.publishStateResponse.result.subCode,result:e.response.publishStateResponse.additionalDetail},JSON.stringify(i)}const n=`Invalid CS response which does not contains publishStateResponse. Respone: ${e?.response?JSON.stringify(e.response):"no response"}`;throw this.logger.warn(n),{response:{code:Zr.CALL_END_CODE.DECODING_FAILED,subCode:Zr.CALL_END_SUB_CODE.PUBLISH_STATE_INVALID_SERVICE_RESPONSE,phrase:n}}}removeStateAsync(e,t,i,n){if(this.logger.info(`[${e}][removeStateAsync][scope=${t} publishType=${i} stateIds=${n}]`),this.telemetryHelper.recordEvent(zl,{causeId:e,scope:t,publishType:i,stateIds:n}),!i&&!n){const e={code:Zr.CALL_END_CODE.REJECT,subCode:Zr.CALL_END_SUB_CODE.REMOVE_STATE_MISSING_ARGUMENTS,phrase:"remove state operation miss arguments"};return this.logger.warn(e),Promise.reject(e)}const r=this.links[Zr.LINKS.REMOVE_STATE];if(!r){const e={code:Zr.CALL_END_CODE.REJECT,subCode:Zr.CALL_END_SUB_CODE.REMOVE_STATE_LINK_MISSING,phrase:"remove state link is missing"};return this.logger.warn(e),Promise.reject(e)}return this.http.sendPostRequest({url:r,requestName:cc.REMOVE_STATE.name,payload:Ph(this,t,n,i),causeId:e,requestId:e}).then((t=>this.parseRemoveStateResult(t,e))).catch((t=>{const i=Cs(t,this.signalingAgentConfig);this.logger.info(`[${e}][removeStateAsync] error: ${Ve(i)}`);const n=i.error;return this.telemetryHelper.recordEvent(Kl,{causeId:e,transactionEnd:n}),Promise.reject(n)}))}parseRemoveStateResult(e,t){let i={};return e?.response?.removeStateResponse&&(e.response.removeStateResponse.results?e.response.removeStateResponse.results.forEach((e=>{i[e.stateId]={code:e.result.code,phrase:e.result.phrase,subCode:e.result.subCode}})):e.response.removeStateResponse.result&&(i={code:e.response.removeStateResponse.result.code,phrase:e.response.removeStateResponse.result.phrase,subCode:e.response.removeStateResponse.result.subCode,result:e.response.removeStateResponse.additionalDetail})),JSON.stringify(i)}updateMeetingSettingsAsync(e,t){this.telemetryHelper.recordEvent(Jl,{causeId:t,meetingSettings:e});const i=this.links[Zr.LINKS.UPDATE_MEETING_SETTINGS];if(!i){const e={code:Zr.CALL_END_CODE.REJECT,subCode:Zr.CALL_END_SUB_CODE.UPDATE_MEETING_SETTINGS_LINK_MISSING,phrase:"update meeting settings link is missing"};return this.logger.warn(e),Promise.reject(e)}if(!Object.keys(e).length){const e={code:Zr.CALL_END_CODE.REJECT,subCode:Zr.CALL_END_SUB_CODE.UPDATE_MEETING_SETTINGS_MISSING_ARGUMENTS,phrase:"update meeting settings missing arguments"};return this.logger.warn(e),Promise.reject(e)}return this.http.sendPutRequest({url:i,requestName:cc.UPDATE_MEETING_SETTINGS.name,payload:Oh(this,e),causeId:t,requestId:t}).then((()=>{yc.noop()})).catch((e=>{const i=Cs(e,this.signalingAgentConfig);this.logger.info(`[${t}][updateMeetingSettingsAsync] error: ${Ve(i)}`);const n=i.error;throw this.telemetryHelper.recordEvent(Yl,{causeId:t,transactionEnd:n}),n}))}searchParticipantsAsync(e,t){this.logger.info(`[${t}][searchParticipantsAsync][queryOptions=${e}]`),this.telemetryHelper.recordEvent(Zl,{causeId:t,queryOptions:e});const i=this.links[Zr.LINKS.SEARCH_PARTICIPANTS];if(!i){const e={code:Zr.CALL_END_CODE.REJECT,subCode:Zr.CALL_END_SUB_CODE.SEARCH_PARTICIPANTS_LINK_MISSING,phrase:"search participants link is missing"};return this.logger.warn(e),Promise.reject(e)}return this.http.sendPostRequest({url:i,requestName:cc.SEARCH_PARTICIPANTS.name,payload:(n=this,r=e,{payload:{from:{id:n.participantManager.localParticipant.id,displayName:n.participantManager.localParticipant.displayName,endpointId:n.participantManager.localParticipant.endpointId,participantId:n.participantManager.localParticipant.participantId,languageId:n.participantManager.localParticipant.languageId},searchOptions:r}}),causeId:t,requestId:t}).then((e=>{if(e?.response?.participants)return this.parseSearchParticipantsResult(e,t);{const t=`Invalid CS response which does not contain proper search results. Respone: ${e?.response?JSON.stringify(e.response):"no response"}`;throw this.logger.warn(t),{response:{code:Zr.CALL_END_CODE.DECODING_FAILED,subCode:Zr.CALL_END_SUB_CODE.SEARCH_PARTICIPANTS_INVALID_SERVICE_RESPONSE,phrase:t}}}})).catch((e=>{const i=Cs(e,this.signalingAgentConfig);this.logger.info(`[${t}][searchParticipantsAsync] error: ${Ve(i)}`);const n=i.error;return this.telemetryHelper.recordEvent(td,{causeId:t,transactionEnd:n}),Promise.reject(n)}));var n,r}parseSearchParticipantsResult(e,t){const i=[];if(e?.response){const t=e.response.participants;if(t)for(const n of Object.keys(t))i.push(Us.fromRosterSearchResults(e.response.participants[n]))}return{participants:i}}getAllParticipantsAsync(e,t){this.logger.info(`[${t}][getAllParticipantsAsync][scope=${e}]`),this.telemetryHelper.recordEvent(ed,{causeId:t,scope:e});const i=this.links[Zr.LINKS.GET_ALL_PARTICIPANTS];if(!i){const e={code:Zr.CALL_END_CODE.REJECT,subCode:Zr.CALL_END_SUB_CODE.GET_ALL_PARTICIPANTS_LINK_MISSING,phrase:"get all participants link is missing"};return this.logger.warn(e),Promise.reject(e)}if("lobby"!==e){const e={code:Zr.CALL_END_CODE.REJECT,subCode:Zr.CALL_END_SUB_CODE.GET_ALL_PARTICIPANTS_INVALID_SCOPE,phrase:"get all participants scope is invalid"};return this.logger.warn(e),Promise.reject(e)}return this.http.sendPostRequest({url:i,requestName:cc.GET_ALL_PARTICIPANTS.name,payload:vh(this,e),causeId:t,requestId:t}).then((e=>{if(e?.response)return{participants:e.response.participants};{const e="Invalid CS response which does not contain results.";throw this.logger.warn(e),{response:{code:Zr.CALL_END_CODE.DECODING_FAILED,subCode:Zr.CALL_END_SUB_CODE.GET_ALL_PARTICIPANTS_INVALID_SERVICE_RESPONSE,phrase:e}}}})).catch((e=>{const i=Cs(e,this.signalingAgentConfig);this.logger.info(`[${t}][getAllParticipantsAsync] error: ${Ve(i)}`);const n=i.error;return this.telemetryHelper.recordEvent(id,{causeId:t,transactionEnd:n}),Promise.reject(n)}))}resetState(){this.currentCallStatus=null,this.fsmState=Zr.SIGNALING_FSM_STATE.IDLE}saveUpdatedCallLinksIfAny(e){e.links&&(this.logger.info(`saveUpdatedCallLinksIfAny, updated call links found, update to new links ${Ve(e)}`),this.links[Zr.LINKS.MEDIA_RENEGOTIATION]=e.links.mediaRenegotiation||this.links[Zr.LINKS.MEDIA_RENEGOTIATION],this.links[Zr.LINKS.TRANSFER]=e.links.transfer||this.links[Zr.LINKS.TRANSFER],this.links[Zr.LINKS.REPLACE]=e.links.replacement||this.links[Zr.LINKS.REPLACE],this.links[Zr.LINKS.HANGUP]=e.links.callLeg||this.links[Zr.LINKS.HANGUP],this.links[Zr.LINKS.KEEPALIVE]=e.links.callLeg||this.links[Zr.LINKS.KEEPALIVE],this.links[Zr.LINKS.PARK]=e.links.hold||this.links[Zr.LINKS.PARK],this.links[Zr.LINKS.UPDATE_MEDIA_DESCRIPTIONS]=e.links.updateMediaDescriptions||this.links[Zr.LINKS.UPDATE_MEDIA_DESCRIPTIONS])}ensureMessageChannelReady(e){return this.disposed?(this.logger.info("ensureMessageChannelReady: error: call already disposed"),Promise.reject(this.getCallNotFoundTransactionEnd())):this.brokerService?(this.telemetryHelper.addTrouterWaitOperation(`${hc.TROUTER_WAIT_OPERATION.STARTED}:${e}`),this.telemetryHelper.addTrouterWaitOperation(`${hc.TROUTER_WAIT_OPERATION.ENDED}:${e}`),Promise.resolve()):this.ensureLatestTrouterUrl(e)}ensureLatestTrouterUrl(e){return this.telemetryHelper.addTrouterWaitOperation(`${hc.TROUTER_WAIT_OPERATION.STARTED}:${e}`),this.getTrouterUrlAsync().then((t=>!t||"string"==typeof t&&!t.trim()?(this.telemetryHelper.recordEvent(to),this.telemetryHelper.addTrouterWaitOperation(`${hc.TROUTER_WAIT_OPERATION.ENDED}:${e}`),Promise.reject(new Error("Invalid trouter url"))):this.disposed?(this.logger.info("ensureLatestTrouterUrl, trouterUrlGetter returned too late. Object is already disposed"),Promise.reject(this.getCallNotFoundTransactionEnd())):(this.telemetryHelper.addTrouterWaitOperation(`${hc.TROUTER_WAIT_OPERATION.ENDED}:${e}`),this.baseMessagingChannelUrl=this.currentTrouterUrl=t,Promise.resolve()))).catch((t=>(this.disposed||this.telemetryHelper.addTrouterWaitOperation(`${hc.TROUTER_WAIT_OPERATION.FAILED}:${e}`),this.logger.info(`ensureLatestTrouterUrl, failed because:${t}`),Promise.reject(t))))}signalTransferAcceptedAsync(e,t=os()){return this.logger.info(`[signalTransferAcceptedAsync][${t}] transferType ${e}`),this.disposed?(this.logger.info(`[signalTransferAcceptedAsync][${t}] Call already ended, skip acceptance request`),Promise.reject({code:Zr.CALL_END_CODE.CALL_DOES_NOT_EXIST,reason:null})):(this.telemetryHelper.recordEvent(kl,{causeId:t,transferType:e}),this.http.sendPostRequest({url:this.links[Zr.LINKS.TRANSFER_ACCEPTANCE],requestName:cc.TRANSFER_ACCEPTANCE.name,payload:{payload:{transferAcceptance:{}}},causeId:t}).catch((e=>{const i=Cs(e,this.signalingAgentConfig);return this.logger.info(`[signalTransferAcceptedAsync][${t}] error: ${Ve(i)}`),this.telemetryHelper.recordEvent(Nl,{causeId:t}),Promise.reject(i.error)})))}signalTransferCompletedAsync(e,t=os()){return this.logger.info(`[signalTransferCompletedAsync][${t}] rejectReason ${e}`),this.disposed?(this.logger.info(`[signalTransferCompletedAsync][${t}]  Call already ended by transferor, skip completion request`),Promise.reject({code:Zr.CALL_END_CODE.CALL_DOES_NOT_EXIST,reason:null})):(0!==e.code?this.telemetryHelper.recordEvent(Lo,{code:e.code,subcode:e.subCode,causeId:t}):this.telemetryHelper.recordEvent(Vl,{causeId:t}),this.telemetryHelper.recordEvent(Hl,{causeId:t}),this.http.sendPostRequest({url:this.links[Zr.LINKS.TRANSFER_COMPLETION],requestName:cc.TRANSFER_COMPLETION.name,payload:Ah(e),causeId:t}).catch((e=>{this.telemetryHelper.recordEvent(Bl,{causeId:t});const i=Cs(e,this.signalingAgentConfig);return this.logger.info(`[signalTransferCompletedAsync][${t}] error: ${Ve(i)}`),Promise.reject(i.error)})))}endWithBeacon(e){if(navigator&&navigator.sendBeacon&&!this.disposed){const t={code:Zr.CALL_END_CODE.SUCCESS,subCode:Zr.CALL_END_SUB_CODE.BEACON,phrase:Zr.CALL_END_PHRASE.LOCAL_USER_INITIATED};this.telemetryHelper.recordEvent(Ha,{causeId:e});const i=JSON.stringify(Ch(this,t).payload),n=-1===this.links[Zr.LINKS.LEAVE].indexOf("?")?"?":"&",r=`skypeToken=${this.signalingAgent.authTokenManager.getLastToken(e)}`;return navigator.sendBeacon(`${this.links[Zr.LINKS.LEAVE]}${n}${r}`,i)}return!1}setFsmState(e){this.fsmState=e}setIsHostless(e,t){const i=!!e;this.isHostLessCall!==i&&(this.logger.info(`[${t}][setIsHostless] isHostless=${i}`),this.isHostLessCall=i)}hasGroupModality(){return this.threadId||this.groupId}processConversationServiceResponseHeaders(e,t){this.logger.info(`[${t}][processConversationServiceResponseHeaders]`);try{const i=e.request.getResponseHeader(Zr.HEADERS.CORRELATION_ID)||e.request.getResponseHeader(Zr.HEADERS.CORRELATION_ID.toLowerCase());this.updateCorrelationId(i,t)}catch(e){this.logger.info(`[${t}][processConversationServiceResponseHeaders] failed, reason=${Ve(e)}`)}}processConversationServiceResponse(e,t,i){const n=this.logger.createChild(`[${t}][processConversationServiceResponse]`);if(n.info(`responseType :${i}`),this.processConversationServiceUpdate(e,t),e.subscriptionDetails?.selfParticipant){const i=Us.fromRoster(e.subscriptionDetails.selfParticipant,!0);n.info("converted selfParticipant to Participant type"),this.participantManager.updateLocalParticipantFromSubscribe(i,t)}this.handleBrokerSubscription(e,t),e.roster&&this.internalHandleRosterUpdate(e.roster,!0,t),0===i&&(this.startOrJoinConvResponseReceived=!0,this.handlePendingEndpointState(t))}processConversationServiceUpdate(e,t){const i=this.logger.createChild(`[${t}][processConversationServiceUpdate]`);i.info(),this.convJoined=!0;const n=e.sequenceNumber>=0?e.sequenceNumber:-1;n<this.updateSequenceNumber?i.info(`seqNum=${n} is less than latest seqNum=${this.updateSequenceNumber}`):(this.updateSequenceNumber=n,this.links[Zr.LINKS.CONVERSATION_CONTROLLER]=e.conversationController,this.links[Zr.LINKS.ADD_PARTICIPANT]=e.links.addParticipant,this.links[Zr.LINKS.ADD_PARTICIPANTS_AND_MODALITY]=e.links.addParticipantAndModality,this.links[Zr.LINKS.LEAVE]=e.links.leave,this.links[Zr.LINKS.NOTIFICATION_LINKS]=e.links.notificationLinks,this.links[Zr.LINKS.REMOVE_PARTICIPANT]=e.links.removeParticipant,this.links[Zr.LINKS.ADD_MODALITY]=e.links.addModality,this.links[Zr.LINKS.REMOVE_MODALITY]=e.links.removeModality,this.links[Zr.LINKS.MUTE]=e.links.mute||null,this.links[Zr.LINKS.UNMUTE]=e.links.unmute||null,this.links[Zr.LINKS.ADMIT]=e.links.admit||null,this.links[Zr.LINKS.ADMIT_ALL]=e.links.admitAll||null,this.links[Zr.LINKS.UPDATE_ENDPOINT_STATE]=e.links.updateEndpointState||null,this.links[Zr.LINKS.UPDATE_ENDPOINT_METADATA]=e.links.updateEndpointMetadata||null,this.links[Zr.LINKS.UPDATE_PARTICIPANT_ROLE]=e.links.updateParticipantRole||null,this.links[Zr.LINKS.PUBLISH_STATE]=e.links.publishState||null,this.links[Zr.LINKS.REMOVE_STATE]=e.links.removeState||null,this.links[Zr.LINKS.UPDATE_MEETING_SETTINGS]=e.links.updateMeetingSettings||null,this.links[Zr.LINKS.SEARCH_PARTICIPANTS]=e.links.searchParticipants||null,this.links[Zr.LINKS.GET_ALL_PARTICIPANTS]=e.links.getAllParticipants||null,this.links[Zr.LINKS.UPDATE_MEETING_LIVE_STATE]=e.links.updateMeetingLiveState||null,this.links[Zr.LINKS.UPDATE_MEETING_GROUPS]=e.links.updateMeetingGroups||null,this.links[Zr.LINKS.SET_MEETING_LAYOUT]=e.links.setMeetingLayout||null,this.links[Zr.LINKS.UPDATE_PARTICIPANT_INTERPRETATION_STATE]=e.links.updateParticipantInterpretationState||null,this.links[Zr.LINKS.UPDATE_PARTICIPANTS_PROPERTIES]=e.links.updateParticipantProperties||null,this.links[Zr.LINKS.JOIN_MEETING_GROUP]=e.links.joinMeetingGroup||null,this.links[Zr.LINKS.LEAVE_MEETING_GROUP]=e.links.leaveMeetingGroup||null,this.links[Zr.LINKS.SEND_MESSAGE]=e.links.sendMessage||null,this.links[Zr.LINKS.UPDATE_MEETING_STATES]=e.links.updateMeetingStates||null,this.convSubject=e.subject,e.state&&(this.setMultiParty(e.state.isMultiParty,t),this.setIsHostless(e.state.isHostless||!1,t),this.conversationType=e.state.conversationType,this.isCastCall="cast"===e.state.conversationType,this.isHuddleGroupCall="huddleGroupCall"===e.state.conversationType),e.activeModalities&&e.activeModalities.groupChat&&this.updateGroupChatIds(e.activeModalities.groupChat,t),e.activeModalities&&e.activeModalities.broadcast&&(this.broadcastSession||(this.broadcastSession=new Mc(this,this.signalingSessionCallback)),this.broadcastSession.handleBroadcastDetailsChanged(e,t)),this.handleMeetingDetailsChanged(e,t),this.handleMeetingStatesChanged(e,t),this.linkUpdateRequested.conversationLinks?(i.info("Updating CS links as requested"),this.updateLinks(this.updateConversationLinks,t)):this.scheduleConversationKeepAlive(),e.meetingData&&(this.meetingData=e.meetingData),e.meetingInfo&&(this.meetingInfo=e.meetingInfo),e.region&&(this.region=e.region),e.callLimits&&(this.callLimits=e.callLimits),e.complianceRecordingContent&&(this.complianceRecordingContent=e.complianceRecordingContent),this.signalingSessionCallback.onConversationUpdated({conversationType:this.conversationType,groupId:this.groupId,threadId:this.threadId,teamsMessageId:this.teamsMessageId,isMultiParty:this.multiParty,commandUrlPresence:this.getCommandUrlPresence(),meetingData:this.meetingData,region:this.region,meetingInfo:this.meetingInfo,callLimits:this.callLimits,complianceRecordingContent:this.complianceRecordingContent,isHuddleGroupCall:this.isHuddleGroupCall,backroomThreadId:this.backroomThreadId},t))}processLocalParticipantUpdateResponse(e,t){this.logger.info(`[${t}][processLocalParticipantUpdateResponse]`),e.sequenceNumber&&e.sequenceNumber<this.localParticipantUpdateSequenceNumber||(this.breakoutDetails=e.breakoutDetails||{},this.signalingSessionCallback.onBreakoutDetailsUpdated(this.breakoutDetails,t),!0===e.nudgeToJoinAsRealtime&&(this.telemetryHelper.recordEvent(sc,{causeId:t}),this.signalingSessionCallback.onNudgeToJoinRealtime(t)))}handlePendingEndpointState(e){this.requestedEndpointStateWhileConnecting&&(this.logger.info(`[${e}][handlePendingEndpointState]sending pending endpoint state now that we are connected.`),this.updateEndpointState(this.requestedEndpointStateWhileConnecting,e,this.requestedPublishedStatesWhileConnecting).catch((e=>{this.isPreheatOnly&&this.disablePreheatDefer.isPending()&&(this.logger.info("handlePendingEndpointState failed"),this.disablePreheatDefer.reject(e))})))}handleMeetingDetailsChanged(e,t){this.logger.info(`[${t}][handleMeetingDetailsChanged]`),e.meetingDetails&&!yc.isEqual(e.meetingDetails,this.meetingDetails)&&this.signalingSessionCallback.onMeetingDetailsUpdated&&(this.meetingDetails=e.meetingDetails,this.meetingDetails.meetingCapability?.meetingLiveState&&(this.meetingLiveStateSequenceNumber=this.meetingDetails.meetingCapability.meetingLiveState.seqNum,this.logger.info(`[${t}][handleMeetingDetailsChanged] update meeting seqNum as ${this.meetingLiveStateSequenceNumber}`)),this.signalingSessionCallback.onMeetingDetailsUpdated(this.meetingDetails,t))}handleMeetingStatesChanged(e,t){this.logger.info(`[${t}][handleMeetingStatesChanged]`),this.signalingSessionCallback.onMeetingStatesUpdated&&this.signalingSessionCallback.onMeetingStatesUpdated(e.meetingStates,t)}handleBrokerSubscription(e,t){this.logger.info(`[${t}][handleBrokerSubscription]`),e.links.subscribe?(this.telemetryHelper.recordEvent(zd,t),this.brokerService&&!yc.isEqual(e.links.subscribe,this.brokerService.currentSubscriptionUrl)?this.brokerService.subscribeToBroker(e.links.subscribe):(this.logger.info(`[${t}][handleBrokerSubscription] broker subscribe ignored. Broker is disabled or subscribe url is same.`),this.telemetryHelper.recordEvent(Qo,t))):this.telemetryHelper.recordEvent(Kd,t)}cancelOutgoingCall(e,t){const i=As();this.logger.info(`[${t}][cancelOutgoingCall][rejectionData=${e&&Ve(e)}]`);const n={code:isNaN(e?.code)?Zr.CALL_END_CODE.CANCEL:e.code,subCode:e?.subCode||Zr.CALL_END_SUB_CODE.SUCCESS,phrase:e?.phrase||Zr.CALL_END_PHRASE.LOCAL_USER_INITIATED,resultCategories:e?.resultCategories,clientReasonSubCode:e?.clientReasonSubCode,clientReasonPhrase:e?.clientReasonPhrase};if(n.resultCategories=n.resultCategories||[br],this.links.hasOwnProperty(Zr.LINKS.LEAVE)){this.logger.info(`[${t}][cancelOutgoingCall] cancelling outgoing call`),this.fsmState=Zr.SIGNALING_FSM_STATE.IDLE;const e={cancelationDuration:this.telemetryHelper.getCallCancelationDuration()},r={terminatingEnd:hc.CALL_TERMINATING_END.LOCAL,resultDetail:n.phrase||"CancelOutgoingCall",endCode:n.code,endSubCode:n.subCode,causeId:t,clientReasonSubCode:n.clientReasonSubCode,clientReasonPhrase:n.clientReasonPhrase,resultCategories:n.resultCategories};this.http.sendPostRequest({url:this.links[Zr.LINKS.LEAVE],requestName:cc.CANCEL_CALL.name,payload:Sh(this,n,e),causeId:t}).then((e=>{this.disposed||(this.telemetryHelper.setTerminatingData(r),this.onCallStatusChanged(Zr.CALL_STATUS.LOCAL_TERMINATED,t,n),this.dispose(n,t)),i.resolve(null)})).catch((e=>{const s=Cs(e,this.signalingAgentConfig);this.logger.info(`[cancelOutgoingCall][${t}] error: ${Ve(e)} xhrError: ${Ve(s)}`),this.disposed||(this.telemetryHelper.setTerminatingData(r),this.onCallStatusChanged(Zr.CALL_STATUS.LOCAL_TERMINATED,t,n),this.dispose(n,t)),i.resolve(null)}))}else this.logger.info(`[${t}][cancelOutgoingCall] Conversation Service Leave Url is not yet set. Cannot leave conversation. Disposing anyways.`),n.subCode=Zr.CALL_END_SUB_CODE.CONV_URL_NOT_SET,this.telemetryHelper.setTerminatingData({terminatingEnd:hc.CALL_TERMINATING_END.LOCAL,resultDetail:n.phrase||"CancelOutgoingCall",endCode:n.code,endSubCode:n.subCode,causeId:t,clientReasonSubCode:n.clientReasonSubCode,clientReasonPhrase:n.clientReasonPhrase,resultCategories:n.resultCategories}),this.onCallStatusChanged(Zr.CALL_STATUS.LOCAL_TERMINATED,t,n),this.dispose(n,t),i.resolve(null);return i.promise}terminateEstablishedCall(e,t){const i=t.causeId||os();this.logger.info(`[${i}][terminateEstablishedCall]`);const n=As();this.fsmState=Zr.SIGNALING_FSM_STATE.IDLE;const r=this.convJoined?cc.LEAVE_CONVERSATION.name:cc.END_CALL.name,s=Vc(),a={code:e?.code||Zr.CALL_END_CODE.SUCCESS,subCode:e?.subCode||Zr.CALL_END_SUB_CODE.SUCCESS,phrase:e?.phrase||Zr.CALL_END_PHRASE.LOCAL_USER_INITIATED,resultCategories:e?.resultCategories,clientReasonSubCode:e?.clientReasonSubCode,clientReasonPhrase:e?.clientReasonPhrase};a.resultCategories=a.resultCategories||[br];const o={terminatingEnd:hc.CALL_TERMINATING_END.LOCAL,endCode:a.code,endSubCode:a.subCode,resultDetail:a.phrase||"TerminateEstablishedCall",causeId:i,clientReasonSubCode:a.clientReasonSubCode,clientReasonPhrase:a.clientReasonPhrase,resultCategories:a.resultCategories};return this.leaveConversation(a,t).then((()=>{this.logger.info(`[${i}][terminateEstablishedCall]success`),this.disposed||(this.telemetryHelper.setTerminatingData(o),this.telemetryHelper.addNetworkOperationCompleted(r,!0,s.duration()),this.onCallStatusChanged(Zr.CALL_STATUS.LOCAL_TERMINATED,i,a),this.dispose(a,i)),n.resolve(null)})).catch((e=>{const t=Cs(e,this.signalingAgentConfig);this.logger.info(`[${i}][terminateEstablishedCall][failed] error: ${Ve(e)} xhrError: ${Ve(t)}]`),this.disposed||(this.telemetryHelper.setTerminatingData(o),this.telemetryHelper.addNetworkOperationCompleted(r,!1,s.duration()),this.onCallStatusChanged(Zr.CALL_STATUS.LOCAL_TERMINATED,i,a),this.dispose(a,i)),n.resolve(null)})),n.promise}deleteConversation(e,t){this.logger.info(`[${t}][deleteConversation]`);const i=As();this.fsmState=Zr.SIGNALING_FSM_STATE.IDLE;const n=cc.DELETE_CONVERSATION.name,r=Vc(),s={code:e?.code||Zr.CALL_END_CODE.SUCCESS,subCode:e?.subCode||Zr.CALL_END_SUB_CODE.SUCCESS,phrase:e?.phrase||Zr.CALL_END_PHRASE.CONV_END_FOR_ALL_INITIATED,resultCategories:e?.resultCategories||[br],clientReasonSubCode:e?.clientReasonSubCode,clientReasonPhrase:e?.clientReasonPhrase},a={terminatingEnd:hc.CALL_TERMINATING_END.LOCAL,endCode:s.code,endSubCode:s.subCode,resultDetail:s.phrase,causeId:t,clientReasonSubCode:s.clientReasonSubCode,clientReasonPhrase:s.clientReasonPhrase,resultCategories:s.resultCategories};return this.deleteConversationController(s,t).then((()=>{this.logger.info(`[${t}][deleteConversation]success`),this.disposed||(this.telemetryHelper.setTerminatingData(a),this.telemetryHelper.addNetworkOperationCompleted(n,!0,r.duration()),this.onCallStatusChanged(Zr.CALL_STATUS.LOCAL_TERMINATED,t,s),this.dispose(s,t)),i.resolve(null)})).catch((e=>{const o=Cs(e,this.signalingAgentConfig);this.logger.info(`[${t}][deleteConversation][failed] error: ${Ve(e)} xhrError: ${Ve(o)}`),this.disposed||(this.telemetryHelper.setTerminatingData(a),this.telemetryHelper.addNetworkOperationCompleted(n,!1,r.duration()),this.onCallStatusChanged(Zr.CALL_STATUS.LOCAL_TERMINATED,t,s),this.dispose(s,t)),i.resolve(null)})),i.promise}leaveConversation(e,t){const i=t.causeId||os();if(this.convJoined){this.logger.info(`[${i}][leaveConversation]`);const n={cancelationDuration:this.telemetryHelper.getCallCancelationDuration()};return this.http.sendPostRequest({url:this.links[Zr.LINKS.LEAVE],requestName:cc.LEAVE_CONVERSATION.name,payload:Ch(this,e,n,t.scope),withoutTrouter:!0,causeId:i})}return this.logger.info(`[${i}][leaveConversation] ignore, not joined to conversation`),Promise.resolve(void 0)}deleteConversationController(e,t){return this.convJoined?(this.logger.info(`[${t}][deleteConversationController]`),this.http.sendDeleteRequest({url:this.links[Zr.LINKS.CONVERSATION_CONTROLLER],requestName:cc.DELETE_CONVERSATION.name,payload:(i=this,n=e,hs(i,"signalingSession cannot be null"),us(n),{payload:{participants:{from:{id:i.participantManager.localParticipant.id,displayName:i.participantManager.localParticipant.displayName,endpointId:i.participantManager.localParticipant.endpointId,participantId:i.participantManager.localParticipant.participantId,languageId:i.participantManager.localParticipant.languageId}},conversationTransactionEnd:{reason:"noError",code:Zr.CALL_END_CODE.SUCCESS,phrase:Zr.CALL_END_PHRASE.CONV_END_FOR_ALL_INITIATED},callTransactionEnd:n}}),withoutTrouter:!0,causeId:t})):(this.logger.info(`[${t}][deleteConversationController]ignored, not joined to conversation`),Promise.resolve(void 0));var i,n}rejectIncomingCall(e,t){this.telemetryHelper.recordEvent(Tl,t),this.logger.info(`[${t}][rejectIncomingCall]`);const i=As();this.fsmState=Zr.SIGNALING_FSM_STATE.IDLE;const n={code:isNaN(e?.code)?Zr.CALL_END_CODE.REJECT:e.code,subCode:e?.subCode||Zr.CALL_END_SUB_CODE.SUCCESS,phrase:e?.phrase||Zr.CALL_END_PHRASE.LOCAL_USER_INITIATED,resultCategories:e?.resultCategories,clientReasonSubCode:e?.clientReasonSubCode,clientReasonPhrase:e?.clientReasonPhrase};n.resultCategories=n.resultCategories||[br];const r={terminatingEnd:hc.CALL_TERMINATING_END.LOCAL,endCode:n.code,endSubCode:n.subCode,resultDetail:n.phrase||"RejectCall",causeId:t,clientReasonSubCode:n.clientReasonSubCode,clientReasonPhrase:n.clientReasonPhrase,resultCategories:n.resultCategories};return this.http.sendDeleteRequest({url:this.links[Zr.LINKS.REJECT],requestName:cc.REJECT_CALL.name,payload:bh(this,n),causeId:t}).then((e=>{this.disposed||(this.telemetryHelper.setTerminatingData(r),this.onCallStatusChanged(Zr.CALL_STATUS.LOCAL_TERMINATED,t,n),this.dispose(n,t)),i.resolve(null)})).catch((e=>{const s=Cs(e,this.signalingAgentConfig);this.logger.info(`[rejectIncomingCall][${t}] error: ${Ve(e)} xhrError: ${Ve(s)}`),this.disposed||(this.telemetryHelper.setTerminatingData(r),this.onCallStatusChanged(Zr.CALL_STATUS.LOCAL_TERMINATED,t,n),this.dispose(n,t)),i.resolve(null)})),i.promise}onCallStatusChanged(e,t,i){const n=`[${t}][onCallStatusChanged]`;if(this.logger.info(`${n}${this.currentCallStatus}=>${e}]`),this.disposed)this.logger.info(`${n}Call is already disposed!!`);else if(i&&this.logger.info(`${n}[statusCode=${Ve(i)}]`),this.isPromotingToRealtime)e===Zr.CALL_STATUS.CONNECTED&&this.onPromotionCompleted(!1,void 0,t);else if(this.isValidStateTransitions(e)){this.currentCallStatus=e;const n={callStatus:e,statusCode:i,causeId:t};this.isPreheatOnly&&(n.isPreheatOnly=!0),this.telemetryHelper.recordEvent(dl,n),this.signalingSessionCallback.onCallStatusChanged(e,i,t),this.currentCallStatus===Zr.CALL_STATUS.CONNECTED&&(this.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT),this.telemetryHelper.resetCallCancelationDurationWatch(),this.isPreheatOnly&&this.startCallPreheatTimer(t))}}updateMeetingLiveStateAsync(e,t){this.logger.info(`[${e}][updateMeetingLiveStateAsync][options=${JSON.stringify(t)}]`),this.telemetryHelper.recordEvent(pd,{causeId:e,meetingLiveStateOptions:t}),this.timeoutManager.startTimer(Zr.TIMEOUT_OPERATIONS.UPDATE_MEETING_LIVE_STATE_COMPLETION,(()=>{this.handleUpdateMeetingLiveStateError({code:Zr.CALL_END_CODE.TIMEOUT,subCode:Zr.CALL_END_SUB_CODE.UPDATE_MEETING_LIVE_STATE_COMPLETION_TIMEOUT,phrase:Zr.CALL_END_PHRASE.UPDATE_MEETING_LIVE_STATE_COMPLETION_TIMEOUT},gd,e,e,t)}),Zr.TIMEOUT_VALUES_IN_SECONDS.UPDATE_MEETING_LIVE_STATE_COMPLETION_TIMEOUT);const i=(n=this,r={...t,seqNum:this.meetingLiveStateSequenceNumber},s=e,hs(n,"signalingSession cannot be null"),{payload:{from:{id:n.participantManager.localParticipant.id,endpointId:n.participantManager.localParticipant.endpointId,participantId:n.participantManager.localParticipant.participantId,languageId:n.participantManager.localParticipant.languageId,displayName:n.participantManager.localParticipant.displayName},meetingLiveState:r,links:{updateMeetingLiveStateStatus:is(n,Dr.UPDATE_MEETING_LIVE_STATE_STATUS)},operationId:s}});var n,r,s;return this.http.sendPostRequest({url:this.links[Zr.LINKS.UPDATE_MEETING_LIVE_STATE],requestName:cc.UPDATE_MEETING_LIVE_STATE.name,payload:i,causeId:e}).then((t=>{this.logger.info(`[${e}][updateMeetingLiveStateAsync] response: ${Ve(t)}`),this.telemetryHelper.recordEvent(gd,{causeId:e})})).catch((i=>{const n=Cs(i,this.signalingAgentConfig);return this.logger.info(`[${e}][updateMeetingLiveStateAsync] error: ${Ve(n)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.handleUpdateMeetingLiveStateError(n.error,md,e,e,t),Promise.reject(n.error))}))}updateMeetingStatesAsync(e,t){const i=this.logger.createChild(`[${e}][updateMeetingStatesAsync]`,this.correlationId);if(i.info(`meetingStatesOptions: ${JSON.stringify(t)}`),!t)return Promise.reject({code:Zr.VALIDATION.VALIDATION_FAILED,subCode:Zr.VALIDATION.NULL_OR_EMPTY,phrase:"meetingStatesOptions should be a non empty object"});this.telemetryHelper.recordEvent(ac,{causeId:e,meetingStatesOptions:t}),this.timeoutManager.startTimer(Zr.TIMEOUT_OPERATIONS.UPDATE_MEETING_STATES_COMPLETION,(()=>{for(const i in t.meetingStates)this.handleUpdateMeetingStatesError({code:Zr.CALL_END_CODE.TIMEOUT,subCode:Zr.CALL_END_SUB_CODE.UPDATE_MEETING_STATES_COMPLETION_TIMEOUT,phrase:Zr.CALL_END_PHRASE.UPDATE_MEETING_STATES_COMPLETION_TIMEOUT},oc,e,t.operationId+"_"+i)}),Zr.TIMEOUT_VALUES_IN_SECONDS.UPDATE_MEETING_STATES_COMPLETION_TIMEOUT);const n=(r=this,s={...t.meetingStates},a=e,hs(r,"signalingSession cannot be null"),{payload:{from:{id:r.participantManager.localParticipant.id,endpointId:r.participantManager.localParticipant.endpointId,participantId:r.participantManager.localParticipant.participantId,languageId:r.participantManager.localParticipant.languageId,displayName:r.participantManager.localParticipant.displayName},meetingStates:s,updateMeetingStatesStatus:is(r,Dr.UPDATE_MEETING_STATES_STATUS),operationId:a}});var r,s,a;return this.http.sendPostRequest({url:this.links[Zr.LINKS.UPDATE_MEETING_STATES],requestName:cc.UPDATE_MEETING_STATES.name,payload:n,causeId:e}).then((t=>{i.info(`response: ${Ve(t)}`),this.telemetryHelper.recordEvent(oc,{causeId:e})})).catch((n=>{const r=Cs(n,this.signalingAgentConfig);if(i.error(`error: ${Ve(r)}`),!this.disposed){for(const i in t.meetingStates)this.handleUpdateMeetingStatesError(r.error,dc,e,t.operationId+"_"+i);return Promise.reject(r.error)}return Promise.reject(this.getCallNotFoundTransactionEnd())}))}handleUpdateMeetingLiveStateError(e,t,i,n,r){this.disposed?this.logger.info(`[${i}][handleUpdateMeetingLiveStateError] ignored. Call disposed, err: ${JSON.stringify(e)}`):(this.logger.info(`[${i}][handleUpdateMeetingLiveStateError] reject reason: ${e}`),this.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.UPDATE_MEETING_LIVE_STATE_COMPLETION),this.telemetryHelper.recordEvent(t,{...e,updateMeetingGroupsOptions:r,causeId:i}),this.signalingSessionCallback.onUpdateMeetingLiveStateCompleted&&this.signalingSessionCallback.onUpdateMeetingLiveStateCompleted(e,i,n))}handleUpdateMeetingLiveStateCompletion(e){const t=e.body,i=_s(e),n=t.updateMeetingLiveStateResponse.result,r=t.updateMeetingLiveStateResponse.operationId;r||this.logger.warn(`[${i}][handleUpdateMeetingLiveStateCompletion] operationId is undefined.`),this.logger.info(`[${i}][handleUpdateMeetingLiveStateCompletion] meetingLiveUpdate completes with operationId=${r}`),this.handleOperationCompletionCommon(n,i,r,Ve(t),"handleUpdateMeetingLiveStateCompletion",Zr.TIMEOUT_OPERATIONS.UPDATE_MEETING_LIVE_STATE_COMPLETION,Sd,fd,this.signalingSessionCallback.onUpdateMeetingLiveStateCompleted,this.handleUpdateMeetingLiveStateError.bind(this))}handleUpdateMeetingStatesError(e,t,i,n){this.disposed?this.logger.info(`[${i}][handleUpdateMeetingStatesError] ignored. Call disposed, err: ${JSON.stringify(e)}`):(this.logger.info(`[${i}][handleUpdateMeetingStatesError] reject reason: ${e}`),this.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.UPDATE_MEETING_STATES_COMPLETION),this.telemetryHelper.recordEvent(t,{...e,causeId:i}),this.signalingSessionCallback.onUpdateMeetingStatesCompleted&&this.signalingSessionCallback.onUpdateMeetingStatesCompleted(e,i,n))}handleUpdateMeetingStatesCompletion(e){const t=e.body,i=_s(e),n=t.updateMeetingStatesResponse,r=t.operationId,s=this.logger.createChild(`[${i}][handleUpdateMeetingStatesCompletion]`,this.correlationId);r||s.warn("operationId is undefined.");for(const e of n)s.info(`UpdateMeetingStates completes with operationId=${r}.`),this.handleOperationCompletionCommon(e.transactionEnd,i,r+"_"+e.meetingStateName,Ve(t),"handleUpdateMeetingStatesCompletion",Zr.TIMEOUT_OPERATIONS.UPDATE_MEETING_STATES_COMPLETION,lc,dc,this.signalingSessionCallback.onUpdateMeetingStatesCompleted,this.handleUpdateMeetingStatesError.bind(this))}setMeetingLayoutAsync(e,t){this.logger.info(`[${e}][setMeetingLayoutAsync][options=${JSON.stringify(t)}]`),this.telemetryHelper.recordEvent(Rd,{causeId:e,setMeetingLayoutOptions:t}),this.timeoutManager.startTimer(Zr.TIMEOUT_OPERATIONS.SET_MEETING_LAYOUT_COMPLETION,(()=>{this.handleSetMeetingLayoutError({code:Zr.CALL_END_CODE.TIMEOUT,subCode:Zr.CALL_END_SUB_CODE.SET_MEETING_LAYOUT_COMPLETION_TIMEOUT,phrase:Zr.CALL_END_PHRASE.SET_MEETING_LAYOUT_COMPLETION_TIMEOUT},wd,e,e,t)}),Zr.TIMEOUT_VALUES_IN_SECONDS.SET_MEETING_LAYOUT_COMPLETION_TIMEOUT);const i=function(e,t){return hs(e,"signalingSession cannot be null"),{payload:{from:{id:e.participantManager.localParticipant.id,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId,displayName:e.participantManager.localParticipant.displayName},...t,links:{setMeetingLayoutStatus:is(e,Dr.SET_MEETING_LAYOUT_STATUS)}}}}(this,{...t,sequenceNumber:this.meetingLayoutSequenceNumber});return this.http.sendPostRequest({url:this.links[Zr.LINKS.SET_MEETING_LAYOUT],requestName:cc.SET_MEETING_LAYOUT.name,payload:i,causeId:e}).then((t=>{this.logger.info(`[${e}][setMeetingLayoutAsync] response: ${Ve(t)}`),this.telemetryHelper.recordEvent(wd,{causeId:e})})).catch((i=>{const n=Cs(i);return this.logger.info(`[${e}][setMeetingLayoutAsync] error: ${Ve(n)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.handleSetMeetingLayoutError(n.error,Md,e,e,t),Promise.reject(n.error))}))}handleSetMeetingLayoutError(e,t,i,n,r){this.disposed?this.logger.info(`[${i}][handleSetMeetingLayoutError] ignored. Call disposed, err: ${JSON.stringify(e)}`):(this.logger.info(`[${i}][handleSetMeetingLayoutError] reject reason: ${e}`),this.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.SET_MEETING_LAYOUT_COMPLETION),this.telemetryHelper.recordEvent(t,{...e,updateMeetingGroupsOptions:r,causeId:i}),this.signalingSessionCallback.onSetMeetingLayoutCompleted&&this.signalingSessionCallback.onSetMeetingLayoutCompleted(e,i,n))}handleSetMeetingLayoutCompletion(e){const t=e.body,i=_s(e),n=t.setMeetingLayoutResponse.result,r=t.setMeetingLayoutResponse.operationId;r||this.logger.warn(`[${i}][handleSetMeetingLayoutCompletion] operationId is undefined.`),this.handleOperationCompletionCommon(n,i,r,Ve(t),"handleSetMeetingLayoutCompletion",Zr.TIMEOUT_OPERATIONS.SET_MEETING_LAYOUT_COMPLETION,Dd,Od,this.signalingSessionCallback.onSetMeetingLayoutCompleted,this.handleSetMeetingLayoutError.bind(this))}handleOperationCompletionCommon(e,t,i,n,r,s,a,o,l,d){this.disposed?this.logger.info(`[${t}][${r}] ignored. Call disposed.`):(this.logger.info(`[${t}][${r}] body ${n}`),e.code===Zr.TRANSACTION_END_CODE.SUCCESS?(this.timeoutManager.stopTimer(s),this.telemetryHelper.recordEvent(a,{...e,causeId:t}),l&&l(e,t,i)):d&&d(e,o,t,i))}isValidStateTransitions(e){if(this.currentCallStatus===Zr.CALL_STATUS.LOCAL_TERMINATED&&e===Zr.CALL_STATUS.CONNECTING)return!0;const t=e=>{switch(e){case Zr.CALL_STATUS.IDLE:case Zr.CALL_STATUS.CONNECTED_FOR_ROSTER_ONLY:return 0;case Zr.CALL_STATUS.CONNECTING:return 1;case Zr.CALL_STATUS.RINGING:return 2;case Zr.CALL_STATUS.CONNECTED:return 3;case Zr.CALL_STATUS.LOCAL_TERMINATED:case Zr.CALL_STATUS.REMOTE_TERMINATED:return 4;default:return-1}};return t(e)>t(this.currentCallStatus)}handlePSTNBalanceUpdate(e){const t=e.body.balanceUpdate,i=_s(e);this.logger.info(`[${i}][handlePSTNBalanceUpdate]`),this.telemetryHelper.recordIncomingEvent(sl,e),t.updateBalance?this.signalingSessionCallback.onPSTNBalanceUpdate(t):this.logger.info(sl,"this was a pstn keepAlive message - ignore")}handleCallAcceptanceAck(e){const t=e.body,i=_s(e);this.logger.info(`[${i}][handleCallAcceptanceAck]`),this.telemetryHelper.recordIncomingEvent(qa,e),this.internalHandleCallAcceptanceAck(t,i)}internalHandleCallAcceptanceAck(e,t){this.logger.info(`[${t}][internalHandleCallAcceptanceAck] ${Ve(e)}`),this.fsmState!==Zr.SIGNALING_FSM_STATE.CONNECTED&&(this.links[Zr.LINKS.MEDIA_RENEGOTIATION]=e.callAcceptanceAcknowledgement.links.mediaRenegotiation,this.links[Zr.LINKS.TRANSFER]=e.callAcceptanceAcknowledgement.links.transfer,this.links[Zr.LINKS.REPLACE]=e.callAcceptanceAcknowledgement.links.replacement,this.links[Zr.LINKS.HANGUP]=e.callAcceptanceAcknowledgement.links.callLeg,this.links[Zr.LINKS.KEEPALIVE]=e.callAcceptanceAcknowledgement.links.callLeg,this.links[Zr.LINKS.PARK]=e.callAcceptanceAcknowledgement.links.hold,this.links[Zr.LINKS.UPDATE_MEDIA_DESCRIPTIONS]=e.callAcceptanceAcknowledgement.links.updateMediaDescriptions,this.saveMediaControllerLinksIfAny(e.callAcceptanceAcknowledgement),this.scheduleKeepAlives(e.callAcceptanceAcknowledgement.callKeepAliveInterval),this.signalingSessionCallback.updateIsSharedLineAppearanceV2Activated(e.callAcceptanceAcknowledgement.callProperties?.isSharedLineAppearanceV2Activated),this.fsmState=Zr.SIGNALING_FSM_STATE.CONNECTED,this.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.INCOMING_CALL_ESTABLISHMENT),this.isPreheatOnly||this.telemetryHelper.startCallConnectedWatch(),this.mediaRenegotiationManager.onCallConnected(t),this.onCallStatusChanged(Zr.CALL_STATUS.CONNECTED,t),this.linkUpdateRequested.keepAliveLinks&&(this.logger.info(`[${t}][internalHandleCallAcceptanceAck] updating CC links as requested`),this.updateLinks(this.updateKeepAliveUrl,t)))}isFatalException(e){let t=!0;try{JSON.parse(e.message).code===Zr.CALL_END_CODE.CONFLICT&&(t=!1,this.logger.info("isFatalException: received non-fatal 409 error"))}catch(e){this.logger.error("isFatalException: failed to parse error")}return t}startOrJoinCall(e,t,i,n,r){if(this.logger.info(`[${i}]startOrJoinCall[${t}]`),this.disposed)return void this.logger.info(`[${i}][${t}] session already disposed, ignore`);this.setMultiParty(1!==this.participantManager.getParticipantsToInitiateCallWith().length,i);const s=this.getConversationUrl()?this.getConversationUrl():e.conversationServiceUrl;this.telemetryHelper.setConversationServiceUrl(s),this.logger.info(`options.conversationServiceUrl ${e.conversationServiceUrl} conversationServiceUrl ${s}`),e.isPreheatOnly?(this.isPreheatOnly=!0,this.telemetryHelper.recordEvent(Al,{causeId:i}),this.telemetryHelper.setSelfParticipantRole(hc.ROLE.PREHEAT),this.telemetryHelper.setIsPreheated()):this.telemetryHelper.startCallCancelationDurationWatch(),this.mediaTypesToUse=r,this.lastUsedOutgoingMediaContent=n,this.telemetryHelper.setCallerType(this.participantManager.localParticipant.id);const a=!this.multiParty&&this.signalingAgentConfig.enableLongOutgoing1To1SetupTimeoutForWeb,o=a?Zr.TIMEOUT_VALUES_IN_SECONDS.LONGER_OUTGOING_CALL_ESTABLISHMENT_TIMEOUT:Zr.TIMEOUT_VALUES_IN_SECONDS.OUTGOING_CALL_ESTABLISHMENT_TIMEOUT;this.logger.info(`[${i}][${t}]target endpointType = ${this.transferContext&&this.transferContext.target?this.transferContext.target.endpointType:"default"} timeout = ${o} LongerTimeout = ${a}`);const l=e.newCall?function(e,t,i,n){hs(e,"signalingSession cannot be null");let r=[];r=n.invitationType===Zr.INVITATION_TYPE.NUDGE&&Array.isArray(n.participantsToNudge)?n.participantsToNudge.map((e=>({id:e}))):e.participantManager.getParticipantsToInitiateCallWith(),e.signalingAgentConfig.doHostlessCalling||ds(r.length>0,"remoteParticipants need to be set before a call can be made");const s={type:"Delta",rosterUpdate:is(e,Dr.CONV_ROSTER_UPDATE)},a=e.groupId?{id:e.groupId}:null,o=e.threadId?{threadId:e.threadId,messageId:e.teamsMessageId||null}:null,l=e.contentSharingManager.getContentSharingInfoToStartSharing(),d=null===l?null:{identifier:l.contentIdentifier,subject:l.subject,sessionState:l.sessionState,sessionUpdateSequenceNumber:l.sequenceNumber,links:{sessionUpdate:is(e,Dr.CONV_CONTENT_SHARING_UPDATE),sessionEnd:is(e,Dr.CONV_CONTENT_SHARING_END)}},c=e.broadcastSession?.getContext(),h=e.getEndpointCapabilities();1===r.length&&e.telemetryHelper.setCalleeType(r[0].id),e.numberOfOriginalInvitees=r.length;const u=[];r.forEach((t=>{const i={id:t.id};t.displayName&&(i.displayName=t.displayName),t.participantId&&(i.participantId=t.participantId),(n.callToVoicemail||e.transferContext&&e.transferContext.target&&"voicemail"===e.transferContext.target.endpointType)&&(i.endpointType="voicemail"),u.push(i)}));const p=e.transferContext?e.transferContext.transferor:null,g=e.transferContext?e.transferContext.transferContext:null,m={};n.callToVoicemail&&(n.voicemailResourcePath&&(m.localResourcePath=n.voicemailResourcePath),n.voicemailItemId&&(m.voicemailItemId=n.voicemailItemId));const f={payload:{conversationRequest:{conversationType:n.conversationType,subject:e.convSubject,suppressDialout:n.suppressDialout,applicationType:n.applicationType,targetApplicationType:n.targetApplicationType,roster:s,properties:{allowConversationWithoutHost:e.signalingAgentConfig.doHostlessCalling,enableGroupCallEventMessages:e.signalingAgentConfig.shouldServiceSendCallEventMessages,enableGroupCallUpgradeMessage:e.signalingAgentConfig.shouldServiceSendNGCUpgradeMessages,enableGroupCallMeetupGeneration:e.enableGroupCallMeetupGeneration},links:{conversationEnd:is(e,Dr.CONV_END),conversationUpdate:is(e,Dr.CONV_UPDATE),localParticipantUpdate:is(e,Dr.CONV_LOCAL_PARTICIPANT_UPDATE),addParticipantSuccess:is(e,Dr.CONV_ADD_PARTICIPANT_SUCCESS),addParticipantFailure:is(e,Dr.CONV_ADD_PARTICIPANT_FAILURE),addModalitySuccess:is(e,Dr.CONV_ADD_MODALITY_SUCCESS),addModalityFailure:is(e,Dr.CONV_ADD_MODALITY_FAILURE),confirmUnmute:is(e,Dr.CONV_CONFIRM_UNMUTE),receiveMessage:is(e,Dr.RECEIVE_MESSAGE)}},broadcast:c,contentSharing:d,participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId,meetingRegistrationId:n.meetingRegistrationId,participantPin:n.participantPin},to:u},capabilities:null,endpointCapabilities:h,clientEndpointCapabilities:n.clientEndpointCapabilities?n.clientEndpointCapabilities:null,endpointMetadata:e.endpointMetadata,groupContext:a,groupChat:o,meetingInfo:e.getMeetingInfo(),meetingData:n.meetingData,meetingPreferences:n.meetingPreferences,endpointState:n.endpointState}};if(n.publishedStates?.publishedStates.length>0){let t=[];t=n.publishedStates.publishedStates.map((t=>{let i={};try{i=JSON.parse(t.content)}catch(t){e.logger.warn("createConversationRequest getPayload() failed to parse state.content")}return{stateType:t.type,level:t.level,content:i,sequenceNumber:e.getPublishStateSequenceNumber()}})),f.payload.publishedStates=t}e.deviceType&&"default"!==e.deviceType&&(f.payload.conversationRequest.deviceType=e.deviceType);const S=ps(i);if(e.telemetryHelper.addOutgoingModalities(S),f.payload.callInvitation={callModalities:S,replaces:null,transferor:p||null,clientTransferContext:g,links:{progress:is(e,Dr.PROGRESS),mediaAnswer:is(e,Dr.MEDIA_ANSWER),acceptance:is(e,Dr.ACCEPT),redirection:is(e,Dr.REDIRECTION),end:is(e,Dr.END)},clientContentForMediaController:e.webRtcSignalingManager.getClientUrls(),pstnContent:e.pstnContent,emergencyContent:e.getEmergencyContent(),mediaContent:t,voicemailSettings:m,routingFlags:n.routingFlags,invitationData:n.invitationData,locationContent:e.getLocationContent(),networkContent:e.getNetworkContent(),areaContent:e.getAreaContent()},n.pickupCode&&(f.payload.callInvitation.unparkContent={pickupCode:parseInt(n.pickupCode,10)}),n.onBehalfOf&&(f.payload.callInvitation.onBehalfOf={id:n.onBehalfOf},n.onBehalfOfUserDisplayName&&(f.payload.callInvitation.onBehalfOf.displayName=n.onBehalfOfUserDisplayName)),n.callQueueContext&&(f.payload.callInvitation.callQueueContext=n.callQueueContext),n.scenario&&(f.payload.conversationRequest.scenario=n.scenario),n.alternateId&&(f.payload.participants.from.alternateId=n.alternateId),n.invitationType===Zr.INVITATION_TYPE.NUDGE&&(f.payload.participants.invitationType=n.invitationType),e.signalingAgentConfig.ecsEtag&&(f.payload.debugContent={ecsEtag:e.signalingAgentConfig.ecsEtag}),n.clientEndpointDebugContent){f.payload.debugContent||(f.payload.debugContent={});try{f.payload.debugContent.clientDebugContent=JSON.parse(n.clientEndpointDebugContent)}catch(e){ds(!1,`Failed to parse ${n.clientEndpointDebugContent}`)}}if(n.captchaContentJson)try{f.payload.conversationRequest.captchaContent=JSON.parse(n.captchaContentJson)}catch(e){ds(!1,`Failed to parse ${n.captchaContentJson}`)}return f}(this,n,r,e):yh(this,n,r,e,i);this.signalingAgentConfig.enableCallEstablishmentTimeoutsForStartJoinCall&&this.timeoutManager.startTimer(Zr.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT,(()=>{this.handleCallEstablishmentTimeout(i)}),o),this.signalingSessionCallback.onTransferredCallAcceptance(i),e.endpointState&&(this.latestEndpointState=e.endpointState),this.http.sendPostRequest({url:s,requestName:t,operationType:"CallSetup",payload:l,causeId:i}).then((e=>{this.disposed||(this.processConversationServiceResponseHeaders(e,i),this.processConversationServiceResponse(e.response,i,0),this.onCallStatusChanged(Zr.CALL_STATUS.CONNECTING,i))})).catch((e=>{if(e.stack&&!this.isFatalException(e))return;const n=Cs(e,this.signalingAgentConfig);if(this.logger.info(`[startOrJoinCall][${i}][${t}] error: ${Ve(e)} xhrError: ${Ve(n)}`),!this.disposed){if(this.isPromotingToRealtime)return void this.onPromotionCompleted(!0,n.error,i);this.fsmState=Zr.SIGNALING_FSM_STATE.IDLE,this.telemetryHelper.setTerminatingData({terminatingEnd:hc.CALL_TERMINATING_END.LOCAL,resultValue:hc.RESULT_VALUE.FAILURE,endCode:n.telemetryEndSubCode,endSubCode:n.error.subCode,resultCategories:n.error.resultCategories,resultDetail:n.error.phrase||this.getTerminatingCallResultDetail(t,n.error),causeId:i}),this.onCallStatusChanged(Zr.CALL_STATUS.LOCAL_TERMINATED,i,n.error),this.dispose(n.error,i)}}))}processIncomingCallPayload(e,t){this.remoteUser=Us.fromWireParticipant(e.callNotification.from),this.participantManager.setLocalParticipantId(e.callNotification.to.participantId,t),e?(e.conversationInvitation&&(this.links[Zr.LINKS.CONVERSATION_CONTROLLER]=e.conversationInvitation.conversationController,this.setMultiParty(e.conversationInvitation.isMultiParty,t),this.setIsHostless(!!e.conversationInvitation.isHostless,t)),e.callNotification&&(this.links[Zr.LINKS.ATTACH]=e.callNotification.links?.attach,this.links[Zr.LINKS.REDIRECT]=e.callNotification.links?.redirection,this.onBehalfOf=e.callNotification.onBehalfOf?.id,this.onBehalfOfUserDisplayName=e.callNotification.onBehalfOf?.displayName,this.callQueueContext=e.callNotification.callQueueContext,this.callPhoneLineType=e.callNotification.callPhoneLineType,this.callType=e.callNotification.callType,this.incomingCallCallerId=e.callNotification.from?.id,this.callUsesMixer=!!e.callNotification.mediaContent?.fromMixer,this.isRedirectAllowed=!!e.callNotification.redirectionProperties?.isRedirectAllowed),e.debugContent&&this.updateCorrelationId(e.debugContent.callId,t),e.callNotification.transferor&&(this.transferor=e.callNotification.transferor.details?e.callNotification.transferor.details.id:null),e.groupChat&&this.updateGroupChatIds(e.groupChat,t),e.meetingData&&(this.meetingData=e.meetingData),e.meetingInfo&&(this.meetingInfo=e.meetingInfo)):this.logger.info(`[${t}][processIncomingCallPayload] empty incoming payload content`)}processAttachResponse(e,t,i){this.telemetryHelper.recordEvent(fl,{causeId:i}),this.links[Zr.LINKS.MEDIA_ANSWER]=t.response.callInvitation.links.mediaAnswer,this.links[Zr.LINKS.ACCEPT]=t.response.callInvitation.links.acceptance,this.links[Zr.LINKS.REJECT]=t.response.callInvitation.links.callLeg,this.links[Zr.LINKS.REDIRECT]=t.response.callInvitation.links.redirection,this.links[Zr.LINKS.NEW_OFFER]=t.response.callInvitation.links.newOffer,this.signalingAgentConfig.sendProgressFromCC||this.sendProgress(t),this.remoteCaller=t.response.participants.from;const n=this.getInitialMediaOfferFromIncomingCallPayload()||t.response.callInvitation.mediaContent;this.telemetryHelper.setCallerType(this.getParticipantIdForOfferAnswer(n));const r=ps(t.response.callInvitation.callModalities);this.telemetryHelper.addIncomingModalities(r),this.telemetryHelper.setOfferedModalities(n.blob,!0),this.callUsesMixer=n.fromMixer,this.isRedirectAllowed=!(!t.response.callInvitation.redirectionProperties||!t.response.callInvitation.redirectionProperties.isRedirectAllowed),this.signalingSessionCallback.onOffer({subject:e.conversationInvitation.subject,remoteParticipantId:this.getParticipantIdForOfferAnswer(n),remoteEndpointId:t.response.participants.from.endpointId,transferor:t.response.callInvitation.transferor,clientTransferContext:e.callNotification.transferContext,mediaTypes:r,mediaContent:n,renegotiation:!1,invitationData:t.response.callInvitation.invitationData,riskLevel:t.response.callInvitation.spamProperties&&t.response.callInvitation.spamProperties.riskLevel,stirAttestation:t.response.callInvitation.spamProperties&&t.response.callInvitation.spamProperties.stirAttestation,isRedirectAllowed:this.isRedirectAllowed},i)}sendProgress(e,t=os()){var i;this.logger.info(`[${t}][sendProgress]`),this.telemetryHelper.recordEvent(Sl,{causeId:t}),this.http.sendPostRequest({url:e.response.callInvitation.links.progress,requestName:cc.SEND_CALL_PROGRESS.name,payload:(i=this,hs(i,"signalingSession cannot be null"),{payload:{callProgress:{sender:{id:i.participantManager.localParticipant.id,displayName:i.participantManager.localParticipant.displayName,endpointId:i.participantManager.localParticipant.endpointId,participantId:i.participantManager.localParticipant.participantId,languageId:i.participantManager.localParticipant.languageId},status:"ringing",phrase:"ringing"}}}),causeId:t}).catch((e=>{const i=Cs(e,this.signalingAgentConfig);this.logger.info(`[${t}][sendProgress] error: ${Ve(i)}`),this.disposed||this.telemetryHelper.recordEvent(vl,{causeId:t,...i.error})}))}handleCallNotification(e){const t=_s(e);if(this.logger.info(`[${t}][handleCallNotification]`),this.telemetryHelper.recordIncomingEvent(nl,e),!ms(e.url,Dr.REPLACE))throw new Error(`[${t}][handleCallNotification]IncomingCallNotification should not be received in handleIncomingMsg`);this.telemetryHelper.recordIncomingEvent(rl,e),this.logger.info(`[${t}][handleCallNotification]replacementCallNotification`),this.signalingSessionCallback&&this.signalingSessionCallback.onIncomingCallReplacement(e.body,t)}handleMediaAnswer(e){this.telemetryHelper.recordIncomingEvent(Bs,e);const t=e.body,i=_s(e);if(this.logger.info(`[${i}][handleMediaAnswer]`),this.mediaRenegotiationManager.isOutgoingRenegotiationInProgress())this.mediaRenegotiationManager.handleMediaAnswer(t,i);else if(this.fsmState===Zr.SIGNALING_FSM_STATE.CONNECTED);else if(this.fsmState===Zr.SIGNALING_FSM_STATE.OUTGOING){if(Ts(e.headers,this.provisionalMediaAnswersSeenSoFar))return void this.logger.info(`[${i}][handleMediaAnswer] ignoring provisional answer retried by service`);t.mediaAnswer.sender&&(this.remoteUser=t.mediaAnswer.sender),this.resetCallEstablishmentTimeout(i),t.mediaAnswer.noRingBack||(this.telemetryHelper.setTimeToRingDuration(),this.onCallStatusChanged(Zr.CALL_STATUS.RINGING,i));const n=t.mediaAnswer.mediaContent;this.signalingSessionCallback.onAnswer({provisional:!0,renegotiation:!1,remoteEndpointId:t.mediaAnswer.sender?t.mediaAnswer.sender.endpointId:ls(),remoteParticipantId:this.getParticipantIdForOfferAnswer(n),mediaContent:n},i)}}async _sendCallAcceptanceAcknowledgement(e,t){this.http.sendPostRequest({url:e.body.callAcceptance.links.acknowledgement,requestName:cc.SEND_ACCEPTANCE_ACKNOWLEDGEMENT.name,payload:mh(this),causeId:t}).catch((e=>{const i=Cs(e,this.signalingAgentConfig);this.logger.info(`[${t}][_sendCallAcceptanceAcknowledgement] error: ${Ve(i)}`),this.disposed||this.telemetryHelper.recordEvent(Ja,{causeId:t,...i.error})}))}handleCallAcceptance(e){const t=_s(e);this.telemetryHelper.recordIncomingEvent(za,e,{enableQuickSendAcceptanceAck:this.signalingAgentConfig.enableQuickSendAcceptanceAck,causeId:t}),this.logger.info(`[${t}][handleCallAcceptance]enableQuickSendAcceptanceAck:\n            ${this.signalingAgentConfig.enableQuickSendAcceptanceAck}`),this.signalingAgentConfig.enableQuickSendAcceptanceAck?(this._sendCallAcceptanceAcknowledgement(e,t),this._processCallAcceptance(e,t)):(this._processCallAcceptance(e,t),this.http.sendPostRequest({url:e.body.callAcceptance.links.acknowledgement,requestName:cc.SEND_ACCEPTANCE_ACKNOWLEDGEMENT.name,payload:mh(this),causeId:t}).catch((e=>{const i=Cs(e,this.signalingAgentConfig);this.logger.info(`[${t}][handleCallAcceptance] error: ${Ve(i)}`),this.disposed||this.telemetryHelper.recordEvent(Ja,{causeId:t,...i.error})})))}handleCallAcceptanceSync(e){const t=_s(e);this.telemetryHelper.recordIncomingEvent(Ka,e,{enableQuickSendAcceptanceAck:this.signalingAgentConfig.enableQuickSendAcceptanceAck,causeId:t}),this.logger.info(`[${t}][handleCallAcceptanceSync] enableQuickSendAcceptanceAck:\n            ${this.signalingAgentConfig.enableQuickSendAcceptanceAck}`),this.signalingAgentConfig.enableQuickSendAcceptanceAck?yc.defer(this._processCallAcceptance,e,t):this._processCallAcceptance(e,t);const i=mh(this).payload;return this.telemetryHelper.addNetworkOperationCompleted(cc.SEND_ACCEPTANCE_ACKNOWLEDGEMENT.name,!0),i}getFakeRoster(e){const t=this.participantManager.getParticipantsToInitiateCallWith();let i;i=1===t.length?t[0].id:e.callAcceptance.acceptedBy.id;const n={id:i,displayName:e.callAcceptance.acceptedBy.id===i?e.callAcceptance.acceptedBy.displayName:"",languageId:e.callAcceptance.acceptedBy.languageId},r=e.callAcceptance.acceptedBy.endpointId;return{type:"MultiPartyEndpoint",participants:{[i]:{acceptedBy:e.callAcceptance.acceptedBy.id,details:n,endpoints:{[r]:{call:{},contentSharing:{},capabilities:e.callAcceptance.capabilities,participantId:e.callAcceptance.acceptedBy.participantId}}}}}}processCallAcceptance(e,t){this.logger.info(`[${t}][processCallAcceptance] ${Ve(e)}`),this.telemetryHelper.recordEvent(yl,{causeId:t}),this.fsmState=Zr.SIGNALING_FSM_STATE.CONNECTED,this.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT),this.isPreheatOnly||this.telemetryHelper.startCallConnectedWatch(),this.mediaRenegotiationManager.onCallConnected(t);let i=!1;e.callAcceptance.controllerName===Zr.MISC.LOBBY_CALL_CONTROLLER&&(this.logger.info(`[${t}][processCallAcceptance] Controller name is lobby so putting user in lobby`),this.participantManager.localParticipant.isLobby=!0,this.participantManager.localParticipant.endpointDetails.push({isLobby:!0,endpointId:this.participantManager.localParticipant.endpointId,participantId:this.participantManager.localParticipant.participantId}),i=!0,this.telemetryHelper.recordEvent(Cl,{causeId:t})),this.participantManager.localParticipant.isStaging=bc(e.callAcceptance),this.signalingSessionCallback.onMeetingGroupDetailsUpdated(e.callAcceptance.meetingGroupDetails,t),this.signalingSessionCallback.updateIsSharedLineAppearanceV2Activated(e.callAcceptance.callProperties?.isSharedLineAppearanceV2Activated),this.logger.info(`[${t}][processCallAcceptance] for localParticipant, isStaging is set to ${this.participantManager.localParticipant.isStaging}`);let n=this.mediaTypesToUse,r=ls();e.callAcceptance.acceptedBy&&(this.remoteUser=Us.fromWireParticipant(e.callAcceptance.acceptedBy),r=e.callAcceptance.acceptedBy.endpointId),e.callAcceptance.acceptedCallModalities&&e.callAcceptance.acceptedCallModalities.length>0&&(n=e.callAcceptance.acceptedCallModalities);const s=e.callAcceptance.mediaContent;this.callUsesMixer=s.fromMixer;const a=ps(n);this.telemetryHelper.addIncomingModalities(a),this.telemetryHelper.setAnsweredModalities(s.blob,!0),this.links[Zr.LINKS.MEDIA_RENEGOTIATION]=e.callAcceptance.links.mediaRenegotiation,this.links[Zr.LINKS.TRANSFER]=e.callAcceptance.links.transfer,this.links[Zr.LINKS.REPLACE]=e.callAcceptance.links.replacement,this.links[Zr.LINKS.HANGUP]=e.callAcceptance.links.callLeg,this.links[Zr.LINKS.KEEPALIVE]=e.callAcceptance.links.callLeg,this.links[Zr.LINKS.PARK]=e.callAcceptance.links.hold,this.links[Zr.LINKS.UPDATE_MEDIA_DESCRIPTIONS]=e.callAcceptance.links.updateMediaDescriptions,this.saveMediaControllerLinksIfAny(e.callAcceptance),this.scheduleKeepAlives(e.callAcceptance.callKeepAliveInterval);const o=this.getParticipantIdForOfferAnswer(s);this.signalingSessionCallback.onAnswer({provisional:!1,renegotiation:!1,remoteEndpointId:r,remoteParticipantId:o,callAcceptedByNGCVoicemail:o===Zr.KNOWN_BOTS.VOICEMAIL_BOT_ID,mediaTypes:a,mediaContent:s},t),this.setRealTimeState(2,t),this.onCallStatusChanged(Zr.CALL_STATUS.CONNECTED,t),i&&this.signalingSessionCallback.onSelfParticipantUpdated(this.participantManager.localParticipant,t),this.linkUpdateRequested.keepAliveLinks&&(this.logger.info(`[${t}][processCallAcceptance] Updating CC links as requested`),this.updateLinks(this.updateKeepAliveUrl,t))}updateGroupChatIds(e,t){const i=this.groupId,n=this.threadId,r=this.teamsMessageId,s=this.backroomThreadId;this.groupId=e.groupId,this.threadId=e.threadId,this.teamsMessageId=e.messageId,this.backroomThreadId=e.backroomThreadId,this.groupId===i&&this.threadId===n&&this.teamsMessageId===r&&this.backroomThreadId===s||this.signalingSessionCallback.onConversationUpdated({conversationType:this.conversationType,groupId:this.groupId,threadId:this.threadId,teamsMessageId:this.teamsMessageId,isMultiParty:this.multiParty,commandUrlPresence:this.getCommandUrlPresence(),meetingData:this.meetingData,region:this.region,meetingInfo:this.meetingInfo,callLimits:this.callLimits,isHuddleGroupCall:this.isHuddleGroupCall,backroomThreadId:this.backroomThreadId},t)}handleCallEnd(e){let t=e.body.callEnd||e.body;const i=_s(e);if(this.logger.info(`[${i}][handleCallEnd][content=${Ve(t)}]`),this.telemetryHelper.recordEvent(Qa,{origin:e.origin,code:t?t.code:"unknown",subCode:t?t.subCode:"unknown",resultCategories:t?t.resultCategories:[],causeId:i}),this.signalingAgentConfig.enableConversationTypeUpdateOnCallEnd&&(this.conversationType=t?.conversationType||this.conversationType),this.fsmState!==Zr.SIGNALING_FSM_STATE.IDLE)if(t.code===Zr.CALL_END_CODE.CONFLICT&&this.multiParty&&t.conversationUrl?.Location)this.handleConversationResolutionConflict(t,i);else{this.disposing=!0,t.callControllerTransactionEnd&&(this.logger.info("handleCallEnd: using CC end details specified in CS end"),t=t.callControllerTransactionEnd),t.broadcastOperationFailure&&(this.logger.info("handleCallEnd: using broadcastOperationFailure end details specified in CS end"),t=t.broadcastOperationFailure);const e=t.code===Zr.CALL_END_CODE.SUCCESS||t.code===Zr.CALL_END_CODE.CANCEL||t.code===Zr.CALL_END_CODE.REJECT;this.telemetryHelper.setTerminatingData({terminatingEnd:hc.CALL_TERMINATING_END.REMOTE,resultDetail:t.phrase,resultValue:e?hc.RESULT_VALUE.SUCCESS:hc.RESULT_VALUE.FAILURE,endCode:t.code,endSubCode:t.subCode,resultCategories:t?t.resultCategories:[],causeId:i});const n={code:t.code,subCode:t.subCode,phrase:t.phrase,resultCategories:t.resultCategories,pickupCode:""};this.fsmState=Zr.SIGNALING_FSM_STATE.IDLE,t.acceptedElsewhereBy&&(this.acceptedElsewhereBy={id:t.acceptedElsewhereBy.id,displayName:t.acceptedElsewhereBy.displayName}),t.unparkContent&&(t.unparkContent.CallParkAdditionalContext&&(this.parkAdditionalContextJson=JSON.stringify(t.unparkContent.CallParkAdditionalContext),this.serverHoldLocation=t.unparkContent.CallParkAdditionalContext.ConversationControllerLocation),t.unparkContent.pickupCode&&(n.pickupCode=t.unparkContent.pickupCode)),this.onCallStatusChanged(Zr.CALL_STATUS.REMOTE_TERMINATED,i,n),this.dispose(n,i)}else this.logger.info(`[${i}][handleCallEnd] not handling incoming callEnd since fsmstate = SIGNALING_FSM_STATE.IDLE`)}handleConversationResolutionConflict(e,t){this.logger.info(`[${t}][handleConversationResolutionConflict]`);const i={...e,phrase:e.phrase||"Conflict Resolution Error"};if(this.fsmState===Zr.SIGNALING_FSM_STATE.OUTGOING_FOR_ROSTER_ONLY||this.fsmState===Zr.SIGNALING_FSM_STATE.CONNECTED_FOR_ROSTER_ONLY)this.fsmState=Zr.SIGNALING_FSM_STATE.IDLE,this.http.cancelRequestIfPending(cc.JOIN_CONVERSATION_WITHOUT_CALL_MODALITY.name,t,void 0,i),this.subscribeToCall(e.conversationUrl.Location,e.correlationId,this.lastUsedJoinCallOptions?this.lastUsedJoinCallOptions.clientEndpointCapabilities:0,{meetingData:this.meetingData,meetingPreferences:this.meetingPreferences,additionalEndpointProperties:this.lastUsedJoinCallOptions?.additionalEndpointProperties},t);else{this.fsmState=Zr.SIGNALING_FSM_STATE.IDLE,this.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT);const n={meetingData:this.meetingData,meetingPreferences:this.meetingPreferences};if(this.lastUsedJoinCallOptions){const e=this.lastUsedJoinCallOptions.scenario;n.muted=this.lastUsedJoinCallOptions.muted,n.scenario=`409Redirect${e||""}`,n.isPreheatOnly=this.lastUsedJoinCallOptions.isPreheatOnly,n.clientEndpointCapabilities=this.lastUsedJoinCallOptions.clientEndpointCapabilities,n.clientEndpointDebugContent=this.lastUsedJoinCallOptions.clientEndpointDebugContent,n.additionalEndpointProperties=this.lastUsedJoinCallOptions.additionalEndpointProperties}else n.scenario="409RedirectJoin";this.setInitialTelemetry("JoinCall",{correlationId:e.correlationId,causeId:t,conversationServiceUrl:e.conversationUrl.Location,joinCallOptions:n,offerGenerationTime:void 0}),this.http.cancelRequestIfPending(cc.JOIN_CONVERSATION.name,t,void 0,i),this.http.cancelRequestIfPending(cc.START_CALL.name,t,void 0,i),this.joinGivenConversation(e.conversationUrl.Location,e.correlationId,this.lastUsedOutgoingMediaContent,this.mediaTypesToUse,void 0,n,t)}}handleCallProgress(e){this.telemetryHelper.recordIncomingEvent(Xa,e);const t=_s(e);this.logger.info(`[${t}][handleCallProgress]`);const i=e.body.callProgress;this.fsmState===Zr.SIGNALING_FSM_STATE.OUTGOING&&(this.telemetryHelper.setTimeToRingDuration(),this.resetCallEstablishmentTimeout(t),this.onCallStatusChanged(Zr.CALL_STATUS.RINGING,t),"forwarded"===i.status&&this.signalingSessionCallback.onCallForwarded({destinationType:i.forwardingDestinationType||"user"},t))}resetCallEstablishmentTimeout(e){this.logger.info("resetCallEstablishmentTimeout"),this.timeoutManager.stopTimer(Zr.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT),this.timeoutManager.startTimer(Zr.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT,(()=>{this.handleCallEstablishmentTimeout(e)}),Zr.TIMEOUT_VALUES_IN_SECONDS.OUTGOING_CALL_ESTABLISHMENT_TIMEOUT)}handleMediaAcknowledgement(e){this.telemetryHelper.recordIncomingEvent(ol,e);const t=e.body,i=_s(e);this.currentCallStatus!==Zr.CALL_STATUS.CONNECTED?this.telemetryHelper.recordEvent(ll,{causeId:i}):this.mediaRenegotiationManager.handleMediaAcknowledgment(t,i)}handleConversationUpdate(e){const t=e.body,i=_s(e);this.logger.info(`[${i}][handleConversationUpdate]content=${Ve(t)}`),this.telemetryHelper.recordIncomingEvent(ba,e),this.processConversationServiceResponse(t,i,2)}endBroadcastMeeting(e){this.logger.info(`[${e}][endBroadcastMeeting]`),this.broadcastSession=null}handleLocalParticipantUpdate(e){const t=e.body,i=_s(e);this.logger.info(`[${i}][handleLocalParticipantUpdate]content=${Ve(t)}`),this.telemetryHelper.recordIncomingEvent(Pa,e),this.processLocalParticipantUpdateResponse(t,i)}handleAddModalityFailure(e){const t=e.body,i=_s(e);this.logger.info(`[${i}][handleAddModalityFailure]`),this.telemetryHelper.recordIncomingEvent(fo,e),t.modalityFailure.contentSharing?this.contentSharingManager?.handleAddModalityFailure(t,i):t.modalityFailure.groupChat?this.signalingSessionCallback.onChatModalitySetupFailed({code:t.modalityFailure.groupChat.code,subCode:t.modalityFailure.groupChat.subCode,phrase:t.modalityFailure.groupChat.phrase,resultCategories:t.modalityFailure.groupChat.resultCategories},i):t.modalityFailure.broadcast&&this.broadcastSession&&this.broadcastSession.handleAddBroadcastModalityFailure(t,i)}handleAddModalitySuccess(e){const t=e.body,i=_s(e);this.logger.info(`[${i}][handleAddModalitySuccess]`),this.telemetryHelper.recordIncomingEvent(mo,e),t.modalitySuccess.contentSharing?this.contentSharingManager?.handleAddModalitySuccess(t,i):t.modalitySuccess.groupChat?this.logger.info(`[${i}][handleAddModalitySuccess] group modality ${Ve(t.modalitySuccess.groupChat)}`):t.modalitySuccess.broadcast&&this.broadcastSession&&this.broadcastSession.handleAddBroadcastModalitySuccess(t,i)}handleTransferRequested(e){const t=e.body.callTransfer,i=_s(e);this.logger.info(`[${i}][handleTransferRequested]`),t.parkType?(this.telemetryHelper.recordIncomingEvent(Fo,e,{type:t.parkType}),this.telemetryHelper.addSharedCorrelationId(t.sharedCorrelationId)):"voicemail"===t.target.endpointType?(this.logger.info(`[${i}][handleTransferRequested] target endpointType = ${t.target.endpointType}`),this.telemetryHelper.recordIncomingEvent(xo,e)):this.telemetryHelper.recordIncomingEvent(xo,e),this.links[Zr.LINKS.TRANSFER_ACCEPTANCE]=t.links.transferAcceptance,this.links[Zr.LINKS.TRANSFER_COMPLETION]=t.links.transferCompletion,this.signalingSessionCallback.onTransferRequested?this.signalingSessionCallback.onTransferRequested(t,i):this.logger.info(`[${i}][handleTransferRequested] failed, no callback defined`)}handleTransferAcceptance(e){const t=_s(e);this.logger.info(`[${t}][handleTransferAcceptance]`),this.telemetryHelper.recordIncomingEvent(Ll,e),this.signalingSessionCallback.onTransferAccepted?this.signalingSessionCallback.onTransferAccepted(t):this.logger.info(`[${t}][handleTransferAcceptance]failed, no callback defined`)}handleTransferCompletion(e){const t=e.body,i=_s(e);this.logger.info(`[${i}][handleTransferCompletion]`),t.sharedCorrelationId&&this.telemetryHelper.addSharedCorrelationId(t.sharedCorrelationId),void 0!==t.unparkContent?.pickupCode&&(t.unparkContent.pickupCode=t.unparkContent.pickupCode.toString(),this.telemetryHelper.recordIncomingEvent($l,e)),this.signalingSessionCallback.onTransferCompleted?(e.body.transferCompletion&&(0===e.body.transferCompletion.code?this.telemetryHelper.recordIncomingEvent(Vl,e):(this.logger.info(`[${i}][handleTransferCompletion]-1-code: ${t.transferCompletion.code}, message: ${Ve(e)}`),this.telemetryHelper.recordIncomingEvent(Lo,e,{code:t.transferCompletion.code,subcode:t.transferCompletion.subCode,resultCategories:t.transferCompletion.resultCategories}))),this.signalingSessionCallback.onTransferCompleted(t,i)):(e.body.transferCompletion&&(e.body.transferCompletion.code===Zr.CALL_END_CODE.NETWORK_ERROR?this.telemetryHelper.recordIncomingEvent(xl,e):this.telemetryHelper.recordIncomingEvent(Lo,e,{code:t.transferCompletion.code,subcode:t.transferCompletion.subCode,resultCategories:t.transferCompletion.resultCategories})),this.logger.info(`[${i}][handleTransferCompletion]failed, no callback defined`))}handleRosterUpdate(e,t){const i=e.body,n=_s(e);this.disposing||this.disposed?this.logger.info(`[${n}][handleRosterUpdate]failed=ignore call ending or ended`):this.internalHandleRosterUpdate(i,t,n)}handleNewMediaOffer(e){const t=_s(e);this.telemetryHelper.recordIncomingEvent(ul,e);const i=e.body.mediaOfferReady.mediaContent;this.callUsesMixer=i.fromMixer,this.signalingSessionCallback.onNewOffer({mediaContent:i,renegotiation:!1},t)}internalHandleRosterUpdate(e,t,i){if(e&&"Delta"!==e.type&&"MultiPartyEndpoint"!==e.type)this.logger.warn(`[${i}][internalHandleRosterUpdate] roster.type=${e.type} is invalid`);else{this.logger.info(`[${i}][internalHandleRosterUpdate]`);try{this.participantManager.handleRosterUpdate(e,t,i),this.contentSharingManager?.handleIncomingContentSharingFromRoster(e,t,i)}catch(t){const n={code:Zr.CALL_END_CODE.BAD_SERVICE_RESPONSE,subCode:Zr.CALL_END_SUB_CODE.ROSTER_HANDLING_INVALID_SERVICE_RESPONSE,phrase:t?.toString()};throw this.logger.info(`[${i}][internalHandleRosterUpdate] ${He(n)}`),this.telemetryHelper.recordRosterEvent(e,_a,i),n}}}scheduleKeepAlives(e){const t=.9*e*1e3;this.logger.info(`scheduleKeepAlives: every ${t} milliseconds`),this.keepAliveInterval=t,this.keepAliveTimer=window.setInterval(this.sendKeepAlive.bind(this),this.keepAliveInterval)}scheduleConversationKeepAlive(){if(!this.conversationKeepAliveTimer&&!this.disposed){if(!this.conversationKeepAliveInterval){const e=function(e){const t=Math.floor(11*Math.random())+10;return Math.floor(e*(1-t/100))}(1e3*this.signalingAgentConfig.csaTimeoutConfiguration.conversationKeepAliveTimeoutSec);this.logger.info(`sendConversationKeepAlive: every ${e} milliseconds`),this.conversationKeepAliveInterval=e}this.conversationKeepAliveTimer=window.setInterval(this.sendConversationKeepAlive.bind(this),this.conversationKeepAliveInterval)}}sendConversationKeepAlive(){this.logger.info("sendConversationKeepAlive"),this.disposed?this.logger.info("sendConversationKeepAlive ignored"):(this.logger.info("sendConversationKeepAlive keepAlive count = "+this.conversationKeepAliveCount++),this.sendToUpdateConversationLinks(!0))}sendKeepAlive(){this.logger.info("sendKeepAlive"),this.disposed?this.logger.info("sendKeepAlive ignored"):(this.logger.info("sendKeepAlive keepAlive count = "+this.keepAliveCount++),this.sendToKeepAliveUrl(null))}sendToUpdateConversationLinks(e,t=os()){if(this.disposed)return;const i=this.logger.createChild(`[${t}][sendToUpdateConversationLinks]`,this.correlationId),n=e?function(e){hs(e,"signalingSession cannot be null");const t={type:"Delta",rosterUpdate:is(e,Or.CONV_ROSTER_UPDATE)};return{payload:{participants:{from:{id:e.participantManager.localParticipant.id,displayName:e.participantManager.localParticipant.displayName,endpointId:e.participantManager.localParticipant.endpointId,participantId:e.participantManager.localParticipant.participantId,languageId:e.participantManager.localParticipant.languageId}},roster:t,links:gs(e,Or)}}}(this):{},r=e?cc.UPDATE_CONVERSATION_LINKS.name:cc.SEND_CONVERSATION_KEEP_ALIVE.name,s=this.links[Zr.LINKS.NOTIFICATION_LINKS];i.info(`shouldUpdateUrl: ${e}, url: ${s}, payload: ${Ve(n)}`),s&&(this.conversationKeepAliveTimer&&(window.clearInterval(this.conversationKeepAliveTimer),this.conversationKeepAliveTimer=0),this.http.sendPostRequest({url:s,payload:n,withoutTrouter:!0,requestName:r,causeId:t}).then((e=>{this.disposed||(this.telemetryHelper.recordEvent(gl,{causeId:t}),this.processConversationServiceResponse(e.response,t,2))})).catch((e=>{const i=Cs(e,this.signalingAgentConfig),n=ws(i.error.code);this.logger.info(`[${t}][updateConversationLinks] error: ${Ve(i)}, retryable: ${n}`),this.disposed||(this.telemetryHelper.recordEvent(ml,{causeId:t,...i.error}),n?this.scheduleConversationKeepAlive():this.links[Zr.LINKS.NOTIFICATION_LINKS]=null)})))}sendToKeepAliveUrl(e,t=os()){const i=this.logger.createChild(`[${t}][sendToKeepAliveUrl]`,this.correlationId);i.info(`payload: ${Ve(e)}`),window.clearInterval(this.keepAliveTimer),this.disposed||(this.telemetryHelper.recordEvent(El),this.http.sendPostRequest({url:this.links[Zr.LINKS.KEEPALIVE],payload:e,requestName:cc.SEND_KEEP_ALIVE.name,withoutTrouter:!0,causeId:t}).then((()=>{this.restartKeepAliveInterval()})).catch((e=>{const t=Cs(e,this.signalingAgentConfig);i.info(`error: ${Ve(t)}`),this.restartKeepAliveInterval(!0,t.error)})))}handleCallEstablishmentTimeout(e,t,i){const n={code:Zr.CALL_END_CODE.TIMEOUT,subCode:t||Zr.CALL_END_SUB_CODE.CALL_ESTABLISHMENT_TIMEOUT,phrase:i||Zr.CALL_END_PHRASE.ESTABLISHMENT_TIMEOUT,resultCategories:[Ir]};this.isPromotingToRealtime?this.onPromotionCompleted(!0,n,e):(this.telemetryHelper.recordEvent(Ya),this.telemetryHelper.setTerminatingData({terminatingEnd:hc.CALL_TERMINATING_END.LOCAL,resultValue:hc.RESULT_VALUE.FAILURE,resultDetail:n.phrase,endCode:n.code,endSubCode:n.subCode,causeId:e,resultCategories:n.resultCategories}),this.fsmState=Zr.SIGNALING_FSM_STATE.IDLE,this.onCallStatusChanged(Zr.CALL_STATUS.LOCAL_TERMINATED,e,n),this.dispose(n,e))}handleCallTransferTimeout(e,t){if(this.disposed)return void this.logger.info("Transfer: handleCallTransferTimeout ignored");const i={code:Zr.CALL_END_CODE.TIMEOUT,phrase:Zr.CALL_END_PHRASE.TRANSFER_COMPLETION_TIMEOUT};this.signalingSessionCallback.onTransferCompleted&&(!1===t?this.telemetryHelper.recordEvent(Lo,{code:Zr.CALL_END_CODE.TIMEOUT,subcode:Zr.CALL_END_SUB_CODE.TRANSFER_COMPLETE_TIMEOUT,causeId:e}):!0===t&&this.telemetryHelper.recordEvent(Fl,{causeId:e}),this.signalingSessionCallback.onTransferCompleted({transferCompletion:i},e))}checkCorrelationIdChange(e,t){if(e&&e.headers){const i=e.headers.get(Zr.HEADERS.CORRELATION_ID);if(i&&i.length){const n=[Dr.CONV_CONTENT_SHARING_UPDATE,Dr.CONV_CONTENT_SHARING_END].some((t=>e.url&&ms(e.url,t)));this.correlationId===i||n||(this.logger.info(`[${t}]checkCorrelationIdChange:${this.correlationId} => ${i}`),this.telemetryHelper.addChangingCorrelationId(this.correlationId,i),this.updateCorrelationId(i,t))}}}getCommandUrlPresence(){let e=0;return this.links[Zr.LINKS.MUTE]&&(e|=1),this.links[Zr.LINKS.UNMUTE]&&(e|=2),e}getCallNotFoundTransactionEnd(){return{code:Zr.CALL_END_CODE.CALL_DOES_NOT_EXIST,subCode:0,phrase:Zr.CALL_END_PHRASE.CALL_DOES_NOT_EXIST}}getTerminatingCallResultDetail(e,t){return Ve({source:e,...t})}dispose(e,t){this.disposed||(this.logger.info(`[${t}][dispose] end reason ${Ve(e)}`),this.disposed=!0,this.disposing=!1,this.tearDownConnectionCheck(),this.conversationKeepAliveTimer&&(window.clearInterval(this.conversationKeepAliveTimer),this.conversationKeepAliveTimer=0),this.keepAliveTimer&&window.clearInterval(this.keepAliveTimer),this.brokerService&&this.brokerService.dispose(),this.http.cancelAllRequests(t).then((()=>{this.signalingAgent.onCallCompleted(this.sessionId,t),this.signalingAgentConfig.trouterUrlGetter&&this.signalingAgentConfig.trouterUrlGetter.trouterUrl.changed.off(this.onTrouterUrlChanged),this.signalingAgentConfig.trouterServiceProvider&&this.signalingAgentConfig.trouterServiceProvider.offStateChanged(this.onTrouterStateChanged),this.timeoutManager.dispose(),this.timeoutManager=null,this.participantManager.dispose(e,t),this.callOperationHandler.dispose("call ended",e,t),this.participantManager=null,this.mediaRenegotiationManager?.dispose(),this.mediaRenegotiationManager=null,this.contentSharingManager?.dispose(e,t),this.contentSharingManager=null,this.telemetryHelper.dispose(),this.telemetryHelper=null,this.webRtcSignalingManager.dispose(),this.webRtcSignalingManager=null})))}},Hh=class{constructor(e){this.endpointId=ls(),this.signalingSessions={},this.clientSupportsGenericTokenAPI=!1,this.getNewSignalingSession=(e,t,i,n)=>{const r=os();hs(e,"selfParticipant should be a non null value"),hs(t,"signalingSessionCallback should be a non null value");const s=i||ls();cs(s,"signalingSession id generated cannot be null or empty"),this.checkConfigChange(r);const a=function(e,t,i,n,r,s){return new Vh(e,t,i,n,r,s)}(e,t,this.signalingAgentConfig,s,this,n),o=a.sessionId;return this.signalingSessions[o]=a,this.logger.info(`[${r}]Created new signalingSession with correlation ID ${s} and session ID ${o}`),a},this.resolvePotentialCallConflict=e=>{const t=os();let i;if(this.logger.info(`[${t}][resolvePotentialCallConflict]`),!e.multiParty)return Object.keys(this.signalingSessions).forEach((t=>{this.isSessionInConflictingState(this.signalingSessions[t],!e.isIncomingCall)&&(i=e.isIncomingCall?this.compareAndGetConflictingSession(e,this.signalingSessions[t]):this.compareAndGetConflictingSession(this.signalingSessions[t],e))})),i?(this.logger.info("Call conflict done, conflicting session callId=",i.correlationId,"urlIdentifier=",i.urlIdentifier),i.telemetryHelper.recordEvent(Ba),this.signalingAgentConfig.endConflictedCall?(this.endConflictedSession(i,t),i):void 0):void 0},this.handleIncomingNotification=e=>{if(hs(e,"request should be a non null value"),this.logger.info(`handleIncomingNotification to : ${e.url}`),!e.body&&!e.rawBody)return this.logger.error("request has no body"),this.buildNotificationResponse(Zr.HTTP_STATUS_CODES.BAD_REQUEST);let t=Zr.HTTP_STATUS_CODES.OK;const i=function(e){const t=e.match(new RegExp(`/${i=Zr.URL_BASE.CALLAGENT,i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}/+([^/]+)`,"i"));var i;return t?t[1]:null}(e.url);if(i){const n=this.signalingSessions.hasOwnProperty(i);if(this.logger.info(`Is session found:${n}`),n){const t=this.signalingSessions[i];if(e.headers=new ts(e.headers),bs(e.headers))try{if(!Ps(e.headers))throw new Error("Unsupported encoding");const t=Is(e.rawBody),i=JSON.parse(t);e.body=i}catch(e){return t.telemetryHelper.recordEvent(jo),this.buildNotificationResponse(Zr.HTTP_STATUS_CODES.BAD_REQUEST)}if(t.canHandleIncomingMsgSync(e))return t.handleIncomingMsgSync(e);window.setTimeout((()=>{if(this.signalingSessions.hasOwnProperty(i)){const t=this.signalingSessions[i];t.handleIncomingMsgAsync(e).catch((e=>{t&&t.telemetryHelper&&t.telemetryHelper.recordEvent(Jo),this.logger.error(`handling IncomingMsg failed with error: ${e}`)}))}}),0)}else this.logger.info(`Incoming message for session ID ${i}, but session was not found!`),t=Zr.HTTP_STATUS_CODES.NOT_FOUND}else this.logger.error(`Could not retrieve session ID from Url path. Path = ${e.url}`),t=Zr.HTTP_STATUS_CODES.BAD_REQUEST;const n=this.buildNotificationResponse(t);return this.logger.info(`Result code:${Ve(n)}`),n},this.onCallCompleted=(e,t)=>{this.signalingSessions.hasOwnProperty(e)?(delete this.signalingSessions[e],this.logger.info(`[${t}][onCallCompleted] Session ID ${e} found. Deleted from signalingSession table`)):this.logger.info(`[${t}][onCallCompleted] Session ID ${e} not found. Could not delete from signalingSession table`)},this.applyAuthTokenCacheConfig=e=>{this.signalingAgentConfig.enableTokenCache?(this.authTokenManager.setTokenCaching(!0,e),this.signalingAgentConfig.enableTokenPrefetch&&this.authTokenManager.getToken(e).then((()=>{this.logger.info(`[${e}] token prefetch success`)})).catch((t=>{this.logger.info(`[${e}] token prefetch failure, error=${Ve(t)}`)}))):this.authTokenManager.setTokenCaching(!1,e),this.signalingAgentConfig.enableTokenCacheForGenericTokenAPI?this.authTokenManager.setTokenCachingForGenericTokenAPI(!0,e):this.authTokenManager.setTokenCachingForGenericTokenAPI(!1,e)},this.endConflictedSession=(e,t)=>{this.logger.info("Call conflict, ending signalingSession with callId=",e.correlationId,"urlIdentifier=",e.urlIdentifier),e.endAsync({code:Zr.CALL_END_CODE.CONFLICT,subCode:Zr.CALL_END_SUB_CODE.CONFLICT_IN_NG,phrase:Zr.CALL_END_PHRASE.CONFLICT},{forEveryone:!1,causeId:t})},this.compareAndGetConflictingSession=(e,t)=>{if(!ss(e.incomingCallCallerId)||!ss(t.participantManager.localParticipant.id))return;const i=as(e.incomingCallCallerId),n=as(t.participantManager.getParticipantsToInitiateCallWith().length&&t.participantManager.getParticipantsToInitiateCallWith()[0].id),r=as(t.participantManager.localParticipant.id);return n===i?r>i?e:t:void 0},this.isSessionInConflictingState=(e,t)=>{if(!e)return this.logger.info("Call conflict, ignore, session already disposed"),!1;const i=[Zr.CALL_STATUS.IDLE,Zr.CALL_STATUS.CONNECTING,Zr.CALL_STATUS.RINGING];return!e.multiParty&&i.indexOf(e.getCallStatus())>-1&&(t&&e.isIncomingCall||!t&&!e.isIncomingCall)},this.buildNotificationResponse=(e,t)=>this.signalingAgentConfig.supportsSynchronousTrouterResponse?{resultCode:e,responseBody:t}:e,uc(e),this.signalingAgentConfig=e,this.logger=e.logger.createChild("SignalingAgent"),hs(e,"signalingAgentConfig should be a non null value"),this.logger.info(e.isWebRtcEnabled?"webRTC enabled":"ORTC enabled");const t={aadTokenExpirationTimeInSeconds:e.aadTokenExpirationTimeInSeconds,caeTokenExpirationTimeInSeconds:e.caeTokenExpirationTimeInSeconds,disableTokenMigrationHeader:e.disableTokenMigrationHeader,enablePublishTokenTelemetry:e.enablePublishTokenTelemetry,refreshTimeBeforeTokenTimeoutInSeconds:e.refreshTimeBeforeTokenTimeoutInSeconds,forceClearExpiredTokens:e.forceClearExpiredTokens,enableRefreshToken:e.enableRefreshToken,enableRefreshTokenRetry:e.enableRefreshTokenRetry,enableRefreshTokenRetryInSeconds:e.enableRefreshTokenRetryInSeconds};this.authTokenManager=Sc(this.logger,e.skypeToken,t,e.telemetryManager),this.applyAuthTokenCacheConfig(os()),ts.useLowerCaseHeaders=e.forceLowercaseHttpHeaders}updateSignalingAgentConfig(e){const t=os(),i=JSON.stringify(e,((e,t)=>e?String(t):t));this.logger.info(`[${t}] updateSignalingAgentConfig, SignalingAgentConfig: ${i}`),this.logger.info(`[${t}] ecsEtag=${e.ecsEtag}`),uc(e),this.updatedSignalingAgentConfig=e,this.authTokenManager?.updateTokenSettings({aadTokenExpirationTimeInSeconds:e.aadTokenExpirationTimeInSeconds,caeTokenExpirationTimeInSeconds:e.caeTokenExpirationTimeInSeconds,refreshTimeBeforeTokenTimeoutInSeconds:e.refreshTimeBeforeTokenTimeoutInSeconds,disableTokenMigrationHeader:e.disableTokenMigrationHeader,enablePublishTokenTelemetry:e.enablePublishTokenTelemetry,forceClearExpiredTokens:e.forceClearExpiredTokens,enableRefreshToken:e.enableRefreshToken,enableRefreshTokenRetry:e.enableRefreshTokenRetry,enableRefreshTokenRetryInSeconds:e.enableRefreshTokenRetryInSeconds}),ts.useLowerCaseHeaders=e.forceLowercaseHttpHeaders}updateUrls(e,t,i){this.logger.info(`updateUrls: conversationServiceUrl: ${e}, uploadLogRequestUrl: ${t}, enforceUrls: ${i}`),this.updatedSignalingAgentConfig=this.updatedSignalingAgentConfig||this.signalingAgentConfig,i||!this.updatedSignalingAgentConfig.isConversationServiceUrlFromEcs?this.updatedSignalingAgentConfig.conversationServiceUrl=e||this.updatedSignalingAgentConfig.conversationServiceUrl:this.updatedSignalingAgentConfig.conversationServiceUrl=this.updatedSignalingAgentConfig.conversationServiceUrl||e,i||!this.updatedSignalingAgentConfig.isUploadLogRequestUrlFromEcs?this.updatedSignalingAgentConfig.uploadLogRequestUrl=t||this.updatedSignalingAgentConfig.uploadLogRequestUrl:this.updatedSignalingAgentConfig.uploadLogRequestUrl=this.updatedSignalingAgentConfig.uploadLogRequestUrl||t}update(e){this.logger.info(`update accountConfiguration ${JSON.stringify(e)}`),e&&e.clientSupportsGenericTokenAPI!==this.clientSupportsGenericTokenAPI&&(this.clientSupportsGenericTokenAPI=e.clientSupportsGenericTokenAPI,this.authTokenManager.updateTokenSettings({clientSupportsGenericTokenAPI:this.clientSupportsGenericTokenAPI})),this.accountConfig=e}sendPushAsync(e,t,i,n,r=os()){const s=new vc(this.signalingAgentConfig.piiScrubber),a=`sendPush[local participant mri = ${s.scrubMriOrOmit(e)}][recipientList = ${s.scrubMriOrOmit(t)}][headers = ${i})][causeId = ${r}]`;if(!e?.id)return this.logger.info(`${a} Empty localParticipantId`),Promise.reject("invalid localParticipantId");if(!t||0===t.length||t.every((e=>e&&""===e.id)))return this.logger.info(`${a} Empty recipientList`),Promise.reject("invalid recipientList");if(!i)return this.logger.info(`${a} Empty headers`),Promise.reject("invalid headers");if(!n||null===ys(n))return this.logger.info(`${a} Invalid body.`),Promise.reject("invalid body");const o={...ys(n),To:Array.from(t,(e=>e.id)),From:e.id},l=new ts(i);l.hasOwnPropertyCaseInsensitive(Zr.HEADERS.CORRELATION_ID)||l.set(Zr.HEADERS.CORRELATION_ID,Hi()),l.hasOwnPropertyCaseInsensitive(Zr.HEADERS.MESSAGE_ID)||l.set(Zr.HEADERS.MESSAGE_ID,Hi()),l.hasOwnPropertyCaseInsensitive(Zr.HEADERS.PARTICIPANT_ID)||l.set(Zr.HEADERS.PARTICIPANT_ID,Hi()),l.hasOwnPropertyCaseInsensitive(Zr.HEADERS.CONTENT_TYPE)||l.set(Zr.HEADERS.CONTENT_TYPE,"application/json"),l.hasOwnPropertyCaseInsensitive(Zr.HEADERS.CLIENT_USER_AGENT)&&l.set(Zr.HEADERS.CLIENT_USER_AGENT,l.get(Zr.HEADERS.CLIENT_USER_AGENT)+"/TsCallingVersion=2024.13.01.19/Ovb=5d60bfcfbf65862f074bd44f3beb1676fd6f338a");const d=this.signalingAgentConfig.httpRequestDispatcher.getRequestOptions("POST",l?.getAll(),JSON.stringify(o),3e4);return new Promise(((e,t)=>{this.signalingAgentConfig.httpRequestDispatcher.postAsync(this.signalingAgentConfig.uploadLogRequestUrl||Zr.URL_DEFAULTS.UPLOAD_LOG_URL,d).then((()=>{e()})).catch((e=>{t(e)}))}))}getSignalingSession(e){for(const t of Object.keys(this.signalingSessions)){const i=this.signalingSessions[t];if(i.correlationId===e)return i}return null}updateToken(e,t,i,n,r){this.authTokenManager.updateToken(e,t,i,n,r)}setTokenRequiredCallBack(e){this.authTokenManager.setTokenRequiredCallBack(e)}resetAuthTokenManager(){this.setTokenRequiredCallBack(null),this.authTokenManager.setDisableTimerFlag(!0),this.authTokenManager.dispose()}checkConfigChange(e){this.updatedSignalingAgentConfig&&this.updatedSignalingAgentConfig!==this.signalingAgentConfig&&(this.signalingAgentConfig=this.updatedSignalingAgentConfig,this.updatedSignalingAgentConfig=null,this.applyAuthTokenCacheConfig(e))}},Bh=/;aliases=.*$/i,$h="8:",jh="4:";function Gh(e){return e?e.replace(Bh,""):e}function Wh(e,t){let i=e;return t&&(i+=";aliases=2:"+t),i}var qh=(e,t)=>t&&void 0!==t.phase&&!!e[t.phase],zh=(e,t)=>t&&void 0!==t.phase&&t.phase===e;function Kh(e){const t={},i=e=>{t[e]={status:"Pending"}},n=(e,i)=>{t[e].t=i,delete t[e].status},r=(e,i,n)=>{t[e].status="Failed",t[e].t=i,t[e].reason=Ve(n)};return{execute:async(s,a)=>{const o=e.createChild(`[phase=${s}]`);i(s),o.info("started");const l=(new Date).getTime();try{const e=await a(),t=+new Date-l;return o.logSuccess(`done, time=${t}`),n(s,t),e}catch(e){const i=+new Date-l;throw o.logFailure(`time=${i}, error=${Ve(e)}`),r(s,i,e),{phase:s,error:e,phases:t}}},executeSync:(s,a)=>{const o=e.createChild(`[phase=${s}]`);o.info("started"),i(s);const l=(new Date).getTime();try{const e=a(),t=+new Date-l;return n(s,t),o.logSuccess(`done, time=${t}`),e}catch(e){const i=+new Date-l;throw o.logFailure(`time=${i}, error=${Ve(e)}`),r(s,i,e),{phase:s,error:e,phases:t}}},getTelemetryData:()=>t}}function Jh(e,t){return-1!==t.indexOf(e)}var Yh,Qh,Xh,Zh={0:[1,2,8,6,10,11,9],1:[2,6,7,10,13],2:[1,3,6,7,9,10,13,14],3:[6,7,4,5,10,13],8:[1,11,10,2,9,6,7],4:[6,7,3,5,10,13],5:[6,7,3,4,10,13],9:[3,6,7,10,13],10:[3,6,7,9,4,5,13,15],13:[3,6,7,4,5],14:[3,6,7,10,13],15:[3,6,7,4,5,13],11:[12,1,2,6,7],12:[2,6,7],6:[7],7:[]};(e=>{let t;var i;let n;var r;let s;var a;let o;var l;(i=t=e.VideoEffectType||(e.VideoEffectType={})).Off="off",i.BackgroundBlur="blur",i.BackgroundReplacement="replacement",(r=n=e.PowerPreference||(e.PowerPreference={})).Default="default",r.HighPerformance="high-performance",r.LowPower="low-power",(a=s=e.ProcessorType||(e.ProcessorType={})).Wasm="Wasm",a.Webgl2="Webgl2",(l=o=e.EffectQualityChangeReason||(e.EffectQualityChangeReason={}))[l.ExternalParam=0]="ExternalParam",l[l.Performance=1]="Performance",l[l.RendererSize=2]="RendererSize"})(Yh||(Yh={})),(e=>{let t;var i;let n;var r;let s;var a;let o;var l;let d;var c;(i=t=e.CallType||(e.CallType={}))[i.P2P=0]="P2P",i[i.Conference=1]="Conference",i[i.PSTN=2]="PSTN",i[i.BroadcastingConf=3]="BroadcastingConf",(r=n=e.AudioUsageMode||(e.AudioUsageMode={}))[r.Default=0]="Default",r[r.LongRangeSpeaker=1]="LongRangeSpeaker",r[r.Auditorium=2]="Auditorium",(a=s=e.AecPerfProfile||(e.AecPerfProfile={}))[a.Normal=0]="Normal",a[a.Soc=1]="Soc",a[a.Mobile=2]="Mobile",a[a.NoisyTimestamps=3]="NoisyTimestamps",(l=o=e.VqeMode||(e.VqeMode={}))[l.Off=0]="Off",l[l.SkypeNS=1]="SkypeNS",l[l.SkypeAEC=2]="SkypeAEC",l[l.SkypeVQE=3]="SkypeVQE",l[l.DeepNS=4]="DeepNS",l[l.DeepVQE=5]="DeepVQE",(c=d=e.AudioEffectType||(e.AudioEffectType={})).Off="Off",c.NoiseSuppressionDeep="Deep NS",c.NoiseSuppressionClassic="Classic NS",c.EchoCancellationClassic="Classic AEC",c.VoiceQualityEnhancementClassic="Classic VQE",c.VoiceQualityEnhancementDeep="Deep VQE"})(Qh||(Qh={})),(e=>{let t;var i;let n;var r;(i=t=e.FrameType||(e.FrameType={}))[i.None=0]="None",i[i.Software=1]="Software",i[i.Hardware=2]="Hardware",(r=n=e.LogLevel||(e.LogLevel={}))[r.Default=0]="Default",r[r.Debug=1]="Debug",r[r.Info=2]="Info",r[r.Warning=3]="Warning",r[r.Error=4]="Error"})(Xh||(Xh={}));var eu=i(496486),tu=(e=>(e[e.CallStateChanged=0]="CallStateChanged",e[e.TrouterStateChanged=1]="TrouterStateChanged",e[e.MultiPartyModeSet=2]="MultiPartyModeSet",e[e.MediaRetargetSucceeded=3]="MediaRetargetSucceeded",e[e.MediaRetargetFailed=4]="MediaRetargetFailed",e))(tu||{}),iu=(e=>(e[e.StartModality=0]="StartModality",e[e.StopModality=1]="StopModality",e[e.StreamStateChanged=2]="StreamStateChanged",e[e.NegotiationStateChanged=3]="NegotiationStateChanged",e))(iu||{}),nu=(e=>(e[e.SelectSource=0]="SelectSource",e[e.AttachSource=1]="AttachSource",e[e.DetachSource=2]="DetachSource",e))(nu||{}),ru=(e=>(e[e.Available=0]="Available",e[e.Subscribe=1]="Subscribe",e[e.Subscribed=2]="Subscribed",e[e.Unsubscribe=3]="Unsubscribe",e[e.Unsubscribed=4]="Unsubscribed",e[e.RenderingStarted=5]="RenderingStarted",e[e.RenderingStopped=6]="RenderingStopped",e))(ru||{}),su=class{constructor(e,t){this.value=e,this.piiKind=t}},au=class{};au.agentEnvironmentId="agent_environment_id",au.correlationId="CorrelationId",au.participantId="participant_id",au.tenantId="TenantId",au.userHexCID="UserHexCID",au.acsResourceId="AcsResourceId",au.endpointId="endpoint_id",au.mediaLegId="media_leg_id",au.webMediaConfigIds="web_media_config_ids",au.tsCallingVersion="ts_calling_version";var ou=class{};ou.diagnostics="MediaDiagnostic",ou.qoeStats="QoE",ou.webrtcSession="webrtc_session",ou.webrtcSessionInitial="webrtc_session_initial",ou.realtimeTelemetry="realtimetelemetry",ou.webrtcMediaSession="webrtc_call_session",ou.mediaSession="pluginless_modality_session",ou.callSession="pluginless_call_session";var lu=class{constructor(e){this.eventName=e,this.ended=!1,this.events=[]}setLocalUserId(e){this.localUserId=e}start(){this.ended||(this.startTime=Date.now())}end(e=0){this.ended||(this.ended=!0,this.resultCode=e)}asStatsRecord(e={}){if((0,eu.isEmpty)(this.events))return null;const t=(0,eu.uniqBy)(this.events,(e=>JSON.stringify(e))).map((e=>{const t={[e.type]:e.timestamp-this.startTime};return(0,eu.isEmpty)(e.data)||(t.data=e.data),t}));return{name:this.eventName,record:(0,eu.assign)({LocalUser:this.localUserId,ResultCode:String(this.resultCode),EventTimestampBag:JSON.stringify({eventStart:this.startTime,events:t})},e)}}add(e){!this.ended&&e.type&&((0,eu.isUndefined)(this.startTime)&&(this.startTime=Date.now()),(0,eu.isUndefined)(e.timestamp)&&(e.timestamp=Date.now()),this.events.push(e))}},du=class e extends lu{constructor(){super(ou.callSession)}callStateChanged(t){super.add({type:tu[0],data:e.callStateToString[t]||t})}event(e){super.add({type:tu[e]})}};du.callStateToString={0:"None",1:"Notified",2:"Connecting",3:"Connected",4:"LocalHold",5:"RemoteHold",6:"Disconnecting",7:"Disconnected",8:"Observing",10:"Lobby"};var cu=du,hu=class e extends lu{constructor(t,i){super(ou.mediaSession),this.mediaType=t,this.mediaDirection=i,this.streamDirection=e.mediaDirectionToStream[this.mediaDirection]}addEvent(e,t){super.add({type:e,data:t})}lifecycle(e){this.addEvent(iu[e])}streamStateChanged(t,i=this.streamDirection){const n=iu[2];this.addEvent(n,{state:e.streamStateToString[t],direction:e.streamDirectionToString[i]})}negotiationStateChanged(t,i,n=this.streamDirection){const r=iu[3];this.addEvent(r,{state:e.negotiationStateToString[t],reason:i})}asStatsRecord(t={}){return super.asStatsRecord((0,eu.assign)({MediaType:e.mediaTypeToString[this.mediaType],Role:e.mediaDirectionToRole[this.mediaDirection]},t))}};hu.negotiationStateToString={started:"NegotiationStarted",rejected:"NegotiationRejected",completed:"NegotiationCompleted"},hu.streamStateToString={created:"StreamCreated",started:"StreamStarted",active:"StreamActive",inactive:"StreamInactive",stopped:"StreamStopped",removed:"StreamRemoved",failed:"StreamFailed",cancelled:"StreamCancelled"},hu.streamDirectionToString={send:"Send",receive:"Receive"},hu.mediaTypeToString={0:"Audio",1:"Video",2:"ScreenShare",3:"Data"},hu.mediaDirectionToRole={1:"Receiver",2:"Sender",4:"Bidirectional"},hu.mediaDirectionToStream={1:"receive",2:"send"};var uu=hu,pu=class extends uu{constructor(){super(0,4)}start(){super.start(),super.lifecycle(0)}stop(){super.lifecycle(1)}},gu=class extends uu{constructor(e){super(e,2),this.mediaType=e}start(){super.start(),super.lifecycle(0)}stop(){super.lifecycle(1)}event(e){super.addEvent(nu[e])}},mu=class extends uu{constructor(e,t){super(e,1),this.mediaType=e,this.remoteParticipantId=t,this.rendererCounter=0}newRendererId(){return this.rendererCounter+=1,String(this.rendererCounter)}event(e,t,i){super.addEvent(ru[e],(0,eu.isUndefined)(i)?{rendererId:t}:{rendererId:t,sourceId:i})}asStatsRecord(){return super.asStatsRecord({TargetUser:this.remoteParticipantId})}},fu=class{constructor(){this.allStats=[],this.ended=!1}setLocalUserId(e){this.localUserId=e}get call(){return this.callStats||this.startCall()}get audio(){return this.audioStats||this.newSession(0)}get video(){return this.videoStats||this.newSession(1)}get screenShare(){return this.sharingStats||this.newSession(2)}renderer(e,t){let i=this.renderingStats[t];return i||(i=this.renderingStats[t]=this.receive(e,t)),i}startCall(){return this.callStats?this.callStats:(this.callStats=new cu,this.callStats.start(),this.addStats(this.callStats))}endCall(e=0){this.ended=!0,this.call.end(e),this.allStats.forEach((e=>e.end())),this.cleanUp()}cleanUp(){this.audioStats&&(this.audioStats.stop(),this.audioStats=null),this.videoStats&&(this.videoStats.stop(),this.videoStats=null),this.sharingStats&&(this.sharingStats.stop(),this.sharingStats=null)}newSession(e){let t;switch(e){case 0:t=this.audioStats=new pu;break;case 1:t=this.videoStats=new gu(e);break;case 2:t=this.sharingStats=new gu(e)}return this.addStats(t)}receive(e,t){const i=new mu(e,t);return i.start(),this.addStats(i)}buildStatsRecords(){return this.allStats.map((e=>e.asStatsRecord())).filter((e=>!!e))}addStats(e){return this.ended||(this.allStats.push(e),e.setLocalUserId(this.localUserId)),e}},Su=class e{constructor(e){this.configProvider=e,this.localStats=new fu,this.tsCallingVersion="2024.13.01.19"}setCallId(e){this.callId=e}setTenantId(e){this.tenantId=e}setUserHexCID(e){this.userHexCID=e}setParticipantId(e){this.participantId=e}setEndpointId(e){this.endpointId=e}setMediaLegId(e){this.mediaLegId=e}setMediaStats(e){this.mediaStats=e}setAcsResourceId(e){this.acsResourceId=e}appendDataChannelInfo(e){this.mediaStats?.data&&e&&(this.mediaStats.data.DataHandlers=e)}appendSharingControlInfo(e){this.mediaStats?.data&&(this.mediaStats.data.SharingControlEnabled=e?"true":"false")}appendMediaControlPaneInfo(e){this.mediaStats?.data&&e&&(this.mediaStats.data.MediaControlPlane=e)}appendTerminationInfo(e,t){this.mediaStats?.data&&(this.mediaStats.data.TerminatedReason=`${e}`,this.mediaStats.data.TerminatedState=`${t}`)}appendPictureInPictureInfo(e){this.mediaStats?.data&&e&&(this.mediaStats.data.PictureInPicture=e)}appendCallDeviceManagerInfo(e){this.mediaStats?.data&&e&&(this.mediaStats.data.CallDeviceManager=e)}buildFromMediaStats(){return"WebRtcMediaStats"===this.mediaStats?.type?[this.buildEvent(this.mediaStats.data,ou.webrtcSession)]:[]}buildShortBeaconEvent(){const e=this.configProvider?.config?.mediaEventDictionary??tt.MEDIA_EVENT_FIELDS,t={};t[au.correlationId]=this.callId||"",t[au.participantId]=this.participantId||"",t[au.tenantId]=this.tenantId||"",t[au.tsCallingVersion]=this.tsCallingVersion||"",t.metrics_TerminationReason_code=new su(_n.SUCCESS,0),t.metrics_TerminationReason_subCode=new su(bn.BEACON,0);const i=this.buildFromDictionary(this.mediaStats.data,e);return[{eventName:ou.webrtcMediaSession,props:this.buildProps(i,null,t)}]}buildShortCallModalityStats(){const e={};return e[au.correlationId]=this.callId||"",e[au.userHexCID]=this.userHexCID||"",e[au.participantId]=this.participantId||"",e[au.endpointId]=this.endpointId||"",e[au.tenantId]=this.tenantId||"",e[au.tsCallingVersion]=this.tsCallingVersion||"",e[au.acsResourceId]=this.acsResourceId||"",e.Code=new su(_n.SUCCESS,0),e.SubCode=new su(bn.BEACON,0),[{eventName:"skypecosi_concore_web_csa_conversation_callmodality",props:e}]}buildFromDictionary(e,t){const i={};for(const n in t)e[n]&&(i[n]={},t[n].forEach((t=>{void 0!==e[n][t]&&(i[n][t]=e[n][t])})));return i}buildMediaTelemetry(){if(!this.mediaStats)return;const e=this.buildEvent(this.mediaStats.data,null).props,t={};return Object.keys(e).forEach((i=>{void 0===e[i].piiKind?t[i]=e[i]:t[i]=e[i].value})),t}buildMidCallTelemetry(e){if(!this.mediaStats)return[];const t=this.buildEvent(this.mediaStats.data,ou.webrtcSession),i=t.props,n=e.reduce(((e,t)=>(i[t]&&(e[t]=i[t]),e)),{});return[{eventName:t.eventName,props:n}]}buildFromCallSetupStats(){return"WebRtcMediaStats"===this.mediaStats?.type?[this.buildEvent(this.mediaStats.data,ou.webrtcSessionInitial)]:[]}buildFromLocalStats(){return this.localStats.buildStatsRecords().map((e=>this.buildEvent(e.record,e.name)))}buildEvent(t,i){const n={};return n[au.agentEnvironmentId]=e.agentEnvironmentId,n[au.correlationId]=this.callId||"",n[au.tenantId]=this.tenantId||"",n[au.userHexCID]=this.userHexCID||"",n[au.participantId]=this.participantId||"",n[au.endpointId]=this.endpointId||"",n[au.mediaLegId]=this.mediaLegId||"",n[au.webMediaConfigIds]=this.webMediaConfigIds||"",n[au.tsCallingVersion]=this.tsCallingVersion||"",n[au.acsResourceId]=this.acsResourceId||"",{eventName:i,props:this.buildProps(t,null,n)}}normalizeKey(e){return e.replace(/[^a-zA-Z0-9._]/g,"_")}buildProps(e,t,i){return Object.keys(e).forEach((n=>{const r=this.normalizeKey(n),s=t?`${t}_${r}`:r,a=e[n];if((0,eu.isString)(a))i[s]=this.getPiiAwareValue(n,a);else if((0,eu.isArray)(a)){if(a.length>0){const e=a,t=e.map((e=>e.value)).toString();i[s]=new su(t,e[0].type)}}else if((0,eu.isObject)(a))if(a.__VALUE__){const e=a;(0,eu.isBoolean)(e.value)&&(e.value=e.value?"true":"false"),i[s]=new su(e.value,e.type)}else this.buildProps(a,s,i)})),i}getPiiAwareValue(t,i){return e.piiProps.hasOwnProperty(t)?new su(i,e.piiProps[t]):i}build(){return(0,eu.flatten)([this.buildFromMediaStats(),this.buildFromLocalStats()])}};Su.agentEnvironmentId=Hi(),Su.piiProps={IPAddr:13,MACAddr:13,IPAddress:13,OpaqueData:0,LocalSite:13,RemoteSite:13,BaseAddress:13,LocalAddress:13,RemoteAddress:13,NetworkName:12,LocalUser:10,TargetUser:10};var vu=Su,yu=i(496486);function Cu(e){return e?Eu(e.code,e.subCode):0}function Tu(e,t){const i={clientVersion:e.clientVersion,participantId:e.participantId,endpointId:e.endpointId,endpointType:e.endpointType,endpointMetadata:e.endpointMetadata,originalId:e.originalId,capabilities:e.capabilities,clientEndpointCapabilities:e.clientEndpointCapabilities,mappedTo:e.mappedTo,meetingGroupDetails:e.meetingGroupDetails};return e.mediaStreams&&(i.mediaStreams=e.mediaStreams),e.appliedInteractivityLevel&&(i.appliedInteractivityLevel=e.appliedInteractivityLevel),e.deviceType&&(i.deviceType=e.deviceType),e.streamInformation&&32&t&&(i.streamInformation=e.streamInformation),e.propertyBag&&(i.propertyBag=e.propertyBag),i}function Eu(e,t=null){if(e===qn.Success)switch(t){case zn.RemovedFromConversation:case zn.RemovedFromCall:return 44;case zn.DeniedInLobby:return 55;case zn.TimedOutInLobby:return 56;default:return 1}if(null!==t&&t>=2e5&&t<=299999){const e=t-2e5;return Jn[e]?Jn[e]:0}return null!==t&&t>=4e5&&t<=499999?Yn[e]?Yn[e]:43:e===qn.Forbidden?t===zn.UserBlocked?64:t===zn.PolicyRestriction?62:t===zn.AnonymousJoinDisabledByPolicy?66:t===zn.NoLobbyForBroadcastJoin?67:t===zn.NotAllowedDueToInformationBarrier?68:t===zn.TeamParkPolicyDisabled?70:t===zn.B2bJoinDisabledByPolicy?71:t===qn.Success?8:7:e===qn.PreconditionFailed&&t===zn.InsufficientCapabilities?63:e===qn.ServiceUnavailable?t===zn.BroadcastLimitReached?69:48:e===qn.InternalServerError?7:e===qn.ConfParticipantCountLimitReached?t===zn.MaxLobbyParticipantLimitReached?73:59:Kn[e]?Kn[e]:e}function _u(e){if(1===e)return qn.Success;const t=Object.keys(Kn).filter((t=>Kn[t]===e));if(t.length>=1)for(const i of t){const t=parseInt(i);if(t&&Kn[t]===e)return t}return qn.UnknownError}function bu(e,t){if(void 0!==t&&3!==t&&1!==t)return{mediaType:e,isDisabled:0===t,label:Cc(e)}}function Pu(e){if(e.sendMediaModalities)return e;const t={mediaStates:[]};let i=bu(0,e.audioDirection?e.audioDirection:4);return i&&t.mediaStates.push(i),i=bu(1,e.withVideo?4:e.videoDirection),i&&t.mediaStates.push(i),i=bu(2,e.screenshareDirection?e.screenshareDirection:1),i&&t.mediaStates.push(i),e.sendMediaModalities=t,e}function Iu(e){const t=function(e){if("mri"===e)return"mri";throw"Unknown RedirectionTargetIdType"}(e.type),i=function(e){switch(e){case"voicemail":return"voicemail";case"default":return"default";default:throw"Unknown RedirectionEndpointType"}}(e.endpointType);return{type:t,id:e.id,endpointType:i}}var Au=class{constructor(e){this.mediaStateConfiguration=e}isDisabled(e){if(this.mediaStateConfiguration?.mediaStates){const t=this.mediaStateConfiguration.mediaStates.find((t=>t.mediaType===e));return!!t&&!!t.isDisabled}return!1}isInactiveOrDisabled(e){if(this.mediaStateConfiguration?.mediaStates){const t=this.mediaStateConfiguration.mediaStates.find((t=>t.mediaType===e));return!t||!!t.isDisabled}return!1}isSending(e){return!!this.mediaStateConfiguration?.mediaStates&&!!this.mediaStateConfiguration.mediaStates.find((t=>t.mediaType===e&&!t.isDisabled))}disableModality(e){this.setModality(e,!0)}enableModality(e){this.setModality(e,!1)}removeModality(e){this.mediaStateConfiguration?.mediaStates&&(0,yu.remove)(this.mediaStateConfiguration.mediaStates,(t=>t.mediaType===e))}setCallAcceptOptions(e){const t=this.isDisabled(1),i=this.isDisabled(2),n=this.isSending(3);if(e.sendMediaModalities)this.mediaStateConfiguration=e.sendMediaModalities;else{void 0===e.answerMediaType&&(e.answerMediaType=e.withVideo?1:0);const t={mediaStates:[]};switch(e.answerMediaType){case 0:t.mediaStates.push(bu(0,4));break;case 1:t.mediaStates.push(bu(0,4)),t.mediaStates.push(bu(1,4));break;case 2:t.mediaStates.push(bu(1,0))}this.mediaStateConfiguration=t}t&&this.setModality(1,!0),i&&this.setModality(2,!0),n&&this.setModality(3,!1),e.sendMediaModalities=this.mediaStateConfiguration}setModality(e,t){if(this.mediaStateConfiguration?.mediaStates){const i=this.mediaStateConfiguration.mediaStates.find((t=>t.mediaType===e));i?i.isDisabled=t:this.mediaStateConfiguration.mediaStates.push({mediaType:e,isDisabled:t,label:Cc(e)})}}};function Ru(e){return e||!1===e||""===e||0===e}function wu(e){switch(e){case 0:return"Audio";case 1:return"Video";case 2:return"ScreenShare"}throw new Error("MediaType required")}var Mu=class{constructor(){this.stateInt=0,this.promiseInt=new Promise(((e,t)=>{this.resolveInt=e,this.rejectInt=t}))}get state(){return this.stateInt}get resolve(){return e=>{this.stateInt=2,this.resolveInt(e)}}get reject(){return e=>{this.stateInt=1,this.rejectInt(e)}}get promise(){return this.promiseInt}get isPending(){return 0===this.stateInt}},Ou=class{constructor(e){this.mcpConfig=e,this.data={sourceRequestsSignaling:{},sourceRequestsMCP:{},fallback:!1,sourceRequestsResponses:{},errors:[]}}setRecord(e,t,i){const n={sequenceNumber:t,timestamp:Date.now(),sourceId:i?.sourceId,fmtp:i?.fmtParams};e.records??(e.records=[]),At(e.records,n,this.mcpConfig.storedSRRecordsCount)}recordSignalingOperation(e,t){var i;(i=this.data.sourceRequestsSignaling)[e]??(i[e]={counter:0}),this.data.sourceRequestsSignaling[e].counter++,this.mcpConfig.verboseTelemetry&&this.mcpConfig.sendDuplicates&&"ApplyChannelParametersSourceRequest"===e&&this.setRecord(this.data.sourceRequestsSignaling[e],t)}recordMCPOperation(e,t,i){var n;(n=this.data.sourceRequestsMCP)[e]??(n[e]={counter:0}),this.data.sourceRequestsMCP[e].counter++,this.mcpConfig.verboseTelemetry&&this.setRecord(this.data.sourceRequestsMCP[e],t,i)}recordError(e,t){const i=[Date.now(),t,e];At(this.data.errors,i,this.mcpConfig.storedSRRecordsCount)}recordFallback(){this.data.fallback=!0}recordSignalingOperationDuration(e,t){const i=this.data.sourceRequestsSignaling[e]?.records?.find((e=>e.sequenceNumber===t));i&&(i.duration=Date.now()-i.timestamp)}recordSrResultReceived(e,t,i){var n;if(this.mcpConfig.verboseTelemetry){const n=this.data.sourceRequestsMCP[i]?.records?.find((e=>e.sequenceNumber===t));n&&(n.duration=Date.now()-n.timestamp,n.result=e)}(n=this.data.sourceRequestsResponses)[e]??(n[e]=0),this.data.sourceRequestsResponses[e]++}getObjectRef(){return this.data}},Du=class{constructor(e){this.mcpConfig=e,this.storage={createTime:Date.now(),startedCount:0,stoppedCount:0,clientCapabilities:[],events:[]},this.sourceRequestSenderDiagnostics=new Ou(this.mcpConfig)}get getSourceRequestSenderDiagnostics(){return this.sourceRequestSenderDiagnostics}logStarted(){if(this.storage.startedCount++,this.storage.startedCount>5)return;const e={startedTs:ku(this.storage.createTime),mpCapabilities:{},sentMessages:{},recvMessages:{},sentFailed:0,recvFailed:0,cachedDshReceived:!1};this.storage.events.push(e),this.lastEventConnecting=!0}logStopped(){this.storage.stoppedCount++;const e=this.getCurrentDCSessionEvent();e&&(e.stoppedTs=ku(this.storage.createTime)),this.lastEventConnecting=!1}logSentMsg(e){var t,i;const n=this.getCurrentDCSessionEvent();n&&((t=n.sentMessages)[i=e.type]??(t[i]=0),n.sentMessages[e.type]++)}logReceivedMsg(e){var t,i;this.lastEventConnecting=!1;const n=this.getCurrentDCSessionEvent();n&&((t=n.recvMessages)[i=e.type]??(t[i]=0),n.recvMessages[e.type]++,"dsh"!==e.type||n.handshakeDuration||(n.cachedDshReceived=!0))}logHandshakeStarted(e){const t=this.getCurrentDCSessionEvent();t&&(t.handshakeStartedTs=Date.now()),this.storage.clientCapabilities=e}logHandshakeCompleted(e){const t=this.getCurrentDCSessionEvent();t&&(t.handshakeDuration||(t.handshakeDuration=ku(t.handshakeStartedTs)),t.mpCapabilities.send=e.send_capabilities,t.mpCapabilities.recv=e.receive_capabilities)}logSentFailed(e){const t=this.getCurrentDCSessionEvent();t&&(t.sentFailed++,t.lastSentFailed={ts:ku(this.storage.createTime),error:e})}logRecvFailed(e){const t=this.getCurrentDCSessionEvent();t&&(t.recvFailed++,t.lastRecvFailed={ts:ku(this.storage.createTime),error:e})}logTimeout(){if(this.storage.startedCount>=5&&!this.lastEventConnecting)return;const e={timeoutTs:Date.now()},t=this.getCurrentDCSessionEvent();t&&(e.handshakeStartedTs=t.handshakeStartedTs),this.lastEventConnecting&&this.storage.events.pop(),this.storage.events.push(e),this.lastEventConnecting=!1}getReport(){const e=this.sourceRequestSenderDiagnostics.getObjectRef();return this.storage.sourceRequestsReport=e,this.storage}getCurrentDCSessionEvent(){const e=this.storage.events[this.storage.events.length-1];return this.storage.startedCount<=5&&void 0!==e?.startedTs?e:null}};function ku(e){return Date.now()-e}var Nu=class extends Ye{constructor(e,t,i){super(),this.dcAdapter=e,this.logger=t,this.mcpConfig=i,this.dcSend=null,this.handshakePromise=new Mu,this.isStarted=!1,this.isActive=!1,this.handshakeTimeout=null,this.telemetryLogger=new Du(this.mcpConfig),this.mcpSupportedFeautres={sourceRequestsEnabled:!1,sourceRequestsResponseEnabled:!1,sendDuplicates:this.mcpConfig?.sendDuplicates}}getTelemetryLogger(){return this.telemetryLogger}mcpFeaturesSupported(e){return this.mcpSupportedFeautres[e]}switchMcpFeauture(e,t){this.logger.warn(`Switching ${e} to ${t}`),this.mcpSupportedFeautres[e]=t}getConfig(){return this.mcpConfig}dispose(){super.dispose(),this.isStarted&&this.dcAdapter.removeHandler(18),this.handshakePromise.promise.catch((()=>{})),this.handshakePromise.reject("MediaControlPlane disposed"),clearTimeout(this.handshakeTimeout),this.handshakeTimeout=null,this.isActive=!1,this.switchMcpFeauture("sourceRequestsEnabled",!1),this.switchMcpFeauture("sourceRequestsResponseEnabled",!1),this.dcSend=null}getTelemetryReport(){return this.logger.debug(`Telemetry ${JSON.stringify(this.telemetryLogger.getReport())}`),this.telemetryLogger.getReport()}async sendMsg(e){return await this.handshakePromise.promise,this.sendMsgInternal(e)}start(){if(this.isStarted||!this.mcpConfig)return;this.isStarted=!0;const e={onStarted:async(e,t)=>{this.logger.info(`Data channel handler is started ${e}`),this.telemetryLogger.logStarted(),this.dcSend=t,await this.startHandshake()},onStopped:async e=>{this.logger.info(`Data channel handler is stopped ${e}`),this.telemetryLogger.logStopped(),this.dcSend=null,this.isActive=!1,this.switchMcpFeauture("sourceRequestsEnabled",!1),this.switchMcpFeauture("sourceRequestsResponseEnabled",!1)},onDataReceived:async(e,t)=>{this.processIncomingData(t)}};this.dcAdapter.addHandler(18,e)}onTransportConnected(){this.isStarted&&this.mcpConfig.handshakeTimeout&&!this.isActive&&(this.handshakeTimeout&&clearTimeout(this.handshakeTimeout),this.handshakeTimeout=window.setTimeout((()=>{this.handshakeTimeout=null,this.telemetryLogger.logTimeout(),this.logger.warn(`Timeout after ${this.mcpConfig.handshakeTimeout}ms, raising onHandshakeTimeout`),this.event("onHandshakeTimeout").raise()}),this.mcpConfig.handshakeTimeout))}async startHandshake(){this.handshakePromise.isPending||(this.handshakePromise=new Mu),this.isActive=!1;try{const e=[];this.mcpConfig.enableDominantSpeakerHistory&&e.push("dsh"),this.mcpConfig.enableBweNotifications&&e.push("bwe"),this.mcpConfig.enableSourceRequests&&e.push("sr"),this.telemetryLogger.logHandshakeStarted(e),this.logger.info(`Send syn, client capabilities: ${JSON.stringify(e)}`),await this.sendMsgInternal({type:"syn",client_capabilities:e})}catch(e){this.handshakePromise.reject(e)}}async sendMsgInternal(e){const t=Array.isArray(e)?e:[e],i=(new TextEncoder).encode(JSON.stringify(t)),n=new Uint8Array(1+i.length);n[0]=1,n.set(i,1);try{await this.dcSend(n,[4294967292]);for(const e of t)this.telemetryLogger.logSentMsg(e)}catch(e){throw this.logger.error(`Send failed: ${Ge(e)}`),this.telemetryLogger.logSentFailed(Ge(e)),e}}processIncomingData(e){if(1!==e[0]){const t=`Unsupported header version ${e[0]}`;return this.logger.info(t),void this.telemetryLogger.logRecvFailed(t)}const t=new DataView(e.buffer,1);let i;try{const e=(new TextDecoder).decode(t);i=JSON.parse(e)}catch(e){return this.logger.error(`Failed to parse received data, error ${Ge(e)}`),void this.telemetryLogger.logRecvFailed(Ge(e))}for(const e of i)switch(this.telemetryLogger.logReceivedMsg(e),e.type){case"syn":break;case"ack":this.processAckMsg(e);break;case"bwe":this.processBweMsg(e);break;case"dsh":this.processDshMsg(e);break;case"sr_res":this.processSrResMsg(e);break;default:{const t=`Unsupported msg type ${e.type}`;this.logger.error(t),this.telemetryLogger.logRecvFailed(t)}}}processDshMsg(e){this.mcpConfig.enableDominantSpeakerHistory&&(this.logger.debug(`DSH received: ${JSON.stringify(e)}`),this.event("mpDshChanged").raise(e.history))}processSrResMsg(e){this.mcpConfig.enableSourceRequests&&(this.logger.debug(`SR_RES received: ${JSON.stringify(e)}`),this.event("mpSrResReceived").raise(e.sequenceNumber,e.result))}processBweMsg(e){this.mcpConfig.enableBweNotifications&&this.event("mpSendBandwidthChanged").raise(e.bw)}processAckMsg(e){this.telemetryLogger.logHandshakeCompleted(e),this.logger.info(`Ack received: ${JSON.stringify(e)}`);const t=!(!this.mcpConfig.enableDominantSpeakerHistory||!e.send_capabilities?.includes("dsh"));this.switchMcpFeauture("sourceRequestsEnabled",!(!this.mcpConfig.enableSourceRequests||!e.receive_capabilities?.includes("sr"))),this.switchMcpFeauture("sourceRequestsResponseEnabled",!(!this.mcpConfig.enableSourceRequests||!e.send_capabilities?.includes("sr_res"))),this.logger.info(`raising mpDshStatusChanged ${t}`),this.event("mpDshStatusChanged").raise(t),this.handshakePromise.resolve(),clearTimeout(this.handshakeTimeout),this.handshakeTimeout=null,this.isActive=!0}},Lu="NegotiationCompleted",xu={OFFER_GENERATION_STARTED:"InitialOfferGenerationStarted",OFFER_GENERATION_ENDED:"InitialOfferGenerationEnded",ANSWER_PROCESSING_STARTED:"InitialAnswerProcessingStarted",ANSWER_PROCESSING_ENDED:"InitialAnswerProcessingEnded",OFFER_PROCESSING_STARTED:"InitialOfferProcessingStarted",OFFER_PROCESSING_ENDED:"InitialOfferProcessingEnded",ANSWER_GENERATION_STARTED:"InitialAnswerGenerationStarted",ANSWER_GENERATION_ENDED:"InitialAnswerGenerationEnded"},Fu={OFFER_GENERATION_STARTED:"RenegotiationOfferGenerationStarted",OFFER_GENERATION_ENDED:"RenegotiationOfferGenerationEnded",ANSWER_PROCESSING_STARTED:"RenegotiationAnswerProcessingStarted",ANSWER_PROCESSING_ENDED:"RenegotiationAnswerProcessingEnded",OFFER_PROCESSING_STARTED:"RenegotiationOfferProcessingStarted",OFFER_PROCESSING_ENDED:"RenegotiationOfferProcessingEnded",ANSWER_GENERATION_STARTED:"RenegotiationAnswerGenerationStarted",ANSWER_GENERATION_ENDED:"RenegotiationAnswerGenerationEnded"},Uu=class{constructor(e,t,i){this.mediaSession=e,this.signalingSession=t,this.sourceRequestSender=i,this.operationNames=xu,this.configureModalitiesAsync=this.mediaSession.configureModalitiesAsync.bind(this.mediaSession),this.getAllowedModalities=this.mediaSession.getAllowedModalities.bind(this.mediaSession),this.rejectNegotiationAsync=this.mediaSession.rejectNegotiationAsync.bind(this.mediaSession),this.createRemoteRenderer=this.mediaSession.createRemoteRenderer.bind(this.mediaSession),this.getStatsAsync=this.mediaSession.getStatsAsync.bind(this.mediaSession),this.getLastKnownStats=this.mediaSession.getLastKnownStats.bind(this.mediaSession),this.getCallTechnicalInfo=this.mediaSession.getCallTechnicalInfo.bind(this.mediaSession),this.muteHold=this.mediaSession.muteHold.bind(this.mediaSession),this.muteInputAsync=this.mediaSession.muteInputAsync.bind(this.mediaSession),this.unmuteInputAsync=this.mediaSession.unmuteInputAsync.bind(this.mediaSession),this.muteOutputAsync=this.mediaSession.muteOutputAsync.bind(this.mediaSession),this.unmuteOutputAsync=this.mediaSession.unmuteOutputAsync.bind(this.mediaSession),this.terminate=this.mediaSession.terminate.bind(this.mediaSession),this.createAudioElement=this.mediaSession.createAudioElement.bind(this.mediaSession),this.getSessionConfig=this.mediaSession.getSessionConfig.bind(this.mediaSession),this.getDiagnostics=this.mediaSession.getDiagnostics.bind(this.mediaSession),this.getIncomingRawAudioStream=this.mediaSession.getIncomingRawAudioStream.bind(this.mediaSession),this.getUnmixedAudioProvider=this.mediaSession.getUnmixedAudioProvider.bind(this.mediaSession),this.useNullAudioStreamClient=this.mediaSession.useNullAudioStreamClient.bind(this.mediaSession),this.getSubscriptionManager=this.mediaSession.getSubscriptionManager.bind(this.mediaSession),this.configureSpatialAudio=this.mediaSession.configureSpatialAudio.bind(this.mediaSession),this.setParticipantSpatialAudioPositions=this.mediaSession.setParticipantSpatialAudioPositions.bind(this.mediaSession),this.setCallConstraints=this.mediaSession.setCallConstraints.bind(this.mediaSession),this.startMediaDescriptionsUpdateAsync=this.mediaSession.startMediaDescriptionsUpdateAsync.bind(this.mediaSession),this.completeMediaDescriptionsUpdateAsync=this.mediaSession.completeMediaDescriptionsUpdateAsync.bind(this.mediaSession),this.rejectMediaDescriptionsUpdateAsync=this.mediaSession.rejectMediaDescriptionsUpdateAsync.bind(this.mediaSession),this.getExtensionsManager()?.configureExtension("videoStreamControl",{sender:this.sourceRequestSender})}enableTeamsRealTimeTelemetry(){this.mediaSession.enableTeamsRealTimeTelemetry()}getMediaStatsReport(){return this.mediaSession.getMediaStatsReport()}processOfferAsync(e,t){return this.signalingSession.setOfferAnswerGenerationTimestamps(this.operationNames.OFFER_PROCESSING_STARTED),this.mediaSession.processOfferAsync(e,t).then((e=>(this.signalingSession.setOfferAnswerGenerationTimestamps(this.operationNames.OFFER_PROCESSING_ENDED),e)))}createAnswerAsync(e,t){return this.signalingSession.setOfferAnswerGenerationTimestamps(this.operationNames.ANSWER_GENERATION_STARTED),this.mediaSession.createAnswerAsync(e,t).then((t=>(this.signalingSession.setOfferAnswerGenerationTimestamps(this.operationNames.ANSWER_GENERATION_ENDED),e||(this.operationNames=Fu),t)))}createOfferAsync(e){return this.signalingSession.setOfferAnswerGenerationTimestamps(this.operationNames.OFFER_GENERATION_STARTED),this.mediaSession.createOfferAsync(e).then((e=>(this.signalingSession.setOfferAnswerGenerationTimestamps(this.operationNames.OFFER_GENERATION_ENDED),e)))}processAnswerAsync(e,t,i,n=!1){return this.signalingSession.setOfferAnswerGenerationTimestamps(this.operationNames.ANSWER_PROCESSING_STARTED),this.mediaSession.processAnswerAsync(e,t,i,n).then((()=>{this.signalingSession.setOfferAnswerGenerationTimestamps(this.operationNames.ANSWER_PROCESSING_ENDED),this.operationNames=Fu}))}completeNegotiationAsync(e){return this.mediaSession.completeNegotiationAsync(e).then((e=>(this.signalingSession.setOfferAnswerGenerationTimestamps(Lu),e)))}sendDtmf(e){return this.mediaSession.sendDtmf?this.mediaSession.sendDtmf(e):Promise.reject("Not Implemented")}getExtensionsManager(){return this.mediaSession.getExtensionsManager?this.mediaSession.getExtensionsManager():null}reconnectAsync(e,t=!1){return this.mediaSession.reconnectAsync(e,t)}completeEscalationAsync(e){return this.mediaSession.completeEscalationAsync(e)}rejectEscalationAsync(e,t){return this.mediaSession.rejectEscalationAsync(e,t)}getAcceptedTypes(){return this.mediaSession.getAcceptedTypes()}getLocalMediaTrackId(e){return this.mediaSession.getLocalMediaTrackId?this.mediaSession.getLocalMediaTrackId(e):null}processNotification(e,t){this.mediaSession.processNotification(e,t)}};function Vu(e,t,i){if(void 0===t?.serverMuteVersion||void 0===i?.serverMuteVersion||i.serverMuteVersion>=t.serverMuteVersion)return;const n=i&&i.mediaStreams,r=n&&n.filter((e=>"audio"===e.type||"audio-teleconferencing"===e.type)),s=t&&t.mediaStreams,a=s&&s.filter((e=>"audio"===e.type||"audio-teleconferencing"===e.type));r&&r.length&&(i.serverMuteVersion=t.serverMuteVersion,r[0].serverMuted=a[0].serverMuted,e.info(`handleServerMutedVersion: patching server muted state in audio streams updated:${JSON.stringify(r[0])} as we encountered stale muteServerVersion. Updated to ${t.serverMuteVersion}`))}function Hu(e,t,i,n){if("success"!==i.reason||void 0===t||i.serverMuteVersion<=t.serverMuteVersion)return e.info(`handleMuteUnmuteParticipantInfo: ignoring updating since we encountered invalid state: ${i.reason} serverMuteVersion: ${i.serverMuteVersion}`),!1;const r=t&&t.mediaStreams,s=r&&r.filter((e=>"audio"===e.type||"audio-teleconferencing"===e.type));return!!s&&(s[0].serverMuted=n,t.serverMuteVersion=i.serverMuteVersion,e.info(`handleMuteUnmuteParticipantInfo: updating since we encountered valid state serverMuteVersion: ${i.serverMuteVersion} to: ${n} streams: ${s[0].sourceId}`),!0)}var Bu=i(174958);function $u(e,t,i,n){i?.forEach((i=>{e[i]&&(t[i]=n(e[i]))}))}function ju(e){return`id=${Bu.pii.Mri(e.id)}, participantId=${e.participantId}`}function Gu(e){return function(e,t,i,n){const r=JSON.stringify(e),s=JSON.parse(r);return s&&($u(e,s,t,Bu.pii.Omit),$u(e,s,i,Bu.pii.Mri),$u(e,s,n,Bu.pii.UserName)),JSON.stringify(s)}(e,[],["transferorMri","targetMri"])}var Wu=i(496486),qu=d.setImmediate?e=>{d.setImmediate(e)}:e=>{(0,Wu.defer)(e)},zu=class e{constructor(){this.deferredOperations=new Map,this.deferredOperationsNames=[],this.isRunning=!1}setLogger(e){this._logger=e.createChild("[DeferHandler]")}setDeferToQueueMicrotask(t){t&&d.queueMicrotask?e.defer=e=>d.queueMicrotask(e):e.defer=qu}createDeferRunner(e){const t={};return i=>this.runDeferred(t,i,e)}runDeferredWithoutDedup(e,t){this.runDeferred({},e,t)}runDeferred(t,i,n){this.deferredOperations.has(t)||(this.deferredOperations.set(t,i),n&&this.deferredOperationsNames.push(" "+n),this.isRunning||(this.isRunning=!0,this._startDeferalTime=Date.now(),this.causeId=Re(),this._logger?.info(`[${this.causeId}]Deferring operations`),e.defer((()=>{this._timeToRun=Date.now()-this._startDeferalTime,this.deferredOperations.forEach((t=>{e.runWithTryCatch(t)})),this.deferredOperations.clear(),this.isRunning=!1,this._logger?.info(`[${this.causeId}]Deferred operations ran after ${this._timeToRun}ms | Completed after ${Date.now()-this._startDeferalTime}ms | Operations:${this.deferredOperationsNames}`),this.deferredOperationsNames=[]}))))}static runWithTryCatch(e){try{e&&e()}catch(e){}}};zu.defer=qu;var Ku=zu,Ju=class{};Ju.instance=new Ku;var Yu=i(496486),Qu="sendonly",Xu="recvonly",Zu="sendrecv",ep="audio",tp="video",ip="applicationsharing-video",np="audio-teleconferencing",rp=class extends Ye{constructor(e,t,i){super(t),this.mediaSession=e,this.isAvailable=!1,this.mediaSessionInitPromise=new Mu,this.currentIsStreaming=!1,e&&this.mediaSessionInitPromise.resolve(),this.id=i,this.logger=t.createChild(`Stream[${this.id}]`)}set isStreaming(e){this.currentIsStreaming=e,this.logger.info(`isStreaming has changed to ${this.currentIsStreaming}`),this.raiseChanged()}get isStreaming(){return this.currentIsStreaming}update({sourceId:e=null,direction:t=Xu,participantId:i=null,endpointId:n=null}={},r){this.logger.info(`[${r}][update before]  sourceId=${e}, direction=${t}, participantId=${i}, endpointId=${Be(n)}`),this.id=e,this.isAvailable=t===Zu||t===Qu,this.mediaSession?.getSessionConfig().config.streamAvailabilityConsiderModalities&&this.getIsModalityDisabled()&&(this.logger.info(`Disabling current modality, disabled: ${JSON.stringify(this.mediaSession?.getDisabledModalities?.()||"")}`),this.isAvailable=!1),this.participantId=i,this.endpointId=n,this.logger.info(`[${r}][update after]  sourceId=${e}, direction=${t}, participantId=${i}, endpointId=${Be(n)}`),this.raiseChanged()}setMediaSession(e,t){const i=e?.getAllowedModalities?.()||{};this.logger.info(`[${t}][setMediaSession] ${JSON.stringify(i)}`),this.mediaSession=e,e?this.mediaSessionInitPromise.resolve():this.mediaSessionInitPromise.reject(new Error("MediaSession is null"))}isActive(){return this.isAvailable&&this.isStreaming}getIsModalityDisabled(){return!1}},sp=class extends rp{},ap=i(496486),op=class extends rp{constructor(e,t,i,n,r,s){super(void 0,e,t),this.configProvider=i,this.streamOptions=n,this.telemetryLogger=r,this.callInfo=s,this.type=2,this.finalTelemetrySent=!1,this.player=new Xi(e.createChild("UmsHydraLiveStreamPlayer"),this.configProvider,this.telemetryLogger),this.isAvailable=!0}getStreamOptions(){return this.streamOptions}getDiagnosticData(){return JSON.stringify({id:this.id,type:this.type,rank:this.rank,isAvailable:this.isAvailable,isStreaming:this.isStreaming})}getStats(){const e=this.player.getSnapshotTelemetryReport(),t={isAvailable:this.isAvailable,isStreaming:this.isStreaming,...e};return(0,ap.isEqual)(this.lastStreamStats,t)||(this.streamStatsUpdatedTimestamp=Date.now(),this.lastStreamStats=t),{id:this.id,type:this.type,timestampUpdated:this.streamStatsUpdatedTimestamp,rank:this.rank,...this.lastStreamStats}}stop(){return Promise.resolve(void 0)}async start(e){if(this.logger.info("[start]: Starting UMS stream"),!this.renderer){if(await this.player.configure(this.streamOptions),!(await this.player.loadPlayer(e)).setupSucceeded)return this.player.stop(),this.logger.error("[start]: Failed to load UMS player"),Promise.reject("Failed to load UMS player");this.renderer=this.player.getRenderer()}return this.isStreaming=!0,this.renderer}sendSnapshotTelemetry(){const e=this.player.getSnapshotTelemetryReport();this.logger.debug(`[sendSnapshotTelemetry] sending snapshot telemetry report: ${JSON.stringify(e)}`);const t={...this.callInfo,...e};this.telemetryLogger.sendEvent({eventName:"live_events",props:t})}sendTelemetry(e){if(this.finalTelemetrySent)return;e&&(this.finalTelemetrySent=!0);const t=this.player.getTelemetryReport();this.logger.debug(`[sendTelemetry] sending telemetry report: ${JSON.stringify(t)}`);const i={...this.callInfo,...t};this.telemetryLogger.sendEvent({eventName:"live_events",props:i})}},lp=class extends Ye{constructor(){super(...arguments),this.isRendering=!1,this.frameType=-1}get rendererType(){return 0}captureFrame(){if(this.renderer.captureFrame)return this.renderer.captureFrame();throw new Error("Not implemented yet")}async getStats(){if(this.renderer.getStats)return this.renderer.getStats();throw new Error("Renderer does not support stats")}async setScalingMode(e){this.renderer.setScalingMode(function(e){switch(e){case 1:return"crop";case 0:return"stretch";default:return"fit"}}(e))}async cameraAutoControl(e){throw new Error("Not implemented")}async getCameraManualControlStates(e){throw new Error("Not implemented")}async setCameraManualControlStates(e){throw new Error("Not implemented")}async enumerateCameraManualControls(){throw new Error("Not implemented")}onVideoSizeChanged(e,t){this.streamSize={width:e,height:t},this.event("videoSizeChanged").raise(e,t),this.raiseChanged()}},dp=class extends lp{constructor(e,t){super(),this.renderer=t.createPreviewRenderer(e),this.renderer.on("onVideoSizeChanged",((e,t)=>this.onVideoSizeChanged(e,t)))}onVideoSizeChanged(e,t){this.isRendering=e>0&&t>0,super.onVideoSizeChanged(e,t)}setVideoMirroring(e){this.renderer.setVideoMirroring(e)}startVideoAsync(){return this.renderer.startVideoAsync()}dispose(){this.renderer&&(this.renderer.dispose(),this.renderer=null)}},cp=class extends lp{constructor(e,t,i,n,r){super(),this.logger=e,this.target=t,this.rendererStats=n,this.configProvider=r,this.subscriptionActive=!1,this.firstFrameRendered=!1,this.rendererId=n.newRendererId(),this.renderer=i.createRemoteRenderer(t),this.renderer.on("onVideoSizeChanged",((e,t)=>this.onVideoSizeChanged(e,t))),this.renderer.on("onVideoStateChanged",(e=>this.onVideoStateChanged(e))),this.renderer.on("onIsRenderingChanged",(e=>this.onIsRenderingChanged(e)))}toString(){return`rvr:${this.rendererId}`}onVideoStateChanged(e){this.rendererStats.streamStateChanged(e.stream)}onVideoSizeChanged(e,t){this.configProvider.config.videoIsRenderingCheck&&this.setIsRendering(e>0&&t>0),super.onVideoSizeChanged(e,t)}setIsRendering(e){this.isRendering!==e&&(this.isRendering=e,this.logger.info(`isRendering has changed to ${this.isRendering}`),this.rendererStats.event(this.isRendering?5:6,this.rendererId),this.isRendering&&!this.firstFrameRendered&&(this.firstFrameRendered=!0,this.event("firstFrameRendered").raise()))}onIsRenderingChanged(e){this.setIsRendering(e),this.raiseChanged()}subscribeVideoAsync(e){this.currentVideoStream=e,this.rendererStats.event(1,this.rendererId,e.id);const t=this.renderer.subscribeVideoAsync(e.id,1===e.type);return this.subscriptionActive=!0,t.then((()=>{this.rendererStats.event(2,this.rendererId,e.id),this.watchStream(e)})),t}watchStream(e){this.changeSub&&this.changeSub.dispose(),this.changeSub=e.changed((()=>{e.isAvailable?this.subscriptionActive||this.subscribeVideoAsync(e):(this.subscriptionActive=!1,this.rendererStats.event(3,this.rendererId),this.renderer.unsubscribeNow(),this.rendererStats.event(4,this.rendererId))}))}dispose(){this.renderer&&(this.subscriptionActive&&(this.rendererStats.event(3,this.rendererId),this.currentVideoStream&&!this.currentVideoStream.isAvailable&&this.renderer.unsubscribeNow()),this.renderer.dispose(),this.subscriptionActive&&this.rendererStats.event(4,this.rendererId),this.renderer=null,this.currentVideoStream=null),this.changeSub&&(this.changeSub.dispose(),this.changeSub=null)}},hp=class extends Ye{constructor(e,t,i,n=Re()){super(i),this.getRawStream=e,this.disposeStream=t,this.logger=i,this.causeId=n,this.isClientDisposed=!1,this.clientId=gt()}get isDisposed(){return this.isClientDisposed}notifyStreamChange(){this.logger.info(`Raw stream changed, causeId=${this.causeId}`),this.raiseChanged(),this.event("notifiedOnStreamChanged").raise(this.clientId)}async getMediaStream(){return this.checkDisposed(),this.logger.info(`Raw stream requested, causeId=${this.causeId}`),this.event("rawStreamRequested").raise(this.clientId),this.getRawStream()}dispose(){this.checkDisposed(),this.disposeStream?.(),this.isClientDisposed=!0,this.event("clientDisposed").raise(this.clientId),super.dispose(),this.logger.info(`Raw stream client disposed, causeId=${this.causeId}`)}checkDisposed(){if(this.isClientDisposed)throw new Error("Raw stream client is already disposed")}},up=class{constructor(e,t,i){this.stream=e,this.rawBaseClient=new hp((async()=>this.stream),(()=>this.dispose()),t,i)}client(){return this.rawBaseClient}updateAndNotifyClient(e){this.rawBaseClient&&(this.stream=e,this.rawBaseClient.notifyStreamChange())}dispose(){this.rawBaseClient=null,this.stream=null}},pp=class{constructor(e,t,i,n){this.videoStream=e,this.subscriptionManager=t,this.logger=i,this.causeId=n,this.modality=0===e.type?tt.MODALITY.video:tt.MODALITY.sharing,this.subscriptionClient=t.subscribeVideo(this.modality,e.mediaSourceId),this.rawBaseClient=new hp((async()=>this.subscriptionClient?.subscribedStream),(()=>this.unsubscribeVideo()),i,n),this.setClientSubscription(),this.videoStream.changed((()=>{this.rawBaseClient?.isDisposed||(e.isAvailable?this.updateSubscription():this.unsubscribeVideo())}))}client(){return this.rawBaseClient}updateSubscription(){this.rawBaseClient?.isDisposed?this.logger.error(`updateSubscription skipped, raw stream client disposed: stream already exists, causeId=${this.causeId}`):(this.logger.info(`update subcription: Created new subscription, causeId=${this.causeId}`),this.subscriptionClient=this.subscriptionManager.subscribeVideo(this.modality,this.videoStream.mediaSourceId),this.setClientSubscription())}unsubscribeVideo(){this.logger.info(`Disposing subcription, causeId=${this.causeId}`),this.subscriptionClient?.unsubscribe(),this.subscriptionClient?.dispose(),this.subscriptionClient=null}setClientSubscription(){this.logger.info(`setting onMediaStreamChanged callback, causeId=${this.causeId}`),this.subscriptionClient.setOnMediaStreamChangedHandler((()=>this.rawBaseClient?.notifyStreamChange()))}},gp=class{constructor(){this.handlerMap=new Map}dispose(){this.handlerMap.forEach((e=>e.client().dispose())),this.handlerMap.clear()}handlerAdded(e){const t=e.client();t.on("clientDisposed",(()=>this.deleteRawStreamManagerById(t.clientId))),this.handlerMap.set(t.clientId,e)}deleteRawStreamManagerById(e){this.handlerMap.delete(e)}},mp=class extends gp{constructor(e){super(),this.logger=e}streamChanged(e){this.handlerMap.forEach((t=>t.updateAndNotifyClient(e)))}createIRawStreamClient(e){const t=new up(e,this.logger);return super.handlerAdded(t),t.client()}updateHandlers(e){e.forEach(((e,t)=>{this.handlerMap.has(t)||this.handlerMap.set(t,e)}))}},fp=class extends gp{constructor(e){super(),this.logger=e}createIRawStreamClient(e,t){const i=new pp(e,t,this.logger);return super.handlerAdded(i),i.client()}},Sp=i(496486),vp=class extends rp{constructor(e,t,i,n){super(e,i,n),this.rendererStats=t,this.rawIncomingVideoStreamManager=new fp(this.logger.createChild("rawVideoStream")),this.type=0}get mediaSourceId(){return this.id}getDiagnosticData(){return JSON.stringify({id:this.id,msi:this.mediaSourceId,rank:this.rank,type:this.type,isAvailable:this.isAvailable,isStreaming:this.isStreaming})}getStats(){const e={isAvailable:this.isAvailable,isStreaming:this.isStreaming};return(0,Sp.isEqual)(this.lastStreamStats,e)||(this.streamStatsUpdatedTimestamp=Date.now(),this.lastStreamStats=e),{id:this.id,type:this.type,timestampUpdated:this.streamStatsUpdatedTimestamp,msi:this.mediaSourceId,rank:this.rank,...this.lastStreamStats}}stop(){return this.mediaSessionInitPromise.reject(new Error("Video stream stopped")),Promise.resolve(void 0)}getRawStream(e){return this.logger.info(`[${e}] - IRawStream for incoming video stream requested`),this.rawIncomingVideoStreamManager.createIRawStreamClient(this,this.mediaSession.getSubscriptionManager())}start(e,t){return this.logger.info(`video start: target=${e}, options=${JSON.stringify(t)}`),this.mediaSessionInitPromise.promise.then((()=>new cp(this.logger.createChild("RemoteVideoRenderer"),e,this.mediaSession,this.rendererStats,this.mediaSession?.getSessionConfig()))).then((e=>(t&&e.setScalingMode(t.scalingMode),this.logger.info(`subscribeVideoAsync: videoRenderer=${e}, id=${this.id}`),e.subscribeVideoAsync(this).catch((t=>{throw e.dispose(),t})).then((()=>(this.isStreaming=!0,e))))))}update(e,t){this.logger.info(`[${t}][update] stream=${JSON.stringify(e)}`);const i=this.isAvailable;super.update(e,t),this.isAvailable&&this.isAvailable!==i&&this.rendererStats.event(0)}getIsModalityDisabled(){return!!this.mediaSession?.getDisabledModalities?.().video}},yp=class extends vp{constructor(e,t,i,n){super(e,t,i,n),this.type=1}getIsModalityDisabled(){return!!this.mediaSession?.getDisabledModalities?.().sharing}},Cp=class e extends Ye{constructor(e,t,i,n){super(),this.participantId=e,this.mediaSession=t,this.localStats=i,this.audioSourceIds=[],this.streams={},this.lastUmsStreamId=1;const r=i.receive(1,e),s=i.receive(2,e);this.audio=new sp(t,n,1);const a=new vp(t,r,n,2),o=new yp(t,s,n,3),l=this.mediaSession?.getSessionConfig()?.config.participantStreamInitialSubscriptions;l&&(a.changed((()=>this.event("streamChanged").raise())),o.changed((()=>this.event("streamChanged").raise()))),this.streams[0]=[a],this.streams[1]=[o],this.streams[2]=[],this.logger=n.createChild("PluginlessCallStreamManager")}setMediaSession(e,t){this.logger.info(`[${t}][setMediaSession]`),this.mediaSession=e,[[this.audio],this.streams[0],this.streams[1]].forEach((i=>i.forEach((i=>i.setMediaSession(e,t)))))}updateStreams(t,i){this.logger.info(`[${i}][updateStreams]`);const n=i=>t.filter((e=>e.type===i)).sort(e.compareStreams);let r=n(ep);0===r.length&&(r=n(np)),r.length>0&&(this.audioSourceIds=r.map((e=>e.sourceId)));const s=r[0];s&&this.audio.update(s,i),this.updateMediaStreams(n(tp),0,i),this.updateMediaStreams(n(ip),1,i)}hasAudioSource(e){return this.audioSourceIds.some((t=>t===e))||this.audio.id===e}useUmsStream(t,i,n,r,s,a){this.logger.info(`[${a}][useUmsStream] Updating ums streams`);const o=this.getUmsInformation(t,r),l=this.streams[2],d=l.filter((t=>!o.some((i=>e.compareUmsStreams(t,i)))));d.forEach((e=>(0,Yu.remove)(l,e))),d.length&&this.logger.info(`[${a}][useUmsStream] Removing ${d.length} ums streams`),o.forEach((t=>{let r=l.find((i=>e.compareUmsStreams(i,t)));r||(r=new op(this.logger.createChild("UmsStream"),this.lastUmsStreamId++,i,t,s,n),this.logger.info(`[${a}][useUmsStream] Adding ums stream with metadata: ${JSON.stringify(t)}`),l.push(r))}))}getUmsStreamMetadata(e,t){let i=null,n=null;if(i=e.find((function(e){return"MiddleLaneUltraLowLatency"===e.deliveryPipelineType&&t===e.isPrimary})),i){const e=i.urls;if(e&&e.length>0){i.identifier||this.logger.warn(`[getUmsStreamMetadata]: no ums stream identifier found, isPrimary: ${t}`);const r=i.decryptionKey?.id,s=i.decryptionKey?.value;r&&s||this.logger.warn(`[getUmsStreamMetadata]: no valid ums stream decryption key found, isPrimary: ${t}`);const a=i.deliveryPipelineType||void 0;n={url:e[0],streamDeliveryPipeline:a,decryptionKey:r&&s?{id:r,value:s}:null}}else this.logger.info(`[getUmsStreamMetadata]: no ums URLs found, isPrimary: ${t}`)}else this.logger.info(`[getUmsStreamMetadata]: no ums stream information found, isPrimary: ${t}`);return n}getUmsInformation(e,t){const i=[];let n=null,r=null;for(const t in e){const i=e[t].streams;if(i){if(n)this.logger.info(`[getUmsInformation]: primary ums stream already found, skipping finding primary stream for participant: ${t}`);else{const e=this.getUmsStreamMetadata(i,!0);e?n=e:this.logger.info(`[getUmsInformation]: no primary ums stream found for participant: ${t}`)}if(r)this.logger.info(`[getUmsInformation]: alternate ums stream already found, skipping finding alternate stream for participant: ${t}`);else{const e=this.getUmsStreamMetadata(i,!1);e?r=e:this.logger.info(`[getUmsInformation]: no alternate ums stream found for participant: ${t}`)}}else this.logger.warn(`[getUmsInformation]: no stream information found for participant: ${t}`)}return(n||r)&&i.push({stream:n,altStream:r,threadId:t}),i}static compareStreams(e,t){const i="sendonly"===e.direction||"sendrecv"===e.direction,n="sendonly"===t.direction||"sendrecv"===t.direction;return i&&!n?-1:n&&!i?1:t.sourceId-e.sourceId}static compareUmsStreams(t,i){const n=t.getStreamOptions();return e.compareUmsStreamMetadata(n.stream,i.stream)&&e.compareUmsStreamMetadata(n.altStream,i.altStream)}static compareUmsStreamMetadata(e,t){return!e&&!t||!(!e&&t||e&&!t)&&e.decryptionKey.id===t.decryptionKey.id&&e.decryptionKey.value===t.decryptionKey.value&&e.url===t.url}updateMediaStreams(e,t,i){const n=this.streams[t],r=n.filter((t=>!e.some((e=>e.sourceId===t.id))));r.forEach((e=>(0,Yu.remove)(n,e))),r.length&&this.logger.info(`[${i}][updateMediaStreams] Removing ${r.length} streams of type ${t}`),e.forEach(((r,s)=>{let a=n.find((e=>e.id===r.sourceId));a||(0===t?a=new vp(this.mediaSession,this.localStats.receive(1,this.participantId),this.logger,r.sourceId):1===t&&(a=new yp(this.mediaSession,this.localStats.receive(2,this.participantId),this.logger,r.sourceId)),this.logger.info(`[${i}][updateMediaStreams] Adding stream ${r.sourceId} of type ${t}`),n.push(a),a.changed((()=>this.event("streamChanged").raise()))),a.update(r,i),a.rank=e.length-s}))}},Tp={0:[1],1:[2,6,3,4,5,7,8],2:[6,3,4,8],3:[1,4,5,8],7:[3,4,8],4:[],5:[3,4,8],6:[3,4],8:[3,5,4]},Ep={0:"Disconnected",1:"Connecting",2:"Ringing",3:"Connected",5:"Connected",4:"Disconnected",7:"Connecting"},_p=class extends Ye{constructor(e,t,i,n,r,s=Re(),a=[]){super(i),this.mri=e,this.callTelemetry=r,this.cachedMediaStreams=a,this.state=0,this.voiceLevel=0,this.isServerMuted=!1,this.endpointType="default",this.balanceUpdates={},this._raiseChangeDeferRunner=Ju.instance.createDeferRunner("CallParticipant.RaiseChange"),this.filteredParticipantEndpointDetails={},this.recordTelemetryForStateChange=(e,t,i,n)=>{if(n){const n="_SetParticipantStateInvalid",r={state:t,reason:i,endpoints:[]};this.endpoints?.endpointDetails?.length&&(r.endpoints=vn(this.endpoints.endpointDetails)),this.callTelemetry.recordEvent(n,r,e)}},this.checkIfIncomingServerMutedIsUpdated=e=>{e.endpointDetails.forEach((e=>{const t=this.filteredParticipantEndpointDetails[e.participantId];void 0!==t&&Vu(this.logger,t,e)}))},this.handleServerMutedInfoUpdate=e=>{let t=!1;for(const i of e){const e=this.filteredParticipantEndpointDetails[i.participantId];Hu(this.logger,e,i,!0)&&(t=!0)}t&&this.updateIsServerMuted()},this.id=this.mri,this.logger=i.createChild((()=>`ICallParticipant[${ke(this.id)}][${this.state}]`)),this.logger.info(`[${s}]created`),this.streamManager=new Cp(this.id,t,n,this.logger),this.streamManager.on("streamChanged",(()=>this.raiseChanged()))}get audio(){return this.streamManager.audio}get streams(){return this.streamManager.streams}getDiagnosticData(){return JSON.stringify({id:ke(this.id),state:this.state,isServerMuted:this.isServerMuted})}isSameParticipantsMri(e){return this.id===e}setMediaSession(e,t=Re()){this.streamManager.setMediaSession(e,t)}applyCachedMediaStreams(e=Re()){const t=this.logger.createFnLogger("applyCachedMediaStreams",e);this.cachedMediaStreams?.length?(t.info("applying cachedMediaStreams"),this.updateStreams(this.cachedMediaStreams,e,!1)):t.info("cachedMediaStreams is empty")}updateStreams(e,t=Re(),i=!1){this.logger.createFnLogger("updateStreams",t).info(`isStreamingMode=${i} mediaStreams=${He(e)}`),e?.length&&(this.cachedMediaStreams=e),i||(this.streamManager.updateStreams(e,t),this.raiseChangedDeferred())}hasAudioSource(e){return this.streamManager.hasAudioSource(e)}raiseChangedDeferred(){this._raiseChangeDeferRunner((()=>this.raiseChanged()))}updateIsServerMuted(){if(!Object.values(this.filteredParticipantEndpointDetails).length)return void this._updateIsServerMuted(!1);let e=!1;Object.values(this.filteredParticipantEndpointDetails).forEach((t=>{const i=e=>t.mediaStreams?.filter((t=>t.type===e)).sort(Cp.compareStreams);let n=i(ep)?.[0];n||(n=i(np)?.[0]);const r=!!n?.serverMuted,s=t.endpointState?.state;!1!==r||!1!=!!s?.isMuted||(e=!0)}));const t=!e;this._updateIsServerMuted(t)}_updateIsServerMuted(e){e!==this.isServerMuted&&(this.isServerMuted=e,this.logger.info(`_updateIsServerMuted updating to: ${this.isServerMuted}`),this.raiseChanged())}updateVoiceLevel(e){this.voiceLevel!==e&&(this.voiceLevel=e,this.raiseChanged())}setState(e,t,i){if(this.state===e)return;const n=this.logger.createFnLogger("setState",i);if(3===this.state&&6===e)return void n.info("Ignore Connected->EarlyMedia transition, it is a race between media and signaling");const r=Tp[this.state].indexOf(e)>=0;this.recordTelemetryForStateChange(i,e,t,!r),r?(n.info(`state=${this.state}->${e} reason=${this.stateReason}->${t}`),this.state=e,this.stateReason=t,this.raiseChangedDeferred()):n.logFailure(`Invalid state transition ${this.state}->${e} attempted`)}processParticipantDetails(e,t,i){const n=this.logger.createFnLogger("processParticipantDetails","");this.role=e.role,this.meetingRole=e.meetingRole,this.advancedMeetingRole=e.advancedMeetingRole,this.participantType=e.participantType,this.tenantId=e.tenantId,this.propertyBag=e.propertyBag,this.version=e.version,this.isIdentityMasked=!!e.isIdentityMasked,this.nonMaskedId=e.nonMaskedId,this.nonMaskedDisplayName=e.nonMaskedDisplayName,this.nonMaskedObjectId=e.nonMaskedObjectId,this.maskedIdSeqNumber=e.maskedIdSeqNumber,this.maskedId=e.maskedId,this.joinAsStreamingUser=e.joinAsStreamingUser,e.endpointDetails?.length&&(this.endpoints={endpointDetails:[]},this.participantCapabilities={canConference:!1,canShareScreen:!1,canMerge:!0},this.checkIfIncomingServerMutedIsUpdated(e),this.filteredParticipantEndpointDetails={},e.endpointDetails.forEach((e=>{const n=Tu(e,t);if(this.endpoints.endpointDetails.push(n),!n.mappedTo){if(this.filteredParticipantEndpointDetails[e.participantId]={endpointId:e.endpointId,serverMuteVersion:e.serverMuteVersion,endpointState:e.endpointState,mediaStreams:e.mediaStreams},e.capabilities&&(this.participantCapabilities.canConference||"enabled"!==e.capabilities.cloudAudioVideoConference||(this.participantCapabilities.canConference=!0),this.participantCapabilities.canShareScreen||"enabled"!==e.capabilities.cloudScreenSharing||(this.participantCapabilities.canShareScreen=!0),this.participantCapabilities.canMerge||"enabled"!==e.capabilities.cloudMerge||(this.participantCapabilities.canMerge=!0)),this.contentSharingRole=0,e.contentSharing&&e.contentSharing.sessionInformation){const t=e.contentSharing.sessionInformation;"attendee"===t.role?this.contentSharingRole=1:"presenter"===t.role&&(this.contentSharingRole=2)}n.streamInformation&&i&&i()}})),this.updateIsServerMuted(),n.info(`endpointDetails=${JSON.stringify(this.endpoints)}`),this.raiseChangedDeferred())}toCafeParticipant(){return{audioState:Ep[this.state],mri:this.mri}}getSourceIdForMediaType(e){const t=Pc(this,e);return-1===t&&this.logger.warn("getSourceIdForMediaType failed"),t}useUmsStream(e,t,i,n,r,s){this.streamManager.useUmsStream(e,t,i,n,r,s),this.raiseChangedDeferred()}hasSourceId(e,t){return void 0!==Ic(this,e,t)}},bp=class extends Ye{constructor(e,t,i,n,r,s="",a,o){super(),this.callTelemetry=e,this.signalingSession=i,this.contentSharingGuid=n,this.contentSharingIdentity=r,this.state=s,this.subject=a,this.handleOperationFailure=(e,t,i)=>{i.logFailure(e);const n=this.getTerminatedReasonFromError(e);return t.updateStatusTo&&(this.contentSharingStatus=t.updateStatusTo,this.rejectContentSharing(n)),Promise.reject(n)},this._logger=t.createChild((()=>`[ContentSharingSession][${this.contentSharingGuid}]`)),this.contentSharingStatus=0,this.contentSharingTerminationReason=null,this.contentSharingState=s,this._callOperationHandler=new Wn(this._logger,this.callTelemetry),o&&(this.sessionId=o)}get contentSharingStatus(){return this.status}set contentSharingStatus(e){if(this._logger.info(`[set contentSharingStatus][currentStatus=${this.status}][newStatus=${e}]`),this.callTelemetry.recordEvent("_SetContentSharingStatus",{newStatus:e,oldStatus:this.status}),this.status!==e&&7!==this.status&&8!==this.status){if(this._logger.info(`[set contentSharingStatus] Changing content sharing status to: ${e}`),this.status=e,7===this.status){const e={terminatedReason:12,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:"[set contentSharingStatus] Content sharing is disconnected"};this._callOperationHandler.maybeResolveOperation("StopContentSharing"),this._callOperationHandler.rejectPendingOperations(e)}if(2===this.status||5===this.status){const e={terminatedReason:60,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:"Content sharing cannot be ended when not presenting"};this._callOperationHandler.maybeRejectOperation("StopContentSharing",e)}3===this.status&&(this._callOperationHandler.maybeResolveOperation("StartContentSharing"),this._callOperationHandler.maybeResolveOperation("TakeContentSharingControl")),this.raiseChanged()}}get contentSharingState(){return this.state}set contentSharingState(e){this.state!==e&&(this.state=e,this.raiseChanged())}startContentSharing(e=Re()){const t=this._logger.createFnLogger("StartContentSharing",e);if(0!==this.contentSharingStatus){const i=`[${e}][startContentSharing][failed][reason=InvalidState]`,n={terminatedReason:60,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:i};return t.logFailure(`state=${this.contentSharingStatus}, reason=${i}`),Promise.reject(n)}return this.signalingSession.startContentSharingAsync(this.contentSharingIdentity,this.contentSharingState,this.subject,this.contentSharingGuid,e).then((e=>{this.sessionId=e.sessionId,this.contentSharingStatus=3,this.presenterId=this.signalingSession.participantManager.localParticipant.id})).catch((i=>this.handleOperationFailure(i,{causeId:e,operation:"StartContentSharing",updateStatusTo:8},t))),this._callOperationHandler.waitForOperation("StartContentSharing")}joinContentSharing(e=Re()){const t=this._logger.createFnLogger("JoinContentSharing",e);if(2!==this.contentSharingStatus){const i=`[${e}][joinContentSharing][failed][reason=InvalidState]`,n={terminatedReason:60,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:i};return t.logFailure(`state=${this.contentSharingStatus}, reason=${i}`),Promise.reject(n)}return this.signalingSession.joinContentSharingAsync(this.contentSharingGuid,e).then((e=>(this.contentSharingStatus=4,this.contentSharingState=e.sessionState,this.presenterId=e.presenter,Promise.resolve()))).catch((i=>this.handleOperationFailure(i,{causeId:e,operation:"JoinContentSharing",updateStatusTo:8},t)))}updateContentSharingSessionState(e,t,i=Re()){const n=this._logger.createFnLogger("UpdateContentSharingSessionState",i);if(3!==this.contentSharingStatus){const e=`[${i}][updateContentSharingSessionState][failed][reason=InvalidState]`,t={terminatedReason:60,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:e};return n.logFailure(`state=${this.contentSharingStatus}, reason=${e}`),Promise.reject(t)}return this.signalingSession.updateContentSharingSessionStateAsync(this.contentSharingGuid,t,i).then((()=>Promise.resolve())).catch((t=>this.handleOperationFailure(t,{causeId:i,operation:"UpdateContentSharingSessionState",operationId:e},n)))}takeContentSharingControl(e=Re()){const t=this._logger.createFnLogger("TakeContentSharingControl",e);if(5!==this.contentSharingStatus){const i=`[${e}][updateContentSharingSessionState][failed][reason=InvalidState]`,n={terminatedReason:60,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:i};return t.logFailure(`state=${this.contentSharingStatus}, reason=${i}`),Promise.reject(n)}return this.signalingSession.takeContentSharingControlAsync(this.contentSharingGuid,e).then((()=>{this.contentSharingStatus=3,this.presenterId=this.signalingSession.participantManager.localParticipant.id})).catch((i=>this.handleOperationFailure(i,{causeId:e,operation:"TakeContentSharingControl"},t))),this._callOperationHandler.waitForOperation("TakeContentSharingControl")}updateContentSharingParticipantStateToViewer(e=Re()){const t=this._logger.createFnLogger("UpdateParticipantState",e);if(4!==this.contentSharingStatus){const i=`[${e}][updateContentSharingSessionState][failed][reason=InvalidState]`,n={terminatedReason:60,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:i};return t.logFailure(`state=${this.contentSharingStatus}, reason=${i}`),Promise.reject(n)}return this.signalingSession.updateContentSharingParticipantStateAsync(this.contentSharingGuid,e).then((()=>(this.contentSharingStatus=this.presenterId===this.signalingSession.participantManager.localParticipant.id?3:5,Promise.resolve()))).catch((i=>this.handleOperationFailure(i,{causeId:e,operation:"UpdateParticipantState"},t)))}stopContentSharing(e=Re()){const t=this._logger.createFnLogger("StopContentSharing",e);if(2===this.contentSharingStatus||4===this.contentSharingStatus||5===this.contentSharingStatus){const i=`[${e}][stopContentSharing][failed][reason=InvalidState]`,n={terminatedReason:60,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:i};return t.logFailure(`state=${this.contentSharingStatus}, reason=${i}`),Promise.reject(n)}return this.signalingSession.deleteContentSharingAsync(this.contentSharingGuid,e).then((()=>(this.contentSharingStatus=7,this._callOperationHandler.waitForOperation("StopContentSharing")))).catch((i=>this.handleOperationFailure(i,{causeId:e,operation:"StopContentSharing"},t)))}dispose(e=Re()){this._callOperationHandler.rejectPendingOperations({terminatedReason:12,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:"Call ended"},e),this.contentSharingStatus=7,this.contentSharingState="",super.dispose()}rejectContentSharing(e={terminatedReason:12,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:"[rejectContentSharing] Content sharing is disconnected"}){if(7!==this.status&&8!==this.status)throw new Error(`Tried to reject content sharing with status=${this.status}`);this._callOperationHandler.maybeResolveOperation("StopContentSharing"),this._callOperationHandler.rejectPendingOperations(e)}getTerminatedReasonFromError(e){const t=e?.endCode?.code||0,i={terminatedReason:32,terminatedReasonCode:t,terminatedReasonSubCode:e?.endCode?.subCode||0,errorMessage:e};switch(t){case qn.NotFound:i.terminatedReason=34,i.errorMessage="Active session not found on server";break;case qn.Forbidden:i.terminatedReason=8,i.errorMessage="Failed due to insufficient permissions"}return i}};E([Mn("StartContentSharing"),_(0,kn)],bp.prototype,"startContentSharing",1),E([Mn("JoinContentSharing"),_(0,kn)],bp.prototype,"joinContentSharing",1),E([Mn("UpdateContentSharingSessionState"),_(0,Dn),_(2,kn)],bp.prototype,"updateContentSharingSessionState",1),E([Mn("TakeContentSharingControl"),_(0,kn)],bp.prototype,"takeContentSharingControl",1),E([Mn("UpdateParticipantState"),_(0,kn)],bp.prototype,"updateContentSharingParticipantStateToViewer",1),E([Mn("StopContentSharing",{waitFor:"StartContentSharing"}),_(0,kn)],bp.prototype,"stopContentSharing",1);var Pp,Ip,Ap=class{constructor(){this.messageCounters=new Map}recordDataChannelProtocolEvent(e){this.messageCounters.has(e.dataId)||this.messageCounters.set(e.dataId,{});const t=this.messageCounters.get(e.dataId);switch(t[e.direction]||(t[e.direction]={successful:0,failed:0,fragmented:0,dismissed:0}),e.state){case 0:t[e.direction].successful++;break;case 1:t[e.direction].failed++;break;case 2:t[e.direction].fragmented++;break;case 3:t[e.direction].dismissed++}}setSessionDataChannelState(e){this.sessionState=e.toString()}recordDataChannelError(e){this.dataChannelError=e}get protocolCounters(){if(!this.messageCounters.size)return;const e={};for(const t of this.messageCounters.keys())e[t]=this.messageCounters.get(t);return e}getReport(e){const t={};return t[e+"ProtocolCounters"]=JSON.stringify(this.protocolCounters),t[e+"SessionState"]=this.sessionState,t[e+"Error"]=this.dataChannelError,t}},Rp=class{constructor(e){this.value=e,this.next=void 0}},wp=class{constructor(){this.length=0}enqueue(e){const t=new Rp(e);this.front?(this.rear.next=t,this.rear=t):(this.front=t,this.rear=t),this.length++}dequeue(){if(!this.front)return;const e=this.front;return this.front===this.rear?(this.front=void 0,this.rear=void 0):this.front=this.front.next,this.length--,e.value}peek(){return this.front?.value}size(){return this.length}back(){return this.rear?.value}},Mp=i(496486),Op=class{constructor(e){this.comparator=e,this.heap=[]}enqueue(e){this.heap.push(e),this.bubbleUp()}dequeue(){const e=this.peek();if(void 0!==e){const e=this.heap.pop();this.size()>0&&(this.heap[0]=e,this.bubbleDown())}return e}peek(){return this.heap[0]}size(){return this.heap.length}bubbleUp(){let e=this.size()-1,t=this.getParentIndex(e);for(;!this.isRoot(e)&&this.comparator(this.heap[e],this.heap[t]);)[this.heap[t],this.heap[e]]=[this.heap[e],this.heap[t]],e=t,t=this.getParentIndex(e)}bubbleDown(){if(this.size()<=1)return;let e=this.getRootIndex(),t=this.getLeftIndex(e),i=this.getRightIndex(e);for(;this.heap[t]&&this.comparator(this.heap[t],this.heap[e])||this.heap[i]&&this.comparator(this.heap[i],this.heap[e]);)!this.heap[i]||this.comparator(this.heap[t],this.heap[i])?([this.heap[e],this.heap[t]]=[this.heap[t],this.heap[e]],e=t):([this.heap[e],this.heap[i]]=[this.heap[i],this.heap[e]],e=i),t=this.getLeftIndex(e),i=this.getRightIndex(e)}getRootIndex(){return 0}isRoot(e){return 0===e}getLeftIndex(e){return 2*e+1}getRightIndex(e){return 2*e+2}getParentIndex(e){return Math.floor((e-1)/2)}},Dp=class{constructor(e,t,i){this.maxPacketRate=t,this.rateLimiterCheckInterval=i,this.maxDataRate=0,this.packetsEndTimeForPacketRate=0,this.packetsEndTimeForBitrate=0,this.maxDataRate=e/8}canSend(e){if(0===this.maxDataRate&&0===this.maxPacketRate)return!0;const t=kt();if(this.maxPacketRate&&this.packetsEndTimeForPacketRate>t+this.rateLimiterCheckInterval)return!1;if(this.maxDataRate&&this.packetsEndTimeForBitrate>t+this.rateLimiterCheckInterval)return!1;const i=this.maxPacketRate?1e3/this.maxPacketRate:0,n=this.maxDataRate?e.length/this.maxDataRate*1e3:0;return this.packetsEndTimeForPacketRate=Math.max(this.packetsEndTimeForPacketRate,t)+i,this.packetsEndTimeForBitrate=Math.max(this.packetsEndTimeForBitrate,t)+n,!0}},kp=class{constructor(e){this.dataIds=new Map,this.maxBitrate=e.config.webrtcDataChannel.maxBitrate,this.maxPacketRate=e.config.webrtcDataChannel.maxPacketRate,this.maxQueueSize=e.config.webrtcDataChannel.maxQueueSize,e.config.webrtcDataChannel.dataIds.forEach((e=>{this.dataIds.set(e.dataId,e)}))}getMaxBitrate(e){return this.dataIds.get(e)?.maxBitrate??this.maxBitrate}getMaxPacketRate(e){return this.dataIds.get(e)?.maxPacketRate??this.maxPacketRate}getMaxQueueSize(e){return this.dataIds.get(e)?.maxQueueSize??this.maxQueueSize}getConfig(e){const t=this.dataIds.get(e)||{dataId:e};return t.maxBitrate=t.maxBitrate??this.maxBitrate,t.maxPacketRate=t.maxPacketRate??this.maxPacketRate,t.maxQueueSize=t.maxQueueSize??this.maxQueueSize,t.priorityWeight=t.priorityWeight??1,t}},Np=class{constructor(e,t,i){this.dataIdConfig=t,this.rateLimiterCheckInterval=i,this.timeOffset=0,this.packets=new wp,this.startTime=e(),this.finishTime=this.startTime,this.rateLimiter=new Dp(t.maxBitrate,t.maxPacketRate,this.rateLimiterCheckInterval),this.getCurrentTime=e,this.stats={bufferSize:t.maxQueueSize,remainingBytes:0,remainingPackets:0}}enqueue(e){if(0===e.length)return 0;const t=(0,Mp.sumBy)(e,(e=>e.length)),i=this.dataIdConfig.maxQueueSize;if(i&&this.stats.remainingBytes+t>i)throw new Error(`dataId ${this.dataIdConfig.dataId} send queue is full`);const n=this.getCurrentTime();let r=0;return 0===this.packets.size()?(this.startTime=n,this.finishTime=n,this.timeOffset=0,r=n):r=this.finishTime,e.forEach((e=>{r+=e.length*this.dataIdConfig.priorityWeight,this.packets.enqueue({finishTime:r,packet:e}),this.stats.remainingBytes+=e.length,this.stats.remainingPackets++})),this.finishTime=r,t}dequeue(){const e=this.peek();if(void 0!==e){if(!this.rateLimiter.canSend(e.packet))return;this.packets.dequeue(),this.stats.remainingBytes-=e.packet.length,this.stats.remainingPackets--}return e}updateTimeOffset(){this.packets.size()?this.timeOffset=this.getCurrentTime()-this.startTime:(this.startTime=this.getCurrentTime(),this.finishTime=this.startTime,this.timeOffset=0)}peek(){if(0===this.packets.size())return;const e=this.packets.peek();return{finishTime:e.finishTime+this.timeOffset,packet:e.packet}}getConfig(){return this.dataIdConfig}getStats(){return(0,Mp.clone)(this.stats)}},Lp=class{constructor(e){this.senders=new Map,this.currentVirtualClock=0,this.dataIdConfigManager=new kp(e),this.virtualTimeQueue=new Op(((e,t)=>e.minTime<t.minTime)),this.sendStats={bufferSize:0,remainingBytes:0,remainingPackets:0},this.rateLimiterCheckInterval=e.config.webrtcDataChannel.rateLimiterCheckInterval}getPacketsToSend(e){if(0===this.virtualTimeQueue.size())return[];const t=[],i=[];for(;e>=0&&this.virtualTimeQueue.size();){const n=this.virtualTimeQueue.peek();if(n.size>e)break;this.virtualTimeQueue.dequeue();const r=n.dataId,s=this.senders.get(r);if(void 0!==s.peek()){const n=s.dequeue();if(void 0!==n){t.push(n.packet),this.sendStats.remainingBytes-=n.packet.length,e-=n.packet.length,this.sendStats.remainingPackets--,this.currentVirtualClock=Math.max(this.currentVirtualClock,n.finishTime);const i=s.peek();i&&this.virtualTimeQueue.enqueue({dataId:r,minTime:i.finishTime,size:i.packet.length})}else i.push(r)}}return i.forEach((e=>{const t=this.senders.get(e);t.updateTimeOffset();const i=t.peek();i&&this.virtualTimeQueue.enqueue({dataId:e,minTime:i.finishTime,size:i.packet.length})})),t}appendPackets(e,t){let i=this.senders.get(e);void 0===i&&(i=new Np((()=>this.currentVirtualClock),this.dataIdConfigManager.getConfig(e),this.rateLimiterCheckInterval),this.senders.set(e,i));const n=i.getStats(),r=i.enqueue(t);if(this.sendStats.remainingBytes+=r,this.sendStats.remainingPackets+=t.length,0===n.remainingPackets){const t=i.peek();void 0!==t&&this.virtualTimeQueue.enqueue({dataId:e,minTime:t.finishTime,size:t.packet.length})}}getStats(e){if(void 0===e)return(0,Mp.clone)(this.sendStats);const t=this.senders.get(e);return void 0===t?{bufferSize:this.dataIdConfigManager.getMaxQueueSize(e),remainingBytes:0,remainingPackets:0}:t.getStats()}},xp=class{constructor(e,t,i){this.dataId=e,this.statsGatherer=t,this.logger=i,this.pendingFragments=[]}depacketize(e){const t=new DataView(e.buffer),i=63&t.getUint8(2);if(i!==this.dataId)throw new Error(`Invalid packet dataId: ${this.dataId} !== ${i}`);const n=((15&t.getUint8(0))<<8)+t.getUint8(1),r=128&t.getUint8(2),s=t.getUint16(3),a=t.getUint8(5),o=t.getUint32(6),l=t.getUint8(10);if(r){this.pendingFragments.length&&this.logger.warn(`Unfinished message: dataId: ${this.dataId} seqNum: ${s}`),this.remainingPackets=a,0!==a&&this.statsGatherer.recordDataChannelProtocolEvent({direction:"recv",state:2,dataId:i}),this.pendingFragments=[],this.sourceId=o,this.recipients=[];for(let e=0;e<l;e++){const i=t.getUint32(11+4*e);this.recipients.push(i)}}else{if(0===this.pendingFragments.length)return this.logger.safe.error(`No start flag dataId: ${this.dataId} seqNum: ${s}`),this.statsGatherer.recordDataChannelProtocolEvent({direction:"recv",state:3,dataId:i}),null;if(this.nextSeqNum!==s)return this.logger.safe.error(`Invalid sequence number: dataId: ${this.dataId} seqNum: ${s}`),this.statsGatherer.recordDataChannelProtocolEvent({direction:"recv",state:3,dataId:i}),null;this.remainingPackets-=1}if(this.nextSeqNum=s+1&65535,this.pendingFragments.push(e.slice(n)),0===this.remainingPackets){const e=this.pendingFragments.reduce(((e,t)=>e+t.length),0),t=new Uint8Array(e);let i=0;for(const e of this.pendingFragments)t.set(e,i),i+=e.length;return this.pendingFragments=[],{dataId:this.dataId,sourceId:this.sourceId,data:t,recipients:this.recipients}}return null}},Fp=class{constructor(e){this.seqNum=0,this.dataId=e}packetize(e){if(e.dataId!==this.dataId)throw new Error(`Invalid dataId: ${this.dataId} !== ${e.dataId}`);const t=11+4*e.recipients.length,i=new Uint8Array(e.data.length+t),n=new DataView(i.buffer);n.setUint8(0,16+(t>>8)),n.setUint8(1,255&t),n.setUint8(2,128|63&e.dataId),n.setUint16(3,this.seqNum),n.setUint8(5,0),n.setUint32(6,e.sourceId),n.setUint8(10,e.recipients.length);for(let t=0;t<e.recipients.length;t++)n.setUint32(11+4*t,e.recipients[t]);return i.set(e.data,t),this.seqNum+=1,[i]}},Up=class{constructor(e,t,i){this.statsGatherer=i,this.seqNum=0,this.dataId=e,this.fragmentationSize=t}packetize(e){if(e.dataId!==this.dataId)throw new Error(`Invalid dataId: ${this.dataId} !== ${e.dataId}`);const t=11+4*e.recipients.length,i=[],n=this.fragmentationSize-t;if(n<0)throw new Error(`message dataId: ${this.dataId} payload size: ${t} exceeds limit`);let r=e.data.length?Math.ceil(e.data.length/n):1;const s=r-1;s>0&&this.statsGatherer.recordDataChannelProtocolEvent({direction:"send",state:2,dataId:this.dataId});let a=e.data.length,o=!0,l=0;for(;r>0;){const d=Math.min(a,n),c=new Uint8Array(d+t),h=new DataView(c.buffer);h.setUint8(0,16+(t>>8)),h.setUint8(1,255&t),o?(o=!1,h.setUint8(2,128|63&e.dataId)):h.setUint8(2,63&e.dataId),h.setUint16(3,this.seqNum),h.setUint8(5,s),h.setUint32(6,e.sourceId),h.setUint8(10,e.recipients.length);for(let t=0;t<e.recipients.length;t++)h.setUint32(11+4*t,e.recipients[t]);c.set(e.data.slice(l,l+d),t),l+=d,i.push(c),this.seqNum+=1,r-=1,a-=d}return i}},Vp=class extends Qe{constructor(e,t,i,n){super(),this.dataChannel=e,this.statsGatherer=t,this.stateInternal="Created",this.packetizers=new Map,this.depacketizers=new Map,this.sendScheduleTimer=0,this.pendingPackets=new wp,this.label=e.label,this.logger=i.createChild(`[WebRtcDataChannel ${this.label}]`),this.bufferedAmountLowThreshold=n.config.webrtcDataChannel.bufferedAmountLowThreshold,this.bufferedAmountHighThreshold=n.config.webrtcDataChannel.bufferedAmountHighThreshold,this.fragmentationSize=n.config.webrtcDataChannel.enableFragmentation?n.config.webrtcDataChannel.fragmentationSize:0,n.config.webrtcDataChannel.enableSendScheduler&&(this.sendScheduler=new Lp(n)),this.rateLimiterCheckInterval=n.config.webrtcDataChannel.rateLimiterCheckInterval,this.discardOnSendFailure=n.config.webrtcDataChannel.discardOnSendFailure,this.subscribeOnDataChannelEvents()}getDataIdStats(e){return this.sendScheduler?.getStats(e)}get state(){return this.stateInternal}setDataChannel(e){this.dataChannel&&(this.logger.info(`Replacing internal data channel ${this.label}:${this.dataChannel.id} with ${e.label}:${e.id}`),this.unsubscribeOnDataChannelEvents(),this.dataChannel.close()),this.dataChannel=e,this.subscribeOnDataChannelEvents()}dispose(){this.logger.info("dispose"),this.dataChannel&&(this.logger.info(`dataChannel.close ${this.dataChannel.id}`),this.unsubscribeOnDataChannelEvents(),this.dataChannel.close(),this.dataChannel=null,this.setState("Destroyed"),super.dispose())}sendMessage(e,t,i,n=[]){try{this.packetizers.has(e)||(this.fragmentationSize?this.packetizers.set(e,new Up(e,this.fragmentationSize,this.statsGatherer)):this.packetizers.set(e,new Fp(e)));const r=this.packetizers.get(e).packetize({dataId:e,sourceId:t,data:i,recipients:n});void 0!==this.sendScheduler?(this.sendScheduler.appendPackets(e,r),this.scheduleSend()):r.forEach((e=>{this.dataChannel.send(e)})),this.statsGatherer.recordDataChannelProtocolEvent({direction:"send",state:0,dataId:e})}catch(t){throw this.logger.unsafe.warn(`Failed to construct protocol message: ${Ge(t)}`),this.statsGatherer.recordDataChannelProtocolEvent({direction:"send",state:1,dataId:e}),t}}scheduleSend(){if("Connected"!==this.state)return;const e=e=>{try{this.dataChannel.send(e)}catch(e){return this.logger.unsafe.warn(`Failed to send message: ${Ge(e)}`),!1}return!0};if(this.dataChannel.bufferedAmount<=this.dataChannel.bufferedAmountLowThreshold){const t=Date.now();let i=this.bufferedAmountHighThreshold-this.dataChannel.bufferedAmount;for(;this.pendingPackets.size();){const t=this.pendingPackets.peek();if(t.length>i)break;if(!e(t))break;this.pendingPackets.dequeue(),i-=t.length}if(0===this.pendingPackets.size()&&i>0){const t=this.sendScheduler.getPacketsToSend(i);for(const i of t)if(!1===e(i)&&!1===this.discardOnSendFailure){this.pendingPackets.enqueue(i);break}}if(this.dataChannel.bufferedAmount<=this.dataChannel.bufferedAmountLowThreshold){if(this.sendScheduleTimer)return;if(this.sendScheduler.getStats().remainingPackets>0){const e=Math.max(t+this.rateLimiterCheckInterval-Date.now(),20);this.sendScheduleTimer=window.setTimeout((()=>{this.sendScheduleTimer=0,this.scheduleSend()}),e)}}}}subscribeOnDataChannelEvents(){this.dataChannel.binaryType="arraybuffer",this.dataChannel.onmessage=e=>{const t=new Uint8Array(e.data),i=63&t[2];try{this.depacketizers.has(i)||this.depacketizers.set(i,new xp(i,this.statsGatherer,this.logger));const e=this.depacketizers.get(i).depacketize(t);e&&(this.statsGatherer.recordDataChannelProtocolEvent({direction:"recv",state:0,dataId:i}),this.event("onmessage").raise(i,e.sourceId,e.data))}catch(e){this.logger.unsafe.warn(`Failed to parse incoming message: ${Ge(e)}`),this.statsGatherer.recordDataChannelProtocolEvent({direction:"recv",state:1,dataId:i})}},this.dataChannel.onerror=e=>{const t=e?.target,i=Ge(e?.error??e);this.logger.safe.warn(`onerror: label:${t.label} id:${t.id} ${i} `),this.statsGatherer.recordDataChannelError(i)},"open"===this.dataChannel.readyState&&this.dataChannel.id%2==0&&(this.logger.safe.info(`readyState is already 'open' label:${this.dataChannel.label} id:${this.dataChannel.id}`),this.setState("Connected")),this.dataChannel.onopen=e=>{const t=e.target;this.logger.safe.info(`onopen label:${t.label} id:${t.id}`),t.id%2==0&&this.setState("Connected")},this.dataChannel.onclose=e=>{const t=e.target;this.logger.safe.info(`onclose label:${t.label} id:${t.id}`),this.setState("Closed")},this.dataChannel.onclosing=e=>{const t=e.target;this.logger.safe.debug(`onclosing label:${t.label} id:${t.id}`),this.setState("Closed")},void 0!==this.sendScheduler&&(this.dataChannel.bufferedAmountLowThreshold=this.bufferedAmountLowThreshold,this.dataChannel.onbufferedamountlow=()=>{this.scheduleSend()})}unsubscribeOnDataChannelEvents(){this.dataChannel.onmessage=null,this.dataChannel.onerror=null,this.dataChannel.onopen=null,this.dataChannel.onclose=null,this.dataChannel.onclosing=null,this.dataChannel.onbufferedamountlow=null}setState(e){this.stateInternal=e,this.event("onStateChanged").raise(),"Connected"===e&&void 0!==this.sendScheduler&&this.scheduleSend()}},Hp=class extends Qe{constructor(e,t,i,n){const r=i.createChild("PluginlessDataChannel");super(r),this.pc=e,this.statsGatherer=t,this.configProvider=n,this._state="Inactive",this.logger=r,this.subscribeOnDatachannel()}get state(){return this._state}getDataChannel(e){if(!this.dataChannel){this.logger.safe.info(`[${e}] creating new dataChannel`);try{const e={};this.dataChannel=new Vp(this.pc.createDataChannel("main-channel",e),this.statsGatherer,this.logger,this.configProvider),this.subscribeForDataChannelEvents()}catch(t){return this.logger.safe.error(`[${e}] createDataChannel failed: ${Ge(t)}`),this.statsGatherer.sessionInfo.setCreateChannelFailReason(t),this.setState("Failed"),null}}return this.dataChannel}updateDataModalityState(e){"Failed"!==this._state&&"Disabled"!==this._state&&(e===tt.MEDIA_STATE.sendReceive?this.setState("Active"):e===tt.MEDIA_STATE.inactive&&this.setState("Inactive"))}disable(){this.setState("Disabled")}dispose(){this.stopDataChannel(),this.pc=null,super.dispose()}subscribeOnDatachannel(){this.pc.ondatachannel=e=>{this.onDataChannel(e.channel)}}onDataChannel(e){this.logger.safe.info(`onDataChannel id=${e.id} label=${e.label}`),e.id%2==0?this.dataChannel?(this.logger.safe.info("Found existing data channel, replacing"),this.dataChannel.setDataChannel(e)):(this.dataChannel=new Vp(e,this.statsGatherer,this.logger,this.configProvider),this.subscribeForDataChannelEvents()):this.logger.safe.info(`onDataChannel ignoring id ${e.id}`)}subscribeForDataChannelEvents(){this.dataChannel.on("onStateChanged",(()=>{"Closed"===this.dataChannel.state&&(this.stopDataChannel(),this.setState("Inactive"))}))}setState(e){if(this._state!==e){this.statsGatherer.setSessionDataChannelState(e);const t=Re();this._state=e,this.logger.safe.info(`[${t}] SessionDataChannelState changed, state=${this._state}`),"Inactive"===this._state||"Disabled"===this._state?this.stopDataChannel():"Active"===this._state&&this.getDataChannel(t),this.event("onStateChanged").raise(this._state)}}stopDataChannel(){this.dataChannel&&(this.logger.safe.info("stopDataChannel"),this.dataChannel.dispose(),this.dataChannel=null)}},Bp=class extends Ye{constructor(e){super(),this.mainChannel=null,this.sourceId=Pn,this._state="Inactive",this.dataHandlers=new Map,this.dataHandlerTelemetry=new Map,this.startTime=Date.now(),this.sendMessage=async(e,t,i)=>{if(this.logger.debug(`Sending message for ${e}, from: ${this.sourceId} to: ${i} state: ${!!this.mainChannel&&this.mainChannel.state} len: ${t.length}`),!this.mainChannel||"Connected"!==this.mainChannel.state||"Active"!==this.state)throw new Error("No active data channel to send data from");this.mainChannel.sendMessage(e,this.sourceId,t,i)},this.logger=e.createChild("PluginlessDataChannel")}get state(){return this._state}registerSessionDataChannel(e,t){this.sessionDataChannel&&this.stop(t),this.sessionDataChannel=e,this.subscribeForSessionDataChannelEvents()}setDataChannelSourceId(e){this.logger.debug(`setDataChannelSourceId ${e}`),this.sourceId=e}requestDataChannelHandler(e){return this.sessionDataChannel.getDataChannel(e)}async sendUserEvents(e,t){if(!this.mainChannel)throw this.logger.info("sendUserEvents() no data channel available"),new Error("Main DataChannel is not active");{const i=t?t.map((e=>parseInt(e,10))):[];this.mainChannel.sendMessage(0,this.sourceId,(new TextEncoder).encode(e),i)}}async addHandler(e,t){if(this.logger.info(`Adding handler with dataId ${e}`),this.dataHandlers.get(e))throw new Error(`Data Id ${e} is already registered`);const i={isStarted:!1,handler:t};this.dataHandlers.set(e,i),this.recordDataHandlerEvent(e,"added"),"Connected"===this.mainChannel?.state&&this.startHandler(e,i)}async removeHandler(e){if(this.logger.info(`Removing handler with dataId ${e}`),!this.dataHandlers.has(e))throw new Error(`Handler associated with Data Id ${e} is not attached`);const t=this.dataHandlers.get(e);t.isStarted&&this.stopHandler(e,t),this.dataHandlers.delete(e)}async updateNegotiationTag(e){}getTelemetry(){if(!this.dataHandlerTelemetry.size)return"";const e={};for(const[t,i]of this.dataHandlerTelemetry)e[t]=i;return JSON.stringify(e)}start(e){this.mainChannel?this.logger.info(`[${e}] already started`):(this.logger.info(`[${e}] starting`),this.mainChannel=this.sessionDataChannel.getDataChannel(e),this.subscribeForMainDataChannelEvents())}stop(e){this.mainChannel&&(this.logger.info(`[${e}] stopping`),this.mainChannel.dispose(),this.mainChannel=null)}dispose(){this.stop(void 0),this.sessionDataChannel=null,super.dispose()}setConfigProviderView(e){this.configProviderView=e}subscribeForMainDataChannelEvents(){this.mainChannel.on("onmessage",((e,t,i)=>{this.logger.debug(`Got message for ${e}, from: ${t} state: ${!!this.mainChannel&&this.mainChannel.state}, len: ${i.length}`),this.dataHandlers.has(e)&&(this.recordDataHandlerEvent(e,"recvd"),this.dataHandlers.get(e).handler.onDataReceived(e,i,t)),this.event("remoteUserEventsReceived").raise(e.toString(),(new TextDecoder).decode(i))})),this.onMainChannelStateChanged(),this.mainChannel.on("onStateChanged",(()=>this.onMainChannelStateChanged()))}onMainChannelStateChanged(){if(this.mainChannel)switch(this.mainChannel.state){case"Connected":this.startHandlers();break;case"Closed":case"Destroyed":this.stopHandlers()}}startHandlers(){for(const[e,t]of this.dataHandlers.entries())t.isStarted||this.startHandler(e,t)}stopHandlers(){for(const[e,t]of this.dataHandlers.entries())t.isStarted&&this.stopHandler(e,t)}startHandler(e,t){this.logger.info(`Starting dataHandler id: ${e}`),t.handler.onStarted(e,((t,i)=>(this.recordDataHandlerEvent(e,"sent"),this.sendMessage(e,t,i))),(()=>{const t=this.mainChannel?.getDataIdStats(e);if(void 0!==t){const e={bufferSize:t.bufferSize,remainingBytes:t.remainingBytes,remainingPackets:t.remainingPackets};return Promise.resolve(e)}return Promise.reject(new Error(`Stats of dataId ${e} is not available`))})),t.isStarted=!0,this.recordDataHandlerEvent(e,"started")}stopHandler(e,t){this.logger.info(`Stopping dataHandler id: ${e}`),t.handler.onStopped(e),t.isStarted=!1,this.recordDataHandlerEvent(e,"removed")}subscribeForSessionDataChannelEvents(){this.sessionDataChannel.on("onStateChanged",(e=>{const t=Re();switch(e){case"Active":this.start(t),this.setState("Active");break;case"Inactive":this.stop(t),this.setState("Inactive");break;case"Failed":this.stop(t),this.setState("Failed");break;case"Disabled":this.stop(t),this.setState("Disabled");break;default:this.logger.warn(`[${t}] unhandled SessionDataChannelState ${e}`)}}))}recordDataHandlerEvent(e,t){this.dataHandlerTelemetry.has(e)||this.dataHandlerTelemetry.set(e,[{}]);const i=this.dataHandlerTelemetry.get(e);let n=i[i.length-1];if("added"===t&&void 0!==n.added){n={},i.push(n);const e=this.configProviderView?.config.maxStoredDataChannelValues??15;i.length>e&&i.shift()}switch(t){case"added":case"started":case"removed":n[t]=Date.now()-this.startTime;break;case"recvd":case"sent":n[t]=isNaN(n[t])?1:n[t]+1}}setState(e){this._state!==e&&(this._state=e,this.logger.info(`PluginlessDataChannelState changed, state=${this._state}`),this.event("onDataChannelStateUpdated").raise(this._state))}},$p=T(ye());(Ip=Pp||(Pp={})).encodeMouseEvent=function(e){if(!e)return new Uint8Array(0);e.buttonType||(e.buttonType=0),e.xPos||(e.xPos=0),e.yPos||(e.yPos=0),e.wheelRotation||(e.wheelRotation=0);const t=new ArrayBuffer(7),i=new DataView(t),n=(3&e.type)<<0,r=(7&e.buttonType)<<2,s=(e.buttonDown?1:0)<<5,a=(e.wheelButtonDown?1:0)<<6;return i.setUint8(0,1),i.setUint8(1,n|r|s|a|0),i.setUint16(2,e.xPos,!0),i.setUint16(4,e.yPos,!0),i.setUint8(6,e.wheelRotation),new Uint8Array(t)},Ip.encodeKeyboardEvent=function(e){const t=new ArrayBuffer(3),i=new DataView(t),n=(3&e.codeType)<<0,r=(e.keyUp?1:0)<<4,s=(e.repeat?1:0)<<5;return i.setUint8(0,0),i.setUint8(1,0|n|r|s|0),i.setUint8(2,e.code),new Uint8Array(t)},Ip.decodeEventType=function(e){return e[0]},Ip.decodeMouseEvent=function(e){if(1!==e[0]||7!==e.length)return null;const t=new DataView(e.buffer),i=t.getUint8(1);return{type:3&i,buttonType:i>>2&7,buttonDown:!!(i>>5&1),wheelButtonDown:!!(i>>6&1),xPos:t.getUint16(2,!0),yPos:t.getUint16(4,!0),wheelRotation:t.getUint8(6)}},Ip.decodeKeyboardEvent=function(e){if(0!==e[0]||3!==e.length)return null;const t=new DataView(e.buffer),i=t.getUint8(1);return{codeType:3&i,code:t.getUint8(2),repeat:!!(i>>5&1),keyUp:!!(i>>4&1)}};var jp=i(496486),Gp=i(174958),Wp=1e4,qp="",zp=class extends mn{constructor(e,t,i,n,r,s){super(e,t,(()=>this.recordedEvents.length>100)),this.negotiationTag=i,this.callId=n,this.participantId=r,this.endpointId=s,this.messagesFromUnknownSender={},this.tsCallingVersion="2024.13.01.19"}recordProtocolMessage(e,t){e||(t in this.messagesFromUnknownSender||(this.messagesFromUnknownSender[t]=0),this.messagesFromUnknownSender[t]++)}setCallId(e){this.callId=e}setEndpointId(e){this.endpointId=e}setParticipantId(e){this.participantId=e}setTenantId(e){this.tenantId=e}setUserHexCID(e){this.userHexCID=e}},Kp=class extends zp{constructor(e,t,i,n,r,s,a){super(e,t,i,n,r,s);const o=Rc(a);if(o){this.sharerParticipantId=o;const e=(0,jp.find)(a.endpoints.endpointDetails,(e=>e.participantId===o));e&&(this.sharerClientVersion=e.clientVersion)}}getEvent(e,t){const i=e=>void 0===e?"":e;return{CorrelationId:i(this.callId),ParticipantId:i(this.participantId),EndpointId:i(this.endpointId),NegotiationTag:i(this.negotiationTag),TsCallingVersion:i(this.tsCallingVersion),TenantId:i(this.tenantId),SharerParticipantId:i(this.sharerParticipantId),SharerClientVersion:i(this.sharerClientVersion),EventTimestampBag:super.getEventTimestampBag(e,t),ProtocolMessages:JSON.stringify({UnknownSender:this.messagesFromUnknownSender})}}},Jp=class extends zp{constructor(e,t,i,n,r,s){super(e,t,i,n,r,s)}getEvent(e,t){const i=e=>void 0===e?"":e;return{CorrelationId:i(this.callId),ParticipantId:i(this.participantId),EndpointId:i(this.endpointId),NegotiationTag:i(this.negotiationTag),TsCallingVersion:i(this.tsCallingVersion),TenantId:i(this.tenantId),EventTimestampBag:super.getEventTimestampBag(e,t),ProtocolMessages:JSON.stringify({UnknownSender:this.messagesFromUnknownSender})}}},Yp=class extends Ye{constructor(e,t,i,n){super(e),this._logger=e,this._call=t,this._telemetryLoggers=i,this._config=n,this.controlState=0,this.role=0,this._enabled=!1,this._availableAckEnabled=!0,this._dataChannelAvailable=!1,this._availableHandshakeSent=!1,this._controlRequest=null,this._controlRequestSubscription=null,this._controllerParticipant=null,this._controllerParticipantSubscription=null,this._controllerSourceId=null,this._screenSharingVideoRenderer=null,this._screenSharingVideoRendererSubscriptions=[],this._sharerParticipant=null,this._pendingSharer=null,this._controlCapturer=null,this._captureEventSubscription=null,this._mouseControlEventSubscription=null,this._keyboardControlEventSubscription=null,this._requestControlTimer=null,this._grantControlTimer=null,this._acceptControlTimer=null,this._terminateControlTimer=null,this._delayedSendHandshakeTimer=null,this._availableAckTimer=null,this._retryAttempt=0,this._raiseRenderedAtViewer=null,this._participantSubscriptions={},this._viewerSessionLastTerminatedReason=0,this._completedViewerSessions=[],this.giveControlEnabled=!0,this.isEscalationInProgress=!1,this._logger.info("constructor"),this._callId=this._call.callId,this._call.on("callIdChanged",(e=>{this._callId=e,this._currentViewerSessionTelemetry&&this._currentViewerSessionTelemetry.setCallId(e),this._currentSharerSessionTelemetry&&this._currentSharerSessionTelemetry.setCallId(e)})),this._participantId=this._call.participantId,this._call.on("callLegIdChanged",(e=>{this._participantId=e,this._currentViewerSessionTelemetry&&this._currentViewerSessionTelemetry.setParticipantId(e),this._currentSharerSessionTelemetry&&this._currentSharerSessionTelemetry.setParticipantId(e)})),this._endpointId=this._call.endpointId}setAdapters(e,t,i){this._controlInjector=e,this._rendererAdapter=t,this._dataChannelAdapter=i,this._dataChannelAdapter.on("stateChange",(e=>{this._onDataChannelStatusChanged(e)})),this._dataChannelAdapter.on("protocolMessage",((e,t,i,n)=>this.processProtocolMessage(e,t,i,n))),this._dataChannelAdapter.on("controlMessage",((e,t)=>this.processControlMessage(e,t)))}testSetControlInjector(e){}enableScreenSharingControl(e,t,i,n){if(this._logger.info(`enableScreenSharingControl() enabled=${e} disabledReason=${t}`),this._availableAckEnabled!==e||this._allowControlForUser!==n){if(this._allowControlForUser=n,e)this._raiseScreenSharingControlCapableEvent(!0,qp);else{if(0===t){const e={reason:2,detail:i};this.event("sharingControlError").raise(e)}this._raiseScreenSharingControlCapableEvent(!1,qp)}if(this._availableAckEnabled!==e){const t=e?"AvailableAckEnabled":"AvailableAckDisabled";this._recordSharerSessionTelemetry((e=>e.recordEvent(t)),!1)}this._availableAckEnabled=e}}setGiveControlEnabled(e){this.giveControlEnabled=e}_canEnableGiveControl(){return this._controlInjector.canBeEnabled()&&this.giveControlEnabled}setRaiseRenderedAtViewer(e){this._raiseRenderedAtViewer=e}setScreenSharingControlFeatureFlag(e){this._logger.info(`setScreenSharingControlFeatureFlag() enabled=${e}`),this._enabled=e,this._availableAckEnabled=e,this._enabled&&this._handleCallState(this._callState)}isScreenSharingControlEnabled(){return this._enabled}_disposeRenderer(e){this._disposeControlCapturer(e);for(const e of this._screenSharingVideoRendererSubscriptions)e.dispose();this._screenSharingVideoRendererSubscriptions=[],this._screenSharingVideoRenderer=null}setRenderer(e,t){this._logger.info("setRenderer");const i=Re();if(this._disposeRenderer(i),!e)return Promise.resolve();const n=t||this._rendererAdapter.getTarget(e);return Ti((()=>{this._setViewingRenderer(e,n)}))}_isDataChannelActive(){return this._dataChannelAdapter.isActive()&&this._dataChannelAvailable}_raiseScreenSharingControlCapableEvent(e,t,i){if(this._enabled&&this._isDataChannelActive()){this._logger.info(`_raiseScreenSharingControlCapableEvent() enabled=true, capable=${e}, role=${this.role}`);const n={capable:e,id:t,disabledBySharer:i};this.event("sharingControlCapable").raise(n)}else{this._logger.info(`_raiseScreenSharingControlCapableEvent() enabled=false, capable=${e}, role=${this.role}`);const i={capable:!1,id:t};this.event("sharingControlCapable").raise(i)}}initControlForSharer(e){this._logger.info("initControlForSharer()"),this._isSharing()&&this._logger.warn("initControlForSharer() when already sharing"),this._resetControlState(),this._screenSharingVideoRenderer=null,this._disposeControlCapturer(),this._logger.info(`role is changing from=${this.role} to=1`),this.role=1,this._availableHandshakeSent=!1,this._raiseScreenSharingControlCapableEvent(this._canEnableGiveControl(),qp),this._initiateSharerSessionTelemetry(e)}enableControlInjector(e){this._logger.info(`enableControlInjector() trackId: ${e}`),this._canEnableGiveControl()?this._controlInjector.enableInjector(e).catch((e=>{const t={reason:0,detail:JSON.stringify({errorMsg:e})};this.event("sharingControlError").raise(t)})):this._logger.info("enableControlInjector() give control cannot be enabled")}shutdownControlForSharer(){if(this._logger.info("shutdownControlForSharer()"),this._isSharing()||this._logger.warn("shutdownControlForSharer() when not sharing"),this._controlRequest){this._logger.warn("Rejecting pending control requests");const e=this._getDataSourceIdForParticipantLeg(this._controlRequest),t=this._controlRequest;this._clearControlRequest(),this._raiseControlRequestCanceled(t),this._sendControlRejectRequest(5,e)}if(this._controllerParticipant){const e={inControl:!1,id:this._controllerParticipant.participant.id,terminatedReason:5};this.event("sharingControlChanged").raise(e)}this._finalizeSharerSessionTelemetry("Shutdown"),this._teardownSharerRemoteControl(),this._controlInjector.disableInjector().catch((e=>{const t={reason:0,detail:JSON.stringify({errorMsg:e})};this.event("sharingControlError").raise(t)})),this._resetControlState(),this._resetParticipantSubscriptions(),this._availableAckEnabled=this._enabled,this._logger.info(`role is changing from=${this.role} to=0`),this.role=0}_resetParticipantSubscriptions(){this._logger.info("resetParticipantSubscriptions() Stopping tracking all participant state changes"),(0,jp.each)(this._participantSubscriptions,(e=>{e.dispose()})),this._participantSubscriptions={}}_initiateViewerSessionTelemetry(e,t,i){if(!i&&!t)return null;if(!i&&(0,jp.find)(this._completedViewerSessions,(e=>t===e)))return null;if(this._currentViewerSessionTelemetry){if(this._currentViewerSessionTelemetry.negotiationTag===t)return null;this._finalizeViewerSessionTelemetry("ShutdownByOtherSession")}return this._logger.info(`Initiating new viewer session telemetry for ${t}`),this._currentViewerSessionTelemetry=new Kp(this._logger,(new Date).getTime(),t,this._callId,this._participantId,this._endpointId,e),this._currentViewerSessionTelemetry.recordEvent("CallState",{state:this._callState}),this._isDataChannelActive()&&this._currentViewerSessionTelemetry.recordEvent("DataChannelAvailable"),this._currentViewerSessionTelemetry}_recordViewerSessionTelemetry(e,t=!0){this._currentViewerSessionTelemetry?e&&e(this._currentViewerSessionTelemetry):t&&this._logger.error("Cannot record telemetry without current session")}_finalizeViewerSessionTelemetry(e){if(!this._currentViewerSessionTelemetry)return;this._currentViewerSessionTelemetry.recordEvent(e);const t=this._currentViewerSessionTelemetry.getEvent();this._sendTelemetryEvent("mdsc_gtc_viewer_session",t),this._currentViewerSessionTelemetry.negotiationTag&&this._completedViewerSessions.push(this._currentViewerSessionTelemetry.negotiationTag),this._currentViewerSessionTelemetry.messagesFromUnknownSender&&Object.keys(this._currentViewerSessionTelemetry.messagesFromUnknownSender).length&&Gp.RootToolsManager.logExternalForDDL("ScreenSharingControl_viewer: messages received from unkonwn sender",JSON.stringify(t.ProtocolMessages)),this._currentViewerSessionTelemetry=null}_initiateSharerSessionTelemetry(e){if(this._currentSharerSessionTelemetry){if(this._currentSharerSessionTelemetry.negotiationTag===e)return null;this._finalizeSharerSessionTelemetry("ShutdownByOtherSession")}this._logger.info(`Initiating new sharer session telemetry for ${e}`),this._currentSharerSessionTelemetry=new Jp(this._logger,(new Date).getTime(),e,this._callId,this._participantId,this._endpointId),this._isDataChannelActive()&&this._currentSharerSessionTelemetry.recordEvent("DataChannelAvailable")}_recordSharerSessionTelemetry(e,t=!0){this._currentSharerSessionTelemetry?e&&e(this._currentSharerSessionTelemetry):t&&this._logger.error("Cannot record telemetry without current session")}_finalizeSharerSessionTelemetry(e){if(!this._currentSharerSessionTelemetry)return;this._currentSharerSessionTelemetry.recordEvent(e);const t=this._currentSharerSessionTelemetry.getEvent();this._sendTelemetryEvent("mdsc_gtc_sharer_session",t),this._currentSharerSessionTelemetry.messagesFromUnknownSender&&Object.keys(this._currentSharerSessionTelemetry.messagesFromUnknownSender).length&&Gp.RootToolsManager.logExternalForDDL("ScreenSharingControl_sharer: messages received from unkonwn sender",JSON.stringify(t.ProtocolMessages)),this._currentSharerSessionTelemetry=null}_sendTelemetryEvent(e,t){this._logger.info(`Sending event ${e}: `),Object.keys(t).forEach((e=>{this._logger.info(`     ${e} => ${t[e]}`)})),this._telemetryLoggers?.media?.sendEvent({eventName:e,props:t})}_recordProtocolMessage(e,t){this._currentViewerSessionTelemetry&&this._currentViewerSessionTelemetry.recordProtocolMessage(e,t),this._currentSharerSessionTelemetry&&this._currentSharerSessionTelemetry.recordProtocolMessage(e,t)}reportSharingSessionChangeForViewer(e,t){t&&this._initiateViewerSessionTelemetry(e,t,!1)}initControlForViewer(e,t){if(this._logger.info(`initControlForViewer(${ke(e?.id)}, ${t})`),!e)return void this._logger.warn("initControlForViewer: Sharer undefined, ignoring");if(this._isViewing()&&this._logger.warn("initControlForViewer: called when already viewing"),3!==this._callState)return this._logger.info(`initControlForViewer: postponed until call is connected, callState=${this._callState}`),this._pendingNegotiationTag=t,void(this._pendingSharer=e);const i=!this._sharerParticipant||this._sharerParticipant&&this._sharerParticipant.id!==e.id||t!==this._currentNegotiationTag;this._currentNegotiationTag=t,this._logger.info(`role is changing from=${this.role} to=2`),this.role=2,this._sharerParticipant?this._sharerParticipant.id!==e.id&&(this._recordViewerSessionTelemetry((e=>e.recordEvent("ShutdownByOtherSession",null,t))),this._logger.info(`initControlForViewer: sharer switched, new sharer id=${ke(e.id)}`),this._availableHandshakeSent=!1,4===this.controlState&&this._terminateControl(!1)):(this._logger.info(`initControlForViewer: setting sharer to id=${ke(e.id)}`),this._sharerParticipant=e,this._availableHandshakeSent=!1),this._initiateViewerSessionTelemetry(e,t,!0),i&&this._recordViewerSessionTelemetry((e=>e.recordEvent("SharingStarted"))),this._enabled&&this._isDataChannelActive()&&!this._availableHandshakeSent&&(this._resetControlState(),this._sharerParticipant=e,this._logger.info("initControlForViewer: sending Available message to sharer"),this._startAvailableHandshake())}shutdownControlForViewer(e){this._logger.info("shutdownControlForViewer()"),this._pendingSharer=null;let t=!1;if(e&&e.id!==this._sharerParticipant?.id||(this._logger.info(`shutdownControlForViewer: setting shouldShutdownControlForViewer to true, isViewing: ${this._isViewing()}`),t=!0),t&&this._isViewing()){if(1===this.controlState){if(this._sharerParticipant){const e=this._getSharerDataSourceId();this._sendRequest({action:2,terminatedReason:6},e)}else this._logger.warn("shutdownControlForViewer: sharer participant is null");const e={inControl:!1,id:qp,terminatedReason:6};this._requestControlPromise?this._requestControlPromise.reject(new Error(JSON.stringify({controlInfo:e,details:""}))):this._logger.error("shutdownControlForViewer: Unexpected, no promise could be resolved, controlState=RequestSent")}else if(4===this.controlState){const e={inControl:!1,id:qp,terminatedReason:6};this.event("sharingControlChanged").raise(e)}this._teardownViewerRemoteControl(),this._resetControlState(),this._screenSharingVideoRenderer=null,this._terminateAvailableHandshake&&this._terminateAvailableHandshake(2),this._availableHandshakeSent=!1,this._finalizeViewerSessionTelemetry("Shutdown"),2===this.role?(this._logger.info(`_raiseScreenSharingControlCapableEvent  with user role=${this.role}, MRI=, isCapable=false`),this._raiseScreenSharingControlCapableEvent(!1,qp)):this._logger.warn(`can't call _raiseScreenSharingControlCapableEvent, role=${this.role}`),this._logger.info(`role is changing from=${this.role} to=0`),this.role=0}}_resetControlRequest(e){this._clearControlRequest(),this._controlRequest=e,this._registerParticipantListener(e),3===e.participantState&&(this._logger.info(`participantState: Connected, raising: sharingIncomingControlRequest for participantId: ${e.participant.id}`),this.event("sharingIncomingControlRequest").raise(e.participant.id))}_clearControlRequest(){this._logger.info("_clearControlRequest()"),this._stopListeningToParticipantChanges(this._controlRequest),this._controlRequest=null}_stopListeningToParticipantChanges(e){this._controlRequestSubscription&&(this._logger.info(`_stopListeningToParticipantChanges: stopping tracking changes for ${e.participant.id}`),this._controlRequestSubscription.dispose(),this._controlRequestSubscription=null)}_registerParticipantListener(e){this._logger.info(`_registerParticipantListener: tracking changes for ${e.participant.id}`),this._logger.info(`request.participantState: ${e.participantState} | request.participant.state: ${e.participant.state}`),this._controlRequestSubscription=e.participant.changed((()=>{if(e.participant.state!==e.participantState)switch(this._logger.info(`request.participantState about to changed from: ${e.participantState} to: ${e.participant.state}`),e.participantState=e.participant.state,e.participantState){case 3:this.event("sharingIncomingControlRequest").raise(e.participant.id),this._logger.info(`participantState: Connected, raising: sharingIncomingControlRequest for participantId: ${e.participant.id}`);break;case 0:case 5:case 4:this.denyControlRequest().catch((e=>{this._logger.info(`It is ok if denyControlRequest rejects here as screensharing may have just been stopped. Err: ${e}`)})),this._logger.info(`_registerParticipantListener: participant ${e.participant.id} is no longer connected. resetting`),this._clearControlRequest(),this._raiseControlRequestCanceled(e);break;case 1:case 2:case 6:case 7:this._logger.info(`participantState: ${e.participantState}, participantId: ${e.participant.id}`);break;default:this._logger.error(`_registerParticipantListener: Unexpected participantState ${e.participantState} unhandled`)}}))}_resetControllerParticipant(e){this._controllerParticipantSubscription&&(this._logger.info(`_resetControllerParticipant: stopping tracking changes for ${this._controllerParticipant.participant.id}`),this._controllerParticipantSubscription.dispose(),this._controllerParticipantSubscription=null),e&&(this._logger.info(`_resetControllerParticipant: tracking changes for ${e.participant.id}`),this._controllerParticipantSubscription=e.participant.changed((()=>{3!==e.participant.state&&this.handleParticipantRemoved(e.participant.id)}))),this._controllerParticipant=e}handleParticipantRemoved(e){if(this._participantSubscriptions[e]&&(this._logger.info(`handleParticipantRemoved(): Stopping tracking state changes for ${e}`),this._participantSubscriptions[e].dispose(),delete this._participantSubscriptions[e]),this._isSharing()){if(this._controllerParticipant&&this._controllerParticipant.participant.id===e){this._logger.info("handleParticipantRemoved: controller left call, tearing down control session"),this._teardownSharerRemoteControl(),this.controlState=0,this._resetControllerParticipant();const t={inControl:!1,id:e,terminatedReason:5};this.event("sharingControlChanged").raise(t)}this._raiseScreenSharingControlCapableEvent(!1,e)}else if(this._sharerParticipant&&this._sharerParticipant.id===e&&4===this.controlState){this._logger.info("handleParticipantRemoved: sharer left call, tearing down control session"),this._teardownViewerRemoteControl(),this.controlState=0;const e={inControl:!1,id:qp,terminatedReason:6};this.event("sharingControlChanged").raise(e)}}callStateChanged(e){this._callState=e,this._recordViewerSessionTelemetry((t=>t.recordEvent("CallState",{state:e})),!1),this._recordSharerSessionTelemetry((t=>t.recordEvent("CallState",{state:e})),!1),this.isScreenSharingControlEnabled()&&this._handleCallState(e)}setIsEscalationInProgress(e){this.isEscalationInProgress=e}_getHandshakeDelay(){if(!this._config.handshakeSendDelay?.minParticipantThreshold)return 0;let e=0;if(this._call.participants.length>=this._config.handshakeSendDelay.minParticipantThreshold)for(const t of this._call.participants)t.endpoints?.endpointDetails.some((e=>"interactive"===e.appliedInteractivityLevel))&&e++;if(e<=this._config.handshakeSendDelay.minParticipantThreshold)return 0;const t=Math.ceil((e-this._config.handshakeSendDelay.minParticipantThreshold)/this._config.handshakeSendDelay.increaseEveryN);return Math.min(this._config.handshakeSendDelay.maxDelay,t*this._config.handshakeSendDelay.delayPerN)}_handleCallState(e){switch(e){case 3:this._handleCallConnected();break;case 7:this._handleCallDisconnected();break;case 4:case 5:this.shutdownControlForViewer()}}_handleCallConnected(){this._logger.info("_handleCallConnected()"),this._pendingSharer&&(this.initControlForViewer(this._pendingSharer,this._pendingNegotiationTag),this._pendingSharer=null)}_handleCallDisconnected(){this._logger.info("_handleCallDisconnected()"),this._isSharing()?this.shutdownControlForSharer():this.shutdownControlForViewer()}_videoSizeChanged(e,t){null!==this._controlCapturer&&this._controlCapturer.updateVideoSize(e,t)}_onRenderStarted(){const e={action:11,terminatedReason:0};if(this._sharerParticipant){const t=this._getSharerDataSourceId();this._sendRequest(e,t)}else this._logger.error("Attempted to send sharing rendered message to null sharerParticipant")}_setViewingRenderer(e,t){try{this._screenSharingVideoRenderer=e,this._screenSharingVideoRendererSubscriptions.push(this._rendererAdapter.subscribeVideoSizeChangedEvent(this._screenSharingVideoRenderer,((e,t)=>{this._videoSizeChanged(e,t)}))),this._screenSharingVideoRendererSubscriptions.push(this._rendererAdapter.subscribeRenderStartedEvent(this._screenSharingVideoRenderer,(()=>{this._onRenderStarted()})));let i=1;e.streamSize&&e.streamSize.width>0&&e.streamSize.height>0&&(i=e.streamSize.width/e.streamSize.height),this._controlCapturer=new $p.SlimCoreElectronControlCapturer(this._logger,t,!0,i),4===this.controlState?(this._logger.info("_setViewingRenderer: detected local state is controlling"),this._setupViewerRemoteControl()):this._teardownViewerRemoteControl()}catch(e){this._logger.error(`_setViewingRenderer: unable to set _screenSharingVideoRenderer error=${e}`)}}_onDataChannelStatusChanged(e){this._logger.info(`_onDataChannelStatusChanged(): Data channel status=${e}, isEscalationInProgress=${this.isEscalationInProgress}`),e?this._dataChannelAvailable||(this._dataChannelAvailable=!0,this._recordViewerSessionTelemetry((e=>e.recordEvent("DataChannelAvailable")),!1),this._recordSharerSessionTelemetry((e=>e.recordEvent("DataChannelAvailable")),!1),this._enabled&&(this._isViewing()?this._availableHandshakeSent||(this._sharerParticipant?(this._logger.info("_onDataChannelStatusChanged: sending Available message to sharer"),this._startAvailableHandshake()):this._logger.error("Unexpected null _sharerParticipant trying to send Available to sharer")):this._isSharing()&&(this.isEscalationInProgress||this._raiseScreenSharingControlCapableEvent(!0,qp)))):this._dataChannelAvailable&&(this._recordViewerSessionTelemetry((e=>e.recordEvent("DataChannelUnavailable")),!1),this._recordSharerSessionTelemetry((e=>e.recordEvent("DataChannelUnavailable")),!1),this._dataChannelAvailable=!1,this._availableHandshakeSent=!1,this._terminateAvailableHandshake&&this._terminateAvailableHandshake(3),this.isEscalationInProgress||this._raiseScreenSharingControlCapableEvent(!1,qp))}_isSharing(){return 1===this.role}_isViewing(){return 2===this.role}_handleAvailableRequest(e,t,i){let n=!1,r=0;if(this._enabled)if(this._availableAckEnabled)if(this._canEnableGiveControl())if(t?.id){if(this._allowControlForUser&&typeof this._allowControlForUser==typeof Function)return void this._allowControlForUser(t).then((s=>{s||(n=!0,r=1),this._sendResponseToAvailableRequest(e,t,i,n,r)}))}else n=!0,r=10;else this._logger.info("GiveControl is not enabled. no need to answer the available ack"),n=!0,r=9;else this._logger.info("Available ack is off. no need to answer the available ack"),n=!0,r=9;else this._logger.info("Feature flag is off. no need to answer the available ack"),n=!0,r=9;this._sendResponseToAvailableRequest(e,t,i,n,r)}_sendResponseToAvailableRequest(e,t,i,n,r){n?(this._logger.info(`Rejecting Available for handShake:${i}:${e.handshakeId}`),this.event("controlAvailableHandshake").raise(e.handshakeId,i,7,this._getAvailableHandshakeTerminatedFromControlTerminated(r)),this._sendRequest({action:10,terminatedReason:r,handshakeId:e.handshakeId},i)):(this._raiseScreenSharingControlCapableEvent(!0,t.id),this._participantSubscriptions[t.id]||(this._logger.info(`Tracking participant status for ${t.id}`),this._participantSubscriptions[t.id]=t.changed((()=>{3!==t.state&&(this._logger.info(`Participant ${t.id} is not connected. removing`),this.handleParticipantRemoved(t.id))}))),this._logger.info(`Acking Available for handShake:${i}:${e.handshakeId}`),this.event("controlAvailableHandshake").raise(e.handshakeId,i,3),this._sendRequest({action:9,terminatedReason:0,handshakeId:e.handshakeId},i))}processProtocolMessage(e,t,i,n){return Ti((()=>{this._processProtocolMessage(e,t,i,n)}))}_raiseControlRequestCanceled(e){this.event("sharingIncomingControlRequestCancelled").raise(e.participant.id)}_handleControlRequest(e,t,i){this._recordSharerSessionTelemetry((e=>{e.recordOperation("ControlRequest",null,String(t))})),this._enabled?this._controlRequest?(this._logger.warn("Sharer is already processing a control request...rejecting new requests"),this._sendControlRejectRequest(3,t)):this._controllerParticipant&&this._controllerParticipant.participant===e?this._controllerParticipant.participantId&&this._controllerParticipant.participantId!==i?(this._logger.warn(`rejecting control request from second endpoint. participantId: ${i}`),this._sendControlRejectRequest(3,t)):(this._logger.warn("Got control request for someone already in control"),this._resetControllerParticipant(),this._resetControlRequest({participant:e,participantState:e.state,participantId:i})):e?(this._logger.info(`resetControlRequest for participantId: ${i}`),this._resetControlRequest({participant:e,participantState:e.state,participantId:i})):this._logger.error("Got ControlRequest message but could not find a sender participant, ignoring"):(this._logger.warn("Sharer control is disabled - rejecting request"),this._sendControlRejectRequest(9,t))}_handleAcceptRequest(e,t){if(1===this.controlState){const i=this._sendRequest({action:5,terminatedReason:0},t);this._logger.info(`_handleAcceptRequest controlMessage.action: ${Qp(e.action)} _sendRequest isSent: ${i}`),i?(this._setupViewerRemoteControl(),this.controlState=4,this._requestControlPromise?this._requestControlPromise.resolve():this._logger.error(`Unexpected, no promise could be resolved - controlState=RequestSent action=${Qp(e.action)}`),this._recordViewerSessionTelemetry((e=>{e.recordOperationSuccess("ControlRequest",null)}))):this._requestControlPromise?this._requestControlPromise.reject(new Error(JSON.stringify({controlInfo:void 0,details:"request control is accepted, but failed to send ack"}))):this._logger.error(`Unexpected, no promise could be resolved - controlState=${Xp(this.controlState)} action=${Qp(e.action)}`),this._cancelRequestControlTimer()}else this._logger.warn(`AcceptRequest message received in controlState=${Xp(this.controlState)}`)}_handleRejectRequest(e){if(1===this.controlState){this._logger.info(`_handleRejectRequest: controlState: ${Xp(this.controlState)}, about to be changed to: ${Xp(0)}`),this.controlState=0;const t={inControl:!1,id:qp,terminatedReason:e.terminatedReason};this._requestControlPromise?this._requestControlPromise.reject(new Error(JSON.stringify({controlInfo:t,details:""}))):this._logger.error(`Unexpected, no promise could be resolved - controlState=RequestSent action=${Qp(e.action)}`),this._recordViewerSessionTelemetry((t=>{t.recordOperationFailure("ControlRequest",{reason:Zp(e.terminatedReason)})})),this._cancelRequestControlTimer()}else this._logger.warn(`RejectRequest message received in controlState=${Xp(this.controlState)} reason=${e.terminatedReason}`)}_handleCancelControlRequest(e,t){if(this._logger.info(`_handleCancelControlRequest action=${Qp(e.action)} sender=${t}, controlRequest participantId: ${this._controlRequest.participantId}, controlRequest participantState: ${this._controlRequest.participantState}:`),this._controlRequest){const i=this._controlRequest;this._logger.info(`_handleCancelControlRequest action=${Qp(e.action)} sender=${t}, about to raise: _raiseControlRequestCanceled state: ${this._controlRequest.participantState} `),this._recordSharerSessionTelemetry((e=>{e.recordOperationTimeout("ControlRequest",{participantId:t},String(t))})),this._clearControlRequest(),this._raiseControlRequestCanceled(i)}}_handleGiveControl(e,t,i){const n=this._sendRequest({action:5,terminatedReason:0},t);if(this._logger.info(`_handleGiveControl: controlMessage.action: ${Qp(e.action)} _sendRequest isSent: ${n}`),n){this._setupViewerRemoteControl(),this._logger.info(`controlState: ${Xp(this.controlState)}, about to be changed to: ${Xp(4)}`),this.controlState=4,this._recordViewerSessionTelemetry((e=>{e.recordEvent("ControlGiven",{sender:t})}));const i={inControl:!0,id:qp,terminatedReason:e.terminatedReason};this.event("sharingControlChanged").raise(i)}}_handleAck(e,t,i){if(2===this.controlState)if(this._controllerParticipant&&this._controllerParticipant.participant===t){const t=this._getDataSourceIdForParticipantLeg(this._controllerParticipant);i!==t&&this._logger.warn(`acknowledging source id: ${i} does not match requesting source id: ${t}`),this._logger.info(`Setting up remote control for controller source id=${t}`),this._setupSharerRemoteControl(t),this._logger.info(`controlState: ${Xp(this.controlState)}, about to be changed to: ${Xp(3)}`),this.controlState=3;const n={inControl:!0,id:this._controllerParticipant.participant.id,terminatedReason:e.terminatedReason};this.event("sharingControlChanged").raise(n),this._grantControlPromise?(this._grantControlPromise.resolve(),this._cancelGrantControlTimer(),this._recordSharerSessionTelemetry((e=>{e.recordOperationSuccess("GiveControl",{participantId:t})}))):this._acceptControlPromise?(this._acceptControlPromise.resolve(),this._cancelAcceptControlTimer(),this._recordSharerSessionTelemetry((e=>{e.recordOperationSuccess("ControlRequest",{participantId:t},String(t))}))):this._logger.error(`Unexpected, no promise could be resolved - controlState=WaitingForControlAck action=${Qp(e.action)}`)}else t?this._logger.warn(`Ignoring ack from participant that does not match controller id=${ke(t.id)}`):this._logger.warn(`Ignoring ack from null participant source id=${i}`);else 5===this.controlState?(this._logger.info(`controlState: ${Xp(this.controlState)}, about to be changed to: ${Xp(0)}`),this.controlState=0,this._resetControllerParticipant(),this._terminateControlPromise?(this._terminateControlPromise.resolve(),this._cancelTerminateControlTimer()):this._logger.error(`Unexpected, no promise could be resolved - controlState=WaitingForTerminateAck action=${Qp(e.action)}`)):this._logger.warn(`Unexpected ack in control controlState=${Xp(this.controlState)}`)}_handleTerminate(e,t,i){let n;this._isViewing()?(this._teardownViewerRemoteControl(),n=qp):(this._teardownSharerRemoteControl(),t?n=t.id:this._logger.error("Got terminate message but could not find a sender participant!")),this._logger.info(`controlMessage action: ${Qp(e.action)}, controllerId: ${n}`),this._logger.info(`controlState: ${Xp(this.controlState)}, about to be changed to: ${Xp(0)}`),this.controlState=0,this._resetControllerParticipant();const r={inControl:!1,id:n,terminatedReason:e.terminatedReason};this.event("sharingControlChanged").raise(r),8===e.action&&this._sendRequest({action:5,terminatedReason:0},i)}_handleAvailableAck(e){this._terminateAvailableHandshake&&(this._logger.info(`_handleAvailableAck: terminate available handshake reason: 1,handshakeId: ${e.handshakeId}`),this._terminateAvailableHandshake(1,e.handshakeId)),2===this.role?this._raiseScreenSharingControlCapableEvent(!0,qp):this._logger.info(`Ignoring AvailableAck as viewer session is not initialized, role: ${this.role}`)}_handleAvailableNack(e){this._logger.info(`_handleAvailableNack: action=${Qp(e.action)} terminate reason: ${Zp(e.terminatedReason)}`),this._viewerSessionLastTerminatedReason=e.terminatedReason,this._recordViewerSessionTelemetry((t=>{t.updateOperationData("AvailableHandshake",{nackReason:e.terminatedReason},e.handshakeId)})),10!==e.terminatedReason?(this._terminateAvailableHandshake&&(this._terminateAvailableHandshake(this._getAvailableHandshakeTerminatedFromControlTerminated(e.terminatedReason),e.handshakeId),this._logger.info(`_handleAvailableNack: terminateAvailableHandshake reason=${Zp(e.terminatedReason)}`)),1===e.terminatedReason?(this._logger.warn("_handleAvailableNack: control terminate reason: SharerDenied"),this._raiseScreenSharingControlCapableEvent(!0,qp,!0)):this._raiseScreenSharingControlCapableEvent(!1,qp)):this._logger.warn("_handleAvailableNack: control terminate reason: UnknownSender")}_handleRenderedAtViewer(e,t){this._raiseRenderedAtViewer&&(t?(this._logger.info(`raiseRenderedAtViewer senderId=${t.id}, action=${Qp(e.action)}`),this._raiseRenderedAtViewer(t.id)):this._logger.error("Got RenderedAtViewer message but could not find a sender participant!"))}_processProtocolMessage(e,t,i,n){let r;this._recordProtocolMessage(t,n);try{r=JSON.parse(e)}catch(e){return void this._logger.error("Error parsing controlMessage")}switch(t||this._logger.warn(`protocol message from unknown sender with sourceId=${n}`),this._logger.info(`_processProtocolMessage action=${Qp(r.action)}, sourceId=${n}`),r.action){case 0:this._handleAvailableRequest(r,t,n);break;case 1:this._handleControlRequest(t,n,i);break;case 3:this._handleAcceptRequest(r,n);break;case 4:this._handleRejectRequest(r);break;case 2:this._handleCancelControlRequest(r,n);break;case 6:this._handleGiveControl(r,n,t);break;case 5:this._handleAck(r,t,n);break;case 8:case 7:this._handleTerminate(r,t,n);break;case 9:this._handleAvailableAck(r);break;case 10:this._handleAvailableNack(r);break;case 11:this._handleRenderedAtViewer(r,t);break;default:this._logger.error(`Unknown request action received on control protocol data sink, action=${Qp(r.action)}`)}}_getAvailableHandshakeTerminatedFromControlTerminated(e){switch(e){case 10:return 6;case 1:return 7;default:return 0}}_sendRequest(e,t){if(t<0)return this._logger.warn(`Unexpected: invalid sourceID=${t}`),!1;this._logger.info(`_sendRequest() action=${Qp(e.action)} recipient sourceid=${t}`);const i={type:0,message:JSON.stringify(e)},n=[t];return this._dataChannelAdapter.sendProtocolMessage(function(e){const t=new ArrayBuffer(e.length),i=new Uint8Array(t);for(let t=0;t<e.length;t++)i[t]=e.charCodeAt(t);return i}(JSON.stringify(i)),n),!0}async processControlMessage(e,t){if(t===this._controllerSourceId){if(3===this.controlState)return this._processControlMessage(e,t);this._logger.debug(`Ignoring control message, wrong controlState. Expected: RemoteControlling, got: ${Xp(this.controlState)}`)}else this._logger.debug(`Ignoring control message, wrong sourceId. Expected: ${t}, got: ${this._controllerSourceId}`)}_processControlMessage(e,t){return this._controlInjector.injectRawInput(e,t)}_resetControlState(){this._logger.info("_resetControlState()"),this.controlState=0,this._resetControllerParticipant(),this._sharerParticipant=null,this._clearControlRequest(),this._cancelRequestControlTimer(),this._cancelAcceptControlTimer(),this._cancelGrantControlTimer(),this._cancelTerminateControlTimer()}_setupSharerRemoteControl(e){this._logger.info(`_setupSharerRemoteControl() sourceId=${e}`),this._controllerSourceId=e,this._controlInjector.showVirtualCursor(e).catch((t=>{const i={reason:3,detail:JSON.stringify({sourceId:e,errorMsg:t})};this.event("sharingControlError").raise(i)}))}_teardownSharerRemoteControl(){this._logger.info("_teardownSharerRemoteControl()"),this._controllerSourceId=null,this._controlInjector.showVirtualCursor(0).catch((e=>{const t={reason:3,detail:JSON.stringify({sourceId:0,errorMsg:e})};this.event("sharingControlError").raise(t)}))}_setupViewerRemoteControl(){this._logger.info("_setupViewerRemoteControl()"),this._setCapturerMode(3)}_teardownViewerRemoteControl(){this._logger.info("_teardownViewerRemoteControl()"),this._setCapturerMode(0)}_clearCapturerEventSubscriptions(){this._logger.info("_clearCapturerEventSubscriptions()"),this._captureEventSubscription&&(this._captureEventSubscription.dispose(),this._captureEventSubscription=null),this._mouseControlEventSubscription&&(this._mouseControlEventSubscription.dispose(),this._mouseControlEventSubscription=null),this._keyboardControlEventSubscription&&(this._keyboardControlEventSubscription.dispose(),this._keyboardControlEventSubscription=null)}sendRemoteControlEvent(e,t){if(t)switch(e){case"mouseControlEvent":this._sendControlEvent(Pp.encodeMouseEvent(t));break;case"keyboardControlEvent":this._sendControlEvent(Pp.encodeKeyboardEvent(t));break;default:return void this._logger.error("sendRemoteControlEvent: Invalid type=",e)}else this._logger.error("sendRemoteControlEvent: Invalid argument.")}_sendControlEvent(e){if(!this._isDataChannelActive()||!this._sharerParticipant||4!==this.controlState)return void this._logger.error(`_sendControlEvent: Dropping message - No data channel or wrong controlState. dataConnected: ${this._isDataChannelActive()} controlState: ${Xp(this.controlState)})`);const t=[this._getSharerDataSourceId()];this._dataChannelAdapter.sendControlMessage(e,t)}_setCapturerMode(e){this._logger.info(`_setCapturerMode() capturerMode=${e}`),this._controlCapturer?(this._controlCapturer.setCaptureMode(e),this._clearCapturerEventSubscriptions(),1===e?this._captureEventSubscription=this._controlCapturer.on("ctrlCaptureEvent",(e=>{0===e&&this.event("sharingRendererClicked").raise()})):2===e?this._captureEventSubscription=this._controlCapturer.on("ctrlCaptureEvent",(e=>{1===e?this.event("sharingRendererMouseEntering").raise():2===e&&this.event("sharingRendererMouseLeaving").raise()})):3===e&&(this._mouseControlEventSubscription=this._controlCapturer.on("mouseControlEvent",(e=>{this._sendControlEvent(Pp.encodeMouseEvent(e))})),this._keyboardControlEventSubscription=this._controlCapturer.on("keyboardControlEvent",(e=>{this._sendControlEvent(Pp.encodeKeyboardEvent(e))})),this._captureEventSubscription=this._controlCapturer.on("ctrlCaptureEvent",(e=>{1===e?this.event("sharingRendererMouseEntering").raise():2===e&&this.event("sharingRendererMouseLeaving").raise()})))):this._logger.info("_controlCapturer not set, relying on external controlCapturer")}setPointerImage(e,t){return this._logger.warn("setPointerImage is deprecated. Use setLocalPointerImage or setRemotePointerImage"),e?this.setRemotePointerImage(e,t):this.setLocalPointerImage(t)}setLocalPointerImage(e){return 0===e.length?Promise.reject(new Error("setLocalPointerImage invalid image length")):this._setPointerImage(0,e)}async setRemotePointerImage(e,t){if(!e)throw new Error("setRemotePointerImage participant is null");if(0===t.length)throw new Error("setRemotePointerImage invalid image length");const i=this._getParticipantsDataSourceIds(e);if(0===i.length)throw new Error("setRemotePointerImage unable to map participant to sourceIds");this._logger.info(`set pointer image for ${i.length} sources`);for(const e of i)await this._setPointerImage(e,t)}_setPointerImage(e,t){return this._isSharing()||this._logger.warn("_setPointerImage called when not sharing"),this._controlInjector.setPointerImage(e,t)}startPointerMode(){return this._enabled?this._isDataChannelActive()?0!==this.controlState?Promise.reject(new Error(`startPointerMode called in bad control controlState=${Xp(this.controlState)}`)):this._isViewing()?Ti((()=>{this._setCapturerMode(2)})):Promise.reject(new Error("startPointerMode when not viewing")):Promise.reject(new Error("startPointerMode when data channel not active")):Promise.reject(new Error("startPointerMode when feature not enabled"))}stopPointerMode(){return 0!==this.controlState?Promise.reject(new Error(`stopPointerMode called in bad control controlState=${Xp(this.controlState)}`)):this._isViewing()?Ti((()=>{this._setCapturerMode(1)})):Promise.reject(new Error("stopPointerMode when not viewing"))}_startAvailableHandshake(){const e=this._getSharerDataSourceId(),t=Hi(),i=this._getHandshakeDelay(),n=Math.floor(Math.random()*i);if(this._logger.info(`_startAvailableHandshake() - handshakeId: ${e}:${t} ${n>0?`delay: ${n}ms maxDelay: ${i}ms`:""}}`),this._terminateAvailableHandshake&&(this._logger.warn("Replacing existing availble handshake"),this._terminateAvailableHandshake(4)),this._recordViewerSessionTelemetry((e=>e.recordOperation("AvailableHandshake",t))),e<0)this._logger.warn(`_startAvailableHandshake() - sharer: ${ke(this._sharerParticipant?.id)} has no data channel, retrying later`),this._waitForAvailableAck(t);else{const r=()=>{this.event("controlAvailableHandshake").raise(t,e,1),this._sendRequest({action:0,terminatedReason:0,handshakeId:t},e)||this._logger.error("Failed to send Available message to sharer, will retry after backoff"),this._waitForAvailableAck(t)};n>0?(this._delayedSendHandshakeTimer=window.setTimeout(r,n),this._recordViewerSessionTelemetry((e=>{e.updateOperationData("AvailableHandshake",{delay:n,maxDelay:i},t)}))):r()}this._availableHandshakeSent=!0,this._terminateAvailableHandshake=(i=0,n)=>{this._logger.info(`_terminateAvailableHandshake() - handshakeId: ${e}:${t}, status: ${i}`),this._recordViewerSessionTelemetry((e=>{e.updateOperationData("AvailableHandshake",{tries:this._retryAttempt},n)})),1===i?this._recordViewerSessionTelemetry((e=>{e.recordOperationSuccess("AvailableHandshake",null,"",n)})):(this._logger.error(`GTC handshake terminated with code ${i}, last terminated reason: ${Zp(this._viewerSessionLastTerminatedReason)}`),Gp.RootToolsManager.logExternalForDDL(`GTC handshake terminated with code ${i},`,this._viewerSessionLastTerminatedReason.toString()),this._recordViewerSessionTelemetry((e=>{e.recordOperationFailure("AvailableHandshake",{reason:i},"",n)}))),this._terminateAvailableHandshake=null,this.event("controlAvailableHandshake").raise(t,e,1===i?5:6,i),n&&n!==t&&this._logger.warn(`AvailableSeries: Got handshake from another series - expected: ${t}, received: ${n}`),this._availableAckTimer&&(clearTimeout(this._availableAckTimer),this._availableAckTimer=null),this._delayedSendHandshakeTimer&&(clearTimeout(this._delayedSendHandshakeTimer),this._delayedSendHandshakeTimer=null),this._retryAttempt=0}}_waitForAvailableAck(e){this._logger.info("_waitForAvailableAck()"),this._availableAckTimer=window.setTimeout((()=>{this._logger.warn(`No Ack received for Available message from attempt=${this._retryAttempt}`),this._availableAckTimer=null;const t=this._getSharerDataSourceId();if(this._retryAttempt<=6)t>=0?(this._logger.info(`Re-sending Available message handshakeId: ${t}:${e}`),this.event("controlAvailableHandshake").raise(e,t,2),this._sendRequest({action:0,terminatedReason:0,handshakeId:e},t)):this._logger.warn(`_waitForAvailableAck() - sharer: ${ke(this._sharerParticipant?.id)} has no data channel, retrying later`),this._waitForAvailableAck(e);else if(this._logger.error("Reached Available retry limit! Control capability will be false"),this._terminateAvailableHandshake)this._terminateAvailableHandshake(5);else{const e={reason:4,detail:JSON.stringify({sourceId:t,errorMsg:`Timed out after ${this._retryAttempt} tries`})};this.event("sharingControlError").raise(e)}}),2e3*++this._retryAttempt)}requestControl(){return this._enabled?this._isDataChannelActive()?0!==this.controlState?Promise.reject(new Error(`requestControl called in bad controlState=${Xp(this.controlState)}`)):this._isViewing()?this._sharerParticipant?this._requestControlPromise?Promise.reject(new Error("request control promise has not been resolved yet while requesting control")):this._terminateControlPromise?Promise.reject(new Error("terminate control promise has not been resolved yet while requesting control")):this._requestControl():Promise.reject(new Error("requestControl unexpected null sharer")):Promise.reject(new Error("requestControl when not viewing")):Promise.reject(new Error("requestControl when data channel not active")):Promise.reject(new Error("requestControl when feature not enabled"))}_requestControl(){this._logger.info(`_requestControl(), controlState: ${this.controlState}`),this._requestControlPromise=Ei();const e=()=>{this._requestControlPromise=null};this._requestControlPromise.promise.then(e,e);const t=this._getSharerDataSourceId();if(!this._sendRequest({action:1,terminatedReason:0},t)){const e={inControl:!1,id:qp,terminatedReason:7};return this._requestControlPromise.reject(new Error),this._logger.error("_requestControl(): failed to send the request."),Promise.reject(new Error(JSON.stringify({controlInfo:e,details:""})))}return this._recordViewerSessionTelemetry((e=>e.recordOperation("ControlRequest",""))),this.controlState=1,this._requestControlTimer=window.setTimeout((()=>{if(1===this.controlState){this.controlState=0,this._logger.warn("No response to control request - canceling"),this._sendRequest({action:2,terminatedReason:2},t)||this._logger.error("Failed to send the cancel control request");const e={inControl:!1,id:qp,terminatedReason:2};this._recordViewerSessionTelemetry((e=>{e.recordOperationTimeout("ControlRequest",null)})),this._requestControlPromise?this._requestControlPromise.reject(new Error(JSON.stringify({controlInfo:e,details:"we did not get any response to the control - terminating control"}))):this._logger.error("Unexpected, no promise could be resolved - controlState=RequestSent")}else this._requestControlPromise?this._requestControlPromise.reject(new Error(JSON.stringify({controlInfo:void 0,details:"request control - times out in bad state - do nothing"}))):this._logger.error(`Unexpected, no promise could be resolved - controlState=${Xp(this.controlState)}`);this._requestControlTimer=null}),3e4),this._requestControlPromise.promise}_cancelRequestControlTimer(){this._requestControlTimer&&(this._requestControlPromise&&this._requestControlPromise.reject(new Error("cancelled by _cancelRequestControlTimer")),clearTimeout(this._requestControlTimer),this._requestControlTimer=null)}cancelControl(){return this._enabled?this._isDataChannelActive()?1!==this.controlState?Promise.reject(new Error(`cancelControl called in bad state=${Xp(this.controlState)}`)):this._isViewing()?this._sharerParticipant?this._requestControlPromise?this._terminateControlPromise?Promise.reject(new Error("Terminate control promise has not been resolved yet while cancelling control")):this._cancelControl():Promise.reject(new Error("Request control promise has been resolved while cancelling control")):Promise.reject(new Error("cancelControl unexpected null sharer")):Promise.reject(new Error("cancelControl when not viewing")):Promise.reject(new Error("cancelControl when data channel not active")):Promise.reject(new Error("cancelControl when feature not enabled"))}_cancelControl(){this._logger.info("_cancelControl()");const e=this._getSharerDataSourceId();if(1!==this.controlState)return Promise.reject(new Error("Cancel control - in bad state - do nothing"));if(this._cancelRequestControlTimer(),this.controlState=0,this._logger.info("Viewer cancels the control"),!this._sendRequest({action:2,terminatedReason:8},e))return Promise.reject(new Error("Failed to send cancel control request"));{const e={inControl:!1,id:qp,terminatedReason:8};this._recordViewerSessionTelemetry((t=>{t.recordOperationFailure("ControlRequest",{reason:Zp(e.terminatedReason)})})),this._requestControlPromise.reject(new Error(JSON.stringify({controlInfo:e,details:""})))}return new Promise(((e,t)=>{e()}))}acceptControlRequest(){return this._enabled?this._isDataChannelActive()?this._controlRequest?this._isSharing()?this._acceptControlPromise?Promise.reject(new Error("Accept control promise has not been resolved yet while accepting control")):this._grantControlPromise?Promise.reject(new Error("Grant control promise has not been resolved yet while accepting control")):this._terminateControlPromise?Promise.reject(new Error("Terminate control promise has not been resolved yet while accepting control")):this._acceptControlRequest():Promise.reject(new Error("acceptControlRequest when not sharing")):Promise.reject(new Error("acceptControlRequest while no control request pending")):Promise.reject(new Error("acceptControlRequest when data channel not active")):Promise.reject(new Error("acceptControlRequest when feature not enabled"))}_acceptControlRequest(){this._logger.info("_acceptControlRequest()"),this._acceptControlPromise=Ei();const e=()=>{this._acceptControlPromise=null};if(this._acceptControlPromise.promise.then(e,e),this._controllerParticipant){this._logger.warn("_acceptControlRequest called while another participant already has control - terminating control"),this._teardownSharerRemoteControl();const e=this._getDataSourceIdForParticipantLeg(this._controllerParticipant);this._sendRequest({action:7,terminatedReason:5},e)||this._logger.error("Failed to send the terminateNoAck request"),this._resetControllerParticipant()}const t=this._getDataSourceIdForParticipantLeg(this._controlRequest),i=this._controlRequest.participant.id;return this._sendControlAcceptRequest(t)?(this._resetControllerParticipant(this._controlRequest),this._clearControlRequest(),this.controlState=2,this._acceptControlTimer=window.setTimeout((()=>{if(2===this.controlState){this.controlState=0,this._resetControllerParticipant(),this._recordSharerSessionTelemetry((e=>{e.recordOperationTimeout("ControlRequest",{participantId:t},String(t))})),this._logger.error("No ack received when accepting control request - terminating control"),this._sendRequest({action:7,terminatedReason:4},t)||this._logger.error("Failed to send the TerminateNoAck request");const e={inControl:!1,id:i,terminatedReason:4};this.event("sharingControlChanged").raise(e),this._acceptControlPromise?this._acceptControlPromise.reject(new Error("No ack received when accept control - terminating control")):this._logger.error("Unexpected, no promise could be resolved - controlState=WaitingForControlAck")}else this._acceptControlPromise?this._acceptControlPromise.reject(new Error("accept control - times out in bad state - do nothing")):this._logger.error(`Unexpected, no promise could be resolved - controlState=${Xp(this.controlState)}`);this._acceptControlTimer=null}),Wp),this._acceptControlPromise.promise):(this._logger.error("Failed to send the accept control request"),this._acceptControlPromise.reject(new Error),Promise.reject(new Error("Failed to send the accept control request!")))}_sendControlAcceptRequest(e){const t=this._sendRequest({action:3,terminatedReason:0},e);return this._recordSharerSessionTelemetry((t=>{t.updateOperationData("ControlRequest",{status:"accepting",participantId:e},null,String(e))})),t}_sendControlRejectRequest(e,t){const i=this._sendRequest({action:4,terminatedReason:e},t);return this._recordSharerSessionTelemetry((i=>{i.recordOperationFailure("ControlRequest",{participantId:t,reason:Zp(e)},String(t))})),i}_cancelAcceptControlTimer(){this._acceptControlTimer&&(this._acceptControlPromise&&this._acceptControlPromise.reject(new Error("cancelled by _cancelAcceptControlTimer")),clearTimeout(this._acceptControlTimer),this._acceptControlTimer=null)}denyControlRequest(){return this._enabled?this._isDataChannelActive()?this._controlRequest?this._isSharing()?this._acceptControlPromise?Promise.reject(new Error("Accept control promise has not been resolved yet while denying control")):this._grantControlPromise?Promise.reject(new Error("Grant control promise has not been resolved yet while denying control")):this._terminateControlPromise?Promise.reject(new Error("Terminate control promise has not been resolved yet while denying control")):this._denyControlRequest():Promise.reject(new Error("denyControlRequest when not sharing")):Promise.reject(new Error("denyControlRequest while no control request pending")):Promise.reject(new Error("denyControlRequest when data channel not active")):Promise.reject(new Error("denyControlRequest when feature not enabled"))}_denyControlRequest(){this._logger.info("_denyControlRequest()");const e=this._getDataSourceIdForParticipantLeg(this._controlRequest);return this._clearControlRequest(),this._sendControlRejectRequest(1,e)?Promise.resolve():Promise.reject(new Error("Failed to send the deny control requst"))}grantControl(e){return this._enabled?this._isDataChannelActive()?this._controlRequest?Promise.reject(new Error("grantControl called while control request pending")):this._isSharing()?e?this._acceptControlPromise?Promise.reject(new Error("Accept control promise has not been resolved yet while granting control")):this._grantControlPromise?Promise.reject(new Error("Grant control promise has not been resolved yet while granting control")):this._terminateControlPromise?Promise.reject(new Error("Terminate control promise has not been resolved yet while granting control")):this._grantControl(e):Promise.reject(new Error("grantControl null participant")):Promise.reject(new Error("grantControl when not sharing")):Promise.reject(new Error("grantControl when data channel not active")):Promise.reject(new Error("grantControl when feature not enabled"))}_grantControl(e){this._logger.info("_grantControl()"),this._grantControlPromise=Ei();const t=()=>{this._grantControlPromise=null};if(this._grantControlPromise.promise.then(t,t),3===this.controlState){if(this._controllerParticipant.participant===e)return this._logger.warn("_grantControl called for participant who already has control"),this._grantControlPromise.resolve(),new Promise(((e,t)=>{e()}));{this._logger.warn("_grantControl called while another participant already has control - terminating control"),this._teardownSharerRemoteControl();const e=this._getDataSourceIdForParticipantLeg(this._controllerParticipant);this._sendRequest({action:7,terminatedReason:5},e)||this._logger.error("Failed to send the terminateNoAck request")}}const i=this._mapParticipantToSourceId(e),n=this._sendRequest({action:6,terminatedReason:0},i);if(this._recordSharerSessionTelemetry((e=>{e.recordOperation("GiveControl",null)})),!n)return this._logger.error("Failed to send the grant control request"),this._grantControlPromise.reject(new Error),Promise.reject(new Error("Failed to send the grant control request!"));const r=this._getParticipantIdForDataSourceId(e,i);return this._resetControllerParticipant({participant:e,participantState:e.state,participantId:r}),this.controlState=2,this._grantControlTimer=window.setTimeout((()=>{2===this.controlState?(this.controlState=0,this._resetControllerParticipant(),this._logger.error("No ack received when granting control - terminating control"),this._sendRequest({action:7,terminatedReason:4},i)||this._logger.error("Failed to send the terminateNoAck request"),this._recordSharerSessionTelemetry((e=>{e.recordOperationTimeout("GiveControl",null)})),this._grantControlPromise?this._grantControlPromise.reject(new Error("No ack received when granting control - terminating control")):this._logger.error("Unexpected, no promise could be resolved - controlState=WaitingForControlAck")):this._grantControlPromise?this._grantControlPromise.reject(new Error("Grant control - times out in bad state - do nothing")):this._logger.error(`Unexpected, no promise could be resolved - controlState=${Xp(this.controlState)}`),this._grantControlTimer=null}),Wp),this._grantControlPromise.promise}_cancelGrantControlTimer(){this._grantControlTimer&&(this._grantControlPromise&&this._grantControlPromise.reject(new Error("cancelled by _cancelGrantControlTimer")),clearTimeout(this._grantControlTimer),this._grantControlTimer=null)}_mapParticipantToSourceId(e){return this._dataChannelAdapter.isActive()?Pc(e,3):(this._logger.error("Null data channel cannot map participant to source id"),-1)}_getParticipantsDataSourceIds(e){const t=[];try{if(e?.endpoints?.endpointDetails){if(1===e.endpoints.endpointDetails.length){const i=e.endpoints.endpointDetails[0];if(!i?.mediaStreams)return t.push(Pn),t}for(const i of e.endpoints.endpointDetails)if(i?.mediaStreams)for(const e of i.mediaStreams)if(3===Tc(e.type)){if(t.push(e.sourceId),t.length>=8)return this._logger.error("Excessive amount of data streams"),t;break}}}catch(e){this._logger.error(`_getParticipantsDataSourceIds caught exception error=${e}`)}return t}_getParticipantIdForDataSourceId(e,t){return Ic(e,3,t)}_getDataSourceIdForParticipantId(e,t){return this._dataChannelAdapter.isActive()?function(e,t,i){if(!e||!e.endpoints)return-1;const n=e.endpoints.endpointDetails.find((e=>e?.participantId===t));if(!n)return Pc(e,i);if(!n.mediaStreams)return Pc(e,i);const r=n.mediaStreams.find((({type:e})=>Tc(e)===i));return r?r.sourceId:-1}(e,t,3):(this._logger.error("Null data channel cannot map participant to source id"),-1)}_getDataSourceIdForParticipantLeg(e){return this._getDataSourceIdForParticipantId(e.participant,e.participantId)}_getSharerDataSourceId(){const e=Rc(this._sharerParticipant);return e?this._getDataSourceIdForParticipantId(this._sharerParticipant,e):(this._logger.warn("Unable to identify the sharer participantId, falling back to first data channel"),this._mapParticipantToSourceId(this._sharerParticipant))}terminateControl(){if(this._isViewing()){if(4!==this.controlState)return Promise.reject(new Error("terminateControl called while not in control"));if(!this._sharerParticipant)return Promise.reject(new Error("terminateControl called but _sharerParticipant is null"))}else{if(!this._isSharing())return Promise.reject(new Error("terminateControl called but not sharing nor viewing"));if(!this._controllerParticipant)return Promise.reject(new Error("terminateControl called but controllerParticipant is null"))}return this._requestControlPromise?Promise.reject(new Error("Request control promise has not been resolved yet while terminating control")):this._acceptControlPromise?Promise.reject(new Error("Accept control promise has not been resolved yet while terminating control")):this._grantControlPromise?Promise.reject(new Error("Grant control promise has not been resolved yet while terminating control")):this._terminateControlPromise?Promise.reject(new Error("Terminate control promise has not been resolved yet while terminating control")):this._terminateControl()}_terminateControl(e=!0){this._logger.info("_terminateControl()"),this._terminateControlPromise=Ei();const t=()=>{this._terminateControlPromise=null};this._terminateControlPromise.promise.then(t,t);let i=0;const n=e?8:7;let r,s;if(this._isViewing()){if(4!==this.controlState)return this._logger.error("Local viewer called terminateControl when not controlling"),this._terminateControlPromise.reject(new Error),Promise.reject(new Error("Local viewer called terminateControl when not controlling"));this._teardownViewerRemoteControl(),i=6,r=this._getSharerDataSourceId(),s=qp,this._logger.info(`Terminating remote control reason: ${i},  recipient: ${r}, controllerId: ${s}`)}else{if(3!==this.controlState||!this._controllerParticipant)return this._logger.error("Local sharer called terminateControl when no one is in control"),this._terminateControlPromise.reject(new Error),Promise.reject(new Error("Local sharer called terminateControl when no one is in control"));this._teardownSharerRemoteControl(),i=5,r=this._getDataSourceIdForParticipantLeg(this._controllerParticipant),s=this._controllerParticipant.participant.id,this._logger.info(`Terminating control on the sharer side, reason: ${i}, recipient: ${r}, controllerId: ${s}`)}if(!this._sendRequest({action:n,terminatedReason:i},r)){if(e)return this._logger.error("Failed to send the terminate control request"),this._terminateControlPromise.reject(new Error),Promise.reject(new Error("Failed to send the grant control request!"));this._logger.error("Failed to send the terminateNoAck request")}this.controlState=e?5:0;const a={inControl:!1,id:s,terminatedReason:i};return this._logger.info(`raising event sharingControlChanged reason=${a.terminatedReason} controlState=${this.controlState}`),this.event("sharingControlChanged").raise(a),e?(this._terminateControlTimer=window.setTimeout((()=>{5===this.controlState?(this.controlState=0,this._resetControllerParticipant(),this._logger.error("No ack received when terminating control - resending terminate request"),this._sendRequest({action:7,terminatedReason:4},r)||this._logger.error("Failed to send the terminateNoAck request"),this._terminateControlPromise?this._terminateControlPromise.reject(new Error("No ack received when terminating control - resending terminate request")):this._logger.error("Unexpected, no promise could be resolved - controlState=WaitingForTerminateAck")):this._terminateControlPromise?this._terminateControlPromise.reject(new Error("terminate control - times out in bad state - do nothing")):this._logger.error(`Unexpected, no promise could be resolved - controlState=${Xp(this.controlState)}`),this._terminateControlTimer=null}),Wp),this._terminateControlPromise.promise):(this._terminateControlPromise.resolve(),new Promise(((e,t)=>{e()})))}_cancelTerminateControlTimer(){this._terminateControlTimer&&(this._terminateControlPromise&&this._terminateControlPromise.reject(new Error("cancelled by _cancelTerminateControlTimer")),clearTimeout(this._terminateControlTimer),this._terminateControlTimer=null,this._logger.info("_cancelTerminateControlTimer()"))}_disposeControlCapturer(e=Re()){this._logger.info(`_disposeControlCapturer causeId: ${e}`),this._clearCapturerEventSubscriptions(),this._controlCapturer&&(this._controlCapturer.dispose(e),this._controlCapturer=null)}dispose(e){this._logger.info(`dispose causeId: ${e}`),this._dataChannelAdapter.dispose(e),this._resetControlState(),this._disposeRenderer(e),this._cancelRequestControlTimer(),this._cancelAcceptControlTimer(),this._cancelGrantControlTimer(),this._cancelTerminateControlTimer(),this._terminateAvailableHandshake&&this._terminateAvailableHandshake(2),this._call=null,this._resetParticipantSubscriptions(),this._finalizeViewerSessionTelemetry("Shutdown"),this._finalizeSharerSessionTelemetry("Shutdown"),super.dispose(e)}};function Qp(e){switch(e){case 0:return"Available";case 1:return"ControlRequest";case 2:return"CancelControlRequest";case 3:return"AcceptRequest";case 4:return"RejectRequest";case 5:return"Ack";case 6:return"GiveControl";case 7:return"TerminateNoAck";case 8:return"Terminate";case 9:return"AvailableAck";case 10:return"AvailableNack";case 11:return"RenderedAtViewer";default:return"Unknown"}}function Xp(e){switch(e){case 0:return"None";case 1:return"RequestSent";case 2:return"WaitingForControlAck";case 3:return"RemoteControlling";case 4:return"LocalControlling";case 5:return"WaitingForTerminateAck";default:return"Unknown"}}function Zp(e){switch(e){case 0:return"None";case 1:return"SharerDenied";case 2:return"SharerNoResponse";case 3:return"SharerBusy";case 4:return"AckTimeout";case 5:return"SharerTerminated";case 6:return"ViewerTerminated";case 7:return"DataChannelError";case 8:return"ViewerCancelled";case 9:return"SharerControlDisabled";case 10:return"UnknownSender";default:return"Unknown"}}var eg=(e=>(e[e.LEFT=0]="LEFT",e[e.RIGHT=1]="RIGHT",e[e.MIDDLE=2]="MIDDLE",e[e.BACK=3]="BACK",e[e.FORWARD=4]="FORWARD",e))(eg||{}),tg=(e=>(e[e.SCAN_CODE=0]="SCAN_CODE",e[e.VIRTUAL_KEY=1]="VIRTUAL_KEY",e[e.RECOGNITION_INPUT=2]="RECOGNITION_INPUT",e))(tg||{}),ig=class{constructor(e){this.logger=e}toEdgeControlMouseEvent(e){let t;switch(e.type){case 0:return{event:this.toMouseMoveEvent(e),apiName:"injectMouseMoveEvent"};case 1:return{event:this.toMouseWheelEvent(e),apiName:"injectMouseWheelEvent"};case 2:return{event:this.toMouseButtonPressedEvent(e),apiName:"injectMouseButtonEvent"};default:throw t=`Uncovered mouse control event type. Event: ${e}`,this.logger.error(t),Error(t)}}toEdgeControlKeyboardEvent(e){return{event:{repeat:e.repeat,keyUp:e.keyUp,codeType:tg[e.codeType],keyCode:e.code},apiName:"injectKeyEvent"}}toMouseMoveEvent(e){return{xPos:e.xPos,yPos:e.yPos}}toMouseWheelEvent(e){return{wheelButtonDown:e.wheelButtonDown,wheelRotation:e.wheelRotation}}toMouseButtonPressedEvent(e){return{xPos:e.xPos,yPos:e.yPos,button:eg[e.buttonType],buttonDown:e.buttonDown}}},ng="ncbjelpjchkpbikbpkcchkhkblodoama",rg=class{constructor(e){this.logger=e}async sendInjectInputEventMessage(e,t){return this.logger.info("EdgeControlInjectorApi - sendInjectInputEventMessage"),new Promise(((i,n)=>{window.top.chrome.runtime.sendMessage(ng,{api:e,deviceId:this.virtualInputDeviceId,event:t},(e=>{e.error?n(e.error.message):i(0)}))}))}async createInputDeviceId(e,t,i){this.virtualInputDeviceId&&this.logger.warn("EdgeControlInjectorApi - createInputDeviceId virtual input already exists.");try{this.virtualInputDeviceId=await this.sendCreateInputDeviceMessage(e,i)}catch(e){this.logger.error(`EdgeControlInjectorApi - createInputDevice failed, error: ${JSON.stringify(e)}`),t()}}async sendSetLocalUserAvatarMessage(e){const t=await this.generateAvatarBitmap(e);return new Promise(((e,i)=>{const n=window.top;t&&n.chrome.runtime.sendMessage(ng,{api:"setLocalUserAvatar",avatarBitmap:t},(t=>{t.error?i(t.error.message):e()}))}))}async sendCloseVirtualInputDeviceMessage(){const e=this.virtualInputDeviceId;return e?(this.logger.info("EdgeControlInjectorApi - sendCloseVirtualInputDeviceMessage called"),new Promise(((t,i)=>{const n=window.top;n.chrome.runtime.sendMessage(ng,{api:"closeInputDevice",deviceId:e},(e=>{e?e.error?i(e.error.message):(this.virtualInputDeviceId=null,t(e.deviceId)):i(n.chrome.runtime.lastError.message)}))}))):(this.logger.info("EdgeControlInjectorApi - VirtualInputDevice does not exists, nothing to close."),Promise.resolve())}async sendCreateInputDeviceMessage(e,t){this.logger.info("EdgeControlInjectorApi - sendCreateInputDeviceMessage called");const i=await this.generateAvatarBitmap(t);return new Promise(((t,n)=>{const r=window.top,s=e=>{e?e.deviceId?t(e.deviceId):e.error?n(e.error.message):n("Error: Unexpected response from API"):n(r.chrome.runtime.lastError.message)};i?r.chrome.runtime.sendMessage(ng,{api:"createInputDevice",mediaStreamTrackId:e,avatarBitmap:i},s):r.chrome.runtime.sendMessage(ng,{api:"createInputDevice",mediaStreamTrackId:e},s)}))}async generateAvatarBitmap(e){if(!e)return null;try{const t=32;return{width:t,height:t,data:await async function(e,t,i){return new Promise(((n,r)=>{const s=l.from(e,"base64"),a=document.createElement("canvas").getContext("2d"),o=new Blob([s],{type:"image/png"});let d=new Image;d.onload=()=>{a.drawImage(d,0,0,d.width,d.height,0,0,t,i);const e=a.getImageData(0,0,t,i);window.URL.revokeObjectURL(d.src),d=null,n(Array.from(e.data))},d.onerror=e=>{r(e)},d.src=window.URL.createObjectURL(o)}))}(e,t,t)}}catch(e){return this.logger.error(`EdgeControlInjectorApi - generateAvatarBitmap error: ${JSON.stringify(e)}, continue without avatar.`),null}}},sg=class{constructor(e,t,i){this.logger=e,this.sharingTrackId=t,this.onInitErrorCallback=i,this.images=new Map,this.controlEventConverter=new ig(e),this.edgeApi=new rg(this.logger)}showVirtualCursor(e,t){if(this.logger.info(`EdgeControlInjector - showVirtualCursor, id: ${e} sharingTrackId: ${this.sharingTrackId}`),t){this.edgeApi.createInputDeviceId(this.sharingTrackId,this.onInitErrorCallback,this.images[e]);const t=this.images[0];t?this.edgeApi.sendSetLocalUserAvatarMessage(t):this.logger.error("EdgeControllerInjector - local avatar is missing, continue without local avatar")}else this.edgeApi.sendCloseVirtualInputDeviceMessage()}setAvatar(e,t){this.logger.info(`${e} EdgeControlInjector - setAvatar, id: ${e}, data: ${JSON.stringify(t)}`),this.images[e]=t,Promise.resolve(-2)}async injectMouseEvent(e,t){this.logger.info(`${e} EdgeControlInjector - injectMouseEvent ${JSON.stringify(t)}`);const i=this.controlEventConverter.toEdgeControlMouseEvent(t);return this.edgeApi.sendInjectInputEventMessage(i.apiName,i.event)}async injectKeyboardEvent(e,t){const i=this.controlEventConverter.toEdgeControlKeyboardEvent(t);return this.edgeApi.sendInjectInputEventMessage(i.apiName,i.event)}injectClipboardText(e,t){return this.logger.info(`${e} EdgeControlInjector - injectClipboardText is unimplemented`),Promise.resolve(0)}dispose(e){this.logger.info("EdgeControlInjector - dispose"),this.edgeApi.sendCloseVirtualInputDeviceMessage()}},ag=class{constructor(e){this.logger=e,this.activeSourceId=0,this.edgeVirtualInputSupported=!1,this.pendingPointerImages=new Map,this.logger.info("ControlInjectorAdapter"),"EdgeAnaheim"===li().name&&async function(e){return new Promise(((t,i)=>{e.info("EdgeControlInjectorApi - sendIsVirtualInputSupportedMessage");const n=window.top;n.chrome.runtime.sendMessage(ng,{api:"isVirtualInputSupported"},(e=>{e?e.error?t(e.error.message):t(e):i(n.chrome.runtime.lastError?.message)}))}))}(e).then((t=>{this.edgeVirtualInputSupported=t,e.info(`ControlInjectorAdapter - Edge supports virtual input device: ${JSON.stringify(this.edgeVirtualInputSupported)}`)})).catch((t=>{e.info(`ControlInjectorAdapter - Edge IsVirtualInputSupported: ${JSON.stringify(t)}`)}))}enableInjector(e){if(this.injector)return this.logger.error("Control injector already present"),Promise.reject();if("EdgeAnaheim"===li().name){if(!this.edgeVirtualInputSupported)return this.logger.info("ControlInjectorAdapter - Edge doesn't support give control"),Promise.reject();const t=()=>(this.disableInjector(),this.logger.error("ControlInjectorAdapter - An error occured, control injector is disabled."),Promise.reject());this.injector=new sg(this.logger,e,t),this.logger.info("ControlInjectorAdapter - Edge ControlInjector created")}else window.ControlInjector&&(this.injector=window.ControlInjector(e),this.logger.info("ControlInjectorAdapter - Window ControlInjector created"));return this.pendingPointerImages.forEach(((e,t)=>{this.injector.setAvatar(t,e)})),this.pendingPointerImages.clear(),Promise.resolve()}disableInjector(){return this.injector?(this.logger.info("ControlInjectorAdapter - ControlInjector disposed"),this.injector.dispose(),this.injector=null,Promise.resolve()):(this.logger.error("Control injector not present"),Promise.reject())}setPointerImage(e,t){return this.injector?new Promise((i=>{this.injector.setAvatar(e,t),i()})):(this.pendingPointerImages.set(e,t),Promise.resolve())}showVirtualCursor(e){return this.logger.info(`ControlInjectorAdapter - showVirtualCursor ${e} ${this.activeSourceId}`),this.injector?new Promise((t=>{e?(this.activeSourceId&&this.injector.showVirtualCursor(this.activeSourceId,!1),this.injector.showVirtualCursor(e,!0),this.activeSourceId=e):this.activeSourceId&&(this.injector.showVirtualCursor(this.activeSourceId,!1),this.activeSourceId=0),t()})):(this.logger.error("Control injector not present"),Promise.reject())}injectRawInput(e,t){if(!this.injector)return this.logger.error("Control injector not present"),Promise.reject();const i=this.injector;return new Promise(((n,r)=>{let s,a;const o=Pp.decodeEventType(e);switch(o){case 1:s=Pp.decodeMouseEvent(e),i.injectMouseEvent(t,s).then((e=>0===e?n():r()));break;case 0:a=Pp.decodeKeyboardEvent(e),i.injectKeyboardEvent(t,a).then((e=>0===e?n():r()));break;default:this.logger.error(`Invalid event type in raw input: ${o}`),r()}}))}canBeEnabled(){return"EdgeAnaheim"===li().name?this.edgeVirtualInputSupported:!!window.ControlInjector}},og=class{constructor(e){this.logger=e,this.logger.info("RendererAdapter")}getTarget(e){return e.target}subscribeVideoSizeChangedEvent(e,t){const i=e;return i.streamSize&&t(i.streamSize.width,i.streamSize.height),i.renderer.on("onVideoSizeChanged",t)}subscribeRenderStartedEvent(e,t){return e.renderer.on("onVideoStarted",((e,i)=>t()))}},lg=class extends Ye{constructor(e,t){super(e),this.logger=e,this._call=t}isActive(){return!(!this.protocolSendFunc||!this.controlSendFunc)}sendProtocolMessage(e,t){return this.protocolSendFunc?this.protocolSendFunc(e,t):(this.logger.error("Cannot send protocol message, ProtocolHandler hasn't started"),Promise.resolve())}sendControlMessage(e,t){return this.controlSendFunc?this.controlSendFunc(e,t):(this.logger.error("Cannot send control message, ControlHandler hasn't started"),Promise.resolve())}getProtocolHandler(){return{onStarted:async(e,t)=>{this.logger.info(`ProtocolHandler started for ${e}`),this.protocolSendFunc=t,this.isActive()&&this.event("stateChange").raise(!0)},onStopped:async e=>{this.logger.info(`ProtocolHandler stopped for ${e}`);const t=this.isActive();this.protocolSendFunc=null,t&&this.event("stateChange").raise(!1)},onDataReceived:async(e,t,i)=>{if(1===e){const e=JSON.parse((n=t,String.fromCharCode.apply(null,n))),r=this._call.mapDataChannelSourceIdToParticipant(i);let s;return r&&(s=Ic(r,3,i)),this.event("protocolMessage").raise(e.message,r,s,i)}var n}}}getControlHandler(){return{onStarted:async(e,t)=>{this.logger.info(`ControlHandler started for ${e}`),this.controlSendFunc=t,this.isActive()&&this.event("stateChange").raise(!0)},onStopped:async e=>{this.logger.info(`ControlHandler stopped for ${e}`);const t=this.isActive();this.controlSendFunc=null,t&&this.event("stateChange").raise(!1)},onDataReceived:async(e,t,i)=>{if(2===e)return this.event("controlMessage").raise(t,i)}}}},dg=class extends Yp{constructor(e,t,i,n,r){const s={};try{const e=r.getEcsConfig("SkypeCalling","gtcHandshakeSendDelay");e&&(s.handshakeSendDelay=JSON.parse(e))}catch(t){e.error(`Failed to parse ecs config gtcAvailableAckDelay: ${Ge(t)}`)}super(e.createChild("ScreenSharingControl"),i,n,s),this.dataChannel=t;const a=new ag(this._logger),o=new og(this._logger),l=new lg(this._logger,i);this.setAdapters(a,o,l)}setupDataHandlers(){this.dataChannel.addHandler(1,this.getProtocolHandler()),this.dataChannel.addHandler(2,this.getControlHandler())}startOrStopControlForViewer(e,t,i){e&&"nonInteractive"!==i?.appliedInteractivityLevel?t&&0===this.role&&this.initControlForViewer(t):2===this.role&&this.shutdownControlForViewer()}getProtocolHandler(){return this._dataChannelAdapter.getProtocolHandler()}getControlHandler(){return this._dataChannelAdapter.getControlHandler()}};function cg(e){switch(e){case 1:return"specified";case 0:return"all";case 3:return"attendees";case 2:return"presenters";case 4:return"self";default:return"none"}}var hg={};y(hg,{addReceiveDirectionality:()=>wg,allowDataChannel:()=>Xg,allowProvisionalAnswer:()=>nm,areNegotiatedDirectionsAcceptable:()=>kg,areNegotiatedDirectionsFulfilled:()=>Ng,areSendDirectionsFulfilled:()=>Lg,canUseWebrtc1_0:()=>Qg,convertToCodecInfo:()=>im,getAllowedCodecs:()=>Zg,getSendMediaModalities:()=>Hg,getSimulcastConfigForMediaType:()=>tm,getSrtpInfo:()=>xg,hasReceiveDirectionality:()=>Rg,hasSendDirectionality:()=>Ag,invertModalities:()=>Pg,ipAddressConverter:()=>sm,ipV4RegExp:()=>Tg,ipV6RegExp:()=>Eg,ipv4AddressConverter:()=>om,ipv6AddressConverter:()=>am,isOnHold:()=>Mg,isSendModalityAdded:()=>Vg,isVersionGreaterOrEqual:()=>em,makeReinvitelessContext:()=>lm,mediaTypeToModality:()=>jg,mergeSendModalities:()=>Bg,modalityToMediaType:()=>$g,negotiateDirectionality:()=>bg,negotiateModalities:()=>Og,parseCandidateString:()=>Ug,preferSdesSrtp:()=>Yg,printMediaStream:()=>rm,removeChangedSendDirection:()=>Fg,removeSendDirectionality:()=>Ig,scrubConstraints:()=>Jg,scrubDevices:()=>Kg,scrubObjectExcludingFields:()=>qg,scrubObjectFields:()=>Wg,scrubSelectedDevices:()=>zg,sendStreamsToModalities:()=>Gg});var ug,pg,gg="undefined"!=typeof navigator&&void 0!==navigator.mediaDevices?.getUserMedia,mg=(e=>(e.AVD="43",e.Citrix="44",e.VMware="45",e))(mg||{});function fg(e=""){const t=e.match(new RegExp("^SkypeSpaces/(\\d+)/"));t?.length&&Object.values(mg).includes(t[1])&&(pg=t[1]),"undefined"!=typeof window&&"undefined"!=typeof navigator&&(void 0!==navigator.webkitGetUserMedia&&"undefined"!=typeof webkitRTCPeerConnection&&Sg()?(window.RTCPeerConnection=webkitRTCPeerConnection,navigator.getUserMedia=(e,t,i)=>{const n=e=>{e?.deviceId?.exact&&(e.mandatory||(e.mandatory={}),e.mandatory.sourceId=e.deviceId.exact,delete e.deviceId)};return e&&(n(e.audio),n(e.video)),navigator.webkitGetUserMedia(e,t,i)}):gg&&vg())}function Sg(){return!!pg}function vg(){navigator.getUserMedia=function(e,t,i){return navigator.mediaDevices.getUserMedia(e).then(t).catch(i)}}"undefined"!=typeof window&&"undefined"!=typeof navigator&&(ug=window,window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL,window.MediaStream=window.MediaStream||window.webkitMediaStream||window.mozMediaStream||window.msMediaStream,window.AudioContext=window.AudioContext||window.webkitAudioContext);var yg={window:ug},Cg=class e extends Qe{constructor(e){super(),this.isAudioOutputSelectionSupportedValue=!1,e.on("configUpdated",(()=>this.updateConfig())),this.updateConfig(),this.isRollbackSupported()}get isAudioOutputSelectionSupported(){return this.isAudioOutputSelectionSupportedValue}get isBrowserRollbackSupported(){return this.isRollbackSupportedValue}static hasApplyConstraints(){return void 0!==MediaStreamTrack.prototype.applyConstraints}static hasPermissionsApi(){return void 0!==navigator.permissions&&"Firefox"!==li().name}static get hardwareConcurrency(){return window.navigator.hardwareConcurrency}static get unmaskedGlRenderer(){if(this.renderer)return this.renderer===tt.MEDIA_ERROR.webGlRendererError?void 0:this.renderer;try{const e=document.createElement("canvas").getContext("webgl"),t=e?.getExtension("WEBGL_debug_renderer_info"),i=t&&e.getParameter(t.UNMASKED_RENDERER_WEBGL);return this.renderer=i,i}catch{return void(this.renderer=tt.MEDIA_ERROR.webGlRendererError)}}async isRollbackSupported(){let e;try{if(e=yg.window.RTCPeerConnection&&new yg.window.RTCPeerConnection({sdpSemantics:"unified-plan"}),e){const t=await e.createOffer();await e.setLocalDescription(t),await e.setLocalDescription({type:"rollback"}),this.isRollbackSupportedValue=!0}}catch(e){this.isRollbackSupportedValue=!1}finally{e?.close()}}static async isCodecsSupported(e){const t={format:"annexb"},i=["no-preference","prefer-software","prefer-hardware"],n=[];for(const r of e)for(const e of i){const i=await(window.VideoEncoder?.isConfigSupported({codec:r,hardwareAcceleration:e,hevc:t,width:1280,height:720})),s=await(window.VideoDecoder?.isConfigSupported({codec:r,hardwareAcceleration:e,hevc:t}));if(i||s){const e={name:r,mode:i?.config.hardwareAcceleration,encode:i?.supported,decode:s?.supported};n.push(e)}}return n}static async hasH264CodecSupport(e){const t=yg.window.RTCPeerConnection&&new yg.window.RTCPeerConnection;if(!t)return!1;try{return await t.setRemoteDescription({sdp:"v=0\no=- 596983 0 IN IP4 127.0.0.1\ns=session\nc=IN IP4 0.0.0.0\nt=0 0\na=msid-semantic: WMS *\nm=video 3480 RTP/SAVPF 107 99\na=rtpmap:107 H264/90000\na=rtpmap:99 rtx/90000\na=fmtp:107 max-fs=240;max-mbps=3600;max-br=208;max-fps=1500;profile-level-id=42C02A;packetization-mode=1\na=fmtp:99 apt=107\na=setup:actpass\na=mid:video\na=recvonly\na=rtcp-mux\na=ice-ufrag:CvYq\na=ice-pwd:axsjsa0GOz3kz6TuGvNgJZWO\na=fingerprint:sha-256 34:DF:5C:15:60:FF:28:3E:E8:96:4B:F8:85:61:E4:C0:57:D1:60:82:21:FD:BC:D2:90:41:06:FA:03:FD:12:A2\n",type:"offer"}),!0}catch(t){return e.error("H264 not supported",t),!1}finally{try{t.close()}catch(e){}}}static hasMediaApi(){return navigator.getUserMedia&&"undefined"!=typeof RTCPeerConnection}static hasCapabilitiesApi(){return!!yg.window.RTCRtpReceiver?.getCapabilities}static isAudioOutputSelectionSupportedByBrowser(){return!!yg.window?.HTMLAudioElement?.prototype.setSinkId}updateConfig(){const t=e.isAudioOutputSelectionSupportedByBrowser();t!==this.isAudioOutputSelectionSupportedValue&&(this.isAudioOutputSelectionSupportedValue=t,this.event("isAudioOutputSelectionSupportedChanged").raise())}static hasUnifiedPlanSupport(){let e;try{e=yg.window.RTCPeerConnection&&new yg.window.RTCPeerConnection({sdpSemantics:"unified-plan"})}catch(e){return!1}let t=!1;return e&&(t=!!e.addTransceiver,e.close()),t}static hasEncodedStreamApi(){return!!RTCRtpReceiver.prototype.createEncodedStreams||e.hasScriptTransformApi()}static hasScriptTransformApi(){return!!window.RTCRtpScriptTransform}static isWakeLockSupported(){return!!window.navigator.wakeLock}},Tg=RegExp(/^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(:[0-9]{1,5})?$/),Eg=RegExp(/^\[?(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|:((:[0-9a-fA-F]{1,4}){1,5}|:)((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,5}([0-9a-fA-F]{1,4})?:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\]?(?::\d{1,5})?$/);function _g(e){switch(e){case tt.MEDIA_STATE.send:return tt.MEDIA_STATE.receive;case tt.MEDIA_STATE.receive:return tt.MEDIA_STATE.send;default:return e}}function bg(e,t){const i=Ag(e)&&Ag(t),n=Rg(e)&&Rg(t);return i&&n?tt.MEDIA_STATE.sendReceive:i?tt.MEDIA_STATE.send:n?tt.MEDIA_STATE.receive:e===tt.MEDIA_STATE.inactive&&t||e&&t===tt.MEDIA_STATE.inactive?tt.MEDIA_STATE.inactive:void 0}function Pg(e){const t={},i=_g(e.audio);i&&(t.audio=i);const n=_g(e.video);n&&(t.video=n);const r=_g(e.sharing);r&&(t.sharing=r);const s=_g(e.data);return s&&(t.data=s),t}function Ig(e){return e===tt.MEDIA_STATE.sendReceive?tt.MEDIA_STATE.receive:void 0}function Ag(e){return e===tt.MEDIA_STATE.send||e===tt.MEDIA_STATE.sendReceive}function Rg(e){return e===tt.MEDIA_STATE.receive||e===tt.MEDIA_STATE.sendReceive}function wg(e){return Rg(e)?e:e===tt.MEDIA_STATE.send?tt.MEDIA_STATE.sendReceive:tt.MEDIA_STATE.receive}function Mg(e){return!(e.audio!==tt.MEDIA_STATE.inactive||e.video&&e.video!==tt.MEDIA_STATE.inactive||e.sharing&&e.sharing!==tt.MEDIA_STATE.inactive)}function Og(e,t){const i={},n=bg(e.audio,t.audio);n&&(i.audio=n);const r=bg(e.video,t.video);r&&(i.video=r);const s=bg(e.sharing,t.sharing);s&&(i.sharing=s);const a=bg(e.data,t.data);return a&&(i.data=a),i}function Dg(e,t,i){const n=Ag(e)&&Ag(t)||!Ag(e)&&!Ag(i),r=!i||Rg(e)&&Rg(t)||!Rg(e)&&!Rg(i);return n&&r}function kg(e,t,i){return Dg(e.audio,t.audio,i.audio)&&Dg(e.video,t.video,i.video)&&Dg(e.sharing,t.sharing,i.sharing)&&Dg(e.data,t.data,i.data)}function Ng(e,t){function i(e,t){const i=Ag(e)===Ag(t),n=Rg(e)===Rg(t)||Rg(e)&&!t;return i&&n}return i(e.audio,t.audio)&&i(e.video,t.video)&&i(e.sharing,t.sharing)&&i(e.data,t.data)}function Lg(e,t){const i=(e,t)=>Ag(e)===Ag(t);return i(e.audio,t.audio)&&i(e.video,t.video)&&i(e.sharing,t.sharing)&&i(e.data,t.data)}function xg(e){const t={dtls:!1,sdes:!1};return t.dtls=!!e.fingerprint,e.media.forEach((e=>{t.dtls=t.dtls||!!e.fingerprint,t.sdes=t.sdes||!!e.crypto})),t}function Fg(e,t){if(!t||dt(t))return e;const i={};return it(e,((e,n)=>{var r,s;n===tt.MODALITY.data?i[n]=(r=e,s=t[n],Ag(r)&&!Ag(s)?s:r):i[n]=function(e,t){return Ag(e)&&!Ag(t)?Ig(e)||t:e}(e,t[n])})),i}function Ug(e){const t=(e||"").split(" ");return{component:t[1],protocol:t[2],priority:t[3],ip:t[4],port:t[5],type:t[7]}}function Vg(e,t){return!Ag(e)&&Ag(t)}function Hg(e){return{Audio:Ag(e.audio),Video:Ag(e.video),ScreenShare:Ag(e.sharing),Data:Ag(e.data)}}function Bg(e,t){const i=ht(e);return it(e,((e,n)=>{const r=$g(n);Ag(e)&&!t[r]&&(i[n]=Ig(e))})),i}function $g(e){switch(e){case"audio":return"Audio";case"video":return"Video";case"sharing":return"ScreenShare";default:return null}}function jg(e){switch(e){case"Audio":return"audio";case"Video":return"video";case"ScreenShare":return"sharing";default:return null}}function Gg(e){const t={};return ct(e).forEach((i=>t[i]=!!e[i])),t}function Wg(e,t,i){if(!e)return e;const n={...e};for(const[r,s]of Object.entries(e))"object"==typeof s?n[r]=Wg(s,t):s&&t.includes(r)&&(n[r]=i?i(s):ke(s));return n}function qg(e,t,i){if(!e)return e;const n={...e};for(const[r,s]of Object.entries(e))"object"==typeof s?n[r]=qg(s,t):s&&!t.includes(r)&&(n[r]=i?i(s):ke(s));return n}function zg(e){return e?qg(e,[]):e}function Kg(e,t){if(!e)return e;const i=Wg(e,["deviceId","groupId","guid"]);return Wg(i,["label"],(e=>Pt(e,t)))}function Jg(e){return Wg(e,["sourceId","deviceId"])}function Yg(e){return!(!e.configProvider.config.webrtcForceSdesForS1||!e.configProvider.config.checkSupportForWebrtc_1_0||e.configProvider.mediaConfig.simulcastSessionEnabled)||(e.config.isPstnCall?e.configProvider.config.preferSdesSrtpPstn:e.configProvider.config.preferSdesSrtp)}function Qg(e){return!e||Cg.hasUnifiedPlanSupport()}function Xg(e){return!!e.configProvider.mediaConfig.simulcastSessionEnabled&&(e.config.isPstnCall?e.configProvider.config.enableDataChannelPstn:e.configProvider.config.enableDataChannel)}function Zg(e,t){switch(t){case tt.MEDIA_TYPE.audio:return e.config.allowedAudioCodecs;case tt.MEDIA_TYPE.video:return e.config.allowedVideoCodecs;default:return[]}}function em(e,t){const i=t.split(".").map((e=>parseInt(e,10))),n=e.split(".").map((e=>parseInt(e,10)));return n[0]>i[0]||n[0]===i[0]&&n[1]>=i[1]}function tm(e,t){return"Video"===e?t.config.specCompliantSimulcast?.video:"ScreenShare"===e?t.config.specCompliantSimulcast?.sharing:null}function im(e){return e.map((e=>{const t=e.mimeType.split("/"),i={codec:t[1]||t[0],rate:e.clockRate};return e.channels&&(i.encoding=e.channels),e.sdpFmtpLine&&(i.fmtpLine=e.sdpFmtpLine),i}))}function nm(e,t=!1){const i=!e.configProvider.config.acceptProvisionalAnswerFromPstnOnly||t;return e.config.isPstnCall?e.configProvider.config.allowProvisionalAnswerPstn&&i:e.configProvider.config.allowProvisionalAnswer}function rm(e){return`${e?.id}:${JSON.stringify(e?.getTracks().map((e=>e.id)))}}`}function sm(e){try{if(Tg.test(e))return om(e);if(Eg.test(e))return am(e)}catch(t){return e}return e}function am(e){let t,i=e.lastIndexOf("]")+1,n="",r="";i>0?(t=e.substring(0,i),r=e.substring(i)):(t=e,i=t.length);const s=t.lastIndexOf(":");if(t.includes(".")){const e=om(t.substring(s+1,i-1-s));n=t.substring(0,s+1)+e}else s<t.length-1||":"===t[s-1]&&t.match(/:/g).length<7?n=t.substring(0,s+1)+"x":7===t.match(/:/g).length&&(n=t.substring(0,s)+"0:x");return n?r?n+"]"+r:"["===e.substring(0,1)?(n=n.substring(1),n):n:e}function om(e){const t=e.substring(0,e.lastIndexOf(".")+1)+"x",i=e.lastIndexOf(":");return i>0?t+e.substring(i):t}function lm(e,t){const i=(t?e?.maxReinvitelessMediaForVideoMultiparty:e?.maxReinvitelessMediaForVideo1on1)||0,n=(t?e?.maxReinvitelessMediaForVBSSMultiparty:e?.maxReinvitelessMediaForVBSS1on1)||0;return{enabled:i>0||n>0,maxStreamsForModality:{video:i,sharing:n}}}var dm=class extends Ye{constructor(){super(),this.subs=[]}get streams(){return this.sessionAudioProvider?.streams??[]}get comfortNoiseStream(){return this.sessionAudioProvider?.comfortNoiseStream??null}get active(){return this.sessionAudioProvider?.active??!1}setSessionStreamsProvider(e){this.unsubscribeFromStreamEvents(),this.sessionAudioProvider=e,this.subscribeForStreamEvents(),this.event("onStreamsChanged").raise(),this.event("onActiveStateChanged").raise()}dispose(){super.dispose(),this.unsubscribeFromStreamEvents()}subscribeForStreamEvents(){this.sessionAudioProvider&&this.subs.push(this.sessionAudioProvider.on("onStreamsChanged",(()=>this.event("onStreamsChanged").raise())),this.sessionAudioProvider.on("onStreamSourcesUpdated",(e=>this.event("onStreamSourcesUpdated").raise(e))),this.sessionAudioProvider.on("onActiveStateChanged",(()=>this.event("onActiveStateChanged").raise())))}unsubscribeFromStreamEvents(){this.subs.forEach((e=>e.dispose())),this.subs=[]}},cm=class extends Ye{constructor(e,t,i,n,r){super(),this.allowVirtualDeviceInCall=e,this.defaultDeviceManager=t,this.logger=i,this.callStats=n,this.isMediaSending=r,this.stats=[],this.selectedVirtualDevice={camera:void 0,screenshare:void 0},this.subs=[this.defaultDeviceManager.on("onVirtualDevicesChanged",(()=>this.handleRegisteredDeviceChange()))]}get isVirtualDeviceEnabled(){return this.allowVirtualDeviceInCall}selectDevices(e){const t=this.defaultDeviceManager.getRegisteredDevices(),i=t.find((t=>t.id===e.camera)),n=t.find((t=>t.id===e.screenshare));this.logger.info(`Selecting virtual devices, camera: ${i?.id}, screenshare: ${n?.id}`);const r={camera:this.selectedVirtualDevice.camera?.id,screenshare:this.selectedVirtualDevice.screenshare?.id};e.camera!==r.camera||e.screenshare!==r.screenshare?(this.selectedVirtualDevice={camera:i,screenshare:n},this.addToCallStat({type:"VirtualDeviceSelected",payload:this.selectedVirtualDevice}),this.event("onSelectedVirtualDevicesChanged").raise(e,r)):this.logger.info("Virtual Device did not change.")}getSelectedDevices(){return Object.entries(this.selectedVirtualDevice).reduce(((e,[t,i])=>(e[t]=i?.id,e)),{})}getDeviceManager(e){return this.allowVirtualDeviceInCall?this.getDeviceManagersForVirtualDevice(e)[0]:(this.logger.info(`VirtualDevice not enabled, using default DM, type: ${e}`),this.defaultDeviceManager)}getDeviceManagersForVirtualDevice(e){return"Video"===e&&this.selectedVirtualDevice.camera?(this.logger.info(`Using Virtual Device (DM), type: ${e}`),this.selectedVirtualDevice.camera.getDeviceManagers()):"ScreenShare"===e&&this.selectedVirtualDevice.screenshare?(this.logger.info(`Using Virtual Device (DM), type: ${e}`),this.selectedVirtualDevice.screenshare.getDeviceManagers()):(this.logger.info(`Using default DM, type: ${e}`),[this.defaultDeviceManager])}getDefaultDeviceManager(){return this.defaultDeviceManager}dispose(){this.stats=[],this.subs.forEach((e=>e.dispose())),super.dispose()}hasDevice(e){return this.defaultDeviceManager.id===e||[...this.selectedVirtualDevice.camera?.getDeviceManagers()??[],...this.selectedVirtualDevice.screenshare?.getDeviceManagers()??[]].some((t=>t?.id===e))}addToCallStat(e){const t=this.stats.push(e);this.callStats.appendCallDeviceManagerInfo({events:JSON.stringify(t)})}handleRegisteredDeviceChange(){const e=this.defaultDeviceManager.getRegisteredDevices(),{camera:t,screenshare:i}=this.selectedVirtualDevice;let n=!1,r=!1;t&&(n=e.some((e=>e.id===t.id)),this.logger.info(`Selected camera(${t.id}) in call, isCameraValid:${n}`)),i&&(r=e.some((e=>e.id===i.id)),this.logger.info(`Selected SS(${i.id}) in call, isScreenShareValid:${r}`)),this.selectDevices({camera:n?t.id:void 0,screenshare:r?i.id:void 0})}isModalityEnabled(e){return this.isMediaSending(function(e){switch(e){case"Audio":return 0;case"Video":return 1;case"ScreenShare":return 2}throw new Error("MediaType required")}(e))}},hm=class{constructor(e){this.ontimeout=e,this.active=!1}get isActive(){return this.active}start(e){void 0!==this.timeoutId&&this.stop(),this.timeoutId=setTimeout((()=>{this.ontimeout(),this.active=!1}),e),this.active=!0}stop(){clearTimeout(this.timeoutId),this.timeoutId=void 0,this.active=!1}};function um(){let e,t,i=!0;return{isPending:()=>i,promise:new Promise(((i,n)=>{e=i,t=n})),resolve:t=>{i&&(e(t),i=!1)},reject:e=>{i&&(t(e),i=!1)}}}function pm(e){return new Promise((t=>setTimeout(t,e)))}var gm=class{constructor(e,t,i,n){this.mediaControlPlane=e,this.signalingSession=t,this.logger=i,this.diagnostics=n,this.pendingSourceRequests=new Map,this.mediaControlPlane.on("mpSrResReceived",((e,t)=>this.onMsgReceived(e,t)))}mapToSignalingOperation(e){switch(e){case"ApplyChannelParametersSourceRequest":case"ApplyChannelParametersVideoCapabilities":case"ApplyChannelParametersBandwidth":return 0;case"ControlVideoStreaming":return 1;default:return this.logger.error("Unknown send operation"),null}}send(e,t,i,n){switch(e){case"ApplyChannelParametersSourceRequest":return this.sendMessages(e,t,i,n);case"ApplyChannelParametersVideoCapabilities":case"ApplyChannelParametersBandwidth":case"ControlVideoStreaming":return this.signalingSession?(this.diagnostics.recordSignalingOperation(e),this.signalingSession.sendWebRtcMediaNotificationAsync(this.mapToSignalingOperation(e),t)):Promise.reject(new Error("no signaling session"));default:return this.logger.warn(`Unable to send message reason: Operation unknown ${e}`),Promise.reject(new Error("Unable to send message"))}}async sendMessages(e,t,i,n){return this.mediaControlPlane.mcpFeaturesSupported("sendDuplicates")?Promise.all([this.sendMcpMessage(e,t,i,n),this.sendSignalingDupeOperation(e,t,n)]).then():this.sendMcpMessage(e,t,i,n)}setResendingMechanism(e,t,i,n){const r=window.setTimeout((()=>{this.logger.warn(`Fallback for SR: ${e}, switching to signaling`),this.mediaControlPlane.switchMcpFeauture("sourceRequestsEnabled",!1),this.resendPendingMessagesThroughSignaling()}),this.mediaControlPlane.getConfig()?.sourceRequestsMessagesTimeout);this.pendingSourceRequests.set(e,{sequenceNumber:e,timeoutId:r,deferred:t,message:i,operation:n})}async sendMcpMessage(e,t,i,n){if(this.mediaControlPlane?.mcpFeaturesSupported("sourceRequestsEnabled")&&t.applyChannelParameters?.multiChannelParameter?.mediaParameter?.includes("controlVideoStreaming")){const r=um();this.setResendingMechanism(n,r,t,e);try{return this.diagnostics.recordMCPOperation(e,n,i.controlVideoStreaming?.controlInfo),await this.mediaControlPlane.sendMsg({type:"sr",controlVideoStreaming:i.controlVideoStreaming}),this.logger.info(`Sending to MCP sequenceNumber:${n}`),this.mediaControlPlane?.mcpFeaturesSupported("sourceRequestsResponseEnabled")?r.promise:Promise.resolve()}catch(e){const t=Ge(e);this.diagnostics.recordError(t,n),this.logger.error(`sendMsgInternal failed with error: ${t}`)}}return this.signalingSession?this.mediaControlPlane?.mcpFeaturesSupported("sendDuplicates")?void 0:(this.diagnostics.recordSignalingOperation(e),this.signalingSession.sendWebRtcMediaNotificationAsync(this.mapToSignalingOperation(e),t)):Promise.reject(new Error("no signaling session"))}async sendSignalingDupeOperation(e,t,i){if(this.signalingSession){const n=this.mapToSignalingOperation(e);return this.diagnostics.recordSignalingOperation(e,i),await this.signalingSession.sendWebRtcMediaNotificationAsync(n,t),this.diagnostics.recordSignalingOperationDuration(e,i),Promise.resolve()}return Promise.reject(new Error("no signaling session"))}resendPendingMessagesThroughSignaling(){this.diagnostics.recordFallback(),this.pendingSourceRequests.forEach((async(e,t)=>{try{this.mediaControlPlane.mcpFeaturesSupported("sendDuplicates")||(this.diagnostics.recordSignalingOperation(e.operation),await this.signalingSession.sendWebRtcMediaNotificationAsync(this.mapToSignalingOperation(e.operation),e.message)),e.deferred.resolve()}catch{e.deferred.reject()}finally{this.logger.warn(`Deleting message from pending: ${t}`),this.pendingSourceRequests.delete(t),clearTimeout(e.timeoutId)}}))}onMsgReceived(e,t){const i=this.pendingSourceRequests.get(e);switch(this.diagnostics.recordSrResultReceived(t,e,i.operation),t){case"ok":case"duplicate":case"out_of_order":i.deferred.resolve();break;default:i.deferred.reject(`Sequence number: ${e} failed with ${t}!`)}clearTimeout(i.timeoutId),this.pendingSourceRequests.delete(e)}},mm=[1,2,9,10,11,12,30,27,28],fm="remote",Sm=class extends Ye{constructor(e,t){super(),this.isStreaming=e,this.mediaType=t}},vm=class e extends Ye{constructor(t,i,n,r,s,a,o,l,d,c,h,u,p,g,m,f,S){super(n),this.signalingAgent=t,this.mediaAgent=i,this.logger=n,this.telemetryLoggers=r,this.currentUserSkypeIdentity=s,this.groupId=a,this.threadId=o,this.ecsProvider=c,this.trouterService=h,this.accountConfiguration=u,this.participants=[],this.isServerMuted=!1,this.isSpeakerMuted=!1,this.isVideoOn=!1,this.isScreenSharingOn=!1,this.callStartedAt=null,this.callHeldAt=null,this.callType=-1,this.failureType=2,this.isEmergency=!1,this.contentSharingSessions=[],this.endpoints={endpointDetails:[]},this.isPreheatEnabled=!1,this.localMediaStreams=[],this.enableRealtimeTelemetry=!1,this.isSharedLineAppearanceV2Activated=!1,this.enableCaptcha=!1,this.requestedHoldState=!1,this.mediaStateConfigurationHelper=new Au({mediaStates:[bu(0,4)]}),this.canToggleAudio=!0,this.canToggleVideo=!0,this.connectCallPromise=Promise.resolve(),this.canToggleScreenSharing=!0,this.callUsesMixer=!1,this.isEscalationInProgress=!1,this.retryOutgoingRenegotiation={retry:!1,causeId:""},this.isHoldInProgress=!1,this.isMuteOnHold=!1,this.callSetupFailed=!1,this.isSomeoneSharing=!1,this.isSomeoneStreamingVideo=!1,this.activeTalkersHistory=[],this.callGotConnected=!1,this.mediaRelayWhiteListingIssue=!1,this.signalingSessionCallOptions=null,this.tsCallingTelemetryReported=!1,this.isCallSetupTelemetrySent=!1,this._isAudioStreamConnected=!1,this._wasAudioStreamConnected=!1,this._callInLobby=!1,this._callIsSetupComplete=!1,this._transferState=0,this._parkState=0,this._muteState=0,this._callCreationTime=(new Date).getTime(),this._commandUrlPresence=0,this._capabilities={canMuteOthers:!1,canUnmuteSelf:!1},this._spamRiskLevel=null,this._spamStirAttestation=null,this._callMode=0,this._isUpdatePropertiesSpecifiedAllowedByEcs=!1,this._deferUsingMicrotask=!1,this._staleRosterCheckFixForPluginless=!1,this._transfereeAcceptanceWithoutWaitingForConv=!1,this._enableResolveScreenSharingWhenNegotiationComplete=!1,this._publishedStatesModified=0,this._participantPublishedStatesMap={},this._endpointPublishedStatesMap={},this._participantChangedEventSkipConfig={skipParticipantsUpdatesOnCall:!0},this._dominantSpeakerChangedEventSkipConfig={skipDominantSpeakerUpdatesOnCall:!0},this.receiveOnlyAudioOnCallStart=!1,this.lastContibutingSourceReport=Date.now(),this.instanceNumber=e.instanceCount++%1e3,this._hasDelayedReconnect=!1,this._enableMuteAsync=!1,this._enableUnmuteAsync=!1,this.startVM=(e,t,i,n,r)=>this.signalingSession.startOutgoingCall(i,n,{voicemailResourcePath:t.callVoicemailStartOptions.voicemailResourcePath,voicemailItemId:t.callVoicemailStartOptions.voicemailItemId,callToVoicemail:!0},Date.now()-r,e),this.getSignalingSessionCallOptions=e=>{const t={suppressDialout:!e.callStartOptions.ringOthers,isPreheatOnly:1==(1&e.callStartOptions.preheatFlags),onBehalfOf:this.onBehalfOfMri,onBehalfOfUserDisplayName:this.onBehalfOfUserDisplayName,callQueueContext:this.callQueueContext,muted:1==(1&e.callStartOptions.muteFlags),invitationType:e.invitationType,participantsToNudge:e.participantsToNudge,routingFlags:e.callStartOptions&&e.callStartOptions.routingFlags,parkContext:e.parkContext,pickupCode:e.pickupCode,scenario:e.callStartOptions&&e.callStartOptions.scenario,callUsesMixer:this.callUsesMixer,clientEndpointCapabilities:e.callStartOptions.clientEndpointCapabilities,clientEndpointDebugContent:e.callStartOptions.clientEndpointDebugContent,isEmergency:this.isEmergency,meetingData:this.meetingData,meetingPreferences:e.meetingPreferences,alternateId:e.callStartOptions?e.callStartOptions.alternateId:null,meetingRegistrationId:e.callStartOptions?e.callStartOptions.meetingRegistrationId:"",participantPin:e.callStartOptions?e.callStartOptions.participantPin:"",additionalEndpointProperties:e.callStartOptions?.additionalEndpointProperties||null,publishedStates:e.callStartOptions?.publishedStates||null,targetApplicationType:e.callStartOptions?.targetApplicationType,isHuddleGroupCall:e.callStartOptions?.isHuddleGroupCall,captchaContentJson:e.callStartOptions?.captchaContentJson},i=e.callStartOptions?.invitationDataJson;if(i)try{t.invitationData=JSON.parse(i)}catch(e){throw new Error(`Invalid JSON in invitationData: ${i}`)}return t},this.startOutgoingCall=(e,t,i,n,r)=>this.signalingSession.startOutgoingCall(i,n,this.getSignalingSessionCallOptions(t),Date.now()-r,e),this.joinGivenConversation=(e,t,i,n,r,s)=>{const a=1==(1&t.callStartOptions.muteFlags),o=1==(1&t.callStartOptions.preheatFlags),l=t.callStartOptions?.invitationDataJson,d=t.callStartOptions?.sharedLineCallInvitationContentJson;this.logger.info(`[${e}][joinGivenConversation] muted=${a}, isPreheatOnly=${o},\n            sharedLineCallInvitationContentJson=${d}, invitationDataJson=${l}`);const c={muted:a,isPreheatOnly:o,clientEndpointCapabilities:t.callStartOptions.clientEndpointCapabilities,clientEndpointDebugContent:t.callStartOptions.clientEndpointDebugContent,isEmergency:this.isEmergency,meetingData:this.meetingData,meetingPreferences:t.meetingPreferences,meetingRegistrationId:t.callStartOptions?t.callStartOptions.meetingRegistrationId:"",participantPin:t.callStartOptions?t.callStartOptions.participantPin:"",additionalEndpointProperties:t?.callStartOptions?.additionalEndpointProperties,applyServerMute:t?.applyServerMute,publishedStates:t?.callStartOptions.publishedStates,invitationData:t?.callStartOptions.invitationDataJson,captchaContentJson:t?.callStartOptions.captchaContentJson,callQueueContext:t?.callStartOptions.callQueueContext};if(d)try{c.sharedLineCallInvitationContent=JSON.parse(d)}catch(e){throw new Error(`Invalid JSON in sharedLineCallInvitationContent: ${d}`)}if(l)try{c.invitationData=JSON.parse(l)}catch(e){throw new Error(`Invalid JSON in invitationDataJson: ${l}`)}return this.signalingSession.joinGivenConversation(s,this.callId,i,n,Date.now()-r,c,e)},this.executeCallTransfer=(e,t,i,n)=>{this._setTransferState(1);const r=this._callOperationHandler.createPendingOperation("_CallTransferInProgress",void 0,t,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]});return 0===i?this.signalingSession.transferCallAsync(e,"TransferTypeStandard",void 0,n,t):2===i&&this.signalingSession.transferCallAsync(e,"TransferTypeVoicemail",void 0,n,t),r},this.executeConsultCallTransfer=(e,t,i,n,r)=>{this._setTransferState(1);const s=this._callOperationHandler.createPendingOperation("_CallTransferInProgress",void 0,n,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]});return this.signalingSession.consultTransferCallAsync(e,t,i,n,r),s},this.createUpdateParticipantPromise=(e,t)=>this._callOperationHandler.createPendingOperation("UpdateParticipantsProperties",e,t),this._getCallEndOperation=()=>this._callOperationHandler.hasPendingOperation("StopCall")?this._callOperationHandler.waitForOperation("StopCall"):this._callOperationHandler.hasPendingOperation("Reject")?this._callOperationHandler.waitForOperation("Reject"):this._callOperationHandler.hasPendingOperation("CallRedirect")?this._callOperationHandler.waitForOperation("CallRedirect"):Promise.resolve(),this._onAcknowledgeError=(e,t,i,n)=>{i.logFailure(e);let r,s={code:2,success:!1,fatal:!0},a=7;throw zh("SendAttach",e)&&(r={code:qn.InternalServerError,subCode:zn.AttachFailed,phrase:dr}),zh("ProcessIncomingCallRequest",e)&&(r={code:qn.NotAcceptable,subCode:zn.AttachActionFailed,phrase:cr},s={code:0,success:!1,fatal:!0}),qh(yr,e)&&(a=47),e?.error&&e.error.type===this.mediaAgent.constants.MEDIA_ERROR.incompatibleOffer&&(r={code:qn.MediaError,subCode:zn.MediaOfferProcessingError,phrase:or}),this.callTelemetry.updateOperationData("Acknowledge",{phases:n,error:Fe(e)},t),this._callOperationHandler.maybeRejectOperation("Acknowledge",s,void 0,t),this.stopInternal({rejectReason:r,causeId:t,terminatedReason:a}),s},this._onAcknowledgeSuccess=(e,t,i)=>(e.logSuccess("success"),this.callTelemetry.updateOperationData("Acknowledge",{phases:t},i),{code:1,success:!0}),this._processOfferedModalities=(e,t)=>{this.handleOfferedModalities(e,t);const i=this.callUsesMixer?void 0:{modalityOverride:e};return this.updateMediaModalities(i,t)},this._handleOfferProcessingError=(e,t,i)=>(i.logFailure(`handleOfferProcessingError=${e}`),e?.error?.type===this.mediaAgent.constants.MEDIA_ERROR.incompatibleOffer?(this.callTelemetry.recordEvent("IncompatibleOffer",void 0,t),this.signalingSession.supportsNewOfferRequest()?(this.newOfferRequestDeferred=Ei(),this.attachToCallAndGetOffer.promise.then((()=>this.mediaSession.rejectNegotiationAsync(e.error,t))).then((()=>this.signalingSession.requestNewOffer(this.mediaSession.getAcceptedTypes(),t))).then((()=>this.newOfferRequestDeferred.promise)).then((e=>this.mediaSession.processOfferAsync(e,t))).catch((e=>(this.callTelemetry.recordEvent("NewOfferFailed",Ve(e),t),Promise.reject(e))))):Promise.reject(e)):Promise.reject(e)),this._trySendProvisionalMediaAnswer=e=>Promise.resolve(void 0).then((()=>this.mediaSession.createAnswerAsync(!0,e))).then((e=>e.blob?(this.mediaAcknowledgmentOperation=this._callOperationHandler.createPendingOperation("_MediaAcknowledgment",void 0,Re(),{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),this.signalingSession.setProvisionalAnswerAsync(e).then((()=>this.mediaAcknowledgmentOperation))):Promise.resolve(void 0))),this.checkForCallIdUpdate=(e,t)=>{if(this.callId!==e){this.logger.info(`[${t}][checkForCallIdUpdate] old=${this.callId}, new=${e}`),this.setCallId(e);try{this.event("callIdChanged").raise(this.callId)}catch(e){this.logger.error(`Error raising call ID change: ${e}`)}this.raiseChanged()}},this.handleRemoteParticipantStateInOneToOneCall=e=>{if(!this.callUsesMixer&&3===this.state){const t=this.participants[0];t&&t.setState(3,void 0,e)}},this.handleRemoteParticipantJoinedInOneToOneCall=(e,t)=>{if(!this.callUsesMixer&&3===this.state){const i=this.participants.filter((t=>t.id===e.id))[0];i?i.setState(3,void 0,t):this.logger.logFailure(`[${t}][handleRemoteParticipantJoinedInOneToOneCall]unable to find particpant ${ke(e.id)}`)}},this.handleRemoteParticipantStateInObservingCall=(e,t,i)=>{const n=t.isLobby;if(8===this.state){const t=n?7:3;e.setState(t,void 0,i)}},this.getTelemetryFromPhaseExecution=e=>{const t={phase:e.phase,phases:e.phases,code:e.error&&e.error.code,subCode:e.error&&e.error.subCode,message:e.error&&e.error.message,error:e.error};return(t.code||t.message)&&delete t.error,t},this._setTransferState=e=>{this.transferState!==e&&(this.logger.info(`Transfer: state set: ${e}`),this._transferState=e,this.callTelemetry.recordEvent("_SetTransferState",{state:e}),this.raiseChanged())},this._setParkState=e=>{this.parkState!==e&&(this.logger.info(`Parking: state set: ${e}`),this._parkState=e,this.callTelemetry.recordEvent("_SetParkState",{state:e}),this.raiseChanged())},this.prepareNegotiationResultForTelemtry=e=>({isComplete:e.isComplete,activeModalities:e.activeModalities,configuredModalities:e.configuredModalities,initiator:ke(e.initiator),attemptedModalities:e.attemptedModalities,offeredModalities:e.offeredModalities}),this.prepareTelemetryForOfferAnswer=e=>e&&e.mediaContent&&{isRenegotiation:!!e.renegotiation,isEscalation:!!e.mediaContent.isTwoPartyToMultiPartyEscalation,mediaTypes:e.mediaTypes,newOffer:e.mediaContent.newOffer},this.updateLocalParticipantEndpoints=e=>{const t=this.logger.createFnLogger("updateLocalParticipantEndpoints",""),i=[];(0,Cr.forEach)(e,(e=>{const t=Tu(e,this.getSelfClientEndpointCapabilities());i.push(t)})),this.endpoints.endpointDetails=i;const n=this.getDataChannelSourceId();-1!==n&&this.dataChannel&&this.dataChannel.setDataChannelSourceId(n),t.info(`selfEndpointDetails=${JSON.stringify(this.endpoints)}`)},this.handleParticipantsMutedUpdated=(e,t)=>{const i=this.logger.createFnLogger("handleParticipantsMutedUpdated",t);if(void 0!==e?.info){this.logger.info(`handleParticipantsMutedUpdated: number of infos: ${Object.keys(e.info).length}`);for(const t of Object.keys(e.info)){const n=this.getParticipant(t);n?n.handleServerMutedInfoUpdate(e.info[t]):i.info(`Cannot find local participant ${ke(t)}`)}}else i.info("Ignored, no mute participant info.")},this.handleSelfUnmuteUpdatedInfo=(e,t)=>{const i=this.logger.createFnLogger("handleSelfUnmuteUpdatedInfo",t);if(void 0!==e?.info)for(const n of Object.keys(e.info)){const r=e.info[n];if(n===this.localSignalingParticipant.id){const e=(0,Cr.find)(r,(e=>e.participantId===this.localSignalingParticipant.participantId));if(void 0===e){i.info(`Cannot find local participant ${ke(n)}`);continue}const s=(0,Cr.find)(this.localSignalingParticipant.endpointDetails,(t=>t.participantId===e.participantId));Hu(this.logger,s,e,!1)&&this.handleSelfServerMutedState(t)}}else i.info("Ignored, no unmute participant info.")},this.state=0,this.terminatedReason=0,this.callStats=new vu(this.mediaAgent?.getConfigProvider()),this.callDeviceManager=this.createCallDeviceManager(),this.callTelemetry=new Sn(this.logger,this._callCreationTime),this.collectMediaStatsDeferred=Ei(),this.setCallId(l),this.setGroupId(a),this.setThreadId(o),this.setMessageId(p),this.setSkypeId(this.currentUserSkypeIdentity.id),this.setParticipantId(d),this.setCallOrigin(0),this.logger=this.logger.createChild((()=>{const e=(this.endpointId||"").substr(0,8),t=(this.participantId||"").substr(0,8);return`Web/${this.instanceNumber}[${this.callId}][${e}][${t}][${this.state}]`})),this._staleRosterCheckFixForPluginless=this.ecsProvider.getEcsConfig("SkypeCalling","staleRosterCheckFixForPluginless"),this._transfereeAcceptanceWithoutWaitingForConv=this.ecsProvider.getEcsConfig("SkypeCalling","transfereeAcceptanceWithoutWaitingForConv"),this._enableMuteAsync=this.ecsProvider.getEcsConfig("SkypeCalling","enableAsyncMute"),this._enableUnmuteAsync=this.ecsProvider.getEcsConfig("SkypeCalling","enableAsyncUnmute"),this.initializeSignalingSession(d),this.signalingSession.setLocationInfo(g,m,S),this.streamManager=new Cp(this.participantId,null,this.callStats.localStats,this.logger),this.mediaAgent&&(this.dataChannel=new Bp(this.logger),this.dataChannel.on("remoteUserEventsReceived",((e,t)=>this.event("remoteUserEventsReceived").raise(e,t))),this.dataChannel.on("onDataChannelStateUpdated",(e=>{"Failed"===e&&(this.logger.error("onDataChannelStateUpdated: datachannel creation failed, will remove data modality"),this.mediaStateConfigurationHelper.removeModality(3),this.updateSignalingDSHMessageSubscription(!0),this.updateMediaModalities())})),this.screenSharingControl=new dg(this.logger,this.dataChannel,this,this.telemetryLoggers,this.ecsProvider),this.initializeMediaControlPlane(),this.mediaAgent.handleSendMidCallTelemetry(this.sendMidCallTelemetry.bind(this)));const v={enableErrorConversion:this.ecsProvider.getEcsConfig("SkypeCalling","enableErrorConversion")};this._deferUsingMicrotask=this.ecsProvider.getEcsConfig("SkypeCalling","deferUsingMicrotask"),Ju.instance.setDeferToQueueMicrotask(this._deferUsingMicrotask),Ju.instance.setLogger(n),this.logger.info(`operationHandlerEcsConfig: ${JSON.stringify(v)}`),this._preferredMpLocation=this.ecsProvider.getEcsConfig("SkypeCalling","preferredMpLocation"),this._isUpdatePropertiesSpecifiedAllowedByEcs=this.ecsProvider.getEcsConfig("SkypeCalling","enableUpdateParticipantsSpecified"),this._enableResolveScreenSharingWhenNegotiationComplete=this.ecsProvider.getEcsConfig("SkypeCalling","enableResolveScreenSharingWhenNegotiationComplete"),this._callOperationHandler=new Wn(this.logger,this.callTelemetry,v,void 0,((e,t)=>{this.preconditions(e,t)})),this._participantOperationHandler=new Wn(this.logger,this.callTelemetry,v),this.setMeetingData(f),this.initializeLiveStreamConfigProvider()}get callMode(){return this._callMode}get callId(){return this._callId}get endpointId(){return this._endpointId}get isHostless(){return this.signalingSession.isHostLessCall}get transferState(){return this._transferState}get parkState(){return this._parkState}get capabilities(){return this._capabilities}get publishedStates(){return this._publishedStates}get dataChannelAdapter(){return this.dataChannel}get participantId(){try{const e=this.signalingSession?.participantManager?.localParticipant?.participantId;this._participantId=e||this._participantId}catch(e){this.logger.error("Error updating participantId")}return this._participantId}get role(){return this.localSignalingParticipant.role}get meetingRole(){return this.localSignalingParticipant.meetingRole}get advancedMeetingRole(){return this.localSignalingParticipant.advancedMeetingRole}get maskedIdentityDetails(){return{isIdentityMasked:this.localSignalingParticipant.isIdentityMasked,maskedIdSeqNumber:this.localSignalingParticipant.maskedIdSeqNumber,maskedId:this.localSignalingParticipant.maskedId}}get participantType(){return this.localSignalingParticipant.participantType}get isMuted(){return 2===this._muteState||3===this._muteState}get tenantId(){return this.localSignalingParticipant.tenantId}get mediaLegId(){return this._mediaLegId}get isIncomingOneOnOneVideoCall(){return this.isOneToOneCall()&&this.isSomeoneStreamingVideo}get mediaStreams(){return this.streamManager.streams}get origin(){return this._origin}get propertyBag(){return this.localSignalingParticipant.propertyBag}get version(){return this.localSignalingParticipant.version}get isAudioStreamConnected(){return this._isAudioStreamConnected}set isAudioStreamConnected(e){this._isAudioStreamConnected!==e&&(this._isAudioStreamConnected=e,this._wasAudioStreamConnected=this._wasAudioStreamConnected||e,this.raiseChanged())}setMeetingRole(e){e!==this.localSignalingParticipant.meetingRole&&(this.logger.info(`changing self role to [${e}]`),this.localSignalingParticipant.meetingRole=e,this.event("meetingRoleUpdated").raise(e))}setAdvancedMeetingRole(e){e!==this.localSignalingParticipant.advancedMeetingRole&&(this.logger.info(`changing self advanced meeting role to [${e}]`),this.localSignalingParticipant.advancedMeetingRole=e,this.event("advancedMeetingRoleUpdated").raise(e))}setParticipantType(e){e!==this.localSignalingParticipant.participantType&&(this.logger.info(`changing self participant user type to [${e}]`),this.localSignalingParticipant.participantType=e,this.event("participantTypeUpdated").raise(e))}setPropertyBag(e){e&&!(0,Cr.isEqual)(e,this.localSignalingParticipant.propertyBag)&&(this.logger.info(`changing self participant property bag to [${e}]`),this.localSignalingParticipant.propertyBag=e,this.event("propertyBagUpdated").raise(e))}setPropertyRosterVersion(e){e!==this.localSignalingParticipant.version&&(this.logger.info(`changing self participant property version to [${e}]`),this.localSignalingParticipant.version=e,this.event("propertyRosterVersionUpdated").raise(e))}setMaskedIdentityDetails(e=!1,t,i){this.localSignalingParticipant.isIdentityMasked===e&&this.localSignalingParticipant.maskedIdSeqNumber===t&&this.localSignalingParticipant.maskedId===i||(this.localSignalingParticipant.isIdentityMasked=e,this.localSignalingParticipant.maskedIdSeqNumber=t,this.localSignalingParticipant.maskedId=i,this.logger.info(`self participant masked identity details updated to [${JSON.stringify(this.maskedIdentityDetails)}]`),this.event("maskedIdentityDetailsUpdated").raise(this.maskedIdentityDetails))}setJoinAsStreamingUser(e){e!==this.joinAsStreamingUser&&(this.logger.info(`setting self join as streaming user to [${e}]`),this.joinAsStreamingUser=e)}get spamRiskLevel(){return this._spamRiskLevel}set spamRiskLevel(e){e&&(this._spamRiskLevel=e)}get spamStirAttestation(){return this._spamStirAttestation}set spamStirAttestation(e){e&&(this._spamStirAttestation=e)}getScreenHandle(e){if(!this.sharedScreenHandle){const t=!!this.mediaSession&&this.mediaSession.getSessionConfig().mediaConfig.simulcastSessionEnabled,i=!!this.mediaSession&&this.mediaSession.getSessionConfig().config.enableAudioSharing&&!this.mediaSession.getSessionConfig().config.requireUserActionForAudioSharing,n=this.mediaStateConfigurationHelper.isSending(0)&&i&&t,r=3===e?.getType()?e?.getDeviceId():void 0,s=this.callDeviceManager.getDeviceManager(wu(2));s.setAudioSharingRequested(n),this.sharedScreenHandle=s.createDevicesHandle({audio:n,sharing:!0},"pluginlessCall:getScreenHandle()",r),this.subscribeOnSharedScreenHandleEvents(this.sharedScreenHandle)}return this.sharedScreenHandle}setCallOrigin(e){this.logger.info(`Set call origin to ${e}`),this._origin=e,this.callTelemetry.setCallOrigin(e),this.callTelemetry.recordEvent("_SetCallOrigin",{origin:e})}setMediaLegId(e){this._mediaLegId=e,this.callStats.setMediaLegId(e)}setCallId(e){this.callTelemetry.setCallId(e),this.callStats.setCallId(e),this._callId=e}setEndpointId(e){this._endpointId=e,this.logger.info(`[endpointId=${Be(this._endpointId)}]`),this.callTelemetry.setEndpointId(e),this.callStats.setEndpointId(e)}setFailureType(e){this.callTelemetry.setFailureType(e),this.failureType=e}setParticipantId(e){this._participantId=e,this.logger.info(`[participantId=${this._participantId}]`),this.callTelemetry.setParticipantId(this.participantId)}setCallerMri(e){this.callerMri=e,this.logger.info(`[callerMri=${ke(this.callerMri)}]`)}setTransferorMri(e){const t=Gh(e);t!==this.transferorMri&&(this.transferorMri=t,this.logger.info(`transferorMri: ${ke(this.transferorMri)}`),this.raiseChanged())}setGroupId(e,t=Re()){this.logger.info(`[${t}][setGroupId] groupId=${ke(e)}`),this.groupId!==e&&(this.groupId=e,this.callTelemetry.setGroupId(e),this.event("groupIdChanged").raise(e))}setMeetingData(e){if(e){if(e.meetingCode&&(!this.meetingData||this.meetingData&&e.meetingCode!==this.meetingData.meetingCode)){const t=e.meetingCode;this.logger.info(`[setMeetingData] meetingCode=${t}`),this.callTelemetry.setMeetingCode(t),this.signalingSession.setMeetingCode(t)}if(e.meetingUrl&&(!this.meetingData||this.meetingData&&e.meetingUrl!==this.meetingData.meetingUrl)){const t=e.meetingUrl.split("?")[0];this.logger.info(`[setMeetingData] meetingUrl=${e.meetingUrl}`),this.callTelemetry.setMeetingUrl(t),this.signalingSession.setMeetingUrl(t)}}this.meetingData=e}setHuddleGroupCall(e){this.isHuddleGroupCall!==!!e&&(this.logger.info(`[setHuddleGroupCall] new isHuddleGroupCall=${e}`),this.isHuddleGroupCall=e,this.callTelemetry.setIsHuddleGroupCall(!0))}setComplianceRecordingContent(e,t){try{if(!(0,Cr.isEqual)(this.complianceRecordingContent,t)){this.complianceRecordingContent=t;const i=t?JSON.stringify(t):"";this.callTelemetry.setComplianceRecordingContentLength(i.length),this.logger.info(`[${e}][setComplianceRecordingContent] complianceRecordingContentLength=${i.length}`)}}catch(t){this.logger.error(`[${e}][setComplianceRecordingContent] ${t}`)}}setThreadId(e,t=Re()){this.threadId!==e&&(this.logger.info(`[${t}][setThreadId] threadId=${Le(e)}`),this.threadId=e,this.callTelemetry.setThreadId(e))}setBackroomThreadId(e,t=Re()){this.backroomThreadId!==e&&(this.logger.info(`[${t}][setBackroomThreadId] backroomThreadId=${Le(e)}`),this.backroomThreadId=e,this.callTelemetry.setBackroomThreadId(e))}setMessageId(e,t=Re()){this.messageId!==e&&(this.logger.info(`[${t}][setMessageId] messageId=${ke(e)}`),this.messageId=e,this.callTelemetry.setMesageId(e))}setSkypeId(e,t=Re()){this.skypeId!==e&&(this.logger.info(`[${t}][setSkypeId]`),this.skypeId=e,this.callTelemetry.setSkypeId(e))}setCallType(e,t){const i=this.logger.createFnLogger("setCallType",t);i.info(`current=${this.callType}, newValue: ${e}`),2!==this.callType||1!==e?e!==this.callType&&(this.callType=e,this.callTelemetry.setCallType(e),2===e&&this.callStats.localStats.call.event(2),this.raiseChanged()):i.logFailure("De-escalating to P2P should not happen!")}setConversationType(e,t){this.logger.createFnLogger("setConversationType",t).info(`current=${this.conversationType}, newValue=${e}`),e!==this.conversationType&&(this.conversationType=e,this.callTelemetry.setConversationType(e),this.raiseChanged())}setCallUsesMixer(e,t){this.callUsesMixer!==!!e&&(this.logger.info(`[${t}][setCallUsesMixer] new value=${e}`),this.callUsesMixer=e,this.callTelemetry.recordEvent("_CallUsesMixer",{newValue:e},t),this.dataChannel.setConfigProviderView(this.mediaSession?.getSessionConfig())),e&&this.mediaControlPlane.start()}setIsEscalationInProgress(e,t){this.logger.info(`[${t}][setIsEscalationInProgress] currentValue=${this.isEscalationInProgress}, newValue=${e}`),this.isEscalationInProgress=e,this.allowScreenSharingControl()&&this.screenSharingControl.setIsEscalationInProgress(e),this.callTelemetry.recordEvent("_EscalationInProgress",void 0,t)}setFromApplicationType(e,t){e&&(this.fromApplicationType=e,this.callTelemetry.recordEvent("_SetFromApplicationType",{fromApplicationType:e},t))}setEnableCaptcha(e){e!==this.localSignalingParticipant.enableCaptcha&&(this.logger.info(`setting self participant to enable captcha to [${e}]`),this.localSignalingParticipant.enableCaptcha=e,this.enableCaptcha=e)}processCallStartOptions(e,t){const i=this.logger.createFnLogger("_ProcessCallStartOptions",t);try{1&e.preheatFlags&&(this.isPreheatEnabled=!0)}catch(e){i.logFailure(e)}}getlocalScreenShareStream(){return(0,Cr.find)(this.localMediaStreams,(e=>2===e.mediaType))}setMeetingLayout(e,t){throw new Error("Method not implemented.")}async selectDevices(e){this.callDeviceManager.isVirtualDeviceEnabled?this.callDeviceManager.selectDevices(e):this.logger.error("allowVirtualDeviceInCall not enabled.")}async getSelectDevices(){return this.callDeviceManager.getSelectedDevices()}createStage(e){throw new Error("Method not implemented.")}updateDisplayName(e){this.logger.info("updating displayName"),this.localSignalingParticipant.displayName=e,this.signalingSession.participantManager.localParticipant.displayName=e}init(e){if(this.logger.info(`init callInitOptions:${He(function(e){const t={mediaPeerType:e.mediaPeerType,threadId:Le(e.threadId)};return $e(e.messageId)&&(t.messageId=e.messageId),$e(e.enableGroupCallMeetupGeneration)&&(t.enableGroupCallMeetupGeneration=e.enableGroupCallMeetupGeneration),$e(e.endpointMetadata)&&(t.endpointMetadata=e.endpointMetadata),$e(e.onBehalfOf)&&(t.onBehalfOf=ke(e.onBehalfOf)),$e(e.onBehalfOfUserDisplayName)&&(t.onBehalfOfUserDisplayName=e.onBehalfOfUserDisplayName),$e(e.emergencyContent)&&(t.emergencyContent=e.emergencyContent),$e(e.isEmergency)&&(t.isEmergency=e.isEmergency),$e(e.broadcastContext)&&(t.broadcastContext=e.broadcastContext),e.meetingInfo&&(t.meetingInfo={tenantId:e.meetingInfo.tenantId,organizerId:ke(e.meetingInfo.organizerId)},$e(e.meetingInfo.meetingType)&&(t.meetingInfo.meetingType=e.meetingInfo.meetingType),$e(e.meetingInfo.replyChainMessageId)&&(t.meetingInfo.replyChainMessageId=e.meetingInfo.replyChainMessageId)),e.transferContext&&(t.transferContext={transferorMri:ke(e.transferContext.transferorMri),targetMri:ke(e.transferContext.targetMri),context:e.transferContext.context},$e(e.transferContext.transferType)&&(t.transferContext.transferType=e.transferContext.transferType)),t}(e))}`),this.signalingSessionCallOptions={teamsMessageId:e.messageId,enableGroupCallMeetupGeneration:e.enableGroupCallMeetupGeneration,meetingInfo:e.meetingInfo,emergencyContent:e.emergencyContent?JSON.parse(e.emergencyContent):void 0,broadcastContext:e.broadcastContext,endpointMetadata:e.endpointMetadata},this.setMessageId(e.messageId),this.onBehalfOfMri=e.onBehalfOf,this.onBehalfOfUserDisplayName=e.onBehalfOfUserDisplayName,e.threadId&&(this.setThreadId(e.threadId),this.signalingSession.setThreadId(e.threadId)),this.groupId&&this.signalingSession.setGroupId(this.groupId),this.signalingSession.setCallOptions(this.signalingSessionCallOptions),e.transferContext){switch(this.logger.info("Transfer: Call.init, set transferContext",Gu(e.transferContext)),this.signalingSession.setTransferContext(e.transferContext.context),e.transferContext.transferType){case 1:this.setCallOrigin(2);break;case 0:this.setCallOrigin(1);break;case 2:this.setCallOrigin(3);break;default:throw new Error(`TransferType: ${e.transferContext.transferType} doesn't have a switch option`)}e.transferContext.context.callAcceptanceCallback?this._transferredCallAcceptanceCallback=e.transferContext.context.callAcceptanceCallback:this.logger.info("[failed]Transfer: Missing transferred call acceptance callback"),e.transferContext.transferorMri&&this.setTransferorMri(e.transferContext.transferorMri)}this.setIsEmergency(!!e.isEmergency),this.raiseChanged()}getIncomingRawAudioStream(){if(!this.mediaSession)throw this.logger.error("can not execute getIncomingRawAudioStream as there is no mediaSession"),new Error("NoMediaSession");return this.mediaSession.getIncomingRawAudioStream()}getUnmixedAudioProvider(){return this.unmixedAudioProvider?Promise.resolve(this.unmixedAudioProvider):Promise.reject("No audio provider available")}setDeviceManager(e){}async startVideo(e,t=Re()){return this.startStopVideo(!0,t)}async stopVideo(e,t=Re()){return this.startStopVideo(!1,t)}async dumpVideoSourceImages(){return Promise.reject(60)}async hold(e,t=Re(),i,n){const r=this.logger.createFnLogger("Hold",t);return r.info(`[Hold][${t}] negotiationTag ${e} hold options: ${He(i)}`),4===this.state?(r.logFailure("Trying to put a call on hold which is already held state, early resolving the promise"),Promise.resolve(void 0)):i?.isLocal?this.localHold(t,i,n):this.holdWithRenegotiate(t,i)}async holdWithRenegotiate(e,t){return this.isValidHoldResumeCallState(this.state)?this.setHold(!0,e,t):(this.logger.logFailure(`[Hold][${e}] Trying to hold a call in an invalid state: ${this.state}`),Promise.reject(`Trying to hold a call in an invalid state: ${this.state}`))}async localHold(e,t,i){return this.isValidHoldResumeCallState(this.state)?this.setHold(!0,e,t,i):(this.logger.logFailure(`[LocalHold][${e}] Trying to hold a call in an invalid state: ${this.state}`),Promise.reject(`Trying to hold a call in an invalid state: ${this.state}`))}async unhold(e,t=Re()){const i=this.logger.createFnLogger("Unhold",t);return 3===this.state?(i.logFailure("Trying to resume a call which is already in connected state, early resolving the promise"),Promise.resolve(void 0)):4===this.state?(i.info(`current hold state ${this.requestedHoldState}`),this.setHold(!1,t)):(i.logFailure(`Trying to resume a call in an invalid state: ${this.state}`),Promise.reject(`Trying to resume a call in an invalid state: ${this.state}`))}canMerge(e,t){const i=e.isOneToOneCall(),n=3===this.state,r=4===e.state,s=i&&n&&r;return this.logger.info(`[${t}][canMerge] Call ${e.callId} isOneToOne ${i} isCallConnected ${n} call.state ${this.state} isMergeOnHold ${r} mergeCall.state ${e.state} CanMerge result: ${s}`),s}async updateEndpointMetadata(e,t=Re()){return this.signalingSession.updateEndpointMetadata(e,t)}async sendDtmfTone(e){if(this.mediaSession){const t=this.toneToString(e);return t?(this.logger.info(`[${kn}][sendDtmfTone]DtmfTone: <omitted>`),Promise.resolve(this.mediaSession.sendDtmf(t))):Promise.reject(new Error("Unsupported DtmfTone"))}return Promise.reject(new Error("no mediaSession"))}async setAudioUsageMode(e){return Promise.reject(60)}async setAudioMidcallConfig(e,t){return Promise.reject(60)}async setAudioMidcallConfigJson(e,t=Re()){if(!e)return Promise.reject(60);rt(e.enableSpatialAudio)&&this.mediaSession?.configureSpatialAudio(e.enableSpatialAudio,t),e.noiseSuppressionMode&&await this.setNoiseSuppressionMode(e.noiseSuppressionMode,e.enableAEC)}async setParticipantSpatialAudioPositions(e,t=Re()){const i=e.map((e=>({sourceId:this.participants.find((t=>t.id===e.participantId))?.audio.id,x:e.x,y:e.y})));return this.mediaSession?.setParticipantSpatialAudioPositions(i,t)}async setNoiseSuppressionMode(e,t){return this.mediaSession.getSessionConfig().config.wasmvqe.enableVqe||this.mediaSession.getSessionConfig().config.wasmdns.enableNoiseSuppression?"Auto"===e?this.mediaSession.getSessionConfig().config.wasmvqe.enableVqe?this.mediaAgent.getDeviceManager().setAudioEffects(this.mediaAgent.getDeviceManager().effectsManager.vqeModeToAudioEffectType(this.mediaSession.getSessionConfig().config.wasmvqe.defaultVqeMode)):this.mediaAgent.getDeviceManager().setAudioEffects(this.mediaAgent.getDeviceManager().effectsManager.vqeModeToAudioEffectType(this.mediaAgent.getDeviceManager().effectsManager.nsModeToVqeMode(this.mediaSession.getSessionConfig().config.wasmdns.noiseSuppressionMode,t))):this.mediaSession.getSessionConfig().config.wasmvqe.enableVqe?this.mediaAgent.getDeviceManager().setAudioEffects(this.mediaAgent.getDeviceManager().effectsManager.vqeModeToAudioEffectType(this.mediaAgent.getDeviceManager().effectsManager.nsModeToVqeMode(e,this.mediaSession.getSessionConfig().config.wasmvqe.enableAec))):this.mediaAgent.getDeviceManager().setAudioEffects(this.mediaAgent.getDeviceManager().effectsManager.vqeModeToAudioEffectType(this.mediaAgent.getDeviceManager().effectsManager.nsModeToVqeMode(e,t))):Promise.resolve()}setInitialTelemetry(e,t,i,n){let r,s,a,o,l;switch(e){case"Subscribe":case"SubscribeWithMeetingData":this.callTelemetry.setDirection("Outgoing"),this.callTelemetry.setSelfParticipantRole("SUBSCRIBE"),i||this.callTelemetry.setOperationVariant(e,"CCWM"),this.signalingSession.setInitialTelemetry(e,{correlationId:this.callId,causeId:n,conversationServiceUrl:i});break;case"Acknowledge":0!==this.state&&8!==this.state&&this.callTelemetry.maybeRecordOperationSuccess(e,{code:4}),this.callTelemetry.setDirection("Incoming"),this.callTelemetry.setSelfParticipantRole("callee"),this.signalingSession.setInitialTelemetry(e,{causeId:n});break;case"JoinCall":case"JoinWithMeetingData":this.callTelemetry.setDirection("Incoming"),this.callTelemetry.setSelfParticipantRole("join"),1&t.callStartOptions.preheatFlags&&this.callTelemetry.setOperationVariant(e,"Preheat"),r=this.telemetryDataFromCallStartOptions(t.callStartOptions),r&&this.callTelemetry.updateOperationData(e,r,n),s=1==(1&t.callStartOptions.muteFlags),a=1==(1&t.callStartOptions.preheatFlags),o={muted:s,isPreheatOnly:a},this.signalingSession.setInitialTelemetry(e,{correlationId:this.callId,causeId:n,conversationServiceUrl:i,joinCallOptions:o,offerGenerationTime:Date.now()-t.callStartTime});break;case"StartCall":case"StartWithMeetingData":this.callTelemetry.setDirection("Outgoing"),this.callTelemetry.setSelfParticipantRole("caller"),1&t.callStartOptions.preheatFlags&&this.callTelemetry.setOperationVariant(e,"Preheat"),r=this.telemetryDataFromCallStartOptions(t.callStartOptions),r&&this.callTelemetry.updateOperationData(e,r,n),l=t.callStartOptions,this.signalingSession.setInitialTelemetry(e,{correlationId:this.callId,causeId:n,conversationServiceUrl:i,callStartOptions:l,offerGenerationTime:Date.now()-t.callStartTime});break;case"StartCallToVoiceMail":case"StartCallWithNudge":case"StartCallAndUnpark":this.callTelemetry.setDirection("Outgoing"),this.callTelemetry.setSelfParticipantRole("caller"),this.signalingSession.setInitialTelemetry(e,{correlationId:this.callId,causeId:n,conversationServiceUrl:i,startCallOptions:t.callStartOptions,offerGenerationTime:Date.now()-t.callStartTime})}}async setHold(e,t,i,n){const r=this.logger.createFnLogger("setHold",t,`hold=${e}`);if(!this.canToggleAudio||this.callHoldResumeDeferred)return Promise.reject(new Error("can not set hold as it is already in progress"));this.callHoldResumeDeferred=Ei(),this.isHoldInProgress=e,this.canToggleAudio=!1,this.canToggleVideo=!1,this.canToggleScreenSharing=!1,this.requestedHoldState=e;const s=()=>{this.canToggleAudio=!0,this.canToggleScreenSharing=!0,this.canToggleVideo=!0};r.info(`start, holdOptions: ${JSON.stringify(i)}`);const a=this.callHoldResumeDeferred.promise,o=e?"Hold":"Unhold",l={debugContent:{clientScenario:this.convertClientScenario(n)}};try{if(e?this.isMuteOnHold=i&&i.isLocal&&5!==this.state:this.prepareModalitiesForResume(t),!this.isMuteOnHold){const e=await this.updateMediaModalities(void 0,t);this.updateMediaState(e,t),this.updateScreenSharingState(e,t)}e&&(this.prepareModalitiesForHold(t),5===this.state&&this.finishCallHoldResume(),this.setCallState(4,t)),this.isMuteOnHold&&this.setMuteOnHold(e,t),s();const n={code:0,subCode:0,phrase:""};this.callTelemetry.recordOperationSuccess(o,n,null,t,l)}catch(i){this.callTelemetry.recordOperationFailure(o,{error:Fe(i)},null,t,l),r.logFailure(i),s(),this.callHoldResumeDeferred?.reject(new Error(`Failed setting hold state to ${e}`)),this.callHoldResumeDeferred=null}return a}transferCall(e){return this.logger.warn("transferCall is deprecated, please use callBlindTransfer instead"),this.callBlindTransfer(e)}callBlindTransfer(e,t=Re(),i){return this.executeCallTransfer(e,t,0,i)}callSafeTransfer(e,t=Re(),i){return this.executeCallTransfer(e,t,0,i)}transferCallToVoicemail(e,t=Re()){return this.executeCallTransfer(e.transferTargetMri,t,2,void 0)}callConsultativeTransfer(e,t=Re(),i,n){const r=this.logger.createFnLogger("ConsultativeTransfer",t),s=e.participants[0],a=s&&s.acceptedBy||s&&s.id;return r.info(`transferTargetParticipantLegId: ${i} targetMri: ${ke(a)}`),this.executeConsultCallTransfer(e.callId,a,i,t,n)}async consultativeTransferWithPickupCode(e,t){const i=this.logger.createFnLogger("ConsultativeTransferWithPickupCode",t);if(i.info(`pickup code: ${e}`),!e||isNaN(Number(e)))return i.info("pickup code cannot be empty"),Promise.reject($n("TransactionDisallowed"));const n=this._callOperationHandler.createPendingOperation("_CallTransferInProgress",void 0,t,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),r=`4:${cn}`,s={unparkContent:{pickupCode:Number(e)}};return this.signalingSession.transferCallAsync(r,"TransferTypeStandard",s,{disableForwardingAndUnanswered:!1},t),n}callRedirect(e,t=Re()){return this.logger.createFnLogger("CallRedirect",t).info(`redirectOptions: ${JSON.stringify(e)}`),this.stopInternal({terminatedReason:75,redirectOptions:e,causeId:t}).then((()=>({code:qn.CallRedirected,subCode:zn.CallRedirectedSuccess,phrase:gr,resultCategories:["Success"]})))}convertParkContext(e){switch(e){case 1:return"sharedLinePark";case 4:return"sharedLineParkV2";case 0:return"teamPark";case 3:return"serverHoldV2";case 5:return"callPark";default:return"serverHold"}}convertClientScenario(e){switch(e){case 0:return"breakoutRoom";case 1:return"musicOnHoldV2";case 2:return"sharedLineAppearanceV2";default:return}}park(e,t=Re()){const i=this.convertParkContext(e);return this.logger.info(`[${t}] [ParkCall] start -  context ${e} parkType ${i}`),5===e?(this.callTelemetry.recordOperation(`${Ls(i)}`,t),this._pendingParkPromise=this._callOperationHandler.createPendingOperation("CallParkV2",void 0,t)):this._pendingParkPromise=this._callOperationHandler.waitForOperation("ParkCall"),"serverHoldV2"!==i&&"callPark"!==i&&this._setParkState(1),this.signalingSession.parkCallAsync(i,t).catch((e=>{this.logger.info(`[${t}] [ParkCall] error in parkCallAsync (synchronous error) : ${Fe(e)}. Hold promise will be rejected by signaling callback`),this.callTelemetry.updateOperationData("ParkCall",{error:Fe(e)},t)})),this._pendingParkPromise}async unpark(e,t){const i=this.convertParkContext(e);return this.logger.info(`[${t}] [UnparkCall] start -  context ${e} parkType ${i}`),this._pendingUnparkPromise=this._callOperationHandler.waitForOperation("UnparkCall"),this.signalingSession.unparkAsync(i,t).catch((e=>{this.logger.info(`[${t}] [UnparkCall] error in unparkAsync (synchronous error) : ${Fe(e)}. Unhold promise will be rejected by signaling callback`),this.callTelemetry.updateOperationData("UnparkCall",{error:Fe(e)},t)})),this._pendingUnparkPromise}getServerHoldLocation(){return this._pendingParkPromise.then((()=>(this.logger.info(`getServerHoldLocation ${this.serverHoldLocation}`),this.serverHoldLocation)))}getParkAdditionalContextJson(){return this._pendingParkPromise.then((()=>(this.logger.info(`getParkAdditionalContextJson ${this.parkAdditionalContextJson}`),this.parkAdditionalContextJson)))}getJoinBlob(){return Promise.resolve(JSON.stringify({conversationUrl:this.signalingSession.getConversationUrl(),conversationId:this.callId}))}getTechnicalInformationJson(){return Promise.resolve(JSON.stringify(this.mediaSession.getCallTechnicalInfo()))}isOneToOneCall(){return 1===this.callType&&1===this.participants.length}setMuteOnHold(e,t){this.mediaSession.muteHold(e,t),e||(this.computeCallState(t),this.isMuteOnHold=!1),this.finishCallHoldResume()}finishCallHoldResume(e){e?this.callHoldResumeDeferred?.reject(e):this.callHoldResumeDeferred?.resolve(),this.isHoldInProgress=!1,this.callHoldResumeDeferred=null}computeCallState(e){let t=3;this._callInLobby?t=10:this.signalingSession.participantManager.localParticipant.isStaging&&(t=13),this.logger.info(`[${e}][computeCallState] the call state will be set to ${t}`),this.setCallState(t,e)}async prepareModalitiesForResume(e){this.mediaStateConfigurationHelper.isSending(1)&&await this.turnOnLocalVideoPreview(e)}async prepareModalitiesForHold(e){await this.turnOffLocalVideoPreview(e)}updateMediaState(e,t){this.setVideoOn(e.video===this.mediaAgent.constants.MEDIA_STATE.sendReceive||e.video===this.mediaAgent.constants.MEDIA_STATE.send,t),this.setAudioOn(e.audio===this.mediaAgent.constants.MEDIA_STATE.sendReceive||e.audio===this.mediaAgent.constants.MEDIA_STATE.send,t)}updateScreenSharingState(e,t){this.setScreenSharingOn(e.sharing===this.mediaAgent.constants.MEDIA_STATE.send,t)}subscribeOnSharedScreenHandleEvents(e){this.sharedHandleSubs=e.on("onStreamStateChanged",((e,t)=>this.onSharingStreamStateChanged(e)))}unsubscribeFromSharedScreenHandleEvents(){this.sharedHandleSubs.dispose(),this.sharedHandleSubs=null}onSharingStreamStateChanged(t){const i=Re();this.logger.info(`[${i}] Sharing stream state moved to ${t}`);const n={mediaType:2,mediaDirection:1,mediaStreamState:e.streamingStatetoMediaStreamState(t)};this.event("mediaStreamStateChanged").raise(n),this.callStats.localStats.screenShare.streamStateChanged(t),"stopped"===t&&(this.canToggleScreenSharing=!0,this.stopScreenSharing(),"screenSharingCall"!==this.conversationType||this.participants.some((e=>3===e.state))||this.stop(!0,i))}async startScreenSharing(e,t,i,n=Re()){this.allowScreenSharingControl()&&(this.screenSharingControl.shutdownControlForViewer(),this.screenSharingControl.initControlForSharer(i));const r=this.logger.createFnLogger("StartScreenSharing",n);return r.info("started"),this.canToggleScreenSharing?this.isScreenSharingOn?(r.logSuccess("Resolving early because screen sharing is already on"),Promise.resolve()):(this.screenSharingRenegotiationDeferred&&(r.logFailure("called before the renegotiation deferred for the previous one has been closed"),this.screenSharingRenegotiationDeferred.resolve()),this.screenSharingRenegotiationDeferred=Ei(),this.callStats.localStats.newSession(2),this.callStats.localStats.screenShare.start(),this.mediaStateConfigurationHelper.isDisabled(2)&&r.info("sharing modality was skipped till now. Adding it now"),this.canToggleScreenSharing=!1,this.callStats.localStats.screenShare.event(0),this.getScreenHandle(e).acquire().then((()=>(r.logSuccess("sharing stream acquired"),this.mediaStateConfigurationHelper.enableModality(2),this.allowDataChannel()&&this.mediaStateConfigurationHelper.enableModality(3),this.updateMediaModalities(void 0,n)))).then((()=>(r.logSuccess("updateMediaModalities done"),this.callStats.localStats.screenShare.negotiationStateChanged("started"),this.setScreenSharingOn(!0,n),this.canToggleScreenSharing=!0,this.screenSharingRenegotiationDeferred.promise))).then((()=>{this.enableControlInjector(),this.callStats.localStats.screenShare.negotiationStateChanged("completed")})).catch((e=>{this.callTelemetry.updateOperationData("StartScreenSharing",{error:Fe(e)},n),this.setScreenSharingOn(!1,n),this.mediaStateConfigurationHelper.removeModality(2),this.canToggleScreenSharing=!0,this.disposeSharingScreenHandle();const t=e.error;throw t&&t.code===qn.GlareError?(this.callStats.localStats.screenShare.negotiationStateChanged("rejected","glare"),r.logFailure("starting screen sharing failure with reason glare")):"ScreenSharingStopped"===e.reason?(this.callStats.localStats.screenShare.negotiationStateChanged("rejected","sharingStopped"),r.logFailure("expectedstarting screen sharing failure with reason stopped")):(this.callStats.localStats.screenShare.negotiationStateChanged("rejected","other"),r.logFailure(e)),e}))):Promise.reject(new Error("cannot start screen sharing"))}async stopScreenSharing(e,t,i=Re()){const n=this.logger.createFnLogger("StopScreenSharing",i);if(n.info("started"),!this.canToggleScreenSharing)return n.logFailure("cannot stop screen sharing"),Promise.reject(new Error("cannot stop screen sharing"));if(!this.isScreenSharingOn&&!this._callOperationHandler.hasPendingOperation("StartScreenSharing"))return n.logFailure("screensharing is not on, ignore this operation"),Promise.resolve();this.screenSharingRenegotiationDeferred&&(this.screenSharingRenegotiationDeferred.reject({reason:"ScreenSharingStopped"}),this.screenSharingRenegotiationDeferred=null),this.mediaStateConfigurationHelper.removeModality(2),this.canToggleScreenSharing=!1;const r=()=>{this.canToggleScreenSharing=!0,this.callStats.localStats.screenShare.stop(),this.disposeSharingScreenHandle(),this.mediaAgent.getDeviceManager().shareSystemSound(!1),this.mediaAgent.getDeviceManager().setAudioSharingRequested(!1)};return this.allowScreenSharingControl()&&this.screenSharingControl.shutdownControlForSharer(),this.updateMediaModalities(void 0,i).then((()=>this.setScreenSharingOn(!1,i))).then(r,(e=>{throw n.logFailure(e),this.callTelemetry.updateOperationData("StopScreenSharing",{error:Fe(e)},i),r(),e}))}async startDataChannel(e,t=Re()){if(!this.allowDataChannel())throw new Error("startDataChannel is disabled since ECS flag prohibits it");this.mediaStateConfigurationHelper.enableModality(3),await this.updateMediaModalities({},t)}async stopDataChannel(e,t=Re()){if(!this.allowDataChannel())throw new Error("stopDataChannel is disabled since ECS flag prohibits it");this.mediaStateConfigurationHelper.removeModality(3),await this.updateMediaModalities({},t)}allowDataChannel(){return this.mediaSession?!!this.mediaSession.getSessionConfig().mediaConfig.simulcastSessionEnabled&&(this.isOneToOnePSTNCall()?this.mediaSession.getSessionConfig().config.enableDataChannelPstn:this.mediaSession.getSessionConfig().config.enableDataChannel):(this.logger.warn("datachannel not allowed as there is no mediaSession"),!1)}isGiveControlEnabled(){const e=this.mediaSession?.getSessionConfig()?.config;return e?e.enableGiveControl:(this.logger.warn("Give take control is not enabled as there is no mediaSession, sessionConfig or sessionConfig.config"),!1)}isInitialSignalingDSHSubscriptionEnabled(){const e=this.mediaSession?.getSessionConfig()?.config;return e?!this.allowDataChannel()||e.enableInitialSignalingDSHSubscription:(this.logger.warn("Initial signaling dsh subscription is enabled as there is no mediaSession, sessionConfig or sessionConfig.config"),!0)}isSignalingDSHFallbackEnabled(){const e=this.mediaSession?.getSessionConfig()?.config;return e?e.enableSignalingDSHFallback:(this.logger.warn("Falling back to Signaling DSH is disabled as there is no mediaSession, sessionConfig or sessionConfig.config"),!0)}allowScreenSharingControl(){return this.screenSharingControl?.isScreenSharingControlEnabled()&&this.allowDataChannel()}updateSignalingDSHMessageSubscription(e){this.signalingSession.updateDominantSpeakerHistoryMessageSubscription(e),e&&this.mediaSession?.getDiagnostics?.().dshDiagnostics.setCurrentActiveStrategy("signaling")}async sendUserEvents(e,t){return this.dataChannel.sendUserEvents(e,t)}async shareSystemSound(e,t=Re()){const i=this.logger.createFnLogger("ShareSystemSounds",t,`shareSystemSound=${e}`);if(!(this.mediaSession&&this.mediaSession.getSessionConfig().mediaConfig.simulcastSessionEnabled&&this.mediaSession.getSessionConfig().config.enableAudioSharing&&this.mediaSession.getSessionConfig().config.requireUserActionForAudioSharing))return i.error("shareSystemSound not allowed"),Promise.reject(60);try{return void this.mediaAgent.getDeviceManager().shareSystemSound(e)}catch{return i.error("shareSystemSound failed with device error"),Promise.reject(58)}}async mute(e=Hi()){return this.isMuted?Promise.reject($n("TransactionDisallowed")):this.muteUnmute(!0,e)}async unmute(e=Hi()){return this._callOperationHandler.hasPendingOperation("_PromotionToRealtime")&&await this._callOperationHandler.waitForOperation("_PromotionToRealtime"),this.muteUnmute(!1,e)}async muteSpeaker(e=Re()){return this.muteUnmuteSpeaker(!0,e)}async unmuteSpeaker(e=Re()){return this.muteUnmuteSpeaker(!1,e)}async muteParticipants(t,i,n=Hi()){const r=this.logger.createFnLogger("MuteParticipants",n,`muteScope=${t}`);r.info(`callParticipants count=${i.length}`);const s=e.convertMuteScope(t);if(void 0===s)return r.logFailure(`Unrecognized ${t}`),Promise.reject(new Error("Unrecognized muteScope"));if(Jh(this.state,[11,12]))return r.logFailure("Can not mute/unmute during preheat call"),Promise.reject(60);const a=[];return i.forEach((e=>{a.push(e.id)})),this.signalingSession.muteAsync(s,a,n).then((e=>this.handleParticipantsMutedUpdated(e,n))).catch((e=>(this.callTelemetry.updateOperationData("MuteParticipants",{error:Fe(e)},n),r.logFailure(e),e?.endCode?Promise.reject(e.endCode):Promise.reject(e))))}async startAudio(e,t=Re()){const i=this.logger.createFnLogger("StartAudio",t);if(this.receiveOnlyAudioOnCallStart=!1,3!==this.state)return i.logFailure("Cannot startAudio when call is not connected"),Promise.reject(60);if(this.mediaStateConfigurationHelper.enableModality(0),this.callUsesMixer&&this.mediaStateConfigurationHelper.removeModality(1),this.mediaStateConfigurationHelper.isSending(1))try{await this.turnOnLocalVideoPreview(t)}catch(e){return i.logFailure(e),Promise.reject(25)}const n=await this.startStopAudio(!0,t);return await this.signalingSession.recordTelemetryForStartAudio(n),{code:n}}async stopAudio(e,t=Re()){const i=this.logger.createFnLogger("StopAudio",t);if(3!==this.state)return i.logFailure("Cannot stopAudio when call is not connected"),Promise.reject(60);this.mediaStateConfigurationHelper.removeModality(0);const n=await this.startStopAudio(!1,t);return await this.turnOffLocalVideoPreview(t),await this.signalingSession.recordTelemetryForStopAudio(n),{code:n}}assimilate(e,t,i,n=Re()){return Promise.reject(new Error("Not implemented"))}async merge(e,t,i=Re()){const n=this.logger.createFnLogger("MergeCall",i);n.error(`merge callId ${e.callId} callMergeOptions ${JSON.stringify(t)}`);const r=this.canMerge(e,i);if(!r)return n.info(`Error. ${Ve(r)}`),Promise.reject($n("TransactionDisallowed"));const s=[];return e.participants.forEach((e=>{s.push(this._callOperationHandler.createPendingOperation("MergeCall",e.id,i))})),(await this.mergeCallByAddParticipantWithReplaces(t,e.participants,e,1,"MergeCall",i,s,void 0))[0]}async mergeParticipants(e,t,i,n,r){const s=this.logger.createFnLogger("MergeParticipants",n),a=[];if(!e)return Promise.reject($n("Invalid callToMerge"));if(0===t.length)return Promise.reject($n("Invalid participantIds"));const o=[];for(const i of t){let t=_c(e,i);if(!t&&Ec(e,i)&&(s.info("found self endpoint, use localSignalingParticipant"),t=this.localSignalingParticipant),t){const e=Hi(),r={id:t.id,participantId:e,replacementParticipantId:i,nonMaskedId:t.nonMaskedId};a.push(r),o.push(this._callOperationHandler.createPendingOperation("MergeParticipant",e,n))}else{const e={code:406,subCode:5201,phrase:`participantLegId ${i} is invalid!`};o.push(Promise.reject($n(e)))}}return this.mergeCallByAddParticipantWithReplaces(i,a,e,3,"MergeParticipant",n,o,r)}async mergeWithPickupCode(e,t,i=Re()){const n=this.logger.createFnLogger("MergeWithPickupCode",i);if(n.info(`mergeWithPickupCode: pickup code: ${e}, groupId: ${ke(t.groupId)}, threadId: ${Le(t.threadId)} messageId: ${t.messageId}`),!e||isNaN(Number(e)))return n.info("mergeWithPickupCode: pickup code cannot be empty"),Promise.reject($n("mergeWithPickupCode: pickup code cannot be empty"));const r={additionalData:t.additionalData,groupId:t.groupId,threadId:t.threadId,messageId:t.messageId,replacementType:2,pickupCode:Number(e)},s={id:`4:${cn}`};return Promise.resolve().then((()=>Promise.all(this.signalingSession.addParticipantsAsync([s],r,i)))).then((e=>(e.length>0&&this.signalingNotifications.onParticipantJoined(e[0],i),Promise.resolve({code:0,subCode:0,phrase:"TransactionComplete"})))).catch((e=>{n.logFailure(`Participant was not added to call, error=${Ve(e)}`);const t=this._handleParticipantOperationFailure("MergeWithPickupCode",e,i,null,!0).reason;return Promise.reject(e?e.endCode:t||0)}))}async setMaxVideoChannels(e){return Promise.reject(60)}async stop(e=!1,t=Re(),i,n){const r=this.logger.createFnLogger("StopAudio",t);if(6===this.state)return r.logFailure("Trying to stop a call which is already Disconnecting"),Promise.reject(new Error("cannot stop call in Disconnecting state"));if(7===this.state)return r.logFailure("Trying to stop a call which is already Disconnected"),Promise.reject(new Error("cannot stop call in Disconnected state"));if(this.disposedPromise)return Promise.reject("Call already ended");let s=0;1===this.state&&(s=10);const a=n?{clientReasonSubCode:n.clientSubCode,clientReasonPhrase:n.clientPhrase}:{};n?.clientSubCode===bn.VDI_DISCONNECTED&&this.mediaSession?.getSessionConfig()?.config.vdiDisconnectedTracking.enabled&&this.mediaSession?.getSessionConfig()?.config.vdiDisconnectedTracking.clientPhrases.includes(n?.clientPhrase)&&(a.code=_n.MEDIA_ERROR,a.subCode=bn.VDI_DISCONNECTED,a.phrase=mr,a.resultCategories=["UnexpectedClientError"],s=4);const o={terminatedReason:s,forEveryone:e,causeId:t,...i,rejectReason:a};return this.stopInternal(o)}publishState(e,t){const i=Fs(e.type),n=this.getPluginlessPublishLevel(e.level),r=e.participantIds&&e.participantIds.length>0?"specified":void 0;return this.callTelemetry.setOperationVariant("PublishState","specified"===r?`${i}Specified`:`${i}None`,t),this.signalingSession.publishStateAsync(i,n,t,e.content,r,e.participantIds)}publishStatesForEveryone(e,t){const i=Fs(e.type),n=this.getPluginlessPublishLevel(e.level);return this.callTelemetry.setOperationVariant("PublishState",`${i}All`),this.signalingSession.publishStateAsync(i,n,t,e.content,"all")}removeState(e,t){return this.signalingSession.removeStateAsync(t,"specified",void 0,e.stateIds).then((e=>Promise.resolve()))}removeStatesForEveryone(e,t){const i=Fs(e.type);return this.signalingSession.removeStateAsync(t,"all",i,void 0).then((e=>Promise.resolve()))}updateMeetingSettings(e,t){return this.signalingSession.updateMeetingSettingsAsync({allowRaiseHands:e.allowRaiseHands,attendeeRestrictions:e.attendeeRestrictions,lockMeeting:e.lockMeeting,breakoutRoomsEnabled:e.breakoutRoomsEnabled,allowPresentersToManageBreakoutRooms:e.allowPresentersToManageBreakoutRooms,disableMdpClientAudioRecording:e.disableMdpClientAudioRecording,refreshSettings:e.refreshSettings},t)}updateMeetingGroups(e,t){this.logger.info(`[UpdateMeetingGroups][${e}] options ${He(t)}`);const i=this._callOperationHandler.waitForOperation("UpdateMeetingGroups",e),n={fromGroup:t.fromGroup,toGroup:t.toGroup,scope:cg(t.scope)};return t.participants&&(n.participants=function(e){const t=[];for(const i in e)if(e[i].participantLegIdMap)for(const n in e[i].participantLegIdMap){const r=e[i].participantLegIdMap[n].endpointId;t.push({id:i,mri:i,participantId:n,...r&&{endpointId:r}})}else t.push({id:i,mri:i});return t}(t.participants)),this.signalingSession.updateMeetingsGroupsAsync(e,n).catch((t=>{this.logger.info(`[${e}] [UpdateMeetingGroups] error in updateMeetingGroups (synchronous error) : ${Fe(t)}. updateMeetingGroupsPromise will be rejected by signaling callback`),this.callTelemetry.updateOperationData("UpdateMeetingGroups",{error:Fe(t)},e)})),i}updateMeetingLiveState(e,t){return this.logger.info(`[UpdateMeetingLiveState][${e}] options ${He(t)}`),this.signalingSession.updateMeetingLiveStateAsync(e,t).catch((t=>{this.logger.info(`[${e}] [UpdateMeetingLiveState] error in updateMeetingLiveState (synchronous error) : ${Fe(t)}. promise will be rejected by signaling callback`),this.callTelemetry.updateOperationData("UpdateMeetingLiveState",{error:Fe(t)},e)})),this._callOperationHandler.waitForOperation("UpdateMeetingLiveState",e)}updateMeetingStates(e,t=Re()){var i;this.logger.info(`[UpdateMeetingStates][${t}]`);const n={},r=[];e.operationId=e.operationId||t;for(const s of Object.keys(e.meetingStates)){const a=e.operationId+"_"+s;r.push(a);const o=this._callOperationHandler.createPendingOperation("UpdateMeetingStates",a,t);n[i=e.operationId]??(n[i]={}),n[e.operationId][s]=o,this.callTelemetry.recordOperation("UpdateMeetingStates",t,a)}return Promise.resolve().then((()=>this.signalingSession.updateMeetingStatesAsync(t,e))).then((e=>{for(const i of r)this.callTelemetry.updateOperationData("UpdateMeetingStates",{data:Fe(e)},t,i)})).catch((e=>{for(const i of r)this.callTelemetry.updateOperationData("UpdateMeetingStates",{error:Fe(e)},t,i);this.logger.logFailure(e)})).then((()=>n))}async updateParticipantInterpretationState(e,t){if(this.logger.info(`[UpdateParticipantInterpretationState][${e}] options ${He(t)}`),0===t.length)return Promise.reject($n("Invalid UpdateParticipantInterpretationState options"));const i=this.signalingSession.updateParticipantInterpretationStateAsync(e,t),n=[];t.forEach((t=>{n.push(this._callOperationHandler.createPendingOperation("UpdateParticipantInterpretationState",t.id,e))}));for(let n=0;n<i.length;n++){const r=i[n],s=t[n];r.then((()=>{this.logger.logSuccess(`updateParticipantInterpretationState succeeded for [id=${ke(s.id)}]`);const t={code:0,subCode:0,phrase:""};this.callTelemetry.recordOperationSuccess("UpdateParticipantInterpretationState",t,s.id,e),this._callOperationHandler.maybeResolveOperation("UpdateParticipantInterpretationState",t,s.id,e)})).catch((t=>{this.logger.error(`[${e}] [UpdateParticipantInterpretationState] error in updateParticipantInterpretationState (synchronous error) : ${Fe(t)}. updateParticipantInterpretationStatePromise will be rejected by signaling callback`),this.callTelemetry.updateOperationData("UpdateParticipantInterpretationState",{error:Fe(t)},e);const i=this._handleParticipantOperationFailure("UpdateParticipantInterpretationState",t,e,s.id).reason,n=t?.endCode||i||0;this._callOperationHandler.maybeRejectOperation("UpdateParticipantInterpretationState",n,s.id,e)}))}return Promise.resolve(n)}async updateParticipantsProperties(e,t){const i=this.logger.createFnLogger("UpdateParticipantsProperties",t);if(i.info(`options ${ke(He(e))}`),!e)return Promise.reject($n("Invalid input: UpdateParticipantsPropertiesContext"));const n={},r=e.scope,s=e.operationId,a=new Set;if("self"===r){const i=this.signalingSession.participantManager.localParticipant.id;for(const r in e.propertyBag){const e=uh(i,s,r),o=this.createUpdateParticipantPromise(e,t);n[e]={[i]:o},a.add(e),this.callTelemetry.recordOperation("UpdateParticipantsProperties",t,ke(e))}}else{if("specified"!==r||!this._isUpdatePropertiesSpecifiedAllowedByEcs)return Promise.reject("This scope is not supported.");{const i=e.participants;for(const e of i){const i=e.id;for(const r in e.propertyBag){const e=uh(i,s,r),o=this.createUpdateParticipantPromise(e,t);n[e]={[i]:o},a.add(e),this.callTelemetry.recordOperation("UpdateParticipantsProperties",t,ke(e))}}}}return i.info(`promises created: ${ke(He(n))}`),this.signalingSession.updateParticipantsPropertiesAsync(e,a,s,t).catch((e=>{const r=Ve(e);i.info(`[failed][reason=${r}]`);const s={...e};this.callTelemetry.updateOperationData("UpdateParticipantsProperties",{error:Fe(r)},t);for(const e of Object.keys(n))this._callOperationHandler.maybeRejectOperation("UpdateParticipantsProperties",s,e,t)})),Promise.resolve().then((()=>n))}joinMeetingGroup(e,t){this.logger.info(`[JoinMeetingGroup][${e}] options ${He(t)}`);const i=this._callOperationHandler.waitForOperation("JoinMeetingGroup",e),n={meetingGroupId:t.meetingGroupId,...t.groupPreferences&&{groupPreferences:t.groupPreferences}};return this.signalingSession.joinMeetingGroupAsync(e,n).catch((t=>{const i=Fe(t);this.logger.info(`[${e}] [JoinMeetingGroup] error in joinMeetingGroup (synchronous error) : ${i}. joinMeetingGroupPromise will be rejected by signaling callback`),this.callTelemetry.updateOperationData("JoinMeetingGroup",{error:i},e)})),i}leaveMeetingGroup(e,t){this.logger.info(`[LeaveMeetingGroup][${e}] options ${He(t)}`);const i=this._callOperationHandler.waitForOperation("LeaveMeetingGroup",e),n={meetingGroupId:t.meetingGroupId};return this.signalingSession.leaveMeetingGroupAsync(e,n).catch((t=>{const i=Fe(t);this.logger.info(`[${e}] [LeaveMeetingGroup] error in leaveMeetingGroup (synchronous error) : ${i}. leaveMeetingGroupPromise will be rejected by signaling callback`),this.callTelemetry.updateOperationData("LeaveMeetingGroup",{error:i},e)})),i}sendMessages(e,t){var i,n;this.logger.info(`[SendMessages][${e}]`);const r={};for(const s of t)if(0===s.scope){const t=this._callOperationHandler.createPendingOperation("SendMessages",s.operationId,e);r[s.operationId]={all:t},this.callTelemetry.recordOperation("SendMessages",e,s.operationId)}else if(1===s.scope)for(const t in s.to)if("participant"===s.to[t].level){const n=ch(t,s.operationId),a=this._callOperationHandler.createPendingOperation("SendMessages",n,e);r[i=s.operationId]??(r[i]={}),r[s.operationId][t]=a,this.callTelemetry.recordOperation("SendMessages",e,n)}else if("endpoint"===s.to[t].level)for(const i in s.to[t].participantLegIdMap){const t=hh(i,s.operationId),a=this._callOperationHandler.createPendingOperation("SendMessages",t,e);r[n=s.operationId]??(r[n]={}),r[s.operationId][i]=a,this.callTelemetry.recordOperation("SendMessages",e,t)}return this.signalingSession.sendProxiedMessageAsync(e,t).then((e=>{for(const t of e)t.then((e=>{this._callOperationHandler.maybeResolveOperation("SendMessages",e.transactionEnd,e.resolveString,e.causeId)})).catch((e=>{this._callOperationHandler.maybeRejectOperation("SendMessages",e.transactionEnd,e.resolveString,e.causeId)}));return r}))}updateMonitorSession(e,t=Re()){return Promise.reject(new Error("Not implemented"))}async updateMeetingRoles(e,t,i=Re()){return 3===this.state&&this.signalingSession.hasOwnProperty("updateMeetingRolesAsync")?this.signalingSession.updateMeetingRolesAsync(e,t,i):Promise.reject({code:_n.CLIENT_ERROR_CODE,subCode:bn.ACTION_NOT_ALLOWED,phrase:"ActionNotAllowed"})}stopInternal(e){const t=this.logger.createFnLogger("stopInternal",e.causeId),i=e.terminatedReason||0;let n=e.rejectReason&&(e.rejectReason.code||e.rejectReason.subCode)?e.rejectReason:this.getRejectionInfoFromTerminatedReason(i);if(e.rejectReason&&(n||(n={}),n.clientReasonSubCode=e.rejectReason.clientReasonSubCode,n.clientReasonPhrase=e.rejectReason.clientReasonPhrase),t.info(`started, terminatedReason=${i}, rejectReason=${He(n)}`),6===this.state)return t.logFailure("Trying to stop a call which is already Disconnecting"),this.disconnectingPromise;if(7===this.state)return t.logFailure("Trying to stop a call which is already Disconnected"),this.disconnectingPromise;this.setCallState(6,e.causeId,i);const r={causeId:e.causeId,forEveryone:e.forEveryone,scope:this.mapEndpointScope(e.scope),redirectOptions:e.redirectOptions&&Iu(e.redirectOptions)};return 1===e.scope&&(n.code=_n.SUCCESS,n.subCode=bn.ENDED_BY_REMOTE_ENDPOINT,n.phrase=pr),this.disconnectingPromise=Promise.all([this.cleanUpMedia(e.causeId,n).catch((e=>{throw t.logFailure(`cleanUpMedia failed with reason=${Ve(e)}`),e})),this.signalingSession.endAsync(n,r).catch((e=>{throw t.logFailure(`endAsync failed with reason=${Ve(e)}`),e}))]).catch((i=>{throw t.logFailure(i),this.cleanUp(e.causeId,n),i})).then((()=>this.cleanUp(e.causeId,n))).catch((t=>{throw this.callTelemetry.updateOperationData("StopCall",{error:Fe(t)},e.causeId),this.setCallState(7,e.causeId,i),t})),this.disconnectingPromise}async cleanUp(e,t){return this.logger.info(`[${e}][cleanup]start`),this.disposedPromise||(this.disposedPromise=this.cleanUpFinalize(e,t),this._getCallEndOperation().catch(En).then((()=>{const t={code:_n.CLIENT_ERROR_CODE,subCode:bn.ABANDONED};this._callOperationHandler.rejectPendingOperations(61,e,t),this._participantOperationHandler.rejectPendingOperations(47,e,t)}))),this.disposedPromise}async cleanUpMedia(e,t){return this.mediaDisposedPromise||(this.mediaDisposedPromise=(async()=>{this.callDeviceManager?.dispose(),this.callDeviceManager=null,this.turnOffLocalVideoPreview(e),this.localVideoContainer=null,this.disposeContentSharingSessions(),this.disposeSharingScreenHandle();const i=this.mediaSession;if(this.reportMediaStats=!!i,!i)return;this.unmixedAudioProvider.dispose(),this.mediaControlPlane.dispose(),this.dataChannel.dispose(),this.screenSharingControl.dispose(e),this.mediaSession=null,this.streamManager.setMediaSession(null,e),this.participants?.forEach((t=>{t.setMediaSession(null,e)}));const n=i.terminate(e,t);this.isVideoOn=!1,this.setMediaStream(this.isVideoOn,!1,1),this.setMediaStream(!1,!1,2),this.setMediaStream(!1,!1,0),this.isScreenSharingOn=!1,this.screenSharingRenegotiationDeferred?.reject(t),this.screenSharingRenegotiationDeferred=null,this.mediaStateConfigurationHelper.removeModality(1),this.mediaStateConfigurationHelper.removeModality(0),this.mediaStateConfigurationHelper.removeModality(3),this.mediaStateConfigurationHelper.removeModality(2),i?.getSessionConfig()?.config?.useOneDsLogger&&i.getSessionConfig().config.addTelemetryReportingCallback&&window.removeEventListener("beforeunload",this.beforeUnloadTelemetrySender);try{await n}finally{await this.collectCallStats(i)}})()),this.mediaDisposedPromise}async cleanUpFinalize(e,t){try{await this.cleanUpMedia(e,t)}catch(t){this.logger.info(`[${e}][cleanUpMedia] failure: ${Ve(t)}`)}const i=this.reportCallEndStats(this.reportMediaStats);this.mediaSession?.getSessionConfig().config.waitReportStatsAtCallStop&&await i}async createContentSharingSession(e,t,i,n,r=Re()){if("attendee"===(this.advancedMeetingRole||this.meetingRole)){const e={terminatedReason:8,terminatedReasonCode:403,terminatedReasonSubCode:0,errorMessage:"Failed due to insufficient permissions"};return Promise.reject(e)}const s=new bp(this.callTelemetry,this.logger,this.signalingSession,e,t,n,i);return this.contentSharingSessions.push(s),s.changed((()=>this.removeContentSessionIfEnded(s))),this.event("contentSharingChanged").raise(),Promise.resolve(s)}stopWithBeacon(e=Re()){return 6===this.state||7===this.state||this.signalingSession.endWithBeacon(e)}disposeContentSharingSessions(){this.contentSharingSessions.forEach((e=>{e.dispose(),this.removeContentSessionIfEnded(e)})),this.event("contentSharingChanged").raise()}isPreheatedOnly(){return!!(12===this.state||2===this.state&&this._callOperationHandler.hasPendingOperation("JoinPreheatedCall")||9===this.state&&this._callOperationHandler.hasPendingOperation("JoinPreheatedCall"))}removeContentSessionIfEnded(e){7!==e.contentSharingStatus&&8!==e.contentSharingStatus||(this.logger.info("stopping the content sharing session."),(0,Cr.remove)(this.contentSharingSessions,(t=>t.contentSharingGuid===e.contentSharingGuid)).length&&this.event("contentSharingChanged").raise())}getRejectionInfoFromTerminatedReason(e){switch(e){case 53:return{code:qn.MediaError,subCode:zn.MediaWhiteListingIssue,phrase:lr};case 4:return{code:qn.MediaError,subCode:this._wasAudioStreamConnected?zn.MediaDropAfterConnect:zn.MediaDropDuringConnect,phrase:this._wasAudioStreamConnected?rr:nr};case 47:return{code:qn.MediaError,subCode:zn.MediaOfferProcessingError,phrase:sr};case 38:return{code:qn.MediaError,subCode:zn.MediaRenegotiationError,phrase:hr};case 10:return{code:qn.Reject,subCode:zn.Success,phrase:ur};case 25:return{code:qn.UnknownError,subCode:zn.MediaUnknownError,phrase:tr};case 58:return{code:qn.MediaError,subCode:zn.MediaPermissionError,phrase:ir};case 7:return{code:qn.UnknownError,subCode:zn.Success,phrase:er};case 0:case 1:return{code:qn.Success,subCode:zn.Success,phrase:ur};case 75:return{code:qn.CallRedirected,subCode:zn.CallRedirectedSuccess,phrase:gr,resultCategories:["Success"]};case 77:return{code:qn.Success,subCode:zn.Suspended,phrase:fr}}return null}async acknowledge(e,t,i=Re()){const n=this.logger.createFnLogger("Acknowledge",i),r=Date.now();if(this.setInitialTelemetry("Acknowledge",{callStartTime:r},"",i),0!==this.state&&8!==this.state)throw new Error(`Trying to acknowledge a call that has already been acted on ${this.state}`);n.info(`isMultiParty=${e.isMultiParty}`),n.info(`fromMixer=${e.fromMixer}`),n.info(`participantId=${e.participantId}`),n.info(`callType=${e.callType}`),this.attachToCallAndGetOffer=Ei(),this.setCallType(e.isMultiParty?2:1,i),this.setCallUsesMixer(!!e.fromMixer,i),this.setCallerMri(Gh(e.callerId)),this.setTransferorMri(e.transferorId),this.transferorType=e.transferorType,this.transferorDisplayName=e.transferorDisplayName,this.incomingCallType=e.callType,this.consultativeCallId=e.consultativeCallId,this.callQueueInfo=e.callQueueInfo,this.setFromApplicationType(e.fromApplicationType,i),this.callStats.localStats.startCall();const s=Kh(n);try{if(s.executeSync("ProcessIncomingCallRequest",(()=>this.signalingSession.processIncomingCallRequest(e,t,i))),this.setParticipantId(this.participantId),s.executeSync("ResolvePotentialConflict",(()=>this.signalingAgent.resolvePotentialCallConflict(this.signalingSession)))===this.signalingSession)return Promise.reject({code:7,success:!1});const r=async()=>{s.executeSync("InitializeMediaSession",(()=>this.initializeMediaSession(i))),this.updateSignalingDSHMessageSubscription(this.isInitialSignalingDSHSubscriptionEnabled());const e=this.signalingSession.getInitialMediaOfferFromIncomingCallPayload();this.callStats.setParticipantId(this.participantId),this.onBehalfOfMri=this.signalingSession.onBehalfOf,this.onBehalfOfUserDisplayName=this.signalingSession.onBehalfOfUserDisplayName,this.callQueueContext=this.signalingSession.callQueueContext,this.callPhoneLineType=this.signalingSession.callPhoneLineType;const t=await s.execute("WaitForMediaOffer",(()=>e?Promise.resolve(e):this.attachToCallAndGetOffer.promise));let r;try{r=await s.execute("ProcessOffer",(()=>this.mediaSession.processOfferAsync(t,i)))}catch(e){r=await this._handleOfferProcessingError(e,i,n)}await s.execute("ProcessOfferedModalities",(()=>this._processOfferedModalities(r,i))),await s.execute("TrySendingProvisionalAnswer",(()=>this._trySendProvisionalMediaAnswer(i)))},a=(()=>s.execute("SendAttach",(()=>this.signalingSession.sendAttachToCall(i))).then((()=>this.setCallState(1,i))))();return await Promise.all([a,r()]).catch((async e=>{throw await a,e})),s.executeSync("OnAcknowledgeSuccess",(()=>this._onAcknowledgeSuccess(n,s.getTelemetryData(),i)))}catch(e){return this._onAcknowledgeError(e,i,n,s.getTelemetryData())}}async accept(e,t=Re()){const i=this.logger.createFnLogger("Accept",t);if(i.info(`accept, answerMediaType: ${e.answerMediaType},\n                            withVideo: ${e.withVideo},\n                            muted: ${e.muted},\n                            getSendMediaModalities: ${JSON.stringify(e.sendMediaModalities)},\n                            clientEndpointCapabilities: ${e.clientEndpointCapabilities},\n                            muteFlags: ${e.muteFlags}`),1!==this.state)throw new Error("Only calls in Notified state can be accepted");this.setCallOptions({callStartOptions:e,callStartTime:Date.now()}),this.setSessionIceTransportPolicy(e?.mediaConfiguration);const n=this._callOperationHandler.createPendingOperation("_ConnectCall",void 0,t);this.callStats.localStats.audio.start();const r=Kh(i);this.mediaSession.createAudioElement(t);const s=e.muted||1==(1&e.muteFlags);this.setMuted(s?2:this.isServerMuted?1:0,t),this.setCallState(2,t),this.connectCallPromise=this._callOperationHandler.waitForOperation("Accept");try{e.forceAudioSendModalityWithNullStream&&this.mediaSession.useNullAudioStreamClient(),this.mediaStateConfigurationHelper.setCallAcceptOptions(e),this.mediaStateConfigurationHelper.isSending(1)&&await r.execute("StartVideoSafe",(()=>this.startVideoSafe(t))),this.mediaStateConfigurationHelper.isSending(0)&&this.setAudioOn(!0,t);const s=await r.execute("UpdateMediaModalities",(()=>this.updateMediaModalities(void 0,t))),a=r.executeSync("GetSignalingMediaTypes",(()=>this.getSignalingMediaTypes(s))),o=await r.execute("evaluateEndpointStatesForAccept",(()=>this.evaluateEndpointStatesForAccept(2===this._muteState,e?.additionalEndpointProperties,t))),l=r.execute("handleEndpointStatesForAccept",(()=>this.handleEndpointStatesForAccept(o,t)));i.info("Queued the handleEndpointStatesForAccept");const d=await r.execute("CreateAnswer",(()=>this.mediaSession.createAnswerAsync(!1,t)));await r.execute("Accept",(()=>this.signalingSession.acceptAsync(d,a,e.clientEndpointCapabilities,t))),await r.execute("WaitForConnect",(()=>n)),this.handleRemoteParticipantStateInOneToOneCall(t),await r.execute("CompleteNegotiation",(()=>this.completeNegotiationAsync(t))),await l,this.callTelemetry.updateOperationData("Accept",{phases:r.getTelemetryData()},t)}catch(e){let n=7,r={};throw this.callTelemetry.updateOperationData("Accept",this.getTelemetryFromPhaseExecution(e),t),e?.error&&(r={...e.error}),qh(vr,e)&&(n=47),this.mediaSession?.getSessionConfig().config.stopCallOnAcceptFailure&&this.stopInternal({terminatedReason:n,causeId:t,rejectReason:r}),e.terminatedReason=n,i.logFailure(e),e}}async reject(e=Re(),t){const i=t?{clientReasonSubCode:t.clientSubCode,clientReasonPhrase:t.clientPhrase}:{};return 1!==this.state?Promise.reject(60):this.stopInternal({terminatedReason:10,causeId:e,rejectReason:i})}async join(e,t={},i=Re()){const n=Date.now();return this.setInitialTelemetry("JoinCall",{callStartOptions:t,callStartTime:n},e.conversationUrl,i),this.setCallerMri(Gh(e.groupCallInitiator)),this.connectCallPromise=this._callOperationHandler.waitForOperation("JoinCall"),this.joinOrStartCall({callStartOptions:Pu(t),callStartTime:n},this.joinGivenConversation,i,e.conversationUrl)}async joinPreheatedCall(e,t){const i=this.logger.createFnLogger("JoinPreheatedCall",t),n=this.isServerMuted||1==(1&e.muteFlags),r=2==(2&e.muteFlags),s=Kh(i);this.connectCallPromise=this._callOperationHandler.waitForOperation("JoinPreheatedCall");try{const i={endpointProperties:{preheatProperties:0}};this.setCallState(2,t),this.isCallModeStreaming()||(n?i.state={isMuted:!0}:(await s.execute("UnmuteInput",(()=>this.mediaSession.unmuteInputAsync(t))),this.setMuted(0,t)),r||(await s.execute("UnmuteOutput",(()=>this.mediaSession.unmuteOutputAsync(t))),this.setSpeakerMuted(!1,t))),await this.signalingSession.updateEndpointState(i,t,e.publishedStates),this.computeCallState(t)}catch(e){const n=7;let r;return i.logFailure(` error: ${n} ${Ve(e)}`),Bn(e)?r=e:zh("UnmuteInput",e)?r={code:qn.LocalError,subCode:zn.MediaUnmuteMicrophoneError,phrase:Ve(e),causeId:t}:zh("UnmuteOutput",e)&&(r={code:qn.LocalError,subCode:zn.MediaUnmuteSpeakerError,phrase:Ve(e),causeId:t}),this.callTelemetry.updateOperationData("JoinPreheatedCall",{phases:s.getTelemetryData(),error:Fe(e)},t),this.stopInternal({causeId:t,terminatedReason:n,rejectReason:r}),Promise.reject(r)}}async start(e={},t=Re()){const i=Date.now();return this.setCallerMri($h+this.currentUserSkypeIdentity.id),this.setInitialTelemetry("StartCall",{callStartOptions:e,callStartTime:i},"",t),this.connectCallPromise=this._callOperationHandler.waitForOperation("StartCall"),this.joinOrStartCall({callStartOptions:Pu(e),callStartTime:i},this.startOutgoingCall,t)}async startCallToVoicemail(e,t=Re()){const i=Date.now();return this.setCallerMri($h+this.currentUserSkypeIdentity.id),this.setInitialTelemetry("StartCallToVoiceMail",{callVoicemailStartOptions:e,callStartTime:i},"",t),this.connectCallPromise=this._callOperationHandler.waitForOperation("StartCallToVoiceMail"),this.joinOrStartCall({callVoicemailStartOptions:e,callStartTime:i},this.startVM,t)}async joinCallWithoutCallModality(e,t={},i=Re()){const n=Date.now();this.setCallerMri(e.groupCallInitiator),this.setCallType(2,i);const r={callStartOptions:Pu(t),callStartTime:n};return this.setInitialTelemetry("Subscribe",r,e.conversationUrl,i),0!==this.state?(this.logger.info(`[${i}][joinCallWithoutCallModality]Trying to subscribe to a call that has already been acted on`),Promise.reject(60)):(this.setCallOptions(r),this.setCallState(8,i),this.signalingSession.subscribeToCall(e.conversationUrl,this.callId,t.clientEndpointCapabilities,{meetingRegistrationId:t.meetingRegistrationId,participantPin:t.participantPin,clientEndpointDebugContent:t.clientEndpointDebugContent,additionalEndpointProperties:t.additionalEndpointProperties},i).catch((e=>Bn(e)?(this.logger.info(`[${i}][joinCallWithoutCallModality] ${Ve(e)}`),Promise.reject(e)):Promise.reject(Cu(e)))),this._callOperationHandler.waitForOperation("Subscribe",void 0,i))}startWithMeetingData(e,t){const i=Date.now();return this.setCallerMri($h+this.currentUserSkypeIdentity.id),this.setInitialTelemetry("StartWithMeetingData",{callStartOptions:t,callStartTime:i},"",e),this.connectCallPromise=this._callOperationHandler.waitForOperation("StartWithMeetingData"),this.joinOrStartCall({callStartOptions:Pu(t),callStartTime:i,meetingPreferences:{shouldResurrect:t.shouldResurrect}},this.startOutgoingCall,e)}joinWithMeetingData(e,t,i){const n=Date.now();return this.setInitialTelemetry("JoinWithMeetingData",{callStartOptions:i,callStartTime:n},t.conversationUrl,e),this.setCallerMri(Gh(t.groupCallInitiator)),this.connectCallPromise=this._callOperationHandler.waitForOperation("JoinWithMeetingData"),this.joinOrStartCall({callStartOptions:Pu(i),callStartTime:n,meetingPreferences:{shouldResurrect:i.shouldResurrect}},this.joinGivenConversation,e,t.conversationUrl)}subscribeWithMeetingData(e,t,i){const n=Date.now();this.setCallerMri(t.groupCallInitiator),this.setCallType(2,e);const r={callStartOptions:Pu(i),callStartTime:n};return this.setInitialTelemetry("SubscribeWithMeetingData",r,t.conversationUrl,e),0!==this.state?(this.logger.info(`[${e}][subscribeWithMeetingData]Trying to subscribe to a call that has already been acted on`),Promise.reject(60)):(this.setCallOptions(r),this.setCallState(8,e),this.signalingSession.subscribeToCall(t.conversationUrl,this.callId,i.clientEndpointCapabilities,{meetingPreferences:{shouldResurrect:i.shouldResurrect},meetingData:this.meetingData,meetingRegistrationId:i.meetingRegistrationId,participantPin:i.participantPin,additionalEndpointProperties:i.additionalEndpointProperties},e).catch((t=>Bn(t)?(this.logger.info(`[${e}][subscribeWithMeetingData] ${Ve(t)}`),Promise.reject(t)):Promise.reject(Cu(t)))),this._callOperationHandler.waitForOperation("SubscribeWithMeetingData",void 0,e))}async startCallWithNudge(e,t={},i=Re()){this.setCallerMri($h+this.currentUserSkypeIdentity.id),this.connectCallPromise=this._callOperationHandler.waitForOperation("StartCallWithNudge");const n=Date.now();var r;if(this.logger.info(`[${i}][startCallWithNudge]startCallWithNudge for participants: ${r=e,r.forEach(ke)}`),this.participants.length)return Promise.reject(48);if(t.isCast&&t.isHuddleGroupCall)return this.logger.logFailure(`isCast: ${t.isCast} isHuddleGroupCall: ${t.isHuddleGroupCall}`),Promise.reject(new Error("isCast or isHuddleGroupCall can only be set exclusively."));const s={};return s.callStartOptions=Pu(t),s.invitationType=Zr.INVITATION_TYPE.NUDGE,s.participantsToNudge=e,s.callStartTime=n,this.setInitialTelemetry("StartCallWithNudge",s,"",i),this.joinOrStartCall(s,this.startOutgoingCall,i)}async startAndUnpark(e,t,i={},n=Re()){this.setCallerMri($h+this.currentUserSkypeIdentity.id);const r=this.logger.createFnLogger("StartCallAndUnpark",n),s=Date.now();this.setInitialTelemetry("StartCallAndUnpark",{callStartTime:s},"",n),r.info(`startAndUnpark for context: ${e}, pickupCode :${t}`),this.connectCallPromise=this._callOperationHandler.waitForOperation("StartCallAndUnpark");const a={};switch(a.callStartOptions=Pu(i),a.pickupCode=t,a.parkContext=cn,e){case 0:a.parkContext=ln;break;case 1:a.parkContext=dn;break;case 5:a.parkContext=hn;break;case 2:a.parkContext=cn;break;default:throw new Error(`[startAndUnpark] unsupported ParkContext name: ${e}`)}return this.addParticipant(`4:${a.parkContext}`).catch((e=>r.logFailure("Failed to add participant to unparked call"))),this.joinOrStartCall(a,this.startOutgoingCall,n)}async admitParticipant(e,t=Re()){const i=Wh(e),n=this.getParticipant(i),r=this._getParticipantLegId(n),s=r?{participantLegId:r}:{};if(n&&7!==n.state){const i={code:0,subCode:3552,phrase:"Participant is not in lobby state"};return this.callTelemetry.maybeRecordOperationSuccess("AdmitParticipant",i,e,t,s),Promise.reject(i)}return this.admitParticipantToCall(i,t,r)}admit(e,t){return this.signalingSession.admitAsync(t)}async callMeBack(e,t,i=Re()){const n=Wh(`${$h}${this.currentUserSkypeIdentity.id}`,this.currentUserSkypeIdentity.sipUri);return this.addCallMeBackParticipant(e,t||n,i)}async addParticipant(e,t={},i=Re()){return(await this.addParticipantsImpl([e],t,i,"addParticipant"))[0]}async addParticipants(e,t={},i=Re()){return this.addParticipantsImpl(e,t,i,"addParticipants")}async addParticipantsImpl(e,t={},i=Re(),n){if(this.logger.info(`[${i}][${n}] start`),this.isEmergency&&0===this.state&&(0!==this.participants.length||1!==e.length))return Promise.reject(new Error("Only 1 participant (the emergency operator) may be added to unstarted emergency calls"));if(t.participantInvitationData)try{JSON.stringify(t.participantInvitationData)}catch(e){throw this.logger.info(`[${i}][${n}] ${e}`),e}const r=[],s=[];if(e.forEach((e=>{const t=this.getOrCreateParticipant(e,i,!0);0===t.state||4===t.state?(s.push(t),r.push(this._participantOperationHandler.createPendingOperation("AddParticipant",t.id,i))):3===t.state?r.push(Promise.resolve(t)):this._participantOperationHandler.hasPendingOperationWithOperationId("AddParticipant",t.id)&&r.push(this._participantOperationHandler.waitForOperation("AddParticipant",t.id))})),0===s.length)return Promise.resolve(r);const a=!!t.disableUnmute,o=this.addParticipantsToCall(s,i,t.participantInvitationData,t.groupId,t.threadId,t.messageId,a,t.alternateId);return(0,Cr.zip)(o,s).forEach((async([e,t])=>{try{await e;const n=this._getParticipantLegId(this.getParticipant(t.id)),r=n?{participantLegId:n}:{};this.callTelemetry.recordOperationSuccess("AddParticipant",{code:0,subCode:0,phrase:""},t.id,i,r),this._participantOperationHandler.maybeResolveOperation("AddParticipant",t,t.id,i)}catch(e){this._participantOperationHandler.maybeRejectOperation("AddParticipant",e,t.id,i)}})),this.raiseChanged(this._participantChangedEventSkipConfig),Promise.resolve(r)}async nudgeParticipants(e,t,i={},n=Re()){return 2!==this.state&&3!==this.state?Promise.reject(48):this.signalingSession.nudgeParticipantsAsync({participantsIds:t,causeId:n,invitationData:i.participantInvitationData,newGroupId:i.groupId,newThreadId:i.threadId,newMessageId:i.messageId})}mapEndpointScope(e){let t="none";switch(e){case 0:t="specified";break;case 1:case 1:t="all";break;default:t="none"}return t}async removeParticipant(e,t=Re(),i,n){const r=this.logger.createFnLogger("removeParticipant",t);r.info("start");const s=this.mapEndpointScope(n);return this.signalingSession.removeParticipantAsync({id:e,endpointId:i},t,s).catch((i=>{r.logFailure(`Participant was not removed from call, error=${i}`);const n=this._handleParticipantOperationFailure("RemoveParticipant",i,t,e).reason;return Promise.reject(n||38)}))}async searchParticipants(e,t){return this.signalingSession.searchParticipantsAsync(e.searchQueryOptions,t)}async getAllParticipants(e,t){return this.signalingSession.getAllParticipantsAsync(e.scope,t)}set dominantSpeakerInfo(e){this.internalDominantSpeakerInfo=e}get dominantSpeakerInfo(){return this.internalDominantSpeakerInfo?this.internalDominantSpeakerInfo:this.mediaSession?.getSessionConfig().config.emptyInitialDSH?{speakerList:[],timestamp:null,noCurrentDominantSpeaker:!1}:{speakerList:this.participants.filter((e=>3===e.state)).map((e=>e.id)),timestamp:null,noCurrentDominantSpeaker:!1}}set slowedDownActiveTalkerInfo(e){(0,Cr.isEqual)(this.internalSlowedDownActiveTalkerInfo?.speakerList,e.speakerList)||(this.internalSlowedDownActiveTalkerInfo=e,this.raiseChanged())}get slowedDownActiveTalkerInfo(){return this.internalSlowedDownActiveTalkerInfo}startVideoSafe(e){return this.startVideo(e).catch((t=>{this.logger.info(JSON.stringify(t),"startVideoSafe",e)}))}async joinOrStartCall(e,t,i,n){const r=this.logger.createFnLogger("joinOrStartCall",i);if(0!==this.state&&8!==this.state&&!e.isPromotingToRealtime){const e="Trying to start a call that has already been acted on";return r.logFailure(e),Promise.reject(60)}if(this.signalingAgent.resolvePotentialCallConflict(this.signalingSession)===this.signalingSession)return Promise.reject(57);this.callStats.localStats.startCall();const s=8===this.state||1!==this.participants.length;r.info(`isMultiparty=${s}, reason: participants.length=${this.participants.length}`),this.setCallType(s?2:1,i),this.setCallUsesMixer(s,i),this.setCallOptions(e);const a=e.callStartOptions||{};if(1==(1&a.preheatFlags))this.setMuted(2,i),this.setSpeakerMuted(!0,i),this.setCallState(11,i);else{const e=!!a&&(a.muted||1==(1&a.muteFlags));this.setMuted(e?2:this.isServerMuted?1:0,i),this.setCallState(2,i)}const o=((e,t,i,n,r)=>{if(e){if(e.meetingUrl)return"MeetingUrl";if(e.meetingCode)return"MeetingCode"}return t||i?"ThreadContext":n?"GroupId":r?"Awareness":""})(this.meetingData,this.threadId,this.messageId,this.groupId,!!n);this.callTelemetry.setJoinedFrom(o),this.signalingSession.setJoinedFrom(o),this.setHuddleGroupCall(!!e.callStartOptions?.isHuddleGroupCall);const l=this._callOperationHandler.createPendingOperation("_ConnectCall","",i);return l.catch(En),await this.joinOrStartWithMedia(e,t,e.callStartTime,l,i,n),e.callStartOptions?.meetingRegistrationId&&this.callTelemetry.setHasMeetingRegistrationId(!0),e.callStartOptions?.participantPin&&this.callTelemetry.setHasParticipantPin(!0),l}setSessionIceTransportPolicy(e){const t=e?.connectionType;let i=tt.ICE_TRANSPORT_POLICY.all;switch(t){case"AllSupported":i=tt.ICE_TRANSPORT_POLICY.all;break;case"NoDirectConnection":i=tt.ICE_TRANSPORT_POLICY.relay}this.mediaSession?.getSessionConfig().setIceTransportPolicy?.(i)}async joinOrStartWithMedia(e,t,i,n,r,s){const a=this.logger.createFnLogger("joinOrStartWithMedia",r);this.callStats.localStats.audio.start();const o=e.callStartOptions,l=o&&1&o.preheatFlags,d=Kh(a);if(e.callStartOptions?.sendMediaModalities&&(this.mediaStateConfigurationHelper=new Au(e.callStartOptions.sendMediaModalities)),this._preferredMpLocation){e.callStartOptions=e.callStartOptions||{};const t=e.callStartOptions.clientEndpointDebugContent?JSON.parse(e.callStartOptions.clientEndpointDebugContent):{};e.callStartOptions.clientEndpointDebugContent=JSON.stringify({preferredMpLocation:this._preferredMpLocation,...t})}try{o&&!l&&this.mediaStateConfigurationHelper.isInactiveOrDisabled(0)&&this.mediaStateConfigurationHelper.isSending(2)&&(this.setCallUsesMixer(!0,r),await this.getScreenHandle().acquire()),this.mediaStateConfigurationHelper.isSending(0)&&this.setAudioOn(!0,r),this.callUsesMixer||this.mediaStateConfigurationHelper.disableModality(2),a.info(`skipSharingModality=${!this.callUsesMixer}`),d.executeSync("InitializeMediaSession",(()=>this.initializeMediaSession(r))),this.updateSignalingDSHMessageSubscription(this.isInitialSignalingDSHSubscriptionEnabled()),this.mediaSession.getSessionConfig().config.alwaysNegotiateDataChannel&&this.mediaStateConfigurationHelper.enableModality(3),this.setSessionIceTransportPolicy(e?.callStartOptions?.mediaConfiguration),this.mediaSession.createAudioElement(r),this.callUsesMixer||s||this.isOneToOnePSTNCall()||e.callVoicemailStartOptions||(this.isSomeoneStreamingVideo=!0);const c=this._callOperationHandler.createPendingOperation("_WaitForAnswer","",r,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]});c.catch(En);let h=!1;e.isPromotingToRealtime?(this.isSpeakerMuted=!0,h=!0,await d.execute("MuteInput",(()=>this.mediaSession.muteInputAsync(r))),await d.execute("MuteOutput",(()=>this.mediaSession.muteOutputAsync(r)))):o&&(l?(h=!0,await d.execute("MuteInput",(()=>this.mediaSession.muteInputAsync(r))),await d.execute("MuteOutput",(()=>this.mediaSession.muteOutputAsync(r))),this.setMuted(2,r),this.setCallUsesMixer(!0,r)):this.mediaStateConfigurationHelper.isSending(1)&&await d.execute("StartVideoSafe",(()=>this.startVideoSafe(r)))),o?.forceAudioSendModalityWithNullStream&&this.mediaSession.useNullAudioStreamClient();const u=await d.execute("UpdateMediaModalities",(()=>this.updateMediaModalities(void 0,r))),p=await d.execute("CreateOffer",(()=>this.mediaSession.createOfferAsync(r))),g=d.executeSync("GetSignalingMediaTypes",(()=>this.getSignalingMediaTypes(this.calculateModalityDirections({},r))));if(this.mediaStateConfigurationHelper.isSending(2)&&this.updateScreenSharingState(u,r),h||(await d.execute("MuteUnmute",(()=>this.muteUnmute(2===this._muteState,r))),await d.execute("MuteUnmuteSpeakers",(()=>this.muteUnmuteSpeaker(this.isSpeakerMuted,r)))),d.executeSync("CallStart",(()=>t(r,e,p,g,i,s))),await d.execute("WaitForConnect",(()=>n)),!this.isCallModeStreaming()||e.isPromotingToRealtime){const e=await d.execute("WaitForAnswer",(()=>c));if(!this.mediaSession?.processAnswerAsync)throw{error:"NoMediaSession",phase:"ProcessAnswer"};await d.execute("ProcessAnswer",(()=>this.mediaSession.processAnswerAsync(e,r,!1))),await d.execute("CompleteNegotiation",(()=>this.completeNegotiationAsync(r)))}this.callTelemetry.updateOperationData("_ConnectCall",{phases:d.getTelemetryData()},r),2!==o?.screenshareDirection&&4!==o?.screenshareDirection||(this.screenSharingControl.initControlForSharer(""),this.enableControlInjector())}catch(e){this.catchJoinOrStartCallError(e,r,a,d.getTelemetryData())}}catchJoinOrStartCallError(e,t,i,n){let r,s=0;throw i.logFailure(Ve(e)),e?.error&&(r={...e.error}),zh("MuteInput",e)?(s=7,r={code:qn.LocalError,subCode:zn.MediaMuteMicrophoneError,phrase:Ve(e),causeId:t}):zh("MuteOutput",e)?(s=7,r={code:qn.LocalError,subCode:zn.MediaMuteSpeakerError,phrase:Ve(e),causeId:t}):e?.type===this.mediaAgent.constants.MEDIA_ERROR.incompatibleOffer||qh(vr,e)?s=47:e?.type===this.mediaAgent.constants.MEDIA_ERROR.permissionDeniedError?(s=58,r={code:qn.MediaError,subCode:zn.MediaPermissionError,phrase:Ve(e),causeId:t}):zh("WaitForAnswer",e)||zh("WaitForConnect",e)?s=e.error:qh(Sr,e)&&(s=7),this.callTelemetry.updateOperationData("_ConnectCall",this.getTelemetryFromPhaseExecution(e),t),this.callSetupFailed=!0,Promise.all([this._callOperationHandler.maybeRejectOperation("_WaitForAnswer",s,"",t),this._callOperationHandler.maybeRejectOperation("_ConnectCall",s,"",t)]).then((()=>{this.isPromotingToRealtime()||this.stopInternal({causeId:t,terminatedReason:s,rejectReason:r})})).catch(En),s}addCallMeBackParticipant(e,t,i){const n=this._participantOperationHandler.waitForOperation("CallMeBack",e),r=this.logger.createFnLogger("CallMeBack",i),s={id:e,assertedId:t};return this.signalingSession.callMeBackAsync(s).then((()=>{r.logSuccess(`successfully executed call me back, participantId = ${ke(e)}`),this._participantOperationHandler.resolveOperation("CallMeBack",0,e)})).catch((n=>{r.logFailure(`Call me back failed, participantId = ${ke(e)}, error = ${n}`),this._handleParticipantOperationFailure("CallMeBack",n,i,t,!1);const s=this._processError(n);let a={};s&&(a={...s}),a.failureReason=s.reason?s.reason:11,this._participantOperationHandler.rejectOperation("CallMeBack",a,e)})),n}addParticipantsToCall(e,t,i,n,r,s,a,o){const l=this.logger.createFnLogger("addParticipantsToCall",t);e.forEach((e=>{e.setState(1,void 0,t)}));const d=e.map((e=>({id:e.mri})));l.info(`participantIds=${e.map((e=>ke(e.id)))}, disableUnmute=${a}`);const c={additionalData:i,groupId:n,threadId:r,messageId:s,disableUnmute:a,alternateId:o};try{const e=this.signalingSession.addParticipantsAsync(d,c,t);return(0,Cr.zip)(e,d).map((async([e,i])=>{try{const n=await e;this.signalingNotifications.onParticipantJoined(n,t);const r=this._getParticipantLegId(this.getParticipant(i.id)),s=r?{participantLegId:r}:{};this.callTelemetry.recordOperationSuccess("AddParticipant",{code:0,subCode:0,phrase:""},n.id,t,s)}catch(e){const n=this._handleParticipantOperationFailure("AddParticipant",e,t,i.id).reason;throw this._removeParticipant(i,t,n),n}}))}catch(e){return l.logFailure(`Participants was not added to call, error=${e}`),(0,Cr.range)(d.length).map((()=>Promise.reject(1)))}}async mergeCallByAddParticipantWithReplaces(e,t,i,n,r,s,a,o){const l=this.logger.createFnLogger("mergeCallByAddParticipantWithReplaces",s),d=this.convertClientScenario(o),c={additionalData:e.additionalData,groupId:e.groupId,threadId:e.threadId,messageId:e.messageId,callIdToReplace:i.callId,replacementType:n,clientScenario:d},h=await this.signalingSession.addParticipantsAsync(t,c,s);for(let e=0;e<h.length;e++){const i=3===n?t[e].participantId:t[e].id;try{await h[e],l.logSuccess(` [participantInfos id =${ke(t[e].id)}]`);const n={debugContent:{replacementParticipantLegId:t[e].replacementParticipantId||void 0,clientScenario:d},participantLegId:t[e].participantId},a={code:0,subCode:0,phrase:""};this.callTelemetry.recordOperationSuccess(r,a,i,s,n),this._callOperationHandler.maybeResolveOperation(r,a,i,s)}catch(n){l.logFailure(`Participant was not added to call, error=${He(n)}`);const a=this._handleParticipantOperationFailure(r,n,s,i,!0,d).reason;this._removeParticipant(t[e],s,a);const o=n?n.endCode:a||0;this._callOperationHandler.maybeRejectOperation(r,o,i,s)}}return Promise.resolve(a)}admitParticipantToCall(e,t,i){const n=this.logger.createFnLogger("admitParticipantToCall",t),r={id:e};return n.info("start"),this.signalingSession.admitParticipantAsync(r,t).then((r=>{n.info(`successfully admitted participant to call, participantId = ${ke(e)}`);const s=i?{participantLegId:i}:{};this.callTelemetry.recordOperationSuccess("AdmitParticipant",{code:0,subCode:0,phrase:""},e,t,s)})).catch((i=>{n.logFailure(`Participant was not admitted to call, error=${i}`);const r=this._handleParticipantOperationFailure("AdmitParticipant",i,t,e);return Promise.reject(r)}))}_processError(t){let i;const n={reason:i};if(t?.endCode){const r=Eu(t.endCode.code,t.endCode.subCode);i=e.getParticipantReasonFromTerminatedReason(r),n.reason=i,n.code=t.endCode.code,n.subCode=t.endCode.subCode,n.resultCategories=t.endCode.resultCategories,n.phrase=t.endCode.phrase}else n.phrase=`${t}`;return this.logger.info(`_processError error=${t} telemetryData=${JSON.stringify(n)}`),n}_handleParticipantOperationFailure(e,t,i,n,r=!0,s){this.callTelemetry.updateOperationData(e,{error:Fe(t)},i,n);const a=this._processError(t),o=this.getParticipant(n);a.code&&o&&(o.callEndDiagnosticsInfo={callControllerCode:a.code,callControllerSubCode:a.subCode,phrase:a.phrase,resultCategories:a.resultCategories});try{if(r){const t={debugContent:{clientScenario:s},participantLegId:this._getParticipantLegId(o)||void 0};this.callTelemetry.recordOperationFailure(e,a,n,i,t)}}catch(e){this.logger.info(`_handleParticipantOperationFailure errow during recordOperationFailure ${e}`)}return a}_getParticipantLegId(e){return(0,Cr.has)(e,"endpoints.endpointDetails")&&e.endpoints.endpointDetails.length&&e.endpoints.endpointDetails[0].participantId?e.endpoints.endpointDetails[0].participantId:null}isOneToOnePSTNCall(){const e=this.signalingSession.isIncomingCall?this.callerMri:this.participants.length>0?this.participants[0].id:"";return this.isOneToOneCall()&&(0,Cr.startsWith)(e,jh)&&(!this.incomingCallType||!this.callUsesMixer)}isParkedCall(){return this.isOneToOnePSTNCall()&&!!this.callOptions?.parkContext}async updateMediaModalities(e={},t=Re()){let i;const n=this.logger.createFnLogger("updateMediaModalities",t);return n.info(`callUsesMixer=${this.callUsesMixer},isSomeoneSharing=${this.isSomeoneSharing},isSomeoneStreamingVideo=${this.isSomeoneStreamingVideo}`),n.info(`options=${He(e)},requestHoldState=${this.requestedHoldState},requestedScreenSharingState=${this.mediaStateConfigurationHelper.isSending(2)}`),i=e.modalityOverride?e.modalityOverride:this.requestedHoldState&&!this.isMuteOnHold?this.getMediaModalitiesForHold(t):this.calculateModalityDirections(e?.offered,t),n.info(`modalities=${He(i)}`),await this.mediaSession.configureModalitiesAsync(i,t),i}calculateModalityDirections(e={},t){const i=this.logger.createFnLogger("calculateModalityDirections",t);i.info(`callUsesMixer=${this.callUsesMixer}, isEscalationInProgress=${this.isEscalationInProgress}`);const n={audio:this.calculateAudioDirection(e.audio,i),video:this.calculateVideoDirection(e.video,i),sharing:this.calculateSharingDirection(e.sharing,i),data:this.calculateDataDirection(e.data,i)};return i.info(`done, modalities=${He(n)}`),this.deleteExtraneousModalities(n,t),n}calculateAudioDirection(e,t){return t.info(`calculateAudioDirection, offer=${e}, requestedAudioState=${this.mediaStateConfigurationHelper.isSending(0)}`),this.receiveOnlyAudioOnCallStart?(t.info("calculateAudioDirection, direction=recvonly, receiveOnlyAudioOnCallStart=true"),"recvonly"):this.mediaStateConfigurationHelper.isInactiveOrDisabled(0)||"inactive"===e?"inactive":this.mediaSession.getAllowedModalities().audio.some((e=>e===Qu||e===Zu))?"sendrecv":"sendonly"===e?"inactive":"recvonly"}calculateVideoDirection(e,t){const i=this.mediaStateConfigurationHelper.isSending(1);if(t.info(`calculateVideoDirection, offer=${e}, requestedVideoState=${i}, isSomeoneStreamingVideo=${this.isSomeoneStreamingVideo}`),this.mediaStateConfigurationHelper.isInactiveOrDisabled(0))return"inactive";let n=i,r=this.isSomeoneStreamingVideo||this.callUsesMixer||this.isEscalationInProgress;return e&&(n=n&&("sendrecv"===e||"sendonly"===e),r=r&&("sendrecv"===e||"recvonly"===e)),n?"sendrecv":r?"recvonly":"inactive"}calculateSharingDirection(e,t){return t.info(`calculateSharingDirection, offer=${e}, requestedScreenSharingState=${this.mediaStateConfigurationHelper.isSending(2)}, isSomeoneSharing=${this.isSomeoneSharing}`),"inactive"===e?"inactive":this.mediaStateConfigurationHelper.isSending(2)?"sendonly":this.isSomeoneSharing||this.callUsesMixer||this.isEscalationInProgress?"recvonly":void 0}calculateDataDirection(e,t){const i=this.mediaStateConfigurationHelper.isSending(3);if(t.info(`calculateDataDirection, offer=${e}, dataEnabled=${i}`),this.allowDataChannel())return i?"inactive"===e?"inactive":"sendrecv":void 0;t.info("calculateDataDirection, disabling data since ECS flag prohibits it")}getMediaModalitiesForHold(e){this.logger.info(`[${e}][getMediaModalitiesForHold]`);const t="inactive",i={audio:t,video:t,data:this.allowDataChannel()?t:void 0,sharing:t};return this.deleteExtraneousModalities(i,e),i}deleteExtraneousModalities(e,t){!Ag(e.video)&&this.mediaStateConfigurationHelper.isDisabled(1)&&(this.logger.info(`[${t}][deleteExtraneousModalities] skipping videoModality`),delete e.video),!Ag(e.sharing)&&this.mediaStateConfigurationHelper.isDisabled(2)&&(this.logger.info(`[${t}][deleteExtraneousModalities] skipping sharingModality`),delete e.sharing)}getSignalingMediaTypes(e){const t=[];return e.audio&&e.audio!==this.mediaAgent.constants.MEDIA_STATE.inactive&&t.push("Audio"),(e=>e===this.mediaAgent.constants.MEDIA_STATE.send||e===this.mediaAgent.constants.MEDIA_STATE.sendReceive)(e.video)&&t.push("Video"),e.sharing===this.mediaAgent.constants.MEDIA_STATE.send?t.push("ScreenSharer"):e.sharing===this.mediaAgent.constants.MEDIA_STATE.receive&&t.push("ScreenViewer"),t}enableControlInjector(){if(this.allowScreenSharingControl())if(this.getlocalScreenShareStream()){const e=this.mediaSession?.getLocalMediaTrackId("ScreenShare")??"";this.screenSharingControl.enableControlInjector(e)}else this.logger.warn("enableControlInjector: no local screenshare stream found")}createCallDeviceManager(){return new cm(this.mediaAgent.getConfigProvider().config.allowVirtualDeviceInCall,this.mediaAgent.getDeviceManager(),this.logger.createChild("CallDeviceManager"),this.callStats,(e=>this.isMediaSending(e)))}initializeSignalingSession(t){if(this.signalingSession)return void this.logger.info("Session already exists!");const i=Zr.CALL_STATUS;if(this.localSignalingParticipant={id:Wh(`${$h}${this.currentUserSkypeIdentity.id}`,this.currentUserSkypeIdentity.sipUri),displayName:this.currentUserSkypeIdentity.displayName,endpointDetails:[],languageId:null,participantId:t,endpointId:null},this.accountConfiguration){if(this.localSignalingParticipant.applicationType=this.accountConfiguration.applicationType,this.callTelemetry.setApplicationType(this.accountConfiguration.applicationType),this.localSignalingParticipant.ring=this.accountConfiguration.ring,this.callTelemetry.setRing(this.accountConfiguration.ring),this.localSignalingParticipant.region=this.accountConfiguration.region,this.callTelemetry.setRegion(this.accountConfiguration.region),this.localSignalingParticipant.userHexCID=this.accountConfiguration.userHexCID,this.callTelemetry.setUserHexCID(this.accountConfiguration.userHexCID),this.localSignalingParticipant.partition=this.accountConfiguration.partition,this.callTelemetry.setPartition(this.accountConfiguration.partition),this.localSignalingParticipant.acsResourceId=this.accountConfiguration.acsResourceId,this.callTelemetry.setAcsResourceId(this.accountConfiguration.acsResourceId),this.callStats.setAcsResourceId(this.accountConfiguration.acsResourceId),this.accountConfiguration.serviceUrls){const e=this.accountConfiguration.serviceUrls.calling_conversationServiceUrl,t=this.accountConfiguration.serviceUrls.calling_uploadLogRequestUrl;this.signalingAgent.updateUrls(e,t,this.accountConfiguration.enforceUrls)}this.localSignalingParticipant.clientType=this.accountConfiguration.clientType,this.callTelemetry.setClientType(this.accountConfiguration.clientType)}this.callStats.localStats.setLocalUserId(this.localSignalingParticipant.id),this._callOperationHandler&&this._callOperationHandler.resetOperationChain(),this.signalingNotifications={onPromotionCompleted:(e,t,i)=>{this.logger.info(`[${i}][onPromotionCompleted] isFailed=${e} reason=${He(t)} callMode=${this.callMode}`);const n=e?t:{code:0,subCode:0};if(this.callTelemetry.recordEvent("PromotionCompleted",{reason:n},i),e){const e=Cu(t);this._callOperationHandler.maybeRejectOperation("_WaitForAnswer",e,"",i),this._callOperationHandler.maybeRejectOperation("_CallStartOrJoinInitiated",e,"",i),this._callOperationHandler.maybeRejectOperation("_ConnectCall",e,"",i),this.promotionCompletedDeferred?.reject(e)}else this._callOperationHandler.maybeResolveOperation("_CallStartOrJoinInitiated",void 0,void 0,i),this._callOperationHandler.maybeResolveOperation("_ConnectCall",void 0,void 0,i);this.participants.forEach((e=>{e.applyCachedMediaStreams(i)}))},onCallStatusChanged:(e,t,n=Re())=>{const r=this.logger.createFnLogger("onCallStatusChanged",n);let s=`[status=${e}]`;if(t&&(s+=`[reason=${He(t)}]`,void 0!==t.code&&(this.callEndDiagnosticsInfo={callControllerCode:t.code,callControllerSubCode:t.subCode,phrase:t.phrase,resultCategories:t.resultCategories},(t.overflowJoinInformation||t.registrationInformation)&&(this.callEndDiagnosticsInfo.additionalDiagnostics={overflowInformation:t.overflowJoinInformation,registrationInformation:t.registrationInformation}))),r.info(s),this.callTelemetry.recordEvent("_SignalingStateChanged",{status:e,reason:t},n),e===i.CONNECTING)!this._transfereeAcceptanceWithoutWaitingForConv&&this._transferredCallAcceptanceCallback&&(r.info("[Transfer] Invoke call acceptance callback for original call"),this._transferredCallAcceptanceCallback()),this._callOperationHandler.maybeResolveOperation("_CallStartOrJoinInitiated",void 0,void 0,n);else if(e===i.RINGING)2===this.audioStreamState?(this.setCallState(9,n),this.participants.forEach((e=>e.setState(6,void 0,n)))):this.participants.forEach((e=>e.setState(2,void 0,n))),this._callOperationHandler.maybeResolveOperation("Subscribe",void 0,void 0,n);else if(e===i.CONNECTED_FOR_ROSTER_ONLY)this._callOperationHandler.maybeResolveOperation("Subscribe",void 0,void 0,n),this._callOperationHandler.maybeResolveOperation("SubscribeWithMeetingData",void 0,void 0,n);else if(e===i.CONNECTED){this._callIsSetupComplete=!0;const e=this.getLocalSignalingEndpointDetails();(e?.isLobby||e?.streamLobby)&&(this._callInLobby=!0,this.updateCapabilities(n,!0));const t=this.signalingSession.participantManager.localParticipant.isStaging;if(11===this.state)this.setCallState(12,n);else if(this._callOperationHandler.hasPendingOperation("JoinPreheatedCall"))r.info("wait for joinPreheatedCall to resolved");else if(this._callInLobby)r.info("[inLobby] Override Connected state from signaling agent"),this.setCallState(10,n);else if(t)this.setCallState(13,n);else{if(3===this.state&&!this._callOperationHandler.hasPendingOperation("_CallStartOrJoinInitiated")&&!this._callOperationHandler.hasPendingOperation("_ConnectCall"))return void r.info("Return: Don't re-send setup telemetry if call was already connected and operations are completed");this.setCallState(3,n),this.handleRemoteParticipantStateInOneToOneCall(n)}this._callOperationHandler.maybeResolveOperation("_CallStartOrJoinInitiated",void 0,void 0,n),this._callOperationHandler.maybeResolveOperation("_ConnectCall",void 0,void 0,n),this.reportTsCallingTelemetry(!0)}else if(e===i.LOCAL_TERMINATED||e===i.REMOTE_TERMINATED){let s=this.callSetupFailed?7:Cu(t);if(8===this.state&&this._callOperationHandler.hasAtleastOneOfPendingOperation(["StartCall","JoinCall","StartWithMeetingData","JoinWithMeetingData"]))return this.signalingSession.resetState(),this._callOperationHandler.maybeRejectOperation("Subscribe",s,void 0,n),this._callOperationHandler.maybeRejectOperation("SubscribeWithMeetingData",s,void 0,n),void r.info("Subscribe failed, there is pending start/join operation, ignore call end message");if((2===this.state||6===this.state||8===this.state)&&this._callOperationHandler.hasAtleastOneOfPendingOperation(["StartCall","JoinCall","StartWithMeetingData","JoinWithMeetingData","Subscribe","SubscribeWithMeetingData"])){const e={code:this.callEndDiagnosticsInfo.callControllerCode,subCode:this.callEndDiagnosticsInfo.callControllerSubCode,phrase:this.callEndDiagnosticsInfo.phrase,reason:s};this._callOperationHandler.maybeRejectOperations(["Accept","JoinCall","JoinWithMeetingData","JoinPreheatedCall","StartCall","StartCallAndUnpark","StartCallToVoiceMail","StartCallWithNudge","StartWithMeetingData","Subscribe","SubscribeWithMeetingData"],s,void 0,n,e)}this.signalingSession.acceptedElsewhereBy&&(this.acceptedElsewhereBy={id:this.signalingSession.acceptedElsewhereBy.id,displayName:this.signalingSession.acceptedElsewhereBy.displayName}),this.signalingSession.parkAdditionalContextJson&&(this.parkAdditionalContextJson=this.signalingSession.parkAdditionalContextJson),this.signalingSession.serverHoldLocation&&(this.serverHoldLocation=this.signalingSession.serverHoldLocation),this._callOperationHandler.hasPendingOperation("CallParkV2")&&t.pickupCode&&0===t.code&&this._callOperationHandler.resolveOperation("CallParkV2",""+t.pickupCode,void 0,n),1!==s&&(this.mediaRelayWhiteListingIssue&&(s=53),t?.code===qn.MediaError&&t?.subCode===zn.MediaPermissionError&&(s=58),r.info(`[terminated][reason=${He(t)}]`)),this._callOperationHandler.maybeRejectOperation("CallParkV2",s,"",n),this._callOperationHandler.maybeRejectOperation("_WaitForAnswer",s,"",n),this._callOperationHandler.maybeRejectOperation("_ConnectCall",s,"",n);const a=this.mediaSession?.getSessionConfig().config.setDisconnectAfterCleanUp;if(a?this.setTerminatedReason(s):this.setCallState(7,n,s),this.participants.forEach((e=>e.setState(4,void 0,n))),!this.disconnectingPromise){const s={...t,remoteTerminated:e===i.REMOTE_TERMINATED};this.disconnectingPromise=this.cleanUp(n,s).catch((e=>{r.logFailure(`Error when cleaning up the call, callId = ${this.callId}, error = ${e}`)}))}a&&this.disconnectingPromise.finally((()=>{7!==this.state&&this.setCallState(7,n,s)}))}},onOffer:(e,t=Re())=>{const i=this.logger.createFnLogger("onOffer",t);i.info(`${He((0,Cr.omit)(e,"mediaContent","remoteParticipantId"))}`),this.setMediaLegId(e.mediaContent.mediaLegId),this.callTelemetry.recordEvent("_WebOnOffer",this.prepareTelemetryForOfferAnswer(e),t),e.transferor?.details?.id&&this.setTransferorMri(e.transferor.details.id),e.transferor?.transferorType&&(this.transferorType=e.transferor.transferorType),e.transferor?.details?.displayName&&(this.transferorDisplayName=e.transferor.details.displayName),this.clientTransferContext=e.clientTransferContext,this.invitationData=e.invitationData,this.spamRiskLevel=e.riskLevel,this.spamStirAttestation=e.stirAttestation,e.mediaContent.isTwoPartyToMultiPartyEscalation&&this.setIsEscalationInProgress(!0,t),e.renegotiation?this.requestedHoldState&&this._pendingParkPromise?this.renegotiateIncoming(e.mediaContent,t):this._callOperationHandler.executeChained((()=>this.renegotiateIncoming(e.mediaContent,t)),"_RenegotiateIncoming",t,t,void 0,void 0,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}):(i.info("resolving attach / offer promise"),this.attachToCallAndGetOffer.resolve(e.mediaContent))},onNewOffer:(e,t=Re())=>{const i=this.logger.createFnLogger("onNewOffer",t);this.newOfferRequestDeferred?(i.info("onNewOffer"),this.newOfferRequestDeferred.resolve(e.mediaContent)):i.info("callback received but new offer was not requested")},onAnswer:(e,t=Re())=>{const i=this.logger.createFnLogger("onAnswer",t);if(i.info(`${He((0,Cr.omit)(e,"mediaContent","remoteParticipantId"))}`),this.setMediaLegId(e.mediaContent.mediaLegId),this.callTelemetry.recordEvent("_WebOnAnswer",this.prepareTelemetryForOfferAnswer(e),t),e.renegotiation)i.info("resolving previous renegotiation promise"),this.renegotiationAnswerDeferred.resolve(e.mediaContent);else if(i.info("resolving final answer promise"),e.provisional){const i=this.isOneToOnePSTNCall()&&(0,Cr.startsWith)(e.remoteParticipantId,jh);this.mediaSession.processAnswerAsync(e.mediaContent,t,!0,i)}else this._callOperationHandler.maybeResolveOperation("_WaitForAnswer",e.mediaContent,void 0,t),this.handleRemoteParticipantStateInOneToOneCall(t);e.provisional||!e.mediaContent.fromMixer||this.callUsesMixer||this._callOperationHandler.executeChained((async()=>{this.setCallUsesMixer(!0,t),this.mediaStateConfigurationHelper.isDisabled(2)&&this.mediaStateConfigurationHelper.removeModality(2),await this.updateMediaModalities(void 0,t);const e=!(this.isSomeoneSharing||this.isScreenSharingOn||this.isVideoOn);return this.mediaSession.getSessionConfig().config.disableImmidiateEscalationReconnect&&e?(i.info("Delaying reconnect"),this._hasDelayedReconnect=!0,Promise.resolve()):this.mediaSession.reconnectAsync(t,!0)}),"_CallEscalatedToConference",t,t,void 0,void 0,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]})},onMediaAcknowledgementSuccess:(e,t=Re())=>{this.logger.info(`isRenegotiation: ${e}`,"onMediaAcknowledgementSuccess",t),this._callOperationHandler.resolveOperation("_MediaAcknowledgment",void 0,void 0,t)},onMediaAcknowledgementFailure:(e,t,i=Re())=>{this.logger.createFnLogger("onMediaAcknowledgementFailure",i).logFailure(He(t)),this._callOperationHandler.rejectOperation("_MediaAcknowledgment",t,i)},onMediaRenegotiationRejection:(e,t=Re())=>{this.logger.createFnLogger("onMediaRenegotiationRejection",t).logFailure(He(e)),this.renegotiationAnswerDeferred.reject(e)},onRosterHandlingComplete:()=>{this.logger.info(`[onRosterHandlingComplete] ${this._publishedStatesModified}`),0!==this._publishedStatesModified&&(this.processPublishedStates(),this._publishedStatesModified=0)},onMeetingGroupDetailsUpdated:(e,t=Re())=>{this.meetingGroupDetails!==e&&(this.callTelemetry.recordEvent("_UpdateMeetingGroupDetails",e,t),this.logger.info(`[${t}][onMeetingGroupDetailsUpdated] update meetingGroupDetails from ${JSON.stringify(this.meetingGroupDetails)} to ${JSON.stringify(e)}`),this.meetingGroupDetails=e,this.raiseChanged())},onSelfParticipantUpdated:(e,t=Re())=>{this.logger.info(`[${t}][onSelfParticipantUpdated]`),this.updateLocalParticipant(e,t),this.raiseChanged()},onParticipantMriUpdated:(e,t,i=Re())=>{this.logger.info(`[${i}][onParticipantMriUpdated]`);const n=this.getParticipant(e);n&&(n.id=t,this.raiseChangedDeferred())},onParticipantUpdated:(t,i=Re())=>{this.logger.info(`[${i}][onParticipantUpdated]: ${ju(t)}`);const n=this.getOrCreateParticipant(t.id,i,!0);n.displayName=t.displayName;const r=e.getStreamsFromEndpoints(t.endpointDetails),s=(0,Cr.some)(t.endpointDetails,(e=>e?.streamInformation));this.callUsesMixer||r.length>0||s?(this.updateParticipantStreams(n,t,r,i),this.updateCallParticipantFromSignalingParticipant(n,t,i)):n.setState(3,void 0,i),n.processParticipantDetails(t,this.getSelfClientEndpointCapabilities(),(()=>{this.signalingSession?.setStreamInformationReceived()})),this.updatePublishedStates(t),this.calculateIsSomeoneStreaming(i),this.raiseChangedDeferred()},onParticipantRemoved:(e,t=Re(),i=!1)=>{if(this.logger.info(`[${t}][onParticipantRemoved]`),i){const i=this.getParticipant(e.id);this.callTelemetry.recordOperationSuccess("_ParticipantJoined",null,i?.id,t,{participantJoinedButReplaced:"Participant joined with original MRI and replaced with participant of RNL MRI"})}else this.callTelemetry.recordOperationSuccess("RemoveParticipant",null,e.id,t),this._participantOperationHandler.maybeRejectOperation("AddParticipant",1,e.id,t);this._removeParticipant(e,t),this.removePublishedStatesByParticipant(e.id),this.calculateIsSomeoneStreaming(t)},onParticipantJoined:(t,i=Re())=>{this.logger.info(`[${i}][onParticipantJoined]`);const n=!this.getParticipant(t.id),r=this.getOrCreateParticipant(t.id,i,!1);r.displayName=t.displayName,0===r.state&&r.setState(1,void 0,i);const s=e.filterVirtualEndpoints(t.endpointDetails),a=e.getStreamsFromEndpoints(s),o=(0,Cr.some)(t.endpointDetails,(e=>e?.streamInformation));this.callUsesMixer||a.length>0||o?(this.updateParticipantStreams(r,t,a,i),this.updateCallParticipantFromSignalingParticipant(r,t,i),this.calculateIsSomeoneStreaming(i)):(this.handleRemoteParticipantJoinedInOneToOneCall(t,i),this.handleRemoteParticipantStateInObservingCall(r,t,i),t.acceptedBy&&t.acceptedBy!==t.id&&(r.acceptedBy=t.acceptedBy)),this.callTelemetry.recordOperationSuccess("_ParticipantJoined",vn(t.endpointDetails),r.id,i),r.processParticipantDetails(t,this.getSelfClientEndpointCapabilities(),(()=>{this.signalingSession?.setStreamInformationReceived()})),this.updatePublishedStates(t),n&&this.event("participantAdded").raise(r),this.raiseChangedDeferred()},onCallModeChanged:(e,t)=>{this.callTelemetry.recordEvent("_CallModeChanged",{newCallMode:e,oldCallMode:this._callMode},t),this.logger.info(`onCallModeChanged[${t}]: new=${e} old=${this._callMode} `),e&&this._callMode!==e&&(this._callMode=e,this.isCallModeStreaming()&&this.cleanUpDueToStreaming(t),1===this._callMode&&(this.participants.forEach((e=>{e.applyCachedMediaStreams(t)})),this.promotionCompletedDeferred?.resolve()),this.monitorCallStart(),this.updateCapabilities(t),this.raiseChanged())},getRemoteParticipantCollection:()=>this.participants.map((e=>e.toCafeParticipant())),onReTargetCompletedSuccess:e=>{const t=this.logger.createFnLogger("onReTargetCompletedSuccess",e);t.info(`started, isEscalationInProgress=${this.isEscalationInProgress}`),this.callTelemetry.recordEvent("_WebRetargetSuccess",void 0,e),this.callStats.localStats.call.event(3);const i=this.isEscalationInProgress;this.screenSharingControl&&this.screenSharingControl.shutdownControlForViewer(),this.updateSignalingDSHMessageSubscription(this.isInitialSignalingDSHSubscriptionEnabled()),this.mediaSession.completeEscalationAsync(e).then((()=>(t.logSuccess("completeEscalationAsync"),this.callTelemetry.recordEvent("_WebOnEscalationSuccess",void 0,e),this.handleCallEscalation(i,e),this.updateMediaStatus(e)))).catch((i=>{t.logFailure(`completeEscalationAsync, error=${Ve(i)}`),this.setIsEscalationInProgress(!1,e),this.callTelemetry.recordEvent("_WebOnEscalationFailure",Fe(i),e),this.stopInternal({causeId:e,terminatedReason:47})}))},onReTargetCompletedFailure:(e,t)=>{this.logger.createFnLogger("onReTargetCompletedFailure",t).logFailure(`reason=${Ve(e)}, isEscalationInProgress=${this.isEscalationInProgress}`),this.callTelemetry.recordEvent("_WebRetargetFailure",Fe(e),t),this.isEscalationInProgress&&(this.setIsEscalationInProgress(!1,t),this.setCallUsesMixer(!1,t),this.updateMediaStatus(t)),this.callStats.localStats.call.event(4),this.mediaSession.rejectEscalationAsync(e,t)},onChatModalitySetupFailed:e=>{this.logger.debug(`onChatModalitySetupFailed: ${e}`)},onConversationUpdated:(e,t)=>{this.logger.info(`onConversationUpdated[${t}]: ${He(e)}`),this.setConversationType(e.conversationType,t),this.setMessageId(e.teamsMessageId,t),this.setGroupId(e.groupId,t),this.setThreadId(e.threadId,t),this.setBackroomThreadId(e.backroomThreadId,t),this.setCallType(e.isMultiParty?2:1,t),this._commandUrlPresence=e.commandUrlPresence,this.updateCapabilities(t),this.region=e.region,this.setMeetingData(e.meetingData),this.meetingInfo=e.meetingInfo,this.callLimits=e.callLimits,this.setComplianceRecordingContent(t,e.complianceRecordingContent),this.setHuddleGroupCall(e.isHuddleGroupCall),this.raiseChanged()},onMeetingDetailsUpdated:e=>{this.meetingDetails=e,this.mediaSession&&!this.enableRealtimeTelemetry&&this.meetingDetails.meetingCapability?.enableRealtimeTelemetry&&(this.mediaSession.enableTeamsRealTimeTelemetry(),this.enableRealtimeTelemetry=!0),this.raiseChanged()},onMeetingStatesUpdated:e=>{(0,Cr.isEqual)(e,this.meetingStates)||(this.meetingStates=e,this.logger.info(`[onMeetingStatesUpdated] meetingStates updated to ${JSON.stringify(this.meetingStates)}`),this.raiseChanged())},onParticipantCountsUpdated:e=>{(0,Cr.isEqual)(e,this.participantCounts)||(this.participantCounts={...un,...e},this.event("participantCountsUpdated").raise(this.participantCounts),this.mediaSession?.processNotification("ParticipantCountChanged",{count:e.totalParticipants}))},updateIsSharedLineAppearanceV2Activated:e=>{this.isSharedLineAppearanceV2Activated!==e&&(this.logger.info(`_updateIsSharedLineAppearanceV2Activated: new value is ${e}`),this.isSharedLineAppearanceV2Activated=e,this.event("sharedLineAppearanceV2ActivatedChanged").raise(this.isSharedLineAppearanceV2Activated))},onBroadcastMeetingUpdated:e=>{e&&(this.broadcastMeeting&&this.broadcastMeeting.metadataChanged(JSON.stringify(e)),this.broadcastMetadata=e,this.raiseChanged())},onBroadcastMeetingConnected:(e,t)=>{this.logger.info(`[${t}][onBroadcastMeetingConnected]`),this._callOperationHandler.hasPendingOperation("AddBroadcastModality")&&(0===e.code?this._callOperationHandler.resolveOperation("AddBroadcastModality",e,t):this._callOperationHandler.rejectOperation("AddBroadcastModality",e,t))},onBroadcastMeetingEnded:(e,t)=>{this.logger.info(`[${t}][onBroadcastMeetingEnded]`),this._callOperationHandler.hasPendingOperation("AddBroadcastModality")&&this._callOperationHandler.rejectOperation("AddBroadcastModality",e,t),this.signalingSession.endBroadcastMeeting(t)},onTransferRequested:(e,t)=>{const i=this.logger.createFnLogger("onTransferRequested",t);i.info("Transfer: onTransferRequested, target participant",ju(e.target));let n="",r="",s=0;"voicemail"===e.target.endpointType&&(s=2);try{n=e.target.id,r=e.transferor.details.id,e&&e.parkType&&"none"!==e.parkType&&(s=1)}catch(e){return i.logFailure(e),this.callTelemetry.recordEvent("_OnTransferRequestedInvalid"),void this.signalingSession.signalTransferCompletedAsync({code:_u(7)})}const a=this.convertToTransferType(s,e.parkType),o={transferContext:{transferorMri:r,targetMri:n,transferType:s,context:{target:e.target,transferor:e.transferor,transferContext:e.transferContext,newCallModalities:e.newCallModalities,links:e.links,replacementDetails:e.replacementDetails,isConsultative:e.isConsultative,callAcceptanceCallback:()=>{i.logSuccess("Transfer: callAcceptanceCallback called"),this.signalingSession.signalTransferAcceptedAsync(a)}}},onCompleted:e=>{i.logSuccess("Transfer: onCompleted called"),this.signalingSession.signalTransferCompletedAsync({code:_u(e)})}};this.callTelemetry.recordEvent("_OnTransferRequested",{transferType:s}),this.event("transferRequested").raise(o)},onTransferredCallAcceptance:e=>{const t=this.logger.createFnLogger("onTransferredCallAcceptance",e);this._transfereeAcceptanceWithoutWaitingForConv&&this._transferredCallAcceptanceCallback&&(t.info("[Transfer] Invoke call acceptance callback for original call"),this._transferredCallAcceptanceCallback())},onTransferAccepted:e=>{this.logger.info("Transfer: onTransferAccepted"),this._callOperationHandler.hasPendingOperation("_CallTransferInProgress")&&this._setTransferState(2),this._callOperationHandler.hasPendingOperation("BlindTransfer")&&this._callOperationHandler.maybeResolveOperation("_CallTransferInProgress",void 0,void 0,e),this._callOperationHandler.hasPendingOperation("ParkCall")&&this._setParkState(2)},onTransferCompleted:(e,t)=>{const i=this.logger.createFnLogger("onTransferCompleted",t);i.info("Transfer: onTransferCompleted");const n=e.transferCompletion,r=Cu(n);if(n&&(i.info(`Transfer: Call Transfer Code: ${n.code}`),0===n.code)){if(this._callOperationHandler.hasPendingOperation("_CallTransferInProgress")&&(this._callOperationHandler.resolveOperation("_CallTransferInProgress",void 0,void 0,t),this._setTransferState(3)),this._callOperationHandler.hasPendingOperation("ConsultativeTransferWithPickupCode")){const e={code:0,subCode:0,phrase:"TransactionComplete"};this._callOperationHandler.resolveOperation("ConsultativeTransferWithPickupCode",e,void 0,t),this._setTransferState(3)}this._callOperationHandler.hasPendingOperation("ParkCall")&&(e.unparkContent?.CallParkAdditionalContext?.ConversationControllerLocation&&(this.serverHoldLocation=e.unparkContent.CallParkAdditionalContext.ConversationControllerLocation),void 0!==e.unparkContent?.pickupCode?(this._callOperationHandler.resolveOperation("ParkCall",e.unparkContent.pickupCode,void 0,t),i.logSuccess(`pickupCode=${e.unparkContent.pickupCode}`),this._setParkState(3)):(this._callOperationHandler.rejectOperation("ParkCall",32,t),i.logFailure(`terminatedReason=${r}`),this._setParkState(4)))}else{if(this._callOperationHandler.hasPendingOperation("_CallTransferInProgress")&&(this._callOperationHandler.rejectOperation("_CallTransferInProgress",r,void 0,t),i.logFailure(`terminatedReason=${r}`),this.transferDiagnosticsInfo={callControllerCode:n.code,callControllerSubCode:n.subCode,phrase:n.phrase,resultCategories:n.resultCategories},this._setTransferState(4)),this._callOperationHandler.hasPendingOperation("ConsultativeTransferWithPickupCode")){const e={code:n.code,subCode:n.subCode,resultCategories:n.resultCategories};this._callOperationHandler.rejectOperation("ConsultativeTransferWithPickupCode",e,void 0,t)}this._callOperationHandler.hasPendingOperation("ParkCall")&&(this._callOperationHandler.rejectOperation("ParkCall",r,void 0,t),i.logFailure(`terminatedReason=${r}`),this.transferDiagnosticsInfo={callControllerCode:n.code,callControllerSubCode:n.subCode,phrase:n.phrase,resultCategories:n.resultCategories},this._setParkState(4))}},onParkCompleted:(e,t)=>{this.logger.createFnLogger("onParkCompleted",t).info(`transactionEnd ${Ve(e)}`),this._callOperationHandler.hasPendingOperation("CallParkV2")?0===e.code&&void 0!==e.unparkContent?.pickupCode?(this._callOperationHandler.resolveOperation("CallParkV2",""+e.unparkContent?.pickupCode,void 0,t),this.callTelemetry.maybeRecordOperationSuccess("CallParkV2"),this.serverHoldLocation=e.unparkContent?.CallParkAdditionalContext?.ConversationControllerLocation,this.parkAdditionalContextJson=JSON.stringify(e.unparkContent.CallParkAdditionalContext)):this._callOperationHandler.rejectOperation("CallParkV2",e,t):this._callOperationHandler.hasPendingOperation("ParkCall")&&(0===e.code?(this._callOperationHandler.resolveOperation("ParkCall","",void 0,t),this._setParkState(3)):(this._callOperationHandler.rejectOperation("ParkCall",e,t),this._setParkState(4)))},onUnparkCompleted:(e,t)=>{this.logger.createFnLogger("onUnparkCompleted",t).info(`transactionEnd ${Ve(e)}`),this._callOperationHandler.hasPendingOperation("UnparkCall")&&(0===e.code?this._callOperationHandler.resolveOperation("UnparkCall",e,void 0,t):this._callOperationHandler.rejectOperation("UnparkCall",e,t))},onIncomingCallReplacement:(e,t)=>{const i=this.logger.createFnLogger("onIncomingCallReplacement",t);this.callTelemetry.recordEvent("_onIncomingCallReplacement",{},t),e.callNotification.callType="replaces",e.callNotification.consultativeCallId=this.callId,i.info(`consultativeCallId=${this.callId}`),e.body={gp:e,evt:Qn.INCOMING_SKYPE_NGC_CALL,nsp:void 0},this.event("replacementRequested").raise(e)},onContentSharingStopped:e=>{this.logger.debug("ScreenSharing: onContentSharingStopped");for(const t of this.contentSharingSessions)t.contentSharingGuid===e.correlationId&&(t.contentSharingStatus=7)},onContentSharingStarted:e=>{this.logger.debug("ScreenSharing: onContentSharingStarted");const t=new bp(this.callTelemetry,this.logger.createChild("ContentSharingSession"),this.signalingSession,e.correlationId||Hi(),e.contentIdentifier,e.sessionState,e.subject,e.sessionId);t.contentSharingStatus=2,this.contentSharingSessions.push(t),t.changed((()=>this.removeContentSessionIfEnded(t))),this.event("contentSharingChanged").raise()},onContentSharingUpdated:e=>{this.logger.debug("ScreenSharing: onContentSharingUpdated");const t=(0,Cr.find)(this.contentSharingSessions,(t=>t.contentSharingGuid===e.correlationId));t?(e.presenter&&(t.presenterId=e.presenter),e.subject&&t.subject!==e.subject&&(t.subject=e.subject),e.sessionState&&t.contentSharingState!==e.sessionState&&(t.contentSharingState=e.sessionState),3===t.contentSharingStatus&&this.localSignalingParticipant.id!==e.presenter?t.contentSharingStatus=5:5===t.contentSharingStatus&&this.localSignalingParticipant.id===e.presenter&&(t.contentSharingStatus=3)):this.logger.warn("onContentSharingUpdated: session not found")},onWebRtcMediaNotification:(e,t)=>{this.mediaSession?.processNotification(e,t);const i=this.mediaSession&&this.mediaSession.getExtensionsManager?this.mediaSession.getExtensionsManager():null;i&&i.processNotification(e,t)},onCorrelationIdUpdated:(e,t)=>this.checkForCallIdUpdate(e,t),onUnmuteRequested:e=>{},onCallForwarded:e=>{e&&e.destinationType!==this.forwardingDestinationType&&(this.forwardingDestinationType=e.destinationType,this.raiseChanged())},onPSTNBalanceUpdate:e=>{},isOneToOnePstnCall:()=>this.isOneToOnePSTNCall(),onUpdateMeetingLiveStateCompleted:(e,t,i)=>{this.logger.info(`[onUpdateMeetingLiveStateCompleted] [${t}] transactionEnd ${Ve(e)}`),this.onOperationCompleteCommonHandler(e,t,"UpdateMeetingLiveState",i)},onUpdateMeetingStatesCompleted:(e,t,i)=>{this.logger.info(`[onUpdateMeetingStatesCompleted] [${t}] transactionEnd ${Ve(e)}`),this.onOperationCompleteCommonHandler(e,t,"UpdateMeetingStates",i)},onUpdateMeetingGroupsCompleted:(e,t,i)=>{this.logger.info(`[onUpdateMeetingGroupsCompleted] [${t}] transactionEnd ${Ve(e)}`),this.onOperationCompleteCommonHandler(e,t,"UpdateMeetingGroups",i)},onSetMeetingLayoutCompleted:(e,t,i)=>{this.logger.info(`[onSetMeetingLayoutCompleted] [${t}] transactionEnd ${Ve(e)}`),this.onOperationCompleteCommonHandler(e,t,"SetMeetingLayout",i)},onJoinMeetingGroupCompleted:(e,t,i)=>{this.logger.info(`[onJoinMeetingGroupCompleted] [${t}] transactionEnd ${Ve(e)}`),this.onOperationCompleteCommonHandler(e,t,"JoinMeetingGroup",i)},onLeaveMeetingGroupCompleted:(e,t,i)=>{this.logger.info(`[onJoinMeetingGroupCompleted] [${t}] transactionEnd ${Ve(e)}`),this.onOperationCompleteCommonHandler(e,t,"LeaveMeetingGroup",i)},onBreakoutDetailsUpdated:(e,t)=>{this.logger.info(`[onBreakoutDetailsUpdated] [${t}]`),this.breakoutDetails=e,this.raiseChanged()},onIncomingProxiedMessages:(e,t)=>{this.logger.info(`[onIncomingProxiedMessages] [${t}] payload ${Ve(e,!0)}`),this.event("incomingProxiedMessages").raise(e)},onUpdateParticipantsPropertiesCompleted:(e,t,i)=>{this.logger.createFnLogger("onUpdateParticipantsPropertiesCompleted",i).info(`promisesToResolve ${ke(He(e))}`);for(const t of Object.keys(e))e[t].code===_n.SUCCESS?this._callOperationHandler.maybeResolveOperation("UpdateParticipantsProperties",e[t],t,i):this._callOperationHandler.maybeRejectOperation("UpdateParticipantsProperties",e[t],t,i)},onNudgeToJoinRealtime:e=>{this.logger.info("[onNudgeToJoinRealtime]",e),this.callTelemetry.recordEvent("NudgeToJoinRealTime",e),this.canPromoteToRealTime(1)&&this.promoteToRealtime(1,e).then((()=>this.logger.info(`[onNudgeToJoinRealtime][${e}] completed`))).catch((t=>this.logger.info(`[onNudgeToJoinRealtime][${e}] failed to auto promote: ${Ve(t)}`)))}};const n=Object.create(this.localSignalingParticipant);this.signalingSession=this.signalingAgent.getNewSignalingSession(n,this.signalingNotifications,this.callId,this._callCreationTime),this.signalingSession.participantManager.setStaleCheckForFullRoster(this._staleRosterCheckFixForPluginless),this.signalingSession.participantManager.setEnableMuteAsync(this._enableMuteAsync),this.signalingSession.participantManager.setEnableUnmuteAsync(this._enableUnmuteAsync),this.accountConfiguration&&this.accountConfiguration.deviceType&&this.signalingSession.setDeviceType(this.accountConfiguration.deviceType),this.setCallId(this.callId||this.signalingSession.correlationId),this.signalingSession.participantManager&&this.signalingSession.participantManager.localParticipant&&(this.setEndpointId(this.signalingSession.participantManager.localParticipant.endpointId),this.setParticipantId(this.signalingSession.participantManager.localParticipant.participantId),this.callStats.setParticipantId(this.participantId))}updateParticipantStreams(e,t,i,n){e.updateStreams(i,n,this.isCallModeStreaming());const r=this.getStreamInformationMap(t);this.logger.info(`[updateParticipantStreams]: streaming mode with new streamInfoMap: ${He(r)}`);const s={callId:this.callId,participantId:this.participantId,endpointId:this.endpointId};this.meetingData&&(s.meetingId=this.meetingData.meetingCode);const a=this.telemetryLoggers?this.telemetryLoggers.tlePlayer:null;e.useUmsStream(r,this._liveStreamConfigProvider,s,this.threadId,a,n)}cleanUpDueToStreaming(e){this.logger.info(`cleanUpDueToStreaming[${e}]: cleaning streams and media and canceling cc operations`),this.cancelAllCallingOperationsDueToStreaming(e);const t={code:qn.Success,subCode:zn.DowngradeToStreamingClient,phrase:ar};this.participants.forEach((t=>t.updateStreams([],e))),this.cleanUpMedia(e,t).finally((()=>{this.mediaDisposedPromise=null})),this.finishCallHoldResume(t),this.renegotiationAnswerDeferred?.reject(t),this.newOfferRequestDeferred?.reject(t),this._parkState=0,this._transferState=0,this.isServerMuted||(this._muteState=0),this.isSpeakerMuted=!1,this.requestedHoldState=!1,this.isMuteOnHold=!1}cancelAllCallingOperationsDueToStreaming(e){this._callOperationHandler.maybeRejectPendingOperationsWithPredicate(74,e,((e,t)=>(0,Cr.some)(t?.preconditionTags,(e=>"NOT_SUPPORTED_IN_STREAMING_MODE"===e))))}onOperationCompleteCommonHandler(e,t,i,n){0===e.code?this._callOperationHandler.maybeResolveOperation(i,e,n,t):this._callOperationHandler.maybeRejectOperation(i,e,n,t)}convertToTransferType(e,t){let i="none";return 1===e&&t&&"none"!==t?"teamPark"===t?i="TransferTypeTeamPark":"sharedLinePark"===t?i="TransferTypeSharedLinePark":"serverHold"===t&&(i="TransferTypeServerHold"):0===e?i="TransferTypeStandard":2===e?i="TransferTypeVoicemail":this.logger.info(`Irrelevant combination of transferTye: ${e} and parkType: ${t}`),i}raiseChangedDeferred(e){(!this.raiseChangedDefer||this.raiseChangedDefer.isSkippable&&!e)&&(Ju.instance.runDeferredWithoutDedup((()=>{delete this.raiseChangedDefer,this.raiseChanged(e)}),"Call.raiseChanged"),this.raiseChangedDefer={isSkippable:!!e})}static getStreamsFromEndpoints(t){if(!t)return[];const i=e.filterVirtualEndpoints(t);return i.forEach((e=>(0,Cr.forEach)(e.mediaStreams,(t=>{t.participantId=e.participantId,t.endpointId=e.endpointId})))),(0,Cr.flatMap)(i,(e=>e&&e.mediaStreams||[]))}preconditions(e,t){this.logger.info(`check call mode currentMode is ${this.callMode} operationName is ${e}`),(0,Cr.some)(t,(e=>"NOT_SUPPORTED_IN_STREAMING_MODE"===e))&&this.isCallModeStreaming(!0)}mapCallSetupIntent(e){switch(e){case 0:return"None";case 1:return"AutoPromotion";case 2:return"PromotionWithAudio";case 3:return"PromotionWithVideo";default:return"Unknown"}}async promoteToRealtime(e,t){this.logger.info(`[${t}][promoteToRealtime] started with intent=${e}`);const i=this.getPromoteToRealtimeCallOptions(e,this.callOptions);this.callTelemetry.updateOperationData("_PromotionToRealtime",{intent:e},t),this.callTelemetry.recordEvent("StartPromotion",{intent:this.mapCallSetupIntent(e)},t);try{this.promotionCompletedDeferred=Ei(),await Promise.all([this.joinOrStartCall(i,this.joinGivenConversation,t,void 0),this.promotionCompletedDeferred.promise])}catch(e){throw this.logger.logFailure(`[${t}][promoteToRealtime] failed with reason=${Ve(e)}`),this.cleanUpDueToStreaming(t),this.signalingSession.cleanUpDueToStreaming(t),e}}async promoteToRealtimeAndUnmute(e){return this.logger.info(`[${e}][promoteToRealtimeAndUnmute]`),this.isPromotingToRealtime()?(this.logger.info(`[${e}][promoteToRealtimeAndUnmute] already promoting to realtime.`),this._callOperationHandler.waitForOperation("_PromotionToRealtime").then((()=>this.muteUnmute(!1,e)))):this.canPromoteToRealTime(2)?(this.unmutePendingPromise=Ei(),setTimeout((()=>{this.unmutePendingPromise?.reject("promoteToRealtime unmute timed out")}),1e3*this.signalingSession.signalingAgentConfig.csaTimeoutConfiguration.promotionUnmuteTimeoutSec),Promise.all([this.promoteToRealtime(2,e),this.unmutePendingPromise.promise]).then((()=>{})).finally((()=>this.unmutePendingPromise=null))):Promise.reject("manual promotion with audio is not allowed")}isPromotingToRealtime(){return this._callOperationHandler.hasPendingOperation("_PromotionToRealtime")}getPromoteToRealtimeCallOptions(e,t){let i,n=1;1===e?i={value:!0,mediaTypes:["audio"]}:3===e?(i={value:!0,mediaTypes:["audio"]},n=4):2===e&&(i={value:!1});const r={...t.callStartOptions,sendMediaModalities:{mediaStates:[bu(0,4),bu(1,n)].filter((e=>null!=e))},preheatFlags:0};return{...t,callStartOptions:r,applyServerMute:i,isPromotingToRealtime:!0,callStartTime:Date.now()}}canPromoteToRealTime(e){const t=this.logger.createChild("[canPromoteToRealTime]");return t.info(`[promoteType:${e}]`),this.isCallModeStreaming()?this.isPromotingToRealtime()?(t.info("already promoting to realtime"),!1):1===e||2===e:(t.info("cant promote since call mode is not streaming"),!1)}isCallModeStreaming(e=!1){if(2===this.callMode){if(!e)return!0;throw this.logger.info("reject check callmode"),{code:499,subCode:3551,phrase:"TransactionNotAllowedForStreamMode"}}return!1}setCallOptions(e){this.receiveOnlyAudioOnCallStart=!!e.callStartOptions?.receiveOnlyAudioOnCallStart,this.callOptions=e,this.logger.info(`callOptions: ${He(function(e){const t={};Ru(e.callStartTime)&&(t.callStartTime=e.callStartTime),Ru(e.callVoicemailStartOptions)&&(t.callVoicemailStartOptions=e.callVoicemailStartOptions),Ru(e.invitationType)&&(t.invitationType=e.invitationType),Ru(e.meetingPreferences)&&(t.meetingPreferences=e.meetingPreferences),Ru(e.parkContext)&&(t.parkContext=e.parkContext),Ru(e.pickupCode)&&(t.pickupCode=e.pickupCode),Ru(e.participantsToNudge)&&(t.participantsToNudgeSize=e.participantsToNudge.length);const i=e.callStartOptions;if(i){const e={};Ru(i.additionalEndpointProperties)&&(e.additionalEndpointProperties=i.additionalEndpointProperties),Ru(i.clientEndpointCapabilities)&&(e.clientEndpointCapabilities=i.clientEndpointCapabilities),Ru(i.connectionType)&&(e.connectionType=i.connectionType),Ru(i.invitationDataJson)&&(e.invitationDataJson=i.invitationDataJson),Ru(i.isCast)&&(e.isCast=i.isCast),Ru(i.isHuddleGroupCall)&&(e.isHuddleGroupCall=i.isHuddleGroupCall),Ru(i.label)&&(e.label=i.label),Ru(i.maxVideoChannels)&&(e.maxVideoChannels=i.maxVideoChannels),Ru(i.mediaConfiguration)&&(e.mediaConfiguration=i.mediaConfiguration),Ru(i.muteFlags)&&(e.muteFlags=i.muteFlags),Ru(i.muted)&&(e.muted=i.muted),Ru(i.negotiationTag)&&(e.negotiationTag=i.negotiationTag),Ru(i.preheatFlags)&&(e.preheatFlags=i.preheatFlags),Ru(i.ringOthers)&&(e.ringOthers=i.ringOthers),Ru(i.routingFlags)&&(e.routingFlags=i.routingFlags),Ru(i.scenario)&&(e.scenario=i.scenario),Ru(i.screenshareDirection)&&(e.screenshareDirection=i.screenshareDirection),Ru(i.sendMediaModalities)&&(e.sendMediaModalities=i.sendMediaModalities),Ru(i.sharedLineCallInvitationContentJson)&&(e.sharedLineCallInvitationContentJson=i.sharedLineCallInvitationContentJson),Ru(i.targetApplicationType)&&(e.targetApplicationType=i.targetApplicationType),Ru(i.captchaContentJson)&&(e.captchaContentJson=i.captchaContentJson),Ru(i.callQueueContext)&&(e.callQueueContext=i.callQueueContext),Ru(i.clientEndpointDebugContent)&&(e.clientEndpointDebugContentSize=i.clientEndpointDebugContent.length),Ru(i.alternateId)&&(e.alternateId=ke(i.alternateId)),Ru(i.callKey)&&(e.callKeySize=i.callKey.length),Ru(i.encryptedKey)&&(e.encryptedKeySize=i.encryptedKey.length),t.callStartOptions=e}return t}(e))}`)}getSelfClientEndpointCapabilities(){return this.callOptions?.callStartOptions?.clientEndpointCapabilities}getLocalSignalingEndpointDetails(){return(0,Cr.find)(this.localSignalingParticipant.endpointDetails,(e=>e?.endpointId===this._endpointId))}getStreamInformationMap(e){const t={};return e&&this.accountConfiguration?.clientSupportsUms&&(0,Cr.forEach)(e.endpointDetails,(e=>{e?.streamInformation&&e.participantId&&e.participantId!==this._participantId&&(t[e.participantId]=e.streamInformation)})),t}updateSATInfo(e=[]){const t=this.mediaSession?.getSessionConfig().config.slowedDownTalkerInfoAggregationTime;if(!t||t<0)return;const i=Date.now(),n=i-1e3*t;this.activeTalkersHistory=this.activeTalkersHistory.filter((({timestamp:e})=>e>n)).concat({speakers:e.map((e=>e.id)),timestamp:i});const r=Object.entries(this.activeTalkersHistory.reduce(((e,{speakers:t})=>{for(const i of t)e[i]??(e[i]=0),e[i]++;return e}),{})).sort((([,e],[,t])=>t-e)).map((([e])=>e));this.slowedDownActiveTalkerInfo={speakerList:r,timestamp:new Date(i)}}setPlatformCallConstraints(e){this.setCallConstraints(e).catch((e=>{this.logger.error(e)}))}setCallConstraints(e){return this.mediaSession?(this.logger.info(`Applying platform constraints to current call ${JSON.stringify(e)}`),this.mediaSession.setCallConstraints(e,Re())):(this.logger.info("Saving platform constraints until media session is created"),this.temporaryCallConstraints=e,new Promise(((e,t)=>{this.resolveTemporaryCallConstraints=e,this.rejectTemporaryCallConstraints=t})))}initializeMediaSession(t){if(this.mediaSession)return;const i=this.logger.createFnLogger("initializeMediaSession",t),n=((e,t)=>{const i={};return Object.keys(t).forEach((n=>{i[n]=(...i)=>t[n]&&e()&&t[n](...i)})),i})((()=>!this.isCallModeStreaming()||this.isPromotingToRealtime()),{onSessionErrorOccurred:(e,t=Re())=>{i.error(`[${t}][onSessionErrorOccurred]: ${He(e)}`);const n=[this.mediaAgent.constants.MEDIA_ERROR.iceConnectionError,this.mediaAgent.constants.MEDIA_ERROR.internalError];(0,Cr.includes)(n,e.type)&&this.event("mediaConnectionFailed").raise(),this.callTelemetry.recordEvent("SessionError",{type:e.type},t)},onNegotiationRequired:(e=Re())=>{this.executeNegotiation(e,"onNegotiationRequired",!0)},onContributingSourcesChanged:e=>{const t=this.mediaSession?.getSessionConfig().config.contributingSourcesLogInterval,n=t&&Date.now()>=this.lastContibutingSourceReport+t,r=n?new Map(e.map((e=>[e,"<unknown>"]))):new Map,s=[];for(const t of this.participants){const i=e.some((e=>t.hasAudioSource(e))),a=i?1:0;t.updateVoiceLevel(a),i&&(s.push(t),n&&r.set(t.audio.id,ke(t.id)))}this.updateSATInfo(s),n&&(i.info(`[onContributingSourcesChanged], ${e.length?Array.from(r).join(";"):"none"}`),this.lastContibutingSourceReport=Date.now())},onDominantSpeakerChanged:(e,t)=>{const n=Re(),r=[],s=[];e.forEach((e=>{const t=(0,Cr.find)(this.participants,(t=>t.hasAudioSource(e)));t?(r.push(t.id),s.push(ke(t.id))):s.push(this.streamManager.audio.id===e?"<self>":"<unknown>")})),i.info(`[${n}][onDominantSpeakerChanged], msidList = ${e} => speakerList = ${s}, timestamp = ${t}`),this.dominantSpeakerInfo={speakerList:r,timestamp:t,noCurrentDominantSpeaker:!1},this.event("dominantSpeakerChanged").raise(),this.raiseChanged(this._dominantSpeakerChangedEventSkipConfig)},onAudioStateChanged:(t,i)=>{const n=Re(),r=this.logger.createFnLogger("onAudioStateChanged",n);r.info(He(t)),this.callStats.localStats.audio.streamStateChanged(t.stream,t.direction);const s=e.streamingStatetoMediaStreamState(t.stream);if(this.audioStreamState=s,!s)return;this.callTelemetry.recordEvent("AudioStateChanged",{state:t,reason:i},n),2===s&&2===this.state&&(this.setCallState(9,n),this.participants.forEach((e=>e.setState(6,void 0,n))));const a={mediaType:0,mediaDirection:e.streamingDirectionToMediaDirectionMapping(t.direction),mediaStreamState:s};if(this.event("mediaStreamStateChanged").raise(a),!this.isCallSetupTelemetrySent&&this.mediaSession?.getSessionConfig().config.sendCallStartupTelemetry&&this.sendCallSetupTelemetry(),0===a.mediaDirection&&(this.isAudioStreamConnected=(0,Cr.includes)([2,1],a.mediaStreamState)),(0,Cr.includes)([3,4],a.mediaStreamState)&&(r.logFailure(`audio stream state changed to ${t.stream} with reason ${i}`),!i||["timeout","connection-dropped","connectivity-check-failure","suspended"].indexOf(i)>=0)){this.event("mediaConnectionFailed").raise();const e="suspended"===i?77:this.mediaRelayWhiteListingIssue?53:4;this.mediaRelayWhiteListingIssue&&this.callTelemetry.recordEvent("_MediaWhiteListingIssueDetected"),this.stopInternal({causeId:n,terminatedReason:e})}},onQualityChanged:t=>{const i={type:e.convertQualityEventType(t.type),value:e.convertQualityLevel(t.value),isLocalSource:t.isLocalSource,mediaType:e.convertMediaType(t.mediaType)};this.muteUnmuteWorkaround(i),32===i.type&&(this.mediaRelayWhiteListingIssue=3===i.value,this.mediaRelayWhiteListingIssue&&this.event("mediaConnectionWhitelistingWarning").raise()),5===i.type&&3===i.value&&this.trouterService.checkConnection(!0),this.callTelemetry.recordEvent("AudioQualityChanged",i),this.event("callQualityChanged").raise(i)},onOptimalVideoReceiversCountChanged:e=>{i.debug(`onOptimalVideoReceiversCountChanged: ${e}`),this.optimalVideoCount!==e&&(this.optimalVideoCount=e,this.raiseChanged())},onDataChannelUpdated:e=>{const t=Re();i.debug(`[${t}] onDataChannelUpdated`),this.dataChannel.registerSessionDataChannel(e,t)},onUpdateMediaDescriptionsRequired:e=>{this.executeNegotiation(e,"onUpdateMediaDescriptionsRequired",!1)},onRealtimeTelemetryReport:()=>{this.reportTelemetryEvents([{eventName:"realtimetelemetry",props:{user_object_id:{value:$h+this.currentUserSkypeIdentity.id,piiKind:10},call_context_id:{value:this.signalingSession.correlationId,piiKind:0},participant_id:{value:this.participantId,piiKind:0},media_leg_id:{value:this.mediaLegId,piiKind:0},DiagnosticLevel:{value:255,piiKind:0},eventpdclevel:{value:2,piiKind:0},eventpriority:{value:5,piiKind:0},call_technical_info:{value:JSON.stringify(this.mediaSession.getCallTechnicalInfo()),piiKind:0}}}],"realtimeMedia","mdsc")},onTransportConnected:()=>{this.mediaStateConfigurationHelper.isSending(3)&&this.allowDataChannel()?this.mediaControlPlane.onTransportConnected():!this.isInitialSignalingDSHSubscriptionEnabled()&&this.callUsesMixer&&this.updateSignalingDSHMessageSubscription(!0),this.unmixedAudioProvider.setSessionStreamsProvider(this.mediaSession.getUnmixedAudioProvider())}});this.callTelemetry.recordEvent("CreatingConference","",t),this.callDeviceManager||(i.info(`[${t}][initializeMediaSession] Creating new callDeviceManager`),this.callDeviceManager=this.createCallDeviceManager());const r=new gm(this.mediaControlPlane,this.signalingSession,i.createChild("SourceRequestSender"),this.mediaControlPlane.getTelemetryLogger().getSourceRequestSenderDiagnostics),s={maxReinvitelessMediaForVBSSMultiparty:this.signalingSession.getMaxReinvitelessMediaForVBSSForWeb(),maxReinvitelessMediaForVideoMultiparty:this.signalingSession.getMaxReinvitelessMediaForVideoForWeb()};this.callTelemetry.recordEvent("_ReinvitelessConfig",{reinvitelessConfig:s},t),this.mediaSession=new Uu(this.mediaAgent.createSession(n,this.signalingSession.correlationId,{isConference:this.callUsesMixer,isPstnCall:this.isOneToOnePSTNCall(),isParkedCall:this.isParkedCall(),reinvitelessConfig:s},this.callDeviceManager),this.signalingSession,r),this.temporaryCallConstraints&&(i.info(`Applying saved call constraints to current call ${JSON.stringify(this.temporaryCallConstraints)}`),this.mediaSession.setCallConstraints(this.temporaryCallConstraints,Re()).then(this.resolveTemporaryCallConstraints).catch(this.rejectTemporaryCallConstraints).finally((()=>{this.temporaryCallConstraints=void 0,this.rejectTemporaryCallConstraints=void 0,this.resolveTemporaryCallConstraints=void 0}))),this.dataChannel.setConfigProviderView(this.mediaSession.getSessionConfig()),this.callTelemetry.recordEvent("CreatedConference","",t),this.streamManager.setMediaSession(this.mediaSession,t),this.participants.forEach((e=>{e.setMediaSession(this.mediaSession,t)}));const a=this.mediaSession.getSessionConfig()?.config;a?.useOneDsLogger&&a?.addTelemetryReportingCallback&&(this.beforeUnloadTelemetrySender=()=>{this.sendLastKnownStats()},window.addEventListener("beforeunload",this.beforeUnloadTelemetrySender)),this.screenSharingControl&&this.allowDataChannel()&&(this.screenSharingControl.setGiveControlEnabled(this.isGiveControlEnabled()),this.screenSharingControl.setupDataHandlers()),this.unmixedAudioProvider=new dm}executeNegotiation(e,t,i){const n=this.logger.createFnLogger(t,e);if(this.isCallModeStreaming()||this.isEscalationInProgress)return void n.info(`ignored due to being in streaming=${this.isCallModeStreaming()},\n                isEscalationInProgress=${this.isEscalationInProgress}`);const r=Re();3===this.state||4===this.state||5===this.state||10===this.state||this.isPreheatedOnly()?(n.info(`started, state: ${this.state}, runNegotiation: ${i}`),i?(this.callTelemetry.recordEvent("NegotiationRequired","",e),this._callOperationHandler.executeChained((()=>this.renegotiateOutgoing(e)),"_RenegotiateOutgoing",r,e,void 0,void 0,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]})):(this.callTelemetry.recordEvent("UpdateMediaDescriptions","",e),this._callOperationHandler.executeChained((()=>this.updateMediaDescriptions(e)),"_UpdateMediaDescriptions",void 0,e,void 0,void 0,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}))):n.info(`not started, state: ${this.state}`)}async muteUnmuteWorkaround(e){if(this.mediaSession?.getSessionConfig().config.enableMuteSpeakerUnmuteSpeakerWorkaround&&!this.isSpeakerMuted&&25===e.type&&3===e.value&&0===e.mediaType){this.logger.log("Performing muteSpeaker->unmuteSpeaker workaround");const e=Re();await this.muteSpeaker(e),await this.unmuteSpeaker(e)}}sendLastKnownStats(){if(!this.tsCallingTelemetryReported){const e=this.mediaSession.getLastKnownStats(!0);this.callStats.setMediaStats(e),this.reportTelemetryEvents(this.callStats.buildShortBeaconEvent(),"media","mdsc"),this.reportTelemetryEvents(this.callStats.buildShortCallModalityStats(),"signaling"),this.reportTelemetryEvents(this.callStats.buildFromLocalStats(),"signaling","skypecosi_concore_web"),this.callTelemetry.setCallEndDiagnosticInfo(this.callEndDiagnosticsInfo);const t="in_call_session";this.reportTelemetryEvents([{eventName:t,props:this.callTelemetry.getEvent(!0)}],"signaling","skypecosi_concore_web_ts_calling")}}invertDirectionality(e){switch(e){case this.mediaAgent.constants.MEDIA_STATE.sendReceive:return Zu;case this.mediaAgent.constants.MEDIA_STATE.send:return Xu;case this.mediaAgent.constants.MEDIA_STATE.receive:return Qu;default:return null}}completeNegotiationAsync(e){const t=this.logger.createFnLogger("completeNegotiationAsync",e),i=this.mediaSession.completeNegotiationAsync(e).then((i=>{t.info(`activeModalities=${i&&Object.keys(i.activeModalities)}`);const n=this.participants[0],r=n?.endpoints?.endpointDetails.length&&n.endpoints.endpointDetails[0].mediaStreams?.length,s=this.mediaSession.getSessionConfig().config.avoidFakeStreamsDuringEscalation&&this.isEscalationInProgress;if(n&&!this.callUsesMixer&&!s&&!r){const t=(e,t,i)=>({participantId:fm,endpointId:"remote",type:e,direction:this.invertDirectionality(t),sourceId:i,serverMuted:!1}),r=[];r.push(t(ep,i.activeModalities.audio,1)),i.activeModalities.video&&r.push(t(tp,i.activeModalities.video,2)),i.activeModalities.sharing&&r.push(t(ip,i.activeModalities.sharing,3)),n.updateStreams(r,e)}return t.logSuccess(He(i)),i}));return i.catch((i=>{t.logFailure(i),this.callTelemetry.recordEvent("_CompleteNegotiationFailed",{e:i},e)})),i}async renegotiateOutgoing(e){let t;this.renegotiationAnswerDeferred=Ei();const i=this.logger.createFnLogger("renegotiateOutgoing",e);if(this._hasDelayedReconnect)return i.info("Reconnecting with delay"),this._hasDelayedReconnect=!1,void await this.mediaSession.reconnectAsync(e,!0);i.info("start");const n=Kh(i);try{try{t=this.inLocalHold()?this.getMediaModalitiesForHold(e):this.calculateModalityDirections({},e);const i=await n.execute("MediaCreateOffer",(()=>this.mediaSession.createOfferAsync(e))),r=this.getSignalingMediaTypes(t);await n.execute("SignalingStartNegotiation",(()=>this.signalingSession.startRenegotiationAsync(i,r,e)));const s=await n.execute("SignalingRenegotiationAnswer",(()=>this.renegotiationAnswerDeferred.promise));await n.execute("MediaProcessAnswer",(()=>this.mediaSession.processAnswerAsync(s,e,!1)));const a=await n.execute("CompleteNegotiation",(()=>this.completeNegotiationAsync(e)));this.onNegotiationCompletion(a,!0,t,e,n.getTelemetryData())}catch(n){if(i.logFailure(n),!n.phase)throw this.callTelemetry.recordEvent("OutgoingNegotiationFailure",n,e),n;let r="unknown";const s=this.mediaAgent.constants.RENEGOTIATION_ERROR;if(r=s.local,"SignalingRenegotiationAnswer"===n.phase||"SignalingStartNegotiation"===n.phase){const e=415;r=n.error.code===qn.GlareError?s.glare:n.error.code===e?s.media:s.signaling}else"MediaCreateOffer"===n.phase&&n.error.type===this.mediaAgent.constants.MEDIA_ERROR.noNetworkError&&(r=s.media);if(this.callTelemetry.recordEvent("OutgoingNegotiationFailure",this.getTelemetryFromPhaseExecution(n),e),n.error.message?.includes("The requested call does not exist"))throw new Error("Call drop due to remote replying with call not found");i.logFailure(r);const a={type:r,detail:n.error};await this.mediaSession.rejectNegotiationAsync(a,e),this.onNegotiationFailure(n,r,e,t)}}catch(t){i.logFailure(t),this.callTelemetry.recordEvent("NegotiationFatalError",Fe(t),e),this.stopInternal({causeId:e,terminatedReason:47})}}async renegotiateIncoming(e,t){this.mediaAcknowledgmentOperation=this._callOperationHandler.createPendingOperation("_MediaAcknowledgment",null,t,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),this.mediaAcknowledgmentOperation.catch(En);const i=this.logger.createFnLogger("renegotiateIncoming",t);if(i.info("start"),e.newOffer&&!this.mediaAgent.getCapabilities().retargeting)return i.logFailure("Retarget offer received, but pluginless has no support for retarget"),void this.stopInternal({causeId:t,terminatedReason:38});const n=Kh(i);try{const i=await n.execute("MediaProcessOffer",(()=>this.mediaSession.processOfferAsync(e,t)));this.handleOfferedModalities(i,t),2===this.getRenegotiationOfferType(i)&&await this.prepareModalitiesForResume(t);const r=await this.updateMediaModalities({offered:i},t);1===this.getRenegotiationOfferType(i)&&await this.prepareModalitiesForHold(t),this.updateMediaState(r,t),this.isRenegotiationHoldOrResume(r)&&this.updateScreenSharingState(r,t);const s=await n.execute("MediaCreateAnswer",(()=>this.mediaSession.createAnswerAsync(!1,t))),a=this.getSignalingMediaTypes(r);await n.execute("SignalingAcceptRenegotiation",(()=>this.signalingSession.acceptRenegotiationAsync(s,a,t))),await n.execute("SignalingMediaAcknowledgement",(()=>this.mediaAcknowledgmentOperation));const o=await n.execute("CompleteNegotiation",(()=>this.completeNegotiationAsync(t)));this.onNegotiationCompletion(o,!1,i,t,n.getTelemetryData())}catch(e){try{if(!e.phase||"CompleteNegotiation"===e.phase)throw this.callTelemetry.recordEvent("IncomingNegotiationFailure",e,t),e;const n=e;this.callTelemetry.recordEvent("IncomingNegotiationFailure",this.getTelemetryFromPhaseExecution(e),t);const r={type:this.mediaAgent.constants.RENEGOTIATION_ERROR.local,detail:e.error};if("SignalingAcceptRenegotiation"===n.phase||"SignalingMediaAcknowledgement"===n.phase)return i.logFailure("Error in renegotiateIncoming() -> rejecting media negotiation"),r.type=this.mediaAgent.constants.RENEGOTIATION_ERROR.signaling,this._callOperationHandler.maybeRejectOperation("_MediaAcknowledgment",r,void 0,t),void await this.mediaSession.rejectNegotiationAsync(r,t);this._callOperationHandler.maybeRejectOperation("_MediaAcknowledgment",r,void 0,t),await this.mediaSession.rejectNegotiationAsync(r,t),await this.signalingSession.rejectRenegotiationAsync(void 0,t)}catch(e){i.logFailure(e),this.callTelemetry.recordEvent("NegotiationFatalError",Fe(e),t),this.stopInternal({causeId:t,terminatedReason:47})}}}async updateMediaDescriptions(e){const t=this.logger.createFnLogger("updateMediaDescriptions",e);t.info("start");try{const i=await this.mediaSession.startMediaDescriptionsUpdateAsync(e);t.info(`send updateMediaDesriptions, descriptions=${He(i)}`),await this.signalingSession.updateMediaDescriptionsAsync(e,i);const n=await this.mediaSession.completeMediaDescriptionsUpdateAsync(e);this.onUpdateMediaDescriptionsCompletion(n,e)}catch(i){t.logFailure(i),this.callTelemetry.recordEvent("UpdateMediaDescriptionsFailure",i,e);const n=await this.mediaSession.rejectMediaDescriptionsUpdateAsync(e,!0);this.onUpdateMediaDescriptionsFailure(i,n,e)}}handleCallEscalation(e,t){const i=this.logger.createFnLogger("handleCallEscalation",t);if(i.info(`current callType=${this.callType}, escalationInProgress=${e}, isEscalationInProgress=${this.isEscalationInProgress}`),e){const e=this.participants[0];e&&e.audio.participantId===fm?e.updateStreams([{type:ep,direction:"inactive",sourceId:null,serverMuted:!1},{type:tp,direction:"inactive",sourceId:null,serverMuted:!1},{type:ip,direction:"inactive",sourceId:null,serverMuted:!1}],t):i.info("no 1-1 participant found, stream update ignored"),this.setCallType(2,t),this.setCallUsesMixer(!0,t),this.setIsEscalationInProgress(!1,t),this.callTelemetry.recordEvent("_EscalationCompleted",void 0,t),this.raiseChanged()}}async reportTsCallingTelemetry(e){if(this.tsCallingTelemetryReported)return;await this.connectCallPromise.catch(En);const t=e?"call_setup_session":"in_call_session";this.callTelemetry.setCallEndDiagnosticInfo(this.callEndDiagnosticsInfo),this.reportTelemetryEvents([{eventName:t,props:this.callTelemetry.getEvent(e)}],"signaling","skypecosi_concore_web_ts_calling"),e?this.callTelemetry.switchToInCallTelemetry():this.tsCallingTelemetryReported=!0}async sendMidCallTelemetry(e){this.mediaSession&&e?.length&&(this.callStats.setMediaStats(await this.mediaSession.getStatsAsync(!0)),this.appendInfoToCallStats(),this.reportTelemetryEvents(this.callStats.buildMidCallTelemetry(e),"media","mdsc_mid_call_telemetry"))}sendCallSetupTelemetry(){this.mediaSession&&(this.collectCallStats(this.mediaSession),this.reportCallSetupStats(),this.isCallSetupTelemetrySent=!0)}collectCallStats(e){const t=()=>this.collectMediaStatsDeferred.resolve();return e.getStatsAsync(!1).then((e=>this.callStats.setMediaStats(e))).then(t,t)}reportCallSetupStats(){this.collectMediaStatsDeferred.promise.then((()=>{this.reportTelemetryEvents(this.callStats.buildFromCallSetupStats(),"media","mdsc"),this.event("statsReported").raise(),this.collectMediaStatsDeferred=Ei()}))}async reportCallEndStats(e){this.callTelemetry.setTerminationState(this.state),this.callTelemetry.setTerminationReason(this.terminatedReason),this.callStats.localStats.endCall(this.terminatedReason),this.reportTelemetryEvents(this.callStats.buildFromLocalStats(),"signaling","skypecosi_concore_web"),this.reportTsCallingTelemetry(!this._callIsSetupComplete),e&&(await this.collectMediaStatsDeferred.promise,this.callStats.appendTerminationInfo(this.terminatedReason,this.state),this.appendInfoToCallStats(),this.reportTelemetryEvents(this.callStats.buildFromMediaStats(),"media","mdsc")),this.event("statsReported").raise(),this.collectMediaStatsDeferred=Ei()}reportTelemetryEvents(e,t,i){const n=this.telemetryLoggers?this.telemetryLoggers[t]:null;n?e.forEach((e=>n.sendEvent({eventName:`${i?`${i}_`:""}${e.eventName}`,props:e.props}))):this.logger.debug(`reportTelemetryEvents no logger for tenant ${t}`)}onLocalPreviewSizeChanged(e,t){this.logger.debug(`onLocalPreviewSizeChanged: ${e}x${t}`)}onLocalPreviewStateChanged(e){this.logger.debug(`onLocalPreviewStateChanged: ${e}`),this.callStats.localStats.video.streamStateChanged(e.stream)}async configureVideoModalitiesAsync(e,t){if(!this.mediaSession)return this.logger.warn("Tried to configure modalities after call end"),Promise.resolve();await this.updateMediaModalities(void 0,t),e||this.turnOffLocalVideoPreview(t),this.setVideoOn(e,t)}turnOffLocalVideoPreview(e){return this.localVideoRenderer&&(this.localVideoRenderer.dispose(),this.localVideoRenderer=null),Promise.resolve(void 0)}turnOnLocalVideoPreview(e){const t=this.logger.createFnLogger("_StartPreviewVideo",e),i=this.mediaStateConfigurationHelper.isSending(1);if(!i||!this.localVideoContainer)return Promise.reject(`could not start video preview: requestedVideoState=${i}, localVideoContainer=${this.localVideoContainer}`);this.turnOffLocalVideoPreview(e);const n=Ti((()=>{this.localVideoRenderer=this.callDeviceManager.getDeviceManager(wu(1)).createPreviewRenderer(this.localVideoContainer),this.localVideoRenderer.on("onVideoSizeChanged",((e,t)=>this.onLocalPreviewSizeChanged(e,t))),this.localVideoRenderer.on("onVideoStateChanged",(e=>this.onLocalPreviewStateChanged(e)))})).then((()=>this.localVideoRenderer.startVideoAsync(e)));return n.catch((e=>t.logFailure(e))),n}startStopVideo(e,t){const i=this.logger.createFnLogger(e?"startVideo":"stopVideo",t);if(i.info("start"),!this.canToggleVideo)return e===this.mediaStateConfigurationHelper.isSending(1)?this.videoTogglePromise.then((()=>{this.turnOnLocalVideoPreview(t)})):(i.logFailure(`video switching is in progress ${e}]`),Promise.reject({reason:1}));e?(this.callStats.localStats.newSession(1),this.callStats.localStats.video.start()):this.callStats.localStats.video.stop(),e&&this.mediaStateConfigurationHelper.isDisabled(1)&&i.info("Video modality was skipped till now. Adding it now."),e?this.mediaStateConfigurationHelper.enableModality(1):this.mediaStateConfigurationHelper.removeModality(1),this.canToggleVideo=!1;const n=()=>{this.canToggleVideo=!0};return this.videoTogglePromise=Promise.resolve().then((()=>!!e&&(this.localVideoContainer||(this.localVideoContainer=document.createElement("div")),this.turnOnLocalVideoPreview(t).then((()=>!0))))).then((e=>this.configureVideoModalitiesAsync(e,t))).catch((e=>(i.logFailure(e),this.mediaStateConfigurationHelper.removeModality(1),this.configureVideoModalitiesAsync(!1,t).then((()=>{throw e}))))).then(n,(e=>{throw i.logFailure(e),n(),e})),this.videoTogglePromise}async startStopAudio(e,t){const i=this.logger.createFnLogger(e?"startAudio":"stopAudio",t);try{const e=await this.updateMediaModalities(void 0,t);this.updateMediaState(e,t)}catch(e){return i.logFailure(e),9}return 0}updateEndpointStateForMute(e,t){try{this.signalingSession.updateEndpointState({state:{isMuted:e}},t).catch((e=>{this.logger.logFailure(`updateEndpointStateForMute failure: ${e}`)}))}catch(e){this.logger.logFailure(`updateEndpointStateForMute failure: ${e}`)}}async handleServerMutedState(e){const t=this.logger.createFnLogger(`handleServerMutedState, isServerMuted=${!!this.isServerMuted}`,e);if(!this.isServerMuted){const i=3===this._muteState;if(1===this._muteState||i)try{t.info("is unmuting, as we are no longer server muted"),await this.handleMuteUnmuteOnMediaSession(!1,e),this.setMuted(0,e),this.unmutePendingPromise?.resolve(),i&&this.updateEndpointStateForMute(!1,e)}catch(e){throw t.logFailure(e),e}}if(this.isServerMuted&&0===this._muteState){t.info("is muting, as we are unmuted");try{await this.handleMuteUnmuteOnMediaSession(!0,e),this.setMuted(1,e)}catch(e){throw t.logFailure(e),e}}}async handleMuteUnmuteOnMediaSession(e,t){const i=this.logger.createFnLogger(`handleMuteUnmuteOnMediaSession, value=${!!e}`,t);if(this.mediaSession&&this.mediaSession.getAllowedModalities&&!this.isServerMuted){const n=this.isMuted||this.isServerMuted,r=this.mediaSession.getAllowedModalities().audio.some((e=>e===Qu||e===Zu));(n&&r||!n&&!r)&&(i.info(`updating audio modalities: Muted ${n} -> ${e}; audioAllowed = ${r}`),await this.updateMediaModalities(void 0,t))}return e?(i.info("mediaSession.muteInputAsync"),await this.mediaSession.muteInputAsync(t)):e||(i.info("mediaSession.unmuteInputAsync"),await this.mediaSession.unmuteInputAsync(t)),Promise.resolve()}updateCapabilities(e,t=!1){let i=!1,n=!1;if(!Jh(this.state,[11,12])){const e="attendee"===(this.advancedMeetingRole||this.meetingRole);this.isServerMuted&&!this._callInLobby?2&this._commandUrlPresence&&(i=!0):this.isMuted&&(i=!0),n=!!(1&this._commandUrlPresence)&&!e}this._capabilities.canUnmuteSelf===i&&this._capabilities.canMuteOthers===n||(this._capabilities.canUnmuteSelf=i,this._capabilities.canMuteOthers=n,this.logger.info(`[${e}][updateCapabilities] Computed self capabilities: ${JSON.stringify(this._capabilities)}`),t&&this.raiseChanged())}async evaluateEndpointStatesForAccept(e,t,i){const n=this.logger.createFnLogger(`evaluateEndpointStatesForAccept, isMuted=${!!e}`,i),r={};try{await this.handleMuteUnmuteOnMediaSession(e,i),Object.assign(r,{state:{isMuted:e}}),n.info("is updating endpointState for mute"),t&&(Object.assign(r,{endpointProperties:{additionalEndpointProperties:t}}),n.info("is updating endpointState for additionalEndpointProperties"))}catch(e){throw n.logFailure(e),$n(e)}return r}async handleEndpointStatesForAccept(e,t){const i=this.logger.createFnLogger("handleEndpointStatesForAccept",t);try{await this.signalingSession.updateEndpointState(e,t)}catch(e){throw i.logFailure(e),$n(e)}}async muteUnmute(e,t){const i=this.logger.createFnLogger(`muteUnmute, value=${!!e} isServerMuted=${this.isServerMuted} inLobby=${this._callInLobby}`,t);if(Jh(this.state,[11,12]))return i.logFailure("Can not mute/unmute during preheat call"),Promise.reject($n("TransactionDisallowed"));const n=!e&&(!this.isServerMuted||this._callInLobby);try{if((e||n)&&await this.handleMuteUnmuteOnMediaSession(e,t),e)this.setMuted(2,t),i.info("is updating endpointState for mute"),this.updateEndpointStateForMute(!0,t);else{if(!n)return i.info("is unmuting on server"),2===this._muteState&&this.setMuted(3,t),this.isCallModeStreaming()?this.promoteToRealtimeAndUnmute(t):this.signalingSession.unmuteAsync(t).then((e=>{this.handleSelfUnmuteUpdatedInfo(e,t)}));i.info("is updating endpointState for unmute"),this.setMuted(0,t),this.updateEndpointStateForMute(!1,t)}}catch(e){throw i.logFailure(e),$n(e)}}async muteUnmuteSpeaker(e,t){this.setSpeakerMuted(e,t),this.mediaSession&&(e?await this.mediaSession.muteOutputAsync(t):await this.mediaSession.unmuteOutputAsync(t))}getParticipant(e){return this.participants.filter((t=>t.isSameParticipantsMri(e)))[0]}getOrCreateParticipant(e,t,i){let n=this.getParticipant(e);return n||(n=new _p(e,this.mediaSession,this.logger,this.callStats.localStats,this.callTelemetry,t),n.changed((()=>this.onParticipantChanged(n))),this.participants.push(n),i&&this.event("participantAdded").raise(n),this.monitorCallStart(),n)}onParticipantChanged(e){this.event("participantUpdated").raise(e),this.raiseChangedDeferred(this._participantChangedEventSkipConfig)}setCallState(e,t,i=0){if(this.state===e)return;const n=this.logger.createFnLogger("setCallState",t);n.info(`currentState=${this.state}, newState=${e}, terminatedReason=${this.terminatedReason}`),(Zh[this.state].indexOf(e)>=0||(n.logFailure("invalid state transition"),7===e))&&(this.callTelemetry.recordEvent("_SetCallState",{state:e,reason:i},t),this.state=e,this.callStats.localStats.call.callStateChanged(e),7===e&&this.setTerminatedReason(i),3===e&&(this.callGotConnected=!0,this.callHeldAt=null),this.callIsHeld()&&!this.callHeldAt&&(this.callHeldAt=new Date),n.logSuccess(`changed to ${e}, terminatedReason: ${this.terminatedReason}, failureType=${this.failureType}`),this.screenSharingControl.callStateChanged(this.state),this.monitorCallStart(),this.event("callStateChanged").raise(),this.updateCapabilities(t),this.raiseChanged(),this.callTelemetry.recordEvent("_RaiseCallStateChangeEvent",{state:e,reason:i},t))}setTerminatedReason(e){if(this.terminatedReason=e,!(0,Cr.includes)(mm,e)){const e=44===this.terminatedReason,t=55===this.terminatedReason,i=56===this.terminatedReason;this.setFailureType(!this.callGotConnected||!this._wasAudioStreamConnected||e||t||i?0:1)}}setMediaStream(e,t,i){if(e){if(!(0,Cr.find)(this.localMediaStreams,(e=>e.mediaType===i))){const e=new Sm(t,i);this.logger.info(`setMediaStream ${JSON.stringify(e)}`),this.localMediaStreams.push(e)}}else this.logger.info(`setMediaStream removing ${i}`),(0,Cr.remove)(this.localMediaStreams,(e=>e.mediaType===i))}setVideoOn(e,t){this.logger.info(`[${t}]videoOn=${e}`),this.isVideoOn=e,this.setMediaStream(this.isVideoOn,!0,1),this.callTelemetry.recordEvent("_SetLocalVideo",{value:e},t),this.raiseChanged()}setAudioOn(e,t){this.logger.info(`[${t}]audioOn=${e}`),this.setMediaStream(e,!0,0),this.callTelemetry.recordEvent("_SetLocalAudio",{value:e},t)}setScreenSharingOn(e,t){this.logger.info(`[${t}]screenSharingOn=${e}`),this.isScreenSharingOn=e,this.setMediaStream(this.isScreenSharingOn,this.isScreenSharingOn,2),this.callTelemetry.recordEvent("_SetScreenSharing",{screenSharingOn:e},t),this.event("userActivityChanged").raise(),this.raiseChanged()}disposeSharingScreenHandle(){this.sharedScreenHandle&&(this.unsubscribeFromSharedScreenHandleEvents(),this.sharedScreenHandle.dispose(),this.sharedScreenHandle=null)}setMuted(e,t){this._muteState!==e&&(this._muteState=e,this.callTelemetry.recordEvent("_SetMuted",{isMuted:e},t),this.logger.info(`[${t}]participantMuteState:${e}, isMuted: ${this.isMuted}`),this.updateCapabilities(t),this.raiseChanged(),this.event("muteStateChanged").raise(this.isMuted,t))}setSpeakerMuted(e,t){this.logger.info(`[${t}]speakerMute=${e}]`),this.isSpeakerMuted=e,this.raiseChanged()}monitorCallStart(){3!==this.state||!this.participants.length&&2!==this.callMode||this.callStartedAt||(this.callStartedAt=new Date)}_removeParticipant(e,t,i=0){const n=this.logger.createFnLogger("removeParticipant",t);n.info(`mri=${ju(e)}`);const r=(0,Cr.remove)(this.participants,(t=>t.isSameParticipantsMri(e.id)))[0];r?(r.setState(4,i,t),this.event("participantRemoved").raise(r)):n.logFailure(`unable to remove participant ${ke(e.id)}`),this.raiseChanged(this._participantChangedEventSkipConfig)}setIsSomeoneSharing(e,t){const i=this.isSomeoneSharing!==e&&!(e&&this.screenSharingRenegotiationDeferred&&this.callUsesMixer);i&&(this.isSomeoneSharing=e);let n=i;if(this.callUsesMixer&&this.mediaSession?.getSessionConfig().config.enableStopSharingWithIncomingOffer&&(n||(n=t)),n&&this.isSomeoneSharing&&this.isScreenSharingOn&&(this.stopScreenSharing(),this.logger.info("sharingStolen: Cleaning up local screenshare because remote screenshare is running"),this.event("sharingStolen").raise()),this.allowScreenSharingControl()){const e=this.localSignalingParticipant.endpointDetails.find((e=>this._endpointId===e.endpointId)),t=this.participants.find((e=>e.streams[1].some((e=>e.isAvailable))));this.screenSharingControl.startOrStopControlForViewer(this.isSomeoneSharing,t,e)}}handleOfferedModalities(e,t){const i=this.mediaAgent.constants.MEDIA_STATE,n=this.logger.createFnLogger("handleOfferedModalities",t);try{n.info(`offeredModalities=${He(e)}`)}catch(e){n.logFailure(e)}e.hasOwnProperty("video")||this.mediaStateConfigurationHelper.isSending(1)?e.hasOwnProperty("video")&&!this.mediaStateConfigurationHelper.isSending(1)&&this.mediaStateConfigurationHelper.removeModality(1):this.mediaStateConfigurationHelper.disableModality(1),e.hasOwnProperty("sharing")||this.mediaStateConfigurationHelper.isSending(2)||this.mediaStateConfigurationHelper.disableModality(2),e.sharing!==i.receive||this.mediaStateConfigurationHelper.isSending(2)||this.mediaStateConfigurationHelper.removeModality(2),e.data===i.sendReceive&&this.allowDataChannel()&&this.mediaStateConfigurationHelper.enableModality(3),this.setIsSomeoneSharing(e.sharing===i.receive,!0),this.isSomeoneStreamingVideo=e.video===i.receive||e.video===i.sendReceive}getRenegotiationOfferType(e){if(e)if(5===this.state){if("sendrecv"===e.audio)return 2}else if(this.modalitiesAreHold(e))return 1;return 0}isRenegotiationHoldOrResume(e){return 1===this.getRenegotiationOfferType(e)||2===this.getRenegotiationOfferType(e)}isValidHoldResumeCallState(e){return[3,5,10,13].includes(e)}onNegotiationCompletion(e,t,i={},n,r){const s=this.logger.createFnLogger("onNegotiationCompletion",n);s.info(`byLocal=${t}, result=${He(e)}`),this.callTelemetry.recordEvent("NegotiationCompletion",{phaseTelemetryBag:r,...this.prepareNegotiationResultForTelemtry(e)},n);const a=this.isOneToOneCall();if(a){const t=this.modalitiesAreHold(e.activeModalities)?5:3;this.participants[0].setState(t,void 0,n),s.info(`isOneToOneCall: participant[0] state set to ${t}`)}const o=this.modalitiesAreHold(e.configuredModalities),l=this.modalitiesAreHold(e.activeModalities);let d;const c=this.signalingSession.participantManager.localParticipant.isStaging;s.info(`isStaging= ${c}`),this.requestedHoldState?(o&&l||s.info(`Not expected modalities when processing local hold: ${o} ${l}`),4!==this.state&&s.info(`Not expected state when processing local hold: ${this.state}, switching back to LocalHold`)):t||this.callHoldResumeDeferred?!o&&l?d=5:o||l||this._callInLobby||this.isPreheatedOnly()||(d=c?13:3):4===this.state||this._callInLobby||this.isPreheatedOnly()||(d=a&&5===this.participants[0].state?5:c?13:3),d&&this.setCallState(d,n),this.callHoldResumeDeferred&&(s.info(`isHoldInProgress=${this.isHoldInProgress}, state=${this.state}, completed=${l}`),this.isHoldInProgress?l&&this.finishCallHoldResume():this.inLocalHold()||this.finishCallHoldResume(this.isValidHoldResumeCallState(d)?void 0:new Error(`Call state changed to ${d} instead of Connected, Lobby, Staging or RemoteHold`))),this.requestedHoldState||(this.setIsSomeoneSharing((0,Cr.some)(this.participants,(e=>(0,Cr.some)(e.streams[1],(e=>e.isAvailable))))),this.isSomeoneStreamingVideo=(0,Cr.some)(this.participants,(e=>(0,Cr.some)(e.streams[0],(e=>e.isAvailable)))));const h=i&&i.sharing===this.mediaAgent.constants.MEDIA_STATE.send,u=e?.activeModalities?.sharing===this.mediaAgent.constants.MEDIA_STATE.send;if(this.resolveScreenSharingRenegotiation(n,h,u,e.isComplete),this.retryOutgoingRenegotiation.retry){const e=this.retryOutgoingRenegotiation.causeId;this._callOperationHandler.executeChained((()=>this.updateMediaModalities(void 0,e)),"_Renegotiate",e,e,void 0,void 0,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),this.retryOutgoingRenegotiation.retry=!1}}onUpdateMediaDescriptionsFailure(e,t,i){const n=t?.requestedModalities.sharing===this.mediaAgent.constants.MEDIA_STATE.send;this.screenSharingRenegotiationDeferred&&n&&(this.screenSharingRenegotiationDeferred.reject(e),this.screenSharingRenegotiationDeferred=null)}onUpdateMediaDescriptionsCompletion(e,t){this.logger.createFnLogger("onUpdateMediaDescriptionsCompletion",t).info(`result=${He(e)}`),this.callTelemetry.recordEvent("UpdateMediaDescriptionsCompletion",e,t);const i=e?.requestedModalities?.sharing===this.mediaAgent.constants.MEDIA_STATE.send,n=e?.appliedModalities?.sharing===this.mediaAgent.constants.MEDIA_STATE.send;this.resolveScreenSharingRenegotiation(t,i,n,!0)}resolveScreenSharingRenegotiation(e,t,i,n){const r=this.logger.createFnLogger("resolveScreenShareRenegotiation",e);if(r.info(`invoked with wasSharingOfferred: ${t}, isSharingActive: ${i}, isComplete: ${n}`),this.screenSharingRenegotiationDeferred)if(t&&i)r.info("resolving screenSharingRenegotiationDeferred"),this.screenSharingRenegotiationDeferred.resolve(),this.screenSharingRenegotiationDeferred=null;else if(this._enableResolveScreenSharingWhenNegotiationComplete&&n&&!this.retryOutgoingRenegotiation.retry&&this.canToggleScreenSharing){const e=new Error(`screenSharing error: wasSharingOfferred: ${t}, isSharingActive: ${i}`);r.info(`reject screenSharingRenegotiationDeferred ${e}`),this.screenSharingRenegotiationDeferred.reject(e),this.screenSharingRenegotiationDeferred=null}}async updateMediaStatus(e){if(this.calculateIsSomeoneStreaming(e),this.mediaSession){const t=await this.updateMediaModalities(void 0,e);this.callTelemetry.updateOperationData("_UpdateLocalMediaStatus",t,e)}}calculateIsSomeoneStreaming(e){let t=!1,i=!1;for(const e of this.participants)if(t||(t=(0,Cr.some)(e.streams[1],(e=>e.isAvailable))),i||(i=(0,Cr.some)(e.streams[0],(e=>e.isAvailable))),t&&i)break;this._hasDelayedReconnect&&(t||i)&&(this.logger.info("Reconnecting with delay"),this._hasDelayedReconnect=!1,this._callOperationHandler.executeChained((()=>this.mediaSession.reconnectAsync(e,!0)),"_RenegotiateOutgoing",e,e,void 0,void 0,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]})),this.setIsSomeoneSharing(t),this.isSomeoneStreamingVideo=i}onNegotiationFailure(e,t,i,n){const r=n&&n.sharing===this.mediaAgent.constants.MEDIA_STATE.send;if(t===this.mediaAgent.constants.RENEGOTIATION_ERROR.glare)return this.screenSharingRenegotiationDeferred&&r&&this.callStats.localStats.screenShare.negotiationStateChanged("rejected","glare"),void(this.retryOutgoingRenegotiation={retry:!0,causeId:i});const s=new Error(`Error in renegotiateOutgoing() -> rejecting hold for callId = ${this.callId}, reason=${t}`);s.innerError=e,this.finishCallHoldResume(s),this.screenSharingRenegotiationDeferred&&r&&(this.screenSharingRenegotiationDeferred.reject(e),this.screenSharingRenegotiationDeferred=null)}static getParticipantReasonFromTerminatedReason(e){switch(e){case 1:return 0;case 9:return 2;case 10:return 3;case 2:return 4;case 24:return 8;case 3:return 9;case 4:return 10;case 14:return 12;case 0:default:return 11;case 15:return 13;case 16:return 14;case 17:return 15;case 18:return 16;case 19:return 17;case 20:return 18;case 11:return 19;case 21:return 20;case 22:return 21;case 23:return 22;case 33:return 25;case 36:return 26;case 37:return 27;case 41:return 30;case 39:return 28;case 42:return 31;case 40:return 29;case 43:return 32;case 44:return 33;case 45:return 34;case 46:return 35;case 47:return 36;case 48:return 37;case 49:return 38;case 50:return 39;case 51:return 40;case 52:return 41;case 54:return 42;case 55:return 44;case 56:return 45;case 12:return 23;case 59:return 46;case 73:return 59;case 61:return 47;case 60:return 48;case 62:return 49;case 63:return 50;case 64:return 5;case 65:return 51;case 8:return 52}}isRemoteParticipantInStaging(e){if(!e.endpointDetails)return!1;for(const t of e.endpointDetails)if(!bc(t))return!1;return!0}updateCallParticipantFromSignalingParticipant(t,i,n){if((0,Cr.every)(i.endpointDetails,(e=>e?.isLobby||e?.streamLobby)))return void t.setState(7,void 0,n);const r=(0,Cr.some)(i.endpointDetails,(e=>e?.streamInformation)),s=i.endpointDetails&&(0,Cr.some)(i.endpointDetails,(e=>e.mappedTo)),a=e.filterVirtualEndpoints(i.endpointDetails),o=a&&a[0].mediaStreams,l=this.isRemoteParticipantInStaging(i);if(o&&o.length>0){const e=o.every((e=>"inactive"===e.direction));let i=e?5:l?8:3;1!==this.state||e||this.callUsesMixer||(i=2),this.logger.info(`[updateCallParticipantFromSignalingParticipant]: with mediaStreams is not empty, ParticipantState is set to ${i}`),t.setState(i,void 0,n)}else if(o||s||r){const e=l?8:3;this.logger.info(`[updateCallParticipantFromSignalingParticipant]: ParticipantState is set to ${e}, mediaStreams=${!!o}, hasMappedEndpoints=${s}, hasPlayerStreams=${r}`),t.setState(e,void 0,n)}}handleSelfServerMutedState(t){const i=e.filterVirtualEndpoints(this.localSignalingParticipant.endpointDetails),n=(0,Cr.find)(i,(e=>this._endpointId===e.endpointId)),r=n&&n.mediaStreams,s=r&&r.filter((e=>"audio"===e.type||"audio-teleconferencing"===e.type)),a=n&&(n.stream||n.streamLobby);if(a){const e=a.serverMuted??!1;n.serverMuteVersion=0,e!==this.isServerMuted&&(this.isServerMuted=e,this.callTelemetry.recordEvent("_SelfParticipantUpdated",{isServerMuted:this.isServerMuted}),this.logger.info(`updateLocalParticipant: server muted set to ${e}`),this.event("serverMutedChanged").raise(e,t),this.updateCapabilities(t,!0),this.isServerMuted&&this.setMuted(1,t))}else if(s&&s.length>0){const e=s.some((e=>e.serverMuted));e!==this.isServerMuted&&(this.isServerMuted=e,this.callTelemetry.recordEvent("_SelfParticipantUpdated",{isServerMuted:this.isServerMuted}),this.logger.info(`updateLocalParticipant: server muted set to ${e}`),this.event("serverMutedChanged").raise(e,t),this.updateCapabilities(t,!0),this.handleServerMutedState(t))}}checkIfIncomingServerMutedIsUpdated(e){const t=(0,Cr.find)(this.localSignalingParticipant.endpointDetails,(e=>e.participantId===this.localSignalingParticipant.participantId));if(void 0===t)return;const i=(0,Cr.find)(e.endpointDetails,(e=>e.participantId===this.localSignalingParticipant.participantId));Vu(this.logger,t,i)}convertWiredPublishedState(e){if(!e)return;const t=xs(e.stateType);return{content:e.content,stateType:t,typeRank:e.typeRank,stateId:e.stateId}}updatePublishedStateModified(e,t){e!==this.currentUserSkypeIdentity.id||t&&t!==this.participantId?this._publishedStatesModified=2|this._publishedStatesModified:this._publishedStatesModified=1|this._publishedStatesModified}updatePublishedStates(e){try{let t=[];(0,Cr.forEach)(e.publishedStates,(e=>{t.push(this.convertWiredPublishedState(e))})),(0,Cr.isEqual)(this._participantPublishedStatesMap[e.id],t)||(0!==t.length||void 0!==this._participantPublishedStatesMap[e.id]&&null!==this._participantPublishedStatesMap[e.id])&&(this._participantPublishedStatesMap[e.id]=t,this.updatePublishedStateModified(e.id));const i=[];(0,Cr.forEach)(e.endpointDetails,(n=>{i.push(n.participantId),t=[],(0,Cr.forEach)(n.publishedStates,(i=>{const r=this.convertWiredPublishedState(i);this._endpointPublishedStatesMap[e.id]||(this._endpointPublishedStatesMap[e.id]={},this._endpointPublishedStatesMap[e.id][n.participantId]=[]),t.push(r)})),this._endpointPublishedStatesMap[e.id]&&!(0,Cr.isEqual)(this._endpointPublishedStatesMap[e.id][n.participantId],t)&&(0!==t.length||null!==this._endpointPublishedStatesMap[e.id][n.participantId]&&void 0!==this._endpointPublishedStatesMap[e.id][n.participantId])&&(this._endpointPublishedStatesMap[e.id][n.participantId]=t,this.updatePublishedStateModified(e.id,n.participantId))})),this._endpointPublishedStatesMap[e.id]&&Object.keys(this._endpointPublishedStatesMap[e.id]).forEach((t=>{i.some((e=>e===t))||(delete this._endpointPublishedStatesMap[e.id][t],this.updatePublishedStateModified(e.id,t))}))}catch(e){this.logger.error(`updatePublishedStates ${JSON.stringify(e)}`)}this.logger.info(`updatePublishedStates ${JSON.stringify(this._participantPublishedStatesMap)}`),this.logger.info(`updatePublishedStates ${JSON.stringify(this._endpointPublishedStatesMap)}`)}removePublishedStatesByParticipant(e){this._endpointPublishedStatesMap[e]&&delete this._endpointPublishedStatesMap[e],this._participantPublishedStatesMap[e]&&delete this._participantPublishedStatesMap[e],this.updatePublishedStateModified(e)}findOrCreateTypeState(e){let t=this._publishedStates.typeStates.findIndex((t=>t.type===e));if(-1===t){const i={participantStates:[],type:e};this._publishedStates.typeStates.push(i),t=this._publishedStates.typeStates.length-1}return t}processPublishedStates(){this.logger.info(`processPublishedStates ${JSON.stringify(this._participantPublishedStatesMap)}`),this.logger.info(`processPublishedStates ${JSON.stringify(this._endpointPublishedStatesMap)}`);try{this._publishedStates||(this._publishedStates={typeStates:[]}),this._publishedStates.typeStates=[];for(const e of Object.keys(this._participantPublishedStatesMap)){const t=this._participantPublishedStatesMap[e];(0,Cr.forEach)(t,(t=>{const i=this.findOrCreateTypeState(t.stateType),n={id:e,publishedState:{content:t.content,stateId:t.stateId,typeRank:t.typeRank}};this._publishedStates.typeStates[i].participantStates.push(n)}))}for(const e of Object.keys(this._endpointPublishedStatesMap))for(const t of Object.keys(this._endpointPublishedStatesMap[e]))this._endpointPublishedStatesMap[e][t].forEach((i=>{const n=this.findOrCreateTypeState(i.stateType),r={id:t,publishedState:{content:i.content,stateId:i.stateId,typeRank:i.typeRank}},s={id:e,endpoints:[r]},a=this._publishedStates.typeStates[n].participantStates.filter((t=>t.id===e));a&&a.length>0?(a[0].endpoints||(a[0].endpoints=[]),a[0].endpoints.push(r)):this._publishedStates.typeStates[n].participantStates.push(s)}));this.event("publishedStatesChanged").raise(this._publishedStates),this.raiseChanged()}catch(e){this.logger.error(`processPublishedStates ${e}}`)}}updateLocalParticipant(t,i){const n=this.logger.createFnLogger("updateLocalParticipant",i);this.checkIfIncomingServerMutedIsUpdated(t),this.localSignalingParticipant.endpointDetails=t.endpointDetails,this.localSignalingParticipant.role=t.role,this.setMeetingRole(t.meetingRole),this.setAdvancedMeetingRole(t.advancedMeetingRole),this.setParticipantType(t.participantType),this.setPropertyBag(t.propertyBag),this.setPropertyRosterVersion(t.version),this.setMaskedIdentityDetails(t.isIdentityMasked,t.maskedIdSeqNumber,t.maskedId),this.localSignalingParticipant.tenantId=t.tenantId,this.localSignalingParticipant.isLobby=t.isLobby,t.joinAsStreamingUser&&(this.localSignalingParticipant.joinAsStreamingUser=t.joinAsStreamingUser,this.setJoinAsStreamingUser(t.joinAsStreamingUser)),void 0!==t.enableCaptcha&&this.setEnableCaptcha(t.enableCaptcha),this.callTelemetry.setTenantId(t.tenantId),this.callStats.setTenantId(t.tenantId);const r=this.localSignalingParticipant.isLobby;t.endpointDetails&&this.updateLocalParticipantEndpoints(t.endpointDetails),this.updatePublishedStates(t),this.handleSelfServerMutedState(i);const s=this.getLocalSignalingEndpointDetails();this._callInLobby=r||!!s?.streamLobby,this.signalingSession.participantManager.localParticipant.isStaging=t.isStaging;const a=this.signalingSession.participantManager.localParticipant.isStaging;n.info(`callInLobby = ${r}, callSetupComplete = ${this._callIsSetupComplete}, callIsHeld = ${this.callIsHeld()}, isStaging = ${a}`),!this._callIsSetupComplete||this.callIsHeld()||Jh(this.state,[11,12])||(r?this.setCallState(10,i):a&&Jh(this.state,[3,13,10,9,2])?this.setCallState(13,i):this.setCallState(3,i));const o=e.getStreamsFromEndpoints(t.endpointDetails);if(this.callTelemetry.recordEvent("_UpdateLocalParticipantStream",function(e){let t=[];return e.forEach((e=>{try{let i=t.find((t=>t.participantId===e.participantId&&t.endpointId===e.endpointId));i||(i={participantId:e.participantId,endpointId:e.endpointId},t.push(i)),"audio"!==e.type&&"audioteleconference"!==e.type||(i.serverMuted=e.serverMuted),i[e.type]=e.direction}catch(e){t=[]}})),t}(o),i),this.streamManager.updateStreams(o,i),this.updateCapabilities(i,!0),this.allowScreenSharingControl()){const e=t.endpointDetails.find((e=>this._endpointId===e.endpointId)),i=this.participants.find((e=>e.streams[1].some((e=>e.isAvailable))));this.screenSharingControl.startOrStopControlForViewer(this.isSomeoneSharing,i,e)}}modalitiesAreHold(e){return!(e.audio&&"inactive"!==e.audio||e.video&&"inactive"!==e.video||e.sharing&&"inactive"!==e.sharing)}toneToString(e){switch(e){case 0:return"0";case 1:return"1";case 2:return"2";case 3:return"3";case 4:return"4";case 5:return"5";case 6:return"6";case 7:return"7";case 8:return"8";case 9:return"9";case 10:return"*";case 11:return"#";default:return null}}static streamingStatetoMediaStreamState(e){switch(e){case"started":return 0;case"active":return 2;case"inactive":return 1;case"stopped":return 3;default:return 4}}static streamingDirectionToMediaDirectionMapping(e){switch(e){case"send":return 1;case"receive":return 0;default:return}}static convertMuteScope(e){switch(e){case 0:return"EveryoneElse";case 1:return"SpecifiedParticipants";default:return}}callIsHeld(){return 4===this.state||5===this.state}inLocalHold(){return this.isHoldInProgress||4===this.state}telemetryDataFromCallStartOptions(e){const t={};return e.muteFlags&&(t.muteMicrophone=!!(1&e.muteFlags),t.muteSpeaker=!!(2&e.muteFlags)),Object.keys(t).length?t:void 0}reconnect(){const e=Re();return this.mediaSession.reconnectAsync(e)}async provideCallQualityFeedback(e,t,i,n){}async showCQFInfo(e,t){throw new Error("Not implemented")}async isCqfRendered(e){}async provideCallQualityFeedbackEx(e,t,i,n,r,s){}testTriggerMediaRelayWhiteListingIssue(){this.logger.info("Simulating media relay whitelisting issue for test purposes");const e=this.mediaSession.mediaSession.callback;e.onQualityChanged({type:"NetworkRelaysNotReachable",value:"Bad",isLocalSource:!0,mediaType:"Audio"}),e.onAudioStateChanged({direction:"send",stream:"failed",content:"audio"})}async getMediaTelemetry(e=!1){return this.mediaSession&&(this.callStats.setMediaStats(await this.mediaSession.getStatsAsync(e)),this.appendInfoToCallStats()),this.callStats.buildMediaTelemetry()}getMediaSessionStats(){return this.mediaSession?.getMediaStatsReport()}getDiagnosticsForE2E(){return this.mediaSession?.getDiagnostics().e2eDiagnostics}appendInfoToCallStats(){this.callStats.appendDataChannelInfo(this.dataChannel.getTelemetry()),this.callStats.appendSharingControlInfo(this.screenSharingControl?.isScreenSharingControlEnabled()),this.callStats.appendMediaControlPaneInfo(JSON.stringify(this.mediaControlPlane.getTelemetryReport()))}getMediaLogs(){return this.mediaAgent.getMediaLogs()}testSetCallState(e){this.logger.info(`Overwriting call state for test purposes: ${this.state} -> ${e} `),this.state=e}testSetCallType(e){this.logger.info(`Overwriting call state for test purposes: ${this.callType} -> ${e} `),this.callType=e}addGroupModality(e,t=Re()){const i=this.logger.createFnLogger("AddGroupModality",t);if(!e.threadId&&!e.groupId)return Promise.reject($n("No threadId/groupId was provided."));if(6===this.state||7===this.state)return i.info(`Not adding modality because CallState is ${this.state} groupId=${ke(e.groupId)}, threadId = ${Le(e.threadId)} messageId = ${e.messageId}`),Promise.reject($n("TransactionDisallowed"));let n;if(e.additionalData)try{n=JSON.stringify(e.additionalData)}catch(t){i.logFailure(`additionalData: ${e.additionalData} is not valid Json, error: ${t}`);const n={code:qn.BadRequest,subCode:0,phrase:`additionalData is not valid Json, error: ${t}`};return Promise.reject(n)}i.info(`groupId=${ke(e.groupId)}, threadId = ${Le(e.threadId)} messageId = ${e.messageId} additionalData = ${ke(n)}`);const r={groupId:e.groupId,threadId:e.threadId,messageId:e.messageId,additionalData:n};return this.signalingSession.addGroupModalityAsync(r,t).catch((e=>(i.logFailure(Ve(e)),Promise.reject(e))))}addBroadcastModality(e,t){const i=this.logger.createFnLogger("AddBroadcastModality",t);return Promise.resolve().then((()=>{this.signalingSession.addBroadcastModalityAsync(e,t)})).catch((e=>(i.logFailure(Ve(e)),Promise.reject($n(e))))).then((()=>this._callOperationHandler.waitForOperation("AddBroadcastModality"))).catch((e=>{throw this.callTelemetry.updateOperationData("AddBroadcastModality",{error:Fe(e)},t),i.logFailure(e),e}))}static convertQualityEventType(e){switch(e){case"NetworkSendQuality":return 1;case"NetworkRecvQuality":return 2;case"NetworkDelay":return 3;case"NetworkBandwidthLow":return 4;case"NetworkReconnect":return 5;case"NetworkPacketLoss":return 6;case"NetworkJitter":return 7;case"NetworkRateMatching":return 8;case"DeviceCaptureNotFunctioning":return 9;case"DeviceRenderNotFunctioning":return 10;case"DeviceRenderGlitches":return 11;case"DeviceLowSNR":return 12;case"DeviceLowSpeechLevel":return 13;case"DeviceClipping":return 14;case"DeviceEcho":return 15;case"DeviceNearEndToEchoRatio":return 16;case"DeviceHalfDuplexAec":return 17;case"DeviceMultipleEndpoints":return 18;case"DeviceHowling":return 19;case"DeviceRenderZeroVolume":return 20;case"DeviceRenderMute":return 21;case"NetworkSendCatastrophic":return 22;case"NetworkRecvCatastrophic":return 23;case"CpuInsufficient":return 24;case"DeviceCaptureMute":return 25;case"DeviceCaptureNotMuteButSilent":return 26;case"DeviceSpeakWhileMuted":return 27;case"VideoVbssRendered":return 28;case"NetworkEthernetInterfaceUsed":return 29;case"NetworkWlanInterfaceUsed":return 30;case"NetworkWwanInterfaceUsed":return 31;case"NetworkRelaysNotReachable":return 32;case"VideoCapturerDeviceStartFailed":return 33;case"VideoCapturerDeviceStartTimedOut":return 34;case"VideoCapturerDeviceStartFailureLackSystemRes":return 35;case"VideoCapturerDeviceStartFailureMFResConflict":return 36;case"NoNetwork":return 37;case"NetworkNotWorking":return 38;case"DeviceCaptureNotFunctioningDeviceInUse":return 39;case"DeviceRenderNotFunctioningDeviceInUse":return 40;case"VideoCaptureDeviceFreeze":return 45;case"ZeroCaptureDevicesEnumerated":return 43;case"ZeroRenderDevicesEnumerated":return 44;case"VideoCapturePermissionDenied":return 47;case"ScreenshareRecordingDisabled":return 55;case"AudioCapturePermissionDenied":return 46;case"VideoCaptureFreezeRecovered":return 48;case"DeviceRenderHowling":return 49;case"PresentationAudioLoopbackDeviceState":return 53;case"RemoteNetworkConnectivityIssue":return 52;case"AudioCaptureUltrasoundDetected":return 54;case"MusicModeNotAvailable":return 57;case"CameraLighting":return 61;case"AudioLoopbackDeviceReady":return 63;case"NoRequiredVideoCodecs":return 64;case"SpatialAudioMUCHUnavailable":return 65;default:return}}static convertQualityLevel(e){switch(e){case"Unknown":return 0;case"Good":return 1;case"Poor":return 2;case"Bad":return 3;default:return}}static convertMediaType(e){switch(e){case"Audio":return 0;case"Video":return 1;case"ScreenShare":return 2;case"Data":return 3;default:return}}getPluginlessPublishLevel(e){switch(e){case"user":return"user";case"endpoint":return"endpoint";default:throw"Invalid level type."}}setIsEmergency(e){this.logger.info(`Set isEmergency:${e}`),this.isEmergency=e,this.callTelemetry.setIsEmergency(e)}static filterVirtualEndpoints(e){return e&&(0,Cr.filter)(e,(e=>!e.mappedTo))}mapDataChannelSourceIdToParticipant(e){let t=null;return t=1===this.callType?this.participants[0]:(0,Cr.find)(this.participants,(t=>t.hasSourceId(3,e))),t?.id?this.logger.info(`ParticipantId: ${ke(t.id)} to SourceId: ${e}`):this.logger.warn(`No Participant found for SourceId: ${e}`),t}getDataChannelSourceId(){const e=(0,Cr.find)(this.endpoints.endpointDetails,(e=>null!==e&&e.participantId===this._participantId));if(!e)return this.logger.warn(`No participantLeg found for participantId: ${this._participantId}`),-1;if(!e.mediaStreams)return this.logger.warn(`ParticipantLeg ${this._participantId} does not have valid mediaStreams`),-1;const t=(0,Cr.find)(e.mediaStreams,(e=>3===Tc(e.type)));return t?t.sourceId:(this.logger.warn(`participantLeg ${this._participantId} has no data channel`),-1)}initializeMediaControlPlane(){this.mediaControlPlane=new Nu(this.dataChannel,this.logger.createChild("MediaControlPlane"),this.mediaAgent.getConfigProvider().config.mediaControlPlaneConfig),this.mediaControlPlane.on("mpSendBandwidthChanged",(e=>{this.mediaSession?.processNotification("BandwithNotification",{bw:e});const t=this.mediaSession?.getExtensionsManager();t?.processNotification("BandwithNotification",{bw:e})})),this.mediaControlPlane.on("mpDshStatusChanged",(e=>{this.updateSignalingDSHMessageSubscription(!e),e&&this.mediaSession?.getDiagnostics()?.dshDiagnostics.setCurrentActiveStrategy("server")})),this.mediaControlPlane.on("onHandshakeTimeout",(()=>{this.isSignalingDSHFallbackEnabled()&&this.updateSignalingDSHMessageSubscription(!0)})),this.mediaControlPlane.on("mpDshChanged",(e=>{const t=this.mediaSession?.getExtensionsManager();t?.processNotification("McpDominantSpeakerInfo",{history:e})}))}initializeLiveStreamConfigProvider(){const e="MDN_MIDDLELANE_TEAMS",t=this.ecsProvider.getEcsConfig(e,"liveStream"),i=this.ecsProvider.getEcsConfig("ConfigIDs",e);this._liveStreamConfigProvider=new ui(t,null,i,this.logger.createChild("LiveStreamConfigProvider"))}isMediaSending(e){return this.mediaStateConfigurationHelper.isSending(e)}};vm.instanceCount=0,E([Mn("Initialize",{type:"Sync",convertError:!0,idempotencyLevel:"NoOp"})],vm.prototype,"init",1),E([Mn("StartVideo",{waitFor:"_UpdateMediaDescriptions",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),_(1,kn)],vm.prototype,"startVideo",1),E([Mn("StopVideo",{waitFor:"_UpdateMediaDescriptions",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),_(1,kn)],vm.prototype,"stopVideo",1),E([Mn("DumpVideoSourceImages")],vm.prototype,"dumpVideoSourceImages",1),E([_(1,kn)],vm.prototype,"hold",1),E([Mn("Hold",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),_(0,kn)],vm.prototype,"holdWithRenegotiate",1),E([Mn("LocalHold",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),_(0,kn)],vm.prototype,"localHold",1),E([Mn("Unhold",{waitFor:["Hold","LocalHold"],preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),_(1,kn)],vm.prototype,"unhold",1),E([Mn("UpdateEndpointMetadata"),_(1,kn)],vm.prototype,"updateEndpointMetadata",1),E([Mn("SendDtmfTone",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]})],vm.prototype,"sendDtmfTone",1),E([Mn("SetAudioUsage")],vm.prototype,"setAudioUsageMode",1),E([Mn("SetAudioMidcallConfig")],vm.prototype,"setAudioMidcallConfig",1),E([Mn("SetAudioMidcallConfigJon",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),_(1,kn)],vm.prototype,"setAudioMidcallConfigJson",1),E([Mn("SetParticipantSpatialAudioPositions",{waitFor:"_ElectronSlimcoreReady",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),_(1,kn)],vm.prototype,"setParticipantSpatialAudioPositions",1),E([Mn("BlindTransfer",{singular:!0,type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),_(1,kn)],vm.prototype,"callBlindTransfer",1),E([Mn("SafeTransfer",{singular:!0,type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),_(1,kn)],vm.prototype,"callSafeTransfer",1),E([Mn("TransferToVoicemail",{singular:!0,type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),_(1,kn)],vm.prototype,"transferCallToVoicemail",1),E([Mn("ConsultativeTransfer",{singular:!0,type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),_(1,kn)],vm.prototype,"callConsultativeTransfer",1),E([Mn("ConsultativeTransferWithPickupCode",{singular:!0,type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]})],vm.prototype,"consultativeTransferWithPickupCode",1),E([Mn("CallRedirect",{singular:!0,type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),_(1,kn)],vm.prototype,"callRedirect",1),E([Mn("ParkCall",{type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),_(1,kn)],vm.prototype,"park",1),E([Mn("UnparkCall",{type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),_(1,kn)],vm.prototype,"unpark",1),E([Mn("getTechnicalInformationJson",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]})],vm.prototype,"getTechnicalInformationJson",1),E([Mn("StartScreenSharing",{waitFor:"_UpdateMediaDescriptions",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),_(3,kn)],vm.prototype,"startScreenSharing",1),E([Mn("StopScreenSharing",{waitFor:"_UpdateMediaDescriptions",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),_(2,kn)],vm.prototype,"stopScreenSharing",1),E([Mn("StartDataChannel",{type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),_(1,kn)],vm.prototype,"startDataChannel",1),E([Mn("StopDataChannel",{type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),_(1,kn)],vm.prototype,"stopDataChannel",1),E([Mn("ShareSystemSounds",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),_(1,kn)],vm.prototype,"shareSystemSound",1),E([Mn("Mute",{waitFor:"JoinPreheatedCall",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]},!0),_(0,kn)],vm.prototype,"mute",1),E([Mn("Unmute",{waitFor:["JoinPreheatedCall"]},!0),_(0,kn)],vm.prototype,"unmute",1),E([Mn("MuteSpeaker",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),_(0,kn)],vm.prototype,"muteSpeaker",1),E([Mn("UnmuteSpeaker",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),_(0,kn)],vm.prototype,"unmuteSpeaker",1),E([Mn("MuteParticipants",void 0,!0),_(2,kn)],vm.prototype,"muteParticipants",1),E([Mn("StartAudio",{type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),_(1,kn)],vm.prototype,"startAudio",1),E([Mn("StopAudio",{type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),_(1,kn)],vm.prototype,"stopAudio",1),E([Mn("Assimilate"),_(3,kn)],vm.prototype,"assimilate",1),E([_(2,kn)],vm.prototype,"merge",1),E([Mn("MergeParticipants"),_(1,Dn),_(3,kn)],vm.prototype,"mergeParticipants",1),E([Mn("MergeWithPickupCode"),_(0,Dn),_(2,kn)],vm.prototype,"mergeWithPickupCode",1),E([Mn("SetMaxVideoChannels")],vm.prototype,"setMaxVideoChannels",1),E([Mn("StopCall"),_(1,kn),_(3,Ln)],vm.prototype,"stop",1),E([Mn("PublishState"),_(1,Dn)],vm.prototype,"publishState",1),E([Mn("PublishState"),_(1,Dn)],vm.prototype,"publishStatesForEveryone",1),E([Mn("RemoveState"),_(1,Dn)],vm.prototype,"removeState",1),E([Mn("RemoveState"),_(1,Dn)],vm.prototype,"removeStatesForEveryone",1),E([Mn("UpdateMeetingSettings"),_(1,Dn)],vm.prototype,"updateMeetingSettings",1),E([Mn("UpdateMeetingGroups"),_(0,Dn)],vm.prototype,"updateMeetingGroups",1),E([Mn("UpdateMeetingLiveState"),_(0,Dn)],vm.prototype,"updateMeetingLiveState",1),E([Mn("UpdateMeetingStates"),_(1,Dn)],vm.prototype,"updateMeetingStates",1),E([Mn("UpdateParticipantInterpretationState"),_(0,Dn)],vm.prototype,"updateParticipantInterpretationState",1),E([Mn("UpdateParticipantsProperties")],vm.prototype,"updateParticipantsProperties",1),E([Mn("JoinMeetingGroup"),_(0,Dn)],vm.prototype,"joinMeetingGroup",1),E([Mn("LeaveMeetingGroup"),_(0,Dn)],vm.prototype,"leaveMeetingGroup",1),E([Mn("SendMessages"),_(0,Dn)],vm.prototype,"sendMessages",1),E([Mn("UpdateMonitorSession"),_(1,kn)],vm.prototype,"updateMonitorSession",1),E([Mn("UpdateMeetingRole")],vm.prototype,"updateMeetingRoles",1),E([Mn("CreateContentSharingSession"),_(4,kn)],vm.prototype,"createContentSharingSession",1),E([Mn("StopCallWithBeacon",{type:"Sync"}),_(0,kn)],vm.prototype,"stopWithBeacon",1),E([Mn("Acknowledge",{type:"Chained",convertError:!0,idempotencyLevel:"Error",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),_(2,kn)],vm.prototype,"acknowledge",1),E([Mn("Accept",{type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),_(1,kn)],vm.prototype,"accept",1),E([Mn("Reject",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),_(0,kn),_(1,Ln)],vm.prototype,"reject",1),E([Mn("JoinCall",{type:"Chained",idempotencyLevel:"Error"}),_(1,Nn),_(2,kn)],vm.prototype,"join",1),E([Mn("JoinPreheatedCall",{waitFor:"_CallStartOrJoinInitiated"})],vm.prototype,"joinPreheatedCall",1),E([Mn("StartCall",{type:"Chained",idempotencyLevel:"Error"}),_(0,Nn),_(1,kn)],vm.prototype,"start",1),E([Mn("StartCallToVoiceMail",{type:"Chained",idempotencyLevel:"Error"}),_(1,kn)],vm.prototype,"startCallToVoicemail",1),E([Mn("Subscribe",{type:"Chained",idempotencyLevel:"Error"}),_(2,kn)],vm.prototype,"joinCallWithoutCallModality",1),E([Mn("StartWithMeetingData",{type:"Chained",idempotencyLevel:"Error"})],vm.prototype,"startWithMeetingData",1),E([Mn("JoinWithMeetingData",{type:"Chained",idempotencyLevel:"Error"})],vm.prototype,"joinWithMeetingData",1),E([Mn("SubscribeWithMeetingData",{type:"Chained",idempotencyLevel:"Error"})],vm.prototype,"subscribeWithMeetingData",1),E([Mn("StartCallWithNudge",{type:"Chained",idempotencyLevel:"Error"}),_(1,Nn),_(2,kn)],vm.prototype,"startCallWithNudge",1),E([Mn("StartCallAndUnpark",{type:"Chained",idempotencyLevel:"Error",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),_(2,Nn),_(3,kn)],vm.prototype,"startAndUnpark",1),E([On("AdmitParticipant"),_(0,Dn),_(1,kn)],vm.prototype,"admitParticipant",1),E([Mn("Admit")],vm.prototype,"admit",1),E([On("CallMeBack"),_(0,Dn),_(2,kn)],vm.prototype,"callMeBack",1),E([_(0,Dn),_(2,kn)],vm.prototype,"addParticipant",1),E([On("AddParticipants"),_(0,Dn),_(2,kn)],vm.prototype,"addParticipants",1),E([_(0,Dn),_(2,kn)],vm.prototype,"addParticipantsImpl",1),E([On("NudgeParticipants"),_(0,Dn),_(3,kn)],vm.prototype,"nudgeParticipants",1),E([On("RemoveParticipant"),_(0,Dn),_(1,kn)],vm.prototype,"removeParticipant",1),E([Mn("SearchParticipants"),_(1,Dn),_(1,kn)],vm.prototype,"searchParticipants",1),E([Mn("GetAllParticipants"),_(1,Dn),_(1,kn)],vm.prototype,"getAllParticipants",1),E([Mn("_PromotionToRealtime"),_(1,kn)],vm.prototype,"promoteToRealtime",1),E([_(0,kn)],vm.prototype,"turnOffLocalVideoPreview",1),E([Mn("_StartPreviewVideo"),_(0,kn)],vm.prototype,"turnOnLocalVideoPreview",1),E([Mn("_UpdateLocalMediaStatus",{type:"Chained"}),_(0,kn)],vm.prototype,"updateMediaStatus",1),E([_(0,kn)],vm.prototype,"calculateIsSomeoneStreaming",1),E([Mn("_Reconnect")],vm.prototype,"reconnect",1),E([Mn("AddGroupModality"),_(1,kn)],vm.prototype,"addGroupModality",1),E([Mn("AddBroadcastModality")],vm.prototype,"addBroadcastModality",1);var ym=vm;function Cm(e){const t=new TextDecoder("utf-8"),i=atob(e),n=Uint8Array.from(i,(e=>e.charCodeAt(0)));return t.decode(n)}var Tm=T(ge()),Em=new RegExp("/callAgent/","i"),_m=class{constructor(e,t){this.signalingAgentProvider=e,this.callRegistry=t}handleMessage(e){if(!e.eventId){if(e.url.search(Em)>-1){const t=this.signalingAgentProvider.getSignalingAgent().handleIncomingNotification(e);return"number"==typeof t?{isHandled:!0,resultCode:t}:{isHandled:!0,resultCode:t.resultCode,responseBody:t.responseBody,responseHeaders:t.responseHeaders}}return{isHandled:!1}}if(e.eventId in Zn){this.callRegistry.logUploadNotification(e);const t=this.signalingAgentProvider.getSignalingAgent().handleIncomingNotification(e);return"number"==typeof t?{isHandled:!0,resultCode:t}:{isHandled:!0,resultCode:t.resultCode,responseBody:t.responseBody,responseHeaders:t.responseHeaders}}return{isHandled:!1}}},bm=class{constructor(e,t,i){this.callRegistry=e,this.recentInvitations=[],this.logger=t.createChild("IncomingCallMessageHandler"),this.ecsProvider=i,this.useExperimentalDecode=this.ecsProvider?.getEcsConfig("SkypeCalling","useExperimentalDecode")}handleMessage(e){const t=this.handleIncomingCall(e);return t?{isHandled:t,resultCode:200}:{isHandled:t}}handleIncomingCall(e){const t=Re(),i=this.logger.createFnLogger("handleIncomingCall",t);if(this.isProxiableNotification(e))return this.callRegistry.proxyPushNotification(e),!0;if(!this.isIncomingCallMessage(e))return!1;let n;try{if(e?.body?.gp&&!je(e.body.gp))i.info("unencoded payload, skipping decoding."),n=e.body.gp;else{const t=Im(e,i,this.useExperimentalDecode);n=JSON.parse(t)}n.body=e.body}catch(e){return i.logFailure(`Error parsing notification payload: ${e}`),!1}const r=this.isCallTransferNotification(e)?this.buildTransferCallPayload(n):this.buildNGCCallPayload(n);if(!r)return!1;if(this.callRegistry.calls.some((e=>e.callId===r.convoCallId&&e.participantId===r.participantId)))return i.logFailure(`Duplicate call filtered because it was in the call registry, callId = ${r.convoCallId}, participantId = ${r.participantId}`),!1;const s=this.isCallReplacementNotification(e);if(i.log(`replacementCall=${s}`),!s&&this.recentInvitations.some((e=>e.convoCallId===r.convoCallId&&e.participantId===r.participantId)))return i.logFailure(`Duplicate call filtered because it was in the recent calls list, callId = ${r.convoCallId}, participantId = ${r.participantId}`),!1;5===this.recentInvitations.length&&this.recentInvitations.shift(),this.recentInvitations.push({convoCallId:r.convoCallId,participantId:r.participantId});let a=this.callRegistry.calls.find((e=>e.callId===r.convoCallId&&8===e.state));return a||(a=r.groupId?this.callRegistry.createCallWithGroupId(r.groupId,r.convoCallId,r.participantId,t):this.callRegistry.createCall(r.conversationId,r.convoCallId,r.participantId,void 0,t)),a.init({threadId:r.conversationId,messageId:r.messageId,mediaPeerType:2}),this.callRegistry.testEndpointMetadata?a.acknowledge(r,this.callRegistry.testEndpointMetadata,t):a.acknowledge(r,void 0,t),!0}isIncomingCallMessage(e){return Object.keys(Qn).some((t=>Qn[t]===e.eventId))?e.eventId!==Qn.INCOMING_TFL_TFW_CALL||this.ecsProvider?.getEcsConfig("SkypeCalling","enableTFWTFLOneToOneCall"):this.isCallTransferNotification(e)}isCallTransferNotification(e){return e.callNotification&&("transfer"===e.callNotification.callType||"replaces"===e.callNotification.callType)}isCallReplacementNotification(e){return e.callNotification&&"replaces"===e.callNotification.callType}isProxiableNotification(e){return Object.keys(Xn).some((t=>Xn[t]===e.eventId))}buildTransferCallPayload(e){const t={body:e.body,callerId:e.callNotification.from.id,groupId:null,conversationId:null,convoCallId:e.debugContent.callId,isMultiParty:e.conversationInvitation?.isMultiParty,fromMixer:e.callNotification.fromMixer,ngcCall:!0,participantId:e.callNotification.to.participantId,transferorId:e.callNotification.transferor&&e.callNotification.transferor.details&&e.callNotification.transferor.details.id,transferorType:e.callNotification.transferor&&e.callNotification.transferor.transferorType,transferorDisplayName:e.callNotification.transferor&&e.callNotification.transferor.details&&e.callNotification.transferor.details.displayName,callType:e.callNotification.callType,consultativeCallId:e.callNotification.consultativeCallId,messageId:null,callQueueInfo:e.callNotification.applicationContent,videoCall:void 0,launchTime:void 0,pushReceivedTime:void 0,registrationId:void 0};return this.logger.info("Incoming transfer paylod",t),t}buildNGCCallPayload(e){if(!e.callNotification)return this.logger.error("Missing callNotification in parsed incoming NGC call payload"),null;const t={groupId:e.groupContext?.id,conversationId:e.groupChat?.threadId,messageId:e.groupChat?.messageId,callerId:e.callNotification.from.id,isMultiParty:e.conversationInvitation.isMultiParty,fromMixer:e.callNotification.fromMixer,convoCallId:e.debugContent.callId,participantId:e.debugContent.participantId,ngcCall:!0,body:e.body,transferorId:e.callNotification.transferor&&e.callNotification.transferor.details&&e.callNotification.transferor.details.id,transferorType:e.callNotification.transferor&&e.callNotification.transferor.transferorType,transferorDisplayName:e.callNotification.transferor&&e.callNotification.transferor.details&&e.callNotification.transferor.details.displayName,callType:e.callNotification.callType,callQueueInfo:e.callNotification.applicationContent,videoCall:void 0,launchTime:void 0,pushReceivedTime:void 0,registrationId:void 0,fromApplicationType:e.callNotification.fromApplicationType};return this.logger.info("Incoming NGC payload",t),t}},Pm=class extends Ye{constructor(e,t,i,n,r,s=null,a,o){super(),this.trouterService=e,this.signalingAgentProvider=t,this.mediaAgent=i,this.callingLogger=n,this.telemetryLoggers=r,this.ecsProvider=s,this.skypeIdentity=a,this.oneDsTelemetryLoggers=o,this.calls=[],this.isDisposing=!1,this._disposedPromise=Ei(),this.testEndpointMetadata=null,this._disconnectingPromiseDefers=new Map,this.skypeIdentity&&(this.identity=this.skypeIdentity.id),this.callSubscriptionsMap=new Map,this.logger=new ti(this.callingLogger).createChild(`CallRegistry/${Re()}`),this.registryTelemetry=new fn(this.logger,(new Date).getTime()),this._callOperationHandler||(this._callOperationHandler=new Wn(this.logger,this.registryTelemetry,{},(e=>{this._publishTelemetry(e)})));const l=this.mediaAgent.getConfig().disconnectOnPageHide;this._windowUninitEvent=l?"pagehide":"beforeunload",this.signalingAgentProvider.getSignalingAgent().setTokenRequiredCallBack(this.onTokenRequired.bind(this)),this._createNewCallInDisconnectedState=this.ecsProvider.getEcsConfig("SkypeCalling","createNewCallInDisconnectedState"),this._invokeDeleteCallInDisconnectedState=this.ecsProvider.getEcsConfig("SkypeCalling","invokeDeleteCallInDisconnectedState"),this._useExperimentalDecode=this.ecsProvider.getEcsConfig("SkypeCalling","useExperimentalDecode")}init(e,t,i=Re()){return this.logger.createFnLogger("init",i).info("init"),this.login(e)}uninit(){return this.logout()}login(e,t=Re()){return this.logger.createFnLogger("login",t).info("login"),this.skypeIdentity=e,this.identity=this.skypeIdentity.id,this.initialize(t)}initialize(e=Re(),t){const i=this.logger.createFnLogger("initialize",e),n=t&&t.applicationType?t.applicationType:"null";i.info(`initialize with applicationType: ${n}`),this.accountConfiguration=t,this.accountConfiguration&&this.event("accountConfigurationReceived").raise(this.accountConfiguration),this.signalingAgentProvider.getSignalingAgent().update(t),this.incomingCallMessageHandler=new bm(this,this.logger,this.ecsProvider),this.trouterService.registerMessageHandler(new _m(this.signalingAgentProvider,this)),this.trouterService.registerMessageHandler(this.incomingCallMessageHandler),i.info("Call registry init, endpointMetadata",this.testEndpointMetadata);try{this.windowUninitListener=()=>{this._disregardWindowUninitEvents||this.stopCallsWithBeacon()},window.addEventListener(this._windowUninitEvent,this.windowUninitListener)}catch(e){i.logFailure(`Not adding beforeunload listener: ${e}`)}return Promise.resolve(void 0)}logout(e=Re()){const t=this.logger.createFnLogger("logout",e);t.info("logout");try{this.trouterService.clearMessageHandlers(),window.removeEventListener(this._windowUninitEvent,this.windowUninitListener)}catch(e){t.info(`Not removing beforeunload listener: ${e}`)}return Promise.resolve(void 0)}_publishTelemetry(e){if(!this.telemetryLoggers?.signaling)return;this.registryTelemetry.setSkypeId(this.identity);try{const e=this.signalingAgentProvider.getSignalingAgent();this.registryTelemetry.setEndpointId(e.endpointId)}catch(e){this.logger.warn("Could not get end point ID from signaling agent for call registry telemetry.")}this.accountConfiguration&&(this.registryTelemetry.setAcsResourceId(this.accountConfiguration.acsResourceId),this.registryTelemetry.setApplicationType(this.accountConfiguration.applicationType),this.registryTelemetry.setPartition(this.accountConfiguration.partition),this.registryTelemetry.setRegion(this.accountConfiguration.region),this.registryTelemetry.setRing(this.accountConfiguration.ring),this.registryTelemetry.setTenantId(this.accountConfiguration.tenantId),this.registryTelemetry.setUserHexCID(this.accountConfiguration.userHexCID),this.registryTelemetry.setClientType(this.accountConfiguration.clientType));const t=on;this.telemetryLoggers.signaling.sendEvent({eventName:t,props:this.registryTelemetry.getEvent(null,e)})}async dispose(e=Re()){const t=this.logger.createFnLogger("dispose",e);if(t.info("dispose"),this.isDisposing)return t.warn("call registry is already in disposing stage!"),this._disposedPromise.promise;this.isDisposing=!0;const i=()=>{this.calls=[],this.event("disposed").raise(),super.dispose(),this._disposedPromise.resolve()},n=this.calls.map((e=>e.stop())),r=()=>this.logout();return this.clearCallSubscription(),this.signalingAgentProvider.getSignalingAgent().resetAuthTokenManager(),Promise.all(n).then(r,r).then(i,i),this._disposedPromise.promise}get disposePromise(){return this._disposedPromise.promise}createCallAsync(e){const t=this.logger.createFnLogger("createCallAsync",e.causeId),i=`callId:${e.callId}, localParticipantId: ${ke(e.localParticipantId)},\n            causeId:${e.causeId}, type:${e.type}, `;switch(e.type){case"MeetingData":i.concat(`meetingUrl:${!!e.meetingData?.meetingUrl}, meetingCode:${!!e.meetingData?.meetingCode}`);break;case"GroupId":i.concat(`groupId:${ke(e.groupId)}`);break;case"ThreadId":i.concat(`threadId:${Le(e.threadId)}, messageId:${e.messageId}`);break;default:throw new Error("Invalid type in passing parameter.")}t.info(i);const n=this.mediaAgent?.getConfig().useOneDsLogger?this.oneDsTelemetryLoggers:this.telemetryLoggers,r=this._getCurrentCall(e,t);if(r){if(6===r.state){const e=Ei();return this._disconnectingPromiseDefers.set(r.callId,e),e.promise}return Promise.resolve(r)}return Promise.resolve(this._createNewCall(e,n,t))}createCallWithMeetingData(e,t,i,n){const r=this.logger.createFnLogger("createCallWithMeetingData",n);if(r.info(`meetingData:${He(e)}, callId:${t}, localParticipantId: ${ke(i)}`),!e)return r.info("meetingData cannot be null"),null;const s=this._generateCreateCallOptions(n,t,i,null,null,null,e),a=this._getCurrentCall(s,r);if(a)return a;const o=this.mediaAgent?.getConfig().useOneDsLogger?this.oneDsTelemetryLoggers:this.telemetryLoggers;return this._createNewCall(s,o,r)}createCall(e,t,i,n,r=Re()){return this._createCall(e,t,i,n,r)}createCallWithGroupId(e,t,i,n){return this._createCall("",t,i,void 0,n,e)}_createNewCall(e,t,i){let n=null,r=null,s=null,a=null;switch(e.type){case"MeetingData":a=e.meetingData;break;case"GroupId":n=e.groupId;break;case"ThreadId":r=e.threadId,s=e.messageId}const o=new ym(this.signalingAgentProvider.getSignalingAgent(),this.mediaAgent,new ti(this.callingLogger),t,this.skypeIdentity,n,r,e.callId,e.localParticipantId,this.ecsProvider,this.trouterService,this.accountConfiguration,s,this.locationInfoContent,this.networkInfoContent,a,this.areaContent);o.on("callStateChanged",(async()=>{if(7===o.state&&this._createNewCallInDisconnectedState){const n=this._disconnectingPromiseDefers.get(o.callId);n&&(this._disconnectingPromiseDefers.delete(o.callId),n.resolve(this._createNewCall(e,t,i))),this._invokeDeleteCallInDisconnectedState&&setTimeout((()=>{this.deleteCall(o)}),0)}})),this.calls.push(o),this.event("callAdded").raise(o),this.raiseChanged(),i.info(`creating new call, ${o.callId}, ${He(a)}, ${He(o.meetingData)}`);const l=o.on("replacementRequested",(e=>{this.incomingCallMessageHandler.handleMessage(e)}));return this.addCallSubscriptionToMap(o,l),o}_getCurrentCall(e,t){let i=null;return"MeetingData"===e.type&&(i=this.getCallUsingMeetingData(e.meetingData,e.callId,e.localParticipantId,void 0,void 0,e.causeId),i)?(t.info("Call Registry has an entry for this call's meeting data"),i):(i=this.getCall(e.callId,e.localParticipantId,e.causeId),i?(t.info("Call Registry has an entry for this callId, participantId"),i):"ThreadId"===e.type&&(i=this.getCallUsingThreadIdMessageId(e.threadId,e.callId,e.messageId,e.causeId),i)?(t.info("Call Registry has an entry for this threadId, messageId"),i):"GroupId"===e.type&&(i=this.calls.find((t=>t.groupId===e.groupId)),i)?(t.info("Call Registry has an entry for this groupId"),i):i)}_generateCreateCallOptions(e,t,i,n,r,s,a){let o=null;return o=n?{type:"GroupId",callId:t,localParticipantId:i,causeId:e,groupId:n}:r?{type:"ThreadId",callId:t,localParticipantId:i,causeId:e,threadId:r,messageId:s}:{type:"MeetingData",callId:t,localParticipantId:i,causeId:e,meetingData:a},o}_createCall(e,t,i,n,r=Re(),s){const a=this.logger.createFnLogger("createCall",r);a.info(`threadId:${Le(e)}, callId:${t}, localParticipantId: ${ke(i)}, messageId:${n}, groupId:${ke(s)}`);const o=this._generateCreateCallOptions(r,t,i,s,e,n,null),l=this._getCurrentCall(o,a);if(l)return l;const d=this.mediaAgent?.getConfig().useOneDsLogger?this.oneDsTelemetryLoggers:this.telemetryLoggers;return this._createNewCall(o,d,a)}getCall(e,t,i=Re()){const n=this.logger.createFnLogger(`getCall[callId=${e}][participantId=${ke(t)}]`,i);if(!e)return n.logFailure("callId is undefined"),null;const r=this.calls.find((t=>t.callId===e));return r&&n.info("Call Registry already has an entry for this call"),r}async deleteCallAsync(e){return Ti((()=>this.deleteCall(e)))}deleteCall(e){const t=this.calls.indexOf(e);return-1!==t&&(this.callSubscriptionsMap.get(e).forEach((e=>{e.dispose()})),this.callSubscriptionsMap.delete(e),this.calls.splice(t,1),this.event("callRemoved").raise(e),this.raiseChanged(),!0)}async setConfiguration(e){this.accountConfiguration=e,this.accountConfiguration&&this.event("accountConfigurationReceived").raise(this.accountConfiguration),this.signalingAgentProvider.getSignalingAgent().update(e)}updateDisplayName(e){return this.skypeIdentity.displayName=e,this.calls.forEach((t=>{t.updateDisplayName(e)})),Promise.resolve()}fireIntent(e,t){return Promise.resolve()}getCallState(e,t){return Promise.reject("Not implemented")}getSetup(){}getEcsConfig(){return Promise.reject()}updateSkypeToken(e){this.logger.debug("CallRegistry.updateSkypeToken() called but not supported in the current set up.")}updateToken(e,t,i,n,r){this.logger.info(`[updateToken], causeId = ${n} tokenType = ${t.tokenType}, factorsJson = ${e}, tokenExpiredTime = ${r}`);try{return this.signalingAgentProvider.getSignalingAgent().updateToken(e,t,i,n,r),Promise.resolve({code:0})}catch(t){return this.logger.info(`Failed to update token with ${e}, error is ${t}`),Promise.reject($n(`Failed to update token with ${e}, error is ${t}`))}}onTokenRequired(e){const{requestMetadataJson:t,factorsJson:i,tokenType:n,invalidToken:r}=e;this.logger.info(`[onTokenRequired], tokenType ${n}, factorsJson ${i}, requestMetadataJson ${JSON.stringify(t)}`),this.event("tokenRequired").raise(i,n,t,r)}debugInformation(e){const t=e?`CallInformation\n * CallId=${e.callId}`:void 0;return Promise.resolve(t)}setLocationInfo(e,t,i=Re()){if(this.logger.info(`setLocationInfo, ${i}, infoType:${e}, contentJson ${t?"is set":"is undefined"}`),t)try{JSON.parse(t)}catch(e){return Promise.reject(`invalid contentJson: ${e}`)}return this.locationInfoType=e,1===this.locationInfoType&&(this.locationInfoContent=t,this.logger.info(`locationInfoContent set to ${this.locationInfoContent}`)),2===this.locationInfoType&&(this.networkInfoContent=t,this.logger.info(`networkInfoContent set to ${this.networkInfoContent}`)),3===this.locationInfoType&&(this.areaContent=t,this.logger.info(`areaContent set to ${this.areaContent}`)),this.event("locationInfoSet").raise(e,t),Promise.resolve()}createDownloader(){return null}async getUnassembledLocalRecordingSessions(e=Re()){return Promise.reject("Not implemented")}extendBrbFeedback(e,t){return Promise.reject("Not implemented")}proxyPushNotification(e){this.logger.info(`Proxying push notification with event ID ${e.eventId}`);try{const t={eventId:e.eventId,payload:Im(e,this.logger,this._useExperimentalDecode)};this.event("proxiedPushNotification").raise(t)}catch(e){this.logger.error(`Error proxying push notification: ${e}`)}}logUploadNotification(e){this.logger.info(`Log upload notification with event ID ${e.eventId}`);try{const t={eventId:e.eventId,payload:Im(e,this.logger,this._useExperimentalDecode)};this.event("logUploadNotification").raise(t)}catch(e){this.logger.error(`Error raising log upload notification: ${e}`)}}sendPush(e,t,i,n){const r={id:e},s=[];return t.forEach((e=>{s.push({id:e})})),this.signalingAgentProvider.getSignalingAgent().sendPushAsync(r,s,i,n)}enableWindowUninitEventHandler(){this._disregardWindowUninitEvents=!1}disableWindowUninitEventHandler(){this._disregardWindowUninitEvents=!0}getCallUsingThreadIdMessageId(e,t,i,n){this.logger.info(`[getCallUsingThreadIdMessageId][${n}] threadID: ${Le(e)} callId: ${t} messageId: ${i}`);let r=null;return e&&(r=this.calls.find((n=>n.threadId===e&&(t&&n.callId===t||i&&n.messageId===i))),r)?(this.logger.logFailure(`[getCallUsingThreadIdMessageId][${n}]Call Registry already has an entry for threadId: ${Le(r.threadId)}, callId: ${r.callId}, messageId: ${r.messageId}`),r):r}getCallUsingMeetingData(e,t,i,n,r,s=Re()){const a=this.logger.createFnLogger("getCallUsingMeetingData",s);if(a.info(`[callId=${t}][participantId=${ke(i)}] meetingData: ${He(e)} threadId: ${Le(n)} messageId: ${r}`),!t)return a.logFailure("callId is undefined"),null;let o;for(const i of this.calls){if(i.callId===t){o=i;break}if(Tn(i.meetingData,e,s,this.logger)){o=i;break}}return o}stopCallsWithBeacon(){for(const e of this.calls)e.stopWithBeacon()}addCallSubscriptionToMap(e,t){this.callSubscriptionsMap.set(e,(this.callSubscriptionsMap.get(e)||[]).concat(t))}clearCallSubscription(){this.callSubscriptionsMap.forEach((e=>{e.forEach((e=>{e.dispose()}))})),this.callSubscriptionsMap.clear()}};function Im(e,t,i=!1){const n=t.createFnLogger("decodeNotificationPayload");n.info(`useExperimentalDecode:${i}`);const r=i?Cm:atob;let s="{}";if(e?.body?.gp)n.info("using notification.body.gp"),s=r(e.body.gp);else if(e?.body?.cp){n.info("using notification.body.cp");const t=atob(e.body.cp);s=Tm.inflate(t,{to:"string"})}return s}E([Mn("Initialize",{enableInstantTelemetry:!0})],Pm.prototype,"initialize",1),E([Mn("Logout",{enableInstantTelemetry:!0})],Pm.prototype,"logout",1);var Am=i(496486),Rm=class{constructor(e){this.deviceManager=e}get childDeviceManagers(){return this.deviceManager.getRegisteredDevices()}createPreview(e,t,i,n){return this.executeOnVirtualDeviceManager((n=>i(e,t,n)),n)}getRawDeviceMediaStream(e,t,i){return this.executeOnVirtualDeviceManager((i=>i.getRawDeviceMediaStream(e,t)),i)}setDeviceEffectsAsync(e,t){return this.executeOnVirtualDeviceManager((e=>e.setVideoEffects(t)),e)}setRawMediaStream(e,t,i){this.executeOnVirtualDeviceManager((i=>i.setRawMediaStream(e,t)),i)}unsetRawMediaStream(e,t){this.executeOnVirtualDeviceManager((t=>t.unsetRawMediaStream(e)),t)}getVirtualDevice(e){return this.childDeviceManagers.find((t=>t.id===e))}executeOnVirtualDeviceManager(e,t){return this.getVirtualDevice(t).getDeviceManagers().map((t=>e(t)))}},wm=class e extends Ye{constructor(e){super(),this._deviceManager=e,this.virtualDeviceAdapter=new Rm(this._deviceManager),e.on("onDevicesChanged",(e=>{const t=this._deviceManager.getDeviceDescriptions(e),i=this._mapDevices(t);this._raiseDevicesChanged(i)})),e.on("onSelectedDevicesChanged",(e=>this._raiseDevicesChanged())),e.on("onPermissionStateChanged",(()=>this.event("onPermissionStateChanged").raise())),e.on("onVideoEffectsEvent",((e,t)=>this.event("videoEffectsEvent").raise(e,t))),e.on("onVideoEffectApplied",(()=>this.event("videoEffectApplied").raise()))}get isAudioOutputSelectionSupported(){return this._deviceManager.isAudioOutputSelectionSupported}getPermissionState(e){return"camera"===e?this.getPermissionStateHelper(this._deviceManager.getPermissionState("camera")):"microphone"===e?this.getPermissionStateHelper(this._deviceManager.getPermissionState("microphone")):"unknown"}askDevicePermission(e){return this._deviceManager.askDevicePermission?this._deviceManager.askDevicePermission(e):Promise.resolve({audio:!0,video:!0})}enumerateDevicesAsync(){return this._deviceManager.enumerateDevicesAsync().then((e=>this._mapDevices(e)))}getPreferredCamera(){throw new Error("Not implemented")}selectDevices(e){if(Object.keys(e).some((e=>this.isVirtualDevice(e))))throw new Error("Virtual Device selection on DM is not supported");const t=(0,Am.assign)({},this._deviceManager.getSelectedDevices(),e);this._deviceManager.selectDevices(t)}selectDevicesAsync(e){return Ti((()=>this.selectDevices(e)))}getSelectedDevices(){return this._deviceManager.getSelectedDevices()}getSelectedDevicesAsync(){return Ti((()=>this.getSelectedDevices()))}getDeviceNameAsync(e){return this._deviceManager.getDeviceNameAsync(e)}getSpeakerDeviceDomIdAsync(e,t){return this._deviceManager.getSpeakerDeviceDomIdAsync(e)}async setDeviceEffectsAsync(e,t){if(!this.isVirtualDevice(e))return this._deviceManager.setVideoEffects(t);Promise.all(this.virtualDeviceAdapter.setDeviceEffectsAsync(e,t))}getDeviceEffectsCapabilityAsync(e,t){return this._deviceManager.effectsManager.getEffectsCapability("Video")}setBackgroundImageAsync(e,t,i){return this._deviceManager.effectsManager.configure("Video",{imagePath:t,headers:i})}getImagePropertyAsync(e){return Promise.reject(new Error("Not implemented"))}getMicrophoneGeometryArrayInfoAsync(e){return Promise.reject(new Error("Not implemented"))}transformImageAsync(e,t,i,n){return Promise.reject(new Error("Not implemented"))}setAudioProcessingFlags(e){return this._deviceManager.setAudioProcessingFlags(e)}sendMessageDeviceVideoEffectsAsync(e,t){return Promise.reject(new Error("Not implemented"))}sendMessageDeviceVideoExtensibilityAsync(e,t){return Promise.reject(new Error("Not implemented"))}setVideoCaptureConfigAsync(e,t){return Promise.reject(new Error("Not implemented"))}captureVideoFrameWithoutEffectsAsync(e,t,i){return Promise.reject(new Error("Not implemented"))}getSpeakerVolume(){return Promise.reject(new Error("Not implemented"))}getSpeakerSystemVolume(){return Promise.reject(new Error("Not implemented"))}setSpeakerVolume(e){return Promise.reject(new Error("Not implemented"))}setSpeakerSystemVolume(e){return Promise.reject(new Error("Not implemented"))}unmuteMicrophone(){return Promise.reject(new Error("Not implemented"))}unmuteSpeaker(){return Promise.reject(new Error("Not implemented"))}getNrgLevelsForDeviceTuner(e){return Promise.reject(new Error("Not implemented"))}setAudioEffectsAsync(e,t){return this._deviceManager.setAudioEffects(t)}getAudioFeatureCapability(e){return this._deviceManager.effectsManager.getEffectsCapability("Audio")}getMicrophoneVolume(){return Promise.reject(new Error("Not implemented"))}setMicrophoneVolume(e){return Promise.reject(new Error("Not implemented"))}setDeviceTelemetryData(e,t,i,n=0){return Promise.reject(new Error("Not implemented"))}getSourceFormats(e){return Promise.reject(new Error("Not implemented"))}enableShellSharing(){return Promise.reject(new Error("Not implemented"))}disableShellSharing(){return Promise.reject(new Error("Not implemeted"))}enableParticipantCameras(){return Promise.reject(new Error("Not implemeted"))}registerDerivedSource(e,t){return Promise.reject(new Error("Not implemeted"))}unregisterDerivedSource(e){return Promise.reject(new Error("Not implemeted"))}async createPreview(e,t,i){return"camera"===t.kind&&this.isVirtualDevice(t.device)?this.virtualDeviceAdapter.createPreview(e,i,this.getRenderer,t.device)[0]:"camera"===t.kind&&(0,Am.isUndefined)(t.device)?this.createPreviewRenderer(e,i):Promise.reject(new Error("Not yet supported"))}async createPreviewRenderer(e,t){return this.getRenderer(e,t,this._deviceManager)}createScreenSharingPreviewRenderer(e,t){return Promise.reject(new Error("Not yet supported"))}getRawDeviceMediaStream(e,t,i){const n=wu(e);return this.isVirtualDevice(i)?this.virtualDeviceAdapter.getRawDeviceMediaStream(n,t,i)[0]:this._deviceManager.getRawDeviceMediaStream(n,t)}setRawMediaStream(e,t,i){const n=wu(t);return this.isVirtualDevice(i)?this.virtualDeviceAdapter.setRawMediaStream(e,n,i):this._deviceManager.setRawMediaStream(e,n)}unsetRawMediaStream(e,t){const i=wu(e);return this.isVirtualDevice(t)?this.virtualDeviceAdapter.unsetRawMediaStream(i,t):this._deviceManager.unsetRawMediaStream(i)}createAudioRenderer(){return this._deviceManager.createAudioRenderer()}startAudioLoopbackDevice(e){return Promise.reject(new Error("Not implemented"))}async dispose(e){return this._deviceManager.dispose(e)}async registerCompositeVideoDevice(e,t,i){return this._deviceManager.registerVirtualDevice(e,t,i)}async unregisterCompositeVideoDevice(e){return this._deviceManager.unregisterVirtualDevice(e)}async createAudioPlayer(){return Promise.reject(new Error("Not implemented"))}_raiseDevicesChanged(e){(e?Promise.resolve(e):this.enumerateDevicesAsync()).then((e=>{this.raiseChanged(),this.event("devicesChanged").raise(e)}))}getPermissionStateHelper(e){switch(e){case"granted":return"granted";case"denied":return"denied";case"prompt":return"prompt";default:return"unknown"}}_mapDevices(e){return e?.map((e=>this._mapDeviceDesc(e)))}_mapDeviceDesc(t){const i=e._mapDeviceType(t.kind);return 6===i?{id:t.id,label:t.label,kind:i,position:0,defaultVideoId:t.id,devicesIds:[]}:1===i?{id:t.id,browserId:t.browserId,label:t.label,kind:i,position:e._mapCameraPosition(t.position)}:4===i?{id:null,browserId:null,label:t.label,kind:i,formFactor:t.formFactor,isPcInternalDevice:t.isPcInternalDevice,microphoneId:t.microphoneId,speakerId:t.speakerId}:{id:t.id,browserId:"default_output_device"===t.browserId?"default":t.browserId,label:t.label,kind:i,isSystemDefault:!!t.isSystemDefault}}static _mapDeviceType(e){switch(e){case"camera":return 1;case"microphone":return 2;case"speaker":return 3;case"compositeAudio":return 4;case"virtualDevice":return 6;default:throw new Error(`Invalid device type '${e}'`)}}static _mapCameraPosition(e){switch(e){case"front":return 1;case"back":return 2;case"external":return 3;default:return 0}}isVirtualDevice(e){return e&&this._deviceManager.getRegisteredDevices().some((t=>t.id===e))}async getRenderer(e,t,i){const n=new dp(e,i);try{await n.startVideoAsync(),t&&(n.setScalingMode(t.scalingMode),n.setVideoMirroring(!t.ignoreMirroring))}catch(e){throw n.dispose(),e}return n}},Mm=i(174958),Om=i(174958),Dm=class extends Om.AbstractLogAppender{constructor(e){super(new Om.StandardLogFormatter(Om.SLF_Flags.Component)),this._logger=e}log(e,t,i,n){if(!this._logger)return;const r=e.level<=Om.LogLevel.Debug4?this._logger.debug:e.level<=Om.LogLevel.Debug2?this._logger.log:e.level<=Om.LogLevel.Debug1?this._logger.info:e.level<=Om.LogLevel.Warning?this._logger.warn:this._logger.error;r&&r.apply(this._logger,[this.formatter().format(e,t,i,n)])}},km=i(174958),Nm=T(Ce()),Lm=["CorrelationId","agent_environment_id","UserInfo_TenantId","participant_id","endpoint_id","mediaLegId","metrics_ConfigIds","ts_calling_version","uiVersion"],xm={video:[...Lm,"Extensions_WebRTCStats_ssrc_video_recv_framesDecoded","Extensions_WebRTCStats_ssrc_video_recv_packetsReceived","Extensions_WebRTCStats_ssrc_video_recv_ssrc","Extensions_WebRTCStats_ssrc_video_recv_bytesReceived","Extensions_WebRTCStats_ssrc_video_recv_googFrameRateDecoded","Extensions_Video_SubscriptionEvents","Extensions_Video_recv_ResolutionDurations","Extensions_Video_recv_StreamsMax","Extensions_Video_recv_frameRateAvg","Extensions_Video_recv_DurationSeconds","Extensions_Video_recv_FreezeHistogram","Extensions_Video_recv_FreezeTimestamps","Extensions_WebRTCStats_ssrc_video_recv_keyFramesDecoded","Extensions_Video_recv_TotalFreezeDurationMs","Extensions_Video_recv_packetsLostRateMax","metrics_ReconnectAttempts","metrics_ReconnectConnectedCount","metrics_RetargetCompletedCount","metrics_UFDs","Payload"],sharing:[...Lm,"Extensions_WebRTCStats_ssrc_sharing_recv_framesDecoded","Extensions_WebRTCStats_ssrc_sharing_recv_packetsReceived","Extensions_WebRTCStats_ssrc_sharing_recv_ssrc","Extensions_WebRTCStats_ssrc_sharing_recv_bytesReceived","Extensions_WebRTCStats_ssrc_sharing_recv_googFrameRateDecoded","Extensions_WebRTCStats_ssrc_sharing_recv_keyFramesDecoded","Extensions_Sharing_SubscriptionEvents","Extensions_Sharing_recv_ResolutionDurations","Extensions_Sharing_recv_StreamsMax","Extensions_Sharing_recv_frameRateAvg","Extensions_Sharing_recv_DurationSeconds","Extensions_Sharing_recv_FreezeHistogram","Extensions_Sharing_recv_FreezeTimestamps","Extensions_Sharing_recv_TotalFreezeDurationMs","Extensions_Sharing_recv_packetsLostRateMax","metrics_ReconnectAttempts","metrics_ReconnectConnectedCount","metrics_RetargetCompletedCount","metrics_UFDs","Payload"]},Fm=class extends Ye{constructor(){super(...arguments),this.stabilizationTimeInAvg=2e4}send(e){e&&setTimeout((()=>{this.event("sendMidCallTelemetry").raise(xm[e])}),this.stabilizationTimeInAvg)}},Um=class extends Ye{constructor(e,t){super(),this._telemetryService=e,this._ecsProvider=t,this._ecsProvider.on("OnECSChanged",(()=>km.RootToolsManager.OnEcsChange()))}fetchEcsConfig(e,t){return Nm.Resolved().then((()=>this._ecsProvider.getEcsConfig(e,t)))}sendTelemetry(e,t){this._telemetryService.getGenericTelemetryLogger&&e?this._telemetryService.getGenericTelemetryLogger(e).sendEvent({eventName:"rt_log",props:t}):this._telemetryService.sendEvents([{eventName:"rt_log",props:t}])}sendMidCallTelemetry(e){Object.keys(xm).includes(e)&&this.event("onMidCallTelemetry").raise(e)}},Vm=i(496486),Hm=class e{constructor(t){this._prefix=t,this._children=[],this._useConsoleLogger=!1,this.createChild=(t,i)=>{const n="function"==typeof t?"":t,r=new e((this._prefix||"")+n);return this._children.push(r),this._useConsoleLogger&&r.useConsoleLogger(),r},this.createFnLogger=(t,i,...n)=>{const r=`[${i}][${t}]`,s=new e((this._prefix||"")+r);return this._children.push(s),this._useConsoleLogger&&s.useConsoleLogger(),s}}logInfo(){}logFailure(){}logSuccess(){}log(...e){}debug(...e){}info(...e){}warn(...e){}error(...e){}useConsoleLogger(){this._useConsoleLogger=!0;const e=(...e)=>{console.info(this._prefix||"",...e)};this.log=e,this.debug=e,this.info=e,this.warn=e,this.error=e,(0,Vm.each)(this._children,(e=>e.useConsoleLogger()))}},Bm=class{constructor(e){this.configProvider=e,this.window=yg.window,this.updateCapabilityOverrides(),this.configProviderSub=e.on("configUpdated",(()=>this.updateCapabilityOverrides()))}get audio(){return this.getCapability("audio")}get video(){return this.getCapability("video")}get screensharing(){return this.getCapability("screensharing")}get retargeting(){return this.getCapability("retargeting")}dispose(){this.configProviderSub&&this.configProviderSub.dispose()}updateCapabilityOverrides(){let e;this.configProvider.config.capabilities&&(e=this.configProvider.config.capabilities),this.overrides=e||{}}hasMediaCapture(){return!!this.window.navigator.getUserMedia}getCapability(e){return void 0!==this.overrides[e]?!!this.overrides[e]:this.hasMediaCapture()&&this.hasWebRtc()}hasWebRtc(){return void 0!==this.window.RTCPeerConnection}},$m=class e extends Qe{constructor(e,t){super(e),this.logger=e,this.configProvider=t,this.eventStates=new Map,this.swMuted=!1,this.logger.safe.info("Initialized")}signalEvent(e,t,i="Audio",n=!0,r=Re(),s,a){const o={type:e,value:t,isLocalSource:n,mediaType:i,deviceManagerId:s,diagnosticData:a},l=this.getEventKey(o),d=this.eventStates.get(l);(!d||d.value!==t||this.configProvider.config.alwaysRaiseBadDeviceEvents&&"Good"!==t)&&(d||"Good"!==t)&&(this.eventStates.set(l,o),this.shouldRaiseEvent(o,d)&&(this.logger.safe.info(`[${r}] Raising UFD ${e} for ${i}: ${t}`),this.event("onQualityChanged").raise(o)))}signalDeviceEvent(t,i,n,r){const s=e.getQualityEventType(t,n,this.configProvider);s?this.signalEvent(s,i,n,void 0,Re(),r):this.logger.warn(`Unknown device quality event type: ${t}`)}raisePendingWhitelistingUFD(){this.lastWhitelistingUFD&&(this.logger.safe.debug(`Raising whitelisting UFD ${this.lastWhitelistingUFD.type}: ${this.lastWhitelistingUFD.value}`),this.event("onQualityChanged").raise(this.lastWhitelistingUFD),this.cancelPendingWhitelistingUFD())}cancelPendingWhitelistingUFD(){if(this.lastWhitelistingUFD){const e=this.getEventKey(this.lastWhitelistingUFD);this.eventStates.delete(e)}this.lastWhitelistingUFD=void 0}setSwMute(e){if(this.swMuted=e,e){const e=this.eventStates.get(this.getEventKey({type:"DeviceSpeakWhileMuted",mediaType:"Audio"}));e&&"Good"!==e.value&&this.event("onQualityChanged").raise(e)}}applyCurrentState(e){this.cancelPendingWhitelistingUFD();let t=0;for(const i of this.eventStates.values())"Good"!==i.value&&(e(i),t++);t>0&&this.logger.safe.info(`Applied ${t} UFDs`)}reset(){this.logger.safe.info("Resetting UFD states");for(const[t,i]of this.eventStates.entries())e.persistent.has(i.type)||this.eventStates.delete(t);this.lastWhitelistingUFD=void 0,this.swMuted=!1}getEventKey(e){return`${e.type}:${e.mediaType}`}shouldRaiseEvent(t,i){return"NetworkRelaysNotReachable"===t.type?(this.lastWhitelistingUFD=t,!1):!(!("DeviceSpeakWhileMuted"!==t.type||this.swMuted||"Good"===t.value&&"Good"!==i?.value)||"NetworkRecvQuality"===t.type&&!this.configProvider.config.webrtcStatNetworkDetectionEnabled||this.configProvider.config.alwaysRaiseBadDeviceEvents&&!e.deviceQualityEvents.has(t.type)&&t.value===i?.value)}static getQualityEventType(e,t,i){switch(e){case 0:return"Audio"===t?"DeviceCaptureNotFunctioning":"VideoCapturerDeviceStartFailed";case 1:return"Audio"===t?"DeviceCaptureNotFunctioning":"VideoCapturerDeviceStartTimedOut";case 2:return"DeviceCaptureMute";case 3:switch(t){case"ScreenShare":return"ScreenshareRecordingDisabled";case"Audio":return i.config.enableSignalingAudioPermissionDeniedUFD?"AudioCapturePermissionDenied":"DeviceCaptureNotMuteButSilent";case"Video":return"VideoCapturePermissionDenied";default:return}default:return}}};$m.persistent=new Set(["ZeroCaptureDevicesEnumerated","ZeroRenderDevicesEnumerated"]),$m.deviceQualityEvents=new Set(["DeviceCaptureNotFunctioning","VideoCapturerDeviceStartFailed","DeviceCaptureNotFunctioning","VideoCapturerDeviceStartTimedOut","DeviceCaptureMute","ScreenshareRecordingDisabled","DeviceCaptureNotMuteButSilent","VideoCapturePermissionDenied"]);var jm=$m,Gm=i(496486),Wm=i(496486),qm=i(496486),zm={maxOutgoingResolution:({settings:e})=>Qm(e),maxParticipantResolutions:({settings:e})=>Ym(e),maxIncomingStreams:({settings:e})=>Zm(e),maxSimulcastLayers:({settings:e})=>ef(e),outgoingVideoLimit:({settings:e,constraints:t})=>Xm(e,t)},Km=(e,t,i)=>(e.info(`Converting settings to constraints and mapping, [requestedConstraints=${JSON.stringify(i)}], [settings=${JSON.stringify(t)}]`),Jm((0,qm.cloneDeep)(i),(0,qm.cloneDeep)(t))),Jm=(e,t)=>Object.keys(e).reduce(((i,n)=>{const r=zm[n]?zm[n]({constraints:e,settings:t}):void 0;return r&&(i[n]=r),i}),{}),Ym=e=>e.multiviewResolutionLimits,Qm=e=>e.outgoingVideoLimit?.maxResolution,Xm=(e,t)=>{const i=t?.outgoingVideoLimit;if(!i)return;const{outgoingVideoLimit:n={}}=ut(e);if("number"==typeof i)return n?.maxResolution;const r=Object.keys(i).reduce(((e,t)=>{const i=n?.[t];return i&&(e[t]=i),e}),{});return Object.keys(r).length?r:void 0},Zm=e=>e.numVideoChannelsGvc,ef=e=>{const t=e.specCompliantSimulcast,i=t.video?.layerScaleFactors,n=t.sharing?.layerScaleFactors,r=i?.length?Math.max(...i):1,s=n?.length?Math.max(...i):1;return Math.min(r,s)},tf=i(496486),nf=e=>{const t=["maxResolution","maxBitrate","maxFramerate"],i=Object.entries(e);return 0!==i.length&&i.every((([e,i])=>(0,tf.isNumber)(i)&&(e=>t.includes(e))(e)))},rf=e=>!!(0,tf.isNumber)(e)||!!nf(e)&&!dt(e),sf={maxIncomingStreams:tf.isNumber,maxSimulcastLayers:tf.isNumber,maxOutgoingResolution:tf.isNumber,maxParticipantResolutions:e=>!!rt(e)&&(!!(0,tf.isNumber)(e)||"more"in e&&Object.values(e).every((e=>(0,tf.isNumber)(e)))),outgoingVideoLimit:e=>!!rt(e)&&rf(e),incomingVideoLimit:e=>!!rt(e)&&(!!rf(e)||"more"in e&&Object.values(e).every((e=>rf(e))))},af=(e,t)=>{for(const i in t){const n=e[i],r=t[i];e[i]="object"==typeof r?af({...n},r):st(n,r)}return e},of=class{constructor(e,t,i,n,r,s,a){this.logger=e,this.defaultSettings=t,this._mediaConfig=i,this._userAgentConfig=n,this._countryCode=r,this.platformCallConstraintsProvider=s,this.currentCallConstraints=a,this.mergedConstraints={},this.callConstraintsTelemetry=[],this.iceTransportPolicy=tt.ICE_TRANSPORT_POLICY.all,this.validIceTransportPolicies=[tt.ICE_TRANSPORT_POLICY.all,tt.ICE_TRANSPORT_POLICY.relay],this.mergeConstraintsTelemetryWithGlobal(),this.mergedConstraints=this.mergeConstraintsWithGlobal(this.currentCallConstraints),this.settings=this.mergeSettings((0,Wm.cloneDeep)(this.defaultSettings))}get config(){return this.settings}get mediaConfig(){return this._mediaConfig}get userAgentConfig(){return this._userAgentConfig}get countryCode(){return this._countryCode}addCallConstraintsTelemetryEvent(e,t){const i={timestamp:(new Date).getTime(),type:t,value:e};At(this.callConstraintsTelemetry,i,this.config.numCallConstraintsEvents)}getCallConstraintsTelemetry(){return this.callConstraintsTelemetry}getCallConstraints(){return this.mergedConstraints}setCallConstraints(e={}){this.addCallConstraintsTelemetryEvent(e,"requested"),this.logger.safe.debug("Saving new call constraints",JSON.stringify(e));const t=this.transformConstraints((e=>(e=JSON.parse(JSON.stringify(e)),Object.entries(sf).reduce(((t,[i,n])=>(n(e[i])&&(t[i]=e[i]),t)),{})))(e));return this.logger.safe.debug("Validated call constraints",JSON.stringify(t)),this.mergedConstraints=this.mergeConstraintsWithGlobal(t),this.settings=this.mergeSettings((0,Wm.cloneDeep)(this.defaultSettings)),Km(this.logger,this.settings,t)}getIceTransportPolicy(){return this.settings.iceTransportPolicyForced||this.iceTransportPolicy}setIceTransportPolicy(e){this.validIceTransportPolicies.includes(e)?(this.logger.info(`Setting transport policy to ${this.iceTransportPolicy}`),this.iceTransportPolicy=e):this.logger.debug(`Unknown incoming transport policy, using ${this.iceTransportPolicy}`)}transformConstraints(e){const t=(0,Wm.cloneDeep)(e);return"maxOutgoingResolution"in t&&(t.outgoingVideoLimit={maxResolution:t.maxOutgoingResolution},delete t.maxOutgoingResolution),"number"==typeof t.outgoingVideoLimit&&(t.outgoingVideoLimit={maxResolution:t.outgoingVideoLimit}),t}mergeConstraintsTelemetryWithGlobal(){this.platformCallConstraintsProvider.callConstraintsTelemetry.forEach((e=>At(this.callConstraintsTelemetry,e,this.defaultSettings.numCallConstraintsEvents)))}mergeConstraintsWithGlobal(e={}){const t=this.transformConstraints(this.platformCallConstraintsProvider.constraints);if(!Object.keys(t).length)return e;const i=(0,Wm.cloneDeep)(e);return af(i,t),this.logger.safe.debug(`Merging call constraints ${JSON.stringify(e)} and global constraints ${JSON.stringify(t)}. Result: ${JSON.stringify(i)}`),i}mergeSettings(e){if(!e.enablePlatformCallConstraints||!e.enablePlatformCallConstraintsPerCall)return e;const t=qt(this.logger,e,this.mergedConstraints);return this.logger.safe.info(`Merging settings with platform call constraints: ${Ge(t)}`),(0,Wm.assign)({},e,t,vI)}},lf="function",df="object",cf="undefined",hf="prototype",uf="hasOwnProperty",pf=Object,gf=pf[hf],mf=pf.assign,ff=pf.create,Sf=pf.defineProperty,vf=gf[uf],yf=null;function Cf(e){void 0===e&&(e=!0);var t=!1===e?null:yf;return t||(typeof globalThis!==cf&&(t=globalThis),t||typeof self===cf||(t=self),t||typeof window===cf||(t=window),t||typeof d===cf||(t=d),yf=t),t}function Tf(e){throw new TypeError(e)}function Ef(e){if(ff)return ff(e);if(null==e)return{};var t=typeof e;function i(){}return t!==df&&t!==lf&&Tf("Object prototype may only be an Object:"+e),i[hf]=e,new i}(Cf()||{}).Symbol,(Cf()||{}).Reflect;var _f,bf=mf||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])gf[uf].call(t,r)&&(e[r]=t[r]);return e},Pf=function(e,t){return(Pf=pf.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t[uf](i)&&(e[i]=t[i])})(e,t)};function If(e,t){function i(){this.constructor=e}typeof t!==lf&&null!==t&&Tf("Class extends value "+String(t)+" is not a constructor or null"),Pf(e,t),e[hf]=null===t?Ef(t):(i[hf]=t[hf],new i)}function Af(e,t){for(var i=0,n=t.length,r=e.length;i<n;i++,r++)e[r]=t[i];return e}var Rf,wf="undefined",Mf="constructor",Of="prototype",Df="function",kf="_dynInstFuncs",Nf="_isDynProxy",Lf="_dynClass",xf="_dynInstChk",Ff=xf,Uf="_dfOpts",Vf="_unknown_",Hf="__proto__",Bf="_dyn"+Hf,$f="__dynProto$Gbl",jf="_dynInstProto",Gf="useBaseInst",Wf="setInstFuncs",qf=Object,zf=qf.getPrototypeOf,Kf=qf.getOwnPropertyNames,Jf=(typeof globalThis!==wf&&(Rf=globalThis),Rf||typeof self===wf||(Rf=self),Rf||typeof window===wf||(Rf=window),Rf||typeof d===wf||(Rf=d),Rf||{}),Yf=Jf[$f]||(Jf[$f]={o:(_f={},_f[Wf]=!0,_f[Gf]=!0,_f),n:1e3});function Qf(e,t){return e&&qf[Of].hasOwnProperty.call(e,t)}function Xf(e){return e&&(e===qf[Of]||e===Array[Of])}function Zf(e){return Xf(e)||e===Function[Of]}function eS(e){var t;if(e){if(zf)return zf(e);var i=e[Hf]||e[Of]||(e[Mf]?e[Mf][Of]:null);t=e[Bf]||i,Qf(e,Bf)||(delete e[jf],t=e[Bf]=e[jf]||e[Bf],e[jf]=i)}return t}function tS(e,t){var i=[];if(Kf)i=Kf(e);else for(var n in e)"string"==typeof n&&Qf(e,n)&&i.push(n);if(i&&i.length>0)for(var r=0;r<i.length;r++)t(i[r])}function iS(e,t,i){return t!==Mf&&typeof e[t]===Df&&(i||Qf(e,t))}function nS(e){throw new TypeError("DynamicProto: "+e)}function rS(e,t){for(var i=e.length-1;i>=0;i--)if(e[i]===t)return!0;return!1}function sS(e,t,i,n,r){function s(e,t){var i=function(){var n=function(e,t,i,n){var r=null;if(e&&Qf(i,Lf)){var s=e[kf]||{};if((r=(s[i[Lf]]||{})[t])||nS("Missing ["+t+"] "+Df),!r[xf]&&!1!==s[Ff]){for(var a=!Qf(e,t),o=eS(e),l=[];a&&o&&!Zf(o)&&!rS(l,o);){var d=o[t];if(d){a=d===n;break}l.push(o),o=eS(o)}try{a&&(e[t]=r),r[xf]=1}catch(e){s[Ff]=!1}}}return r}(this,t,e,i)||function(e,t,i){var n=t[e];return n===i&&(n=eS(t)[e]),typeof n!==Df&&nS("["+e+"] is not a "+Df),n}(t,e,i);return n.apply(this,arguments)};return i[Nf]=1,i}if(!Xf(e)){var a=i[kf]=i[kf]||{},o=a[t]=a[t]||{};!1!==a[Ff]&&(a[Ff]=!!r),tS(i,(function(t){iS(i,t,!1)&&i[t]!==n[t]&&(o[t]=i[t],delete i[t],(!Qf(e,t)||e[t]&&!e[t][Nf])&&(e[t]=s(e,t)))}))}}function aS(e,t){return Qf(e,Of)?e.name||t||Vf:((e||{})[Mf]||{}).name||t||Vf}function oS(e,t,i,n){Qf(e,Of)||nS("theClass is an invalid class definition.");var r=e[Of];(function(e,t){if(zf){for(var i=[],n=eS(t);n&&!Zf(n)&&!rS(i,n);){if(n===e)return!0;i.push(n),n=eS(n)}return!1}return!0})(r,t)||nS("["+aS(e)+"] not in hierarchy of ["+aS(t)+"]");var s=null;Qf(r,Lf)?s=r[Lf]:(s="_dynCls$"+aS(e,"_")+"$"+Yf.n,Yf.n++,r[Lf]=s);var a=oS[Uf],o=!!a[Gf];o&&n&&void 0!==n[Gf]&&(o=!!n[Gf]);var l=function(e){var t={};return tS(e,(function(i){!t[i]&&iS(e,i,!1)&&(t[i]=e[i])})),t}(t),d=function(e,t,i,n){function r(e,t,i){var r=t[i];if(r[Nf]&&n){var s=e[kf]||{};!1!==s[Ff]&&(r=(s[t[Lf]]||{})[i]||r)}return function(){return r.apply(e,arguments)}}var s={};tS(i,(function(e){s[e]=r(t,i,e)}));for(var a=eS(e),o=[];a&&!Zf(a)&&!rS(o,a);)tS(a,(function(e){!s[e]&&iS(a,e,!zf)&&(s[e]=r(t,a,e))})),o.push(a),a=eS(a);return s}(r,t,l,o);i(t,d);var c=!!zf&&!!a[Wf];c&&n&&(c=!!n[Wf]),sS(r,s,t,l,!1!==c)}oS[Uf]=Yf.o;var lS="initialize",dS="name",cS="getNotifyMgr",hS="identifier",uS="push",pS="isInitialized",gS="config",mS="instrumentationKey",fS="logger",SS="length",vS="time",yS="processNext",CS="getProcessTelContext",TS="addNotificationListener",ES="removeNotificationListener",_S="stopPollingInternalLogs",bS="onComplete",PS="getPlugin",IS="flush",AS="_extensions",RS="splice",wS="teardown",MS="messageId",OS="message",DS="isAsync",kS="_doTeardown",NS="update",LS="getNext",xS="diagLog",FS="setNextPlugin",US="createNew",VS="cookieCfg",HS="indexOf",BS="substring",$S="userAgent",jS="split",GS="setEnabled",WS="substr",qS="nodeType",zS="apply",KS="replace",JS="enableDebugExceptions",YS="toLowerCase",QS="call",XS="type",ZS="handler",ev="listeners",tv="isChildEvt",iv="getCtx",nv="setCtx",rv="complete",sv="traceId",av="spanId",ov="traceFlags",lv="",dv="channels",cv="core",hv="createPerfMgr",uv="disabled",pv="extensionConfig",gv="processTelemetry",mv="priority",fv="eventsSent",Sv="eventsDiscarded",vv="eventsSendRequest",yv="perfEvent",Cv="errorToConsole",Tv="warnToConsole",Ev="getPerfMgr",_v="toISOString",bv="endsWith",Pv="startsWith",Iv="indexOf",Av="trim",Rv="toString",wv="__proto__",Mv="constructor",Ov=Sf,Dv=pf.freeze,kv=(pf.seal,pf.keys),Nv=String[hf],Lv=Nv[Av],xv=Nv[bv],Fv=Nv[Pv],Uv=Date[hf][_v],Vv=Array.isArray,Hv=gf[Rv],Bv=vf[Rv],$v=Bv[QS](pf),jv=/-([a-z])/g,Gv=/([^\w\d_$])/g,Wv=/^(\d+[\w\d_$])/,qv=Object.getPrototypeOf;function zv(e){return void 0===e||typeof e===cf}function Kv(e){return null===e||zv(e)}function Jv(e){return!Kv(e)}function Yv(e,t){return!(!e||!vf[QS](e,t))}function Qv(e){return!(!e||typeof e!==df)}function Xv(e){return!(!e||typeof e!==lf)}function Zv(e){var t=e;return t&&sy(t)&&(t=(t=(t=t[KS](jv,(function(e,t){return t.toUpperCase()})))[KS](Gv,"_"))[KS](Wv,(function(e,t){return"_"+t}))),t}function ey(e,t){if(e)for(var i in e)vf[QS](e,i)&&t[QS](e,i,e[i])}function ty(e,t){var i=!1;return e&&t&&!(i=e===t)&&(i=xv?e[bv](t):function(e,t){var i=!1,n=t?t[SS]:0,r=e?e[SS]:0;if(n&&r&&r>=n&&!(i=e===t)){for(var s=r-1,a=n-1;a>=0;a--){if(e[s]!=t[a])return!1;s--}i=!0}return i}(e,t)),i}function iy(e,t){var i=!1;return e&&t&&!(i=e===t)&&(i=Fv?e[Pv](t):function(e,t){var i=!1,n=t?t[SS]:0;if(e&&n&&e[SS]>=n&&!(i=e===t)){for(var r=0;r<n;r++)if(e[r]!==t[r])return!1;i=!0}return i}(e,t)),i}function ny(e,t){return!(!e||!t)&&-1!==e[HS](t)}var ry=Vv||function(e){return!(!e||"[object Array]"!==Hv[QS](e))};function sy(e){return"string"==typeof e}function ay(e){return"number"==typeof e}function oy(e){return"boolean"==typeof e}function ly(e){var t=!1;if(e&&"object"==typeof e){var i=qv?qv(e):function(e){if(e){if(qv)return qv(e);var t=e[wv]||e[hf]||e[Mv];if(t)return t}return null}(e);i?(i[Mv]&&vf[QS](i,Mv)&&(i=i[Mv]),t=typeof i===lf&&Bv[QS](i)===$v):t=!0}return t}function dy(e){if(e)return Uv?e[_v]():function(e){if(e&&e.getUTCFullYear){var t=function(e){var t=String(e);return 1===t[SS]&&(t="0"+t),t};return e.getUTCFullYear()+"-"+t(e.getUTCMonth()+1)+"-"+t(e.getUTCDate())+"T"+t(e.getUTCHours())+":"+t(e.getUTCMinutes())+":"+t(e.getUTCSeconds())+"."+String((e.getUTCMilliseconds()/1e3).toFixed(3)).slice(2,5)+"Z"}}(e)}function cy(e,t,i){var n=e[SS];try{for(var r=0;r<n&&(!(r in e)||-1!==t[QS](i||e,e[r],r,e));r++);}catch(e){}}function hy(e,t,i){if(e){if(e[Iv])return e[Iv](t,i);var n=e[SS],r=i||0;try{for(var s=Math.max(r>=0?r:n-Math.abs(r),0);s<n;s++)if(s in e&&e[s]===t)return s}catch(e){}}return-1}function uy(e){return e&&(e=Lv&&e[Av]?e[Av]():e[KS]?e[KS](/^\s+|(?=\s)\s+$/g,lv):e),e}var py=!{toString:null}.propertyIsEnumerable("toString"),gy=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"];function my(e){var t=typeof e;if(t===lf||t===df&&null!==e||Tf("objKeys called on non-object"),!py&&kv)return kv(e);var i=[];for(var n in e)e&&vf[QS](e,n)&&i[uS](n);if(py)for(var r=gy[SS],s=0;s<r;s++)e&&vf[QS](e,gy[s])&&i[uS](gy[s]);return i}function fy(e,t,i,n){if(Ov)try{var r={enumerable:!0,configurable:!0};return i&&(r.get=i),n&&(r.set=n),Ov(e,t,r),!0}catch(e){}return!1}function Sy(e){return Dv&&ey(e,(function(e,t){(ry(t)||Qv(t))&&Dv(t)})),vy(e)}var vy=Dv||function(e){return e};function yy(){var e=Date;return e.now?e.now():(new e).getTime()}function Cy(e){return(t=e)&&"[object Error]"===Hv[QS](t)?e[dS]:lv;var t}function Ty(e,t,i,n,r){var s=i;return e&&((s=e[t])===i||r&&!r(s)||n&&!n(i)||(s=i,e[t]=s)),s}function Ey(e,t,i){var n;return e?!(n=e[t])&&Kv(n)&&(n=zv(i)?{}:i,e[t]=n):n=zv(i)?{}:i,n}function _y(e,t){return Kv(e)?t:e}function by(e){return!!e}function Py(e){throw new Error(e)}function Iy(e,t,i,n,r){e&&t&&i&&(!1!==r||zv(e[t]))&&(e[t]=function(e,t){var i=null,n=null;return Xv(e)?i=e:n=e,function(){var e=arguments;if(i&&(n=i()),n)return n[t][zS](n,e)}}(i,n))}function Ay(e,t,i,n){return e&&t&&Qv(e)&&ry(i)&&cy(i,(function(i){sy(i)&&Iy(e,i,t,i,n)})),e}function Ry(e){return e&&mf&&(e=pf(mf({},e))),e}function wy(e,t,i,n,r,s){var a=arguments,o=a[0]||{},l=a[SS],d=!1,c=1;for(l>0&&oy(o)&&(d=o,o=a[c]||{},c++),Qv(o)||(o={});c<l;c++){var h=a[c],u=ry(h),p=Qv(h);for(var g in h)if(u&&g in h||p&&vf[QS](h,g)){var m=h[g],f=void 0;if(d&&m&&((f=ry(m))||ly(m))){var S=o[g];f?ry(S)||(S=[]):ly(S)||(S={}),m=wy(d,S,m)}void 0!==m&&(o[g]=m)}}return o}function My(e){var t={};return ey(e,(function(e,i){t[e]=i,t[i]=e})),Sy(t)}function Oy(e){var t={};return ey(e,(function(e,i){t[e]=i[1],t[i[0]]=i[1]})),Sy(t)}var Dy=My({Unknown:0,NonRetryableStatus:1,InvalidEvent:2,SizeLimitExceeded:3,KillSwitch:4,QueueFull:5}),ky="window",Ny="document",Ly="navigator",xy="location",Fy="console",Uy="performance",Vy="JSON",Hy="crypto",By="msCrypto",$y="msie",jy="trident/",Gy="XMLHttpRequest",Wy=null,qy=null,zy=!1,Ky=null,Jy=null;function Yy(e,t){var i=!1;if(e){try{if(!(i=t in e)){var n=e[hf];n&&(i=t in n)}}catch(e){}if(!i)try{i=!zv((new e)[t])}catch(e){}}return i}function Qy(e){var t=Cf();return t&&t[e]?t[e]:e===ky&&Xy()?window:null}function Xy(){return Boolean(typeof window===df&&window)}function Zy(){return Xy()?window:Qy(ky)}function eC(){return Boolean(typeof document===df&&document)}function tC(){return eC()?document:Qy(Ny)}function iC(){return Boolean(typeof navigator===df&&navigator)}function nC(){return iC()?navigator:Qy(Ly)}function rC(e){if(e&&zy){var t=Qy("__mockLocation");if(t)return t}return typeof location===df&&location?location:Qy(xy)}function sC(){return Boolean(typeof JSON===df&&JSON||null!==Qy(Vy))}function aC(){return sC()?JSON||Qy(Vy):null}function oC(){var e=nC();return!(!e||!e.product)&&"ReactNative"===e.product}function lC(){var e=nC();if(e&&(e[$S]!==qy||null===Wy)){var t=((qy=e[$S])||lv)[YS]();Wy=ny(t,$y)||ny(t,jy)}return Wy}function dC(e){var t=Object[hf].toString[QS](e),i=lv;return"[object Error]"===t?i="{ stack: '"+e.stack+"', message: '"+e.message+"', name: '"+e[dS]+"'":sC()&&(i=aC().stringify(e)),t+i}function cC(){return null===Jy&&(Jy=iC()&&Boolean(nC().sendBeacon)),Jy}function hC(e){var t=!1;try{t=!!Qy("fetch");var i=Qy("Request");t&&e&&i&&(t=Yy(i,"keepalive"))}catch(e){}return t}function uC(){var e=!1;try{e=!!Qy(Gy)}catch(e){}return e}var pC,gC=["eventsSent","eventsDiscarded","eventsSendRequest","perfEvent"],mC=null;function fC(e,t){return function(){var i=arguments,n=SC(t);if(n){var r=n.listener;r&&r[e]&&r[e][zS](r,i)}}}function SC(e){var t,i=mC;return i||!0===e.disableDbgExt||(i=mC||((t=Qy("Microsoft"))&&(mC=t.ApplicationInsights),mC)),i?i.ChromeDbgExt:null}function vC(e){return e?'"'+e[KS](/\"/g,lv)+'"':lv}function yC(e,t){var i=typeof console!==cf?console:Qy(Fy);if(i){var n="log";i[e]&&(n=e),Xv(i[n])&&i[n](t)}}var CC=function(){function e(e,t,i,n){void 0===i&&(i=!1);var r=this;r[MS]=e,r[OS]=(i?"AI: ":"AI (Internal): ")+e;var s=lv;sC()&&(s=aC().stringify(n));var a=(t?" message:"+vC(t):lv)+(n?" props:"+vC(s):lv);r[OS]+=a}return e.dataType="MessageData",e}();function TC(e,t){return(e||{})[fS]||new EC(t)}var EC=function(){function e(t){this.identifier="DiagnosticLogger",this.queue=[];var i,n,r,s,a=0,o={};oS(e,this,(function(e){var l;function d(t,i){if(!(a>=r)){var s=!0,l="AITR_"+i[MS];if(o[l]?s=!1:o[l]=!0,s&&(t<=n&&(e.queue[uS](i),a++,c(1===t?"error":"warn",i)),a===r)){var d="Internal events throttle limit per PageView reached for this app.",h=new CC(23,d,!1);e.queue[uS](h),1===t?e[Cv](d):e[Tv](d)}}}function c(e,i){var n=SC(t||{});n&&n[xS]&&n[xS](e,i)}i=_y((l=t||{}).loggingLevelConsole,0),n=_y(l.loggingLevelTelemetry,1),r=_y(l.maxMessageLimit,25),s=_y(l[JS],!1),e.consoleLoggingLevel=function(){return i},e.telemetryLoggingLevel=function(){return n},e.maxInternalMessageLimit=function(){return r},e[JS]=function(){return s},e.throwInternal=function(t,n,r,a,l){void 0===l&&(l=!1);var h=new CC(n,r,l,a);if(s)throw dC(h);var u=1===t?Cv:Tv;if(zv(h[OS]))c("throw"+(1===t?"Critical":"Warning"),h);else{if(l){var p=+h[MS];!o[p]&&i>=t&&(e[u](h[OS]),o[p]=!0)}else i>=t&&e[u](h[OS]);d(t,h)}},e[Tv]=function(e){yC("warn",e),c("warning",e)},e[Cv]=function(e){yC("error",e),c("error",e)},e.resetInternalMessageCount=function(){a=0,o={}},e.logInternalMessage=d}))}return e.__ieDyn=1,e}();function _C(e){return e||new EC}function bC(e,t,i,n,r,s){void 0===s&&(s=!1),_C(e).throwInternal(t,i,n,r,s)}function PC(e,t){_C(e)[Tv](t)}var IC="ctx",AC="ParentContextKey",RC="ChildrenContextKey",wC=function(){function e(t,i,n){var r,s=this,a=!1;s.start=yy(),s[dS]=t,s[DS]=n,s[tv]=function(){return!1},Xv(i)&&(a=fy(s,"payload",(function(){return!r&&Xv(i)&&(r=i(),i=null),r}))),s[iv]=function(t){return t?t===e[AC]||t===e[RC]?s[t]:(s[IC]||{})[t]:null},s[nv]=function(t,i){t&&(t===e[AC]?(s[t]||(s[tv]=function(){return!0}),s[t]=i):t===e[RC]?s[t]=i:(s[IC]=s[IC]||{})[t]=i)},s[rv]=function(){var t=0,n=s[iv](e[RC]);if(ry(n))for(var r=0;r<n[SS];r++){var o=n[r];o&&(t+=o[vS])}s[vS]=yy()-s.start,s.exTime=s[vS]-t,s[rv]=function(){},!a&&Xv(i)&&(s.payload=i())}}return e.ParentContextKey="parent",e.ChildrenContextKey="childEvts",e}(),MC=function(){function e(t){this.ctx={},oS(e,this,(function(e){e.create=function(e,t,i){return new wC(e,t,i)},e.fire=function(e){e&&(e[rv](),t&&Xv(t[yv])&&t[yv](e))},e[nv]=function(t,i){t&&((e[IC]=e[IC]||{})[t]=i)},e[iv]=function(t){return(e[IC]||{})[t]}}))}return e.__ieDyn=1,e}(),OC="CoreUtils.doPerf";function DC(e,t,i,n,r){if(e){var s=e;if(s[Ev]&&(s=s[Ev]()),s){var a=void 0,o=s[iv](OC);try{if(a=s.create(t(),n,r)){if(o&&a[nv]&&(a[nv](wC[AC],o),o[iv]&&o[nv])){var l=o[iv](wC[RC]);l||(l=[],o[nv](wC[RC],l)),l[uS](a)}return s[nv](OC,a),i(a)}}catch(e){a&&a[nv]&&a[nv]("exception",e)}finally{a&&s.fire(a),s[nv](OC,o)}}}return i()}var kC=4294967296,NC=4294967295,LC=!1,xC=123456789,FC=987654321;function UC(){try{var e=2147483647&yy();(t=(Math.random()*kC^e)+e)<0&&(t>>>=0),xC=123456789+t&NC,FC=987654321-t&NC,LC=!0}catch(e){}var t}function VC(e){var t=0,i=Qy(Hy)||Qy(By);return i&&i.getRandomValues&&(t=i.getRandomValues(new Uint32Array(1))[0]&NC),0===t&&lC()&&(LC||UC(),t=function(e){var t=((FC=36969*(65535&FC)+(FC>>16)&NC)<<16)+(65535&(xC=18e3*(65535&xC)+(xC>>16)&NC))>>>0&NC|0;return e||(t>>>=0),t}()&NC),0===t&&(t=Math.floor(kC*Math.random()|0)),e||(t>>>=0),t}function HC(e){void 0===e&&(e=22);for(var t=VC()>>>0,i=0,n=lv;n[SS]<e;)i++,n+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(63&t),t>>>=6,5===i&&(t=(VC()<<2&4294967295|3&t)>>>0,i=0);return n}var BC=Sf,$C="2.8.10",jC="."+HC(6),GC=0;function WC(e){return 1===e[qS]||9===e[qS]||!+e[qS]}function qC(e,t){var i=t[e.id];if(!i){i={};try{WC(t)&&(function(e,t,i){if(BC)try{return BC(e,t,{value:i,enumerable:!1,configurable:!0}),!0}catch(e){}return!1}(t,e.id,i)||(t[e.id]=i))}catch(e){}}return i}function zC(e,t){return void 0===t&&(t=!1),Zv(e+GC+++(t?"."+$C:lv)+jC)}function KC(e){var t={id:zC("_aiData-"+(e||lv)+"."+$C),accept:function(e){return WC(e)},get:function(e,i,n,r){var s=e[t.id];return s?s[Zv(i)]:(r&&((s=qC(t,e))[Zv(i)]=n),n)},kill:function(e,t){if(e&&e[t])try{delete e[t]}catch(e){}}};return t}var JC="toGMTString",YC="toUTCString",QC="cookie",XC="expires",ZC="enabled",eT="isCookieUseDisabled",tT="disableCookiesUsage",iT="_ckMgr",nT=null,rT=null,sT=null,aT=tC(),oT={},lT={};function dT(e){return!e||e.isEnabled()}function cT(e,t){return!!(t&&e&&ry(e.ignoreCookies))&&-1!==e.ignoreCookies[HS](t)}function hT(e,t){var i;if(e)i=e.getCookieMgr();else if(t){var n=t[VS];i=n[iT]?n[iT]:uT(t)}return i||(i=function(e,t){var i=uT[iT]||lT[iT];return i||(i=uT[iT]=uT(e,t),lT[iT]=i),i}(t,(e||{})[fS])),i}function uT(e,t){var i,n=function(e){var t=e[VS]=e[VS]||{};if(Ty(t,"domain",e.cookieDomain,Jv,Kv),Ty(t,"path",e.cookiePath||"/",null,Kv),Kv(t[ZC])){var i=void 0;zv(e[eT])||(i=!e[eT]),zv(e[tT])||(i=!e[tT]),t[ZC]=i}return t}(e||lT),r=n.path||"/",s=n.domain,a=!1!==n[ZC],o=((i={isEnabled:function(){var e=a&&pT(t),i=lT[iT];return e&&i&&o!==i&&(e=dT(i)),e}})[GS]=function(e){a=!1!==e},i.set=function(e,t,i,a,l){var d,c=!1;if(dT(o)&&!function(e,t){return!!(t&&e&&ry(e.blockedCookies)&&-1!==e.blockedCookies[HS](t))||cT(e,t)}(n,e)){var h={},u=uy(t||lv),p=u[HS](";");if(-1!==p&&(u=uy(t[BS](0,p)),h=gT(t[BS](p+1))),Ty(h,"domain",a||s,by,zv),!Kv(i)){var g=lC();if(zv(h[XC])){var m=yy()+1e3*i;if(m>0){var f=new Date;f.setTime(m),Ty(h,XC,mT(f,g?JC:YC)||mT(f,g?JC:YC)||lv,by)}}g||Ty(h,"max-age",lv+i,null,zv)}var S=rC();S&&"https:"===S.protocol&&(Ty(h,"secure",null,null,zv),null===rT&&(d=(nC()||{})[$S],rT=!(sy(d)&&(ny(d,"CPU iPhone OS 12")||ny(d,"iPad; CPU OS 12")||ny(d,"Macintosh; Intel Mac OS X 10_14")&&ny(d,"Version/")&&ny(d,"Safari")||ny(d,"Macintosh; Intel Mac OS X 10_14")&&ty(d,"AppleWebKit/605.1.15 (KHTML, like Gecko)")||ny(d,"Chrome/5")||ny(d,"Chrome/6")||ny(d,"UnrealEngine")&&!ny(d,"Chrome")||ny(d,"UCBrowser/12")||ny(d,"UCBrowser/11")))),rT&&Ty(h,"SameSite","None",null,zv)),Ty(h,"path",l||r,null,zv),(n.setCookie||vT)(e,fT(u,h)),c=!0}return c},i.get=function(e){var t=lv;return dT(o)&&!cT(n,e)&&(t=(n.getCookie||ST)(e)),t},i.del=function(e,t){var i=!1;return dT(o)&&(i=o.purge(e,t)),i},i.purge=function(e,i){var r,s=!1;if(pT(t)){var a=((r={}).path=i||"/",r[XC]="Thu, 01 Jan 1970 00:00:01 GMT",r);lC()||(a["max-age"]="0"),(n.delCookie||vT)(e,fT(lv,a)),s=!0}return s},i);return o[iT]=o,o}function pT(e){if(null===nT){nT=!1;try{nT=void 0!==(aT||{})[QC]}catch(t){bC(e,2,68,"Cannot access document.cookie - "+Cy(t),{exception:dC(t)})}}return nT}function gT(e){var t={};return e&&e[SS]&&cy(uy(e)[jS](";"),(function(e){if(e=uy(e||lv)){var i=e[HS]("=");-1===i?t[e]=null:t[uy(e[BS](0,i))]=uy(e[BS](i+1))}})),t}function mT(e,t){return Xv(e[t])?e[t]():null}function fT(e,t){var i=e||lv;return ey(t,(function(e,t){i+="; "+e+(Kv(t)?lv:"="+t)})),i}function ST(e){var t=lv;if(aT){var i=aT[QC]||lv;sT!==i&&(oT=gT(i),sT=i),t=uy(oT[e]||lv)}return t}function vT(e,t){aT&&(aT[QC]=e+"="+t)}var yT="on",CT="attachEvent",TT="addEventListener",ET="detachEvent",_T="removeEventListener",bT="events",PT="visibilitychange",IT="pagehide",AT="pageshow",RT="unload",wT="beforeunload",MT=zC("aiEvtPageHide"),OT=zC("aiEvtPageShow"),DT=/\.[\.]+/g,kT=/[\.]+$/,NT=1,LT=KC("events"),xT=/^([^.]*)(?:\.(.+)|)/;function FT(e){return e&&e[KS]?e[KS](/^[\s\.]+|(?=[\s\.])[\.\s]+$/g,lv):e}function UT(e,t){var i;if(t){var n=lv;ry(t)?(n=lv,cy(t,(function(e){(e=FT(e))&&("."!==e[0]&&(e="."+e),n+=e)}))):n=FT(t),n&&("."!==n[0]&&(n="."+n),e=(e||lv)+n)}var r=xT.exec(e||lv)||[];return(i={})[XS]=r[1],i.ns=(r[2]||lv).replace(DT,".").replace(kT,lv)[jS](".").sort().join("."),i}function VT(e,t,i){void 0===i&&(i=!0);var n=LT.get(e,bT,{},i),r=n[t];return r||(r=n[t]=[]),r}function HT(e,t,i,n){e&&t&&t[XS]&&(e[_T]?e[_T](t[XS],i,n):e[ET]&&e[ET](yT+t[XS],i))}function BT(e,t,i,n){for(var r=t[SS];r--;){var s=t[r];s&&(i.ns&&i.ns!==s.evtName.ns||n&&!n(s)||(HT(e,s.evtName,s[ZS],s.capture),t[RS](r,1)))}}function $T(e,t){return t?UT("xx",ry(t)?[e].concat(t):[e,t]).ns[jS]("."):e}function jT(e,t,i,n,r){var s;void 0===r&&(r=!1);var a=!1;if(e)try{var o=UT(t,n);if(a=function(e,t,i,n){var r=!1;return e&&t&&t[XS]&&i&&(e[TT]?(e[TT](t[XS],i,n),r=!0):e[CT]&&(e[CT](yT+t[XS],i),r=!0)),r}(e,o,i,r),a&&LT.accept(e)){var l=((s={guid:NT++,evtName:o})[ZS]=i,s.capture=r,s);VT(e,o.type)[uS](l)}}catch(e){}return a}function GT(e,t,i,n,r){if(void 0===r&&(r=!1),e)try{var s=UT(t,n),a=!1;!function(e,t,i){if(t[XS])BT(e,VT(e,t[XS]),t,i);else{var n=LT.get(e,bT,{});ey(n,(function(n,r){BT(e,r,t,i)})),0===my(n)[SS]&&LT.kill(e,bT)}}(e,s,(function(e){return!((!s.ns||i)&&e[ZS]!==i||(a=!0,0))})),a||HT(e,s,i,r)}catch(e){}}function WT(e,t,i,n){var r=!1;return t&&e&&e[SS]>0&&cy(e,(function(e){e&&(i&&-1!==hy(i,e)||(r=function(e,t,i){var n=!1,r=Zy();r&&(n=jT(r,e,t,i),n=jT(r.body,e,t,i)||n);var s=tC();return s&&(n=jT(s,e,t,i)||n),n}(e,t,n)||r))})),r}function qT(e,t,i){e&&ry(e)&&cy(e,(function(e){e&&function(e,t,i){var n=Zy();n&&(GT(n,e,t,i),GT(n.body,e,t,i));var r=tC();r&&GT(r,e,t,i)}(e,t,i)}))}function zT(e,t,i){return function(e,t,i,n){var r=!1;return t&&e&&ry(e)&&!(r=WT(e,t,i,n))&&i&&i[SS]>0&&(r=WT(e,t,null,n)),r}([wT,RT,IT],e,t,i)}function KT(e,t,i){var n=$T(MT,i),r=WT([IT],e,t,n);return t&&-1!==hy(t,PT)||(r=WT([PT],(function(t){var i=tC();e&&i&&"hidden"===i.visibilityState&&e(t)}),t,n)||r),!r&&t&&(r=KT(e,null,i)),r}function JT(e,t,i){var n=$T(OT,i),r=WT([AT],e,t,n);return!(r=WT([PT],(function(t){var i=tC();e&&i&&"visible"===i.visibilityState&&e(t)}),t,n)||r)&&t&&(r=JT(e,null,i)),r}function YT(){var e=QT();return e[BS](0,8)+"-"+e[BS](8,12)+"-"+e[BS](12,16)+"-"+e[BS](16,20)+"-"+e[BS](20)}function QT(){for(var e,t=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],i=lv,n=0;n<4;n++)i+=t[15&(e=VC())]+t[e>>4&15]+t[e>>8&15]+t[e>>12&15]+t[e>>16&15]+t[e>>20&15]+t[e>>24&15]+t[e>>28&15];var r=t[8+(3&VC())|0];return i[WS](0,8)+i[WS](9,4)+"4"+i[WS](13,3)+r+i[WS](16,3)+i[WS](19,12)}var XT="00000000000000000000000000000000",ZT="0000000000000000";function eE(e,t,i){return!(!e||e[SS]!==t||e===i||!e.match(/^[\da-f]*$/))}function tE(e){return eE(e,32,XT)}function iE(e){return eE(e,16,ZT)}var nE=KC("plugin");function rE(e){return nE.get(e,"state",{},!0)}function sE(e,t){for(var i,n=[],r=null,s=e[LS]();s;){var a=s[PS]();a&&(r&&Xv(r[FS])&&Xv(a[gv])&&r[FS](a),(Xv(a[pS])?a[pS]():(i=rE(a))[pS])||n[uS](a),r=a,s=s[LS]())}cy(n,(function(n){var r=e[cv]();n[lS](e.getCfg(),r,t,e[LS]()),i=rE(n),n[cv]||i[cv]||(i[cv]=r),i[pS]=!0,delete i[wS]}))}function aE(e){return e.sort((function(e,t){var i=0;if(t){var n=Xv(t[gv]);Xv(e[gv])?i=n?e[mv]-t[mv]:1:n&&(i=-1)}else i=e?1:-1;return i}))}var oE="TelemetryPluginChain",lE="_hasRun",dE="_getTelCtx",cE=0;function hE(e,t,i,n){var r=null,s=[];null!==n&&(r=n?function(e,t,i){for(;e;){if(e[PS]()===i)return e;e=e[LS]()}return mE([i],t[gS]||{},t)}(e,i,n):e);var a={_next:function(){var e=r;if(r=e?e[LS]():null,!e){var t=s;t&&t[SS]>0&&(cy(t,(function(e){try{e.func[QS](e.self,e.args)}catch(e){bC(i[fS],2,73,"Unexpected Exception during onComplete - "+dC(e))}})),s=[])}return e},ctx:{core:function(){return i},diagLog:function(){return TC(i,t)},getCfg:function(){return t},getExtCfg:o,getConfig:function(e,i,n){void 0===n&&(n=!1);var r,s=o(e,null);return s&&!Kv(s[i])?r=s[i]:t&&!Kv(t[i])&&(r=t[i]),Kv(r)?n:r},hasNext:function(){return!!r},getNext:function(){return r},setNext:function(e){r=e},iterate:function(e){for(var t;t=a._next();){var i=t[PS]();i&&e(i)}},onComplete:function(e,t){for(var i=[],n=2;n<arguments.length;n++)i[n-2]=arguments[n];e&&s[uS]({func:e,self:zv(t)?a.ctx:t,args:i})}}};function o(e,i,n){var r;if(void 0===i&&(i={}),void 0===n&&(n=0),t){var s=t[pv];s&&e&&(r=s[e])}if(r){if(Qv(i)&&0!==n){var a=wy(!0,i,r);t&&2===n&&ey(i,(function(e){if(Kv(a[e])){var i=t[e];Kv(i)||(a[e]=i)}})),r=a}}else r=i;return r}return a}function uE(e,t,i,n){var r=hE(e,t,i,n),s=r.ctx;return s[yS]=function(e){var t=r._next();return t&&t[gv](e,s),!t},s[US]=function(e,n){return void 0===e&&(e=null),ry(e)&&(e=mE(e,t,i,n)),uE(e||s[LS](),t,i,n)},s}function pE(e,t,i){var n=t[gS]||{},r=hE(e,n,t,i),s=r.ctx;return s[yS]=function(e){var t=r._next();return t&&t.unload(s,e),!t},s[US]=function(e,i){return void 0===e&&(e=null),ry(e)&&(e=mE(e,n,t,i)),pE(e||s[LS](),t,i)},s}function gE(e,t,i){var n=t[gS]||{},r=hE(e,n,t,i).ctx;return r[yS]=function(e){return r.iterate((function(t){Xv(t[NS])&&t[NS](r,e)}))},r[US]=function(e,i){return void 0===e&&(e=null),ry(e)&&(e=mE(e,n,t,i)),gE(e||r[LS](),t,i)},r}function mE(e,t,i,n){var r=null,s=!n;if(ry(e)&&e[SS]>0){var a=null;cy(e,(function(e){if(s||n!==e||(s=!0),s&&e&&Xv(e[gv])){var o=function(e,t,i){var n,r=null,s=Xv(e[gv]),a=Xv(e[FS]),o={getPlugin:function(){return e},getNext:function(){return r},processTelemetry:c,unload:h,update:u,_id:n=e?e[hS]+"-"+e[mv]+"-"+cE++:"Unknown-0-"+cE++,_setNext:function(e){r=e}};function l(){var n;return e&&Xv(e[dE])&&(n=e[dE]()),n||(n=uE(o,t,i)),n}function d(t,i,s,a,o){var l=!1,d=e?e[hS]:oE,c=t[lE];return c||(c=t[lE]={}),t.setNext(r),e&&DC(t[cv](),(function(){return d+":"+s}),(function(){c[n]=!0;try{var e=r?r._id:lv;e&&(c[e]=!1),l=i(t)}catch(e){var a=!r||c[r._id];a&&(l=!0),r&&a||bC(t[xS](),1,73,"Plugin ["+d+"] failed during "+s+" - "+dC(e)+", run flags: "+dC(c))}}),a,o),l}function c(t,i){function n(i){if(!e||!s)return!1;var n=rE(e);return!n[wS]&&!n[uv]&&(a&&e[FS](r),e[gv](t,i),!0)}d(i=i||l(),n,"processTelemetry",(function(){return{item:t}}),!t.sync)||i[yS](t)}function h(t,i){function n(){var n=!1;if(e){var r=rE(e),s=e[cv]||r[cv];!e||s&&s!==t.core()||r[wS]||(r[cv]=null,r[wS]=!0,r[pS]=!1,e[wS]&&!0===e[wS](t,i)&&(n=!0))}return n}d(t,n,"unload",(function(){}),i[DS])||t[yS](i)}function u(t,i){function n(){var n=!1;if(e){var r=rE(e),s=e[cv]||r[cv];!e||s&&s!==t.core()||r[wS]||e[NS]&&!0===e[NS](t,i)&&(n=!0)}return n}d(t,n,"update",(function(){}),!1)||t[yS](i)}return vy(o)}(e,t,i);r||(r=o),a&&a._setNext(o),a=o}}))}return n&&!r?mE([n],t,i):r}var fE=function(){return function(e,t,i,n){var r=uE(e,t,i,n);Ay(this,r,my(r))}}(),SE=500,vE="Channel has invalid priority - ";function yE(e,t,i){t&&ry(t)&&t[SS]>0&&(cy(t=t.sort((function(e,t){return e[mv]-t[mv]})),(function(e){e[mv]<SE&&Py(vE+e[hS])})),e[uS]({queue:vy(t),chain:mE(t,i[gS],i)}))}function CE(){var e=[];return{add:function(t){t&&e[uS](t)},run:function(t,i){cy(e,(function(e){try{e(t,i)}catch(e){bC(t[xS](),2,73,"Unexpected error calling unload handler - "+dC(e))}})),e=[]}}}var TE="getPlugin",EE=function(){function e(){var t,i,n,r,s,a=this;function o(e){void 0===e&&(e=null);var t=e;if(!t){var r=i||uE(null,{},a[cv]);t=n&&n[TE]?r[US](null,n[TE]):r[US](null,n)}return t}function l(e,t,r){e&&Ty(e,pv,[],null,Kv),!r&&t&&(r=t[CS]()[LS]());var s=n;n&&n[TE]&&(s=n[TE]()),a[cv]=t,i=uE(r,e,t,s)}function d(){t=!1,a[cv]=null,i=null,n=null,s=[],r=CE()}d(),oS(e,a,(function(e){e[lS]=function(e,i,n,r){l(e,i,r),t=!0},e[wS]=function(t,i){var a,o=e[cv];if(o&&(!t||o===t[cv]())){var l,c=!1,h=t||pE(null,o,n&&n[TE]?n[TE]():n),u=i||((a={reason:0})[DS]=!1,a);return e[kS]&&!0===e[kS](h,u,p)?l=!0:p(),l}function p(){if(!c){c=!0,r.run(h,i);var e=s;s=[],cy(e,(function(e){e.rm()})),!0===l&&h[yS](u),d()}}},e[NS]=function(t,i){var r=e[cv];if(r&&(!t||r===t[cv]())){var s,a=!1,o=t||gE(null,r,n&&n[TE]?n[TE]():n),d=i||{reason:0};return e._doUpdate&&!0===e._doUpdate(o,d,c)?s=!0:c(),s}function c(){a||(a=!0,l(o.getCfg(),o.core(),o[LS]()))}},e._addHook=function(e){e&&(ry(e)?s=s.concat(e):s[uS](e))},Iy(e,"_addUnloadCb",(function(){return r}),"add")})),a[xS]=function(e){return o(e)[xS]()},a[pS]=function(){return t},a.setInitialized=function(e){t=e},a[FS]=function(e){n=e},a[yS]=function(e,t){t?t[yS](e):n&&Xv(n[gv])&&n[gv](e,null)},a._getTelCtx=o}return e.__ieDyn=1,e}(),_E=function(e){function t(){var i,n,r=e.call(this)||this;function s(){i=0,n=[]}return r.identifier="TelemetryInitializerPlugin",r.priority=199,s(),oS(t,r,(function(e,t){e.addTelemetryInitializer=function(e){var t={id:i++,fn:e};return n[uS](t),{remove:function(){cy(n,(function(e,i){if(e.id===t.id)return n[RS](i,1),-1}))}}},e[gv]=function(t,i){for(var r=!1,s=n[SS],a=0;a<s;++a){var o=n[a];if(o)try{if(!1===o.fn[zS](null,[t])){r=!0;break}}catch(e){bC(i[xS](),1,64,"One of telemetry initializers failed, telemetry item will not be sent: "+Cy(e),{exception:dC(e)},!0)}}r||e[yS](t,i)},e[kS]=function(){s()}})),r}return If(t,e),t.__ieDyn=1,t}(EE),bE="Plugins must provide initialize method",PE="_notificationManager",IE="SDK is still unloading...",AE={loggingLevelConsole:1};function RE(e,t){return new MC(t)}function wE(e,t){var i=!1;return cy(t,(function(t){if(t===e)return i=!0,-1})),i}var ME=function(){function e(){var t,i,n,r,s,a,o,l,d,c,h,u,p,g,m,f,S,v,y,C,T=0;oS(e,this,(function(e){function E(){i=!1,t=wy(!0,{},AE),e[gS]=t,e[fS]=new EC(t),e[AS]=[],m=new _E,n=[],r=null,s=null,a=null,o=null,l=null,c=null,d=[],h=null,u=null,p=null,g=!1,f=null,S=zC("AIBaseCore",!0),v=CE(),C=null}function _(){return uE(I(),t,e)}function b(i){var n=function(e,t,i){var n,r=[],s={};return cy(i,(function(i){(Kv(i)||Kv(i[lS]))&&Py(bE);var n=i[mv],a=i[hS];i&&n&&(Kv(s[n])?s[n]=a:PC(e,"Two extensions have same priority #"+n+" - "+s[n]+", "+a)),(!n||n<t)&&r[uS](i)})),(n={all:i})[cv]=r,n}(e[fS],SE,d);c=n[cv],l=null;var r=n.all;if(p=vy(function(e,t,i){var n=[];if(e&&cy(e,(function(e){return yE(n,e,i)})),t){var r=[];cy(t,(function(e){e[mv]>SE&&r[uS](e)})),yE(n,r,i)}return n}(u,r,e)),h){var s=hy(r,h);-1!==s&&r[RS](s,1),-1!==(s=hy(c,h))&&c[RS](s,1),h._setQueue(p)}else h=function(e,t){function i(){return uE(null,t[gS],t,null)}function n(e,t,i,n){var r=e?e[SS]+1:1;function s(){0==--r&&(n&&n(),n=null)}r>0&&cy(e,(function(e){if(e&&e.queue[SS]>0){var n=e.chain,a=t[US](n);a[bS](s),i(a)}else r--})),s()}var r=!1;return{identifier:"ChannelControllerPlugin",priority:SE,initialize:function(t,i,n,s){r=!0,cy(e,(function(e){e&&e.queue[SS]>0&&sE(uE(e.chain,t,i),n)}))},isInitialized:function(){return r},processTelemetry:function(t,r){n(e,r||i(),(function(e){e[yS](t)}),(function(){r[yS](t)}))},update:function(t,i){var r=i||{reason:0};return n(e,t,(function(e){e[yS](r)}),(function(){t[yS](r)})),!0},pause:function(){n(e,i(),(function(e){e.iterate((function(e){e.pause&&e.pause()}))}),null)},resume:function(){n(e,i(),(function(e){e.iterate((function(e){e.resume&&e.resume()}))}),null)},teardown:function(t,i){var s=i||{reason:0,isAsync:!1};return n(e,t,(function(e){e[yS](s)}),(function(){t[yS](s),r=!1})),!0},getChannel:function(t){var i=null;return e&&e[SS]>0&&cy(e,(function(e){if(e&&e.queue[SS]>0&&(cy(e.queue,(function(e){if(e[hS]===t)return i=e,-1})),i))return-1})),i},flush:function(t,r,s,a){var o=1,l=!1,d=null;function c(){o--,l&&0===o&&(d&&(clearTimeout(d),d=null),r&&r(l),r=null)}return a=a||5e3,n(e,i(),(function(e){e.iterate((function(e){if(e[IS]){o++;var i=!1;e[IS](t,(function(){i=!0,c()}),s)||i||(t&&null==d?d=setTimeout((function(){d=null,c()}),a):c())}}))}),(function(){l=!0,c()})),!0},_setQueue:function(t){e=t}}}(p,e);r[uS](h),c[uS](h),e[AS]=aE(r),h[lS](t,e,r),sE(_(),r),e[AS]=vy(aE(c||[])).slice(),i&&function(t){var i=gE(I(),e);e._updateHook&&!0===e._updateHook(i,t)||i[yS](t)}(i)}function P(t){var i,n=null,r=null;return cy(e[AS],(function(e){if(e[hS]===t&&e!==h&&e!==m)return r=e,-1})),!r&&h&&(r=h.getChannel(t)),r&&((i={plugin:r})[GS]=function(e){rE(r)[uv]=!e},i.isEnabled=function(){var e=rE(r);return!e[wS]&&!e[uv]},i.remove=function(e,t){var i;void 0===e&&(e=!0);var n=[r],s=((i={reason:1})[DS]=e,i);A(n,s,(function(e){e&&b({reason:32,removed:n}),t&&t(e)}))},n=i),n}function I(){if(!l){var i=(c||[]).slice();-1===hy(i,m)&&i[uS](m),l=mE(aE(i),t,e)}return l}function A(i,n,r){if(i&&i[SS]>0){var s=pE(mE(i,t,e),e);s[bS]((function(){var e=!1,t=[];cy(d,(function(n,r){wE(n,i)?e=!0:t[uS](n)})),d=t;var n=[];u&&(cy(u,(function(t,r){var s=[];cy(t,(function(t){wE(t,i)?e=!0:s[uS](t)})),n[uS](s)})),u=n),r&&r(e)})),s[yS](n)}else r(!1)}function R(){var i=e[fS]?e[fS].queue:[];i&&(cy(i,(function(i){var n,r=((n={})[dS]=f||"InternalMessageId: "+i[MS],n.iKey=_y(t[mS]),n.time=dy(new Date),n.baseType=CC.dataType,n.baseData={message:i[OS]},n);e.track(r)})),i[SS]=0)}function w(e,t,i,n){return h?h[IS](e,t,i||6,n):(t&&t(!1),!0)}function M(t){var i=e[fS];i?bC(i,2,73,t):Py(t)}E(),e[pS]=function(){return i},e[lS]=function(n,s,o,l){var c,h;g&&Py(IE),e[pS]()&&Py("Core should not be initialized more than once"),t=n||{},e[gS]=t,Kv(n[mS])&&Py("Please provide instrumentation key"),r=l,e[PE]=l,!0===(h=_y(t.disableDbgExt))&&y&&(r[ES](y),y=null),r&&!y&&!0!==h&&(y=function(e){if(!pC){pC={};for(var t=0;t<gC[SS];t++)pC[gC[t]]=fC(gC[t],e)}return pC}(t),r[TS](y)),!(c=_y(t.enablePerfMgr))&&a&&(a=null),c&&Ey(t,hv,RE),Ey(t,pv,{}).NotificationManager=r,o&&(e[fS]=o);var m=Ey(t,"extensions",[]);(d=[])[uS].apply(d,Af(Af([],s),m)),u=Ey(t,dv,[]),b(null),p&&0!==p[SS]||Py("No "+dv+" available"),i=!0,e.releaseQueue()},e.getTransmissionControls=function(){var e=[];return p&&cy(p,(function(t){e[uS](t.queue)})),vy(e)},e.track=function(i){i.iKey=i.iKey||t[mS],i[vS]=i[vS]||dy(new Date),i.ver=i.ver||"4.0",!g&&e[pS]()?_()[yS](i):n[uS](i)},e[CS]=_,e[cS]=function(){var t;return r||(r=Ef(((t={})[TS]=function(e){},t[ES]=function(e){},t[fv]=function(e){},t[Sv]=function(e,t){},t[vv]=function(e,t){},t)),e[PE]=r),r},e[TS]=function(e){r&&r[TS](e)},e[ES]=function(e){r&&r[ES](e)},e.getCookieMgr=function(){return o||(o=uT(t,e[fS])),o},e.setCookieMgr=function(e){o=e},e[Ev]=function(){if(!s&&!a&&_y(t.enablePerfMgr)){var i=_y(t[hv]);Xv(i)&&(a=i(e,e[cS]()))}return s||a||null},e.setPerfMgr=function(e){s=e},e.eventCnt=function(){return n[SS]},e.releaseQueue=function(){if(i&&n[SS]>0){var e=n;n=[],cy(e,(function(e){_()[yS](e)}))}},e.pollInternalLogs=function(e){f=e||null;var i=_y(t.diagnosticLogInterval);return i&&i>0||(i=1e4),T&&clearInterval(T),T=setInterval((function(){R()}),i)},e[_S]=function(){T&&(clearInterval(T),T=0,R())},Ay(e,(function(){return m}),["addTelemetryInitializer"]),e.unload=function(t,n,r){var s;void 0===t&&(t=!0),i||Py("SDK is not initialized"),g&&Py(IE);var a=((s={reason:50})[DS]=t,s.flushComplete=!1,s),o=pE(I(),e);function l(t){a.flushComplete=t,g=!0,v.run(o,a),e[_S](),o[yS](a)}o[bS]((function(){E(),n&&n(a)}),e),w(t,l,6,r)||l(!1)},e[PS]=P,e.addPlugin=function(e,t,i,n){if(!e)return n&&n(!1),void M(bE);var r=P(e[hS]);if(r&&!t)return n&&n(!1),void M("Plugin ["+e[hS]+"] is already loaded!");var s={reason:16};function a(t){d[uS](e),s.added=[e],b(s),n&&n(!0)}if(r){var o=[r.plugin];A(o,{reason:2,isAsync:!!i},(function(e){e?(s.removed=o,s.reason|=32,a()):n&&n(!1)}))}else a()},e.evtNamespace=function(){return S},e[IS]=w,e.getTraceCtx=function(e){var t,i;return C||(i={},C={getName:function(){return i[dS]},setName:function(e){t&&t.setName(e),i[dS]=e},getTraceId:function(){return i[sv]},setTraceId:function(e){t&&t.setTraceId(e),tE(e)&&(i[sv]=e)},getSpanId:function(){return i[av]},setSpanId:function(e){t&&t.setSpanId(e),iE(e)&&(i[av]=e)},getTraceFlags:function(){return i[ov]},setTraceFlags:function(e){t&&t.setTraceFlags(e),i[ov]=e}}),C},e.setTraceCtx=function(e){C=e||null},Iy(e,"addUnloadCb",(function(){return v}),"add")}))}return e.__ieDyn=1,e}();function OE(e,t,i,n){cy(e,(function(e){if(e&&e[t])if(i)setTimeout((function(){return n(e)}),0);else try{n(e)}catch(e){}}))}var DE,kE,NE=function(){function e(t){this.listeners=[];var i=!!(t||{}).perfEvtsSendAll;oS(e,this,(function(e){e[TS]=function(t){e.listeners[uS](t)},e[ES]=function(t){for(var i=hy(e[ev],t);i>-1;)e.listeners[RS](i,1),i=hy(e[ev],t)},e[fv]=function(t){OE(e[ev],fv,!0,(function(e){e[fv](t)}))},e[Sv]=function(t,i){OE(e[ev],Sv,!0,(function(e){e[Sv](t,i)}))},e[vv]=function(t,i){OE(e[ev],vv,i,(function(e){e[vv](t,i)}))},e[yv]=function(t){t&&(!i&&t[tv]()||OE(e[ev],yv,!1,(function(e){t[DS]?setTimeout((function(){return e[yv](t)}),0):e[yv](t)})))}}))}return e.__ieDyn=1,e}(),LE=function(e){function t(){var i=e.call(this)||this;return oS(t,i,(function(e,t){function i(t){var i=e[cS]();i&&i[Sv]([t],2)}e[lS]=function(e,i,n,r){t[lS](e,i,n||new EC(e),r||new NE(e))},e.track=function(n){DC(e[Ev](),(function(){return"AppInsightsCore:track"}),(function(){null===n&&(i(n),Py("Invalid telemetry item")),function(e){Kv(e[dS])&&(i(e),Py("telemetry name required"))}(n),t.track(n)}),(function(){return{item:n}}),!n.sync)}})),i}return If(t,e),t.__ieDyn=1,t}(ME),xE="Failed",FE=xE+"MonitorAjax",UE="Track",VE="Start",HE="Stop",BE="Event",$E="AuthContext",jE="Exception",GE="Local",WE="Session",qE="Storage",zE="Browser",KE="Cannot",JE="Buffer",YE="InstrumentationKey",QE=(My({CRITICAL:1,WARNING:2}),My(((DE={})[zE+"DoesNotSupport"+GE+qE]=0,DE[zE+KE+"Read"+GE+qE]=1,DE[zE+KE+"Read"+WE+qE]=2,DE[zE+KE+"Write"+GE+qE]=3,DE[zE+KE+"Write"+WE+qE]=4,DE[zE+xE+"RemovalFrom"+GE+qE]=5,DE[zE+xE+"RemovalFrom"+WE+qE]=6,DE[KE+"SendEmptyTelemetry"]=7,DE.ClientPerformanceMathError=8,DE["ErrorParsingAI"+WE+"Cookie"]=9,DE.ErrorPVCalc=10,DE[jE+"WhileLoggingError"]=11,DE[xE+"AddingTelemetryTo"+JE]=12,DE[FE+"Abort"]=13,DE[FE+"Dur"]=14,DE[FE+"Open"]=15,DE[FE+"RSC"]=16,DE[FE+"Send"]=17,DE[FE+"GetCorrelationHeader"]=18,DE[xE+"ToAddHandlerForOnBeforeUnload"]=19,DE[xE+"ToSendQueuedTelemetry"]=20,DE[xE+"ToReportDataLoss"]=21,DE["Flush"+xE]=22,DE.MessageLimitPerPVExceeded=23,DE.MissingRequiredFieldSpecification=24,DE.NavigationTimingNotSupported=25,DE.OnError=26,DE[WE+"RenewalDateIsZero"]=27,DE.SenderNotInitialized=28,DE[VE+UE+BE+xE]=29,DE[HE+UE+BE+xE]=30,DE[VE+UE+xE]=31,DE[HE+UE+xE]=32,DE.TelemetrySampledAndNotSent=33,DE[UE+BE+xE]=34,DE[UE+jE+xE]=35,DE[UE+"Metric"+xE]=36,DE[UE+"PV"+xE]=37,DE[UE+"PV"+xE+"Calc"]=38,DE[UE+"Trace"+xE]=39,DE["Transmission"+xE]=40,DE[xE+"ToSet"+qE+JE]=41,DE[xE+"ToRestore"+qE+JE]=42,DE.InvalidBackendResponse=43,DE[xE+"ToFixDepricatedValues"]=44,DE.InvalidDurationValue=45,DE.TelemetryEnvelopeInvalid=46,DE.CreateEnvelopeError=47,DE[KE+"SerializeObject"]=48,DE[KE+"SerializeObjectNonSerializable"]=49,DE.CircularReferenceDetected=50,DE["Clear"+$E+xE]=51,DE[jE+"Truncated"]=52,DE.IllegalCharsInName=53,DE.ItemNotInArray=54,DE.MaxAjaxPerPVExceeded=55,DE.MessageTruncated=56,DE.NameTooLong=57,DE.SampleRateOutOfRange=58,DE["Set"+$E+xE]=59,DE["Set"+$E+xE+"AccountName"]=60,DE.StringValueTooLong=61,DE.StartCalledMoreThanOnce=62,DE.StopCalledWithoutStart=63,DE["TelemetryInitializer"+xE]=64,DE.TrackArgumentsNotSpecified=65,DE.UrlTooLong=66,DE[WE+qE+JE+"Full"]=67,DE[KE+"AccessCookie"]=68,DE.IdTooLong=69,DE.InvalidEvent=70,DE[FE+"SetRequestHeader"]=71,DE["Send"+zE+"InfoOnUserInit"]=72,DE["Plugin"+jE]=73,DE["Notification"+jE]=74,DE.SnippetScriptLoadFailure=99,DE["Invalid"+YE]=100,DE[KE+"ParseAiBlobValue"]=101,DE.InvalidContentBlob=102,DE[UE+"PageAction"+BE+xE]=103,DE[xE+"AddingCustomDefinedRequestContext"]=104,DE["InMemory"+qE+JE+"Full"]=105,DE[YE+"Deprecation"]=106,DE))),XE=(My({NotSet:0,Pii_DistinguishedName:1,Pii_GenericData:2,Pii_IPV4Address:3,Pii_IPv6Address:4,Pii_MailSubject:5,Pii_PhoneNumber:6,Pii_QueryString:7,Pii_SipAddress:8,Pii_SmtpAddress:9,Pii_Identity:10,Pii_Uri:11,Pii_Fqdn:12,Pii_IPV4AddressLegacy:13,CustomerContent_GenericContent:32}),My({Normal:1,CostDeferred:2,RealTime:3,Immediate:4})),ZE=(My({Unspecified:0,String:1,Int32:2,UInt32:3,Int64:4,UInt64:5,Double:6,Bool:7,Guid:8,DateTime:9}),My({Normal:1,Critical:2})),e_=(My({NONE:0,ERROR:1,WARNING:2,INFORMATION:3}),vy(bf(bf({},QE),My({AuthHandShakeError:501,AuthRedirectFail:502,BrowserCannotReadLocalStorage:503,BrowserCannotWriteLocalStorage:504,BrowserDoesNotSupportLocalStorage:505,CannotParseBiBlobValue:506,CannotParseDataAttribute:507,CVPluginNotAvailable:508,DroppedEvent:509,ErrorParsingAISessionCookie:510,ErrorProvidedChannels:511,FailedToGetCookies:512,FailedToInitializeCorrelationVector:513,FailedToInitializeSDK:514,InvalidContentBlob:515,InvalidCorrelationValue:516,SessionRenewalDateIsZero:517,SendPostOnCompleteFailure:518,PostResponseHandler:519,SDKNotInitialized:520}))),""),t_="version",i_="properties",n_="1DS-Web-JS-3.2.9",r_="withCredentials",s_=((kE={})[0]=0,kE[2]=6,kE[1]=1,kE[3]=7,kE[4098]=6,kE[4097]=1,kE[4099]=7,kE);function a_(e){return!(e===e_||Kv(e))}function o_(e){if(e){var t=e.indexOf("-");if(t>-1)return e.substring(0,t)}return e_}function l_(e,t,i){var n=-1;if(!zv(e))if(t>0&&(32===t?n=8192:t<=13&&(n=t<<5)),function(e){return e>=0&&e<=9}(i))-1===n&&(n=0),n|=i;else{var r=s_[g_(e)]||-1;-1!==n&&-1!==r?n|=r:6===r&&(n=r)}return n}function d_(e,t,i){var n;return void 0===i&&(i=!0),e&&(n=e.get(t),i&&n&&decodeURIComponent&&(n=decodeURIComponent(n))),n||e_}function c_(e){void 0===e&&(e="D");var t=YT();return"B"===e?t="{"+t+"}":"P"===e?t="("+t+")":"N"===e&&(t=t.replace(/-/g,e_)),t}function h_(e,t,i,n,r){var s={},a=!1,o=0,l=arguments.length,d=arguments;for("[object Boolean]"===Object[hf].toString.call(d[0])&&(a=d[0],o++);o<l;o++)ey(d[o],(function(e,t){a&&t&&Qv(t)?ry(t)?(s[e]=s[e]||[],cy(t,(function(t,i){t&&Qv(t)?s[e][i]=h_(!0,s[e][i],t):s[e][i]=t}))):s[e]=h_(!0,s[e],t):s[e]=t}));return s}Boolean(tC()),Boolean(Zy());var u_=function(){var e=Qy(Uy);return e&&e.now?e.now():yy()};function p_(e,t){var i=e;i.timings=i.timings||{},i.timings.processTelemetryStart=i.timings.processTelemetryStart||{},i.timings.processTelemetryStart[t]=u_()}function g_(e){var t=0;if(null!=e){var i=typeof e;"string"===i?t=1:"number"===i?t=2:"boolean"===i?t=3:i===df&&(t=4,ry(e)?(t=4096,e.length>0&&(t|=g_(e[0]))):vf.call(e,"value")&&(t=8192|g_(e.value)))}return t}var m_=function(e){function t(){var i=e.call(this)||this;return i.pluginVersionStringArr=[],oS(t,i,(function(e,t){e.logger&&e.logger.queue||(e.logger=new EC({loggingLevelConsole:1})),e.initialize=function(i,n,r,s){DC(e,(function(){return"AppInsightsCore.initialize"}),(function(){var a=e.pluginVersionStringArr;if(i){i.endpointUrl||(i.endpointUrl="https://browser.events.data.microsoft.com/OneCollector/1.0/");var o=i.propertyStorageOverride;!o||o.getProperty&&o.setProperty||Py("Invalid property storage override passed."),i.channels&&cy(i.channels,(function(e){e&&cy(e,(function(e){if(e.identifier&&e.version){var t=e.identifier+"="+e.version;a.push(t)}}))}))}e.getWParam=function(){return"undefined"!=typeof document||i.enableWParam?0:-1},n&&cy(n,(function(e){if(e&&e.identifier&&e.version){var t=e.identifier+"="+e.version;a.push(t)}})),e.pluginVersionString=a.join(";"),e.pluginVersionStringArr=a;try{t.initialize(i,n,r,s),e.pollInternalLogs("InternalLog")}catch(t){var l=e.logger,d=dC(t);-1!==d.indexOf("channels")&&(d+="\n - Channels must be provided through config.channels only!"),bC(l,1,514,"SDK Initialization Failed - no telemetry will be sent: "+d)}}),(function(){return{config:i,extensions:n,logger:r,notificationManager:s}}))},e.track=function(i){DC(e,(function(){return"AppInsightsCore.track"}),(function(){var n,r=i;if(r){r.timings=r.timings||{},r.timings.trackStart=u_(),(n=r.latency)&&ay(n)&&n>=1&&n<=4||(r.latency=1);var s=r.ext=r.ext||{};s.sdk=s.sdk||{},s.sdk.ver=n_;var a=r.baseData=r.baseData||{};a[i_]=a[i_]||{};var o=a[i_];o[t_]=o[t_]||e.pluginVersionString||e_}t.track(r)}),(function(){return{item:i}}),!i.sync)}})),i}return If(t,e),t.__ieDyn=1,t}(LE),f_=Xv;function S_(e,t,i){return function(n){e[t]=n,i()}}var v_=function(){function e(t){var i=0,n=null,r=[];function s(){if(r.length>0){var e=r.slice();r=[],setTimeout((function(){for(var t=0,i=e.length;t<i;++t)try{e[t]()}catch(e){}}),0)}}function a(e){0===i&&(n=e,i=1,s())}function o(e){0===i&&(n=e,i=2,s())}oS(e,this,(function(t){t.then=function(t,a){return new e((function(o,l){!function(t,a,o,l){r.push((function(){var r;try{(r=1===i?f_(t)?t(n):n:f_(a)?a(n):n)instanceof e?r.then(o,l):2!==i||f_(a)?o(r):l(r)}catch(e){return void l(e)}})),0!==i&&s()}(t,a,o,l)}))},t.catch=function(e){return t.then(null,e)}})),function(){if(!f_(t))throw new TypeError("ESPromise: resolvedFunc argument is not a Function");try{t(a,o)}catch(e){o(e)}}()}return e.resolve=function(t){return t instanceof e?t:t&&f_(t.then)?new e((function(e,i){try{t.then(e,i)}catch(e){i(e)}})):new e((function(e){e(t)}))},e.reject=function(t){return new e((function(e,i){i(t)}))},e.all=function(t){if(t&&t.length)return new e((function(e,i){try{for(var n=[],r=0,s=0;s<t.length;s++){var a=t[s];a&&f_(a.then)?(r++,a.then(S_(n,s,(function(){0==--r&&e(n)})),i)):n[s]=a}0===r&&setTimeout((function(){e(n)}),0)}catch(e){i(e)}}))},e.race=function(t){return new e((function(e,i){if(t&&t.length)try{for(var n=function(n){var r=t[n];r&&f_(r.then)?r.then(e,i):setTimeout((function(){e(r)}),0)},r=0;r<t.length;r++)n(r)}catch(e){i(e)}}))},e}(),y_=0,C_=[],T_=[],E_=[];function __(){return(new Date).getTime()}var b_,P_=function(){function e(t,i){var n=0,r=(t||"<unnamed>")+"."+y_;function s(e){var t=Cf();t&&t.QUnit&&console&&console.log("ESPromiseScheduler["+r+"] "+e)}function a(e){PC(i,"ESPromiseScheduler["+r+"] "+e)}y_++,oS(e,this,(function(e){var t=null,i=0;function o(e,t){for(var i=0;i<e.length;i++)if(e[i].id===t)return e.splice(i,1)[0];return null}e.scheduleEvent=function(e,l,d){var c=r+"."+i;i++,l&&(c+="-("+l+")");var h=c+"{"+n+"}";n++;var u,p,g,m={evt:null,tm:__(),id:h,isRunning:!1,isAborted:!1};return m.evt=t?(u=m,p=t,g=new v_((function(e,t){var i=__()-p.tm,n=p.id;s("["+c+"] is waiting for ["+n+":"+i+" ms] to complete before starting -- ["+T_.length+"] waiting and ["+C_.length+"] running"),u.abort=function(e){u.abort=null,o(T_,c),u.isAborted=!0,t(new Error(e))},p.evt.then((function(i){o(T_,c),T(u).then(e,t)}),(function(i){o(T_,c),T(u).then(e,t)}))})),T_.push(u),g):T(m),(t=m).evt._schId=h,m.evt;function f(e){for(var t=__(),i=t-6e5,n=e.length,r=0;r<n;){var s=e[r];if(s&&s.tm<i){var o=null;s.abort?(o="Aborting ["+s.id+"] due to Excessive runtime ("+(t-s.tm)+" ms)",s.abort(o)):o="Removing ["+s.id+"] due to Excessive runtime ("+(t-s.tm)+" ms)",a(o),e.splice(r,1),n--}else r++}}function S(e,i){var n=!1,r=o(C_,e);if(r||(r=o(E_,e),n=!0),r){r.to&&(clearTimeout(r.to),r.to=null);var l=__()-r.tm;i?n?a("Timed out event ["+e+"] finally complete -- "+l+" ms"):s("Promise ["+e+"] Complete -- "+l+" ms"):(E_.push(r),a("Event ["+e+"] Timed out and removed -- "+l+" ms"))}else s("Failed to remove ["+e+"] from running queue");t&&t.id===e&&(t=null),f(C_),f(T_),f(E_)}function v(e,t){return function(i){return S(e,!0),t&&t(i),i}}function y(e,t,i,n){t.then((function(t){return t instanceof v_?(s("Event ["+e+"] returned a promise -- waiting"),y(e,t,i,n),t):v(e,i)(t)}),v(e,n))}function C(e,t){var i=e.id;return new v_((function(n,r){s("Event ["+i+"] Starting -- waited for "+(e.wTm||"--")+" ms"),e.isRunning=!0,e.abort=function(t){e.abort=null,e.isAborted=!0,S(i,!1),r(new Error(t))};var a=t(i);a instanceof v_?(d&&(e.to=setTimeout((function(){S(i,!1),r(new Error("Timed out after ["+d+"] ms"))}),d)),y(i,a,(function(t){s("Event ["+i+"] Resolving after "+(__()-e.tm)+" ms"),n(t)}),r)):(s("Promise ["+i+"] Auto completed as the start action did not return a promise"),n())}))}function T(t){var i=__();return t.wTm=i-t.tm,t.tm=i,t.isAborted?v_.reject(new Error("["+c+"] was aborted")):(C_.push(t),C(t,e))}}}))}return e.incomplete=function(){return C_},e.waitingToStart=function(){return T_},e}(),I_="locale",A_="ver",R_="name",w_=Oy({UserExt:[0,"user"],DeviceExt:[1,"device"],TraceExt:[2,"trace"],WebExt:[3,"web"],AppExt:[4,"app"],OSExt:[5,"os"],SdkExt:[6,"sdk"],IntWebExt:[7,"intweb"],UtcExt:[8,"utc"],LocExt:[9,"loc"],CloudExt:[10,"cloud"],DtExt:[11,"dt"]}),M_=Oy({id:[0,"id"],ver:[1,A_],appName:[2,R_],locale:[3,I_],expId:[4,"expId"],env:[5,"env"]}),O_=Oy({domain:[0,"domain"],browser:[1,"browser"],browserVer:[2,"browserVer"],screenRes:[3,"screenRes"],userConsent:[4,"userConsent"],consentDetails:[5,"consentDetails"]}),D_=Oy({locale:[0,I_],localId:[1,"localId"],id:[2,"id"]}),k_=Oy({osName:[0,R_],ver:[1,A_]}),N_=Oy({ver:[0,A_],seq:[1,"seq"],installId:[2,"installId"],epoch:[3,"epoch"]}),L_=Oy({msfpc:[0,"msfpc"],anid:[1,"anid"],serviceName:[2,"serviceName"]}),x_=Oy({popSample:[0,"popSample"],eventFlags:[1,"eventFlags"]}),F_=Oy({tz:[0,"tz"]}),U_=Oy({sessionId:[0,"sesId"]}),V_=Oy({localId:[0,"localId"],deviceClass:[1,"deviceClass"],make:[2,"make"],model:[3,"model"]}),H_=Oy({role:[0,"role"],roleInstance:[1,"roleInstance"],roleVer:[2,"roleVer"]}),B_=Oy({traceId:[0,"traceID"],traceName:[1,R_],parentId:[2,"parentID"]}),$_=Oy({traceId:[0,"traceId"],spanId:[1,"spanId"],traceFlags:[2,"traceFlags"]});function j_(){return void 0===b_&&(b_=!!W_(0)),b_}function G_(){return j_()?W_(0):null}function W_(e){var t,i,n=null;try{var r=Cf();if(!r)return null;i=new Date,(n=0===e?r.localStorage:r.sessionStorage)&&Xv(n.setItem)&&(n.setItem(i,i),t=n.getItem(i)!==i,n.removeItem(i),t&&(n=null))}catch(e){n=null}return n}function q_(){return this.getId()}function z_(e){this.setId(e)}var K_=function(){function e(){oS(e,this,(function(e){e.setId=function(t){e.customId=t},e.getId=function(){return sy(e.customId)?e.customId:e.automaticId}}))}return e._staticInit=void fy(e.prototype,"id",q_,z_),e}(),J_="ai_session",Y_=function(){function e(t,i){var n,r,s=TC(t),a=hT(t);oS(e,this,(function(t){var o,l={sessionRenewalMs:(o=i).sessionRenewalMs&&function(){return o.sessionRenewalMs},sessionExpirationMs:o.sessionExpirationMs&&function(){return o.sessionExpirationMs},cookieDomain:o.cookieDomain&&function(){return o.cookieDomain},namePrefix:o.namePrefix&&function(){return o.namePrefix},sessionAsGuid:function(){return o.sessionAsGuid},idLength:function(){return o.idLength?o.idLength:22}};function d(e){var i=t.automaticSession,n=e.split("|");n.length>0&&i.setId(n[0]);try{if(n.length>1){var r=+n[1];i.acquisitionDate=+new Date(r),i.acquisitionDate=i.acquisitionDate>0?i.acquisitionDate:0}if(n.length>2){var a=+n[2];i.renewalDate=+new Date(a),i.renewalDate=i.renewalDate>0?i.renewalDate:0}}catch(e){bC(s,1,510,"Error parsing ai_session cookie, session will be reset: "+e)}0===i.renewalDate&&bC(s,2,517,"AI session renewal date is 0, session will be reset.")}function c(){var e=t.automaticSession,i=(new Date).getTime(),n=t.config.sessionAsGuid();!zv(n)&&n?oy(n)?e.setId(c_()):e.setId(c_(n)):e.setId(HC(l&&l.idLength?l.idLength():22)),e.acquisitionDate=i,e.renewalDate=i,h(e.getId(),e.acquisitionDate,e.renewalDate),j_()||bC(s,2,505,"Browser does not support local storage. Session durations will be inaccurate.")}function h(e,i,s){var o=i+t.config.sessionExpirationMs(),l=s+t.config.sessionRenewalMs(),d=new Date,c=[e,i,s];o<l?d.setTime(o):d.setTime(l);var h=t.config.cookieDomain?t.config.cookieDomain():null;a.set(r(),c.join("|")+";expires="+d.toUTCString(),null,h),n=(new Date).getTime()}Xv(i.sessionExpirationMs)||(l.sessionExpirationMs=function(){return e.acquisitionSpan}),Xv(i.sessionRenewalMs)||(l.sessionRenewalMs=function(){return e.renewalSpan}),t.config=l,r=function(){return t.config.namePrefix&&t.config.namePrefix()?J_+t.config.namePrefix():J_},t.automaticSession=new K_,t.update=function(){t.automaticSession.getId()||function(){var e=a.get(r());if(e&&Xv(e.split))d(e);else{var i=function(e,t){var i=G_();if(null!==i)try{return i.getItem(t)}catch(t){b_=!1,bC(e,1,503,"Browser failed read of local storage. "+t)}return null}(s,r());i&&d(i)}t.automaticSession.getId()||c()}();var i=t.automaticSession,o=t.config,l=(new Date).getTime(),u=l-i.acquisitionDate>o.sessionExpirationMs(),p=l-i.renewalDate>o.sessionRenewalMs();u||p?c():(!n||l-n>e.cookieUpdateInterval)&&(i.renewalDate=l,h(i.getId(),i.acquisitionDate,i.renewalDate))},t.backup=function(){var e,i,n,a=t.automaticSession;e=a.getId(),i=a.acquisitionDate,n=a.renewalDate,function(e,t,i){var n=G_();if(null!==n)try{return n.setItem(t,i),!0}catch(t){b_=!1,bC(e,1,504,"Browser failed write to local storage. "+t)}}(s,r(),[e,i,n].join("|"))}}))}return e.acquisitionSpan=864e5,e.renewalSpan=18e5,e.cookieUpdateInterval=6e4,e}(),Q_=["AX","EX","SF","CS","CF","CT","CU","DC","DF","H5","HL","WS","WP"];function X_(e,t){void 0===t&&(t=Q_);var i=null;if(e)for(var n=e.split(","),r=0;r<n.length;r++)Z_(n[r],t)&&(i?i+=","+n[r]:i=n[r]);return i}function Z_(e,t){if(void 0===t&&(t=Q_),!e||e.length<4)return!1;for(var i=!1,n=e.substring(0,3).toString().toUpperCase(),r=0;r<t.length;r++)if(t[r]+":"===n&&e.length<=256){i=!0;break}return i}function eb(){return this.getExpId()}var tb=function(){function e(t,i){var n=null,r=Q_.slice(0),s="Treatments",a=hT(i),o=t;oS(e,this,(function(e){if(eC()){var i=tC().documentElement;i&&(e.locale=i.lang)}function l(e){e!==n&&(n=X_(e,r))}e.env=t.env?t.env:function(e){var t,i={},n=tC();if(n){t=n&&n.querySelectorAll("meta");for(var r=0;r<t.length;r++){var s=t[r];s.name&&0===s.name.toLowerCase().indexOf(e)&&(i[s.name.replace(e,"")]=s.content)}}return i}("awa-").env,e.getExpId=function(){return o.expId?(l(o.expId),n):(l(d_(a,s)),n)}}))}return e.validateAppExpId=X_,e._staticInit=void fy(e.prototype,"expId",eb),e}(),ib=function(){return function(){}}(),nb=function(){return function(){}}();function rb(){return this.getMsfpc()}function sb(){return this.getAnid()}var ab=function(){function e(t,i){var n=hT(i);oS(e,this,(function(e){t.serviceName&&(e.serviceName=t.serviceName),e.getMsfpc=function(){return d_(n,"MSFPC")},e.getAnid=function(){return d_(n,"ANON").slice(0,34)}}))}var t;return e._staticInit=(fy(t=e.prototype,"msfpc",rb),void fy(t,"anid",sb)),e}(),ob=function(){return function(){var e=(new Date).getTimezoneOffset(),t=e%60,i=(e-t)/60,n="+";i>0&&(n="-"),i=Math.abs(i),t=Math.abs(t),this.tz=n+(i<10?"0"+i:i.toString())+":"+(t<10?"0"+t:t.toString())}}(),lb={WIN:/(windows|win32)/i,WINRT:/ arm;/i,WINPHONE:/windows\sphone\s\d+\.\d+/i,OSX:/(macintosh|mac os x)/i,IOS:/(ipad|iphone|ipod)(?=.*like mac os x)/i,LINUX:/(linux|joli|[kxln]?ubuntu|debian|[open]*suse|gentoo|arch|slackware|fedora|mandriva|centos|pclinuxos|redhat|zenwalk)/i,ANDROID:/android/i,CROS:/CrOS/i},db={5.1:"XP","6.0":"Vista",6.1:"7",6.2:"8",6.3:"8.1","10.0":"10"},cb="([\\d,.]+)",hb="([\\d,_,.]+)",ub="Unknown",pb=[{r:lb.WINPHONE,os:"Windows Phone"},{r:lb.WINRT,os:"Windows RT"},{r:lb.WIN,os:"Windows"},{r:lb.IOS,os:"iOS"},{r:lb.ANDROID,os:"Android"},{r:lb.LINUX,os:"Linux"},{r:lb.CROS,os:"Chrome OS"},{s:"x11",os:"Unix"},{s:"blackberry",os:"BlackBerry"},{s:"symbian",os:"Symbian"},{s:"nokia",os:"Nokia"},{r:lb.OSX,os:"Mac OS X"}];function gb(e,t){return"Windows"===t?mb(e,"Windows NT"):"Android"===t?mb(e,t):"Mac OS X"===t?function(e){var t=e.match(new RegExp("Mac OS X "+hb));if(t){var i=t[1].replace(/_/g,".");if(i){var n=fb(i);return n?i.split(n)[0]:i}}return ub}(e):"iOS"===t?function(e){var t=e.match(new RegExp("OS "+hb));if(t){var i=t[1].replace(/_/g,".");if(i){var n=fb(i);return n?i.split(n)[0]:i}}return ub}(e):ub}function mb(e,t){var i=e.match(new RegExp(t+" "+cb));return i?db[i[1]]?db[i[1]]:i[1]:ub}function fb(e){return e.indexOf(".")>-1?".":e.indexOf("_")>-1?"_":null}var Sb=function(){return function(e){if(e.populateOperatingSystemInfo){var t=this,i=nC()||{},n=e.userAgent||i.userAgent||"",r=e.userAgentData||i.userAgentData||{};if(n){var s=function(e){for(var t=0;t<pb.length;t++){var i=pb[t];if(i.r&&e.match(i.r))return i.os;if(i.s&&-1!==e.indexOf(i.s))return i.os}return ub}(n.toLowerCase());t.name=s,t.ver=gb(n,s)}t.name&&t.name!==ub||!sy(r.platform)||(t.name=r.platform)}}}(),vb="MicrosoftApplicationsTelemetryDeviceId",yb=function(){function e(t,i){var n=0;oS(e,this,(function(e){var r=t.propertyStorageOverride;e.seq=n,e.epoch=VC(!1).toString();var s=hT(i,t);if(s.isEnabled()||r){var a=function(e,t,i){return t?t.getProperty(i)||"":d_(e,i)}(s,r,vb);a||(a=YT()),function(e,t,i,n){t?t.setProperty(i,n):e.set(i,n,31536e3)}(s,r,vb,a),e.installId=a}else s.purge(vb);e.getSequenceId=function(){return++n}}))}return e.__ieDyn=1,e}(),Cb=function(){return function(e,t,i,n){var r=this;if(r.traceId=t||QT(),e.enableDistributedTracing&&!i&&(i=QT().substring(0,16)),r.parentId=i,e.enableApplicationInsightsTrace){r.name=n;var s=rC();s&&s.pathname&&(r.name=s.pathname)}}}(),Tb="setLocalId";function Eb(){return this.getLocalId()}function _b(e){this[Tb](e)}var bb=function(){function e(t,i,n){var r,s=i,a=hT(n,t);oS(e,this,(function(i){if(a&&a.isEnabled()&&(u(),s.enableApplicationInsightsUser)){var n=d_(a,e.userCookieName);if(n){var o=n.split(e.cookieSeparator);o.length>0&&(i.id=o[0])}if(!i.id){i.id=HC(t&&!zv(t.idLength)?t.idLength:22);var l=dy(new Date);i.accountAcquisitionDate=l;var d=[i.id,l],c=s.cookieDomain?s.cookieDomain:void 0;a.set(e.userCookieName,d.join(e.cookieSeparator),31536e3,c)}}if("undefined"!=typeof navigator){var h=navigator;i.locale=h.userLanguage||h.language}function u(){if(!s.hashIdentifiers&&!s.dropIdentifiers){var e=d_(a,"MUID");e&&(r="t:"+e)}return r}i.getLocalId=function(){return r||u()},i[Tb]=function(e){r=e}}))}return e.cookieSeparator="|",e.userCookieName="ai_user",e._staticInit=void fy(e.prototype,"localId",Eb,_b),e}(),Pb=function(){return function(e){var t=this;t.popSample=100,t.eventFlags=0,e.hashIdentifiers&&(t.eventFlags=1048576|t.eventFlags),e.dropIdentifiers&&(t.eventFlags=2097152|t.eventFlags)}}(),Ib="([\\d,.]+)",Ab="Unknown",Rb="Edg/",wb=[{ua:"OPR/",b:"Opera"},{ua:"PhantomJS",b:"PhantomJS"},{ua:"Edge",b:"Edge"},{ua:Rb,b:"Edge"},{ua:"Electron",b:"Electron"},{ua:"Chrome",b:"Chrome"},{ua:"Trident",b:"MSIE"},{ua:"MSIE ",b:"MSIE"},{ua:"Firefox",b:"Firefox"},{ua:"Safari",b:"Safari"},{ua:"SkypeShell",b:"SkypeShell"}],Mb=[{br:"Microsoft Edge",b:"Edge"},{br:"Google Chrome",b:"Chrome"},{br:"Opera",b:"Opera"}];function Ob(e,t){return t.indexOf(e)>-1}function Db(e,t){for(var i=0;i<t.length;i++)if(e==t[i].brand)return t[i].version;return null}function kb(e,t){return"MSIE"===t?function(e){var t=e.match(new RegExp("MSIE "+Ib));if(t)return t[1];var i=e.match(new RegExp("rv:"+Ib));return i?i[1]:void 0}(e):function(e,t){"Safari"===e?e="Version":"Edge"===e&&Ob(Rb,t)&&(e="Edg");var i=t.match(new RegExp(e+"/"+Ib));return i||"Opera"===e&&(i=t.match(new RegExp("OPR/"+Ib)))?i[1]:Ab}(t,e)}function Nb(){return this.getUserConsent()}var Lb=function(){function e(t,i){var n=hT(i),r=t||{};oS(e,this,(function(e){var t=rC();if(t){var i=t.hostname;i&&(e.domain="file:"===t.protocol?"local":i)}if(r.populateBrowserInfo){var s=r.userAgent,a=(r.userAgentData||{}).brands,o=nC();o&&(s=s||o.userAgent||"",a=a||(o.userAgentData||{}).brands),function(t,i){if(ry(i))try{for(var n=0;n<Mb.length;n++){var r=Db(Mb[n].br,i);if(r)return e.browser=Mb[n].b,void(e.browserVer=r)}}catch(e){}if(t){var s=function(e){if(e)for(var t=0;t<wb.length;t++)if(Ob(wb[t].ua,e))return wb[t].b;return Ab}(t);e.browser=s,e.browserVer=kb(t,s)}}(s,a);var l=function(){var e={h:0,w:0},t=Zy();return t&&t.screen&&(e.h=screen.height,e.w=screen.width),e}();e.screenRes=l.w+"X"+l.h}e.getUserConsent=function(){return r.userConsented||!!d_(n,r.userConsentCookieName||"MSCC")},e.getUserConsentDetails=function(){try{var e=r.callback;if(e&&e.userConsentDetails){var t=e.userConsentDetails();if(t)return JSON.stringify({Required:t.Required||!1,Analytics:t.Analytics||!1,SocialMedia:t.SocialMedia||!1,Advertising:t.Advertising||!1})}}catch(e){}return null},fy(e,"userConsent",e.getUserConsent)}))}return e._staticInit=void fy(e.prototype,"userConsent",Nb),e}();function xb(e,t,i,n,r){var s=t.ext[w_[e]];return s&&ey(n,(function(e,t){if(sy(t)||ay(t)||oy(t)){var n=s[i[e]];!r&&(n||sy(n)||ay(n)||oy(n))&&(t=n),s[i[e]]=t}})),s}var Fb=function(){function e(t,i,n){oS(e,this,(function(e){e.app=new tb(i,n),e.cloud=new ib,e.user=new bb(t,i,n),e.os=new Sb(i),e.web=new Lb(i,n);var r=new yb(t,n),s=new ab(i,n),a=new Pb(i);e.loc=new ob,e.device=new nb;var o=new Y_(n,i);e.session=new K_;var l,d,c,h=(l=new Cb(i),d=g(),c=l||{},{getName:function(){return c.name},setName:function(e){d&&d.setName(e),c.name=e},getTraceId:function(){return c.traceId},setTraceId:function(e){d&&d.setTraceId(e),tE(e)&&(c.traceId=e)},getSpanId:function(){return c.parentId},setSpanId:function(e){d&&d.setSpanId(e),iE(e)&&(c.parentId=e)},getTraceFlags:function(){return c.traceFlags},setTraceFlags:function(e){d&&d.setTraceFlags(e),c.traceFlags=e}}),u=!(i||{}).eventContainExtFields;function p(){var t=e.session;if(t&&sy(t.customId))return t.customId;o.update();var i=o.automaticSession;if(i){var n=i.getId();n&&sy(n)&&(t.automaticId=n)}return t.automaticId}function g(){var e=h;return n&&n.getTraceCtx&&(e=n.getTraceCtx(!1)||h),e}e.getTraceCtx=function(){return h},e.getSessionId=p,e.applyApplicationContext=function(t){var i,n=e.app;xb(4,t,M_,((i={})[0]=n.id,i[1]=n.ver,i[2]=n.name,i[3]=n.locale,i[4]=n.getExpId(),i[5]=n.env,i),u)},e.applyUserContext=function(t){var i,n=e.user;xb(0,t,D_,((i={})[1]=n.getLocalId(),i[0]=n.locale,i[2]=n.id,i),u)},e.applyWebContext=function(t){var i,n=e.web;xb(3,t,O_,((i={})[0]=n.domain,i[1]=n.browser,i[2]=n.browserVer,i[3]=n.screenRes,i[5]=n.getUserConsentDetails(),i[4]=n.getUserConsent(),i),u)},e.applyOsContext=function(t){var i,n=e.os;xb(5,t,k_,((i={})[0]=n.name,i[1]=n.ver,i),u)},e.applySdkContext=function(e){var t;xb(6,e,N_,((t={})[2]=r.installId,t[1]=r.getSequenceId(),t[3]=r.epoch,t),u)},e.applyIntWebContext=function(e){var t;xb(7,e,L_,((t={})[0]=s.getMsfpc(),t[1]=s.getAnid(),t[2]=s.serviceName,t),u)},e.applyUtcContext=function(e){var t,i=((t={})[0]=a.popSample,t);a.eventFlags>0&&(i[1]=a.eventFlags),xb(8,e,x_,i,u)},e.applyLocContext=function(t){var i;xb(9,t,F_,((i={})[0]=e.loc.tz,i),u)},e.applySessionContext=function(e){var t;xb(4,e,U_,((t={})[0]=p(),t),u)},e.applyDeviceContext=function(t){var i,n=e.device;xb(1,t,V_,((i={})[0]=n.localId,i[2]=n.make,i[3]=n.model,i[1]=n.deviceClass,i),u)},e.applyCloudContext=function(t){var i,n=e.cloud;xb(10,t,H_,((i={})[0]=n.role,i[1]=n.roleInstance,i[2]=n.roleVer,i),u)},e.applyAITraceContext=function(e){var t;if(i.enableApplicationInsightsTrace){var n=g();n&&xb(2,e,B_,((t={})[0]=n.getTraceId(),t[1]=n.getName(),t[2]=n.getSpanId(),t),!1)}},e.applyDistributedTraceContext=function(e){var t,i=g();if(i){var n=((t={})[0]=i.getTraceId(),t[1]=i.getSpanId(),t),r=i.getTraceFlags();Kv(r)||(n[2]=r),xb(11,e,$_,n,!1)}}}))}return e.__ieDyn=1,e}(),Ub=[w_[4],w_[0],w_[3],w_[5],w_[6],w_[7],w_[8],w_[9],w_[1],w_[2],w_[11],w_[10]],Vb=function(e){function t(){var i,n,r,s=e.call(this)||this;return s.identifier="SystemPropertiesCollector",s.priority=3,s.version="3.2.9",oS(t,s,(function(e,t){function s(){i=null,n={}}s(),e.initialize=function(n,s,a){t.initialize(n,s,a),r=e._getTelCtx().getExtCfg(e.identifier),i=new Fb(n,r,s),s&&s.setTraceCtx&&s.setTraceCtx(i.getTraceCtx())},e.processTelemetry=function(t,s){p_(t,e.identifier),s=e._getTelCtx(s);var a,o,l=t.ext=t.ext?t.ext:{};t.data=t.data?t.data:{},cy(Ub,(function(e){l[e]=l[e]||{}})),i&&(i.applyApplicationContext(t),i.applyUserContext(t),i.applyWebContext(t),i.applyOsContext(t),i.applySdkContext(t),i.applyIntWebContext(t),i.applyUtcContext(t),i.applyLocContext(t),i.applySessionContext(t),i.applyDeviceContext(t),r.enableApplicationInsightsTrace&&i.applyAITraceContext(t),r.enableDistributedTracing&&i.applyDistributedTraceContext(t),i.applyCloudContext(t)),cy(my(l),(function(e){0===my(l[e]).length&&delete l[e]})),a=n,o=t.data,a&&ey(a,(function(e,t){o[e]||(o[e]=t)})),e.processNext(t,s)},e.getPropertiesContext=function(){return i},e.setProperty=function(e,t){n[e]=t},e._doTeardown=function(e,t){var n=(e||{}).core();if(n&&n.getTraceCtx&&i){var r=n.getTraceCtx(!1);r&&r===i.getTraceCtx()&&n.setTraceCtx(null)}s()}})),s}return If(t,e),t.__ieDyn=1,t}(EE),Hb=function(){return function(e){this._setOverride=function(t,i){e.setOverride(t,i)},this._getOverride=function(t){return e.getOverride(t)}}}(),Bb=function(e){function t(t,i){var n=e.call(this,t)||this,r=n;return r.setId=function(e){r._setOverride(M_.id,e)},r.getId=function(){return r._getOverride(M_.id)},r.setVer=function(e){r._setOverride(M_.ver,e)},r.getVer=function(){return r._getOverride(M_.ver)},r.setName=function(e){r._setOverride(M_.appName,e)},r.getName=function(){return r._getOverride(M_.appName)},r.setLocale=function(e){r._setOverride(M_.locale,e)},r.getLocale=function(){return r._getOverride(M_.locale)},r.setEnv=function(e){r._setOverride(M_.env,e)},r.getEnv=function(){return r._getOverride(M_.env)},r.setExpId=function(e){r._setOverride(M_.expId,tb.validateAppExpId(e))},r.getExpId=function(){return r._getOverride(M_.expId)},i&&(zv(i.env)||r.setEnv(i.env),Kv(i.expId)||r.setExpId(i.expId)),n}return If(t,e),t}(Hb),$b=function(e){function t(t){var i=e.call(this,t)||this,n=i;return n.setRole=function(e){n._setOverride(H_.role,e)},n.getRole=function(){return n._getOverride(H_.role)},n.setRoleInstance=function(e){n._setOverride(H_.roleInstance,e)},n.getRoleInstance=function(){return n._getOverride(H_.roleInstance)},n.setRoleVer=function(e){n._setOverride(H_.roleVer,e)},n.getRoleVer=function(){return n._getOverride(H_.roleVer)},i}return If(t,e),t}(Hb),jb=function(e){function t(t){var i=e.call(this,t)||this,n=i;return n.setProperty=function(e,t){n._setOverride(e,t)},n.getProperty=function(e){return n._getOverride(e)},i}return If(t,e),t}(Hb),Gb=function(e){function t(t){var i=e.call(this,t)||this,n=i;return n.setLocalId=function(e){n._setOverride(V_.localId,e)},n.getLocalId=function(){return n._getOverride(V_.localId)},n.setDeviceClass=function(e){n._setOverride(V_.deviceClass,e)},n.getDeviceClass=function(){return n._getOverride(V_.deviceClass)},n.setMake=function(e){n._setOverride(V_.make,e)},n.getMake=function(){return n._getOverride(V_.make)},n.setModel=function(e){n._setOverride(V_.model,e)},n.getModel=function(){return n._getOverride(V_.model)},i}return If(t,e),t}(Hb),Wb=function(e){function t(t){var i=e.call(this,t)||this,n=i;return n.setTz=function(e){n._setOverride(F_.tz,e)},n.getTz=function(){return n._getOverride(F_.tz)},i}return If(t,e),t}(Hb),qb=function(e){function t(t,i){var n=e.call(this,t)||this,r=n;if(r.setOsName=function(e){r._setOverride(k_.osName,e)},r.getOsName=function(){return r._getOverride(k_.osName)},r.setVer=function(e){r._setOverride(k_.ver,e)},r.getVer=function(){return r._getOverride(k_.ver)},i&&i.userAgent&&i.populateOperatingSystemInfo){var s=new Sb(i);r.setOsName(s.name),r.setVer(s.ver)}return n}return If(t,e),t}(Hb);function zb(e,t){if(e)for(var i=0;i<t.length;i++){var n=t[i];Kv(e[n])&&(e[n]={}),e=e[n]}return e}var Kb=function(){return function(e){var t=this,i=[];t.setOverride=function(e,t){e&&i.push({key:e,value:t})},t.hasOverride=function(e){var t=!1;return cy(i,(function(i){i.key===e&&(t=!0)})),t},t.getOverride=function(e){var t;return cy(i,(function(i){i.key===e&&(t=i.value)})),t},t.applyOverrides=function(t,n){if(i.length>0)try{var r=zb(t,e);cy(i,(function(e){!function(e,t,i){if(e&&t){var n=t.split("."),r=n[n.length-1];n.length>1&&(e=zb(e,n.slice(0,-1))),Kv(i)?zv(e[r])||delete e[r]:e[r]=i}}(r,e.key,e.value)}))}catch(e){}}}}(),Jb=function(e){function t(t){var i=e.call(this,t)||this,n=i;return n.setLocalId=function(e){n._setOverride(D_.localId,e)},n.getLocalId=function(){return n._getOverride(D_.localId)},n.setLocale=function(e){n._setOverride(D_.locale,e)},n.getLocale=function(){return n._getOverride(D_.locale)},n.setId=function(e){n._setOverride(D_.id,e)},n.getId=function(){return n._getOverride(D_.id)},i}return If(t,e),t}(Hb),Yb=function(e){function t(t,i){var n=e.call(this,t)||this,r=n;return r.setDomain=function(e){r._setOverride(O_.domain,e)},r.getDomain=function(){return r._getOverride(O_.domain)},r.setBrowser=function(e){r._setOverride(O_.browser,e)},r.getBrowser=function(){return r._getOverride(O_.browser)},r.setBrowserVer=function(e){r._setOverride(O_.browserVer,e)},r.getBrowserVer=function(){return r._getOverride(O_.browserVer)},r.setScreenRes=function(e){r._setOverride(O_.screenRes,e)},r.getScreenRes=function(){return r._getOverride(O_.screenRes)},r.setUserConsent=function(e){r._setOverride(O_.userConsent,e)},r.getUserContext=function(){return r._getOverride(O_.userConsent)},i&&(zv(i.userConsented)||r.setUserConsent(i.userConsented)),n}return If(t,e),t}(Hb),Qb="ext",Xb=function(){return function(e,t,i){var n=this,r={};function s(e){for(var t="",i=0;i<e.length;i++)t&&(t+="_"),t+=e[i];return zv(r[t])&&(r[t]=new Kb(e)),t?r[t]:null}n.data=new jb(s(["data"])),n.app=new Bb(s([Qb,w_.AppExt]),t),n.user=new Jb(s([Qb,w_.UserExt])),n.os=new qb(s([Qb,w_.OSExt]),t),n.web=new Yb(s([Qb,w_.WebExt]),t),n.device=new Gb(s([Qb,w_.DeviceExt])),n.loc=new Wb(s([Qb,w_.LocExt])),n.cloud=new $b(s([Qb,w_.CloudExt])),n.applyOverrides=function(e,t){var i=my(r);i&&i.length>0&&cy(i,(function(i){r[i].applyOverrides(e,t)}))}}}(),Zb=function(e){function t(){var i=e.call(this)||this;i.identifier="OverridePropertiesPlugin",i.priority=4,i.version="3.2.9";var n=null;return oS(t,i,(function(e,t){e.initialize=function(i,n,r){t.initialize(i,n,r),e._baseInit(i,n,r)},e.processTelemetry=function(t,n){p_(t,i.identifier),n=e._getTelCtx(n);var r=e.getOverrideContext();r&&r.applyOverrides(t,n),e.processNext(t,n)},e._baseInit=function(e,t,r){n=new Xb(e,i._getTelCtx().getExtCfg(i.identifier),t)},e.setProperty=function(e,t){n&&n.data.setProperty(e,t)},e.getOverrideContext=function(){return n}})),i}return If(t,e),t.__ieDyn=1,t}(EE),eP="REAL_TIME",tP="",iP="POST",nP="drop",rP="send",sP="requeue",aP="rspFail",oP="application/x-json-stream",lP="cache-control",dP="content-type",cP="kill-tokens",hP="kill-duration",uP="time-delta-millis",pP="client-version",gP="client-id",mP="time-delta-to-apply-millis",fP="upload-time",SP="apikey",vP="AuthMsaDeviceTicket",yP="AuthXToken",CP="msfpc",TP="trace",EP="user";function _P(e){var t=(e.ext||{}).intweb;return t&&a_(t[CP])?t[CP]:null}function bP(e){for(var t=null,i=0;null===t&&i<e.length;i++)t=_P(e[i]);return t}var PP=function(){function e(t,i){var n=i?[].concat(i):[],r=this,s=bP(n);r.iKey=function(){return t},r.Msfpc=function(){return s||tP},r.count=function(){return n.length},r.events=function(){return n},r.addEvent=function(e){return!!e&&(n.push(e),s||(s=_P(e)),!0)},r.split=function(i,r){var a;if(i<n.length){var o=n.length-i;Kv(r)||(o=r<o?r:o),a=n.splice(i,o),s=bP(n)}return new e(t,a)}}return e.create=function(t,i){return new e(t,i)},e}(),IP=function(){function e(){var t=!0,i=!0,n=!0,r="use-collector-delta",s=!1;oS(e,this,(function(e){e.allowRequestSending=function(){return t},e.firstRequestSent=function(){n&&(n=!1,s||(t=!1))},e.shouldAddClockSkewHeaders=function(){return i},e.getClockSkewHeaderValue=function(){return r},e.setClockSkew=function(e){s||(e?(r=e,i=!0,s=!0):i=!1,t=!0)}}))}return e.__ieDyn=1,e}(),AP=function(){function e(){var t={};oS(e,this,(function(e){e.setKillSwitchTenants=function(e,i){if(e&&i)try{var n=function(e){var t=[];return e&&cy(e,(function(e){t.push(uy(e))})),t}(e.split(","));if("this-request-only"===i)return n;for(var r=1e3*parseInt(i,10),s=0;s<n.length;++s)t[n[s]]=yy()+r}catch(e){return[]}return[]},e.isTenantKilled=function(e){var i=t,n=uy(e);return void 0!==i[n]&&i[n]>yy()||(delete i[n],!1)}}))}return e.__ieDyn=1,e}(),RP=AP;function wP(e){var t,i=Math.floor(1200*Math.random())+2400;return t=Math.pow(2,e)*i,Math.min(t,6e5)}var MP,OP=2e6,DP=Math.min(OP,65e3),kP="metadata",NP="f",LP=/\./,xP=function(){function e(t,i,n,r){var s="data",a="baseData",o=!!r,l=i,d={};oS(e,this,(function(e){function i(e,t,r,s,a,c,h){ey(e,(function(e,u){var p=null;if(u||a_(u)){var g=r,m=e,f=a,S=t;if(o&&!s&&LP.test(e)){var v=e.split("."),y=v.length;if(y>1){f&&(f=f.slice());for(var C=0;C<y-1;C++){var T=v[C];S=S[T]=S[T]||{},g+="."+T,f&&f.push(T)}m=v[y-1]}}var E=s&&function(e,t){var i=d[e];return void 0===i&&(e.length>=7&&(i=iy(e,"ext.metadata")||iy(e,"ext.web")),d[e]=i),i}(g);if(p=!E&&l&&l.handleField(g,m)?l.value(g,m,u,n):function(e,t,i){if(!t&&!a_(t)||"string"!=typeof e)return null;var n,r=typeof t;if("string"===r||"number"===r||"boolean"===r||ry(t))t={value:t};else if("object"!==r||vf.call(t,"value")){if(Kv(t.value)||t.value===e_||!sy(t.value)&&!ay(t.value)&&!oy(t.value)&&!ry(t.value))return null}else t={value:i?JSON.stringify(t):t};if(ry(t.value)&&!(t.value.length>0))return null;if(!Kv(t.kind)){if(ry(t.value)||!(0===(n=t.kind)||n>0&&n<=13||32===n))return null;t.value=t.value.toString()}return t}(m,u,n),p){var _=p.value;if(S[m]=_,c&&c(f,m,p),h&&"object"==typeof _&&!ry(_)){var b=f;b&&(b=b.slice()).push(m),i(u,_,g+"."+m,s,b,c,h)}}}}))}e.createPayload=function(e,t,i,n,r,s){return{apiKeys:[],payloadBlob:tP,overflow:null,sizeExceed:[],failedEvts:[],batches:[],numEvents:0,retryCnt:e,isTeardown:t,isSync:i,isBeacon:n,sendType:s,sendReason:r}},e.appendPayload=function(i,n,r){var s=i&&n&&!i.overflow;return s&&DC(t,(function(){return"Serializer:appendPayload"}),(function(){for(var t=n.events(),s=i.payloadBlob,a=i.numEvents,o=!1,l=[],d=[],c=i.isBeacon,h=c?65e3:3984588,u=c?DP:OP,p=0,g=0;p<t.length;){var m=t[p];if(m){if(a>=r){i.overflow=n.split(p);break}var f=e.getEventBlob(m);if(f&&f.length<=u){var S=f.length;if(s.length+S>h){i.overflow=n.split(p);break}s&&(s+="\n"),s+=f,++g>20&&(s.substr(0,1),g=0),o=!0,a++}else f?l.push(m):d.push(m),t.splice(p,1),p--}p++}if(l&&l.length>0&&i.sizeExceed.push(PP.create(n.iKey(),l)),d&&d.length>0&&i.failedEvts.push(PP.create(n.iKey(),d)),o){i.batches.push(n),i.payloadBlob=s,i.numEvents=a;var v=n.iKey();-1===hy(i.apiKeys,v)&&i.apiKeys.push(v)}}),(function(){return{payload:i,theBatch:{iKey:n.iKey(),evts:n.events()},max:r}})),s},e.getEventBlob=function(e){try{return DC(t,(function(){return"Serializer.getEventBlob"}),(function(){var t={};t.name=e.name,t.time=e.time,t.ver=e.ver,t.iKey="o:"+o_(e.iKey);var n={},r=e.ext;r&&(t.ext=n,ey(r,(function(e,t){i(t,n[e]={},"ext."+e,!0,null,null,!0)})));var o=t[s]={};o.baseType=e.baseType;var l=o[a]={};return i(e.baseData,l,a,!1,[a],(function(e,t,i){FP(n,e,t,i)}),!0),i(e.data,o,s,!1,[],(function(e,t,i){FP(n,e,t,i)}),!0),JSON.stringify(t)}),(function(){return{item:e}}))}catch(e){return null}}}))}return e.__ieDyn=1,e}();function FP(e,t,i,n){if(n&&e){var r=l_(n.value,n.kind,n.propertyType);if(r>-1){var s=e[kP];s||(s=e[kP]={f:{}});var a=s[NP];if(a||(a=s[NP]={}),t)for(var o=0;o<t.length;o++){var l=t[o];a[l]||(a[l]={f:{}});var d=a[l][NP];d||(d=a[l][NP]={}),a=d}a=a[i]={},ry(n.value)?a.a={t:r}:a.t=r}}}var UP="sendAttempt",VP="&NoResponseBody=true",HP=((MP={})[1]=sP,MP[100]=sP,MP[200]="sent",MP[8004]=nP,MP[8003]=nP,MP),BP={},$P={};function jP(e,t,i){BP[e]=t,!1!==i&&($P[t]=e)}function GP(e){try{return e.responseText}catch(e){}return tP}function WP(e,t){var i=!1;if(e&&t){var n=my(e);if(n&&n.length>0)for(var r=t.toLowerCase(),s=0;s<n.length;s++){var a=n[s];if(a&&Yv(t,a)&&a.toLowerCase()===r){i=!0;break}}}return i}function qP(e,t,i,n){t&&i&&i.length>0&&(n&&BP[t]?(e.hdrs[BP[t]]=i,e.useHdrs=!0):e.url+="&"+t+"="+i)}function zP(e,t){return t&&(ay(t)?e=[t].concat(e):ry(t)&&(e=t.concat(e))),e}jP(vP,vP,!1),jP(pP,pP),jP(gP,"Client-Id"),jP(SP,SP),jP(mP,mP),jP(fP,fP),jP(yP,yP);var KP=function(){function e(t,i,n,r,s){this._responseHandlers=[];var a,o,l,d,c,h,u,p,g,m,f="?cors=true&"+dP.toLowerCase()+"="+oP,S=new RP,v=!1,y=new IP,C=!1,T=0,E=!0,_=[],b={},P=[],I=null,A=!1,R=!1,w=!1;oS(e,this,(function(e){var M=!0;function O(e,t){for(var i=0,n=null,r=0;null==n&&r<e.length;)1===(i=e[r])?(null===Ky&&(Ky=typeof XDomainRequest!==cf)&&uC()&&(Ky=Ky&&!Yy(Qy(Gy),"withCredentials")),Ky?n=D:uC()&&(n=N)):2===i&&hC(t)&&(!t||t&&!p)?n=k:C&&3===i&&cC()&&(n=x),r++;return n?{_transport:i,_isSync:t,sendPOST:n}:null}function D(e,t,i){var n=new XDomainRequest;n.open(iP,e.urlString),e.timeout&&(n.timeout=e.timeout),n.onload=function(){var e=GP(n);L(t,200,{},e),K(e)},n.onerror=function(){L(t,400,{})},n.ontimeout=function(){L(t,500,{})},n.onprogress=function(){},i?n.send(e.data):s.set((function(){n.send(e.data)}),0)}function k(e,t,i){var n,r=e.urlString,a=!1,o=!1,l=((n={body:e.data,method:iP}).Microsoft_ApplicationInsights_BypassAjaxInstrumentation=!0,n);i&&(l.keepalive=!0,2===e._sendReason&&(a=!0,m&&(r+=VP))),M&&(l.credentials="include"),e.headers&&my(e.headers).length>0&&(l.headers=e.headers),fetch(r,l).then((function(e){var i={},n=tP,r=e.headers;r&&r.forEach((function(e,t){i[t]=e})),e.body&&e.text().then((function(e){n=e})),o||(o=!0,L(t,e.status,i,n),K(n))})).catch((function(e){o||(o=!0,L(t,0,{}))})),a&&!o&&(o=!0,L(t,200,{})),!o&&e.timeout>0&&s.set((function(){o||(o=!0,L(t,500,{}))}),e.timeout)}function N(e,t,i){var n=e.urlString;function r(e,t,i){if(!e[i]&&t&&t.getResponseHeader){var n=t.getResponseHeader(i);n&&(e[i]=uy(n))}return e}function s(e){var t,i,n={};return e.getAllResponseHeaders?(t=e.getAllResponseHeaders(),i={},sy(t)&&cy(uy(t).split(/[\r\n]+/),(function(e){if(e){var t=e.indexOf(": ");if(-1!==t){var n=uy(e.substring(0,t)).toLowerCase(),r=uy(e.substring(t+1));i[n]=r}else i[uy(e)]=1}})),n=i):(n=r(n,e,uP),n=r(n,e,hP),n=r(n,e,"kill-duration-seconds")),n}function a(e,i){L(t,e.status,s(e),i)}i&&e.disableXhrSync&&(i=!1);var o=function(e,t,i,n,r,s){function a(e,t,i){try{e[t]=i}catch(e){}}void 0===n&&(n=!1),void 0===r&&(r=!1);var o=new XMLHttpRequest;return n&&a(o,"Microsoft_ApplicationInsights_BypassAjaxInstrumentation",n),i&&a(o,r_,i),o.open(e,t,!r),i&&a(o,r_,i),!r&&s&&a(o,"timeout",s),o}(iP,n,M,!0,i,e.timeout);ey(e.headers,(function(e,t){o.setRequestHeader(e,t)})),o.onload=function(){var e=GP(o);a(o,e),K(e)},o.onerror=function(){a(o)},o.ontimeout=function(){a(o)},o.send(e.data)}function L(e,t,i,n){try{e(t,i,n)}catch(e){bC(o,2,518,dC(e))}}function x(e,t,i){var n=200,r=e._thePayload,s=e.urlString+(m?VP:tP);try{var a=nC();if(!a.sendBeacon(s,e.data))if(r){var l=[];cy(r.batches,(function(e){if(l&&e&&e.count()>0){for(var t=e.events(),i=0;i<t.length;i++)if(!a.sendBeacon(s,I.getEventBlob(t[i]))){l.push(e.split(i));break}}else l.push(e.split(0))})),J(l,8003,r.sendType,!0)}else n=0}catch(e){PC(o,"Failed to send telemetry using sendBeacon API. Ex:"+dC(e)),n=0}finally{L(t,n,{},tP)}}function F(e){return 2===e||3===e}function U(e){return R&&F(e)&&(e=2),e}function V(){return!v&&T<i}function H(){var e=P;return P=[],e}function B(e,t,i){var n=!1;return e&&e.length>0&&!v&&l[t]&&I&&(n=0!==t||V()&&(i>0||y.allowRequestSending())),n}function $(e){var t={};return e&&cy(e,(function(e,i){t[i]={iKey:e.iKey(),evts:e.events()}})),t}function j(e,i,n,r,s){if(e&&0!==e.length)if(v)J(e,1,r);else{r=U(r);try{var a=e,c=0!==r;DC(d,(function(){return"HttpManager:_sendBatches"}),(function(a){a&&(e=e.slice(0));for(var o=[],d=null,h=u_(),u=l[r]||(c?l[1]:l[0]),p=u&&u._transport,m=g&&(R||F(r)||3===p||u._isSync&&2===p);B(e,r,i);){var f=e.shift();f&&f.count()>0&&(S.isTenantKilled(f.iKey())?o.push(f):(d=d||I.createPayload(i,n,c,m,s,r),I.appendPayload(d,f,t)?null!==d.overflow&&(e=[d.overflow].concat(e),d.overflow=null,q(d,h,u_(),s),h=u_(),d=null):(q(d,h,u_(),s),h=u_(),e=[f].concat(e),d=null)))}d&&q(d,h,u_(),s),e.length>0&&(P=e.concat(P)),J(o,8004,r)}),(function(){return{batches:$(a),retryCount:i,isTeardown:n,isSynchronous:c,sendReason:s,useSendBeacon:F(r),sendType:r}}),!c)}catch(e){bC(o,2,48,"Unexpected Exception sending batch: "+dC(e))}}}function G(e,t){var i={url:f,hdrs:{},useHdrs:!1};t?(i.hdrs=h_(i.hdrs,b),i.useHdrs=my(i.hdrs).length>0):ey(b,(function(e,t){$P[e]?qP(i,$P[e],t,!1):(i.hdrs[e]=t,i.useHdrs=!0)})),qP(i,gP,"NO_AUTH",t),qP(i,pP,n_,t);var n=tP;cy(e.apiKeys,(function(e){n.length>0&&(n+=","),n+=e})),qP(i,SP,n,t),qP(i,fP,yy().toString(),t);var r=function(e){for(var t=0;t<e.batches.length;t++){var i=e.batches[t].Msfpc();if(i)return encodeURIComponent(i)}return tP}(e);if(a_(r)&&(i.url+="&ext.intweb.msfpc="+r),y.shouldAddClockSkewHeaders()&&qP(i,mP,y.getClockSkewHeaderValue(),t),d.getWParam){var s=d.getWParam();s>=0&&(i.url+="&w="+s)}for(var a=0;a<_.length;a++)i.url+="&"+_[a].name+"="+_[a].value;return i}function W(e,t,i){e[t]=e[t]||{},e[t][a.identifier]=i}function q(t,i,r,s){if(t&&t.payloadBlob&&t.payloadBlob.length>0){var c=!!e.sendHook,g=l[t.sendType];!F(t.sendType)&&t.isBeacon&&2===t.sendReason&&(g=l[2]||l[3]||g);var m=w;(t.isBeacon||3===g._transport)&&(m=!1);var f=G(t,m);m=m||f.useHdrs;var v=u_();DC(d,(function(){return"HttpManager:_doPayloadSend"}),(function(){for(var l=0;l<t.batches.length;l++)for(var C=t.batches[l].events(),_=0;_<C.length;_++){var b=C[_];if(A){var P=b.timings=b.timings||{};W(P,"sendEventStart",v),W(P,"serializationStart",i),W(P,"serializationCompleted",r)}b[UP]>0?b[UP]++:b[UP]=1}J(t.batches,1e3+(s||0),t.sendType,!0);var I={data:t.payloadBlob,urlString:f.url,headers:f.hdrs,_thePayload:t,_sendReason:s,timeout:h,disableXhrSync:u,disableFetchKeepAlive:p};m&&(WP(I.headers,lP)||(I.headers[lP]="no-cache, no-store"),WP(I.headers,dP)||(I.headers[dP]=oP));var w=null;g&&(w=function(i){y.firstRequestSent();var r=function(i,r){!function(t,i,r,s){var o,l=9e3,d=null,c=!1,h=!1;try{var u=!0;if(typeof t!==cf){if(i){y.setClockSkew(i[uP]);var p=i[hP]||i["kill-duration-seconds"];cy(S.setKillSwitchTenants(i[cP],p),(function(e){cy(r.batches,(function(t){if(t.iKey()===e){d=d||[];var i=t.split(0);r.numEvents-=i.count(),d.push(i)}}))}))}if(200==t||204==t)return void(l=200);((o=t)>=300&&o<500&&408!=o&&429!=o||501==o||505==o||r.numEvents<=0)&&(u=!1),l=9e3+t%1e3}if(u){l=100;var g=r.retryCnt;0===r.sendType&&(g<n?(c=!0,z((function(){0===r.sendType&&T--,j(r.batches,g+1,r.isTeardown,R?2:r.sendType,5)}),R,wP(g))):(h=!0,R&&(l=8001)))}}finally{c||(y.setClockSkew(),function(t,i,n,r){try{r&&a._backOffTransmission(),200===i&&(r||t.isSync||a._clearBackOff(),function(e){if(A){var t=u_();cy(e,(function(e){e&&e.count()>0&&function(e,t){A&&cy(e,(function(e){W(e.timings=e.timings||{},"sendEventCompleted",t)}))}(e.events(),t)}))}}(t.batches)),J(t.batches,i,t.sendType,!0)}finally{0===t.sendType&&(T--,5!==n&&e.sendQueuedRequests(t.sendType,n))}}(r,l,s,h)),J(d,8004,r.sendType)}}(i,r,t,s)},l=t.isTeardown||t.isSync;try{g.sendPOST(i,r,l),e.sendListener&&e.sendListener(I,i,l,t.isBeacon)}catch(e){PC(o,"Unexpected exception sending payload. Ex:"+dC(e)),L(r,0,{})}}),DC(d,(function(){return"HttpManager:_doPayloadSend.sender"}),(function(){if(w)if(0===t.sendType&&T++,c&&!t.isBeacon&&3!==g._transport){var i={data:I.data,urlString:I.urlString,headers:h_({},I.headers),timeout:I.timeout,disableXhrSync:I.disableXhrSync,disableFetchKeepAlive:I.disableFetchKeepAlive},n=!1;DC(d,(function(){return"HttpManager:_doPayloadSend.sendHook"}),(function(){try{e.sendHook(i,(function(e){n=!0,E||e._thePayload||(e._thePayload=e._thePayload||I._thePayload,e._sendReason=e._sendReason||I._sendReason),w(e)}),t.isSync||t.isTeardown)}catch(e){n||w(I)}}))}else w(I)}))}),(function(){return{thePayload:t,serializationStart:i,serializationCompleted:r,sendReason:s}}),t.isSync)}t.sizeExceed&&t.sizeExceed.length>0&&J(t.sizeExceed,8003,t.sendType),t.failedEvts&&t.failedEvts.length>0&&J(t.failedEvts,8002,t.sendType)}function z(e,t,i){t?e():s.set(e,i)}function K(t){var i=e._responseHandlers;try{for(var n=0;n<i.length;n++)try{i[n](t)}catch(e){bC(o,1,519,"Response handler failed: "+e)}if(t){var r=JSON.parse(t);a_(r.webResult)&&a_(r.webResult[CP])&&c.set("MSFPC",r.webResult[CP],31536e3)}}catch(e){}}function J(e,t,i,n){if(e&&e.length>0&&r){var s=r[(l=t,c=HP[l],a_(c)||(c="oth",l>=9e3&&l<=9999?c=aP:l>=8e3&&l<=8999?c=nP:l>=1e3&&l<=1999&&(c=rP)),c)];if(s){var a=0!==i;DC(d,(function(){return"HttpManager:_sendBatchesNotification"}),(function(){z((function(){try{s.call(r,e,t,a,i)}catch(e){bC(o,1,74,"send request notification failed: "+e)}}),n||a,0)}),(function(){return{batches:$(e),reason:t,isSync:a,sendSync:n,sendType:i}}),!a)}}var l,c}e.initialize=function(e,t,i,n,r){var s;r||(r={}),f=e+f,w=!!zv(r.avoidOptions)||!r.avoidOptions,d=t,c=t.getCookieMgr(),A=!d.config.disableEventTimings;var S=!!d.config.enableCompoundKey;o=(a=i).diagLog();var v=r.valueSanitizer,y=r.stringifyObjects;zv(r.enableCompoundKey)||(S=!!r.enableCompoundKey),h=r.xhrTimeout,u=!!r.disableXhrSync,p=!!r.disableFetchKeepAlive,m=!1!==r.addNoResponse,C=!oC(),I=new xP(d,v,y,S),Kv(r.useSendBeacon)||(C=!!r.useSendBeacon);var T=n,_=r.alwaysUseXhrOverride?n:null,b=r.alwaysUseXhrOverride?n:null,P=[3,2];if(!n){E=!1;var R=rC();R&&R.protocol&&"file:"===R.protocol.toLowerCase()&&(M=!1);var D=[];oC()?(D=[2,1],P=[2,1,3]):D=[1,2,3],(n=O(D=zP(D,r.transports),!1))||PC(o,"No available transport to send events"),T=O(D,!0)}_||(_=O(P=zP(P,r.unloadTransports),!0)),g=!E&&(C&&cC()||!p&&hC(!0)),(s={})[0]=n,s[1]=T||O([1,2,3],!0),s[2]=_||T||O([1],!0),s[3]=b||O([2,3],!0)||T||O([1],!0),l=s},e._getDbgPlgTargets=function(){return[l[0],S,I,l]},e.addQueryStringParameter=function(e,t){for(var i=0;i<_.length;i++)if(_[i].name===e)return void(_[i].value=t);_.push({name:e,value:t})},e.addHeader=function(e,t){b[e]=t},e.canSendRequest=function(){return V()&&y.allowRequestSending()},e.sendQueuedRequests=function(e,t){zv(e)&&(e=0),R&&(e=U(e),t=2),B(P,e,0)&&j(H(),0,!1,e,t||0)},e.isCompletelyIdle=function(){return!v&&0===T&&0===P.length},e.setUnloading=function(e){R=e},e.addBatch=function(e){if(e&&e.count()>0){if(S.isTenantKilled(e.iKey()))return!1;P.push(e)}return!0},e.teardown=function(){P.length>0&&j(H(),0,!0,2,2)},e.pause=function(){v=!0},e.resume=function(){v=!1,e.sendQueuedRequests(0,4)},e.sendSynchronousBatch=function(e,t,i){e&&e.count()>0&&(Kv(t)&&(t=1),R&&(t=U(t),i=2),j([e],0,!1,t,i||0))}}))}return e.__ieDyn=1,e}();function JP(e,t){for(var i=[],n=2;n<arguments.length;n++)i[n-2]=arguments[n];return setTimeout(e,t,i)}function YP(e){clearTimeout(e)}function QP(e,t){return{set:e||JP,clear:t||YP}}var XP="eventsDiscarded",ZP="overrideInstrumentationKey",eI="maxEventRetryAttempts",tI="maxUnloadEventRetryAttempts",iI=function(e){function t(){var i,n=e.call(this)||this;n.identifier="PostChannel",n.priority=1011,n.version="3.2.9";var r,s,a,o,l,d,c,h=!1,u=[],p=null,g=!1,m=0,f=500,S=0,v=1e4,y={},C=eP,T=null,E=null,_=0,b=0,P={},I=-1,A=!0,R=!1,w=6,M=2;return oS(t,n,(function(e,t){function n(e){"beforeunload"!==(e||Zy().event).type&&(R=!0,s.setUnloading(R)),V(2,2)}function O(e){R=!1,s.setUnloading(R)}function D(e,t){if(e.sendAttempt||(e.sendAttempt=0),e.latency||(e.latency=1),e.ext&&e.ext[TP]&&delete e.ext[TP],e.ext&&e.ext[EP]&&e.ext[EP].id&&delete e.ext[EP].id,A&&(e.ext=Ry(e.ext),e.baseData&&(e.baseData=Ry(e.baseData)),e.data&&(e.data=Ry(e.data))),e.sync)if(_||g)e.latency=3,e.sync=!1;else if(s)return A&&(e=Ry(e)),void s.sendSynchronousBatch(PP.create(e.iKey,[e]),!0===e.sync?1:e.sync,3);var i=e.latency,n=S,r=v;4===i&&(n=m,r=f);var a=!1;if(n<r)a=!$(e,t);else{var o=1,l=20;4===i&&(o=4,l=1),a=!0,function(e,t,i,n){for(;i<=t;){var r=H(e,t,!0);if(r&&r.count()>0){var s=r.split(0,n),a=s.count();if(a>0)return 4===i?m-=a:S-=a,Q(XP,[s],Dy.QueueFull),!0}i++}return j(),!1}(e.iKey,e.latency,o,l)&&(a=!$(e,t))}a&&Y(XP,[e],Dy.QueueFull)}function k(e,t,i){var n=G(e,t,i);return s.sendQueuedRequests(t,i),n}function N(){return S>0}function L(){if(I>=0&&G(I,0,l)&&s.sendQueuedRequests(0,l),m>0&&!E&&!g){var e=y[C][2];e>=0&&(E=F((function(){E=null,k(4,0,1),L()}),e))}var t=y[C][1];!T&&!p&&t>=0&&!g&&(N()?T=F((function(){T=null,k(0===b?3:1,0,1),b++,b%=2,L()}),t):b=0)}function x(){i=null,h=!1,u=[],p=null,g=!1,m=0,f=500,S=0,v=1e4,y={},C=eP,T=null,E=null,_=0,b=0,r=null,P={},a=void 0,o=0,I=-1,l=null,A=!0,R=!1,w=6,M=2,d=null,c=QP(),s=new KP(500,2,1,{requeue:K,send:X,sent:Z,drop:ee,rspFail:te,oth:ie},c),z(),P[4]={batches:[],iKeyMap:{}},P[3]={batches:[],iKeyMap:{}},P[2]={batches:[],iKeyMap:{}},P[1]={batches:[],iKeyMap:{}},ne()}function F(e,t){0===t&&_&&(t=1);var i=1e3;return _&&(i=wP(_-1)),c.set(e,t*i)}function U(){return null!==T&&(c.clear(T),T=null,b=0,!0)}function V(e,t){U(),p&&(c.clear(p),p=null),g||k(1,e,t)}function H(e,t,i){var n=P[t];n||(n=P[t=1]);var r=n.iKeyMap[e];return!r&&i&&(r=PP.create(e),n.batches.push(r),n.iKeyMap[e]=r),r}function B(t,i){s.canSendRequest()&&!_&&(a>0&&S>a&&(i=!0),i&&null==p&&e.flush(t,null,20))}function $(e,t){A&&(e=Ry(e));var i=e.latency,n=H(e.iKey,i,!0);return!!n.addEvent(e)&&(4!==i?(S++,t&&0===e.sendAttempt&&B(!e.sync,o>0&&n.count()>=o)):m++,!0)}function j(){for(var e=0,t=0,i=function(i){var n=P[i];n&&n.batches&&cy(n.batches,(function(n){4===i?e+=n.count():t+=n.count()}))},n=1;n<=4;n++)i(n);S=t,m=e}function G(t,i,n){var r=!1,a=0===i;return!a||s.canSendRequest()?DC(e.core,(function(){return"PostChannel._queueBatches"}),(function(){for(var e=[],i=4;i>=t;){var n=P[i];n&&n.batches&&n.batches.length>0&&(cy(n.batches,(function(t){s.addBatch(t)?r=r||t&&t.count()>0:e=e.concat(t.events()),4===i?m-=t.count():S-=t.count()})),n.batches=[],n.iKeyMap={}),i--}e.length>0&&Y(XP,e,Dy.KillSwitch),r&&I>=t&&(I=-1,l=0)}),(function(){return{latency:t,sendType:i,sendReason:n}}),!a):(I=I>=0?Math.min(I,t):t,l=Math.max(l,n)),r}function W(e,t){k(1,0,t),j(),q((function(){e&&e(),u.length>0?p=F((function(){p=null,W(u.shift(),t)}),0):(p=null,L())}))}function q(e){s.isCompletelyIdle()?e():p=F((function(){p=null,q(e)}),.25)}function z(){(y={})[eP]=[2,1,0],y.NEAR_REAL_TIME=[6,3,0],y.BEST_EFFORT=[18,9,0]}function K(t,i){var n=[],r=w;R&&(r=M),cy(t,(function(t){t&&t.count()>0&&cy(t.events(),(function(t){t&&(t.sync&&(t.latency=4,t.sync=!1),t.sendAttempt<r?(p_(t,e.identifier),D(t,!1)):n.push(t))}))})),n.length>0&&Y(XP,n,Dy.NonRetryableStatus),R&&V(2,2)}function J(t,i){var n=e._notificationManager||{},r=n[t];if(r)try{r.apply(n,i)}catch(i){bC(e.diagLog(),1,74,t+" notification failed: "+i)}}function Y(e,t){for(var i=[],n=2;n<arguments.length;n++)i[n-2]=arguments[n];t&&t.length>0&&J(e,[t].concat(i))}function Q(e,t){for(var i=[],n=2;n<arguments.length;n++)i[n-2]=arguments[n];t&&t.length>0&&cy(t,(function(t){t&&t.count()>0&&J(e,[t.events()].concat(i))}))}function X(e,t,i){e&&e.length>0&&J("eventsSendRequest",[t>=1e3&&t<=1999?t-1e3:0,!0!==i])}function Z(e,t){Q("eventsSent",e,t),L()}function ee(e,t){Q(XP,e,t>=8e3&&t<=8999?t-8e3:Dy.Unknown)}function te(e){Q(XP,e,Dy.NonRetryableStatus),L()}function ie(e,t){Q(XP,e,Dy.Unknown),L()}function ne(){o=i&&i.disableAutoBatchFlushLimit?0:Math.max(1500,v/6)}x(),e._getDbgPlgTargets=function(){return[s]},e.initialize=function(o,l,h){DC(l,(function(){return"PostChannel:initialize"}),(function(){var u=l;t.initialize(o,l,h);try{l.addUnloadCb,d=$T(zC(e.identifier),l.evtNamespace&&l.evtNamespace());var p=e._getTelCtx();o.extensionConfig[e.identifier]=o.extensionConfig[e.identifier]||{},i=p.getExtCfg(e.identifier),c=QP(i.setTimeoutOverride,i.clearTimeoutOverride),A=!i.disableOptimizeObj&&!!Qy("chrome"),function(e){var t=e.getWParam;e.getWParam=function(){var e=0;return i.ignoreMc1Ms0CookieProcessing&&(e|=2),e|t()}}(u),i.eventsLimitInMem>0&&(v=i.eventsLimitInMem),i.immediateEventLimit>0&&(f=i.immediateEventLimit),i.autoFlushEventsLimit>0&&(a=i.autoFlushEventsLimit),ay(i[eI])&&(w=i[eI]),ay(i[tI])&&(M=i[tI]),ne(),i.httpXHROverride&&i.httpXHROverride.sendPOST&&(r=i.httpXHROverride),a_(o.anonCookieName)&&s.addQueryStringParameter("anoncknm",o.anonCookieName),s.sendHook=i.payloadPreprocessor,s.sendListener=i.payloadListener;var g=i.overrideEndpointUrl?i.overrideEndpointUrl:o.endpointUrl;e._notificationManager=l.getNotifyMgr(),s.initialize(g,e.core,e,r,i);var m=o.disablePageUnloadEvents||[];zT(n,m,d),KT(n,m,d),JT(O,o.disablePageShowEvents,d)}catch(t){throw e.setInitialized(!1),t}}),(function(){return{coreConfig:o,core:l,extensions:h}}))},e.processTelemetry=function(t,n){p_(t,e.identifier);var r=(n=e._getTelCtx(n)).getExtCfg(e.identifier),s=!!i.disableTelemetry;r&&(s=s||!!r.disableTelemetry);var a=t;s||h||(i[ZP]&&(a.iKey=i[ZP]),r&&r[ZP]&&(a.iKey=r[ZP]),D(a,!0),R?V(2,2):L()),e.processNext(a,n)},e._doTeardown=function(e,t){V(2,2),h=!0,s.teardown(),qT([wT,RT,IT],null,d),function(e,t){var i=$T(MT,t);qT([IT],e,i),qT([PT],null,i)}(null,d),function(e,t){var i=$T(OT,t);qT([AT],e,i),qT([PT],null,i)}(null,d),x()},e.setEventQueueLimits=function(e,t){v=e>0?e:1e4,a=t>0?t:0,ne();var i=S>e;if(!i&&o>0)for(var n=1;!i&&n<=3;n++){var r=P[n];r&&r.batches&&cy(r.batches,(function(e){e&&e.count()>=o&&(i=!0)}))}B(!0,i)},e.pause=function(){U(),g=!0,s.pause()},e.resume=function(){g=!1,s.resume(),L()},e.addResponseHandler=function(e){s._responseHandlers.push(e)},e._loadTransmitProfiles=function(e){U(),z(),C=eP,L(),ey(e,(function(e,t){var i=t.length;if(i>=2){var n=i>2?t[2]:0;if(t.splice(0,i-2),t[1]<0&&(t[0]=-1),t[1]>0&&t[0]>0){var r=t[0]/t[1];t[0]=Math.ceil(r)*t[1]}n>=0&&t[1]>=0&&n>t[1]&&(n=t[1]),t.push(n),y[e]=t}}))},e.flush=function(e,t,i){if(void 0===e&&(e=!0),!g)if(i=i||1,e)null==p?(U(),G(1,0,i),p=F((function(){p=null,W(t,i)}),0)):u.push(t);else{var n=U();k(1,1,i),null!=t&&t(),n&&L()}},e.setMsaAuthTicket=function(e){s.addHeader(vP,e)},e.hasEvents=N,e._setTransmitProfile=function(e){C!==e&&void 0!==y[e]&&(U(),C=e,L())},e._backOffTransmission=function(){_<4&&(_++,U(),L())},e._clearBackOff=function(){_&&(_=0,U(),L())},fy(e,"_setTimeoutOverride",(function(){return c.set}),(function(e){c=QP(e,c.clear)})),fy(e,"_clearTimeoutOverride",(function(){return c.clear}),(function(e){c=QP(c.set,e)}))})),n}return If(t,e),t.__ieDyn=1,t}(EE),nI=iI,rI="_dropInst";function sI(e,t){if(t)for(var i=my(t),n=0;n<i.length;n++){var r=i[n];Yv(e,r)||(e[r]=t[r])}}function aI(e,t){var i=null;if(t){t.endpointUrl&&(i=t.endpointUrl);var n=(t.extensionConfig||{})[e]||{};n.overrideEndpointUrl&&(i=n.overrideEndpointUrl)}return i}var oI=function(e){function t(i,n){var r=e.call(this)||this;return oS(t,r,(function(e,t){function r(e){var t=[];return e&&cy(e,(function(e){e.iKey===i&&t.push(e)})),t}function s(t){if(e[t]&&e.listeners)for(var i=0;i<e.listeners.length;i++){var n=e.listeners[i];if(n&&n[t])return!0}return!1}var a={eventsSent:function(t){if(s("eventsSent")){var i=r(t);i.length>0&&e.eventsSent(i)}},eventsDiscarded:function(t,i){if(s("eventsDiscarded")){var n=r(t);n.length>0&&e.eventsDiscarded(n,i)}},eventsSendRequest:function(t,i){s("eventsSendRequest")&&e.eventsSendRequest(t,i)},perfEvent:function(t){s("perfEvent")&&e.perfEvent(t)}};n.addNotificationListener(a)})),r}return If(t,e),t.__ieDyn=1,t}(NE),lI=function(){function e(){var t,i,n,r,s,a,o,l,d,c,h,u,p,g,m=null,f=null;oS(e,this,(function(e){function S(){t={},i=[],n=null,r=null,s=[],a=[],o={},l=null,d=null,c=null,h=null,u=null,p=null,g=!1}function v(e,i){if(void 0===i&&(i=null),e){var n=function(e){return e.pause&&e.teardown&&e.flush}(e)?a:s;n.push(e);var r=e.identifier;t.extensionConfig[r]=t.extensionConfig[r]||{},sI(t.extensionConfig[r],i)}return e}function y(s){if(!n){g||bC(e.diagLog(),2,520,"The Shared Manager is not yet created, the returned shared instance will be overwritten");var a=C(s||t.instrumentationKey||"_not_defined_",{});r=new NE,(n=new dI(e,e.diagLog(),r)).initialize(a,i),n.isInitialized()&&d&&(c=aI(d.identifier,a)),m&&n.setCookieMgr(m)}}function C(e,i){var n={};return n.instrumentationKey=e,n.channels=function(e){var i=[[]];return t.channels&&cy(t.channels,(function(e,t){Xv(e)||(i[t]=i[t]||[],i[t]=i[t].concat(e))})),e&&e.channels&&cy(e.channels,(function(e,t){Xv(e)||(i[t]=i[t]||[],i[t]=i[t].concat(e))})),i}(i),function(e){var i=[];t.extensions&&t.extensions.length>0&&(i=i.concat(t.extensions)),e&&e.extensions&&e.extensions.length>0&&(i=i.concat(e.extensions)),i.length>0&&(e.extensions=i),e.extensionConfig=e.extensionConfig||{},sI(e.extensionConfig,t.extensionConfig)}(n),sI(n,i),sI(n,t),n}S(),e.diagLog=function(){return h||(h=new EC(t)),h},e.getCookieMgr=function(){return y(),m||n.getCookieMgr()},e.setCookieMgr=function(e){m=e,n&&n.setCookieMgr(e)},e.getPerfMgr=function(){return p||t&&t.enablePerfMgr&&(p=f||new MC(e.getNotifyMgr())),p},e.setPerfMgr=function(e){f=e,p=e},e.create=function(r,s){var a,o,h,u;g?bC(e.diagLog(),2,514,"Shared Manager has already been initialized."):(n=null,a=(t=r||{}).channels||[[]],o=new nI,h=o.identifier,u=!1,d=null,c=null,cy(a,(function(e){cy(e,(function(e){Xv(e)||(v(e),e.identifier===h&&(u=!0,d=e))}))})),u||(a[0].push(o),d=v(o,t.channelConfiguration)),t.channels=a,function(e){i=[],l=v(new Vb,t.propertyConfiguration),i.push(l),t.extensions&&cy(t.extensions,(function(e){Xv(e)||v(e)})),e&&cy(e,(function(e){e&&!Xv(e)&&i.push(v(e))}))}(s))},e.getInst=function(e){return(o[e]||{}).inst},e.newInst=function(t,s,a){var l=e.getInst(t);if(l)return bC(e.diagLog(),2,514,"Instance already exists for ["+t+"]"),l;if(y(t),n.isInitialized()){var h=C(t,s);if(d){var u=aI(d.identifier,h);c&&u&&c!==u&&bC(e.diagLog(),2,511,"The endpointUrl mismatch, shared Url ["+c+"] is different from configured ["+u+"] shared will be used!")}var p=new oI(t,r);l=new dI(e,e.diagLog(),p),o[t]={iKey:t,inst:l,notifyMgr:p},l.setPerfMgr(e.getPerfMgr()),l.initialize(h,function(e){var t=[];return i&&i.length>0&&(t=t.concat(i)),e&&e.length>0&&(t=t.concat(e)),t}(a)),l.isInitialized()||(bC(e.diagLog(),2,520,"Failed to initialize new instance!"),l=null,delete o[t])}return l},e.getSharedPlugin=function(e){y();var t=null,i=n.getPlugin(e);return i&&(t=i.plugin),t},e.getPropertyManager=function(){return y(),l},e.getPostChannel=function(){return y(),d},e.getNotifyMgr=function(){return u||(u=new NE),u},e.unload=function(e,t,i){var r=my(o),s=r.length+1,a={reason:50,isAsync:e,flushComplete:!1};function l(e,i){0==--s&&(S(),t&&t(i))}n&&(cy(r,(function(t){!function(e,t,i,n){var r=o[e];r&&(r.inst&&r.inst.isInitialized()?r.inst.unload(t,(function(t){i&&i(e,t)}),n):i&&i(e,{reason:50,isAsync:t,flushComplete:!1}))}(t,e,(function(e,t){l(0,t)}),i)})),n.isInitialized()&&(n.unload(e,(function(e){l(0,a=e)}),i),n=null)),l(0,a)},e[rI]=function(e){e&&o.iKey&&delete o[e]}}))}return e.__ieDyn=1,e}(),dI=function(e){function t(i,n,r){var s,a=e.call(this)||this,o=i;return oS(t,a,(function(e,t){e.getSharedPropertyManager=function(){return o.getPropertyManager()},e.getSharedPostChannel=function(){return o.getPostChannel()},e.getOverridePropertyManager=function(){return s},e.initialize=function(i,a){DC(e,(function(){return"ApplicationInsights:initialize"}),(function(){var o=[s=new Zb];a&&(o=o.concat(a)),i.extensionConfig=i.extensionConfig||[];var l=i.propertyConfiguration||{};i.propertyConfiguration&&delete i.propertyConfiguration,i.extensionConfig[s.identifier]=l;try{t.initialize(i,o,n,r)}catch(t){bC(e.logger,1,514,"Failed to initialize SDK."+dC(t))}}),(function(){return{config:i,extensions:a}}))},e.unload=function(i,n,r){o[rI]&&o[rI]((e.config||{}).instrumentationKey),t.unload(i,n,r)}})),a}return If(t,e),t.__ieDyn=1,t}(m_),cI=class{getInitialSettings(){return{resizeModeForSharing:"none",enableAudioProcessingFallback:!1,allowVirtualDeviceInCall:!1,activeSpeaker:{timeToPromote:1e4},dtmf:{toneDuration:200,toneGap:100},mediaStreamHoldInterval:5e3,webrtcContributingSourcesPollingInterval:1e3,webrtcIceGatheringTimeoutMs:2e4,webrtcAllowedMediaContentType:tt.ALLOWED_CONTENT_TYPES.SDP_NGC,webrtcMediaContentType:tt.CONTENT_TYPE.SDP,webrtcScreensharingCapabilityMaxFS:8160,webrtcScreensharingCapabilityMaxFPS:1500,webrtcStatHwSilentDetectionDuration:5,webrtcStatHwSilentDetectionLevel:14,webrtcStatPollInterval:1e3,webrtcStatStoredRecordsNumber:60,webrtcStatNetworkDetectionDuration:10,webrtcHealedRatioWindowSize:5,webrtcHealedRatioExtendedWindowSize:20,webrtcStatNetworkDetectionHysteresis:.01,webrtcStatNetworkDetectionBadLevel:.17,webrtcStatNetworkDetectionGoodLevel:.15,webrtcMinAudioSamplesRecvForNetworkRecvQuality:48e4,webrtcVideoCapabilityCheckIntervalMin:2e4,webrtcVideoCapabilityCheckIntervalMinMultiparty:5e3,webrtcVideoCapabilityCheckIntervalMax:3e4,webrtcVideoCapabilityCheckIntervalMaxMultiparty:5500,webrtcScreensharingCapabilityCheckIntervalMin:0,webrtcScreensharingCapabilityCheckIntervalMax:0,webrtcVideoCapabilityMaxFS:3600,webrtcVideoCapabilityMaxFPS:3e3,webrtcMultiPartyRecvVideoMaxFS:3600,webrtcRecvVideoMaxFS:8160,webrtcCameraOpenFs:3600,minCameraOpenFps:15,maxCameraOpenFps:30,webrtcMultipartyMaxScalingFs:3600,webrtcMaxScalingFs:8160,webrtcVideoScaling:!1,webrtcVideoScalingMultiparty:!0,enableOptimalVideoCount:!1,ovcBandwidthPerVideoReceiver:2e5,ovcSlidingWindowPercentile:.3,ovcSlidingWindowSamples:20,nonEstimatedDefaultVideoReceiversCount:4,ovcMaxCount:4,ovcMaxCountXL:4,ovcXLParticipantsCount:100,ovcIgnoreFirstSamples:10,ovcAvailableConcurrencyForBiggerGrid:4,ovcMemoryForBiggerGrid:2,ovcRampUpCooldown:15e3,ovcRampDownCooldown:1e4,webrtcStatNetworkDetectionEnabled:!0,webrtcUseNewStatsApi:!0,useAudioAnalyzer:!0,webrtcVideoSubscriptionDisposeTimeout:2e3,webrtcCompareContentTypeInOffer:!0,iceServerTransport:"udp,tcp,tls",iceHostCandidateOnly:!0,iceUdpAddressType:"ip",iceTcpAddressType:"ip",renegotiationAttempts:3,reconnectTimeLimit:9e4,initialReconnectTimeLimit:0,maxReconnectDelayTime:5,waitForRelayOnReconnect:!0,relayWaitSaneTimeoutMs:25e3,reconnectOnDisconnect:!1,reconnectWithNoRelays:!1,reconnectWithProbes:!1,reconnectWaitTimeAfterProbe:1e3,reconnectOnPcClose:!0,reconnectWakeupTimeLimit:18e4,webrtcSpeakingWhileMutedDetectionWindow:3,webrtcSpeakingWhileMutedBadDuration:3,webrtcSpeakingWhileMutedDetectionLevel:4e3,webrtcNegotiateDisabledDataModality:!1,recoverableMediaErrors:[tt.MEDIA_ERROR.iceConnectionError,tt.MEDIA_ERROR.noNetworkError,tt.MEDIA_ERROR.srtpError,tt.MEDIA_ERROR.incompatibleOffer,tt.MEDIA_ERROR.internalError].join(","),forceReconnectErrors:[tt.MEDIA_ERROR.audioPlaybackError].join(","),sendCallStartupTelemetry:!0,webrtcMultiPartyRecvVideoSignaling:!0,webrtcVideoDelayThreshold:10,webrtcEndOfCallFreezeThreshold:3,webrtcSubscriptionEventLimit:300,webrtcHandleRollback:!0,webrtcHandleRemoteRollback:!1,losingConnectivityTimeoutMs:-1,iceCandidateFilterMDns:!0,webrtcInjectTransportCCAudio:!1,webrtcInjectTransportCCAudioMultiparty:!0,webrtcRejectedFeatures:"byPass",webrtcRequiredFeatures:"nonByPass",webrtcSimulcastSessionEnabled:!1,webrtcSimulcastStreamsCountForVideo:1,webrtcSimulcastStreamsCountForSharing:1,webrtcFmtParamListSupported:!0,webrtcNegotiatedSsrcRangeForVideo:0,webrtcNegotiatedSsrcRangeForSharing:0,webrtcNegotiatedSsrcRangeForVideoOneToOne:0,webrtcNegotiatedSsrcRangeForSharingOneToOne:0,webrtcAllowRestoreKeyframe:!1,webrtcEnabledCustomBwEstimationForVideo:!1,webrtcDisabledSenderBitrate:1e3,maxStoredPreferredResolutionCount:4,maxStoredQualityLimitationReasonEvents:30,maxStoredUFDCount:50,simulcastTelemetryLayoutsPerSession:5,simulcastTelemetryNumModalitySessions:3,simulcastTelemetryNumFMTP:10,maxSendVideoCapabilitiesReportingForVideoEnabled:!1,maxSendVideoCapabilitiesReportingForSharingEnabled:!1,maxSendVideoCapabilitiesReportingUseMaximumWidthHeight:!0,maxSendVideoCapabilitiesReportingSendMaxFs:!1,maxSendVideoCapabilitiesReportingSendMaxMbps:!1,maxReportedOvershootingEvents:20,permissions:{usePositiveInAdp:!1,useNegativeInAdp:!1,adpFallback:!0,adpFallbackAudio:!0,adpFallbackVideo:!0,adpRequestAVLast:!0,rememberNegative:!1,persistOnDeniedError:!0,disableOnPermissionDeniedOnly:!1},devices:{blacklist:{microphone:"stereo mix \\(",camera:"(ir camera|avstream media device)",speaker:"stereo mix \\("},overrideDefault:!1,compositeLabelMatchingThreshold:.5,piiSafeWords:["airpod","bluetooth","hands-free","stereo","wireless","citrix hdx","remote audio","vmware","built-in","integrated","internal","teams","high definition","facetime","macbook","smartaudio","front","rear","back","iphone","ipad","display","displayport","dp","hdmi","amd","nvidia","intel","analog","digital","dock","line( in| out)?","s/pdif","external","thunderbolt\\d*","usb","panoramic","desktop","capture","cable","cam","virtual","manycam","snap camera","obs","vb-audio","vaio","effect","sink","source","default","test"],pollingIntervalActive:3e3,enumerateDevicesTimeout:25e3,enumerateDevicesAfterADP:!1},useGoogPrefixAudioConstraints:!0,multiviewResolutionLimits:{1:720,2:720,3:540,4:360,more:360},maxSpotlightResolution:720,multiviewResolutionLimitUpdateThrottleDelay:300,useMultiviewLimitsOnInitialRequest:!0,useApplyChannelParametersForSourceRequests:!1,maxVideoFreezeTimestampsInBucket:5,webrtcSendBandwidthNotificationsEnabled:!1,webrtcSendBandwidthIgnoredUpdateLimit:6,webrtcSendBandwidthThreshold:.1,checkSupportForWebrtc_1_0:!1,webrtcLastAppliedVideoCapabilitiesCount:5,webrtcLastAppliedVideoCapabilitiesSequenceCount:5,gumRequestTimeout:2e4,overrideGumFromWebkit:!1,setMinFpsForWebkit:!1,videoCaptureFreezeTimeout:5e3,webrtcCloseAfterIceFailure:!0,audioBandwidthInKbps:90,videoBandwidthAllocation:.3,enableQosSupport:!1,forceUnbundledTransport:!1,allowedAudioCodecs:[],allowedVideoCodecs:[],allowedVideoCodecsMultiparty:[{clockRate:9e4,mimeType:"video/H264"},{clockRate:9e4,mimeType:"video/rtx"}],filterCodecsInSdp:!1,filterCodecsInSdpMultiparty:!0,filterCodecsInSdpV2:!1,reduceRtcpFbInSdp:[],reduceRtcpFbInSdpMultiparty:["goog-remb","transport-cc","ccm/fir","nack","nack/pli"],subscribeToSsrcForVideo:!1,audioRendererUsePauseOnDetach:!0,audioRendererRestartOnPause:!1,audioRendererRestartOnDeviceError:!0,disableAudioOutputSelection:!1,preferSdesSrtp:!1,preferSdesSrtpPstn:!1,useLocalStorageForOneDs:!0,useOneDsLogger:!1,useSendBeaconSync:!1,addTelemetryReportingCallback:!0,eventsLimitInMem:200,eventLatency:XE.Normal,eventLatencyRealTime:XE.RealTime,enableCompoundKey:!1,telemetryTenants:{signaling:"53fdaa090eb946b5a1d6cbdeb4f2ef66-bcbf6380-2590-41cc-ae60-9e467cd51835-7413",media:"1cae5691997646c98b01d15beddae7a3-ce16e198-bc32-420f-ac64-42bb916111af-6865",realtimeMedia:"5aea257f81424f5d8574e57a50974ead-d3a768ce-590c-4595-ab85-3dd046114290-6701",tlePlayer:"2efdf03d07594586a5977c404e185186-71b046c4-f48f-4ba7-96d3-2a74b54e1d46-7326"},transmitProfileName:"REAL_TIME",transmitProfileTimings:[],waitReportStatsAtCallStop:!1,oneStreamPerDeviceType:!1,enableWebRtcInternalsLogs:!1,enableMultiViewStats:!0,webrtcBWJumpLowerLimit:1e5,webrtcBWJumpUpperLimit:3e5,uplinkBWStabilizationSlidingWindowSize:10,uplinkBWStabilizationMaxDeviation:.1,uplinkBWStabilizationMinBandwidth:1e5,downlinkBWStabilizationSlidingWindowSize:10,downlinkBWStabilizationMaxDeviation:.1,downlinkBWStabilizationMinBandwidth:1e5,maxKeyFrameTimestampsInBucket:5,enableAudioSharing:!1,enableStopSharingWithIncomingOffer:!0,enableDevtoolsAPI:!1,enableDataChannel:!1,enableDataChannelMultiparty:!0,enableDataChannelPstn:!1,alwaysNegotiateDataChannel:!0,webrtcDataChannel:{enableFragmentation:!1,fragmentationSize:0,enableSendScheduler:!1,rateLimiterCheckInterval:250,discardOnSendFailure:!1,bufferedAmountLowThreshold:65535,bufferedAmountHighThreshold:262144,maxBitrate:0,maxPacketRate:0,maxQueueSize:524288,dataIds:[]},acceptDisabledDataModality:!0,rejectUnbundledDataModality:!0,sctpPort:5e3,enableGiveControl:!1,maxStoredDataChannelValues:15,mediaControlPlaneConfig:{enableBweNotifications:!0,enableDominantSpeakerHistory:!0,enableSourceRequests:!1,sourceRequestsMessagesTimeout:1e4,storedSRRecordsCount:60,verboseTelemetry:!1,sendDuplicates:!1},localPreviewMirroringSupported:!1,enableVideoEffects:!0,useRawMediaApiForVideoEffects:!1,forceKeyFrameV2ScaleFactor:1.1,effectsTelemetryBufferSize:20,useGenericWorkerLoader:!1,wasmdns:{pTime:10,goodPerfThreshold:8,poorPerfThreshold:10,badPerfThreshold:12,perfWindowLength:10,enableNoiseSuppression:!1,noiseSuppressionMode:"Off",backgroundMode:!1},wasmvqe:{enableAec:!1,enableVqe:!1,backgroundMode:!1,performanceThresholdMs:8,performanceWindowDurationSecs:10,defaultVqeMode:Qh.VqeMode.Off,callType:Qh.CallType.Conference,audioUsageMode:Qh.AudioUsageMode.Default,performanceProfile:Qh.AecPerfProfile.Normal},webcv:{qualityConfig:{outputFps:{min:15,max:30},outputResolution:720,preserveResolution:!0,degradationLadder:[{resolution:{width:1920,height:1080},fps:{min:15,max:30}},{resolution:{width:1280,height:720},fps:{min:15,max:30}},{resolution:{width:960,height:540},fps:{min:15,max:30}},{resolution:{width:640,height:360},fps:{min:13,max:30}},{resolution:{width:416,height:234},fps:{min:10,max:20}},{resolution:{width:320,height:180},fps:{min:10,max:20}}],initialLadderResolution:720,improvementFpsThresholdPercent:20,statsIntervalSec:5,enableMaskPropagation:!1,maskPropagationFramesInterval:30},powerPreference:Yh.PowerPreference.HighPerformance,useInsertableStreams:!1,webGLUnsupportedRenderers:["Google SwiftShader"],webGLRequiredExtensions:["EXT_color_buffer_float","WEBGL_debug_renderer_info","OES_texture_float_linear"],usePreheat:!1,useSharedArrayBuffer:!0,useWasmEffects:!1,processorType:Yh.ProcessorType.Webgl2},insertFakeCandidateIfNeeded:!0,useSdpCapabilitiesLegacySession:!0,useSdpCapabilities:!0,enableH264SpsPpsIdrKeyframe:!0,disableMsSdp:!1,disableSdes:!1,disableIceReinvite:!1,iceDisconnectedTimeoutMs:3e4,enableLocalVideoConstraints:!0,webrtcAudioChannelSignalingFeedback:"app recv:dsh",webrtcVideoChannelSignalingFeedback:"app send:src recv:src,vc",webrtcResolutionManagerCooldownTimeout:15e3,webrtcResolutionManagerRetryDelay:5e3,webrtcNativeCpuOveruseDisabled:!1,webrtcDisplayStreamContentHint:"text",h264SendProfileOverride:"42C02A",addFmtpToInitialSubscription:!0,h264SubscribeProfile:"64001f",notRenderingTimeInterval:{video:3,sharing:10},notRenderingLowBitrateThreshold:6,notRenderingLowFramerateThreshold:3,isBytesRecvUsedInIsRenderingCalculation:!0,useConnectionState:!0,useDtlsTrasportConnectionCheck:!1,enableNetworkRecvQualityUFD:!0,enableNetworkSendQualityUFD:!0,enableSignalingAudioPermissionDeniedUFD:!1,webrtcJitterLowThreshold:.2,webrtcJitterHighThreshold:.35,webrtcJitterSticknessTime:5e3,webrtcLossRateLowThreshold:.2,webrtcLossRateHighThreshold:.3,webrtcLossRateSticknessTime:5e3,webrtcMinPacketsSentForNetworkSendQuality:200,webrtcLossRateWindowSize:3,webrtcJitterWindowSize:3,networkSendQualityDiagnostics:!1,networkRecvQualityDiagnostics:!1,webrtcJitterExtendedWindowSize:6,webrtcLossRateExtendedWindowSize:6,freezeMinDuration:128,freezeIntervalFrequency:1e3,minPacketsReceivedToCalculatePacketLossRate:100,healedRatioPrecision:8,jitterPrecision:3,requestNewStreamOnUnmute:!0,raiseVideoMuteUfd:!1,useMediaQualityController:!1,useMediaQualityControllerForceKeyFrame:!1,layoutControlTimeout:1e4,extmapAllowMixed:!1,enableVla:!1,allowRemoteVla:!1,enableNonAdvVla:!1,specCompliantSimulcast:{},specCompliantSimulcastMultiparty:{video:{enableLocally:!1,allowEnableRemotely:!1,layerScaleFactors:[1],minFsForSimulcast:920,useApplyConstraints:!1},sharing:{enableLocally:!1,allowEnableRemotely:!1,layerScaleFactors:[1]},allowOverride:!1,constraintsDisableVla:!0,collectResolutionInfo:!0,maxBrControlEnabled:!1,allowedBweOvershootRatio:1,allowResLimit:!1},enforceOpusFmtpMultiparty:{usedtx:1},videoIsRenderingCheck:!1,fixSdpForPartialIceRestart:!1,mapSsrcToTrackForStats:!1,enableVideoOrientationExtension:!1,speakerGainLevel:0,ignoreClosedDtlsTransportState:!1,disconnectOnPageHide:!0,renderThroughCanvas:!1,isRenderingBasedOnRawStatistics:!1,enableDevicePixelRatio:!0,useSetParametersToApplyCapabilities:!1,enablePlatformCallConstraints:!1,enablePlatformCallConstraintsPerCall:!1,enableDynamicCallConstraints:!0,numCallConstraintsEvents:6,setParametersMaxBitrateUndefined:!1,onAddTrackRemoveOtherTracks:!0,avoidFakeStreamsDuringEscalation:!0,navConnectionPollingInterval:1e3,navConnectionNumSamplesToCollect:60,allowProvisionalAnswer:!1,allowProvisionalAnswerPstn:!0,acceptProvisionalAnswerFromPstnOnly:!0,disableIncomingDtlsRoleOverride:!1,disableOutgoingDtlsRoleOverride:!1,statsAllowAnyVideoSendTrack:!1,pictureInPicture:{enablePictureInPicture:!1,aspectRatioHorizontal:16,aspectRatioVertical:9,maxActiveStreams:1,minStreamGridCellWidth:160,dominantStreamChangeDebounce:3e3,statisticsBufferSize:20,multiStreamWorkerURL:""},showStatsInCall:!1,useSetStreamsForSender:!0,addPrefixForMsidInSdp:!1,enableMuteSpeakerUnmuteSpeakerWorkaround:!1,alwaysRaiseBadDeviceEvents:!1,removeRecvStreamOnEnded:!0,requiredVideoCodecs:["h264"],primaryVideoCodecs:["h264","vp8","vp9"],removeUnsupportedVideoModality:!1,enableActiveSpeakerBasedDSH:!0,enableInitialSignalingDSHSubscription:!0,enableSignalingDSHFallback:!1,emptyInitialDSH:!0,bwPercentiles:[5,50,95],enableTimerTracker:!1,diagnostics:{sideBySide:!0,useForTelemetry:!1,collectWhileNotConnected:!1,collectionLimits:{numDeviceEvents:200,numVideoEffectsEvents:100,numAudioEffectsEvents:100,numOvershootEvents:100,numIsRenderingEvents:100,numStatsReports:600,numStatsErrors:100,numSubscriptionEvents:100,numUFDs:100,numNativeSessions:3,numSessions:3,numNetworkEvents:50,numReconnects:50,numCapabilitiesRequested:60,numCapabilitiesApplied:60,maxVideoStatsAfterSubscription:30,numResolutionSwitches:10,numSamplesForE2E:4},telemetryLimits:{numDeviceEvents:50,numVideoEffectsEvents:50,numAudioEffectsEvents:50,numOvershootEvents:20,numIsRenderingEvents:4,numPreferredResolutions:3,numSubscriptionEvents:100,numUFDs:50,numAggregatedSamples:60,numStatsErrors:20,numCapabilitiesRequested:5,numCapabilitiesApplied:3,maxVideoStatsAfterSubscription:30,numNetworkEvents:20,numReconnects:10,numRendererStateChangedEvents:10},teamsRealtimeTelemetry:{pollingInterval:15},performanceMonitoring:{useComputePressure:!1,fluctuationSamplesNum:5,enableRemoteVideoCalculator:!1,enableLowerResolution:!1,monitoringStrategy:"decodeTime",decodeThresholds:{1080:{fps:30,maxDecodeTime:20},720:{fps:30,maxDecodeTime:15},540:{fps:30,maxDecodeTime:11},360:{fps:30,maxDecodeTime:9},234:{fps:15,maxDecodeTime:10},180:{fps:15,maxDecodeTime:10}},defaultThrehold:{fps:30,maxDecodeTime:60},fpsDiffThresholds:{1080:{fps:30,fpsDiff:4},720:{fps:30,fpsDiff:4},540:{fps:30,fpsDiff:4},360:{fps:30,fpsDiff:4},234:{fps:15,fpsDiff:2},180:{fps:15,fpsDiff:2}},defaultFpsDiffThreshold:{fps:30,fpsDiff:10},volatilityThresholds:{1080:10,720:10,540:10,360:10,234:5,180:5},defaultVolatilityThreshold:10,remoteVideoTrackInterval:10,telemetryResolutionRequestSpanMs:5e3,cpuMetricCollector:3},features:{takeFreezeTelemetryFromGathererV2:!0,useLastSampleDeltaPerSecondConverter:!1,useNewerStatisticsMetrics:!1,useNewNetworkUFD:!1,useNewSpeakingWhileMutedUFD:!1,useNewSendBandwidthCalculation:!1,useNewStatsForLocalVideoStreamWatcher:!1}},requireUserActionForAudioSharing:!1,postponeAudioMixerForAudioSharing:!1,reassignMediaStreamAudioTrackAfterCreation:!1,deactiveAudioSender:!1,webrtcForceSdesForS1:!1,webrtcPranswerWaitForMediaPollingInterval:1e3,webrctRemoveVideoModalitiesForPstn:!1,removeSendersOnConfigureModalities:!0,streamAvailabilityConsiderModalities:!0,setBWSeed:!1,bwSeedOptions:{mids:["*"],aggregation:"const",aggregateLastN:null,constValue:-1,minValue:-1,cappingValue:-1,useLocalStorage:!1,localStorageKey:"bwSeed"},stopCallOnAcceptFailure:!0,allowMediaBypass:!0,enablePermissionsWorkaround:!1,disposeSendersSync:!1,disposeStreamsSync:!1,maxVideoStatsAfterSubscription:30,ecsConfigTimeout:2e4,contributingSourcesLogInterval:1e4,useNewTokenApi:!1,audioRendererFailedReconnectTimes:0,audioRendererFailedRetryCodes:[3],effectsApplyConstraintsRetryMs:1e3,isSpotlightEnabled:!0,addAudioStreamBeforeConnection:!1,redReceiveEnabled:!1,mediaEventDictionary:tt.MEDIA_EVENT_FIELDS,useSenderV2:!0,applySenderParamsBeforeStart:!0,reuseLastSetParameters:!1,hevcCodecs:["hev1.1.6.L120.90","hev1.1.4.L93.B0","hev1.1.6.L93.B0"],useInactiveAudioTrack:!1,enableRollbackHandler:!1,disableImmidiateEscalationReconnect:!1,enableCachingFMTP:!0,setDisconnectAfterCleanUp:!1,sendResolutionTableOverride:tt.RES_TABLE.SEND,recvResolutionTableOverride:tt.RES_TABLE.RECV,maxSendVideoCapabilitiesReportingForVideoEnabledMultiparty:!0,participantStreamInitialSubscriptions:!0,holdRetryActivationDelay:-1,holdSkipActivation:!0,recoverOnStreamUnmute:!1,isAv1Allowed:!1,audioSharingMemoryLeakFix:!0,h264SdpProfileMultiparty:"64001f",rejectIncompatibleOriginator:!1,coeffOfValidTimeDelayBetweenFramesArrival:2,invalidFPSAboveMax:40,useWakeLockApi:!1,noRequiredCodecsWorkaround:!1,vdiDisconnectedTracking:{enabled:!0,clientPhrases:["failure"]},multiStreamSupported:!1,nonMultiStreamChannels:9,useTokenMigrationHeader:!1,clientSupportsAadToken:!1,clientSupportsCaeToken:!1,clientSupportsSkypeToken:!0,supportMissingTokenTypesInResponse:!0,useSkypeTokenWhenNoAuthenticateHeader:!1,useKeyFrameApi:!1}}getEnforcedSettings(){return{}}},hI=class extends cI{getInitialSettings(){const e=super.getInitialSettings();return e.oneStreamPerDeviceType=!0,e.removeUnsupportedVideoModality=!0,e}},uI=class extends cI{constructor(){super()}getEnforcedSettings(){return{useAudioAnalyzer:!1,enableAudioSharing:!1}}},pI=class extends hI{constructor(e){super(),this.browserInfo=e}getEnforcedSettings(){const e={webrtcSimulcastSessionEnabled:!0,webrtcAllowRestoreKeyframe:!0,permissions:{usePositiveInAdp:!1,useNegativeInAdp:!1,adpFallback:!0,adpFallbackAudio:!0,adpFallbackVideo:!1,adpRequestAVLast:!1,rememberNegative:!1},devices:{pollingIntervalIdle:1e4},audioRendererRestartOnPause:!0,subscribeToSsrcForVideo:!0,noRequiredCodecsWorkaround:!0};return em(this.browserInfo.version,"15.0")||(e.statsAllowAnyVideoSendTrack=!0),em(this.browserInfo.version,"16.0")&&"Mobile"===this.browserInfo.formFactor&&(e.enablePermissionsWorkaround=!0),em(this.browserInfo.version,"17.0")&&"Mobile"===this.browserInfo.formFactor&&(e.recoverOnStreamUnmute=!0),e}},gI=class extends hI{getEnforcedSettings(){return{webrtcSimulcastSessionEnabled:!0,webrtcAllowRestoreKeyframe:!0,useDtlsTrasportConnectionCheck:!0,videoIsRenderingCheck:!1,fixSdpForPartialIceRestart:!0,mapSsrcToTrackForStats:!0,ignoreClosedDtlsTransportState1on1:!0,subscribeToSsrcForVideo1on1:!0,devices:{enumerateDevicesTimeout:0,pollingIntervalIdle:1e4,idlePollingOnStart:!0},webrtcInjectTransportCCAudioMultiparty:!1,videoCaptureFreezeTimeout:0,filterCodecsInSdp:!0,useSetParametersToApplyCapabilities:!0,removeRecvStreamOnEnded:!0,webrtcDisabledSenderBitrate:0,disableAudioOutputSelection:!0}}},mI=class extends cI{constructor(){super()}getEnforcedSettings(){return{checkSupportForWebrtc_1_0:!0,requireUserActionForAudioSharing:!0,webrtcSimulcastSessionEnabled:!0,webrtcAllowRestoreKeyframe:!0,useAudioAnalyzer:!1,enablePlatformCallConstraints:!0,specCompliantSimulcastMultiparty:{video:{layerScaleFactors:[1,2],enableLocally:!0,allowEnableRemotely:!0,useApplyConstraints:!1,minFsForSimulcast:920},maxBrControlEnabled:!0,allowResLimit:!0,allowOverride:!0},extmapAllowMixedMultiparty:!0,enableVlaMultiparty:!0,allowRemoteVlaMultiparty:!0,enableNonAdvVlaMultiparty:!0,useMediaQualityControllerMultiparty:!0,useSdpCapabilities:!1}}},fI=class extends hI{constructor(e){super(),this.browserInfo=e}getEnforcedSettings(){const e={};return em(this.browserInfo.version,"74.0")&&(e.webrtcSimulcastSessionEnabled=!0,e.webrtcAllowRestoreKeyframe=!0,e.enableAudioSharing=!0),"RoomAudioProcessing"===this.browserInfo.formFactor&&(e.defaultAudioProcessingFlags=0,e.wasmvqe={enableAec:!1,enableVqe:!1,backgroundMode:!1},e.wasmdns={enableNoiseSuppression:!1,backgroundMode:!1}),"CiscoOS"===this.browserInfo.name&&(e.waitReportStatsAtCallStop=!0),"Mobile"===this.browserInfo.formFactor&&(e.enableAudioSharing=!1,e.audioRendererFailedReconnectTimes=3,e.devices={pollingIntervalIdle:1e4}),"SamsungTV"===this.browserInfo.name&&(e.useSetParametersToApplyCapabilities=!0),em(this.browserInfo.version,"98.0")&&"Desktop"===this.browserInfo.formFactor&&(e.specCompliantSimulcastMultiparty={video:{layerScaleFactors:[1,2],enableLocally:!0,allowEnableRemotely:!0,useApplyConstraints:!0,minFsForSimulcast:920},maxBrControlEnabled:!0,allowResLimit:!0},e.extmapAllowMixedMultiparty=!0,e.enableVlaMultiparty=!0,e.allowRemoteVlaMultiparty=!0,e.enableNonAdvVlaMultiparty=!0,e.useMediaQualityControllerMultiparty=!0),em(this.browserInfo.version,"100.0")&&(e.redReceiveEnabledMultiparty=!0),e.webcv={useWasmEffects:!0,processorType:Yh.ProcessorType.Wasm},e}},SI=class{constructor(e){this.settings=e,this.isTransportUnbundled=!1,this.webrtcRejectedFeatures="",this.webrtcRequiredFeatures="",this.spatialAudioEnabled=!1,this._maxBandwidthInKbps=0,this._noiseSuppressionMode="Auto",this._enableMediaBypass=!1,this.audioContext={enabledLocally:!1,disabledRemotely:!1,enabledForSend:!1,initFailed:!1,initSendFailed:!1,codec:"None",lastUsedCodec:"None"}}setMediaConfiguration(e,t){this.maxBandwidthInKbps=Math.floor((e.maxBandwidthInBps||0)/1e3),this.isTransportUnbundled=this.settings.forceUnbundledTransport||this.settings.enableQosSupport&&(e.enableMediaQoS||!!e.mediaPortRanges),this._mediaPortRanges=e.mediaPortRanges,this.simulcastSessionEnabled=this.settings.webrtcSimulcastSessionEnabled&&Qg(this.settings.checkSupportForWebrtc_1_0),this._noiseSuppressionMode=e.noiseSuppressionMode||"Auto",this._enableMediaBypass=this.settings.allowMediaBypass&&e.enableMediaBypass,this.webrtcRejectedFeatures=this._enableMediaBypass?"":this.settings.webrtcRejectedFeatures,this.webrtcRequiredFeatures=this._enableMediaBypass?"":this.settings.webrtcRequiredFeatures,this.spatialAudioEnabled=t?t.spatialAudioEnabled:e.enableSpatialAudio}get mediaBypassEnabled(){return this._enableMediaBypass}get noiseSuppressionMode(){return this._noiseSuppressionMode}get maxBandwidthInKbps(){return this._maxBandwidthInKbps}set maxBandwidthInKbps(e){this._maxBandwidthInKbps=e,this.settings.maxBandwidthInKbps&&(this._maxBandwidthInKbps=Math.min(this.settings.maxBandwidthInKbps,this._maxBandwidthInKbps||Number.MAX_SAFE_INTEGER))}get audioPortRange(){if(this.isTransportUnbundled&&this._mediaPortRanges&&this._mediaPortRanges.audioMin&&this._mediaPortRanges.audioMax)return{min:this._mediaPortRanges.audioMin,max:this._mediaPortRanges.audioMax}}get videoPortRange(){if(this.isTransportUnbundled&&this._mediaPortRanges&&this._mediaPortRanges.videoMin&&this._mediaPortRanges.videoMax)return{min:this._mediaPortRanges.videoMin,max:this._mediaPortRanges.videoMax}}get audioCodecContext(){return this.settings.useInsertableStreams?.audioWasmCodec?.enable?this.audioContext:void 0}};function vI(e,t){if(Array.isArray(e))return t.slice()}var yI=class extends Qe{constructor(e,t,i={}){super(e),this.logger=e,this.platformCallConstraintsProvider=t,this.platformConfig=function(){const e=li();return"ChromiumAVD"===e.engine?new uI:"Safari"===e.engine?new pI(e):"Firefox"===e.name?new gI:Sg()?new mI:"Chromium"===e.engine?new fI(e):new cI}(),this.sessionCount=0,this._consoleOverrides={},this.uaConfig=new Cg(this),this.mediaConfiguration={},this.configReceivedDefer=um(),this.initialSettings=(0,Gm.mergeWith)({},(0,Gm.cloneDeep)(this.platformConfig.getInitialSettings()),(0,Gm.cloneDeep)(i),this.platformConfig.getEnforcedSettings(),vI),this.settings=this.initialSettings,this.settingsWithoutOverrides=this.initialSettings,this.stackSettings=(0,Gm.cloneDeep)(i),this.mediaSettings=new SI(this.settings),this.platformCallConstraintsProvider.changed((()=>{this.updateSettings();const e=this.platformCallConstraintsProvider.constraints,t=this.logger.createChild("SettingsToCallConstraintsConverter"),i=Km(t,this.settings,e);this.platformCallConstraintsProvider.addCallConstraintsTelemetryEvent(i,"applied")})),this.configReceivedTimeout=window.setTimeout((()=>{this.configReceivedTimeout=void 0,this.configReceivedDefer.resolve()}),this.settings.ecsConfigTimeout),this.logger.safe.info("Initialized")}getCallConstraints(){return this.platformCallConstraintsProvider.constraints}setCallConstraints(e){return this.platformCallConstraintsProvider.setConstraints(e),e}getCallConstraintsTelemetry(){return this.logger.error("Not supported globally, returning empty array"),[]}addCallConstraintsTelemetryEvent(e,t){this.logger.error("Not supported globally")}getIceTransportPolicy(){return this.logger.warn(`Not supported globally, returning default ${tt.ICE_TRANSPORT_POLICY.all}`),tt.ICE_TRANSPORT_POLICY.all}setIceTransportPolicy(e){this.logger.error("Not supported globally")}getConfigReceivedOrTimeout(){return this.configReceivedDefer.promise}getConfigView(e,t){const i=e?"Multiparty":"1on1",n=Object.entries((0,Gm.cloneDeep)(this.settings)).reduce(((e,[t,n])=>(e[t]=n,t.endsWith(i)&&(e[t.replace(i,"")]=n),e)),{}),r=new SI(n);return r.setMediaConfiguration(this.mediaConfiguration,t?.mediaConfig),new of(this.logger.createChild("ConfigProviderView"),n,r,this.userAgentConfig,this.countryCode,this.platformCallConstraintsProvider,t?.getCallConstraints())}updateConfig(e,t,i,n){this.etag=t||this.etag,this.configIds=i||this.configIds,this.country=n||this.country,this.event("newConfigReceived").raise(e,t,i),this.settingsWithoutOverrides=(0,Gm.mergeWith)({},this.settingsWithoutOverrides,e,vI),this.updateSettings(),this.configReceivedTimeout&&(window.clearTimeout(this.configReceivedTimeout),this.configReceivedTimeout=void 0),this.configReceivedDefer.resolve()}updateSessionCount(e){this.sessionCount=e,0===e&&this.pendingSettings&&(this.logSettings("Applying pending configuration",this.pendingSettings),this.updateSettings(this.pendingSettings),this.pendingSettings=null),e>0&&this.configReceivedTimeout&&this.configReceivedDefer.resolve()}get config(){return this.settings}get stackConfig(){return this.stackSettings}get consoleOverrides(){return this._consoleOverrides}get defaultConfig(){return this.initialSettings}get userAgentConfig(){return this.uaConfig}get countryCode(){return this.country}setMediaConfiguration(e){this.mediaConfiguration=e,this.mediaSettings.setMediaConfiguration(e)}get mediaConfig(){return this.mediaSettings}get ETag(){return this.etag}get ecsConfigIds(){return this.configIds}setConsoleOverrides(e){this._consoleOverrides=(0,Gm.mergeWith)({},this._consoleOverrides,e,vI),this.updateSettings()}setConsoleOverride(e,t){this._consoleOverrides[e]=t,this.updateSettings()}clearConsoleOverride(e){delete this._consoleOverrides[e],this.updateSettings()}clearAllConsoleOverrides(){this._consoleOverrides={},this.updateSettings()}updateSettings(e=this.settingsWithoutOverrides){if(this.sessionCount>0)return this.pendingSettings=e,void this.logSettings("pendingSettings updated",e);this.settings=this.mergeSettings(e),this.event("configUpdated").raise(),this.logSettings("Settings updated",this.settings)}logSettings(e,t){const i=Object.entries(t).reduce(((e,[t,i])=>(i!==this.initialSettings[t]&&(e[t]=i),e)),{});this.logger.safe.info(`${e}: ${JSON.stringify(i)}`)}mergeSettings(e){if(!e.enablePlatformCallConstraints&&!this._consoleOverrides.enablePlatformCallConstraints)return this.mergeSettingsWithConsoleOverrides(e);let t=e;const{setConsoleOverridesBeforeCallConstraints:i}=this._consoleOverrides;return i&&(t=this.mergeSettingsWithConsoleOverrides(t)),t=this.mergeSettingsWithPlatformConstraints(t),i||(t=this.mergeSettingsWithConsoleOverrides(t)),t}mergeSettingsWithConsoleOverrides(e){return this.logger.safe.info(`Merging settings with console overrides: ${Ge(this._consoleOverrides)}`),(0,Gm.mergeWith)({},e,this._consoleOverrides,vI)}mergeSettingsWithPlatformConstraints(e){const t=this.platformCallConstraintsProvider.getSettings(e);return this.logger.safe.info(`Merging settings with platform call constraints: ${Ge(t)}`),(0,Gm.assign)({},e,t,vI)}},CI=class{constructor(e,t){this.streamClient=e,this.logger=t,this.rawBaseClient=new hp((()=>this.getStream()),(()=>this.activeRawInputMediaStreamClient?.dispose()),t)}client(){return this.rawBaseClient}disposeActiveMediaStreamClient(){this.logger.info("Disposing active media stream client"),this.activeRawInputMediaStreamClient?.dispose("Disposed by RawDeviceStreamManager"),this.activeRawInputMediaStreamClient=null}async getStream(){return this.activeRawInputMediaStreamClient?.originalMediaStream?.active?(this.logger.info("Returning stream from active mediaStreamClient"),this.activeRawInputMediaStreamClient.originalMediaStream):(this.activeRawInputMediaStreamClient=await this.streamClient(),await this.activeRawInputMediaStreamClient.start(),this.activeRawInputMediaStreamClient.originalMediaStream)}},TI=class{constructor(e,t){this.logger=e,this.raiseTelemetryEvent=t,this.handlerMap=new Map([["Audio",new Map],["Video",new Map],["ScreenShare",new Map]])}dispose(e){this.logger.info(`disposing IRawStream ${e}`),this.handlerMap.get(e).forEach((e=>e.client().dispose()))}disposeAll(){this.logger.info("Dispose All clients"),this.handlerMap.forEach((e=>e.forEach((e=>e.client().dispose()))))}notifyChange(e){this.handlerMap.get(e).forEach((e=>{e.disposeActiveMediaStreamClient(),e.client().notifyStreamChange()}))}createIRawStreamClient(e,t){this.logger.info(`Create new IRawStream client for ${t}`);const i=new CI(e,this.logger);return this.handlerAdded(i,t),i.client()}handlerAdded(e,t){const i=e.client();this.setClientSubscription(i,t),this.handlerMap.get(t).set(i.clientId,e)}deleteRawStreamManagerById(e,t){this.logger.info(`Deleting from map: ${t}`),this.handlerMap.get(t).delete(e)}setClientSubscription(e,t){this.logger.info(`Setting subscription on IRawStream client for ${t}`),e.on("clientDisposed",(i=>{this.deleteRawStreamManagerById(e.clientId,t),this.raiseTelemetryEvent("IRawStream_client_disposed",{mediaType:t,clientId:i})})),e.on("rawStreamRequested",(e=>{this.raiseTelemetryEvent("IRawStream_media_stream_changed",{mediaType:t,clientId:e})})),e.on("notifiedOnStreamChanged",(e=>this.raiseTelemetryEvent("IRawStream_media_stream_changed",{mediaType:t,clientId:e})))}},EI=class extends Qe{constructor(e,t){super(e),this.logger=e,this.configProvider=t,this.window=yg.window,this.isMuted=!1,this.isPlayingAllowed=!1,this.hadPlaybackError=!1,this.audioContext=null,this.sourceNode=null,this.gainNode=null,this.onAudioError=e=>{const t=e&&e.target||this.audio;if(this.hadPlaybackError=!0,t?.error){const e=t.error.code,i=`error with rendering audio code: ${e}, message: ${t.error.message}`;this.event("onAudioPlaybackError").raise(e,tt.MEDIA_ERROR.audioPlaybackError,i),this.logger.safe.error(i)}else this.logger.safe.error("error with audio rendering")},this.onAudioPaused=async()=>{if(this.configProvider.config.audioRendererRestartOnPause&&this.canPlay&&!this.isMuted){const e=Re();this.logger.safe.info(`[${e}] audio playback is paused by OS, resuming it`),await this.startStream(e)}}}get muted(){return this.isMuted}async setMuted(e,t){return this.isMuted=e,e?this.stopStream(t):this.startStream(t)}get canPlay(){return this.stream&&this.isPlayingAllowed}getStream(){return this.stream}getDeviceId(){return this.deviceId}async play(e){if(this.stream=e,this.isPlayingAllowed=!0,!this.isMuted)return this.startStream()}stop(){this.stopStream(),this.isPlayingAllowed=!1}async setOutputDevice(e,t=Re()){if(this.audio)if(this.configProvider.config.disableAudioOutputSelection)this.logger.safe.warn(`[${t}] audio-output selction is disabled, disableAudioOutputSelection: true`);else if(this.audio.setSinkId){if(e){this.logger.safe.info(`[${t}] setting audio output device ID to ${ke(e)}`),this.deviceId=e;try{await this.audio.setSinkId(e)}catch(e){this.logger.safe.warn(`[${t}] setSinkId operation was aborted with error ${Ge(e)}`)}this.configProvider.config.audioRendererRestartOnDeviceError&&this.hadPlaybackError&&!this.isMuted&&(this.logger.safe.info(`[${t}] audio playback error happened, restarting audio stream on new device`),await this.startStream(t),this.hadPlaybackError=!1)}}else this.logger.safe.warn(`[${t}] setting output device is not supported`);else this.deviceId=e}dispose(){this.logger.safe.info("dispose"),super.dispose(),this.audio&&(this.stop(),this.stream=null,this.audio.removeEventListener("error",this.onAudioError),this.audio.removeEventListener("pause",this.onAudioPaused),this.window.document.body.removeChild(this.audio),this.event("onAudioElementRemoved").raise(this.audio),this.audio=null),this.detachGainNode()}async startStream(e=Re()){if(this.canPlay)try{await this.assureAudioElement(e),this.logger.safe.info(`[${e}] attaching stream to renderer: ${this.stream?.id}`),this.configProvider.config.speakerGainLevel&&this.reattachToGainNode(this.stream,this.configProvider.config.speakerGainLevel),this.audio.srcObject=this.stream,await this.audio.play()}catch(t){this.logger.safe.warn(`[${e}] play operation was aborted with error ${Ge(t)}`)}}async assureAudioElement(e=Re()){if(!this.audio)return this.logger.safe.info(`[${e}] creating audio element`),this.audio=this.window.document.createElement("audio"),this.audio.addEventListener("error",this.onAudioError),this.audio.addEventListener("pause",this.onAudioPaused),this.window.document.body.appendChild(this.audio),this.audio.autoplay=!0,this.event("onAudioElementAdded").raise(this.audio),this.setOutputDevice(this.deviceId,e)}stopStream(e=Re()){this.audio&&this.canPlay&&(this.detachGainNode(),this.logger.safe.info(`[${e}] detaching stream from renderer: ${this.stream?.id}`),this.configProvider.config.audioRendererUsePauseOnDetach?this.audio.pause():this.audio.srcObject=null)}attachToGainNode(e,t){this.audioContext=new yg.window.AudioContext,this.sourceNode=this.audioContext.createMediaStreamSource(e),this.gainNode=this.audioContext.createGain(),this.gainNode.gain.value=t,this.sourceNode.connect(this.gainNode),this.gainNode.connect(this.audioContext.destination)}detachGainNode(){this.sourceNode?.disconnect(),this.sourceNode=null,this.gainNode?.disconnect(),this.gainNode=null,this.audioContext?.close(),this.audioContext=null}reattachToGainNode(e,t){this.detachGainNode(),this.attachToGainNode(e,t)}},_I=class{constructor(e){this.logger=e,this.queue=Promise.resolve()}add(e,t=Re()){let i;i=e instanceof Mu?()=>e.promise:e;const n=this.queue.then(i);return this.queue=n.catch((e=>{if(this.queue){let i="";e instanceof TypeError&&(i=e.stack),this.logger.safe.error(`[${t}] Error from promiseQueue! ${Ge(e)} ${i}`)}})),n}dispose(){this.queue=null}},bI=i(496486),PI=class{constructor(e){this.container=e,this.formatRegexPattern=new RegExp(/{(\d+)}/g),this.elements={},this.previousSamples={},this.overlayToggled=!0,this.createTableCell=(e,t,i)=>{this.elements[e]=document.createElement("td"),this.elements[e].title=e,this.addElementStyle(e,i),this.elements[t].appendChild(this.elements[e])},this.topElement=e.ownerDocument.createElement("div"),this.topElement.classList.add("vdi-occlusion"),this.topElement.style.position="absolute",this.topElement.style.top="0px",this.topElement.style.left="0px",this.topElement.style.zIndex="100",this.topElement.style.transform="inherit",this.topElement.style.backgroundColor="rgba(0, 0, 0, 0.25)",this.topElement.style.pointerEvents="all",this.topElement.style.minWidth="15px",this.topElement.style.minHeight="15px",this.topElement.style.cursor="pointer",this.topElement.onclick=()=>{this.overlayToggled=!this.overlayToggled},this.container.appendChild(this.topElement),this.table=document.createElement("table"),this.table.style.borderCollapse="collapse",this.table.style.fontSize="smaller",this.topElement.appendChild(this.table)}dispose(){this.topElement.removeChild(this.table),this.container.removeChild(this.topElement),this.table=null,this.topElement=null,this.container=null}createTableColumn(e,t){if(this.overlayToggled)for(const i of Object.keys(e)){const n=e[i];n.hideUndefined&&n.values.every((e=>!e))||this.createTableRow(i,n,t)}}createTableRow(e,t,i){this.elements[e]||(this.elements[e]=document.createElement("tr"),this.table.appendChild(this.elements[e]));const n=`${e}-title`,r=`${e}-${i}`,s=this.formatValue(t),a=this.previousSamples[r]!==s;this.previousSamples[r]=s;const o=function(e){const{values:t,lowerThreshold:i,upperThreshold:n,highlightUndefined:r,fixedValueThreshold:s,allowedDeviationThreshold:a}=e;for(const e of t){if(void 0===e&&null===e&&r)return!0;if(s&&s!==e)return!0;if(null==e||!(0,bI.isNumber)(e))return!1;if(i&&Number(e)<=i)return!0;if(n&&Number(e)>=n)return!0;if(a){const i=(0,bI.mean)(t),n=i*a;if(Math.abs(Number(e)-i)>n)return!0}}return!1}(t)||!(!t.highlightChange||!a);this.elements[n]||(this.createTableCell(n,e,!1),this.elements[n].innerText=t.text?t.text:e),this.createTableCell(r,e,o),this.elements[r].innerText=s}clearTable(){for(;this.table.hasChildNodes();)this.table.removeChild(this.table.lastChild);this.elements={}}addElementStyle(e,t){this.elements[e].style.color=t?"#F72F35":"#FBF719",this.elements[e].style.fontSize="smaller",this.elements[e].style.lineHeight="1",this.elements[e].style.padding="0px 1px 0px 1px",this.elements[e].style.maxWidth="60px",this.elements[e].style.overflow="hidden",this.elements[e].style.whiteSpace="nowrap",this.elements[e].style.textOverflow="ellipsis"}formatValue(e){const{values:t,format:i,undefinedFallback:n="N/A"}=e;return i?i.replace(this.formatRegexPattern,((e,i)=>t[i]?t[i].toString():n.toString())):t?.length&&t[0]?t[0].toString():n.toString()}},II=class{constructor(e,t,i){this.container=t,this.renderer=i,this.subs=[],e&&!this.overlay&&(this.overlay=new PI(this.container),this.subs.push(this.renderer.on("onVideoSizeChanged",((e,t)=>this.streamSize={width:e,height:t}))),this.subs.push(this.renderer.on("onRendererSizeChanged",((e,t)=>this.rendererSize={width:Math.ceil(t.width),height:Math.ceil(t.height)}))))}setStats(e){if(!this.overlay)return;const{id:t,ssrc:i,keyFramesDecoded:n,nackCount:r,firCount:s,pliCount:a,decoderImplementation:o,packetsLost:l}=e.inboundRTP,{frameRateReceived:d,frameRateDecoded:c,bitrate:h,decodeTime:u}=e.extensions??{},p=this.renderer?.getMsi(),g=this.renderer?.getLocalMsi(),m={streamSize:{format:"{0}x{1}",values:[this.streamSize?.width,this.streamSize?.height],undefinedFallback:0},rendererSize:{format:"{0}x{1}",values:[this.rendererSize?.width,this.rendererSize?.height],undefinedFallback:0},ssrc:{values:[i]},msid:{text:"sourceId/msid",format:"{0}/{1}",values:[p,g]},fps:{text:"FPS(r/d)",format:"{0}/{1}",values:[d,c],highlightUndefined:!0,lowerThreshold:1,upperThreshold:45,allowedDeviationThreshold:.2},bitrate:{format:"{0} kbps",values:[RI(h)],lowerThreshold:24},decodeTime:{format:"{0} ms",values:[u],upperThreshold:15,highlightUndefined:!0},keyFramesDecoded:{text:"KFs",values:[n]},nacksFirsPlisSent:{text:"N/F/P",format:"{0}/{1}/{2}",values:[r,s,a],undefinedFallback:0,highlightChange:!0},packetsLost:{text:"lost",values:[l],undefinedFallback:0,highlightChange:!0},codecImplementationName:{text:"decoder",values:[o],highlightUndefined:!0}};this.overlay.clearTable(),this.overlay.createTableColumn(m,t)}dispose(){this.subs.forEach((e=>e.dispose())),this.subs=[],this.overlay?.dispose(),this.overlay=null,this.container=null,this.renderer=null}},AI=class{constructor(e,t){this.container=t,e&&!this.overlay&&(this.overlay=new PI(this.container))}setStats(e){if(!this.overlay)return;const t=e=>{const{rid:t,ssrc:i,frameWidth:n,frameHeight:r,framesPerSecond:s,keyFramesEncoded:a,nackCount:o,firCount:l,pliCount:d,encoderImplementation:c,qualityLimitationReason:h}=e.outboundRTP,{cameraOpenResolution:u,bitrate:p,encodeTime:g,frameRateEncoded:m,frameRateSent:f,qp:S}=e.extensions??{};return{rid:{values:[t],hideUndefined:!0},cameraSize:{format:"{0}x{1}",values:[u?.width,u?.height]},inputSize:{format:"{0}x{1}",values:[e.mediaSource?.width,e.mediaSource?.height]},sentSize:{format:"{0}x{1}",values:[n,r]},ssrc:{values:[i]},fps:{text:"FPS(i/e/s)",format:"{0}/{1}/{2}",values:[s,m,f],lowerThreshold:7,upperThreshold:45,allowedDeviationThreshold:.2},bitrate:{format:"{0} kbps",values:[RI(p)],lowerThreshold:24},encodeTime:{format:"{0} ms",values:[g],upperThreshold:15},keyFramesEncoded:{text:"KFs",values:[a]},qp:{values:[S]},nacksFirsPlisRecv:{text:"N/F/P",format:"{0}/{1}/{2}",values:[o,l,d],undefinedFallback:0,highlightChange:!0},codecImplementationName:{text:"encoder",values:[c],highlightUndefined:!0},qualityLimitationReason:{text:"limited",values:[h],fixedValueThreshold:"none"},bwe:{format:"{0} kbps",values:[RI(e.transport?.selectedCandidatePair?.availableOutgoingBitrate)],lowerThreshold:100}}};this.overlay.clearTable();const i=[e,...e.altLayouts??[]];for(const e of i)this.overlay.createTableColumn(t(e),e.outboundRTP.id)}dispose(){this.overlay?.dispose(),this.overlay=null,this.container=null}};function RI(e){return e&&Math.floor((e||0)/1e3)}var wI=class e extends Qe{constructor(t,i,n){const r=i.createChild(""+e.rendererId++);super(r),this.container=t,this.configProvider=n,this.video=this.container.ownerDocument.createElement("video"),this.lastNotifiedVideoWidth=0,this.lastNotifiedVideoHeight=0,this.isVideoAttached=!1,this.onVideoDataUpdated=()=>{let e=this.video.videoWidth,t=this.video.videoHeight;(e<32||t<32)&&(e=t=0),this.lastNotifiedVideoWidth===e&&this.lastNotifiedVideoHeight===t||(this.lastNotifiedVideoWidth=e,this.lastNotifiedVideoHeight=t,this.event("onVideoSizeChanged").raise(e,t)),this.video?.paused&&this.video.play()},this.onVideoError=()=>{this.logger.safe.info(`onVideoError: error with video rendering: ${JSON.stringify(this.video.error)||"no video"}`),this.event("onVideoRendererStateChanged").raise({timestamp:Date.now(),state:"onError",payload:JSON.stringify(this.video.error)||"no video"})},this.onVideoPaused=()=>{this.logger.safe.info("onVideoPaused: video playback is paused"),this.event("onVideoRendererStateChanged").raise({timestamp:Date.now(),state:"onVideoPaused"}),this.video.play()},this.onVideoPlayed=()=>{this.logger.safe.info("onVideoPlayed"),this.event("onVideoRendererStateChanged").raise({timestamp:Date.now(),state:"onVideoPlayed"})},this.onContextMenu=e=>{e.preventDefault()},this.logger=r,this.video.style.width="100%",this.video.style.height="100%",this.video.setAttribute("playsinline","true"),this.video.disablePictureInPicture=!0,this.video.autoplay=!0,this.video.muted=!0,this.attachEventListeners(),this.logger.safe.info("created")}getVideoElement(){return this.video}dispose(){super.dispose(),this.isVideoAttached&&(this.container.removeChild(this.video),this.isVideoAttached=!1),this.sizeTracker?.dispose(),this.detachEventListeners(),this.attachMediaStream(null),this.video=null,this.stream=null,this.canvas=null,this.context=null}attachMediaStream(e){this.stream!==e&&(this.stream&&(this.video.srcObject=null),e&&(this.video.hidden=0===e.getVideoTracks().length,this.video.srcObject=e,this.isVideoAttached||(this.container.appendChild(this.video),this.isVideoAttached=!0)),this.stream=e)}setScalingMode(e){this.video.style.objectFit=function(e){switch(e){case"crop":return"cover";case"stretch":return"fill";default:return"contain"}}(e)}getMediaStream(){return this.stream}getTrackId(){return this.stream?.getTracks()[0]?.id??void 0}async captureFrame(){const e=this.stream;if(!e)throw this.logger.safe.error("Mediastream not found"),new Error("Mediastream not found");const t=e.getVideoTracks?.()?.[0]?.getSettings(),i=t?.width,n=t?.height;if(!i||!n)throw this.logger.safe.error("Failed to get video track width/height"),new Error("Failed to get video track width/height");const r=this.getImageData(i,n);return{getSize:()=>({width:i,height:n}),isMirrored:()=>!1,getImageData:()=>r}}getImageData(e,t){if(this.canvas??(this.canvas=this.container.ownerDocument.createElement("canvas")),this.context??(this.context=this.canvas.getContext("2d")),!this.context)throw this.logger.safe.error("Failed to get canvas 2d context"),new Error("Failed to get canvas 2d context");return this.canvas.width=e,this.canvas.height=t,this.context.drawImage(this.video,0,0,e,t),this.context.getImageData(0,0,e,t)}attachEventListeners(){this.video.addEventListener("loadedmetadata",this.onVideoDataUpdated),this.video.addEventListener("timeupdate",this.onVideoDataUpdated),this.video.addEventListener("error",this.onVideoError),this.video.addEventListener("pause",this.onVideoPaused),this.video.addEventListener("contextmenu",this.onContextMenu),this.video.addEventListener("play",this.onVideoPlayed)}detachEventListeners(){this.video.removeEventListener("loadedmetadata",this.onVideoDataUpdated),this.video.removeEventListener("timeupdate",this.onVideoDataUpdated),this.video.removeEventListener("error",this.onVideoError),this.video.removeEventListener("pause",this.onVideoPaused),this.video.removeEventListener("contextmenu",this.onContextMenu),this.video.removeEventListener("play",this.onVideoPlayed)}};wI.rendererId=0;var MI=wI;function OI(e){return e.map((e=>new DI(e.w,e.h,e.minBr,e.maxBr)))}var DI=class{constructor(e,t,i=0,n=0){this.width=e,this.height=t,this.minBitrate=i,this.maxBitrate=n,this.fs=Math.ceil(e/tt.MACROBLOCK_SIZE)*Math.ceil(t/tt.MACROBLOCK_SIZE)}toString(){return this.height?`${this.height}p`:`${this.fs}fs`}},kI=class e{constructor(e){e||(this.resolutions=OI(tt.RES_TABLE.SEND)),this.resolutions=OI(e)}static initialize(t){e.Send=new e(t.config.sendResolutionTableOverride),e.Recv=new e(t.config.recvResolutionTableOverride),t.on("configUpdated",(()=>{e.Send=new e(t.config.sendResolutionTableOverride),e.Recv=new e(t.config.recvResolutionTableOverride)}))}get initialResolution(){return this.resolutions[this.resolutions.length-1]}getResolutionByFs(e){for(let t=this.resolutions.length-1;t>=0;t--)if(this.resolutions[t].fs<=e)return this.resolutions[t];return this.resolutions[0]}getMaxFS(e,t){return this.getResolutionRecord(e,t).fs}getResolutionForBitrate(e){let t=this.resolutions.filter((t=>t.maxBitrate&&t.maxBitrate>=e)).shift(),i=this.resolutions.filter((t=>t.minBitrate&&t.minBitrate<=e)).pop();return t=t??i,i=i??t,{lowRes:t,highRes:i}}getBitrateForResolution(e,t){const i=this.getResolutionRecord(e,t);return{minBitrate:i.minBitrate,maxBitrate:i.maxBitrate}}getResolutionForHeight(e){for(let t=this.resolutions.length-1;t>=0;t--)if(this.resolutions[t].height<=e)return this.resolutions[t];return this.resolutions[0]}getResolutionRecord(e,t){const i=Math.max(e,t),n=Math.min(e,t);for(const e of this.resolutions)if(e.width>=i&&e.height>=n)return e;return this.resolutions[this.resolutions.length-1]}getNextLowerResolution(e,t){const i=Math.min(e,t),n=this.getResolutionForHeight(i),r=this.resolutions.indexOf(n);return this.resolutions[r-1]}getNextHigherResolution(e,t){const i=Math.min(e,t),n=this.getResolutionForHeight(i),r=this.resolutions.indexOf(n);return this.resolutions[r+1]}getResolutions(){return this.resolutions}};kI.Recv=new kI(tt.RES_TABLE.RECV),kI.Send=new kI(tt.RES_TABLE.SEND);var NI=kI,LI=class extends Qe{constructor(e,t,i,n){super(),this.videoElement=e,this.minInterval=t,this.maxInterval=i,this.window=yg.window,this.devicePixelRatio=n&&window.devicePixelRatio||1,this.originalVideoElementSize={width:e.offsetWidth,height:e.offsetHeight},this.initializeSizeTracking()}get width(){return this.originalVideoElementSize.width*this.devicePixelRatio}get height(){return this.originalVideoElementSize.height*this.devicePixelRatio}initializeSizeTracking(){const e=Math.floor(Math.random()*Math.abs(this.maxInterval-this.minInterval))+this.minInterval;this.elementSizeTrackingRef=this.window.setInterval((()=>{this.videoElementSizeChanged()&&(this.saveCurrentVideoElementSize(),this.raiseChanged())}),e)}triggerVideoElementSizeChange(){this.originalVideoElementSize.height&&this.originalVideoElementSize.width&&this.raiseChanged()}dispose(){this.elementSizeTrackingRef&&this.window.clearInterval(this.elementSizeTrackingRef)}videoElementSizeChanged(){return this.originalVideoElementSize.width!==this.videoElement.offsetWidth||this.originalVideoElementSize.height!==this.videoElement.offsetHeight}saveCurrentVideoElementSize(){this.originalVideoElementSize.width=this.videoElement.offsetWidth,this.originalVideoElementSize.height=this.videoElement.offsetHeight}},xI=class extends MI{constructor(e,t,i,n){super(e,i.createChild("local"),n),this.mediaStreamProvider=t,this.isDisposed=!1,this.serialQueue=new _I(this.logger.createChild("rendererQueue")),this.lastNotifiedRendererResolution={width:0,height:0},this.logger.safe.info("ctor"),this.overlayStats=new AI(this.configProvider.config.showStatsInCall,e)}getResolution(){return this.lastNotifiedRendererResolution}dispose(){this.logger.safe.info("dispose"),this.isDisposed=!0,this.event("onRendererDisposed").raise(this),super.dispose(),this.mediaStream&&(this.mediaStream.dispose(),this.mediaStream=null),this.statsSub?.dispose(),this.overlayStats.dispose()}setVideoMirroring(e){this.configProvider.config.localPreviewMirroringSupported&&(this.getVideoElement().style.transform=e?"scaleX(-1)":void 0)}startVideoAsync(e=Re()){return this.logger.safe.info(`[${e}] starting local video`),this.event("onRendererStarted").raise(this),this.sizeTracker=new LI(this.getVideoElement(),this.configProvider.config.webrtcVideoCapabilityCheckIntervalMin,this.configProvider.config.webrtcVideoCapabilityCheckIntervalMax,this.configProvider.config.enableDevicePixelRatio),this.sizeTracker.changed((()=>this.onSizeTrackerChanged())),this.serialQueue.add((()=>this.restartVideo()),e)}updateStreamAsync(e=Re()){return this.logger.safe.info(`[${e}] updating local video`),this.serialQueue.add((()=>this.restartVideo()),e)}setStatsProvider(e){this.statsSub?.dispose(),this.statsSub=e.on("onDiagnosticUpdated",(e=>{e.video?.send?.length&&this.overlayStats.setStats(e.video?.send[0])}))}onSizeTrackerChanged(){const e=this.sizeTracker.width,t=this.sizeTracker.height,i=NI.Send.getResolutionForHeight(Math.min(t,e));this.lastNotifiedRendererResolution.width===i.width&&this.lastNotifiedRendererResolution.height===i.height||(this.lastNotifiedRendererResolution.width=i.width,this.lastNotifiedRendererResolution.height=i.height,this.event("onRendererSizeChanged").raise(this,{height:i.height,width:i.width}))}async restartVideo(){const e=await this.mediaStreamProvider.getVideoStream(!1,"localVideoRenderer");try{if(await e.start(),this.isDisposed)throw e.dispose(),new Error("local video renderer is disposed");this.attachStream(e)}catch(e){throw this.mediaStreamProvider.raiseTelemetryEvent("video_preview_error",{mediaType:"Video",error:Ge(e)}),e}}attachStream(e){if(this.mediaStream!==e)if(this.mediaStream?.parentId!==e?.parentId){this.logger.safe.info(`attach media stream ${e?.id}`);try{this.mediaStream&&(this.mediaStream.dispose(),this.mediaStream=null),e&&super.attachMediaStream(e.rawStream),this.mediaStream=e}catch(t){throw e&&e.dispose(),t}}else e.dispose()}},FI=i(496486);function UI(e,t){const i=e.width/e.height,n=(0,FI.clone)(e);return i>t?n.width=Math.floor(e.height*t):i<t&&(n.height=Math.floor(e.width/t)),n}var VI=class e{constructor(e,t,i=!0,n=!1,r){this.audio=e,this.video=t,this.withTimeout=i,this.withEffect=n,this.withOverridenStream=r}clone(){const t=ut(this.video),i=ut(this.audio);return new e(i,t,this.withTimeout,this.withEffect,this.withOverridenStream)}},HI=class{constructor(e){this.logger=e}dispose(){}updateVideoConstraints(e,t,i){const n=this.calculateConstraints(t,i);this.logger.safe.info(`Calculated constraints: ${JSON.stringify(n)} from capabilities: ${JSON.stringify(t)}`);const r=n.resolution,s=n.fps,a=r&&(!yt(r.width,e.video.minWidth,e.video.maxWidth)||!yt(r.height,e.video.minHeight,e.video.maxHeight)),o=e.video.fps!==s;if(!a&&!o)return e;const l=e.clone();return a&&this.setResolution(l,r),o&&(l.video.fps=s),l}updateResolution(e,t){const i=e.clone();return this.setResolution(i,t),i}setResolution(e,t){e.video.maxWidth=t.width,e.video.minWidth=t.width,e.video.maxHeight=t.height,e.video.minHeight=t.height}getKey(e){return e.video?dt(e.video)?"video":e.video.deviceId&&e.video.minWidth&&e.video.minHeight?`${e.video.deviceId}x${e.video.minWidth}x${e.video.minHeight}`:e.video.minWidth&&e.video.minHeight?`${e.video.minWidth}x${e.video.minHeight}`:e.video.deviceId?`${e.video.deviceId}`:(this.logger.safe.error(`Cannot create key for constraints: ${Jg(e)}`),""):"audio"}convertConstraints(e,t={}){if(!e)return null;const i=ut(t);return e?.deviceId&&(i.deviceId=e.deviceId),i}},BI=class{constructor(){this.MAX_SHARING_WIDTH=1920,this.MAX_SHARING_HEIGHT=1080}getResolutionTable(e,t){const i=this.constraintToMaxResolution(e,t);return this.generateResolutionTable(i)}constraintToMaxResolution(e,t){const i=this.getPortraitOrLandscapeMaxResolution(e),n=UI({width:e.width,height:e.height},t),r=i.width/n.width,s=i.height/n.height,a=Math.min(r,s);return this.resizeResolution(n,a)}resizeResolution(e,t){return{width:Math.round(e.width*t),height:Math.round(e.height*t)}}getPortraitOrLandscapeMaxResolution(e){return e.width>e.height?{width:this.MAX_SHARING_WIDTH,height:this.MAX_SHARING_HEIGHT}:{width:this.MAX_SHARING_HEIGHT,height:this.MAX_SHARING_WIDTH}}ceilToMackroblockSize(e){const t=e.width,i=e.height;return{width:Math.ceil(t/tt.MACROBLOCK_SIZE)*tt.MACROBLOCK_SIZE,height:Math.ceil(i/tt.MACROBLOCK_SIZE)*tt.MACROBLOCK_SIZE}}generateResolutionTable(e){return[1,2/3,1/3,1/6].map((t=>this.resizeResolution(e,t))).map((e=>this.ceilToMackroblockSize(e)))}},$I=class{constructor(e){this.logger=e,this.FPS_TABLE=[15,7.5,3.75,1.875],this.resolutionTableCalculator=new BI,this.initialAspectRatio=null}calculateConstraints(e,t){this.initialAspectRatio||(this.initialAspectRatio=t.width/t.height);const i=this.resolutionTableCalculator.getResolutionTable(t,this.initialAspectRatio);let n={resolution:i[i.length-1],fps:this.FPS_TABLE[this.FPS_TABLE.length-1]};return i.some((t=>{const i=this.getFs(t);return this.FPS_TABLE.some((r=>{const s=this.getMbps(i,r);return i<=e.maxFs&&r<=e.maxFps&&s<=e.maxMbps&&(n={resolution:t,fps:r},!0)}))}))?this.logger.safe.info(`Calculated resolution: ${JSON.stringify(n)}`):this.logger.safe.error(`None of available resolutions are suitable: ${JSON.stringify(i)}. Fallback to: ${JSON.stringify(n)}`),n}getMbps(e,t){return e*t}getFs(e){return Math.ceil(e.width/tt.MACROBLOCK_SIZE)*Math.ceil(e.height/tt.MACROBLOCK_SIZE)}},jI=class{constructor(e,t){this.logger=e,this.maxCapabilities=t}ensureValidity(e){this.throwIfMissing(e);const t=this.calculateMissing(e);return this.maxCapabilities&&this.applyMaxCapabilities(t),this.logger.safe.info(`Validating capabilities ${JSON.stringify(t)}`),t}throwIfMissing(e){if(!e.maxFs&&!e.maxMbps&&!e.maxFps||e.maxFs&&!e.maxMbps&&!e.maxFps||!e.maxFs&&e.maxMbps&&!e.maxFps||!e.maxFs&&!e.maxMbps&&e.maxFps)throw new Error(`Missing video capabilities ${JSON.stringify(e)}`)}calculateMissing(e){const t=ht(e);return!e.maxFs&&e.maxMbps&&e.maxFps&&(t.maxFs=e.maxMbps/e.maxFps),e.maxFs&&!e.maxMbps&&e.maxFps&&(t.maxMbps=e.maxFs*e.maxFps),e.maxFs&&e.maxMbps&&!e.maxFps&&(t.maxFps=e.maxMbps/e.maxFs),t}applyMaxCapabilities(e){this.maxCapabilities.maxFs&&(e.maxFs=Math.min(e.maxFs,this.maxCapabilities.maxFs)),this.maxCapabilities.maxMbps&&(e.maxMbps=Math.min(e.maxMbps,this.maxCapabilities.maxMbps)),this.maxCapabilities.maxFps&&(e.maxFps=Math.min(e.maxFps,this.maxCapabilities.maxFps))}},GI=class extends HI{constructor(e,t){super(e),this.initialConstraints={maxWidth:1920,minWidth:1920,maxHeight:1080,minHeight:1080,fps:15},this.maxCapabilities={maxFs:8160,maxFps:15},this.validator=new jI(this.logger.createChild("CV"),this.maxCapabilities),this.constraintsCalculator=new $I(this.logger.createChild("CC")),t.config.resizeModeForSharing&&(this.initialConstraints.resizeMode=t.config.resizeModeForSharing)}createConstraintsObject(e){if(!e.sharing)throw new Error(`Sharing constraints are not presented: ${JSON.stringify(e)}`);const t=this.convertConstraints(e.sharing,this.initialConstraints),i=e.audio?e.audio:null;return i?.deviceId===tt.SYSTEM_AUDIO_SOURCE_ID&&delete i.deviceId,new VI(i,t,!1,!1,e.withOverridenStream)}generatePolicies(e){return[e]}calculateConstraints(e,t){this.logger.safe.info(`Stream resolution is ${JSON.stringify(t)}`);const i=this.validator.ensureValidity(e);return this.constraintsCalculator.calculateConstraints(i,t)}},WI=class extends GI{constructor(e,t,i){super(e,i);const n=t.screen.width/t.screen.height;n<1&&([this.initialConstraints.maxWidth,this.initialConstraints.maxHeight]=[this.initialConstraints.maxHeight,this.initialConstraints.maxWidth],[this.initialConstraints.minWidth,this.initialConstraints.minHeight]=[this.initialConstraints.minHeight,this.initialConstraints.minWidth]);let r=UI({width:this.initialConstraints.maxWidth,height:this.initialConstraints.maxHeight},n);[this.initialConstraints.maxWidth,this.initialConstraints.maxHeight]=[r.width,r.height],r=UI({width:this.initialConstraints.minWidth,height:this.initialConstraints.minHeight},n),[this.initialConstraints.minWidth,this.initialConstraints.minHeight]=[r.width,r.height]}},qI=class extends HI{constructor(e,t){super(t),this.configProvider=e}createConstraintsObject(e){const t={},i=li().engine;void 0!==e.audioProcessingFlags&&("Chromium"===i||"ChromiumAVD"===i?(t.autoGainControl=!!(1&e.audioProcessingFlags),t.echoCancellation=!!(2&e.audioProcessingFlags),t.noiseSuppression=!!(4&e.audioProcessingFlags),this.configProvider.config.useGoogPrefixAudioConstraints&&(t.googAutoGainControl=!!(1&e.audioProcessingFlags),t.googAutoGainControl2=!!(1&e.audioProcessingFlags),t.googEchoCancellation=!!(2&e.audioProcessingFlags),t.googHighpassFilter=!!(4&e.audioProcessingFlags),t.googNoiseSuppression=!!(4&e.audioProcessingFlags),t.googTypingNoiseDetection=!!(4&e.audioProcessingFlags))):"Safari"===i||"Firefox"===i?(t.autoGainControl=!!(1&e.audioProcessingFlags),t.echoCancellation=!!(2&e.audioProcessingFlags),t.noiseSuppression=!!(4&e.audioProcessingFlags)):this.logger.warn(`Unsupported browser for audio processing flags ${i}`));const n=this.convertConstraints(e.audio,t),r=this.convertConstraints(e.video,this.initialVideoConstraints);return new VI(n,r,e.withTimeout,e.withEffect,e.withOverridenStream)}calculateConstraints(e){const t=Math.min(e.maxFs,this.configProvider.config.webrtcCameraOpenFs);return{resolution:NI.Send.getResolutionByFs(t),fps:e.maxFps}}get initialVideoConstraints(){const e=NI.Send.getResolutionByFs(this.configProvider.config.webrtcCameraOpenFs);return{maxWidth:e.width,minWidth:e.width,maxHeight:e.height,minHeight:e.height,fps:this.configProvider.config.maxCameraOpenFps}}},zI=class{static getProvider(e,t,i){if("ScreenShare"===e){const e=i.createChild("SharingCP");return"Safari"===li().name?new WI(e,yg.window,t):new GI(e,t)}return new qI(t,i.createChild("VideoCP"))}},KI=class{constructor(){}getPolicies(e){if(e.audio&&!e.video&&this.hasAudioProcessingConstraints(e))return[e,new VI({deviceId:e.audio.deviceId},null)];if(!e.video)return[e];const t=this.getSuitableResolutions(e).map((t=>this.getConstraintsForResolution(e,t))),i=e.audio,n={deviceId:e.video.deviceId},r=new VI(i,n,e.withTimeout);return t.push(r),t}getSuitableResolutions(e){return NI.Send.getResolutions().filter((t=>t.width<=e.video.maxWidth&&t.height<=e.video.maxHeight)).reverse()}getConstraintsForResolution(e,t){const i=e.clone();return i.video.minWidth=t.width,i.video.minHeight=t.height,i}hasAudioProcessingConstraints(e){const t=e&&e.audio;return t&&(void 0!==t.echoCancellation||void 0!==t.autoGainControl||void 0!==t.noiseSuppression)}},JI=class{constructor(e,t){this.error=e,this.constraints=t,this.permissionDeniedBySystemErrorMsg=["Permission denied by system","The request is not allowed by the user agent or the platform in the current context, possibly because the user denied permission."]}getMediaError(){let e;switch(this.error.name){case"SourceUnavailableError":case"TrackStartError":case"NotReadableError":case"AbortError":e={type:tt.MEDIA_ERROR.sourceUnavailableError,detail:`media device is already used by another process: ${Ge(this.error)}`};break;case"ConstraintNotSatisfiedError":case"OverconstrainedError":e={type:tt.MEDIA_ERROR.constraintNotSatisfiedError,detail:`could not obtain constrained media stream: ${Ge(this.error)}`};break;case"DevicesNotFoundError":case"NotFoundError":e={type:tt.MEDIA_ERROR.devicesNotFoundError,detail:`specified device not found: ${Ge(this.error)}`};break;case"NotAllowedError":e=this.permissionDeniedBySystemErrorMsg.some((e=>e===this.error.message))?{type:tt.MEDIA_ERROR.permissionDeniedBySystemError,detail:`no system permissions: ${Ge(this.error)}`}:{type:tt.MEDIA_ERROR.permissionDeniedError,detail:`permission to use media device was denied: ${Ge(this.error)}`};break;case"PermissionDeniedError":case"PermissionDismissedError":e={type:tt.MEDIA_ERROR.permissionDeniedError,detail:`permission to use media device was denied: ${Ge(this.error)}`};break;case tt.MEDIA_ERROR.extensionNotFoundError:e={type:tt.MEDIA_ERROR.extensionNotFoundError,detail:`extension is not found: ${Ge(this.error)}`};break;case tt.MEDIA_ERROR.chromeRuntimeNotDefinedError:e={type:tt.MEDIA_ERROR.chromeRuntimeNotDefinedError,detail:`chrome runtime is not defined: ${Ge(this.error)}`};break;case tt.MEDIA_ERROR.sharingCancelledError:e=this.getSharingCancelledError(this.error);break;case tt.MEDIA_ERROR.mediaStreamRequestTimedOut:e={type:tt.MEDIA_ERROR.mediaStreamRequestTimedOut,detail:"Media Stream request timed out."};break;default:e=this.error.message===tt.MEDIA_ERROR.sharingCancelledError?this.getSharingCancelledError(this.error):{type:tt.MEDIA_ERROR.mediaStreamRequestError,detail:`media stream request error: ${Ge(this.error)}`}}return e.isAudio=!!this.constraints.audio,e.detail+=` constraints: ${Ge(Jg(this.constraints))}`,e.message=e.detail,e}getSharingCancelledError(e){return{type:tt.MEDIA_ERROR.sharingCancelledError,detail:`screen sharing cancelled: ${Ge(e)}`}}},YI=class{constructor(e){this.logger=e}static isSupported(){return!0}getStream(e){const t=this.constraintsAdapter.toGumConstraints(e);return this.logger.safe.info(`Constraints to be applied: ${JSON.stringify(Jg(t))}`),new Promise(((e,i)=>{yg.window.navigator.getUserMedia(t,e,i)})).catch((t=>{throw new JI(t,e).getMediaError()}))}applyConstraints(e,t){if(!e||!e.getVideoTracks()||!e.getVideoTracks()[0])return Promise.reject("No video tracks found");const i=e.getVideoTracks()[0];return this.applyConstraintsForTrack(i,t)}applyConstraintsForTrack(e,t){const i=this.constraintsAdapter.toTrackConstraints(t);return e.applyConstraints?(this.logger.safe.info(`Apply constraints: ${JSON.stringify(i)} on ${JSON.stringify(e.id)}`),e.applyConstraints(i).catch((e=>{throw new JI(e,t).getMediaError()}))):Promise.reject("track.applyConstraints() is not supported")}},QI=class{constructor(e){this.configProvider=e}toGumConstraints(e){const t={};return e.audio&&(t.audio=ut(e.audio),t.audio.deviceId&&delete t.audio.deviceId,e.audio.deviceId&&e.audio.deviceId!==tt.MEDIA_DEVICE.defaultId&&(t.audio.deviceId=e.audio.deviceId)),e.video&&(t.video={mandatory:{}},e.video.deviceId&&(t.video.mandatory.sourceId=e.video.deviceId),e.video.minWidth&&(t.video.mandatory.minWidth=e.video.minWidth),e.video.maxWidth&&(t.video.mandatory.maxWidth=e.video.maxWidth),e.video.minHeight&&(t.video.mandatory.minHeight=e.video.minHeight),e.video.maxHeight&&(t.video.mandatory.maxHeight=e.video.maxHeight),e.video.fps&&(t.video.mandatory.maxFrameRate=e.video.fps,this.configProvider.config.setMinFpsForWebkit&&(t.video.mandatory.minFrameRate=this.configProvider.config.minCameraOpenFps,t.video.mandatory.idealFrameRate=e.video.fps)),dt(t.video.mandatory)&&delete t.video.mandatory),t}toTrackConstraints(e){const t={};return e.video&&(e.video.minWidth&&(t.width=e.video.minWidth),e.video.minHeight&&(t.height=e.video.minHeight),e.video.fps&&(t.frameRate=e.video.fps)),t}},XI=class{constructor(e){this.configProvider=e}toGumConstraints(e){const t={};if(e.audio&&(t.audio=ut(e.audio),t.audio.deviceId&&delete t.audio.deviceId,e.audio.deviceId&&e.audio.deviceId!==tt.MEDIA_DEVICE.defaultId&&(t.audio.deviceId={exact:e.audio.deviceId})),e.video){t.video={width:{},height:{},frameRate:{}},e.video.deviceId&&(t.video.deviceId={exact:e.video.deviceId}),e.video.minWidth&&(t.video.width.min=e.video.minWidth),e.video.maxWidth&&(t.video.width.max=e.video.maxWidth),e.video.minHeight&&(t.video.height.min=e.video.minHeight),e.video.maxHeight&&(t.video.height.max=e.video.maxHeight),e.video.fps&&(t.video.frameRate.max=e.video.fps,t.video.frameRate.min=this.configProvider.config.minCameraOpenFps,t.video.frameRate.ideal=e.video.fps);for(const e in t.video)dt(t.video[e])&&delete t.video[e]}return t}toTrackConstraints(e){const t={};return e.video&&(e.video.minWidth&&(t.width=e.video.minWidth),e.video.minHeight&&(t.height=e.video.minHeight),e.video.fps&&(t.frameRate=e.video.fps)),t}},ZI=class{toGumConstraints(e){if(!e||!e.video)throw new Error(`constraints cannot be applied: ${e}`);const t={video:{}},i=e.video.deviceId&&e.video.deviceId!==tt.DISPLAY_SOURCE_ID;return e.video.resizeMode&&(t.video.resizeMode=e.video.resizeMode),i&&(t.video.deviceId={exact:e.video.deviceId}),e.video.maxWidth&&(t.video.width={max:e.video.maxWidth},i&&(t.video.width.ideal=e.video.maxWidth)),e.video.maxHeight&&(t.video.height={max:e.video.maxHeight},i&&(t.video.height.ideal=e.video.maxHeight)),e.video.fps&&(t.video.frameRate=e.video.fps),e.audio&&(t.audio=!e.audio.deviceId||{deviceId:{exact:e.audio.deviceId}}),t}toTrackConstraints(e){const t=navigator.mediaDevices.getSupportedConstraints();if(!t)throw new Error("Constraints are not supported by browser");const i={};return t.width&&e.video.minWidth&&(i.width=e.video.minWidth),t.height&&e.video.minHeight&&(i.height=e.video.minHeight),t.frameRate&&e.video.fps&&(i.frameRate=e.video.fps),i.resizeMode=e.video.resizeMode,i}},eA=class extends YI{constructor(e,t){if(super(t.createChild("WebRTCProvider")),this.configProvider=e,this.timeoutId=null,void 0!==navigator.webkitGetUserMedia&&void 0!==webkitRTCPeerConnection&&Sg()){if(!this.configProvider.config.overrideGumFromWebkit||!gg)return void(this.constraintsAdapter=new QI(e));this.logger.safe.info("Overriding getUserMedia from webkit"),vg()}this.constraintsAdapter=new XI(e)}getStream(e){if(!e.withTimeout||!this.configProvider.config.gumRequestTimeout)return super.getStream(e);const t=this.startGumRequestTimer(e),i=super.getStream(e).then((t=>{if(!this.timeoutId)throw this.stopStreamAfterTimeout(t,e),this.getMediaStreamTimeoutError(e);return this.stopGumRequestTimer(),t}));return Promise.race([t,i]).catch((e=>{throw this.stopGumRequestTimer(),e}))}getMediaStreamTimeoutError(e){const t={name:tt.MEDIA_ERROR.mediaStreamRequestTimedOut,message:`Media stream request timed out. Constraints: ${Ge(Jg(e))}`};return new JI(t,e).getMediaError()}startGumRequestTimer(e){return new Promise(((t,i)=>{this.timeoutId=window.setTimeout((()=>{this.timeoutId=null,i(this.getMediaStreamTimeoutError(e))}),this.configProvider.config.gumRequestTimeout)}))}stopGumRequestTimer(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)}stopStreamAfterTimeout(e,t){this.logger.safe.info(`Stopping media stream acquired after timeout: ${JSON.stringify(e.id)} with constraints: ${JSON.stringify(t)}`);try{e.getTracks().forEach((e=>{this.logger.safe.info(`Track is stopped: ${JSON.stringify(e.id)}`),e.stop()})),this.logger.safe.info(`Media stream stopped: ${e.id}`)}catch(e){this.logger.safe.warn(`Failed to stop media stream: ${Ge(e)}`)}}},tA=class extends YI{constructor(e){super(e.createChild("WebRTCDispProvider")),this.constraintsAdapter=new ZI}static isSupported(){return!!window.navigator.mediaDevices.getDisplayMedia}getStream(e){const t=this.constraintsAdapter.toGumConstraints(e);return this.logger.safe.info(`Constraints to be used: ${JSON.stringify(t)}`),Promise.resolve().then((()=>e.video?.deviceId&&e.video?.deviceId!==tt.DISPLAY_SOURCE_ID?yg.window.navigator.mediaDevices.getUserMedia(t):yg.window.navigator.mediaDevices.getDisplayMedia(t))).catch((t=>{throw new JI(t,e).getMediaError()}))}},iA=class{constructor(e){this.detail=e}getStream(e){throw this.getError(e)}applyConstraints(e,t){throw this.getError(t)}applyConstraintsForTrack(e,t){throw this.getError(t)}getError(e){return{type:tt.MEDIA_ERROR.unsupportedStream,detail:this.detail,message:this.detail,isAudio:!!e.audio}}},nA=class{static getStreamProvider(e,t,i){return"ScreenShare"===e?tA.isSupported()?new tA(i):(i.error("GUM stream provider cannot be created for display stream"),new iA("Sharing not supported")):new eA(t,i)}},rA=class extends Qe{constructor(e,t,i){super(i),this.mediaStream=e,this.logger=i,this.mediaStreamSubscriptions=[],this.isHold=!1,this.isMuted=this.mediaStream.getMuted(),this._isDisposed=!1,this.originalId=e.id,this.subscribeOnMediaStreamEvents(),this.update(t),this.logger.safe.info("ctor"),this.mediaType=this.mediaStream.mediaType}get id(){return this.originalId}get parentId(){return this.originalId}get rawStream(){return this.gumStream}get rawTrack(){return this.getTrackByMediaType(this.rawStream,this.mediaType)}get deviceId(){return this.mediaStream.deviceId}update(e){e&&(this.gumStream=e,this.enableDisableTracks())}dispose(){this._isDisposed?this.logger.safe.info("already disposed"):(this._isDisposed=!0,this.logger.safe.info("dispose"),this.logger=this.logger.createChild("DISPOSED"),this.event("onStreamClientDisposing").raise(this),this.mediaStream&&(this.mediaStream.disposeClient(this),this.unsubscribeFromMediaStreamEvents(),this.mediaStream=null),this.event("onStreamClientDisposed").raise(this))}clone(){const e=this.mediaStream.getClient();return this.isMuted&&e.setMuted(!0),this.isHold&&e.setHold(!0),e}applyCapabilities(e){return this.mediaStream.applyCapabilities(e)}setMuted(e,t=Re()){this.isMuted=e||this.mediaStream.getMuted(),this.logger.safe.info(`[${t}] setMuted => ${this.isMuted}`),this.enableDisableTracks()}setHold(e){this.isHold=e,this.enableDisableTracks()}start(){return this.mediaStream.start()}hasAudio(){return this.mediaStream.hasAudio()}hasVideo(){return this.mediaStream.hasVideo()}hasDisplay(){return this.mediaStream.hasDisplay()}isSameStream(e){return this.parentId===e.parentId}getResolution(){return this.mediaStream.getResolution()}getFrameRate(){return this.mediaStream.getFrameRate()}isActive(){return!0}isDisposed(){return this._isDisposed}subscribeOnMediaStreamEvents(){this.mediaStreamSubscriptions.push(this.mediaStream.on("onStreamStarted",((e,t)=>{this.event("onStreamClientStarted").raise(this,t)}))),this.mediaStreamSubscriptions.push(this.mediaStream.on("onStreamError",((e,t)=>{this.event("onStreamClientError").raise(this,t)}))),this.mediaStreamSubscriptions.push(this.mediaStream.on("onStreamTrackMuted",((e,t)=>{this.event("onStreamClientMuted").raise(this,t)}))),this.mediaStreamSubscriptions.push(this.mediaStream.on("onStreamTrackEnded",((e,t)=>{this.event("onStreamClientEnded").raise(this,t)})))}unsubscribeFromMediaStreamEvents(){this.mediaStreamSubscriptions.forEach((e=>e.dispose())),this.mediaStreamSubscriptions=[]}enableDisableTracks(){this.gumStream?this.gumStream.getTracks().forEach((e=>{void 0!==e.enabled&&(e.enabled=!this.isMuted&&!this.isHold,this.logger.safe.info(`Track ${JSON.stringify(e.id)} enabled state set to => ${e.enabled}`))})):this.logger.safe.warn("gumStream stream doesn't exist")}getTrackByMediaType(e,t){return"Audio"===t?e.getAudioTracks()[0]:e.getVideoTracks()[0]}},sA=[30,15,7.5,3.75,1.875];function aA(e){return e&&e.getVideoTracks()[0]?oA(e.getVideoTracks()[0]):null}function oA(e){if(e&&e.getSettings){const t=e.getSettings();if(t)return{width:t.width,height:t.height}}return null}function lA(e){return e&&e.getVideoTracks()[0]?dA(e.getVideoTracks()[0]):0}function dA(e){if(e&&e.getSettings){const t=e.getSettings();if(t)return vt(sA,t.frameRate,!0)}return 0}var cA=class e extends Qe{constructor(t,i,n,r){super(n),this.streamConstraints=t,this.serialQueue=i,this.configProvider=r,this.clientId=0,this.clients=[],this.gumStreams={},this.clientGumStreams=[],this.streamsDump=[],this.isMuted=!1,this.isHold=!1,this.gumStartTime=0,this.streamId=e.streamGeneration++,this.logger=n.createChild(`MediaStream:${this.streamId}`),this.mediaType=this.getMediaType(this.streamConstraints),this.constraintsProvider=zI.getProvider(this.mediaType,this.configProvider,this.logger),this.currentConstraints=this.constraintsProvider.createConstraintsObject(t)}get id(){return this.streamId}get rawStream(){return this.currentGumStream}get deviceId(){return this.rawStream?.getTracks()?.[0]?.getSettings?.()?.deviceId??null}applyCapabilities(e){if(this.currentGumStream){const t=this.constraintsProvider.updateVideoConstraints(this.currentConstraints,e,this.getResolution());if(!t)return Promise.resolve(!1);if(this.currentConstraints!==t){this.currentConstraints=t;const e=this.currentConstraints;return this.hasDisplay()?this.applyConstraints(this.currentConstraints).then((()=>mt(this.currentConstraints,e))).catch((e=>(this.logger.safe.error(`Apply constraints error: ${Ge(e)}`),!1))):this.applyConstraintsInternal().then((()=>mt(this.currentConstraints,e)))}}return Promise.resolve(!1)}getClient(){let e;this.currentGumStream?(e=this.getClone(),this.clientGumStreams.push({[this.constraintsProvider.getKey(this.currentConstraints)]:e})):this.clientGumStreams.push({});const t=new rA(this,e,this.logger.createChild("Client:"+this.clientId++));return this.clients.push(t),t}getClone(){return this.hasDisplay()?this.currentGumStream:this.currentGumStream.clone()}setMuted(e){this.isMuted=e,this.clients.forEach((t=>{t.setMuted(e)})),this.enableDisableTracks()}getMuted(){return this.isMuted}setHold(e){this.isHold=e,this.clients.forEach((t=>{t.setHold(e)})),this.enableDisableTracks()}start(){return this.mediaStreamStartPromise||(this.mediaStreamStartPromise=this.startStream(this.currentConstraints)),this.mediaStreamStartPromise}dispose(){for(let e=this.clients.length-1;e>=0;e--)this.clients[e].dispose()}disposeClient(e){const t=this.clients.indexOf(e);t>=0&&(this.clients.splice(t,1),this.streamsDump.push(this.clientGumStreams[t]),this.clientGumStreams.splice(t,1),0===this.clients.length)&&this.disposeStream()}async disposeStream(){this.event("onStreamDisposing").raise(this);try{await this.stopGumStream(),this.event("onStreamDisposed").raise(this)}catch(e){this.event("onStreamError").raise(this,e)}this.constraintsProvider=null,this.serialQueue=null,this.configProvider=null,this.logger=this.logger.createChild("DISPOSED"),super.dispose()}hasAudio(){return!!this.currentGumStream&&0!==this.currentGumStream.getAudioTracks().length}hasVideo(){return!!this.currentGumStream&&0!==this.currentGumStream.getVideoTracks().length&&this.currentConstraints.video&&this.currentConstraints.video.deviceId!==tt.DISPLAY_SOURCE_ID}hasDisplay(){return!!this.currentGumStream&&0!==this.currentGumStream.getVideoTracks().length&&this.currentConstraints.video&&this.currentConstraints.video.deviceId===tt.DISPLAY_SOURCE_ID}getVideoDeviceId(){return this.currentConstraints.video.deviceId}getResolution(){if(!["Video","ScreenShare","PanoramicVideo"].some((e=>e===this.mediaType)))return null;const e={width:this.currentConstraints.video.minWidth,height:this.currentConstraints.video.minHeight},t=aA(this.currentGumStream),i=t??e,n=`Stream resolution is ${i.width}x${i.height}.`;return t?this.logger.safe.info(n):this.logger.safe.error(`${n}. Resolution not found, assuming default resolution.'`),i}getFrameRate(){if(!["Video","ScreenShare","PanoramicVideo"].some((e=>e===this.mediaType)))return null;const e=lA(this.currentGumStream);return 0===e?this.logger.safe.error("Stream frame rate is not avalable, returning 0"):this.logger.safe.info(`Stream fps is ${e}`),e}async startStream(e){let t;t=e.video?this.applyConstraintsInternal():this.updateGumStreamInternal(e);try{await t,this.event("onStreamStarted").raise(this,e)}catch(e){throw this.event("onStreamError").raise(this,e),e}}getMediaType(e){if(e.sharing)return"ScreenShare";if(e.video)return"Video";if(e.audio)return"Audio";throw new Error(`Media type is not defined: ${JSON.stringify(e)}`)}updateClients(e){const t=this.constraintsProvider.getKey(e);this.clients.forEach(((e,i)=>{this.clientGumStreams[i][t]||(this.clientGumStreams[i][t]=this.getClone()),e.update(this.clientGumStreams[i][t])}))}applyConstraints(e){const t=this.getGumStreamProvider();return Promise.all(this.clients.map((i=>t.applyConstraints(i.rawStream,e)))).then((()=>{}))}applyConstraintsInternal(){return new Promise(((e,t)=>{this.logger.safe.info(`applying stream constraints: ${JSON.stringify(Jg(this.currentConstraints))}`);const i=new Mu;this.clients.forEach((e=>{e.onApplyConstraints&&e.onApplyConstraints(i.promise)})),e(this.serialQueue.add((()=>{const e=(new KI).getPolicies(this.currentConstraints);return this.mediaStreamStartPromise=this.updateGumStreamInternal(e[0]),e.slice(1).forEach((e=>{this.mediaStreamStartPromise=this.mediaStreamStartPromise.catch((t=>{if(tt.MEDIA_ERROR.constraintNotSatisfiedError===t.type)return this.logger.safe.warn("could not obtain constrained media stream, will attempt weaker policy"),this.updateGumStreamInternal(e);throw t.constraints=e,t}))})),this.mediaStreamStartPromise})).then((()=>{i.resolve()})).catch((e=>{throw this.logger.safe.error(`failed to apply constraints: ${JSON.stringify(Jg(e.constraints))} error: ${Ge(e)}`),i.reject(e),e})))}))}enableDisableTracks(){this.currentGumStream&&this.currentGumStream.getTracks().forEach((e=>{void 0!==e.enabled&&(e.enabled=!("audio"===e.kind&&this.isMuted||this.isHold),this.logger.safe.info(`control media stream track kind: ${e.kind} enabled: ${e.enabled} muted: ${e.muted}`))}))}getGumStreamProvider(){return nA.getStreamProvider(this.mediaType,this.configProvider,this.logger.createChild("MSProvider"))}async updateGumStreamInternal(e){this.logger.safe.info(`querying user media for stream: ${JSON.stringify(e)}`),this.logger.safe.info("Getting GUM stream");const t=await this.getGumStream(e);this.logger.safe.info("Updating gum stream audio tracks"),this.updateGumStreamAudioTracks(t),this.currentGumStream=t,this.logger.safe.info("Updating stream constraints"),this.updateConstraints(e,t),this.logger.safe.info("Caching GUM stream"),this.cacheGumStream(this.currentConstraints,t),this.updateClients(this.currentConstraints),this.updateGumStreamVideoTracks(t),this.enableDisableTracks(),this.logger.safe.info("media stream updated");const i=this.stopRequestCalculation();this.event("onStreamAcquired").raise(this,i,(this.hasVideo()||this.hasDisplay())&&this.getResolution()||void 0)}async getGumStream(e){const t=this.gumStreams[this.constraintsProvider.getKey(e)];if(t)return t;const i=this.getGumStreamProvider();return this.startRequestCalculation(),i.getStream(e)}updateGumStreamAudioTracks(e){e.getAudioTracks().forEach((e=>{e.onended=e=>{this.logger.safe.info(`Audio stream track ended: ${JSON.stringify(e.error?.name||e)}`),this.event("onStreamTrackEnded").raise(this,e)},e.onmute=()=>{this.logger.safe.info("Audio stream track muted"),this.event("onStreamTrackMuted").raise(this,!0)},e.onunmute=()=>{this.logger.safe.info("Audio stream track unmuted"),this.event("onStreamTrackMuted").raise(this,!1)},e.muted&&this.event("onStreamTrackMuted").raise(this,!0),this.logger.safe.info(`Audio track added: ${JSON.stringify(e.id)}`)}))}updateGumStreamVideoTracks(e){const[t]=e.getVideoTracks();t&&(t.onmute=e=>{this.logger.safe.error(`Video stream track muted: ${JSON.stringify(Jg(this.currentConstraints))}; ${JSON.stringify(e)}`)},t.onended=e=>{this.logger.safe.info(`Video stream track ended: ${JSON.stringify(Jg(this.currentConstraints))}; ${JSON.stringify(e?.error.name||e)}`),this.event("onStreamTrackEnded").raise(this,e)},this.hasDisplay()&&this.configProvider.config.webrtcDisplayStreamContentHint&&this.applyContentHint(t,this.configProvider.config.webrtcDisplayStreamContentHint),this.logger.safe.info(`Video track added: ${JSON.stringify(t.id)}`))}cacheGumStream(e,t){const i=this.constraintsProvider.getKey(e);this.gumStreams[i]!==t&&(this.gumStreams[i]&&(this.logger.safe.info(`Stream cache hit for ${i}, stopping old stream`),this.stopOneGumStream(this.gumStreams[i])),this.gumStreams[i]=t)}updateConstraints(e,t){this.currentConstraints=e.video?this.constraintsProvider.updateResolution(e,this.getResolution()):e,this.logger.safe.info(`Stream constraints updated: ${JSON.stringify(this.currentConstraints)}`)}applyContentHint(e,t){["","text","detail","motion"].indexOf(t)<0?this.logger.safe.error(`Cannot apply content hint: ${t}`):(this.logger.safe.info(`Apply content hint: ${t}`),e.contentHint=t)}startRequestCalculation(){this.gumStartTime=Date.now()}stopRequestCalculation(){if(0===this.gumStartTime)return 0;const e=Date.now()-this.gumStartTime;return this.gumStartTime=0,e}stopGumStream(){return this.mediaStreamStartPromise?(this.logger.safe.info("queueing media stream stop"),this.serialQueue.add((()=>{this.stopGumStreamInternal()}))):Promise.resolve()}stopOneGumStream(e){try{e.getTracks().forEach((e=>{this.logger.safe.info(`Track is stopped: ${JSON.stringify(e.id)}`),e.onended=null,e.onmute=null,e.stop()})),this.logger.safe.info("media stream stopped")}catch(e){this.logger.safe.warn(`failed to stop media stream: ${Ge(e)}`)}}stopGumStreamInternal(){this.currentGumStream&&([...this.clientGumStreams,...this.streamsDump,this.gumStreams].forEach((e=>{it(e,(e=>{this.stopOneGumStream(e)}))})),this.gumStreams={},this.clientGumStreams=[],this.streamsDump=[],this.currentGumStream=null)}};cA.streamGeneration=0;var hA=cA,uA=class extends Qe{constructor(e,t,i,n,r,s,a){super(a),this.id=e,this.masterStream=t,this.currentConstraints=i,this.constraintsProvider=n,this.streamProvider=r,this.configProvider=s,this._isDisposed=!1,this.masterStreamSubscriptions=[],this.mixerSubscriptions=[],this.parentId=t.id,this.logger=a.createChild(`C:${this.parentId}:${this.id}`),this.subscribeOnMasterStreamEvents()}get rawTrack(){return this.mediaTrack}get rawStream(){return this.rawMediaStream||(this.rawMediaStream=new MediaStream([this.mediaTrack]),this.configProvider.config.reassignMediaStreamAudioTrackAfterCreation&&this.rawMediaStream.getAudioTracks().length>0&&(this.rawMediaStream.removeTrack(this.rawMediaStream.getAudioTracks()[0]),this.rawMediaStream.addTrack(this.mediaTrack))),this.rawMediaStream}get deviceId(){return this.masterStream.deviceId}get mediaType(){return this.masterStream.mediaType}get originalMediaStream(){return this.masterStream.getOriginalMediaStream()}getCurrentConstraints(){return this.currentConstraints}dispose(e){this._isDisposed||(this._isDisposed=!0,this.logger.safe.info(`dispose: ${e}`),this.logger=this.logger.createChild("DISPOSED"),this.event("onStreamClientDisposing").raise(this),this.mediaTrack&&(this.unsubscribeFromMediaTrackEvents(),this.mediaTrack=null),this.masterStream&&(this.unsubscribeFromMasterStreamEvents(),this.masterStream.disposeClient(this),this.masterStream=null),this.unsubscribeFromMixerTrackEvents(),super.dispose(),this.event("onStreamClientDisposed").raise(this))}async applyCapabilities(e){if(!this.mediaTrack)return!1;const t=this.constraintsProvider.updateVideoConstraints(this.currentConstraints,e,this.getResolution());if(!t||!this.configProvider.config.recoverOnStreamUnmute&&this.currentConstraints===t)return!1;const i=async e=>{try{return await this.streamProvider.applyConstraintsForTrack(this.mediaTrack,t),this.currentConstraints=t,!0}catch(t){if(e)throw this.logger.safe.error(`Apply constraints error: ${JSON.stringify(t)}`),t;return this.logger.safe.warn(`Apply constraints failed and will be re-tried, error ${JSON.stringify(t)}`),!1}},n=this.currentConstraints.withEffect&&this.configProvider.config.effectsApplyConstraintsRetryMs;return!await i(!n)&&n&&(await pm(this.configProvider.config.effectsApplyConstraintsRetryMs),await i(!0)),!0}start(){return this.masterStream.start()}clone(e){return null===this.masterStream&&this.logger.safe.error(`clone: master stream is null, reason: ${e}`),this.masterStream.getClient(`streamclient: ${e}`)}setMuted(e,t){this.isMuted=e,this.applyState(t)}setHold(e,t){this.isHold=e,this.applyState(t)}isSameStream(e){return this.parentId===e.parentId}getResolution(){if(!["Video","ScreenShare","PanoramicVideo"].some((e=>e===this.mediaType)))return null;const e={width:this.currentConstraints.video.minWidth,height:this.currentConstraints.video.minHeight},t=oA(this.mediaTrack),i=t?.width?t:e,n=`Track resolution is ${i.width}x${i.height}.`;return t?.width?this.logger.safe.info(n):this.logger.safe.error(`${n}. Resolution not found, assuming default resolution.'`),i}getFrameRate(){if(!["Video","ScreenShare","PanoramicVideo"].some((e=>e===this.mediaType)))return null;const e=dA(this.mediaTrack);return 0===e?this.logger.safe.error("Stream frame rate is not avalable, returning 0"):this.logger.safe.info(`Stream fps is ${e}`),e}update(e){e?this.mediaTrack?this.logger.safe.error(`Media track is already created: ${this.mediaTrack.id}`):(this.mediaTrack=this.getTrackByMediaType(e,this.mediaType),this.updateTrackConstraints(),this.subscribeOnMediaTrackEvents(this.mediaTrack),this.hasMasterAudio=e&&e.getAudioTracks().length>0,this.hasMasterVideo=e&&e.getVideoTracks().length>0,this.hasMasterAudio&&this.hasMasterVideo&&(this.rawMediaStream=e),this.logger.safe.info(`Updated: ${rm(e)}`)):this.logger.safe.error("No master media stream, skipping update")}resetEffectsOutputConstraints(e){this.masterStream.resetEffectsOutputConstraints(e)}async updateTrackConstraints(){if("ScreenShare"!==this.mediaType)return;const e=this.masterStream.getResolution();if(e){const t=this.currentConstraints.clone();t.video.maxWidth=e.width,t.video.minWidth=e.width,t.video.maxHeight=e.height,t.video.minHeight=e.height;try{await this.streamProvider.applyConstraintsForTrack(this.mediaTrack,t),this.currentConstraints=t}catch(e){this.logger.safe.error(`Apply constraints error: ${JSON.stringify(e)}`)}}}getTrackByMediaType(e,t){return"Audio"===t?e.getAudioTracks()[0]:e.getVideoTracks()[0]}applyState(e){this.mediaTrack&&void 0!==this.mediaTrack.enabled&&(this.mediaTrack.enabled=!this.isMuted&&!this.isHold,this.logger.safe.info(`[${e}] Track ${JSON.stringify(this.mediaTrack.id)} enabled state set to => ${this.mediaTrack.enabled}`))}subscribeOnMediaTrackEvents(e){e.onended=t=>{this.logger.safe.info(`Track ${e.id} ended: ${JSON.stringify(t)}`),this.event("onStreamClientEnded").raise(this,t)},e.onmute=()=>{this.logger.safe.info(`Track ${e.id} muted`),this.event("onStreamClientMuted").raise(this,!0)},e.onunmute=()=>{this.logger.safe.info(`Track ${e.id} unmuted`),this.event("onStreamClientMuted").raise(this,!1)}}unsubscribeFromMediaTrackEvents(){this.mediaTrack.onended=null,this.mediaTrack.onmute=null,this.mediaTrack.onunmute=null}unsubscribeFromMixerTrackEvents(){this.mixerSubscriptions.forEach((e=>e.dispose())),this.mixerSubscriptions=[]}subscribeOnMasterStreamEvents(){this.masterStreamSubscriptions.push(this.masterStream.on("onStreamStarted",((e,t)=>this.event("onStreamClientStarted").raise(this,t))),this.masterStream.on("onStreamError",((e,t)=>this.event("onStreamClientError").raise(this,t))),this.masterStream.on("onStreamTrackMuted",((e,t)=>this.event("onStreamClientMuted").raise(this,t))),this.masterStream.on("onStreamDisposing",(e=>this.dispose())),this.masterStream.on("onStreamQualityChanged",((e,t,i,n)=>this.event("onStreamQualityChanged").raise(this,t,i,n))),this.masterStream.on("onStreamTrackEnded",((e,t)=>this.event("onStreamClientEnded").raise(this,t))))}unsubscribeFromMasterStreamEvents(){this.masterStreamSubscriptions.forEach((e=>e.dispose())),this.masterStreamSubscriptions=[]}hasAudio(){return this.hasMasterAudio}hasVideo(){return this.hasMasterVideo}isActive(){return this.mediaTrack?.enabled&&!this.mediaTrack?.muted&&"live"===this.mediaTrack?.readyState}onVideoStreamQualityChanged(e,t,i){this.logger.safe.debug(`onStreamQualityChanged: ${JSON.stringify(e)}@${t}, reason=${i}`),this.masterStream.onVideoStreamQualityChanged(e,t,i)}isDisposed(){return this._isDisposed}},pA=class extends Qe{constructor(e,t,i,n,r,s){super(s),this.stream=e,this.constraints=t,this.constraintsProvider=i,this.gumStreamProvider=n,this.configProvider=r,this.logger=s,this.clients=[],this.streams=[],this.clientId=0,this.mediaStreamSubscription=this.stream.on("onStreamAcquired",(()=>this.onStreamAcquired()))}getClient(){const e=new uA(this.clientId++,this.stream,this.constraints,this.constraintsProvider,this.gumStreamProvider,this.configProvider,this.logger);return this.addClient(e),e}disposeClient(e){this.removeClient(e),this.clients.length||this.event("onAllClientsDisposed").raise()}dispose(){this.mediaStreamSubscription.dispose(),this.clients.length&&this.logger.safe.error(`Not all clients are disposed! ${JSON.stringify(this.clients.map((e=>e.id)))}`),this.streams.forEach((e=>this.disposeStream(e))),super.dispose()}getOrCreateStream(){const e=this.streams.length?this.streams[this.streams.length-1]:this.stream.rawStream;if(!e)return null;const t=e.clone();return this.logger.safe.info(`Cloned: ${rm(e)} -> ${rm(t)}`),this.resetStream(t),this.streams.push(t),t}addClient(e){this.updateClient(e),this.clients.push(e)}updateClient(e){const t=this.getOrCreateStream();t&&e.update(t)}removeClient(e){const t=this.clients.indexOf(e);this.clients.splice(t,1)}addStream(){this.clients.forEach((e=>this.updateClient(e)))}disposeStream(e){e.getTracks().forEach((e=>{this.logger.safe.info(`Stopping track: ${JSON.stringify(e.id)}`),e.stop()}))}onStreamAcquired(){this.addStream()}resetStream(e){e.getTracks().forEach((e=>{this.logger.safe.info(`Resetting state for track: ${e.id}`),e.enabled=!0}))}},gA=class{static getStrategy(e,t,i,n,r,s){return s?new vA(i,n):"Video"===e?new SA(t,i,n,r):new fA(t,i,n)}},mA=class{constructor(e,t,i){this.gumStreamProvider=e,this.serialQueue=t,this.logger=i}getStream(e){return this.logger.safe.info(`Requesting stream with constraints: ${JSON.stringify(Jg(e))}`),this.serialQueue.add((()=>this.request(e)))}},fA=class extends mA{constructor(e,t,i){super(e,t,i.createChild("SimpleStrat"))}request(e){return this.gumStreamProvider.getStream(e)}},SA=class extends mA{constructor(e,t,i,n){super(e,t,i.createChild("MultStrat")),this.policyGenerator=new KI}request(e){const t=this.policyGenerator.getPolicies(e);return this.makeRequests(t)}makeRequests(e){const t=e[0];return this.logger.safe.info(`Requesting media stream with policy: ${JSON.stringify(t)}`),this.makeRequestWithPolicy(t).catch((t=>{const i=e.slice(1);if(i.length&&tt.MEDIA_ERROR.constraintNotSatisfiedError===t.type)return this.logger.safe.warn("Could not obtain constrained media stream, will attempt weaker policy"),this.makeRequests(i);throw t}))}makeRequestWithPolicy(e){return this.gumStreamProvider.getStream(e)}},vA=class extends mA{constructor(e,t){super(null,e,t.createChild("WithOveriddenStreamStart"))}request(e){return new Promise(((t,i)=>t(e.withOverridenStream)))}},yA=class e extends Qe{constructor(t,i,n,r,s){super(r),this.serialQueue=i,this.configProvider=n,this.effectManager=s,this.gumRequestTime=0,this.id=e.streamId++,this.logger=r.createChild(`MediaStream:${this.id}`),this.mediaType=this.getMediaType(t),this.initialize(t)}get rawStream(){return this.mediaStream}get deviceId(){return this.originalMediaStream?this.originalMediaStream.getTracks()?.[0]?.getSettings?.()?.deviceId:null}start(){return this.mediaStreamStartPromise||(this.mediaStreamStartPromise=this.startStream(this.currentConstraints)),this.mediaStreamStartPromise}dispose(e){this.event("onStreamDisposing").raise(this),this.stopMediaStream(e).catch((e=>{this.event("onStreamError").raise(this,e)})).finally((()=>{this.constraintsProvider=null,this.serialQueue=null,this.configProvider=null,this.logger=this.logger.createChild("DISPOSED"),this.clientGenerationStrategy.dispose(),this.event("onStreamDisposed").raise(this),super.dispose()}))}disposeClient(e){this.clientGenerationStrategy.disposeClient(e)}getClient(e){return this.logger.safe.debug(`getClient: ${e}`),this.clientGenerationStrategy.getClient()}getOriginalMediaStream(){return this.originalMediaStream}getResolution(){if(!["Video","ScreenShare","PanoramicVideo"].some((e=>e===this.mediaType)))return null;const e={width:this.currentConstraints.video.minWidth,height:this.currentConstraints.video.minHeight},t=aA(this.mediaStream),i=t??e,n=`Stream resolution is ${i.width}x${i.height}.`;return t?this.logger.safe.info(n):this.logger.safe.error(`${n}. Resolution not found, assuming default resolution.'`),i}getFrameRate(){if(!["Video","ScreenShare","PanoramicVideo"].some((e=>e===this.mediaType)))return null;const e=lA(this.mediaStream);return 0===e?this.logger.safe.error("Stream frame rate is not avalable, returning 0"):this.logger.safe.info(`Stream fps is ${e}`),e}getMediaType(e){if(e.sharing)return"ScreenShare";if(e.video)return"Video";if(e.audio)return"Audio";throw new Error(`Media type is not defined: ${JSON.stringify(e)}`)}resetEffectsOutputConstraints(e){const t=aA(this.originalMediaStream);this.effectManager.resetOutputConstraints("Video",{width:Math.min(e.width,t.width||Number.MAX_SAFE_INTEGER),height:Math.min(e.height,t.height||Number.MAX_SAFE_INTEGER)})}initialize(e){this.constraintsProvider=zI.getProvider(this.mediaType,this.configProvider,this.logger),this.currentConstraints=this.constraintsProvider.createConstraintsObject(e),this.gumStreamProvider=nA.getStreamProvider(this.mediaType,this.configProvider,this.logger),this.mediaStreamRequestStrategy=gA.getStrategy(this.mediaType,this.gumStreamProvider,this.serialQueue,this.logger,this.configProvider,!!this.currentConstraints.withOverridenStream),this.clientGenerationStrategy=new pA(this,this.currentConstraints,this.constraintsProvider,this.gumStreamProvider,this.configProvider,this.logger),this.clientGenerationStrategy.on("onAllClientsDisposed",(()=>this.onAllClientsDisposed()))}onAllClientsDisposed(){this.logger.safe.info("All clients are disposed, disposing master stream"),this.dispose()}async startStream(e){try{await this.getOrCreateMediaStream(e),this.event("onStreamStarted").raise(this,this.currentConstraints)}catch(e){throw this.event("onStreamError").raise(this,e),e}}async getOrCreateMediaStream(e){if(this.mediaStream)return Promise.resolve();const t=this.getRequestStartTimestamp(),i=await this.mediaStreamRequestStrategy.getStream(e);return this.gumRequestTime=this.getRequestDuration(t),this.handleMediaStreamRequestSuccess(i,e)}async handleMediaStreamRequestSuccess(e,t){const i=t.withOverridenStream&&t.withEffect&&this.configProvider.config.useRawMediaApiForVideoEffects;this.logger.safe.info(`Media stream acquired: ${rm(e)} with constraints: ${JSON.stringify(Jg(t))}`),this.originalMediaStream=e,this.subscribeToTrackEvents(this.originalMediaStream),t.withEffect&&!i?this.mediaStream=await this.getVideoEffectStream(e):this.mediaStream=e,"Audio"===this.mediaType&&await this.startNoiseSuppression(),this.currentConstraints=t,this.applyState(this.mediaStream),this.event("onStreamAcquired").raise(this,this.gumRequestTime,"Audio"!==this.mediaType&&this.getResolution()||void 0)}async getVideoEffectStream(e){this.sub=this.effectManager.on("onVideoStreamQualityChanged",((e,t,i)=>this.onVideoStreamQualityChanged(e,t,i)));const t=await this.effectManager.startEffect("Video",e);return this.logger.safe.info(`Media stream switched: ${rm(e)} -> ${rm(t)}`),t}subscribeToTrackEvents(e){const t=e?this.getTrackByMediaType(e,this.mediaType):null;t&&(t.onended=e=>{this.logger.safe.info(`Track ${t.id} ended: ${JSON.stringify(e)}`),this.event("onStreamTrackEnded").raise(this,e)},t.onmute=()=>{this.logger.safe.info(`Track ${t.id} muted`),this.event("onStreamTrackMuted").raise(this,!0)},t.onunmute=()=>{this.logger.safe.info(`Track ${t.id} unmute`),this.event("onStreamTrackMuted").raise(this,!1)})}unsubscribeFromTrackEvents(e){const t=e?this.getTrackByMediaType(e,this.mediaType):null;t&&(t.onended=null,t.onmute=null,t.onunmute=null)}getTrackByMediaType(e,t){return"Audio"===t?e.getAudioTracks()[0]:e.getVideoTracks()[0]}removeVideoEffectStream(){this.sub?.dispose(),this.effectManager.stopEffect("Video",this.mediaStream)}applyState(e){e.getAudioTracks()?.forEach((e=>this.applyAudioState(e)));const t=e.getVideoTracks()[0];this.applyVideoState(t)}applyAudioState(e){e&&(this.hasNonDefaultAudioProcessingConstraints()||"ScreenShare"===this.mediaType?this.applyContentHint(e,"music"):this.configProvider.config.defaultAudioContentHint&&this.applyContentHint(e,this.configProvider.config.defaultAudioContentHint),e.muted&&this.event("onStreamTrackMuted").raise(this,!0),this.logger.safe.info(`Audio track added: ${JSON.stringify(e.id)}`))}applyVideoState(e){e&&("ScreenShare"===this.mediaType&&this.configProvider.config.webrtcDisplayStreamContentHint&&this.applyContentHint(e,this.configProvider.config.webrtcDisplayStreamContentHint),this.logger.safe.info(`Video track added: ${JSON.stringify(e.id)}`))}applyContentHint(e,t){this.logger.safe.info(`Apply content hint: ${t}`),e.contentHint=t}hasNonDefaultAudioProcessingConstraints(){const e=this.currentConstraints.audio;if(e){const t=this.configProvider.config.defaultAudioProcessingFlags;let i;return void 0===e.echoCancellation&&void 0===e.autoGainControl&&void 0===e.noiseSuppression||(i=0,void 0!==e.echoCancellation&&(i+=e.echoCancellation?2:0),void 0!==e.autoGainControl&&(i+=e.autoGainControl?1:0),void 0!==e.noiseSuppression&&(i+=e.noiseSuppression?4:0)),i!==t}return!1}getRequestStartTimestamp(){return Date.now()}getRequestDuration(e){return 0===e?0:Date.now()-e}async startNoiseSuppression(){this.logger.safe.info(`ECS keys for wasmvqe are: ${JSON.stringify(this.configProvider.config.wasmvqe)}`),this.logger.safe.info(`ECS keys for wasmdns are: ${JSON.stringify(this.configProvider.config.wasmdns)}`),this.mediaStream=await this.effectManager.startEffect("Audio",this.mediaStream)}stopMediaStream(e){return this.mediaStreamStartPromise?(this.logger.safe.info(`Queueing media stream stop: ${e}`),this.serialQueue.add((()=>this.stopMediaStreamInternal()))):Promise.resolve()}stopOneMediaStream(e){try{e.getTracks().forEach((e=>{this.logger.safe.info(`Track is stopped: ${JSON.stringify(e.id)}`),e.stop()})),this.logger.safe.info(`Media stream stopped: ${e.id}`)}catch(e){this.logger.safe.warn(`Failed to stop media stream: ${Ge(e)}`)}}stopMediaStreamInternal(){"Video"===this.mediaType&&this.configProvider.config.enableVideoEffects&&this.removeVideoEffectStream(),this.mediaStream&&(this.stopOneMediaStream(this.mediaStream),this.mediaStream=null),this.originalMediaStream&&(this.stopOneMediaStream(this.originalMediaStream),this.unsubscribeFromTrackEvents(this.originalMediaStream),this.originalMediaStream=null)}onVideoStreamQualityChanged(e,t,i){this.logger.safe.debug(`onStreamQualityChanged: ${JSON.stringify(e)}@${t}, reason=${i}`),this.event("onStreamQualityChanged").raise(this,e,t,i)}};yA.streamId=0;var CA=yA,TA=class e extends Qe{constructor(e,t,i){super(e),this.logger=e,this.configProvider=t,this.effectsManager=i,this.cachedStreamsSubs=new Map,this.cachedStreamsMap=new Map,this.mediaStreamSerialQueue=new _I(this.logger),this.couldUseWebrtc_1_0=!1}getMediaStream(e,t){this.logger.safe.info(`retrieving media stream: ${JSON.stringify(Jg(e))}`),this.cachedStreamsMap.size||(this.couldUseWebrtc_1_0=Qg(this.configProvider.config.checkSupportForWebrtc_1_0));let i=this.getSuitableStream(e);i||(this.logger.safe.info(`cached stream is not found. Creating a new one with constraints: ${Ge(Jg(e))}`),i=this.createCachedStream(e)),this.logger.safe.info(`starting cached stream id=${i.id}`,t);const n=i.getClient(t);return n.start().catch((e=>{this.logger.safe.error(`could not start media stream: ${i.id}, total streams: ${this.cachedStreamsMap.size}, error: ${Ge(e)}`),this.removeStream(i)})),n}dispose(){this.cachedStreamsSubs&&(this.cachedStreamsSubs.forEach((e=>{e.forEach((e=>{e.dispose()}))})),this.cachedStreamsSubs=null),this.cachedStreamsMap&&(this.cachedStreamsMap.forEach((e=>e.dispose("MSM dispose"))),this.cachedStreamsMap=null),this.mediaStreamSerialQueue&&(this.mediaStreamSerialQueue.dispose(),this.mediaStreamSerialQueue=null),super.dispose()}getCachedStreams(){return this.cachedStreamsMap}getActiveConstraints(){const e={audio:!1,video:!1,sharing:!1};return this.cachedStreamsMap.forEach(((t,i)=>{i.audio&&(e.audio=!0),i.video&&(e.video=!0),i.sharing&&(e.sharing=!0)})),e}onDevicesChanged(t){this.configProvider.config.enablePermissionsWorkaround&&e.isDeviceListEmpty(t)?this.logger.safe.info("Device list is empty, permission workaround enabled"):this.cachedStreamsMap.forEach(((e,i)=>{if(!i.sharing){const e=this.isDeviceOutdated(i.audio,t),n=this.isDeviceOutdated(i.video,t);(e||n)&&this.cachedStreamsMap.delete(i)}}))}getSuitableStream(e){let t;return this.cachedStreamsMap.forEach(((i,n)=>{this.isSuitable(this.addDeviceIdIfNecessary(i,n),e)&&(t=n)})),t&&this.cachedStreamsMap.get(t)}addDeviceIdIfNecessary(e,t){if(!e.deviceId)return t;const i=this.cloneStreamConstraints(t);return t.audio&&void 0===t.audio.deviceId&&(i.audio.deviceId=e.deviceId),t.video&&void 0===t.video.deviceId&&(i.video.deviceId=e.deviceId),t.sharing&&(i.sharing.deviceId=tt.DISPLAY_SOURCE_ID),i}cloneStreamConstraints(e){return{...ut(e),withOverridenStream:e.withOverridenStream}}createCachedStream(e){const t=this.createStream(e);return this.event("onStreamCreated").raise(t.id,t.mediaType),this.subscribeOnStreamEvents(t),this.logger.safe.info(`created media stream, id: ${t.id} total: ${this.cachedStreamsMap.size}`),this.cachedStreamsMap.set(e,t),t}disposeCurrentDeviceStream(t){for(const[i,n]of this.cachedStreamsMap.entries())t.sharing||i.sharing||(e.deviceChanged(t.audio,i.audio)||e.deviceChanged(t.video,i.video))&&n.dispose("MSM dispose oneStreamPerDeviceType")}createStream(e){return this.configProvider.config.oneStreamPerDeviceType&&this.couldUseWebrtc_1_0&&this.disposeCurrentDeviceStream(e),this.configProvider.config.webrtcSimulcastSessionEnabled&&Cg.hasApplyConstraints()&&this.couldUseWebrtc_1_0?new CA(e,this.mediaStreamSerialQueue,this.configProvider,this.logger,this.effectsManager):new hA(e,this.mediaStreamSerialQueue,this.logger,this.configProvider)}subscribeOnStreamEvents(e){const t=[];t.push(e.on("onStreamAcquired",((e,t,i)=>this.onStreamAcquired(e,t,i)))),t.push(e.on("onStreamDisposing",(e=>this.onStreamDisposing(e)))),this.cachedStreamsSubs.set(e,t)}unsubscribeFromStreamEvents(e){this.cachedStreamsSubs.get(e).forEach((e=>e.dispose())),this.cachedStreamsSubs.delete(e)}removeStream(e){this.logger.safe.info(`release media stream generation: ${e.id} cached: ${this.cachedStreamsMap.size}`),this.cachedStreamsSubs.has(e)?(this.unsubscribeFromStreamEvents(e),this.cachedStreamsMap.delete(this.getConstraintsForStream(e)),this.getStreamsCountByType("Audio")||this.effectsManager.stopEffect("Audio"),this.cachedStreamsMap.size||this.event("onAllStreamsRemoved").raise()):this.logger.safe.warn(`skipping unknown stream ${e.id}`)}getConstraintsForStream(e){let t;return this.cachedStreamsMap.forEach(((i,n)=>{e===i&&(t=n)})),t}isSuitable(e,t){const i=!(!e.withOverridenStream||!t.withOverridenStream),n=i||t.sharing||this.isAcceptable(e.audio,t.audio)&&e.audioProcessingFlags===t.audioProcessingFlags,r=i||this.isAcceptable(e.video,t.video),s=this.configProvider.config.requireUserActionForAudioSharing&&t.sharing&&!!e.audio!=!!t.audio,a=this.isAcceptable(e.sharing,t.sharing),o=a&&this.isAcceptable(e.audio,t.audio),l=s?o:a,d=e.withEffect===t.withEffect,c=e.withOverridenStream?.id===t.withOverridenStream?.id;return!t.force&&n&&r&&l&&d&&c}isAcceptable(e,t){return!e&&!t||e&&t&&e.deviceId===t.deviceId}isDeviceOutdated(e,t){return e?.deviceId&&!t.some((t=>t.deviceId===e.deviceId))}onStreamDisposing(e){this.logger.safe.info(`onStreamDisposing event ${e.id}`),this.event("onStreamDisposing").raise(e.id,e.mediaType),this.removeStream(e)}onStreamAcquired(e,t,i){const n="Audio"===e.mediaType?void 0:!!e.rawStream.getAudioTracks()[0],r="ScreenShare"===e.mediaType?this.getSharingSource(e):void 0;this.event("onStreamAcquired").raise(e.id,e.mediaType,t,i,n,r)}getSharingSource(e){const t=e.rawStream.getVideoTracks()[0],i=t.getConstraints();if(i?.deviceId)return"camera";const n=t.getSettings();return n?.displaySurface??"unknown"}static deviceChanged(e,t){return!(!e||!t)&&e.deviceId!==t.deviceId}static isDeviceListEmpty(e){return e.every((e=>""===e.label))}getStreamsCountByType(e){let t=0;return this.cachedStreamsMap.forEach((i=>{t+=i.mediaType===e?1:0})),t}},EA=class{constructor(e,t,i,n,r){this.deviceId=e,this.label=t,this.kind=i,this.groupId=n,this.capabilities=r,this.type=this.getType(this.kind),this.guid=`${this.type}:${this.deviceId}`,this.isSystemDefault=this.deviceId===tt.MEDIA_DEVICE.defaultId}toDeviceDesc(){return{id:this.guid,browserId:this.deviceId,label:this.label,kind:this.type}}getType(e){switch(e){case tt.MEDIA_DEVICE_KIND.audioInput:return tt.MEDIA_DEVICE.microphone;case tt.MEDIA_DEVICE_KIND.audioOutput:return tt.MEDIA_DEVICE.speaker;case tt.MEDIA_DEVICE_KIND.videoInput:return tt.MEDIA_DEVICE.camera;case tt.MEDIA_DEVICE_KIND.compositeAudio:return tt.MEDIA_DEVICE.compositeAudio;case tt.MEDIA_DEVICE_KIND.virtualDevice:return tt.MEDIA_DEVICE.virtualDevice;default:throw new Error(`Device kind to recognized: ${e}`)}}},_A=class extends EA{constructor(e,t,i,n){super(e,t,i,n)}},bA=class extends EA{constructor(e,t,i,n,r){super(e,t,i,n,r)}toDeviceDesc(){const e=super.toDeviceDesc();return e.isSystemDefault=this.isSystemDefault,e}},PA=class extends EA{constructor(e,t,i,n,r){if(super(e,t,i,n,r),this.position="unknown",r&&r.facingMode&&1===r.facingMode.length)switch(r.facingMode[0]){case"user":this.position="front";break;case"environment":this.position="back"}}toDeviceDesc(){const e=super.toDeviceDesc();return e.position=this.position,e}},IA=class extends EA{constructor(e,t,i,n,r,s){super(null,i,n,""),this.micDevice=e,this.speakerDevice=t,this.formFactor=r,this.isPcInternalDevice=s,this.guid=null,this.isSystemDefault=!1}get micDeviceId(){return this.micDevice.guid}get speakerDeviceId(){return this.speakerDevice.guid}toDeviceDesc(){const e=super.toDeviceDesc();return e.microphoneId=this.micDeviceId,e.speakerId=this.speakerDeviceId,e.formFactor=this.formFactor,e.isPcInternalDevice=this.isPcInternalDevice,e}};function AA(e){const t=e.getCapabilities&&e.getCapabilities();switch(t&&(delete t.groupId,delete t.deviceId),e.kind){case tt.MEDIA_DEVICE_KIND.audioInput:case tt.MEDIA_DEVICE_KIND.audioOutput:return new bA(e.deviceId,e.label,e.kind,e.groupId,t);case tt.MEDIA_DEVICE_KIND.videoInput:return new PA(e.deviceId,e.label,e.kind,e.groupId,t);default:throw new Error(`Device kind is not recognized: ${e.kind}`)}}function RA(e,t,i){return new IA(e,t,i,"compositeAudio",0,!1)}function wA(e){switch(e){case tt.MEDIA_DEVICE.microphone:return tt.MEDIA_DEVICE_KIND.audioInput;case tt.MEDIA_DEVICE.speaker:return tt.MEDIA_DEVICE_KIND.audioOutput;case tt.MEDIA_DEVICE.camera:return tt.MEDIA_DEVICE_KIND.videoInput;default:throw new Error(`Device type to recognized: ${e}`)}}function MA(e,t,i,n,r={str:""}){r.str+=`|input(${t.length})`;let s=[];const a=[n.config.devices.blacklist[e],n.defaultConfig.devices.blacklist[e]];for(const e of a)try{const i=new RegExp(e,"i");s=t.filter((t=>e&&t.label.match(i)?(r.str+=`|-blacklisted(${t.label})`,!1):t.deviceId!==tt.MEDIA_DEVICE.communicationsId||(r.str+="|-communications",!1)));break}catch(i){r.str+=`|filterError('${e}', ${Ge(i)})`,s=t}if(s.length){const t=function(e,t,i){if(1===t.length)return i.str+="|default:only",t[0];const n=t.find((e=>e.isSystemDefault&&e.deviceId===tt.MEDIA_DEVICE.defaultId));if(!n)return i.str+="|default:noSynthetic",t.find((e=>e.isSystemDefault))||t[0];{const s=t.filter((e=>e!==n));if(1===s.length)return i.str+="|default:firstNonDefault",s[0];if(""!==n.groupId){const e=s.filter((e=>e.groupId===n.groupId));if(1===e.length)return i.str+=`|default:groupId(${ke(e[0].guid)})`,e[0]}const a=s.map((e=>e.label)),o=(r=n.label,a.reduce(((e,t)=>{const i=r.includes(t)?t.length:0;return e.length<i?t:e}),"")),l=s.find((e=>e.label===o));if(l)return i.str+=`|default:label(${ke(l.guid)})`,l;const d=e.find((e=>e.isSystemDefault));if(d){const e=s.find((e=>e.deviceId===d.deviceId));if(e)return i.str+=`|default:previousList(${ke(e.guid)})`,e}}var r;return i.str+="|default:anyOrNull",t.find((e=>e.isSystemDefault))||null}(i,s,r);if(t&&(t.isSystemDefault=!0,r.str+=`|default(${ke(t.guid)})`),t&&t.deviceId!==tt.MEDIA_DEVICE.defaultId&&s.length>1&&(s=s.filter((e=>e.deviceId!==tt.MEDIA_DEVICE.defaultId||(r.str+="|-defaultId",!1)))),e===tt.MEDIA_DEVICE.camera||t||(r.str+="|+syntheticDefault",s.unshift(function(e){const t={deviceId:tt.MEDIA_DEVICE.defaultId,label:tt.MEDIA_DEVICE.defaultDeviceLabel,kind:wA(e),groupId:"",toJSON:()=>JSON.stringify(t)};return AA(t)}(e))),i.forEach((e=>{const t=s.find((t=>t.guid===e.guid));t&&!t.label&&e.label&&(r.str+=`|migrateLabel(${ke(t.guid)})`,t.label=e.label)})),e===tt.MEDIA_DEVICE.speaker){const e=s.filter((e=>""===e.label));e.length>1&&e.length===s.length&&(s=t?[t]:[s[0]],r.str+=`|-filteredEmptyLabels(${e.length})`)}}return s}function OA(e,t,i=.5,n={str:""}){const r=[];if(e.length&&t.length){const s=function(e,t,i={str:""}){const n=new Set;for(const i of[...e,...t])n.add(i.groupId);const r=[];for(const s of n.values()){let n=e.filter((e=>e.groupId===s)),a=t.filter((e=>e.groupId===s));if(n&&a)if(1===n.length&&1===a.length)r.push({microphone:n[0],speaker:a[0]}),i.str+=`|pairSimple(${ke(n[0].guid)}, ${ke(a[0].guid)})`;else if(n.length>1||a.length>1){let e=DA(n,a);for(;e;)i.str+=`|pairComplex(${ke(e.microphone.guid)}, ${ke(e.speaker.guid)})`,r.push(e),n=n.filter((t=>t!==e.microphone)),a=a.filter((t=>t!==e.speaker)),e=DA(n,a)}}return r}(e.filter((e=>""!==e.groupId)),t.filter((e=>""!==e.groupId)),n);s.length&&(r.push(...s.map((e=>RA(e.microphone,e.speaker,kA(e.microphone.label,e.speaker.label))))),n.str+=`|directMatched(${r.length})`);const a=r.length;r.push(...function(e,t,i,n){const r=[];return e.length&&t.length?(e.forEach((e=>{const s=t.filter((t=>t.groupId===e.groupId));if(!s.length)return void(n.str+=`|lbl_nocand(${ke(e.guid)})`);let a=Et(e.label,s[0].label).length;const o=s.sort(((t,i)=>{const n=Et(e.label,t.label),r=Et(e.label,i.label);return n.length>a&&(a=n.length),r.length>a&&(a=r.length),r.length-n.length}));if(o.length){const t=a/e.label.length;t>i&&(r.push(RA(e,o[0],kA(e.label,o[0].label))),n.str+=`|lbl_matched(${ke(e.guid)} & ${ke(o[0].guid)}, ${Math.round(1e4*t)/100}%)`)}})),r):r}(e.filter((e=>!r.some((t=>t.micDeviceId===e.guid)))),t.filter((e=>!r.some((t=>t.speakerDeviceId===e.guid)))),i,n)),n.str+=`|otherMatched(${r.length-a})`}return r}function DA(e,t){let i=999,n=null;if(e.length>0&&t.length>0)for(const r of e)for(const e of t){const t=_t(r.label,e.label);t<i&&(i=t,n={microphone:r,speaker:e})}return n}function kA(e,t){if(e===t)return e;let i=Et(e,t);i=i.trim().replace(/^\((.+)\)$/,"$1");let n="",r="",s=0;const a=[NA(e),NA(t)];if(0===a[0]||0===a[1])return i;for(let e=0;e<i.length;e++)if("("===i[e])s++,r+=i[e];else if(")"===i[e]){if(!(s>0))break;s--,r+=i[e],n+=r,r=""}else s>0?r+=i[e]:n+=i[e];const o=NA(n);return o!==a[0]&&o!==a[1]||(n=n.replace(/\w+\s?\((.+)\)/,"$1"),n=kA(i,n)),n.trim()}function NA(e){const t=["(",")"];let i=0;for(let n=0;n<e.length;n++)t.some((t=>e[n]===t))&&i++;return i}var LA={microphone:"",camera:"",speaker:"",compositeAudio:"",audioIngestDevice:"",virtualDevice:""},xA=class extends Qe{constructor(e,t){super(t),this.configProvider=e,this.logger=t,this.debugInfo=LA,this.lists=new Map,this.lists.set(tt.MEDIA_DEVICE.microphone,[]),this.lists.set(tt.MEDIA_DEVICE.camera,[]),this.configProvider.userAgentConfig.isAudioOutputSelectionSupported&&(this.lists.set(tt.MEDIA_DEVICE.speaker,[]),this.lists.set(tt.MEDIA_DEVICE.compositeAudio,[])),e.userAgentConfig.on("isAudioOutputSelectionSupportedChanged",(()=>this.onConfigUpdated())),this.logger.safe.info("Initialized")}get devices(){const e=[];return this.lists.forEach((t=>e.push(...t))),e}getDevicesByType(e){return this.lists.get(e)??[]}updateDevices(e,t=!1){if(mt(this.latestRawList,e))return;this.latestRawList=e;const i=this.devices;this.debugInfo.microphone="microphone",this.debugInfo.camera="camera",this.debugInfo.speaker="speaker",this.debugInfo.compositeAudio="compositeAudio",this.updatePrimitiveDeviceList(tt.MEDIA_DEVICE.microphone,e.filter((e=>e.type===tt.MEDIA_DEVICE.microphone))),this.updatePrimitiveDeviceList(tt.MEDIA_DEVICE.camera,e.filter((e=>e.type===tt.MEDIA_DEVICE.camera))),this.lists.get(tt.MEDIA_DEVICE.speaker)&&(this.updatePrimitiveDeviceList(tt.MEDIA_DEVICE.speaker,e.filter((e=>e.type===tt.MEDIA_DEVICE.speaker))),this.lists.get(tt.MEDIA_DEVICE.compositeAudio)&&this.updateCompositeAudioDeviceList(this.lists.get(tt.MEDIA_DEVICE.microphone),this.lists.get(tt.MEDIA_DEVICE.speaker)));const n=this.lists.get(tt.MEDIA_DEVICE.compositeAudio)||[];this.lists.set(tt.MEDIA_DEVICE.microphone,this.orderDeviceList(this.lists.get(tt.MEDIA_DEVICE.microphone),n)),this.lists.get(tt.MEDIA_DEVICE.speaker)&&this.lists.set(tt.MEDIA_DEVICE.speaker,this.orderDeviceList(this.lists.get(tt.MEDIA_DEVICE.speaker),n));const r=this.lists.get(tt.MEDIA_DEVICE.microphone);this.setTopItemToDefault(r);const s=this.lists.get(tt.MEDIA_DEVICE.speaker);this.setTopItemToDefault(s),mt(i,this.devices)||(this.logger.safe.info("Device lists updated and changed"),this.logger.safe.info(this.debugInfo.microphone),this.logger.safe.info(this.debugInfo.camera),this.logger.safe.info(this.debugInfo.speaker),this.logger.safe.info(this.debugInfo.compositeAudio),this.event("onDevicesChanged").raise(this.devices,t))}updateVirtualDeviceList(e){const t=this.lists.get(tt.MEDIA_DEVICE.virtualDevice),i=e.map((e=>new _A(e.id,e.label,"virtualDevice","")));mt(t,i)?this.logger.safe.info("Device lists did not change."):(this.lists.set(tt.MEDIA_DEVICE.virtualDevice,i),this.event("onDevicesChanged").raise(this.devices,!1))}updateActiveMicrophone(e){if(!e||e.deviceId===tt.MEDIA_DEVICE.defaultId)return;const t=this.lists.get(tt.MEDIA_DEVICE.microphone),i=t.findIndex((e=>e.isSystemDefault));-1!==i&&t[i]!==e?(this.logger.safe.info("Removing synthetic default microphone"),e.isSystemDefault=!0,t.splice(i,1),this.lists.set(tt.MEDIA_DEVICE.microphone,t),this.event("onDevicesChanged").raise(this.devices,!1)):e.isSystemDefault=!0}updatePrimitiveDeviceList(e,t){const i={str:this.debugInfo[e]};this.lists.set(e,MA(e,t,this.lists.get(e)||[],this.configProvider,i)),this.debugInfo[e]=i.str}updateCompositeAudioDeviceList(e,t){const i={str:this.debugInfo.compositeAudio};this.lists.set(tt.MEDIA_DEVICE.compositeAudio,OA(e,t,this.configProvider.config.devices.compositeLabelMatchingThreshold,i)),this.debugInfo.compositeAudio=i.str}orderDeviceList(e,t){return e.sort(((e,i)=>this.getDevicePriority(i,this.getCompositeAudioDeviceCounterpart(i,t))-this.getDevicePriority(e,this.getCompositeAudioDeviceCounterpart(e,t))))}getCompositeAudioDeviceCounterpart(e,t){const i=t.find((t=>t.micDeviceId===e.guid||t.speakerDeviceId===e.guid));return i?i[e.type===tt.MEDIA_DEVICE.speaker?"micDevice":"speakerDevice"]:null}getDevicePriority(e,t){let i=0;return this.configProvider.config.devices.overrideDefault&&t&&(!e.isSystemDefault&&t.isSystemDefault?(this.debugInfo[e.type]+=`|overrideDefault(${ke(e.guid)})`,i+=10):e.isSystemDefault&&!t.isSystemDefault&&"microphone"===e.type&&(i+=15)),e.isSystemDefault&&(i+=5),t&&(i+=1,t.isSystemDefault&&(i+=2)),i}setTopItemToDefault(e){e?.length&&(e.forEach((e=>e.isSystemDefault=!1)),e[0].isSystemDefault=!0)}onConfigUpdated(){let e=!1;this.configProvider.userAgentConfig.isAudioOutputSelectionSupported?this.lists.has(tt.MEDIA_DEVICE.speaker)||(this.lists.set(tt.MEDIA_DEVICE.speaker,[]),this.lists.set(tt.MEDIA_DEVICE.compositeAudio,[]),e=!0):(this.lists.has(tt.MEDIA_DEVICE.speaker)&&(this.lists.delete(tt.MEDIA_DEVICE.speaker),e=!0),this.lists.has(tt.MEDIA_DEVICE.compositeAudio)&&(this.lists.delete(tt.MEDIA_DEVICE.compositeAudio),e=!0)),e&&(this.logger.safe.info("Updating device list due to config update"),this.updateDevices(this.latestRawList||[]))}},FA=class e extends Qe{constructor(t,i){super(i),this.pollingInterval=0,e.enumeratorUsers.add(this),e.initialize(this,t,i)}startDevicePolling(t){this.pollingInterval=t?e.configProvider.config.devices.pollingIntervalIdle:e.configProvider.config.devices.pollingIntervalActive,e.updatePollingTask()}stopDevicePolling(t){this.pollingInterval=t?0:e.configProvider.config.devices.pollingIntervalIdle,e.updatePollingTask()}dispose(){super.dispose(),this.stopDevicePolling(!0),e.enumeratorUsers.delete(this),0===e.enumeratorUsers.size&&(e.logger.safe.info("disposing"),e.initializeCalled=!1,e.isInitialized=new Mu,e.list=void 0,e.window.navigator.mediaDevices.ondevicechange=void 0)}static get isPolling(){return 0!==e.currentPollingInterval}static initialize(t,i,n){e.initializeCalled||(e.initializeCalled=!0,e.window=yg.window,e.configProvider=i,e.logger=n,e.list=new xA(i,n.createChild("DeviceList")),i.userAgentConfig.on("isAudioOutputSelectionSupportedChanged",(()=>e.enumerateDevices())),i.on("configUpdated",(()=>{void 0!==i.config.devices.pollingIntervalIdle&&null!==e.pollingTimer&&t.startDevicePolling(!0)})),i.config.devices.pollingIntervalIdle&&i.config.devices.idlePollingOnStart&&t.startDevicePolling(!0),e.window.navigator.mediaDevices&&(e.window.navigator.mediaDevices.ondevicechange=()=>{n.safe.info("enumerating due to ondevicechange callback"),e.enumerateDevices().catch((e=>{n.safe.error(`unable to enumerate ondevicechange: ${Ge(e)}`)}))}),e.enumerateDevices().then((()=>e.isInitialized.resolve())).catch((t=>e.isInitialized.reject(t))))}static async enumerateDevices(t=!1){if(!e.window.navigator?.mediaDevices?.enumerateDevices)throw new Error("device enumeration unsupported");if(e.enumerateDevicesPromise&&!t)return e.logger.safe.info("enumeration request postponed"),void(e.hasPendingUpdate=!0);try{e.enumerateDevicesPromise??(e.enumerateDevicesPromise=e.configProvider.config.devices.enumerateDevicesTimeout?function(e,t,i,n){let r;const s=[e,new Promise(((e,n)=>{r=setTimeout(n.bind(null,new Error(`Promise timed out ${i?`: ${i}`:""} after ${t} ms`)),t)}))];n&&s.push(n);const a=Promise.race(s),o=()=>{r&&clearTimeout(r)};return a.then(o,o),a}(e.window.navigator.mediaDevices.enumerateDevices(),e.configProvider.config.devices.enumerateDevicesTimeout,"enumerateDevices"):e.window.navigator.mediaDevices.enumerateDevices());const i=await e.enumerateDevicesPromise;e.list.updateDevices(i.map((e=>AA(e))),t)}catch(t){const i=Ge(t);throw e.logger.safe.warn(`error with enumerating devices: ${i}`),e.raiseFailedEnumeration(i),t}finally{e.enumerateDevicesPromise=void 0,e.hasPendingUpdate&&(e.hasPendingUpdate=!1,e.logger.safe.info("running postponed enumeration"),e.enumerateDevices())}}static updatePollingTask(){let t=Number.MAX_SAFE_INTEGER;for(const i of e.enumeratorUsers.values())i.pollingInterval<t&&(t=i.pollingInterval);if(t===Number.MAX_SAFE_INTEGER&&(t=0),(e.pollingTimer||e.currentPollingInterval!==t)&&e.pollingTimer&&(e.window.clearTimeout(e.pollingTimer),e.pollingTimer=void 0),e.currentPollingInterval=t,0===t)return;const i=async()=>{if(e.currentPollingInterval)try{await e.enumerateDevices(!0),e.pollingTimer=e.window.setTimeout(i,e.currentPollingInterval)}catch(t){throw e.pollingTimer=null,t}};e.logger.safe.info(`starting device polling with interval ${t}ms`),e.pollingTimer=1,i()}static raiseFailedEnumeration(t){for(const i of e.enumeratorUsers.values())i.event("onDeviceEnumerationfailed").raise(t)}};FA.isInitialized=new Mu,FA.initializeCalled=!1,FA.currentPollingInterval=0,FA.hasPendingUpdate=!1,FA.enumeratorUsers=new Set;var UA=FA,VA=class extends Qe{constructor(e,t,i){super(i),this.deviceList=e,this.configProvider=t,this.logger=i,this.userSelectedDevices={microphone:null,camera:null,speaker:null},this.currentlySelectedDevices={microphone:null,camera:null,speaker:null,audioIngestDevice:null},this.deviceList.on("onDevicesChanged",(e=>this.onDevicesChanged(e))),e.devices.length>0&&this.onDevicesChanged(e.devices),this.logger.safe.info("Initialized")}get selectedDevices(){return ut(this.currentlySelectedDevices)}selectDevices(e){let t=!1;if(it(e,((e,i)=>{const n=this.getDeviceToSelect(i,this.deviceList.getDevicesByType("audioIngestDevice"===i?"microphone":i),e);"camera"===i&&(this.userSelectedDevices[i]=n?.guid||this.userSelectedDevices[i]),n?.guid!==this.currentlySelectedDevices[i]?.guid&&(this.userSelectedDevices[i]=n?.guid||this.userSelectedDevices[i],t=!0),this.currentlySelectedDevices[i]=n})),t){const e=lt(this.currentlySelectedDevices).map((e=>JSON.stringify(Kg(e,this.configProvider.config.devices.piiSafeWords))));this.logger.safe.info(`Changed from public interface: ${e}`),this.event("onSelectedDevicesChanged").raise(this.selectedDevices,!0)}}getDeviceToSelect(e,t,i){let n;const r=this.userSelectedDevices[e];return i?n=t.find((e=>e.guid===i)):r&&(n=t.find((e=>e.guid===r))),"audioIngestDevice"===e?n:n||t[0]}onDevicesChanged(e){let t=!1;if(Object.keys(this.currentlySelectedDevices).forEach((i=>{const n="audioIngestDevice"===i?"microphone":i,r=e.filter((e=>e.type===n));if(r.length>0){const e=this.getDeviceToSelect(i,r);e?.guid!==this.currentlySelectedDevices[i]?.guid&&(this.currentlySelectedDevices[i]=e,t=!0)}else this.currentlySelectedDevices[i]&&(this.currentlySelectedDevices[i]=null,t=!0)})),t){const e=lt(this.currentlySelectedDevices).map((e=>JSON.stringify(Kg(e,this.configProvider.config.devices.piiSafeWords))));this.logger.safe.info(`Changed due to device list change: ${e}`),this.event("onSelectedDevicesChanged").raise(this.selectedDevices,!1)}}},HA=class extends Qe{constructor(e,t){super(e),this.logger=e,this.mediaStream=t,this.subs=[],this.subscribeOnMediaStreamEvents(t)}acquire(){return this.mediaStream?this.mediaStream.start().then((()=>this.logger.safe.info("Stream acquired"))).catch((e=>{throw this.logger.safe.warn(`Failed to acquire the stream: ${Ge(e)}`),e})):Promise.reject("Disposed")}dispose(){this.logger.safe.info("Disposing stream"),this.unsubscribeFromMediaStreamEvents(),this.mediaStream&&(this.mediaStream.dispose(),this.mediaStream=null)}subscribeOnMediaStreamEvents(e){this.subs=[e.on("onStreamClientStarted",(()=>this.event("onStreamStateChanged").raise("active"))),e.on("onStreamClientMuted",((e,t)=>this.event("onStreamStateChanged").raise(t?"inactive":"active"))),e.on("onStreamClientEnded",(()=>this.event("onStreamStateChanged").raise("stopped"))),e.on("onStreamClientError",((e,t)=>{const i=t.type===tt.MEDIA_ERROR.permissionDeniedError||t.type===tt.MEDIA_ERROR.sharingCancelledError;this.event("onStreamStateChanged").raise(i?"cancelled":"failed")}))]}unsubscribeFromMediaStreamEvents(){this.subs.forEach((e=>e.dispose())),this.subs=[]}},BA=[tt.MEDIA_STATE.inactive,tt.MEDIA_STATE.receive,tt.MEDIA_STATE.send,tt.MEDIA_STATE.sendReceive],$A=[tt.MEDIA_STATE.inactive,tt.MEDIA_STATE.receive],jA=class extends Qe{constructor(e,t,i){super(i),this.configProvider=e,this.deviceManager=t,this.logger=i,this.currentState={microphone:"unknown",camera:"unknown"},this.lastGum={audio:!1,video:!1},this.registeredTrackers=new Set,this.accessIssuePermissionOther={audio:!1,video:!1},this.window=yg.window,this.permittedModalities={audio:BA,video:BA,sharing:BA},this.initialize()}async initialize(){!Cg.hasPermissionsApi()||"unknown"!==this.currentState.microphone&&"unknown"!==this.currentState.camera?"unknown"!==this.currentState.microphone&&"unknown"!==this.currentState.camera||this.logger.safe.warn(`Permissions API is not supported in this browser. Microphone: ${this.currentState.microphone}, camera: ${this.currentState.camera}`):(this.logger.safe.info("Initializing"),await this.registerPermissionTracker("microphone"),await this.registerPermissionTracker("camera"))}getPermissionState(e){return this.currentState[e]||"unknown"}isPermissionKnown(e){const t=this.getPermissionState(e);return"unknown"!==t&&"prompt"!==t}get browserPermittedModalities(){return this.permittedModalities}get knownPermissionStates(){return ut(this.currentState)}update(e,t){const i=ut(t);e.audio||delete i.audio,e.video||delete i.video;const n=ut(this.permittedModalities);it(i,((e,t)=>{this.permittedModalities[t]=e?BA:$A})),mt(n,this.permittedModalities)||this.event("onDevicesPermissionChanged").raise()}async askDevicePermission(e){const t=e?ut(e):{audio:!0,video:this.deviceManager.hasCamera()};if(this.accessIssuePermissionOther={audio:!1,video:!1},this.configProvider.config.permissions.rememberNegative&&(t.audio=t.audio&&this.permittedModalities.audio===BA,t.video=t.video&&this.permittedModalities.video===BA),t.sharing)throw new Error("askDevicePermission does not support sharing constraints.");const i={audio:!1,video:!1};this.lastGum={audio:!1,video:!1};const n=async(i,n,r)=>{const s={audio:!!i.audio,video:!!i.video,sharing:!0};return!(this.configProvider.config.permissions.adpRequestAVLast&&t.audio&&t.video)||this.lastGum.audio&&this.lastGum.video||(this.logger.safe.info("Prompting for audio and video to ensure omnibar state"),await this.askDevicePermissionPrompt({audio:!0,video:!0},!1)),this.update(t,s),this.deviceManager.raiseTelemetryEvent("ask_device_permission",{constraints:e,resultConstraints:i,error:r,reason:n}),s};await this.initialize();const r=this.getPermissionState("microphone"),s=this.getPermissionState("camera");if(this.logger.safe.info(`Permission state { audio: ${r}, video: ${s} }`),this.configProvider.config.permissions.useNegativeInAdp&&(!t.audio||"denied"===r)&&(!t.video||"denied"===s))return n(i,"navigator_permissions_denied");if(this.configProvider.config.permissions.usePositiveInAdp&&(!t.audio||t.audio&&"granted"===r)&&(!t.video||t.video&&"granted"===s))return n(t,"navigator_permissions_granted");try{return n(this.getConstrainsWithPermissionError(await this.askDevicePermissionPrompt(t,this.configProvider.config.permissions.adpFallback)),"stream_acquisition")}catch(e){return n(i,"stream_acquisition",e)}}async askDevicePermissionPrompt(e,t=!0){const i={audio:!1,video:!1};try{const t=this.deviceManager.getMediaStream(e);return t&&(this.lastGum=ut(e),await t.start(),i.audio=t.hasAudio(),i.video=t.hasVideo(),this.disposeLater(t)),i}catch(n){if(e.audio&&e.video&&t){try{i.video=this.configProvider.config.permissions.adpFallbackVideo&&(await this.askDevicePermissionPrompt({video:!0})).video}catch(e){e.type!==tt.MEDIA_ERROR.permissionDeniedError&&(this.accessIssuePermissionOther.video=!0)}try{i.audio=this.configProvider.config.permissions.adpFallbackAudio&&(await this.askDevicePermissionPrompt({audio:!0})).audio}catch(e){e.type!==tt.MEDIA_ERROR.permissionDeniedError&&(this.accessIssuePermissionOther.audio=!0)}}else if(t)throw n;return i}}getConstrainsWithPermissionError(e){return this.configProvider.config.permissions.disableOnPermissionDeniedOnly?{audio:this.accessIssuePermissionOther.audio||e.audio,video:this.accessIssuePermissionOther.video||e.video}:e}disposeLater(e){setTimeout((()=>{e.dispose()}),this.configProvider.config.mediaStreamHoldInterval)}async registerPermissionTracker(e){if(!this.registeredTrackers.has(e))try{const t=await this.window.navigator.permissions.query({name:e});this.handlePermissionStateChanged(e,t.state),t.onchange=()=>this.handlePermissionStateChanged(e,t.state),this.registeredTrackers.add(e)}catch(t){this.logger.safe.error(`Error querying permissions for ${e}: ${Ge(t)}`)}}handlePermissionStateChanged(e,t){this.logger.safe.info(`Permission state for ${e} changed ${this.currentState[e]} -> ${t}`),this.currentState[e]=t,this.deviceManager.raiseTelemetryEvent("permissions_state_changed",this.knownPermissionStates),this.deviceManager.handlePermissionStateChange()}},GA=class extends Ye{constructor(e,t=gt()){super(),this.dms=e,this.label=t,this.id=gt(),this.receivedEvents=new Map,this.subscribeToDeviceManagers(e)}getDeviceManagers(){return this.dms}dispose(){super.dispose(),this.dms?.forEach((e=>e.dispose())),this.dms=null}subscribeToDeviceManagers(e){e.forEach(((e,t)=>{e.on("onVideoEffectsEvent",((...t)=>this.eventHandler("onVideoEffectsEvent",e,(()=>this.event("onVideoEffectsEvent").raise(...t))))),e.on("onVideoEffectApplied",((...t)=>this.eventHandler("onVideoEffectApplied",e,(()=>this.event("onVideoEffectApplied").raise(...t))))),e.on("onDeviceTelemetryEvent",(e=>this.event("onDeviceTelemetryEvent").raise({deviceId:`${this.id}/${t}`,...e}))),e.on("onVideoEffectsTelemetryEvent",(e=>this.event("onVideoEffectsTelemetryEvent").raise({deviceId:`${this.id}/${t}`,...e}))),e.on("onDevicesPermissionChanged",(()=>this.event("onDevicesPermissionChanged").raise(`${this.id}/${t}`))),e.on("onStreamUpdateRequested",((...e)=>this.event("onStreamUpdateRequested").raise(...e)))}))}eventHandler(e,t,i){let n=this.receivedEvents.get(e);if(n??(n=new Set),n.add(t),this.dms.every((e=>n.has(e))))return i(),void n.clear();this.receivedEvents.set(e,n)}},WA=()=>(e,t,i)=>{const n=i.value;return i.value=function(...e){return this.serialQueue.add(n.bind(this,...e))},i},qA=class{constructor(e){this.size=e,this.items=[]}clear(){this.items=[]}},zA=class extends qA{get isFull(){return this.items.length>=this.size}add(e){return this.isFull&&this.items.shift(),this.items.push(e),!0}},KA=class extends qA{add(e){return!(this.items.length>=this.size||(this.items.push(e),0))}},JA=class{constructor(e){this.error=new KA(e)}startLoadTimer(){this.loadStartTimestamp=Date.now()}stopLoadTimer(){this.loadDuration=Date.now()-this.loadStartTimestamp}clearErrors(){this.error.clear()}setError(e,t){this.error.add({type:e,message:t})}getReport(){return{loadDuration:this.loadDuration,error:this.error.items}}},YA=class{constructor(e,t,i){this.configProvider=e,this.statistics=t,this.logger=i}isWasmEffectSupported(){return this.configProvider.config.webcv.useWasmEffects?!!window.MediaStreamTrackProcessor||(this.logger.info("wasmEffects disabled, insertable streams are not supported"),!1):(this.logger.info("wasmEffects disabled by feature flag"),!1)}isWebgl2EffectSupported(){return this.isCurrentRendererSupported()&&this.isWebGL2Supported()}isCurrentRendererSupported(){const e=this.configProvider.config.webcv.webGLUnsupportedRenderers;let t=!1;const i=Cg.unmaskedGlRenderer;return i&&!e.some((e=>e===i))?t=!0:(this.statistics.setError("RendererIsNotSupported",`Blacklisted from ${JSON.stringify(e)}`),this.logger.info(`Unsupported renderer: ${Ge(i)}`)),t}isWebGL2Supported(){try{const e=document.createElement("canvas").getContext("webgl2");if(!e)return this.statistics.setError("WebGL2IsNotSupported"),this.logger.info("WebGL2 context is not supported"),!1;const t=e.getSupportedExtensions(),i=this.configProvider.config.webcv.webGLRequiredExtensions.filter((e=>!t.includes(e)));if(i.length>0)return this.statistics.setError("WebGL2RequiredExtensionsNotSupported","Required WebGL2 extensions not supported."),this.logger.info(`Unsupported WebGL2 extensions: ${Ge(i)}`),!1}catch(e){return this.statistics.setError("WebGL2IsNotSupported",`Error: ${Ge(e)}`),this.logger.error(`isWebGL2Supported: ${Ge(e)}`),!1}return!0}},QA=class extends Qe{constructor(e,t,i,n){super(i),this.webcvProvider=e,this.configProvider=t,this.logger=i,this.createWasmCVWorker=n,this.serialQueue=new _I(this.logger),this.videoEffectToWebCVEffectMapping={0:Yh.VideoEffectType.Off,1:Yh.VideoEffectType.BackgroundBlur,16:Yh.VideoEffectType.BackgroundReplacement},this.effectType=0,this.isPortrait=!1,this.effectProviderSubs=[],this.statistics=new JA(this.configProvider.config.effectsTelemetryBufferSize),this.processorType=Yh.ProcessorType.Webgl2,this.lastNotifiedResolutions=new Map}get isEffectEnabled(){return 0!==this.effectType}async init(){if(!this.effectProvider){this.logger.safe.debug("Init");try{this.effectProvider=await this.initializeVideoEffectProvider()}catch(e){throw this.notifyError("FailedToInitialize",`Initialization failed, error:${Ge(e)}`),e}}}async dispose(){this.logger.safe.debug("Dispose"),this.effectProvider&&(this.effectProviderSubs.forEach((e=>e.dispose())),this.effectProviderSubs=null,await this.effectProvider.disposeAsync()),this.lastNotifiedResolutions.clear(),super.dispose()}async configure(e){if(this.logger.safe.debug(`Set config: ${JSON.stringify(e)}`),this.effectConfig={backgroundImageUrl:e.imagePath,headers:e.headers},this.effectProvider)return this.effectProvider.configureEffect(this.effectConfig);this.logger.safe.debug("WebCV is not initialized. Do nothing")}async setEffectAsync(e){if(!this.shouldApplyEffect(e))return void this.logger.safe.debug(`Effect ${this.effectType} is already set`);this.effectProvider||(this.logger.safe.debug("Initializing effect provider"),await this.init()),this.logger.safe.debug(`Set effect: ${e}`);const t=this.getWebCVEffect(e);if(!t)throw new Error(`Effect with type ${e} is not supported`);if(this.shouldCollectStats(e)&&this.notifyAboutLastSessionStats("EffectChanged"),this.effectType=e,this.effectProvider)try{await this.effectProvider.setEffectAsync(t)}catch(e){throw await this.handleFailedProcessing(),this.notifyError("FailedToInitialize",`Failed to apply ${t}, error:${Ge(e)}`),e}else this.logger.safe.debug("WebCV is not initialized. Do nothing")}async setSourceAsync(e){if(this.logger.safe.debug(`Set source: ${e?e.id:"no stream"}`),!this.effectProvider)return this.logger.safe.debug("WebCV is not initialized. Do nothing"),e;if(e.getTracks().length>0){const t=e.getVideoTracks()[0].getSettings();this.isPortrait=t.height>t.width}let t=e;try{t=await this.effectProvider.setSourceAsync(e)}catch(e){await this.handleFailedProcessing(),this.notifyError("FailedToInitialize",`Failed to set source, error:${Ge(e)}`)}return t}async removeSourceAsync(e){if(this.logger.safe.debug(`Remove source: ${e?e.id:"no stream"}`),this.effectProvider)return this.effectProvider.removeSourceAsync(e);this.logger.safe.debug("WebCV is not initialized. Do nothing")}async getEffectsCapability(){let e=0;const t=await this.getCapability();this.logger.safe.debug(`Get capabilty with return: ${JSON.stringify(t)}`);for(const i of t){const t=this.getVideoEffectType(i);if(!t)throw new Error(`Cannot convert WebCV effect to VideoEffect ${i}`);e|=t}return e}getStats(e){if(!this.effectProvider)return;const t=this.effectProvider.getStats(),i=this.statistics.getReport();return t||i.error.length?{timestamp:Date.now(),statsReason:e,...this.createTelemetryEvent(t,i)}:void 0}getVersion(){return this.effectProvider?.getVersion?.()??"Unknown"}async resetOutputConstraints(e,t=Yh.EffectQualityChangeReason.ExternalParam){const i=this.getNewResolution(e,t),n={...this.configProvider.config.webcv.qualityConfig};return this.isPortrait?n.outputResolution=i.width:n.outputResolution=i.height,this.effectProvider?.configureStreamProcessor(n,Yh.EffectQualityChangeReason.ExternalParam)}getNewResolution(e,t){let i;switch(t){case Yh.EffectQualityChangeReason.ExternalParam:i=this.lastNotifiedResolutions.get(Yh.EffectQualityChangeReason.RendererSize),this.lastNotifiedResolutions.set(Yh.EffectQualityChangeReason.ExternalParam,e);break;case Yh.EffectQualityChangeReason.RendererSize:i=this.lastNotifiedResolutions.get(Yh.EffectQualityChangeReason.ExternalParam),this.lastNotifiedResolutions.set(Yh.EffectQualityChangeReason.RendererSize,e)}return{width:Math.max(e.width,i?.width||Number.MIN_SAFE_INTEGER),height:Math.max(e.height,i?.height||Number.MIN_SAFE_INTEGER)}}createTelemetryEvent(e,t){return{payload:{version:this.getVersion(),...t,...e,isWasmEnabled:this.processorType===Yh.ProcessorType.Wasm}}}notifyError(e,t){this.statistics.setError(e,t),this.notifyAboutLastSessionStats("EffectError")}notifyAboutLastSessionStats(e){const t=this.getStats(e);t&&this.event("onVideoEffectTelementyEvent").raise(t)}async initializeVideoEffectProvider(){if(!this.webcvProvider)return this.logger.safe.debug("WebCV provider is not set"),null;this.statistics.startLoadTimer();const e=await this.webcvProvider.getVideoEffectProvider();if(this.statistics.stopLoadTimer(),!e)return this.statistics.setError("FailedToInitialize"),this.logger.safe.warn("WebCV is not initialized"),null;this.logger.safe.debug(`WebCV v${e.getVersion?.()} is initialized`);const t=await this.webcvProvider.getModelConfig();return await e.configureModel(t),this.configProvider.config.webcv.loadWorkerCallback=this.createWasmCVWorker,await e.configure({...this.configProvider.config.webcv,processorType:this.processorType}),this.effectConfig&&await e.configureEffect(this.effectConfig),this.effectProviderSubs=[e.on("onEffectApplied",(()=>this.event("onMediaStreamUpdateRequested").raise("Video"))),e.on("onEffectStopped",(()=>this.notifyAboutLastSessionStats("EffectStopped"))),e.on("onVideoEffectQualityChanged",(e=>this.event("onVideoEffectQualityChanged").raise(e))),e.on("onVideoStreamQualityChanged",(e=>this.event("onVideoStreamQualityChanged").raise(e.resolution,e.fps,e.reason))),e.on("onCapabilitiesChanged",(()=>this.event("onVideoEffectCapabilitiesChanged").raise())),e.on("onFirstFrameProcessed",(()=>this.onFirstFrameProcessed())),e.on("onErrorNotified",(e=>this.notifyError("WebcvProccessorError",e))),e.on("videoFreezeDetected",(e=>this.event("videoFreezeDetected").raise(e)))],e}async getCapability(){if(!this.configProvider.config.enableVideoEffects)return this.logger.debug("Video effects disabled"),[Yh.VideoEffectType.Off];if(!this.webcvProvider)return this.logger.debug("WebCVProvider is not configured"),[Yh.VideoEffectType.Off];const e=new YA(this.configProvider,this.statistics,this.logger.createChild("CapabilityChecker"));let t=[Yh.VideoEffectType.Off];return e.isWasmEffectSupported()?(t=[Yh.VideoEffectType.Off,Yh.VideoEffectType.BackgroundBlur,Yh.VideoEffectType.BackgroundReplacement],this.processorType=Yh.ProcessorType.Wasm):e.isWebgl2EffectSupported()&&(t=[Yh.VideoEffectType.Off,Yh.VideoEffectType.BackgroundBlur,Yh.VideoEffectType.BackgroundReplacement],this.processorType=Yh.ProcessorType.Webgl2),this.effectProvider?this.effectProvider.getCapability():t}getWebCVEffect(e){return this.videoEffectToWebCVEffectMapping[e]}getVideoEffectType(e){return ct(this.videoEffectToWebCVEffectMapping).find((t=>this.videoEffectToWebCVEffectMapping[t]===e))}onFirstFrameProcessed(){this.event("onVideoEffectApplied").raise(),this.logger.safe.debug("onVideoEffectApplied event raised")}async handleFailedProcessing(){this.effectType=0;try{await this.effectProvider.setEffectAsync(Yh.VideoEffectType.Off)}catch(e){this.notifyError("WebcvProccessorError",`Failed to handle error state, error:${Ge(e)}`)}}shouldApplyEffect(e){return this.effectType!==e}shouldCollectStats(e){return 0!==this.effectType&&0!==e&&this.effectType!==e}};E([WA()],QA.prototype,"init",1),E([WA()],QA.prototype,"dispose",1),E([WA()],QA.prototype,"configure",1),E([WA()],QA.prototype,"setSourceAsync",1),E([WA()],QA.prototype,"removeSourceAsync",1),E([WA()],QA.prototype,"getEffectsCapability",1);var XA=class extends Qe{constructor(e,t,i,n,r,s){super(r),this.wasmdnsProvider=e,this.wasmaecProvider=t,this.wasmVqeProvider=i,this.configProvider=n,this.logger=r,this.createWasmAudioWorkletCbs=s,this.serialQueue=new _I(this.logger),this.stopped=!0,this.hasError=!1,this.statistics=new JA(this.configProvider.config.effectsTelemetryBufferSize),this.currentEffect=Qh.AudioEffectType.Off,this.userNoiseSuppressionMode=0,this.currentEffectCapability=0,this.wasmvqeSourceStreamIsSet=!1,this.nsModeToUserNsMode={Off:0,Auto:1,Low:2,High:3},this.audioEffectToWasmAudioEffectType={0:Qh.AudioEffectType.Off,1:Qh.AudioEffectType.NoiseSuppressionClassic,2:Qh.AudioEffectType.NoiseSuppressionDeep,4:Qh.AudioEffectType.EchoCancellationClassic,8:Qh.AudioEffectType.VoiceQualityEnhancementClassic,16:Qh.AudioEffectType.VoiceQualityEnhancementDeep},this.audioEffectTypeToUserNsMode={[Qh.AudioEffectType.Off]:0,[Qh.AudioEffectType.NoiseSuppressionClassic]:2,[Qh.AudioEffectType.NoiseSuppressionDeep]:3},this.noiseSuppressionModeToWasmDnsEffectMapping={Off:Qh.AudioEffectType.Off,High:Qh.AudioEffectType.NoiseSuppressionDeep,Low:Qh.AudioEffectType.NoiseSuppressionClassic},this.userNoiseSuppressionMode=this.nsModeToUserNsMode[this.configProvider.mediaConfig.noiseSuppressionMode]}shouldFallbackToNativeProcessing(){return!(!this.configProvider.config.enableAudioProcessingFallback||(this.configProvider.config.wasmvqe.enableVqe||this.configProvider.config.wasmdns.enableNoiseSuppression?this.hasError?(this.logger.safe.info("shouldFallbackToNativeProcessing: error was encountred initializing the package"),0):this.configProvider.config.wasmvqe.enableVqe&&!this.wasmVqeProvider?(this.logger.safe.info("shouldFallbackToNativeProcessing: VQE provider is enabled but not loaded"),0):!this.configProvider.config.wasmdns.enableNoiseSuppression||this.wasmdnsProvider&&this.wasmaecProvider||(this.logger.safe.info("shouldFallbackToNativeProcessing: DNS/AEC provider is enabled but not loaded"),0):(this.logger.safe.info("shouldFallbackToNativeProcessing: custom processing is not enabled"),0)))}nsModeToVqeMode(e,t){switch(e){case"High":return t?Qh.VqeMode.DeepVQE:Qh.VqeMode.DeepNS;case"Low":return t?Qh.VqeMode.SkypeVQE:Qh.VqeMode.SkypeNS;default:return t?Qh.VqeMode.SkypeAEC:Qh.VqeMode.Off}}vqeModeToNsMode(e){switch(e){case Qh.VqeMode.DeepVQE:case Qh.VqeMode.DeepNS:return"High";case Qh.VqeMode.SkypeVQE:case Qh.VqeMode.SkypeNS:return"Low";case Qh.VqeMode.SkypeAEC:case Qh.VqeMode.Off:default:return"Off"}}vqeModeToAudioEffectType(e){switch(e){case Qh.VqeMode.DeepVQE:return 16;case Qh.VqeMode.DeepNS:return 2;case Qh.VqeMode.SkypeVQE:return 8;case Qh.VqeMode.SkypeNS:return 1;case Qh.VqeMode.SkypeAEC:return 4;case Qh.VqeMode.Off:default:return 0}}async configureEffect(e){this.stopped||this.stop(),this.statistics.clearErrors();let t=e;if(!t){let e=this.configProvider.mediaConfig.noiseSuppressionMode;this.logger.safe.info(`Configuring the audio effect manager for Noise Suppression mode: ${e}`),"Auto"===e&&(e=this.configProvider.config.wasmvqe.enableVqe?this.vqeModeToNsMode(this.configProvider.config.wasmvqe.defaultVqeMode):this.configProvider.config.wasmdns.noiseSuppressionMode,this.logger.safe.info(`Overriding 'Auto' with ${e}`)),t={...this.configProvider.config.wasmdns,...this.configProvider.config.wasmvqe},t.noiseSuppressionMode=e}if(await this.getEffectsCapability(),this.configProvider.config.wasmvqe.enableVqe)try{this.vqeProvider||(this.logger.safe.debug("Initializing VQE provider ..."),this.vqeProvider=await this.initializeAudioEffectProvider(Qh.AudioEffectType.VoiceQualityEnhancementDeep)),this.logger.safe.debug("Configuring VQE audio effects ..."),t.loadAudioWorkletCallback=this.createWasmAudioWorkletCbs?.getWasmVqeWorklet,await this.vqeProvider.configureEffect(t),this.logger.safe.debug(`The audio effects were configured as follows: ${Ge(t)}, and current capability is ${this.currentEffectCapability}.`)}catch(e){this.notifyError("FailedToInitialize",`Audio effect provider configuration failed (${e}), while trying to use this configuration: ${Ge(t)},\n                    under the following capability: ${this.currentEffectCapability}.`),this.requestStreamUpdate()}else if(this.configProvider.config.wasmdns.enableNoiseSuppression){t.noiseSuppressionMode||(this.logger.safe.debug("configureEffect was called without a noiseSuppressionMode. Using noiseSuppressionMode from config provider ..."),t.noiseSuppressionMode=this.configProvider.mediaConfig.noiseSuppressionMode),this.currentEffect=this.noiseSuppressionModeToWasmDnsEffectMapping[t.noiseSuppressionMode],this.logger.safe.debug(`currentEffect is ${this.currentEffect}`);try{this.dnsProvider||(this.logger.safe.debug("Initializing DNS provider ..."),this.dnsProvider=await this.initializeAudioEffectProvider(Qh.AudioEffectType.NoiseSuppressionDeep)),this.aecProvider||(this.logger.safe.debug("Initializing AEC provider ..."),this.aecProvider=await this.initializeAudioEffectProvider(Qh.AudioEffectType.EchoCancellationClassic)),this.logger.safe.debug("Configuring DNS/AEC audio effects ..."),t.loadAudioWorkletCallback=this.createWasmAudioWorkletCbs?.getWasmDnsWorklet,await this.dnsProvider.configureEffect(t),t.loadAudioWorkletCallback=this.createWasmAudioWorkletCbs?.getWasmAecWorklet,await this.aecProvider.configureEffect(t),this.logger.safe.debug(`The audio effects were configured as follows: ${Ge(t)}, and current capability is ${this.currentEffectCapability}.`)}catch(e){this.notifyError("FailedToInitialize",`Audio effect provider configuration failed (${e}), while trying to use this configuration: ${Ge(t)},\n                    under the following capability: ${this.currentEffectCapability}.`),this.requestStreamUpdate()}this.stopped=!1}}async setSourceAsync(e){if(this.logger.safe.debug(`Set source: ${e?e.id:"no stream"}, currentEffect = ${this.currentEffect}`),this.configProvider.config.wasmvqe.enableVqe&&!this.vqeProvider?await this.configureEffect():!this.configProvider.config.wasmdns.enableNoiseSuppression||this.dnsProvider&&this.aecProvider||await this.configureEffect(),!(this.vqeProvider||this.dnsProvider&&this.aecProvider)){const t=this.vqeProvider?this.dnsProvider?"AEC":"DNS":"VQE";return this.statistics.setError("FailedToInitialize",`setSourceAsync: audio effect provider not initialized (${t}).`),this.logger.safe.warn(`Unable to configure audio effects: audio effect provider not initialized (${t}).`),e}if(!this.configProvider.config.wasmvqe.enableVqe&&!this.configProvider.config.wasmdns.enableNoiseSuppression)return e;if(this.effectProviderSubs=[this.vqeProvider?.on("onEffectStopped",(()=>this.notifyAboutLastSessionStats())),this.vqeProvider?.on("onMetricsUpdated",(()=>this.notifyAboutLastSessionStats())),this.vqeProvider?.on("onErrorNotified",(e=>this.notifyError("WasmVqeProccessorError",e))),this.dnsProvider?.on("onEffectStopped",(()=>this.notifyAboutLastSessionStats())),this.dnsProvider?.on("onMetricsUpdated",(()=>this.notifyAboutLastSessionStats())),this.dnsProvider?.on("onErrorNotified",(e=>this.notifyError("WasmDnsProccessorError",e))),this.aecProvider?.on("onErrorNotified",(e=>this.notifyError("WasmAecProccessorError",e)))],this.configProvider.config.wasmvqe.enableVqe)try{const t=await this.vqeProvider.setSourceAsync(e);return this.aecRefStream&&this.vqeProvider.setRefStream(this.aecRefStream),this.wasmvqeSourceStreamIsSet=!0,t}catch(t){return this.notifyError("WasmVqeProccessorError",`setSourceAsync: Failed to asynchronously set source for VQE (${t})`),e}let t=e;try{t=await this.aecProvider.setSourceAsync(e),this.aecRefStream&&this.aecProvider.setRefStream?.(this.aecRefStream)}catch(e){this.notifyError("WasmAecProccessorError",`setSourceAsync: Failed to asynchronously set source for AEC (${e})`)}try{return await this.dnsProvider.setSourceAsync(t)}catch(e){this.notifyError("WasmDnsProccessorError",`setSourceAsync: Failed to asynchronously set source for DNS (${e})`)}return t}async setAecRefStream(e){try{if(this.logger.safe.debug(`Setting the reference stream to: ${e?e.id:"Null"}`),!(this.vqeProvider||this.dnsProvider&&this.aecProvider)){const e=this.vqeProvider?this.dnsProvider?"AEC":"DNS":"VQE";return this.statistics.setError("FailedToInitialize",`setAecRefStream: audio effect provider not initialized (${e}).`),void this.logger.safe.warn(`Unable to setAecRefStream for audio effects: audio effect provider not initialized (${e}).`)}this.configProvider.config.wasmvqe.enableVqe?this.vqeProvider.setRefStream(e):this.configProvider.config.wasmdns.enableNoiseSuppression&&this.aecProvider.setRefStream(e)}catch(e){this.notifyError("WasmVqeProccessorError",`setRefStream: Failed to set reference stream for echo cancellation (${e})`)}this.aecRefStream=e}async setEffectAsync(e){this.configProvider.config.wasmvqe.enableVqe&&!this.wasmvqeSourceStreamIsSet&&(this.logger.safe.info("wasmvqe source stream is not set, reacquiring audio stream"),this.event("onMediaStreamUpdateRequested").raise("Audio")),this.configProvider.config.wasmvqe.enableVqe&&!this.vqeProvider?await this.configureEffect():!this.configProvider.config.wasmdns.enableNoiseSuppression||this.dnsProvider&&this.aecProvider||await this.configureEffect();const t=this.audioEffectToWasmAudioEffectType[e];if(this.userNoiseSuppressionMode=this.audioEffectTypeToUserNsMode[t],!(this.vqeProvider||this.dnsProvider&&this.aecProvider)){const e=this.vqeProvider?this.dnsProvider?"AEC":"DNS":"VQE";return this.statistics.setError("FailedToInitialize",`setSourceAsync: audio effect provider not initialized (${e}).`),void this.logger.safe.warn(`Unable to configure audio effects: audio effect provider not initialized (${e}).`)}try{this.configProvider.config.wasmvqe.enableVqe?await this.vqeProvider.setEffectAsync(t):this.configProvider.config.wasmdns.enableNoiseSuppression&&(await this.dnsProvider.setEffectAsync(t),await this.aecProvider.setEffectAsync(t)),this.currentEffect=t,this.logger.safe.debug(`The audio effect was set to '${t}'`)}catch(e){throw this.notifyError("WasmVqeProccessorError",`setEffectAsync: Failed to apply '${t}' audio effect, error: ${Ge(e)}`),e}}stop(){try{this.stopped=!0,this.dnsProvider?.dispose(),this.dnsProvider=null,this.aecProvider?.dispose(),this.aecProvider=null,this.vqeProvider?.dispose(),this.vqeProvider=null,this.effectProviderSubs?.forEach((e=>e?.dispose())),this.effectProviderSubs=null,this.logger.safe.debug("The audio effects provider was stopped.")}catch(e){this.logger.safe.error(`Failed to stop the audio effects provider (${e})`)}}dispose(){try{this.hasError=!1,this.stop(),super.dispose(),this.logger.safe.debug("The audio effects provider was disposed.")}catch(e){this.logger.safe.error(`dispose: Failed to dispose the audio effects provider (${e})`)}}async getEffectsCapability(){return this.currentEffectCapability=0,this.configProvider.config.wasmvqe.enableVqe?(this.currentEffectCapability|=1,this.currentEffectCapability|=2,this.configProvider.config.wasmvqe.enableAec&&(this.currentEffectCapability|=4,this.currentEffectCapability|=8,this.currentEffectCapability|=16)):this.configProvider.config.wasmdns.enableNoiseSuppression&&(this.currentEffectCapability|=1,this.currentEffectCapability|=2,this.currentEffectCapability|=4),this.currentEffectCapability}getVersion(){return`WasmDns ${this.dnsProvider?.getVersion()??"Unknown"} / WasmAec ${this.aecProvider?.getVersion()??"Unknown"} / WasmVqe ${this.vqeProvider?.getVersion()??"Unknown"}`}getStats(){const e=this.configProvider.config.wasmvqe.enableVqe?this.vqeProvider?.getStats():this.dnsProvider?.getStats();return e?(e.userNoiseSuppressionMethod=this.userNoiseSuppressionMode,{timestamp:Date.now(),...this.createTelemetryEvent(e)}):null}async initializeAudioEffectProvider(e){if(!this.wasmVqeProvider&&e===Qh.AudioEffectType.VoiceQualityEnhancementDeep)return this.statistics.setError("FailedToInitialize","initializeAudioEffectProvider: WasmVqe package not available."),this.logger.safe.warn("WasmVqe package not available."),null;if(!this.wasmdnsProvider&&e===Qh.AudioEffectType.NoiseSuppressionDeep)return this.statistics.setError("FailedToInitialize","initializeAudioEffectProvider: WasmDns package not available."),this.logger.safe.warn("WasmDns package not available."),null;if(!this.wasmaecProvider&&e===Qh.AudioEffectType.EchoCancellationClassic)return this.statistics.setError("FailedToInitialize","initializeAudioEffectProvider: WasmAec package not available."),this.logger.safe.warn("WasmAec package not available."),null;let t;this.statistics.startLoadTimer();try{this.configProvider.config.wasmvqe.enableVqe&&e===Qh.AudioEffectType.VoiceQualityEnhancementDeep&&(t=await this.wasmVqeProvider.getAudioEffectProvider()),this.configProvider.config.wasmdns.enableNoiseSuppression&&e===Qh.AudioEffectType.NoiseSuppressionDeep&&(t=await this.wasmdnsProvider.getAudioEffectProvider()),this.configProvider.config.wasmdns.enableNoiseSuppression&&e===Qh.AudioEffectType.EchoCancellationClassic&&(t=await this.wasmaecProvider.getAudioEffectProvider())}catch(e){this.logger.safe.warn(`initializeAudioEffectProvider: Failed to initialize the audio effect provider (${e})`),this.statistics.setError("FailedToInitialize",`initializeAudioEffectProvider: Failed to initialize the audio effect provider (${e})`)}return this.statistics.stopLoadTimer(),t?(e===Qh.AudioEffectType.VoiceQualityEnhancementDeep&&this.logger.safe.debug(`WasmVqe v${t.getVersion?.()} initialized!`),e===Qh.AudioEffectType.NoiseSuppressionDeep&&this.logger.safe.debug(`WasmDns v${t.getVersion?.()} initialized!`),e===Qh.AudioEffectType.EchoCancellationClassic&&this.logger.safe.debug(`WasmAec v${t.getVersion?.()} initialized!`),t):(this.logger.safe.warn("Unitialized Wasm audio effect provider."),null)}createTelemetryEvent(e){return{payload:{audioEffectsCapability:this.currentEffectCapability,version:this.getVersion(),...this.statistics.getReport(),...e}}}notifyError(e,t){this.statistics.setError(e,t),this.notifyAboutLastSessionStats()}notifyAboutLastSessionStats(){const e=this.getStats();e&&this.event("onAudioEffectTelemetryEvent").raise(e)}requestStreamUpdate(){this.configProvider.config.enableAudioProcessingFallback&&!this.hasError&&(this.hasError=!0,this.event("onMediaStreamUpdateRequested").raise("Audio"))}};E([WA()],XA.prototype,"setSourceAsync",1),E([WA()],XA.prototype,"setAecRefStream",1),E([WA()],XA.prototype,"setEffectAsync",1),E([WA()],XA.prototype,"stop",1),E([WA()],XA.prototype,"dispose",1);var ZA=class extends Qe{constructor(e,t){super(),this.configProvider=e,this.logger=t}isEffectEnabled(e){return"Video"===e&&this.videoEffectManager?.isEffectEnabled}shouldFallbackToNativeProcessing(e){return"Audio"===e&&this.audioEffectManager?.shouldFallbackToNativeProcessing()}addEffectManager(e,t){switch(e){case"Audio":this.addAudioEffectManagerAndSubscribe(t);break;case"Video":this.addVideoEffectManagerAndSubscribe(t)}}async startEffect(e,t){switch(e){case"Audio":return this.logger.safe.info("audioEffectManager is "+(this.audioEffectManager?"defined":"undefined")),this.audioEffectManager?.shouldFallbackToNativeProcessing()?(this.logger.safe.info("No custom audio effect is used. Fallback to native audio processing"),t):this.audioEffectManager.setSourceAsync(t);case"Video":return this.videoEffectManager.setSourceAsync(t);default:return t}}async setEffectType(e,t){switch(e){case"Audio":return this.audioEffectManager?.setEffectAsync(t);case"Video":return this.videoEffectManager?.setEffectAsync(t)}}stopEffect(e,t){switch(e){case"Audio":this.logger.safe.info("stopping audio effect"),this.audioEffectManager?.stop();break;case"Video":this.logger.safe.info("stopping video effect"),this.videoEffectManager?.removeSourceAsync(t)}}resetOutputConstraints(e,t,i){"Video"===e&&this.videoEffectManager?.resetOutputConstraints(t,i)}getStats(e,t){switch(e){case"Audio":return this.audioEffectManager?.getStats();case"Video":return this.videoEffectManager?.getStats(t);default:return}}async configure(e,t){if("Video"===e)return this.videoEffectManager?.configure(t)}async getEffectsCapability(e){switch(e){case"Audio":return this.audioEffectManager?.getEffectsCapability();case"Video":return this.videoEffectManager?.getEffectsCapability();default:return 0}}setAecRefStream(e){return this.audioEffectManager.setAecRefStream(e)}vqeModeToAudioEffectType(e){return this.audioEffectManager.vqeModeToAudioEffectType(e)}nsModeToVqeMode(e,t){return this.audioEffectManager.nsModeToVqeMode(e,t)}dispose(){super.dispose(),this.audioEffectManager?.dispose(),this.audioEffectManager=null,this.videoEffectManager?.dispose(),this.videoEffectManager=null}addAudioEffectManagerAndSubscribe(e){this.audioEffectManager||(this.audioEffectManager=new XA(e.wasmdnsProvider,e.wasmaecProvider,e.wasmVqeProvider,this.configProvider,this.logger.createChild("AudioEffectManager"),e.createAudioWasmWorkerCbs),this.audioEffectManager.on("onAudioEffectTelemetryEvent",(e=>{this.event("onAudioEffectTelemetryEvent").raise(e)})),this.audioEffectManager.on("onMediaStreamUpdateRequested",(e=>{this.event("onMediaStreamUpdateRequested").raise(e)})))}addVideoEffectManagerAndSubscribe(e){this.videoEffectManager||(this.videoEffectManager=new QA(e.webcvProvider,this.configProvider,this.logger.createChild("VideoEffectManager"),e.createWasmCVWorker),this.videoEffectManager.on("onMediaStreamUpdateRequested",(e=>{this.event("onMediaStreamUpdateRequested").raise(e)})),this.videoEffectManager.on("onVideoEffectQualityChanged",(e=>{this.event("onVideoEffectQualityChanged").raise(e)})),this.videoEffectManager.on("onVideoStreamQualityChanged",((e,t,i)=>{this.event("onVideoStreamQualityChanged").raise(e,t,i)})),this.videoEffectManager.on("onVideoEffectCapabilitiesChanged",(()=>{this.event("onVideoEffectCapabilitiesChanged").raise()})),this.videoEffectManager.on("onVideoEffectTelementyEvent",(e=>{this.event("onVideoEffectTelementyEvent").raise(e)})),this.videoEffectManager.on("onVideoEffectApplied",(()=>{this.event("onVideoEffectApplied").raise()})),this.videoEffectManager.on("videoFreezeDetected",(e=>{this.event("videoFreezeDetected").raise(e)})))}},eR=class e extends Qe{constructor(t,i,n,r,s,a,o,l,d,c){super(t),this.logger=t,this.configProvider=i,this.diagnostics=n,this.domOverrides=r,this.ufdManager=s,this.id=gt(),this.virtualDeviceRecord=new Map,this.deviceEnumerator=new UA(this.configProvider,this.logger.createChild("DeviceEnumerator")),this.deviceSelection=new VA(UA.list,this.configProvider,this.logger.createChild("DeviceSelection")),this.permissionManager=new jA(this.configProvider,{getMediaStream:e=>this.getMediaStream({...e,withEffect:!1,withTimeout:!0,force:!1,audioProcessingFlags:e.audio&&!e.video?this.getAudioProcessingFlags():void 0},"permissionManager"),hasCamera:()=>this.hasDeviceType("camera"),raiseTelemetryEvent:(e,t)=>this.raiseTelemetryEvent(e,t),getActiveConstraints:()=>this.mediaStreamManager.getActiveConstraints(),handlePermissionStateChange:()=>this.handlePermissionStateChange()},this.logger.createChild("PermissionManager")),this.activeRenderers=[],this.selectedDevices={camera:null,microphone:null,speaker:null,audioIngestDevice:null},this.pendingDevices=null,this.deviceManagerSubscriptions=[],this.streamManagerSubscriptions=[],this.streamSubscriptions=new Map,this.rendererSubscriptions=new Map,this.rawDeviceStreamManager=new TI(this.logger.createChild("RawDeviceStream"),this.raiseTelemetryEvent.bind(this)),this.customDeviceMediaStreamMap=new Map,this.clientAudioRenderers=new Map,this.audioSharingRequested=!1,this.virtualDeviceSubs=new Map,this.effectsManagerInternal=new ZA(this.configProvider,this.logger.createChild("EffectsManager")),this.effectsManagerInternal.addEffectManager("Audio",{wasmdnsProvider:o,wasmaecProvider:l,wasmVqeProvider:d,createAudioWasmWorkerCbs:c?.audioWorklet}),this.effectsManagerInternal.addEffectManager("Video",{webcvProvider:a,createWasmCVWorker:c?.createWasmCVWorker}),this.mediaStreamManager=new TA(this.logger.createChild("MediaStreamManager"),this.configProvider,this.effectsManager),this.deviceManagerSubscriptions=[this.permissionManager.on("onDevicesPermissionChanged",(()=>this.event("onDevicesPermissionChanged").raise())),UA.list.on("onDevicesChanged",((e,t)=>this.onDevicesChanged(e,t))),this.deviceSelection.on("onSelectedDevicesChanged",((e,t)=>this.onSelectedDevicesChanged(e,t))),this.effectsManager.on("onAudioEffectTelemetryEvent",(e=>{this.diagnostics?.registerAudioEffectsEvent(ut(e)),this.event("onAudioEffectsTelemetryEvent").raise(e)})),this.effectsManager.on("onMediaStreamUpdateRequested",(e=>this.onMediaStreamUpdateRequested(e,!0))),this.effectsManager.on("onMediaStreamUpdateRequested",(e=>this.onMediaStreamUpdateRequested(e))),this.effectsManager.on("onVideoEffectQualityChanged",(e=>this.onVideoEffectsQualityEventHandler(e))),this.effectsManager.on("onVideoEffectTelementyEvent",(e=>{this.diagnostics?.registerVideoEffectsEvent(ut(e)),this.event("onVideoEffectsTelemetryEvent").raise(e)})),this.effectsManager.on("onVideoEffectApplied",(()=>{this.raiseTelemetryEvent("video_effect_applied",{}),this.event("onVideoEffectApplied").raise()}))],this.subscribeOnStreamManagerEvents(),this.subscribeOnDeviceEnumeratorEvents(),this.deviceList.length&&this.onSelectedDevicesChanged(this.deviceSelection.selectedDevices,!1),this.createChildDeviceManager=t=>new e(t,i,void 0,r,s,a,o,l,d,c)}get deviceList(){return UA.list.devices}get isDeviceEnumeratorInitialized(){return UA.isInitialized}get isAudioOutputSelectionSupported(){return this.configProvider.userAgentConfig.isAudioOutputSelectionSupported}get effectsManager(){return this.effectsManagerInternal}createPreviewRenderer(e){const t=new xI(e,this,this.logger.createChild("videorenderer"),this.configProvider);return this.domOverrides.onMediaElementAdded&&this.domOverrides.onMediaElementAdded(t.getVideoElement()),this.subscribeOnRendererEvents(t),t}async askDevicePermission(e){await this.isDeviceEnumeratorInitialized.promise;const t=await this.permissionManager.askDevicePermission(e);if(this.configProvider.config.devices.enumerateDevicesAfterADP)try{await UA.enumerateDevices()}catch(e){this.logger.safe.warn(`Post-ADP device enumeration failed: ${Ge(e)}`)}return t}getPermissionState(e){return this.permissionManager.getPermissionState(e)}handlePermissionStateChange(){this.diagnostics&&(this.diagnostics.permissionStates=this.permissionManager.knownPermissionStates),this.event("onPermissionStateChanged").raise()}onMediaStreamUpdateRequested(e,t=!1){if("Video"===e&&(this.updateRenderersAsync(),this.effectsManager.isEffectEnabled("Video")))return this.logger.safe.info("onStreamUpdateRequested will be called after the first frame is proccessed of the video effect stream"),void this.effectsManager.once("onVideoEffectApplied",(()=>this.event("onStreamUpdateRequested").raise(e)));this.event("onStreamUpdateRequested").raise(e,t)}createAudioRenderer(){const e=new EI(this.logger.createChild("CustomAudioRenderer"),this.configProvider),t=gt();this.clientAudioRenderers.set(t,e);const i=e.play.bind(e),n=e.stop.bind(e);return this.raiseTelemetryEvent("custom_audio_renderer_created",this.getSelectedDevices()),{play:i,stop:n,dispose:()=>{this.clientAudioRenderers.get(t)?.dispose(),this.clientAudioRenderers.delete(t)},setMuted:(t,i=Re())=>e.setMuted(t,i),isMuted:()=>e.muted}}setAudioSharingRequested(e){this.audioSharingRequested=e}createDevicesHandle(e,t,i){const n=e.sharing?"ScreenShare":e.video?"Video":"Audio";return new HA(this.logger.createChild("DevicesHandle"),this.getMediaStream({...e,...i&&{deviceId:i},withTimeout:!1,withEffect:!1,audioProcessingFlags:this.audioProcessingFlags,force:!1,withOverridenStream:this.customDeviceMediaStreamMap.get(n)?.active&&this.customDeviceMediaStreamMap.get(n)},t))}shareSystemSound(e){this.configProvider.config.postponeAudioMixerForAudioSharing&&(this.audioSharingRequested=e,this.event("onAudioSharingToggled").raise(e))}getAllowedModalities(){const e=ht(this.permissionManager.browserPermittedModalities);return this.hasDeviceType("microphone")||(e.audio=[tt.MEDIA_STATE.inactive,tt.MEDIA_STATE.receive]),this.hasDeviceType("camera")||(e.video=[tt.MEDIA_STATE.inactive,tt.MEDIA_STATE.receive]),e}getRawDeviceMediaStream(e,t){if("ScreenShare"!==e&&!this.hasDeviceType(this.getDeviceType(e)))throw new Error("NoInputDevice");this.audioSharingRequested=t;const i=this.getStreamHandlerByType(e);if(!i)return this.logger.safe.debug(`method not found for ${e}`),null;const n=this.rawDeviceStreamManager.createIRawStreamClient(i,e);return this.raiseTelemetryEvent("IRawStream_client_created",e),n}setRawMediaStream(e,t){if(!e)throw this.logger.error(`Could not set ${e} as to ${t}`),new Error("InvalidStream");this.customDeviceMediaStreamMap.set(t,e),this.onMediaStreamUpdateRequested(t),this.raiseTelemetryEvent("set_raw_outgoing_media_stream",t)}unsetRawMediaStream(e){this.customDeviceMediaStreamMap.get(e)?(this.customDeviceMediaStreamMap.delete(e),this.onMediaStreamUpdateRequested(e),this.raiseTelemetryEvent("unset_raw_outgoing_media_stream",e)):this.logger.safe.debug("no custom stream")}async setVideoEffects(e){return this.effectsManager.setEffectType("Video",e)}async setAudioEffects(e){return this.effectsManager.setEffectType("Audio",e)}async getAudioStream(e,t,i=!1){const n=this.configProvider.config.devices.enumerateBeforeGettingStream;return n&&("always"!==n&&UA.isPolling||await UA.enumerateDevices()),this.getMediaStream({audio:!0,withTimeout:this.permissionManager.isPermissionKnown("microphone"),withEffect:!1,audioProcessingFlags:this.getAudioProcessingFlags(),force:e,withOverridenStream:!i&&this.customDeviceMediaStreamMap.get("Audio")?.active&&this.customDeviceMediaStreamMap.get("Audio")},t)}async getVideoStream(e,t,i=!1){const n=this.configProvider.config.devices.enumerateBeforeGettingStream;return n&&("always"!==n&&UA.isPolling||await UA.enumerateDevices()),this.getMediaStream({video:!0,withTimeout:this.permissionManager.isPermissionKnown("camera"),withEffect:!i&&this.configProvider.config.enableVideoEffects&&this.effectsManager.isEffectEnabled("Video"),force:e,withOverridenStream:!i&&this.customDeviceMediaStreamMap.get("Video")?.active&&this.customDeviceMediaStreamMap.get("Video")},t)}getDisplayStream(e,t=!1){const i=!(!this.configProvider.config.enableAudioSharing||!this.audioSharingRequested);return this.getMediaStream({audio:i,sharing:!0,withTimeout:!1,withEffect:!1,audioProcessingFlags:i?0:void 0,force:!1,withOverridenStream:!t&&this.customDeviceMediaStreamMap.get("ScreenShare")?.active&&this.customDeviceMediaStreamMap.get("ScreenShare")},e)}async enumerateDevicesAsync(){return await this.isDeviceEnumeratorInitialized.promise,this.getDeviceDescriptions(this.deviceList)}async getDeviceNameAsync(e){await this.isDeviceEnumeratorInitialized.promise;const t=this.deviceList.find((t=>t.guid===e));return t?.label??""}async getSpeakerDeviceDomIdAsync(e){await this.isDeviceEnumeratorInitialized.promise;const t=this.deviceList.find((t=>t.guid===e));return t?.deviceId??""}selectDevices(e){return this.pendingDevices?(this.logger.safe.info(`Overriding device selection until enumeration is complete with ${JSON.stringify(zg(this.pendingDevices))}`),void(this.pendingDevices=e)):this.isDeviceEnumeratorInitialized.isPending?(this.logger.safe.info("Postponing device selection until enumeration is complete"),this.pendingDevices=e,void this.isDeviceEnumeratorInitialized.promise.then((()=>{this.logger.safe.info("Performing postponed device selection");const e=this.pendingDevices;this.pendingDevices=null,this.selectDevices(e)}))):void this.deviceSelection.selectDevices(e)}getSelectedDevices(){return this.toSelectedDevices(this.deviceSelection.selectedDevices)}setAudioProcessingFlags(e){e!==this.audioProcessingFlags&&(this.logger.debug(`Setting audio processing flags: ${this.audioProcessingFlags} -> ${e}`),this.audioProcessingFlags=e,this.event("onStreamUpdateRequested").raise("Audio"))}getOutputDeviceId(){return this.selectedDevices.speaker?.deviceId}getDeviceDescriptions(e){return(e||this.deviceList).map((e=>e.toDeviceDesc()))}getDevicesCount(){return this.deviceList.reduce(((e,t)=>(e[t.type]++,e)),{camera:0,speaker:0,microphone:0,compositeAudio:0,virtualDevice:0,audioIngestDevice:0})}async getKnownPermissionStates(){return await this.permissionManager.initialize(),this.permissionManager.knownPermissionStates}getLocalVideoRenderers(){return this.activeRenderers}dispose(){this.deviceManagerSubscriptions?.forEach((e=>e.dispose())),this.deviceManagerSubscriptions=null,this.virtualDeviceSubs?.forEach((e=>e.forEach((e=>e.dispose())))),this.virtualDeviceSubs?.clear(),this.virtualDeviceSubs=null,this.virtualDeviceRecord?.forEach((e=>e.dispose())),this.virtualDeviceRecord=null,this.unsubscribeFromStreamManagerEvents(),this.deviceEnumerator.dispose(),this.mediaStreamManager.dispose(),this.activeVideoEffectSub?.dispose(),this.activeVideoStreamForEffect?.dispose(),this.disposeRawStreamAccess(),this.disposeClientAudioRenderer(),this.effectsManager.dispose(),super.dispose()}async registerVirtualDevice(e,t){const i=e.length?e.map((({id:e},t)=>{const i=this.createChildDeviceManager(this.logger.createChild(`VirtualDevice-${t}`));return i.selectDevices({camera:e}),i})):[this.createChildDeviceManager(this.logger.createChild("VirtualDevice"))],n=new GA(i,t),r=n.id,s=[n.on("onVideoEffectApplied",((...e)=>this.event("onVideoEffectApplied").raise(...e))),n.on("onVideoEffectsEvent",((...e)=>this.event("onVideoEffectsEvent").raise(...e))),n.on("onDeviceTelemetryEvent",((...e)=>this.event("onDeviceTelemetryEvent").raise(...e))),n.on("onVideoEffectsTelemetryEvent",((...e)=>this.event("onVideoEffectsTelemetryEvent").raise(...e))),n.on("onDevicesPermissionChanged",((...e)=>this.event("onDevicesPermissionChanged").raise(...e))),n.on("onStreamUpdateRequested",((...e)=>this.event("onStreamUpdateRequested").raise(...e)))];return this.virtualDeviceSubs.set(r,s),this.virtualDeviceRecord.set(r,n),UA.list.updateVirtualDeviceList(this.getRegisteredDevices()),this.raiseTelemetryEvent("register_virtual_device",{deviceCount:i.length,id:r}),this.event("onVirtualDevicesChanged").raise(),r}async unregisterVirtualDevice(e){this.virtualDeviceRecord.has(e)?(this.virtualDeviceSubs.get(e).forEach((e=>e.dispose())),this.virtualDeviceSubs.delete(e),this.virtualDeviceRecord.get(e).dispose(),this.virtualDeviceRecord.delete(e),UA.list.updateVirtualDeviceList(this.getRegisteredDevices()),this.event("onVirtualDevicesChanged").raise(),this.raiseTelemetryEvent("unregister_virtual_device",{id:e})):this.logger.error(`No virtual device found with id ${e}`)}getRegisteredDevices(){return Array.from(this.virtualDeviceRecord.values())}getAudioProcessingFlags(){if(!this.effectsManager.shouldFallbackToNativeProcessing("Audio"))return this.audioProcessingFlags??this.configProvider.config.defaultAudioProcessingFlags}disposeClientAudioRenderer(){this.clientAudioRenderers.size&&(this.clientAudioRenderers.forEach((e=>{e.dispose()})),this.clientAudioRenderers.clear(),this.raiseTelemetryEvent("custom_audio_renderer_disposed",this.getSelectedDevices()))}disposeRawStreamAccess(){this.rawDeviceStreamManager.disposeAll(),this.rawDeviceStreamManager=null}toSelectedDevices(e){return Object.entries(e).reduce(((e,[t,i])=>(i&&(e[t]=i.guid),e)),{})}getStreamConstraints(e){return{deviceId:e?.deviceId||void 0}}hasDeviceType(e){return lt(this.deviceList).some((t=>t.type===e))}getConstraints(e){if(!e.audio&&!e.video&&!e.sharing)throw new Error("requesting nothing");if(this.logger.safe.info(`retrieving media stream: ${JSON.stringify(e)}`),e.sharing){let t;const i=this.selectedDevices.audioIngestDevice;return t=i&&e.deviceId?{deviceId:i.deviceId}:e.audio&&!e.deviceId?{deviceId:tt.SYSTEM_AUDIO_SOURCE_ID}:void 0,{audio:t,sharing:{deviceId:e.deviceId||tt.DISPLAY_SOURCE_ID},withTimeout:e.withTimeout,withEffect:!1,audioProcessingFlags:e.audioProcessingFlags,force:!1,withOverridenStream:e.withOverridenStream}}const t=this.selectedDevices.microphone,i=this.selectedDevices.camera,n=e.audio&&t,r=e.video&&i;if(!n&&!r)throw{type:tt.MEDIA_ERROR.noDeviceSelected,detail:`audio requested ${e.audio}, video requested: ${e.video} Devices: ${JSON.stringify(this.deviceList.map((e=>JSON.stringify(Kg(e,this.configProvider.config.devices.piiSafeWords)))))}`};const s=this.getStreamConstraints(t),a=this.getStreamConstraints(i);let o=e.audioProcessingFlags;return void 0!==o&&e.audio&&!e.video&&t?.capabilities&&(t.capabilities.echoCancellation&&!t.capabilities.echoCancellation.includes(!!(2&o))&&(o^=2),t.capabilities.autoGainControl&&!t.capabilities.autoGainControl.includes(!!(1&o))&&(o^=1),t.capabilities.noiseSuppression&&!t.capabilities.noiseSuppression.includes(!!(4&o))&&(o^=4)),o!==e.audioProcessingFlags&&this.logger.safe.warn(`Unable to fulfill processing flags ${e.audioProcessingFlags}, using ${o} instead`),{audio:e.audio?s:void 0,video:e.video?a:void 0,withTimeout:e.withTimeout,withEffect:e.withEffect,audioProcessingFlags:o,force:e.force,withOverridenStream:e.withOverridenStream}}getMediaStream(e,t){const i=this.getConstraints(e),n=this.mediaStreamManager.getMediaStream(i,t);return this.subscribeOnStreamEvents(n),n.start().then((()=>{const t=n.hasAudio(),i=n.hasVideo();t&&this.signalDeviceGood("Audio",n.rawTrack.muted),i&&this.signalDeviceGood(n.mediaType,n.rawTrack.muted),this.permissionManager.update(e,e)})).catch((t=>this.handleUserMediaError(e,t))),n}signalDeviceGood(e,t){this.ufdManager.signalDeviceEvent(0,"Good",e,this.id),this.ufdManager.signalDeviceEvent(1,"Good",e,this.id),this.ufdManager.signalDeviceEvent(3,"Good",e,this.id),t||"Audio"!==e&&!this.configProvider.config.raiseVideoMuteUfd||this.ufdManager.signalDeviceEvent(2,"Good",e,this.id)}handleUserMediaError(e,t){const i=this.getMediaType(e),n=e.audio&&e.video,r=(e,t)=>{!n&&this.ufdManager.signalDeviceEvent(e,t,i,this.id)};switch(t.type){case tt.MEDIA_ERROR.permissionDeniedError:"ScreenShare"!==i&&(r(3,"Bad"),this.configProvider.config.permissions.persistOnDeniedError&&this.refreshPermissions(e));break;case tt.MEDIA_ERROR.permissionDeniedBySystemError:r(3,"Bad");break;case tt.MEDIA_ERROR.sourceUnavailableError:r(0,"Bad");break;case tt.MEDIA_ERROR.mediaStreamRequestTimedOut:r(1,"Bad");break;default:this.logger.safe.error(`getMediaStream() error: ${Ge(t)}`),r(0,"Bad")}}refreshPermissions(e){const t=e.audio&&!e.video,i=!e.audio&&e.video;t?this.permissionManager.update({audio:!0},{audio:!1}):i&&this.permissionManager.update({video:!0},{video:!1})}getMediaType(e){if(e.sharing)return"ScreenShare";if(e.video)return"Video";if(e.audio)return"Audio";throw new Error(`mediaType is not defined for this constraint ${JSON.stringify(e)}`)}subscribeOnStreamEvents(e){const t=[];t.push(e.on("onStreamClientStarted",((e,t)=>this.onStreamStarted(e,t)))),t.push(e.on("onStreamClientDisposing",(e=>this.onStreamDisposing(e)))),t.push(e.on("onStreamClientEnded",((e,t)=>this.onStreamEnded(e,t)))),t.push(e.on("onStreamClientMuted",((e,t)=>this.onStreamMuted(e,t)))),t.push(e.on("onStreamClientError",((e,t)=>this.onStreamError(e,t)))),this.configProvider.config.useRawMediaApiForVideoEffects&&t.push(e.on("onStreamClientDisposed",(e=>this.removeVideoEffectStream(e)))),this.streamSubscriptions.set(e,t)}async removeVideoEffectStream(e){if(e.getCurrentConstraints().withEffect){this.logger.safe.info(`this.activeVideoEffectSub: ${this.activeVideoEffectSub} to be disposed`),this.activeVideoEffectSub?.dispose();const e=await(this.activeVideoStreamForEffect?.getMediaStream());this.effectsManager.stopEffect("Video",e)}}unsubscribeFromStreamEvents(e){this.streamSubscriptions.has(e)&&(this.streamSubscriptions.get(e).forEach((e=>e.dispose())),this.streamSubscriptions.delete(e))}subscribeOnRendererEvents(e){const t=[];t.push(e.on("onRendererDisposed",(e=>this.onRendererDisposed(e)))),t.push(e.on("onRendererStarted",(e=>this.onRendererStarted(e)))),t.push(e.on("onRendererSizeChanged",((e,t)=>this.onRendererSizeChanged()))),this.rendererSubscriptions.set(e,t)}unsubscribeFromRendererEvents(e){this.rendererSubscriptions.has(e)&&(this.rendererSubscriptions.get(e).forEach((e=>e.dispose())),this.rendererSubscriptions.delete(e))}subscribeOnStreamManagerEvents(){this.streamManagerSubscriptions=[],this.streamManagerSubscriptions.push(this.mediaStreamManager.on("onAllStreamsRemoved",(()=>this.onAllStreamsRemoved()))),this.streamManagerSubscriptions.push(this.mediaStreamManager.on("onStreamAcquired",((e,t,i,n,r,s)=>this.onStreamAcquired(e,t,i,n,r,s)))),this.streamManagerSubscriptions.push(this.mediaStreamManager.on("onStreamCreated",((e,t)=>this.onStreamCreated(e,t)))),this.streamManagerSubscriptions.push(this.mediaStreamManager.on("onStreamDisposing",((e,t)=>this.onMasterStreamDisposing(e,t))))}subscribeOnDeviceEnumeratorEvents(){this.deviceEnumerator.on("onDeviceEnumerationfailed",(e=>this.raiseTelemetryEvent("enumeration_failed",{error:e})))}unsubscribeFromStreamManagerEvents(){this.streamManagerSubscriptions.forEach((e=>e.dispose()))}async updateRenderersAsync(){try{await Promise.all(this.activeRenderers.map((e=>e.updateStreamAsync()))),this.logger.safe.info("Renderers updates finished")}catch(e){this.logger.safe.error(`Error updating renderers: ${Ge(e)}`)}}onSelectedDevicesChanged(e,t){const i=this.selectedDevices;if(this.selectedDevices=e,this.diagnostics?.setSelectedDevices(e,t),!("camera"in i^"camera"in this.selectedDevices||"microphone"in i^"microphone"in this.selectedDevices)){const e=this.toSelectedDevices(this.selectedDevices),t=this.toSelectedDevices(i);this.event("onSelectedDevicesChanged").raise(e,t),e.microphone!==t.microphone&&this.rawDeviceStreamManager.notifyChange("Audio"),e.camera!==t.camera&&this.rawDeviceStreamManager.notifyChange("Video"),this.clientAudioRenderers.forEach((e=>{e.setOutputDevice(this.getOutputDeviceId())}))}const n=this.configProvider.config.devices.piiSafeWords;this.raiseTelemetryEvent("selected_devices_changed",{microphone:this.selectedDevices.microphone&&Pt(this.selectedDevices.microphone.label,n),camera:this.selectedDevices.camera&&Pt(this.selectedDevices.camera.label,n),speaker:this.selectedDevices.speaker&&Pt(this.selectedDevices.speaker.label,n),fromInterface:t}),this.updateRenderersAsync()}onDevicesChanged(e,t){this.event("onDevicesChanged").raise(e,t),this.mediaStreamManager.onDevicesChanged(e),this.diagnostics?.setDeviceList(e,t,this.getDeviceListDebugInfo());const i=this.getDevicesCount();this.ufdManager.signalEvent("ZeroCaptureDevicesEnumerated",i.microphone>0?"Good":"Bad"),this.isAudioOutputSelectionSupported&&this.ufdManager.signalEvent("ZeroRenderDevicesEnumerated",i.speaker>0?"Good":"Bad");const n=new Map;let r=1;this.raiseTelemetryEvent("devices_changed",{devices:e.map((e=>{const t=n.get(e.groupId)||r++;return n.set(e.groupId,t),{label:Pt(e.label,this.configProvider.config.devices.piiSafeWords),isSystemDefault:e.isSystemDefault,kind:e.kind,type:e.type,capabilities:e.capabilities,groupId:`${t}`}})),debug:this.getDeviceListDebugInfo()})}getDeviceListDebugInfo(){return UA.list.debugInfo}raiseTelemetryEvent(e,t){this.logger.safe.info(`Device event: ${e}: ${JSON.stringify(this.scrubPayload(e,t))}`);const i={eventType:e,timestamp:Date.now(),payload:t};this.diagnostics?.registerDeviceTelemetryEvent(ut(i)),this.event("onDeviceTelemetryEvent").raise(i)}scrubPayload(e,t){return"devices_changed"===e?{devices:lt(t.devices).map((e=>Kg(e,this.configProvider.config.devices.piiSafeWords))),debug:t.debug}:t}async onStreamStarted(e,t){if(this.permissionManager.browserPermittedModalities.audio.some((e=>e===tt.MEDIA_STATE.send))||this.permissionManager.browserPermittedModalities.video.some((e=>e===tt.MEDIA_STATE.send)))try{await UA.enumerateDevices()}catch(e){this.logger.safe.warn(`onStreamStarted device enumeration failed: ${Ge(e)}`)}if(e.rawTrack){switch(e.mediaType){case"Audio":this.deviceEnumerator.startDevicePolling(),this.updateActiveMicrophone(e,t);break;case"Video":this.deviceEnumerator.startDevicePolling()}this.configProvider.config.useRawMediaApiForVideoEffects&&e.getCurrentConstraints().withEffect&&(this.activeVideoEffectSub=this.effectsManager.on("onVideoStreamQualityChanged",((t,i,n)=>e.onVideoStreamQualityChanged(t,i,n))))}else this.logger.safe.warn(`stream:${e.id} is already disposed`)}updateActiveMicrophone(e,t){if(e.deviceId){const i=this.deviceList.find((t=>t.deviceId===e.deviceId));if(!i&&"default"!==e.deviceId)return void this.logger.safe.error("Active device not found",`Device id from track: '${ke(e.deviceId)}', known devices: [${this.deviceList.map((e=>JSON.stringify(Kg(e,this.configProvider.config.devices.piiSafeWords))))}]}`,JSON.stringify(Jg(t)));i&&"default"!==e.deviceId&&t.audio&&t.audio.deviceId===tt.MEDIA_DEVICE.defaultId&&UA.list.updateActiveMicrophone(i)}}onStreamDisposing(e){this.unsubscribeFromStreamEvents(e)}onStreamMuted(e,t){("Audio"===e.mediaType||this.configProvider.config.raiseVideoMuteUfd)&&this.ufdManager.signalDeviceEvent(2,t?"Bad":"Good",e.mediaType,this.id),this.raiseTelemetryEvent(t?"stream_muted":"stream_unmuted",e.mediaType)}onStreamEnded(e,t){t.error?(this.raiseTelemetryEvent("stream_ended_error",{mediaType:e.mediaType,error:{type:t.error.name,detail:t.error.message}}),"SourceUnavailableError"===t.error.name&&this.ufdManager.signalDeviceEvent(0,"Bad","Audio",this.id)):("Audio"!==e.mediaType&&"Video"!==e.mediaType||this.ufdManager.signalDeviceEvent(0,"Bad",e.mediaType,this.id),this.raiseTelemetryEvent("stream_ended",e.mediaType))}onStreamError(e,t){this.raiseTelemetryEvent("stream_error",{mediaType:e.mediaType,error:t})}onAllStreamsRemoved(){this.deviceEnumerator.stopDevicePolling(),this.audioSharingRequested=!1}onStreamAcquired(e,t,i,n,r,s){0!==i&&this.raiseTelemetryEvent("stream_acquired",{id:e,mediaType:t,timestamp:i,resolution:n,withAudio:r,source:s})}onStreamCreated(e,t){this.raiseTelemetryEvent("stream_created",{id:e,mediaType:t})}onMasterStreamDisposing(e,t){this.raiseTelemetryEvent("stream_disposed",{id:e,mediaType:t})}onRendererDisposed(e){ot(this.activeRenderers,(t=>t===e)),this.domOverrides.onMediaElementRemoved?.(e.getVideoElement()),this.unsubscribeFromRendererEvents(e)}onRendererStarted(e){this.activeRenderers.push(e),this.event("onLocalRendererStarted").raise(e)}getLargestRendererResolution(){const e=this.activeRenderers.map((e=>e.getResolution()));return e?.length>0?e.reduce(((e,t)=>t.height>e.height?t:e)):{width:0,height:0}}onVideoEffectsQualityEventHandler(e){const t=this.deviceSelection.selectedDevices.camera;if(t?.deviceId){const i={type:"onVideoEffectQualityChanged",payload:{message:e.message,effectType:e.effectType}};this.event("onVideoEffectsEvent").raise(t.deviceId,i)}}onRendererSizeChanged(){const e=this.getLargestRendererResolution();this.effectsManager.resetOutputConstraints("Video",e,Yh.EffectQualityChangeReason.RendererSize)}getDeviceType(e){if("Video"===e)return"camera";if("Audio"===e)return"microphone";throw new Error(`DeviceType for mediaType: ${e} doesn't exist`)}getStreamHandlerByType(e){return"Video"===e?()=>this.getVideoStream(!1,"rawStream",!0):"Audio"===e?()=>this.getAudioStream(!1,"rawStream",!0):"ScreenShare"===e?()=>Promise.resolve(this.getDisplayStream("rawStream",!0)):null}},tR=class{constructor(e){this.configProvider=e,this.data={deviceList:[],deviceSelectionChangeCount:0,deviceSelectionChangeCountFromInterface:0,permissionStates:{microphone:"unknown",camera:"unknown"},devicesCount:{microphone:0,camera:0,speaker:0,compositeAudio:0,audioIngestDevice:0,virtualDevice:0},devicesChangeCount:0,devicesPollChangeCount:0,deviceTelemetryEvents:[],videoEffectsEvents:[],audioEffectsEvents:[]},Object.defineProperty(this.data,"rawUsedDevices",{get:()=>this.rawUsedDevices,configurable:!1,enumerable:!1})}set permissionStates(e){this.data.permissionStates=e}setSelectedDevices(e,t){const i={microphone:Pt(e.microphone?.label,this.configProvider.config.devices.piiSafeWords),camera:Pt(e.camera?.label,this.configProvider.config.devices.piiSafeWords),speaker:Pt(e.speaker?.label,this.configProvider.config.devices.piiSafeWords)};this.rawUsedDevices={microphone:e.microphone?.label,camera:e.camera?.label,speaker:e.speaker?.label},this.data.usedDevices&&(this.data.deviceSelectionChangeCount++,t&&this.data.deviceSelectionChangeCountFromInterface++),this.data.usedDevices=i}setDeviceList(e,t,i){this.data.deviceList=e.map((e=>({label:Pt(e.label,this.configProvider.config.devices.piiSafeWords),kind:e.type}))),i&&(this.data.deviceDebugStrings=ut(i)),this.data.devicesCount.microphone=e.filter((e=>"microphone"===e.type)).length,this.data.devicesCount.camera=e.filter((e=>"camera"===e.type)).length,this.data.devicesCount.speaker=e.filter((e=>"speaker"===e.type)).length,this.data.devicesCount.compositeAudio=e.filter((e=>"compositeAudio"===e.type)).length,this.data.devicesChangeCount++,t&&this.data.devicesPollChangeCount++}registerDeviceTelemetryEvent(e){if("stream_acquired"===e.eventType){const t=e.payload;"Video"===t.mediaType&&(this.data.latestCameraOpenResolution=t.resolution)}At(this.data.deviceTelemetryEvents,e,this.configProvider.config.diagnostics.collectionLimits.numDeviceEvents)}registerVideoEffectsEvent(e){At(this.data.videoEffectsEvents,e,this.configProvider.config.diagnostics.collectionLimits.numVideoEffectsEvents)}registerAudioEffectsEvent(e){At(this.data.audioEffectsEvents,e,this.configProvider.config.diagnostics.collectionLimits.numAudioEffectsEvents)}getObjectRef(){return this.data}},iR=class{constructor(){this.data={clientDSH:void 0,signalingDSH:void 0,serverDSH:void 0,activeStrategy:void 0,lastMsgOrigin:void 0}}setCurrentActiveStrategy(e){this.data.activeStrategy=e}resetState(){return this.data.lastMsgOrigin=void 0,this}recordHistoryEvent(e,t){var i,n;(i=this.data)[n=t+"DSH"]??(i[n]={count:0,duplicateCount:0}),this.data.lastMsgOrigin=t;const r=this.data[t+"DSH"];r.count++,r.firstMsgTime??(r.firstMsgTime=Date.now()),mt(this.data.lastHistory,e)&&r.duplicateCount++,this.data.lastHistory=e,this.data.lastMsgDate=Date.now()}getObjectRef(){return this.data}},nR=class{constructor(e,t){this.configProvider=e,this.addStatsError=t,this.data={video:{events:[],counters:{attempted:0,subscribed:0,unsubscribed:0,failed:0}},sharing:{events:[],counters:{attempted:0,subscribed:0,unsubscribed:0,failed:0}},subscribedTrackIds:[]}}set subscribedTrackIds(e){this.data.subscribedTrackIds=e}addSubscribe(e,t,i){const n=this.getModalityData(e);if(n){const e={evt:1,msi:t,localMsi:i,ts:Date.now()};At(n.events,e,this.configProvider.config.diagnostics.collectionLimits.numSubscriptionEvents),n.counters.attempted++}}addSubscribed(e,t,i,n){const r=this.getModalityData(e);if(r){const e={evt:2,msi:t,localMsi:i,ts:Date.now(),duration:n};At(r.events,e,this.configProvider.config.diagnostics.collectionLimits.numSubscriptionEvents),r.counters.subscribed++}}addUnsubscribe(e,t,i){const n=this.getModalityData(e);if(n){const e={evt:3,msi:t,localMsi:i,ts:Date.now()};At(n.events,e,this.configProvider.config.diagnostics.collectionLimits.numSubscriptionEvents),n.counters.unsubscribed++}}addFailed(e,t,i,n){const r=this.getModalityData(e);if(r){const e={evt:-1,msi:t,localMsi:i,ts:Date.now(),error:n};At(r.events,e,this.configProvider.config.diagnostics.collectionLimits.numSubscriptionEvents),r.counters.failed++}}getObjectRef(){return this.data}getModalityData(e){switch(e){case tt.MEDIA_TYPE.video:return this.data.video;case tt.MEDIA_TYPE.sharing:return this.data.sharing;default:return void this.addStatsError(`Unsupported modality ${e}`)}}},rR=class{constructor(e,t){this.configProvider=e,this.addStatsError=t,this.data={videoMaxCapabilitiesEvents:[],videoMaxCapabilitiesErrors:[],sharingMaxCapabilitiesEvents:[],sharingMaxCapabilitiesErrors:[],currentVideoSsrcRequestedCapabilities:{},currentVideoSsrcAppliedCapabilities:{},currentSharingSsrcRequestedCapabilities:{},currentSharingSsrcAppliedCapabilities:{},numVideoControlMessages:0,numOutOfOrderVideoControlMessages:0,numWebcamFreezeIntervals:0,numProcessedStreamFreezeIntervals:0}}onMaxCapabilitiesRequested(e){const t={causeId:e.causeId,events:[{eventType:"req",timestamp:Date.now(),capabilities:e.capabilities,isSimulcast:e.isSimulcastEnabled}]};try{if(e.modality===tt.MODALITY.video){At(this.data.videoMaxCapabilitiesEvents,t,this.configProvider.config.diagnostics.collectionLimits.numCapabilitiesRequested);for(const t of e.capabilities)this.data.currentVideoSsrcRequestedCapabilities[`${t.ssrc??0}`]=t}else if(e.modality===tt.MODALITY.sharing){At(this.data.sharingMaxCapabilitiesEvents,t,this.configProvider.config.diagnostics.collectionLimits.numCapabilitiesRequested);for(const t of e.capabilities)this.data.currentSharingSsrcRequestedCapabilities[`${t.ssrc??0}`]=t}}catch(e){this.addStatsError?.("onMaxCapabilitiesRequested",Ge(e))}}onMaxCapabilitiesApplied(e){try{const t=this.getEventForCause(e.modality,e.causeId),i={eventType:"app",timestamp:Date.now(),capabilities:e.capabilities,error:`${e.error}`||"none"};if(t&&(At(t.events,i,this.configProvider.config.diagnostics.collectionLimits.numCapabilitiesApplied,1),e.error&&(e.modality===tt.MODALITY.video?At(this.data.videoMaxCapabilitiesErrors,t,this.configProvider.config.diagnostics.collectionLimits.numCapabilitiesApplied,1):e.modality===tt.MODALITY.sharing&&At(this.data.sharingMaxCapabilitiesErrors,t,this.configProvider.config.diagnostics.collectionLimits.numCapabilitiesApplied,1))),e.modality===tt.MODALITY.video)for(const t of e.capabilities)this.data.currentVideoSsrcAppliedCapabilities[`${t.ssrc??0}`]=t;else if(e.modality===tt.MODALITY.sharing)for(const t of e.capabilities)this.data.currentSharingSsrcAppliedCapabilities[`${t.ssrc??0}`]=t}catch(e){this.addStatsError?.("onMaxCapabilitiesApplied",Ge(e))}}addVideoControlMessage(e=!1){this.data.numVideoControlMessages++,e&&this.data.numOutOfOrderVideoControlMessages++}getObjectRef(){return this.data}registerWebcamFreeze(){this.data.numWebcamFreezeIntervals++}registerProcessedStreamFreeze(){this.data.numProcessedStreamFreezeIntervals++}getEventForCause(e,t){return(e===tt.MODALITY.video?this.data.videoMaxCapabilitiesEvents:this.data.sharingMaxCapabilitiesEvents).find((e=>e.causeId===t))}},sR=class{constructor(e){this.configProvider=e,this.data={renderers:[],firstTimeToFirstFrameVideo:-1,firstTimeToFirstFrameSharing:-1,timeToFirstFrameSinceSubscriptionStartVideo:-1,timeToFirstFrameSinceSubscriptionStartSharing:-1,isRenderingEvents:{video:[],sharing:[]},preferredResolution:{video:void 0,sharing:void 0}}}setTimeToFirstFrame(e,t){-1!==e&&(t===tt.MODALITY.video&&-1===this.data.firstTimeToFirstFrameVideo?this.data.firstTimeToFirstFrameVideo=e:t===tt.MODALITY.sharing&&-1===this.data.firstTimeToFirstFrameSharing&&(this.data.firstTimeToFirstFrameSharing=e))}setTimeToFirstFrameSinceSubscriptionStart(e,t){-1!==e&&(t===tt.MODALITY.video&&-1===this.data.timeToFirstFrameSinceSubscriptionStartVideo?this.data.timeToFirstFrameSinceSubscriptionStartVideo=e:t===tt.MODALITY.sharing&&-1===this.data.timeToFirstFrameSinceSubscriptionStartSharing&&(this.data.timeToFirstFrameSinceSubscriptionStartSharing=e))}setIsRendering(e,t){this.data.isRenderingEvents[t]&&At(this.data.isRenderingEvents[t],{isRendering:e,ts:Date.now()},this.configProvider.config.diagnostics.collectionLimits.numIsRenderingEvents)}setPreferredResolution(e,t){(e.width||e.height)&&(this.data.preferredResolution[t]=e)}newRendererDiagnostics(){const e=new aR(this,this.configProvider),t=e.on("onDisposed",(()=>{this.removeDeadRenderers(),t.dispose()}));return this.data.renderers.push(e.getObjectRef()),e}getObjectRef(){return this.data}removeDeadRenderers(){this.data.renderers=this.data.renderers.filter((e=>e.alive))}},aR=class extends Qe{constructor(e,t){super(),this.managerDiagnostics=e,this.configProvider=t,this.isAlive=!0,this.data={alive:!0,totalFreezeDuration:0,isRendering:!1,timeToFirstFrame:-1,timeToFirstFrameSinceSubscriptionStart:-1,rendererStates:[]},delete this.data.alive,Object.defineProperty(this.data,"alive",{get:()=>this.isAlive,enumerable:!1,configurable:!1})}set trackId(e){this.data.trackId=e}set rendererSize(e){this.data.rendererSize=e,e.toString=()=>`${e.width}x${e.height}`,this.managerDiagnostics.setPreferredResolution(e,this.data.modality)}set msi(e){this.data.msi=e}set modality(e){this.data.modality=e}set isRendering(e){this.data.isRendering=e,this.managerDiagnostics.setIsRendering(e,this.data.modality)}set timeToFirstFrame(e){this.data.timeToFirstFrame=e,this.managerDiagnostics.setTimeToFirstFrame(e,this.data.modality)}set timeToFirstFrameSinceSubscriptionStart(e){this.data.timeToFirstFrameSinceSubscriptionStart=e,this.managerDiagnostics.setTimeToFirstFrameSinceSubscriptionStart(e,this.data.modality)}addFreezeDuration(e){this.data.totalFreezeDuration+=e}addStateChange(e){At(this.data.rendererStates,e,this.configProvider.config.diagnostics.telemetryLimits.numRendererStateChangedEvents)}dispose(){this.isAlive=!1,this.event("onDisposed").raise()}getObjectRef(){return this.data}},oR=i(496486),lR=T(be()),dR=i(496486);function cR(e){let t="";return it(e,((e,i)=>{t+=(t?";":"")+i,void 0!==e&&(t+=`=${e}`)})),t}var hR=class{constructor(e){this.parameters={},e&&e.split(";").forEach((e=>{const t=e.split("=");this.parameters[t[0]]=t[1]}))}setIfMissing(e,t){this.contains(e)||(this.parameters[e]=t)}removeIfPresent(e){this.contains(e)&&delete this.parameters[e]}get(e){return this.parameters[e]}names(){return Object.keys(this.parameters)}contains(e){return this.parameters.hasOwnProperty(e)}toString(){return cR(this.parameters)}};function uR(e,t,i){if(!e.rtp)return;const n=e.rtp.filter((e=>e.payload===t))[0];n&&gR(e,{codec:n.codec,rate:n.rate,payload:n.payload,encoding:n.encoding},(e=>(e.rtp.payload=i,e)))}function pR(e){const t=new Set;for(const i of e.media)for(const e of i.rtp??[])t.add(e.payload);const i=[96,127];for(let e=i[0];e<=i[1];e++)if(!t.has(e))return e;const n=[35,64];for(let e=n[0];e<=n[1];e++)if(!t.has(e))return e;return-1}function gR(e,t,i){fR(e,t,!0,i)}function mR(e,t,i){fR(e,t,!1,i)}function fR(e,t,i,n){if(e.rtp){for(let r=0;r<e.rtp.length;r++){const s=e.rtp[r],a=s.payload;if(t.codec.toLowerCase()!==s.codec.toLowerCase()||t.rate!==s.rate||t.encoding!==s.encoding||t.payload&&t.payload!==s.payload)continue;const o={rtp:s};e.fmtp||(e.fmtp=[]);const l=e.fmtp.find((e=>s.payload===e.payload));o.fmtp=l,e.rtcpFb||(e.rtcpFb=[]),o.rtcpFb=e.rtcpFb.filter((e=>e.payload===s.payload));const d=o.rtcpFb.length>0;if(null===n(o))e.payloads=e.payloads.toString().split(" ").filter((e=>s.payload!==+e)).join(" "),e.fmtp=e.fmtp.filter((e=>s.payload!==e.payload)),e.rtcpFb=e.rtcpFb.filter((e=>s.payload!==e.payload)),e.rtp[r]=null;else{if(o.rtp.payload!==a){const t=o.rtp.payload;e.payloads=e.payloads.toString().split(" ").map((e=>+e===a?t:+e)).join(" "),o.fmtp&&(o.fmtp.payload=t),o.rtcpFb&&o.rtcpFb.forEach((e=>e.payload=t)),e.fmtp.filter((e=>e.config&&e.config.indexOf(`apt=${a}`)>-1)).forEach((e=>e.config=e.config.replace(`apt=${a}`,`apt=${t}`)))}!l&&o.fmtp&&e.fmtp.push(o.fmtp),!d&&o.rtcpFb&&o.rtcpFb.forEach((t=>e.rtcpFb.push(t)))}if(i)break}e.rtp=e.rtp.filter((e=>!!e))}}function SR(e,t){if(!e.rtp)return;let i=-1;if(e.rtp.forEach((function(e,n){t.codec.toLowerCase()!==e.codec.toLowerCase()||t.rate!==e.rate||t.encoding!==e.encoding||t.payload&&t.payload!==e.payload||(i=n)})),i>=0&&e.rtp.length>1){const t=e.rtp[i].payload;e.rtp.splice(i,1),e.payloads=e.payloads.split(" ").filter((e=>t!==+e)).join(" "),e.fmtp=e.fmtp?.filter((e=>t!==e.payload))}}function vR(e,t){e.rtp.unshift({payload:t.payload,codec:t.codec,rate:t.rate,encoding:t.encoding}),e.payloads=`${t.payload} ${e.payloads}`}function yR(e,t,i){if(!(0,dR.isUndefined)(e.rate)&&e.rate!==t.rate)return!1;if(!(0,dR.isUndefined)(e.codec)&&e.codec.toLowerCase()!==t.codec.toLowerCase())return!1;if(!(0,dR.isUndefined)(e.encoding)){if(!(0,dR.isUndefined)(t.encoding)&&e.encoding!==t.encoding)return!1;if((0,dR.isUndefined)(t.encoding)&&1!==e.encoding)return!1}return!!(0,dR.isUndefined)(e.fmtpLine)||!(!i||!i.find((i=>i.payload===t.payload&&-1!==i.config.toLowerCase().indexOf(e.fmtpLine.toLowerCase()))))}function CR(e,t){return t===e||"*"===t}function TR(e,t,i,n){if(!e.rtp?.length)return;let r=e.rtp.filter((i=>t.some((t=>yR(t,i,e.fmtp)))));e.type===tt.MEDIA_TYPE.video&&(r=r.filter((t=>{const i=e.fmtp&&e.fmtp.find((e=>e.payload===t.payload&&e.config.startsWith("apt=")));if(i){const e=+i.config.split(";")[0].split("=")[1];return r.some((t=>t.payload===e))}return!0}))),r.length?(e.rtp=r,i&&(e.rtp=(0,dR.flatten)(t.map((t=>e.rtp.filter((i=>yR(t,i,e.fmtp))))))),e.payloads=e.rtp.map((e=>e.payload)).join(" "),e.fmtp=e.fmtp&&e.fmtp.filter((t=>e.rtp.some((e=>CR(e.payload,t.payload))))),e.rtcpFb=e.rtcpFb&&e.rtcpFb.filter((t=>e.rtp.some((e=>CR(e.payload,t.payload)))))):n&&n.warn("Empty rtp list after filtering")}function ER(e){if(e.label)switch(e.label){case tt.MEDIA_LABEL.audio:return"Audio";case tt.MEDIA_LABEL.video:return"Video";case tt.MEDIA_LABEL.sharing:return"ScreenShare";case tt.MEDIA_LABEL.data:return"Data"}else switch(e.type){case tt.MEDIA_TYPE.audio:return"Audio";case tt.MEDIA_TYPE.video:return"Video";case tt.MEDIA_TYPE.data:case tt.MEDIA_TYPE.dataChannel:return"Data"}return null}function _R(e){if(e.label)switch(e.label){case tt.MEDIA_LABEL.audio:return tt.MODALITY.audio;case tt.MEDIA_LABEL.video:return tt.MODALITY.video;case tt.MEDIA_LABEL.sharing:return tt.MODALITY.sharing;case tt.MEDIA_LABEL.data:return tt.MODALITY.data}else switch(e.type){case tt.MEDIA_TYPE.audio:return tt.MODALITY.audio;case tt.MEDIA_TYPE.video:return tt.MODALITY.video;case tt.MEDIA_TYPE.data:case tt.MEDIA_TYPE.dataChannel:return tt.MODALITY.data}return null}function bR(e){switch(e){case tt.MODALITY.audio:return tt.MEDIA_LABEL.audio;case tt.MODALITY.video:return tt.MEDIA_LABEL.video;case tt.MODALITY.sharing:return tt.MEDIA_LABEL.sharing;case tt.MODALITY.data:return tt.MEDIA_LABEL.data;default:return null}}function PR(e){return e.media.reduce(((e,t)=>{if(0!==t.port){const i=_R(t);if(!(i in e)){const n=t.direction?t.direction.toLowerCase():tt.MEDIA_STATE.sendReceive;e[i]=n}}return e}),{})}function IR(e){const t=e.groups?.find((e=>"BUNDLE"===e.type));if(t){const i=t.mids?.toString().split(" ")[0];return e.media.find((e=>{const t="number"==typeof e.mid?e.mid.toString():e.mid;return i===t}))||null}return null}function AR(e){return 0===e.port}function RR(e){let t;return e&&gR(e,{codec:"h264",rate:9e4},(e=>{e.fmtp?.config&&(t=function(e){const t=new hR(e);return{maxFs:+t.get(tt.VIDEO_CAPABILITIES.MAX_FS_PATH),maxMbps:+t.get(tt.VIDEO_CAPABILITIES.MAX_MBPS_PATH),maxFps:+t.get(tt.VIDEO_CAPABILITIES.MAX_FPS_PATH)/100,maxBr:1200*+t.get(tt.VIDEO_CAPABILITIES.MAX_BR_PATH)}}(e.fmtp.config))})),t}function wR(e){const t=e.media.map((e=>parseFloat(e.mid)));for(let e=1;e<=Math.max(...t)+1;e++)if(!t.includes(e))return e.toString();return"-1"}var MR=i(496486);function OR(){const e=[{jsep:"active",msSdp:"tcp-act"},{jsep:"passive",msSdp:"tcp-pass"},{jsep:"so",msSdp:"tcp-so"}];function t(t,i){delete t.generation,delete t["network-id"],delete t["network-cost"],t.transport.match(/tcp/i)&&function(t,i){e.some((function(e){if(i){if(e.msSdp===t.transport.toLowerCase())return t.transport="tcp",t.tcptype=e.jsep,!0}else if(t.tcptype&&e.jsep===t.tcptype.toLowerCase())return t.transport=e.msSdp,delete t.tcptype,!0;return!1}))}(t,i)}function i(e,t,i){const n=t.connection||i.connection,r=function(e,t,i){return e.port===i&&e.ip===t};return!!n&&(1===e.component?r(e,n.ip,t.port):!!t.rtcp&&r(e,t.rtcp.ip||n.ip,t.rtcp.port))}this.fromMsSdp=function(e){e.candidates=e.candidates||[],e.xCandidatesIpv6&&(e.xCandidatesIpv6.forEach((function(t){e.candidates.push(t)})),delete e.xCandidatesIpv6),e.candidates.forEach((function(e){t(e,!0)}))},this.toMsSdp=function(e,n){e.candidates=e.candidates||[],e.candidates.sort((function(t,r){return t.foundation!==r.foundation?t.foundation-r.foundation:t.component!==r.component?t.component-r.component:+i(r,e,n)-+i(t,e,n)})),e.candidates=e.candidates.filter((function(i,n){t(i,!1);const r=e.candidates[n-1];return!r||r.component!==i.component||r.foundation!==i.foundation})),function(e,t){if(e.port&&!e.candidates.length){const i=IR(t);i&&(e.port=i.port,e.connection=i.connection)}}(e,n)}}var DR={build:()=>new OR},kR=class{toMsSdp(e,t){"offer"===t?e.rtcp&&(e.rtcp={port:e.port}):delete e.rtcp}},NR={build:()=>new kR},LR={STREAM_ID:{audio:"mainAudio",video:"mainVideo",sharing:"applicationsharingVideo"},STREAM_ID_DELIMITER:"-"},xR=[{label:tt.MEDIA_LABEL.audio,id:LR.STREAM_ID.audio},{label:tt.MEDIA_LABEL.video,id:LR.STREAM_ID.video},{label:tt.MEDIA_LABEL.sharing,id:LR.STREAM_ID.sharing}].reduce(((e,t)=>(e[t.label]=t.id,e)),{}),FR=gt(),UR=class{constructor(e){this.configuration=e}fromMsSdp(e){if(0!==e.port){if(!this.isRecvOnly(e)||this.configuration.unifiedPlanEnabled){if(e.msid){e.ssrcs&&1===e.ssrcs.length&&(this.addStream(e,e.ssrcs[0].id,e.ssrcs[0].value,e.msid),e.ssrcs.shift());const t=e.msid.split(" ");(this.configuration.addPrefixForMsid||"-"===t[0])&&(e.msid=this.getMsidValue(t[0],t[1]||t[0],e.label))}if(e.ssrcs)this.updateMsids(e.ssrcs,((t,i)=>this.configuration.addPrefixForMsid||"-"===t?this.getMsidValue(t,i,e.label):`${t} ${i}`));else{const t=this.getFlowSsrcs(e);t.length>0?t.forEach((i=>{this.addStream(e,i,FR,this.getMsidValue(t[0],t[0],e.label))})):e.xSsrcRange&&this.addStream(e,e.xSsrcRange.ssrcMin,FR,this.getMsidValue(e.xSsrcRange.ssrcMin,e.xSsrcRange.ssrcMin,e.label))}}delete e.xSsrcRange}}toMsSdp(e,t){if(0===e.port)return;let i;e.ssrcs?.[0]&&(i=e.ssrcs[0].id),void 0!==i&&(e.xMultiStream||(e.xSsrcRange={ssrcMin:i,ssrcMax:i+t}))}getFlowSsrcs(e){if(e.ssrcGroups&&e.type===tt.MEDIA_TYPE.video){let t;if(e.ssrcGroups.some((e=>"FID"===e.semantics&&(t=e,!0))),t)return t.ssrcs.split(" ").map((e=>+e))}return[]}addStream(e,t,i,n){e.ssrcs=e.ssrcs||[],e.ssrcs.push({attribute:"cname",id:t,value:i}),e.ssrcs.push({attribute:"msid",id:t,value:n})}updateMsids(e,t){e.filter((e=>"msid"===e.attribute)).forEach((e=>{const i=e.value.split(" ");e.value=t(i[0],i[1]||i[0])}))}getMsidValue(e,t,i){const n=this.getMsidPrefix(i);return n+e+" "+n+t}getMsidPrefix(e){return xR[e]?xR[e]+LR.STREAM_ID_DELIMITER:""}isRecvOnly(e){return"recvonly"===e.direction}},VR={audio:"main-audio",video:"main-video"},HR=class{constructor(e,t){this.context=e,this.mediaManager=t,this.logger=this.context.logger,this.candidateTransform=DR.build(),this.streamTransform=new UR(this.context.configuration),this.rtcpTransform=NR.build()}toMsSdp(e,t){return e.msidSemantic={semantic:"WMS",token:"*"},e.media.forEach(((i,n)=>{if(i.protocol=tt.PROFILES.rtpSavp,i.label=i.label||this.getLabel(i.type),AR(i)){for(const e in i)i.hasOwnProperty(e)&&["type","port","protocol","payloads"].indexOf(e)<0&&delete i[e];i.payloads="34"}const r=this.getSsrcRangeForIndex(i.direction,n);this.streamTransform.toMsSdp(i,r),i.crypto&&i.crypto.forEach((function(e){e.config+="|2^31"})),0!==i.port&&e.fingerprint&&(i.fingerprint=e.fingerprint),this.candidateTransform.toMsSdp(i,e),this.rtcpTransform.toMsSdp(i,t),i.invalid&&(this.logger.unsafe.error(`Unknown SDP attributes! ${JSON.stringify(i.invalid)}`),delete i.invalid),this.transformExtensions(i,!1),0!==i.port&&(i.type===tt.MEDIA_TYPE.audio&&this.context.configProvider.config.webrtcAudioChannelSignalingFeedback?i.signalingFbXMessage={payload:"*",param:this.context.configProvider.config.webrtcAudioChannelSignalingFeedback}:i.type===tt.MEDIA_TYPE.video&&this.context.configProvider.config.webrtcVideoChannelSignalingFeedback&&(i.signalingFbXMessage={payload:"*",param:this.context.configProvider.config.webrtcVideoChannelSignalingFeedback}))})),delete e.fingerprint,e}fromMsSdp(e,t){for(let i=e.media.length-1;i>=0;--i){const n=e.media[i];if((n.ssrcs&&n.ssrcs[0]||n.xSsrcRange)&&(e.msidSemantic={semantic:"WMS",token:"*"}),AR(n))n.direction||(n.direction="inactive");else{if(this.streamTransform.fromMsSdp(n),delete n.cryptoscale,n.fingerprint&&(!this.isOffer(t)||this.context.configProvider.config.disableIncomingDtlsRoleOverride&&n.setup||(n.setup="actpass")),n.crypto)for(let e=n.crypto.length-1;e>=0;--e){const t=n.crypto[e];t.config.match(/.*\|\d+:\d+/)?n.crypto.splice(e,1):t.config=t.config.replace(/(.*)\|2\^\d+/,"$1")}n.remoteCandidates&&(delete n.candidates,delete n.xCandidatesIpv6,delete n.remoteCandidates),this.candidateTransform.fromMsSdp(n),n.rtcpFbXMessage&&delete n.rtcpFbXMessage,n.invalid&&this.logger.unsafe.info(`Unknown SDP attributes! ${JSON.stringify(n.invalid)}`),this.transformExtensions(n,!0)}}return e}transformExtensions(e,t){const i=[{name:tt.ABS_SEND_TIME.EXT_URI,encoded:tt.ABS_SEND_TIME.MSSDP_ENCODED_URI},{name:tt.TRANSPORT_CC.EXT_URI,encoded:tt.TRANSPORT_CC.MSSDP_ENCODED_URI}];e.ext&&e.ext.forEach((function(e){i.some((function(i){const n=t?i.encoded:i.name,r=t?i.name:i.encoded;return n===e.uri&&(e.uri=r,!0)}))}))}isOffer(e){return"offer"===e}getLabel(e){return VR.hasOwnProperty(e)&&VR[e]||"undefined"}getSsrcRangeForIndex(e,t){const i=this.mediaManager.getMediaEntities()[t],n=i?.getSimulcastContext();return Ag(e)&&n?n.getSsrcRange():0}},BR=class{constructor(e,t,i){this.context=e,this.mediaManager=t,this.sessionType=i,this.msSdpT=new HR(this.context,this.mediaManager)}modify(e){this.msSdpT.toMsSdp(e,this.sessionType)}},$R=class{constructor(e,t,i){this.context=e,this.mediaManager=t,this.sessionType=i,this.msSdpT=new HR(this.context,this.mediaManager)}modify(e){this.msSdpT.fromMsSdp(e,this.sessionType)}},jR=class{constructor(e){this.context=e}modify(e){const t=Yg(this.context),i=xg(e),n=e.media.find((e=>!!e.crypto));e.media.forEach((e=>{e.type!==tt.MEDIA_TYPE.dataChannel&&(!t&&e.fingerprint&&e.crypto&&delete e.crypto,e.protocol=!i.dtls||i.sdes&&t?tt.PROFILES.rtpSavpf:tt.PROFILES.udpTlsRtpSavpf,AR(e)&&e.protocol===tt.PROFILES.rtpSavpf&&n&&(e.crypto=n.crypto))}))}},GR=class{constructor(e,t,i){this.mediaManager=e,this.isOffer=t,this.configProvider=i}modify(e){e.media.forEach(((e,t)=>{const i=e.setup,n=this.mediaManager.getMediaEntities()[t],r=n.getExtension("setup");i&&n.isEnabled()&&("actpass"!==i?n.setExtension("setup",i):this.isOffer&&void 0!==r&&"actpass"!==r&&!this.configProvider.config.disableOutgoingDtlsRoleOverride&&(e.setup=r))}))}},WR=class{constructor(e,t){this.mediaManager=e,this.modalities=t}modify(e){let t=0;e.media.forEach(((e,i)=>{const n=parseInt(e.mid,10);!isNaN(n)&&n>=t&&(t=n+1)})),e.media.forEach(((i,n)=>{const r=this.mediaManager.getMediaEntities()[n];if(AR(i)||r.isDisabled()||!(r.getModality()in this.modalities)){const s=r.getExtension("midApplied")?void 0:i.mid||""+t++;0===n?i.direction=tt.MEDIA_STATE.inactive:e.media[n]=Yw(i.type,void 0,i.protocol,s)}}))}},qR=class{constructor(e,t){this.mediaManager=e,this.remote=t}modify(e){const t=this.mediaManager.getMediaEntities();for(let i=0;i<t.length;i++){const n=t[i],r=e.media[i];if(n.getExtension("rollback"))if(r&&!this.remote)e.media[i]=null;else if(!r&&this.remote){const t=n.getType()===tt.MEDIA_TYPE.data?tt.MEDIA_TYPE.dataChannel:n.getType(),i=t===tt.MEDIA_TYPE.dataChannel?tt.PROFILES.udpDtlsSctp:tt.PROFILES.udpTlsRtpSavpf;e.media.push(Yw(t,void 0,i,void 0))}}e.media=e.media.filter((e=>e))}},zR=class{constructor(e){this.mediaManager=e}modify(e){this.mediaManager.getMediaEntities().forEach(((t,i)=>{const n=e.media[i];t.getModality()!==tt.MODALITY.data||n&&n.type===tt.MEDIA_TYPE.dataChannel||e.media.splice(i,0,Yw(tt.MEDIA_TYPE.data,tt.MEDIA_LABEL.data,tt.PROFILES.rtpSavp,void 0))}))}},KR=class{constructor(e,t){this.context=e,this.direction=t}modify(e){e.media.forEach((e=>{e.type===tt.MEDIA_TYPE.dataChannel&&(e.type=tt.MEDIA_TYPE.data,e.payloads=tt.PAYLOAD_TYPE.X_DATA)})),Xg(this.context)&&Qw(e,tt.MEDIA_TYPE.data).forEach((t=>{t.rtp=t.rtp||[],t.fmtp=t.fmtp||[],t.rtp.push({codec:"x-data",payload:127,rate:9e4}),t.rtp.push({codec:"rtx",payload:126,rate:9e4}),t.fmtp.push({payload:126,config:"apt=127"});const i=this.getNonOverlappingSsrc(e);t.xSsrcRange={ssrcMin:i,ssrcMax:i},t.rtcpMux="rtcp-mux",t.xDataProtocol="sctp",t.direction=this.direction}))}getNonOverlappingSsrc(e){let t,i=!0;do{t=Math.floor(4294967293*Math.random())+2,Qw(e).forEach((e=>{e?.ssrcs?.[0]?.id===t&&(i=!1)}))}while(!i);return t}},JR=class{constructor(e){this.configProvider=e,this.uri="urn:3gpp:video-orientation",this.value=13}modify(e){if(this.configProvider.config.enableVideoOrientationExtension)for(const t of Qw(e,tt.MEDIA_TYPE.video))this.modifyMedia(t)}},YR=class extends JR{modifyMedia(e){e.ext??(e.ext=[]),e.ext.some((e=>e.uri===this.uri))||e.ext.push({value:this.getAvailableValue(e.ext),uri:this.uri})}getAvailableValue(e){const t=e.map((e=>e.value));return t.includes(this.value)?Math.max(...t)+1:this.value}},QR=class extends JR{modifyMedia(e){e.ext=e.ext?.filter((e=>e.uri!==this.uri))}},XR=class{constructor(e){this.context=e}modify(e){const t=e.groups?.find((e=>"BUNDLE"===e.type));for(let i=e.media.length-1;i>=0;i--){const n=e.media[i];if(n.type===tt.MEDIA_TYPE.data){const r=this.context.configProvider.config.rejectUnbundledDataModality&&!this.context.configProvider.mediaConfig.isTransportUnbundled&&!t?.mids?.toString().includes(n.mid),s=Xg(this.context);s||this.context.configProvider.config.acceptDisabledDataModality?(n.port=s&&!r?n.port:0,n.payloads=tt.PAYLOAD_TYPE.DATA_CHANNEL,n.type=tt.MEDIA_TYPE.dataChannel,n.protocol=tt.PROFILES.udpDtlsSctp,n.sctpPort??(n.sctpPort=this.context.configProvider.config.sctpPort),delete n.xDataProtocol,delete n.rtp,delete n.fmtp,delete n.rtcp,delete n.rtcpMux,delete n.ext,delete n.ssrcs,delete n.ssrcGroups,delete n.xSsrcRange):e.media.splice(i,1)}}}},ZR=class{constructor(e,t){this.modalities=e,this.mediaManager=t}modify(e){Qw(e).forEach((e=>{const t=_R(e),i=this.mediaManager.getMediaEntityByMid(e.mid);!(this.modalities[t]!==tt.MEDIA_STATE.send||i.getExtension("reinviteless")||e.direction&&e.direction.toLowerCase()===tt.MEDIA_STATE.receive)&&(e.direction=tt.MEDIA_STATE.receive)}))}},ew=class{constructor(e,t){this.isMultiparty=e,this.cname=t}modify(e){this.isMultiparty&&Qw(e).forEach((e=>{const t=e.direction;t!==tt.MEDIA_STATE.receive&&t!==tt.MEDIA_STATE.inactive||(e.ssrcs&&e.ssrcs[0]?e.ssrcs=[{id:e.ssrcs[0].id,attribute:"cname",value:this.cname}]:e.type===tt.MEDIA_TYPE.audio?e.ssrcs=[{id:4195875351,attribute:"cname",value:this.cname}]:e.type===tt.MEDIA_TYPE.video&&(e.ssrcs=[{id:1,attribute:"cname",value:this.cname}]))}))}},tw=class{modify(e){const t=new Set;Qw(e,tt.MEDIA_TYPE.video).forEach((e=>{e.ssrcs&&e.ssrcs.length>1&&t.add(e.ssrcs[0].id)}));const i=Qw(e,tt.MEDIA_TYPE.video).find((e=>e.direction===tt.MEDIA_STATE.sendReceive||e.direction===tt.MEDIA_STATE.send));Qw(e,tt.MEDIA_TYPE.video).forEach((e=>{const n=e.direction;if((n===tt.MEDIA_STATE.receive||n===tt.MEDIA_STATE.inactive)&&e.ssrcs&&1===e.ssrcs.length){const n=e.ssrcs[0].id;(1===n||i&&i.ssrcs[0].id===n||!i&&t.has(n))&&(delete e.ssrcs,delete e.ssrcGroups)}}))}},iw=class{constructor(e){this.mediaManager=e}modify(e){e.media.forEach(((e,t)=>{const i=this.mediaManager.getMediaEntities()[t];e.label=bR(i.getModality())}))}},nw=class{modify(e){e.media.forEach((e=>{delete e.label}))}},rw=class{constructor(e,t,i){this.mediaManager=e,this.modalities=t,this.configProvider=i}modify(e){let t=this.configProvider.mediaConfig.maxBandwidthInKbps;const i=e.bandwidth?.find((e=>"CT"===e.type));i&&(!t||t>i.limit)&&(t=i.limit);const n=this.configProvider.config.audioBandwidthInKbps||0,r=Math.max(t-n,0),s=this.configProvider.config.videoBandwidthAllocation&&Ag(this.modalities.video)&&Ag(this.modalities.sharing);Qw(e,tt.MEDIA_TYPE.video).forEach((e=>{if(delete e.bandwidth,r){let t=r;if(s){const i=this.mediaManager.getMediaEntityByMid(e.mid).getModality()===tt.MODALITY.video?this.configProvider.config.videoBandwidthAllocation:1-this.configProvider.config.videoBandwidthAllocation;t=Math.round(r*i)}e.bandwidth=[{limit:t,type:"AS"}]}}))}},sw=class{constructor(e){this.configProvider=e}modify(e){const t=this.configProvider.mediaConfig.maxBandwidthInKbps;t&&(e.bandwidth=[{limit:t,type:"CT"}])}},aw=class{constructor(e){this.mediaManager=e}modify(e){e.media.forEach(((e,t)=>{const i=this.mediaManager.getMediaEntities()[t],n=i.getExtension("iceUfrag");i.setExtension("iceRestart",!!e.iceUfrag&&!!n&&n!==e.iceUfrag),i.setExtension("iceUfrag",e.iceUfrag)}))}},ow=class{modify(e){const t=new Set(["urn:ietf:params:rtp-hdrext:csrc-audio-level","http://www.webrtc.org/experiments/rtp-hdrext/playout-delay"]);Qw(e).forEach((e=>{e.ext&&(e.ext=e.ext.filter((e=>!t.has(e.uri))))}))}},lw=class{constructor(e){this.configProvider=e}modify(e){this.configProvider.config.extmapAllowMixed&&(e.extmapAllowMixed="extmap-allow-mixed")}},dw=class{constructor(e){this.configProvider=e}modify(e){this.configProvider.config.extmapAllowMixed||delete e.extmapAllowMixed}},cw=class{modify(e){Qw(e).forEach((e=>{delete e.signalingFbXMessage}))}},hw=class{constructor(e,t){this.mediaManager=e,this.configProvider=t}modify(e){if(!this.configProvider.config.isAv1Allowed)return;const t=function(e,t){const i=new Set,n=[];for(const t of e.media)for(const e of t.rtp??[])i.add(e.payload);for(let e=t[0];e<=t[1];e++)i.has(e)||n.push(e);return n}(e,[96,127]);this.mediaManager.getMediaEntities().forEach(((i,n)=>{if(i.getModality()===tt.MODALITY.audio)return;const r=e.media[n];let s=0;mR(r,{codec:"AV1",rate:9e4},(e=>{e.rtp.payload<96&&(e.rtp.payload=t[s]??e.rtp.payload,s++)}))}))}},uw=class{constructor(e,t,i){this.mediaManager=e,this.configProvider=t,this.sdpType=i,this.baseModifier=new gw(this.mediaManager,this.configProvider,this.sdpType,!1)}modify(e){this.configProvider.config.filterCodecsInSdpV2||this.baseModifier.modify(e)}},pw=class{constructor(e,t,i){this.mediaManager=e,this.configProvider=t,this.sdpType=i,this.baseModifier=new gw(this.mediaManager,this.configProvider,this.sdpType,!0)}modify(e){this.configProvider.config.filterCodecsInSdpV2&&this.baseModifier.modify(e)}},gw=class{constructor(e,t,i,n=!1){this.mediaManager=e,this.configProvider=t,this.sdpType=i,this.alwaysReorder=n}modify(e){this.configProvider.config.filterCodecsInSdp&&"offer"===this.sdpType&&this.mediaManager.getMediaEntities().forEach(((t,i)=>{const n=e.media[i];if(!n)return;const r=Zg(this.configProvider,n.type);r.length&&TR(n,im(r),!!t.getExtension("unnegotiatedModality")||this.alwaysReorder,null)}))}},mw=class{constructor(e){this.configProvider=e}modify(e){const t=e.media.find((e=>e.type===tt.MEDIA_TYPE.audio)),i=this.configProvider.mediaConfig.audioCodecContext;t&&i&&(i.codec!==i.lastUsedCodec&&"None"!==i.lastUsedCodec&&this.removeSubstitutionCodecIfNeeded(t,i.lastUsedCodec),i.enabledLocally&&!i.disabledRemotely&&this.addSubstitutionCodecIfNeeded(t,i.codec,e))}addSubstitutionCodecIfNeeded(e,t,i){if(this.isSubstitutionCodecAdded(e,t))return;const n=pR(i);if(-1===n)return;const r=Zw(t,"SUBSTITUTION");eM(i,r.payload,n),vR(e,r)}removeSubstitutionCodecIfNeeded(e,t){SR(e,Zw(t,"SUBSTITUTION"))}isSubstitutionCodecAdded(e,t){let i=!1;return gR(e,Zw(t,"SUBSTITUTION"),(()=>{i=!0})),i}},fw=class{constructor(e){this.configProvider=e}modify(e){const t=e.media.find((e=>e.type===tt.MEDIA_TYPE.audio)),i=this.configProvider.mediaConfig.audioCodecContext;if(t&&i&&i.enabledLocally&&!i.disabledRemotely){const e=Zw(i.codec,"SUBSTITUTION"),n=Zw(i.codec,"CODEC");gR(t,e,(e=>{e.rtp.codec=n.codec,e.rtp.rate=n.rate,e.rtp.encoding=n.encoding}))}}},Sw=class{constructor(e){this.configProvider=e}modify(e){const t=e.media.find((e=>e.type===tt.MEDIA_TYPE.audio)),i=this.configProvider.mediaConfig.audioCodecContext;if(!t||!i?.enabledLocally)return;const n=Zw(i.codec,"CODEC"),r=Zw(i.codec,"SUBSTITUTION");let s=!1;gR(t,n,(e=>{i.enabledForSend&&(e.rtp.codec=r.codec,e.rtp.rate=r.rate,e.rtp.encoding=r.encoding,e.fmtp={payload:n.payload,config:"ptime=20"}),s=!0})),i.disabledRemotely=!s}},vw=class{modify(e){SR(e.media.find((e=>e.type===tt.MEDIA_TYPE.audio)),{codec:"CN",rate:16e3})}},yw=class{constructor(e){this.configProvider=e}modify(e){const t=e.media.find((e=>e.type===tt.MEDIA_TYPE.audio)),i=this.configProvider.mediaConfig.audioCodecContext;if(!t||!i?.enabledLocally||i.disabledRemotely)return;let n=!1;const r={codec:"CN",rate:48e3};if(gR(t,r,(()=>{n=!0})),n)return;const s=pR(e);-1!==s&&(eM(e,tt.PAYLOAD_TYPE.MSRTC_CNFB,s),r.payload=tt.PAYLOAD_TYPE.MSRTC_CNFB,vR(t,r))}},Cw=class{modify(e){SR(e.media.find((e=>e.type===tt.MEDIA_TYPE.audio)),{codec:"g722",rate:8e3,encoding:2})}},Tw=class{constructor(e){this.configProvider=e}modify(e){const t=this.configProvider.config.enforceOpusFmtp;t&&gR(e.media.find((e=>e.type===tt.MEDIA_TYPE.audio)),{codec:"opus",rate:48e3,encoding:2},(e=>{e.fmtp||(e.fmtp={payload:e.rtp.payload});const i=new hR(e.fmtp.config);Object.keys(t).forEach((e=>{i.removeIfPresent(e),i.setIfMissing(e,`${t[e]}`)})),e.fmtp.config=i.toString()}))}},Ew=class{modify(e){const t=e.media.find((e=>e.type===tt.MEDIA_TYPE.audio));if(t&&AR(t)){const i=e.media.find((e=>!!e.iceUfrag));i&&(t.port=9,t.direction="inactive",t.iceUfrag=i.iceUfrag,t.icePwd=i.icePwd,t.rtcpMux="rtcp-mux",i.crypto&&(t.crypto=i.crypto),i.fingerprint&&(t.fingerprint=i.fingerprint,t.setup=i.setup),t.rtp=[{payload:0,codec:"PCMU",rate:8e3}],t.payloads="0")}}},_w=class{constructor(e){this.otherPartyCodecs=e}modify(e){const t=e.media.find((e=>e.type===tt.MEDIA_TYPE.audio)),i=["cn","telephone-event"],n=t.rtp.filter((e=>-1!==this.otherPartyCodecs.indexOf(e.codec.toLowerCase())&&-1===i.indexOf(e.codec.toLowerCase())));if(0===n.length)throw new Error("there is no matching primary audio codec");t.rtp.filter((e=>e!==n[0]&&-1===i.indexOf(e.codec.toLowerCase()))).forEach((e=>{SR(t,e)}))}},bw=class{constructor(e,t){this.configProvider=e,this.logger=t}modify(e){this.configProvider.config.webrtcInjectTransportCCAudio&&Qw(e,tt.MEDIA_TYPE.audio).forEach((e=>{const t=e.ext?.find((e=>e.uri===tt.TRANSPORT_CC.EXT_URI));if(!t)return void this.logger.safe.info("transport-cc ext not present in sdp, skipping injecting transport-cc attribute for audio");const i=e.rtp?.find((e=>"opus"===e.codec.toLowerCase()));if(!i)return void this.logger.safe.info("opus codec not found, skipping injecting transport-cc attribute for audio");const n=i.payload,r=e.rtcpFb?.find((e=>e.type===tt.TRANSPORT_CC.ATTRIBUTE&&e.payload===n));r?this.logger.safe.info("opus codec already has transport-cc attribute"):(e.rtcpFb=e.rtcpFb||[],e.rtcpFb.push({payload:n,type:tt.TRANSPORT_CC.ATTRIBUTE}),this.logger.safe.info("injected transport-cc attribute"))}))}},Pw=class{constructor(e,t){this.mediaManager=e,this.configProvider=t}modify(e){e.media.forEach(((e,t)=>{if(AR(e)||e.type!==tt.MEDIA_TYPE.video)return;const i=this.mediaManager.getMediaEntities()[t];gR(e,{codec:"h264",rate:9e4},(e=>{const t=i.getLocalRecvCapabilities();if(!t)return;e.fmtp||(e.fmtp={payload:e.rtp.payload});const n=new hR(e.fmtp.config);this.configProvider.config.h264SdpProfile?(n.removeIfPresent("profile-level-id"),n.setIfMissing("profile-level-id",this.configProvider.config.h264SdpProfile)):n.setIfMissing("profile-level-id","42C02A"),n.setIfMissing("max-fs",t.getMaxFS().toString()),n.setIfMissing("max-mbps",t.getMaxMBPS().toString()),n.setIfMissing("max-fps",t.getMaxFPS().toString()),e.fmtp.config=n.toString()}))}))}},Iw=class{constructor(e){this.configProvider=e}modify(e){if(!this.configProvider.config.multiStreamSupported||this.configProvider.config.numVideoChannelsGvc<this.configProvider.config.nonMultiStreamChannels)return;let t=0;for(let i=0;i<e.media.length;i++)if("video"===e.media[i].type){if(e.media[i].xMultiStream)break;t++}const i=e.media.findIndex((e=>e.xMultiStream)),n=e.media[i];if(!n)return;const r=n.xMultiStream.startSsrc,s=n.xMultiStream.ssrcGroupRange,a=n.xMultiStream.ssrcRange;delete n.xMultiStream;const o=this.configProvider.config.numVideoChannelsGvc-t-1,l=[];for(let t=0;t<o;t++){const o=(0,MR.cloneDeep)(n);o.mid=wR(e),o.xSourceStreamId=n.xSourceStreamId,o.subStreamIndex=t,l.push(o.mid);const d=r+t*a;o.ssrcGroups=[{ssrcs:`${d} ${d+s}`,semantics:"FID"}],o.xSsrcRange={ssrcMin:d,ssrcMax:d+a-1},e.media.splice(i+t,0,o)}const d=r+o*a;n.ssrcGroups=[{ssrcs:`${d} ${d+s}`,semantics:"FID"}],n.xSsrcRange={ssrcMin:d,ssrcMax:d+a-1};const c=e.groups.find((e=>e.mids.includes(n.mid)));c.mids=`${c.mids} ${l.join(" ")}`}},Aw=class{constructor(e,t,i){this.mediaManager=e,this.configProvider=t,this.type=i}modify(e){if(!this.configProvider.config.multiStreamSupported||this.configProvider.config.numVideoChannelsGvc<=this.configProvider.config.nonMultiStreamChannels+1)return;const t=this.mediaManager.getMediaEntitiesByModality(tt.MODALITY.video);let i=-1,n=-1;if(t.forEach(((t,r)=>{const s=e.media.findIndex((e=>e.mid===t.getMid()));r===this.configProvider.config.nonMultiStreamChannels-1&&(n=s),i=s})),-1===i||-1===n)return;const r=e.media[i];e.media.splice(n+1,i-n-1);const s=this.configProvider.config.numVideoChannelsGvc-this.configProvider.config.nonMultiStreamChannels;r.xMultiStream={numberOfStreams:s,startSsrc:1,ssrcRange:1,ssrcGroupRange:1},"answer"===this.type&&(r.xMultiStream.numberOfStreams=Math.min(s,this.configProvider.mediaConfig.multiStreamChannelsOffered),r.ssrcGroups&&delete r.ssrcGroups,r.xSsrcRange&&delete r.xSsrcRange)}},Rw=class{constructor(e){this.configProvider=e}modify(e){Qw(e,tt.MEDIA_TYPE.video).forEach((e=>{gR(e,{codec:"h264",rate:9e4},(e=>{if(e.fmtp){const t=new hR,i=new hR(e.fmtp.config);["level-asymmetry-allowed","packetization-mode","profile-level-id"].forEach((e=>{if(i.contains(e)){let n=i.get(e);"profile-level-id"===e&&(n=this.configProvider.config.h264SendProfileOverride||n),t.setIfMissing(e,n)}})),e.fmtp.config=t.toString()}}))}))}},ww=class{constructor(e){this.configProvider=e}modify(e){this.configProvider.config.enableH264SpsPpsIdrKeyframe&&Qw(e,tt.MEDIA_TYPE.video).forEach((e=>{mR(e,{codec:"h264",rate:9e4},(e=>{if(e.fmtp){const t=new hR(e.fmtp.config);t.setIfMissing("sps-pps-idr-in-keyframe","1"),e.fmtp.config=t.toString()}}))}))}},Mw=class{constructor(e){this.configProvider=e}modify(e){this.configProvider.config.enableH264SpsPpsIdrKeyframe&&Qw(e,tt.MEDIA_TYPE.video).forEach((e=>{mR(e,{codec:"h264",rate:9e4},(e=>{if(e.fmtp){const t=new hR(e.fmtp.config);t.removeIfPresent("sps-pps-idr-in-keyframe"),e.fmtp.config=t.toString()}}))}))}},Ow=class{constructor(e){this.configProvider=e}modify(e){const t=(e.groups||[]).findIndex((e=>"BUNDLE"===e.type)),i=e.groups?e.groups[t]:void 0;i&&(this.configProvider.mediaConfig.isTransportUnbundled?(i.mids=this.createBundleFromMedia(Qw(e,tt.MEDIA_TYPE.video)),i.mids||e.groups.splice(t,1)):i.mids=this.createBundleFromMedia(Qw(e)))}createBundleFromMedia(e){return e.map((e=>e.mid?.toString())).filter((e=>e)).join(" ")}},Dw=class{modify(e){e.media.forEach((e=>{AR(e)&&e.bundleOnly&&(e.port=9,delete e.invalid)}))}},kw=class{constructor(e,t){this.configProvider=e,this.mediaManager=t}modify(e){if(!this.configProvider.mediaConfig.isTransportUnbundled&&!e.groups?.find((e=>"BUNDLE"===e.type))){let t=!1;if(e.media.forEach(((e,i)=>{const n=this.mediaManager.getMediaEntities()[i];!t&&n.isEnabled()?(e.mid=n.getMid(),t=!0):(n.disable(),e.port=0)})),t){e.groups||(e.groups=[]);const t={type:"BUNDLE"};e.groups.push(t)}}}},Nw=class{constructor(e,t){this.configProvider=e,this.logger=t}modify(e){e.media.forEach((e=>{const t=!!e.candidates;if(e.candidates&&(e.candidates=e.candidates.filter((e=>{let t=!0,i=!0,n=!0;return this.configProvider.config.iceCandidateType&&(t=!!e.type.match(new RegExp(this.configProvider.config.iceCandidateType,"i"))),this.configProvider.config.iceCandidateTransport&&(i=!!e.transport.match(new RegExp(this.configProvider.config.iceCandidateTransport,"i"))),this.configProvider.config.iceCandidateFilterMDns&&(n=!this.isMdns(e.ip),n||this.logger.safe.info(`Filtering out mDNS candidate ${ke(e.ip)}:${ke(e.port)}`)),t&&i&&n}))),t&&e.connection&&this.configProvider.config.iceCandidateFilterMDns&&(e.candidates&&0!==e.candidates.length||(e.candidates=[Xw(e.port)]),this.isMdns(e.connection.ip)||!this.hasMatchingCandidate(e))){const t=this.getDefaultCandidate(e);e.connection.ip=t.ip,e.port=t.port}}))}hasMatchingCandidate(e){const t=e.connection;return t&&!!e.candidates.find(this.createIpAndPortMatcher(t.ip,e.port))}getDefaultCandidate(e){return e.candidates.slice().sort(((e,t)=>e.type===t.type?0:"host"===e.type||"relay"===t.type?1:"relay"===e.type||"host"===t.type?-1:0))[0]}isMdns(e){return e.indexOf(".local")>-1||e.indexOf(".encrypted")>-1}createIpAndPortMatcher(e,t){return i=>i.ip===e&&i.port===t}},Lw=class{modify(e){const t=Qw(e)[0];t&&(t.candidates=[Xw()])}},xw=class{constructor(e){this.mediaManager=e}modify(e){e.media.forEach(((e,t)=>{this.fromMsSdp(e,t)}))}fromMsSdp(e,t){if(AR(e)||e.rids&&e.simulcast)return;const i=this.mediaManager.getMediaEntities()[t],n=i?.getSimulcastContext();n?.shouldBeEnabledInRemoteDesc()&&(n.enableInRemoteDesc(),e.simulcast={dir1:"recv",list1:n.ridList.map((e=>`${n.activeRids.includes(e)?"":"~"}${e}`)).join(";")},e.rids=n.ridList.map((e=>({id:e,direction:"recv"}))))}},Fw=class{constructor(e,t){this.mediaManager=e,this.logger=t}modify(e){e.media.forEach(((e,t)=>{this.toMsSdp(e,t)}))}toMsSdp(e,t){const i=this.mediaManager.getMediaEntities()[t],n=i?.getSimulcastContext();n&&(n.localDescriptionIsApplied(),n.shouldBeEnabledInLocalDesc()&&(n.enableInLocalDesc(),this.removeSimulcastEnvelope(e),this.addStreamSsrc(e,i.getLocalSsrc())))}removeSimulcastEnvelope(e){e.rids&&delete e.rids,e.simulcast&&delete e.simulcast}addStreamSsrc(e,t){if(!t)return;if(e.ssrcs)return void this.logger.safe.debug(`Media mid: ${e.mid} already contains ssrc: ${JSON.stringify(e.ssrcs)}`);const i=t;this.setSsrc(e,i)}setSsrc(e,t){e.ssrcs=[{id:t,attribute:"fake_attribute",value:"fake_value"}]}},Uw=class{constructor(e){this.mediaManager=e}modify(e){e.media.forEach(((e,t)=>{const i=this.mediaManager.getMediaEntities()[t],n=i?.getLocalTrackId();(!e.msid&&i?.getSimulcastContext()?.shouldUseSimulcast()&&n||i?.getExtension("reinviteless"))&&(e.msid=`- ${n??"-"}`)}))}},Vw=class{constructor(e,t){this.mediaManager=e,this.configProvider=t}modify(e){const t=this.mediaManager.getMediaEntities(),i=(0,MR.flatMap)(t,(e=>e.getRtpHeaderExtensions())),n=i.find((e=>"vla"===e?.headerType))?.value,r=i.find((e=>"non-adv-vla"===e?.headerType))?.value,s=n??r??(0,MR.flatMap)(e.media,(e=>e.ext||[])).find((e=>e.uri===tt.VLA.EXT_URI))?.value,a=function(e,t,i,n=!1){const r=(0,MR.flatMap)(e.media,(e=>e.ext||[])).map((e=>e.value));if(0===r.length)return i;const s=2,a=14;if(n&&!r.includes(i))return i;let o;for(let e=s;e<=a;e++)if(!r.includes(e)){o=e;break}return!o&&t&&(o=Math.max(...r)+1),o}(e,this.configProvider.config.extmapAllowMixed,tt.VLA.DEFAULT_VALUE);e.media.forEach(((e,i)=>{const n=ER(e);if(!this.configProvider.config.enableVla||"Video"!==n&&"ScreenShare"!==n)return;if(e.ext?.find((e=>e.uri===tt.VLA.EXT_URI)))return;const r=t[i]?.getRtpHeaderExtensions(),o=r?r.find((e=>"vla"===e.headerType))?.value??r.find((e=>"non-adv-vla"===e.headerType))?.value:s??a;o&&(e.ext=e.ext||[],e.ext.push({value:o,uri:tt.VLA.EXT_URI}))}))}},Hw=class{constructor(e){this.configProvider=e}modify(e){e.media.forEach((e=>{const t=ER(e);if(this.configProvider.config.allowRemoteVla&&("Video"===t||"ScreenShare"===t))return;const i=e.ext?.findIndex((e=>e.uri===tt.VLA.EXT_URI));i>-1&&e.ext.splice(i,1)}))}},Bw=class{constructor(e){this.configProvider=e}modify(e,t,i){e.media.forEach((e=>{const n=ER(e);if(!this.configProvider.config.enableNonAdvVla||"Video"!==n&&"ScreenShare"!==n||e.ext?.find((e=>e.uri===i)))return;const r=e.ext?.find((e=>e.uri===t));r&&(r.uri=i)}))}},$w=class extends Bw{constructor(e,t){super(e),this.mediaManager=t}modify(e){const t=this.mediaManager.getMediaEntities();(0,MR.flatMap)(t,(e=>e.getRtpHeaderExtensions())).some((e=>"vla"===e?.headerType))||super.modify(e,tt.VLA.EXT_URI,tt.VLA.EXT_URI_NON_ADV)}},jw=class extends Bw{constructor(e){super(e)}modify(e){super.modify(e,tt.VLA.EXT_URI_NON_ADV,tt.VLA.EXT_URI)}},Gw=class{modify(e){e.media.forEach((e=>{e.ext?.forEach((e=>e.uri=this.normalizeSlashesInUri(e.uri)))}))}normalizeSlashesInUri(e){return e.replace(/\\/g,"/")}},Ww=class{constructor(e){this.configProvider=e}modify(e){if(this.configProvider.config.fixSdpForPartialIceRestart){const[{iceUfrag:t,icePwd:i}={}]=e.media;void 0!==t&&void 0!==i&&e.media.forEach((e=>{e.iceUfrag=t,e.icePwd=i}))}}},qw=class{constructor(e){this.configProvider=e}modify(e){if(this.configProvider.config.reduceRtcpFbInSdp?.length)for(const t of Qw(e,tt.MEDIA_TYPE.video))t.rtcpFb=t.rtcpFb&&this.getFbList(t.rtcpFb)}getFbList(e){const t=[],i=[];for(const n of e){const e=n.subtype?`${n.type}/${n.subtype}`:`${n.type}`;t.includes(e)||(this.configProvider.config.reduceRtcpFbInSdp.includes(e)?(t.push(e),i.push({...n,payload:"*"})):i.push(n))}return i}},zw=class{constructor(e){this.configProvider=e}modify(e){if(!this.configProvider.config.redReceiveEnabled)return;const t=e.media.find((e=>e.type===tt.MEDIA_TYPE.audio));let i=0;gR(t,{codec:"opus",rate:48e3,encoding:2},(e=>{i=e.rtp.payload}));const n={codec:"RED",rate:8e3};gR(t,n,(e=>{e.rtp.rate=48e3,e.rtp.encoding=2,i&&(e.fmtp={payload:e.rtp.payload,config:`${i}/${i}`})})),SR(t,n)}},Kw=class{constructor(e){this.configProvider=e}modify(e){this.configProvider.config.redReceiveEnabled&&gR(e.media.find((e=>e.type===tt.MEDIA_TYPE.audio)),{codec:"red",rate:48e3,encoding:2},(e=>{e.rtp.codec="RED",e.rtp.rate=8e3,delete e.rtp.encoding}))}},Jw=class{constructor(e,t){this.configProvider=e,this.sdpType=t}modify(e){if(!this.configProvider.config.redReceiveEnabled||"offer"!==this.sdpType)return;const t=e.media.find((e=>e.type===tt.MEDIA_TYPE.audio)),i={codec:"red",rate:48e3,encoding:2};let n=0;if(gR(t,i,(e=>{n=e.rtp.payload})),n===tt.PAYLOAD_TYPE.MSRTC_RED)return;const r=pR(e);-1!==r&&(eM(e,tt.PAYLOAD_TYPE.MSRTC_RED,r),gR(t,i,(e=>{e.rtp.payload=tt.PAYLOAD_TYPE.MSRTC_RED})))}};function Yw(e,t,i,n){const r={type:e,port:0,label:t,payloads:e===tt.MEDIA_TYPE.dataChannel||e===tt.MEDIA_TYPE.data?tt.PAYLOAD_TYPE.DATA_CHANNEL:"36",protocol:i,connection:{ip:"10.10.10.10",version:4}};return n&&(r.mid=n),r}function Qw(e,t=null){return e.media.filter((e=>!(AR(e)||t&&e.type!==t)))}function Xw(e=1234){return{component:1,ip:"10.10.10.10",foundation:1755259772,priority:2122197247,port:9!==e?e:1234,transport:"UDP",type:"host"}}function Zw(e,t){if(!tt.AUDIO_DECODER[e]?.[t])throw`unsupported codec ${e} or type ${t}`;const i=tt.AUDIO_DECODER[e][t];return{codec:i.NAME,rate:i.RATE,encoding:i.ENCODING,payload:tt.AUDIO_DECODER[e].PT}}function eM(e,t,i){for(const n of e.media)uR(n,t,i)}var tM=class e{constructor(e,t,i,n){this.context=e,this.sessionType=t,this.sdp=i,this.remote=n,this.mediaManager=this.context.mediaManager,this.sdpTransform=this.context.sdpTransform,this.logger=this.context.logger.createChild("SessionDescr"),this.sdpModel=lR.parse(this.sdp),n&&new Iw(this.context.configProvider).modify(this.sdpModel),this.sdpModel.media.forEach((e=>{(0,oR.isUndefined)(e.mid)||(e.mid=e.mid.toString())})),this.remote&&!this.context.configProvider.config.disableMsSdp&&new $R(e,this.mediaManager,t).modify(this.sdpModel)}clone(){return new e(this.context,this.sessionType,this.sdp,this.remote)}getModalities(){return this.modalities||PR(this.sdpModel)}updateModalities(e){this.modalities=e}getSrtpInfo(){return xg(this.sdpModel)}getVideoCodecs(){const e={};return this.sdpModel.media.forEach((t=>{"video"===t.type&&t.rtp.map((e=>e.codec.toLowerCase())).forEach((t=>e[t]=!0))})),Object.keys(e)}usePrimaryAudioCodecOnly(e){new _w(e).modify(this.sdpModel)}isCodecSwitchSupported(){return!this.sdpModel.media.some((e=>e.type===tt.MEDIA_TYPE.audio&&e.xMediaSettings&&this.containsMediaSetting(e.xMediaSettings,"codecswitchunsupported")))}toLocal(){return this.sdpModel=this.sdpTransform.toLocal(this.sdpModel,this.mediaManager,this.sessionType),lR.write(this.sdpModel)}toOffer(){return this.toOfferAnswer()}toAnswer(){return this.toOfferAnswer()}toOfferAnswer(){const e="offer"===this.sessionType;return new Nw(this.context.configProvider,this.logger).modify(this.sdpModel),(new Dw).modify(this.sdpModel),e&&this.mediaManager.isEmpty()&&this.mediaManager.fromOffer(this.sdpModel,this.modalities),this.mediaManager.syncModalities(this.sdpModel,this.modalities,!e),this.sdpModel=e?this.sdpTransform.toOffer(this.sdpModel,this.mediaManager,this.modalities):this.sdpTransform.toAnswer(this.sdpModel,this.mediaManager,this.modalities),this.context.configProvider.config.disableMsSdp||new BR(this.context,this.mediaManager,this.sessionType).modify(this.sdpModel),new Pw(this.mediaManager,this.context.configProvider).modify(this.sdpModel),this.modalities=PR(this.sdpModel),lR.write(this.sdpModel)}toRemote(e){return this.modalities=e,this.mediaManager.fromRemote(this.sdpModel,this.modalities),this.sdpModel=this.sdpTransform.toRemote(this.sdpModel,this.mediaManager,this.modalities,this.sessionType),lR.write(this.sdpModel)}getVideoRecvCapabilities(){return RR(this.getMediaByLabel(tt.MEDIA_LABEL.video))}getSharingRecvCapabilities(){return RR(this.getMediaByLabel(tt.MEDIA_LABEL.sharing))}getMediaByType(e){return this.sdpModel.media.find((t=>t.type===e))}isUnbundled(){const e=this.sdpModel.groups?.find((e=>"BUNDLE"===e.type)),t=this.sdpModel.media.find((e=>e.type===tt.MEDIA_TYPE.audio)),i=this.sdpModel.media.find((e=>e.type===tt.MEDIA_TYPE.video));return e?!e.mids.toString().split(" ").find((e=>e===t.mid)):!!i}couldBeUnbundled(){return!this.sdpModel.groups?.find((e=>"BUNDLE"===e.type))||this.hasUnbundledIceCandidates()}containsMediaSetting(e,t){return e.some((e=>-1!==e.settings.indexOf(t)))}getMediaByLabel(e){return this.sdpModel.media.find((t=>t.label===e))}hasIceCandidatesForMediaType(e,t=""){const i=this.sdpModel.media?this.sdpModel.media.filter((t=>t.type===e&&!!t.candidates&&0!==t.candidates.length)):[];return t?i.some((e=>!!e.candidates&&e.candidates.some((e=>e.type===t)))):!!i.length}hasIceCandidates(){return this.hasIceCandidatesForMediaType(tt.MEDIA_TYPE.audio)||this.hasIceCandidatesForMediaType(tt.MEDIA_TYPE.video)}hasRelayIceCandidates(){return this.hasIceCandidatesForMediaType(tt.MEDIA_TYPE.audio,"relay")||this.hasIceCandidatesForMediaType(tt.MEDIA_TYPE.video,"relay")}hasUnbundledIceCandidates(){const e=this.sdpModel.media.filter((e=>e.type===tt.MEDIA_TYPE.video&&0!==e.port));return this.hasIceCandidatesForMediaType(tt.MEDIA_TYPE.audio)&&(!e.length||this.hasIceCandidatesForMediaType(tt.MEDIA_TYPE.video))}hasUnbundledRelayIceCandidates(){const e=this.sdpModel.media.filter((e=>e.type===tt.MEDIA_TYPE.video&&0!==e.port));return this.hasIceCandidatesForMediaType(tt.MEDIA_TYPE.audio,"relay")&&(!e.length||this.hasIceCandidatesForMediaType(tt.MEDIA_TYPE.video,"relay"))}isIceRestart(){return this.mediaManager.getMediaEntities().some((e=>e.getExtension("iceRestart")))}isMSRTC(){return!!this.sdpModel.xMediaBw}insertFakeCandidateIfNeeded(e,t){this.hasIceCandidates()||(e.setFakeIceCandidate(!0),t&&(t.fakeIceCandidate=!0),(new Lw).modify(this.sdpModel))}getBweType(){const e=this.sdpModel.media.find((e=>0!==e.port&&e.type===tt.MEDIA_TYPE.video));if(!e)return"Unknown";const t=e.ext?.find((e=>e.uri===tt.TRANSPORT_CC.EXT_URI||e.uri===tt.TRANSPORT_CC.MSSDP_ENCODED_URI));return t?"SSBWE":"REMB"}fixDataModality(){new zR(this.mediaManager).modify(this.sdpModel)}getPayloadsForMedia(e){const t=this.sdpModel.media.find((t=>t.type===e&&0!==t.port));return t?.rtp??[]}},iM=class{constructor(e){this.context=e}createLocalOffer(e){return new tM(this.context,"offer",e)}createRemoteOffer(e){return new tM(this.context,"offer",e,!0)}createLocalAnswer(e){return new tM(this.context,"answer",e)}createRemoteAnswer(e){return new tM(this.context,"answer",e,!0)}},nM=class{static build(e){return new iM(e=e||{})}};function rM(e){let t="";return e.dtls&&(t+="dtls"),e.sdes&&(t+="sdes"),t}var sM=class{constructor(){this.info={OfferedSrtp:"none",NegotiatedSrtp:"none",IceConnectionState:"none",IceConnectionStatePrevious:"none",SignalingState:"none",SignalingStatePrevious:"none",RelayCandidate:"none",IceTransportPolicy:"none",IceServers:"none",FakeIceCandidate:!1,BweType:"none",SdpSemantics:"none",BundlePolicy:"none",IPAddress:"none",ReflexiveLocalIP:"none",NumberOfInterfaces:0,EncodedStreamWorker:!1,AudioCodecEvents:"none"}}setCandidateDetails(e){"host"===e.type&&"udp"===e.protocol?this.setIPAddressInfo(e.ip):"srflx"===e.type&&this.setReflexiveLocalIP(e.ip)}setOfferedModalities(e){this.offeredModalities=e,this.activeModalities=e}setNegotiatedModalities(e){this.negotiatedModalities=e,this.activeModalities=e}setNegotiatedSrtpInfo(e){this.info.NegotiatedSrtp=rM(e)}setOfferedSrtpInfo(e){this.info.OfferedSrtp=rM(e)}setIceConnectionState(e){this.info.IceConnectionStatePrevious=this.info.IceConnectionState,this.info.IceConnectionState=e}setSignalingConnectionState(e){this.info.SignalingStatePrevious=this.info.SignalingState,this.info.SignalingState=e}setRelayCandidateInfo(e){this.info.RelayCandidate=JSON.stringify(e)}fillExtensionInfo(e){!function(e,t){for(const i in t)t.hasOwnProperty(i)&&(e[i]=t[i])}(e,this.info)}setIceTransportPolicy(e){this.info.IceTransportPolicy=e}setIceServers(e){const t=e.map((e=>{const t={...e};return t.username&&(t.username="true"),t.credential&&(t.credential="true"),t}));this.info.IceServers=JSON.stringify(t)}setFakeIceCandidate(e){this.info.FakeIceCandidate=e}setBweType(e){"Unknown"!==e&&(this.info.BweType=e)}setSdpSemantics(e){this.info.SdpSemantics=e}setBundlePolicy(e){this.info.BundlePolicy=e}setEncodedStreamWorkerLoaded(e){this.info.EncodedStreamWorker=e}setAudiocCodecEvents(e){this.info.AudioCodecEvents=JSON.stringify(e)}setCreateChannelFailReason(e){this.info.CreateChannelFailReason=Ge(e)}setIPAddressInfo(e){this.info.NumberOfInterfaces+=1,"none"===this.info.IPAddress&&(this.info.IPAddress=e)}setReflexiveLocalIP(e){"none"===this.info.ReflexiveLocalIP&&(this.info.ReflexiveLocalIP=e)}},aM=class{constructor(e){this.audioContext=new yg.window.AudioContext,this.sourceNode=this.audioContext.createMediaStreamSource(e),this.analyzerNode=this.createAnalyserNode(this.sourceNode)}dispose(){this.sourceNode.disconnect(),this.audioContext.close(),this.audioContext=null,this.sourceNode=null,this.analyzerNode=null}getInputLevel(){if(!this.analyzerNode)return 0;const e=new Uint8Array(this.analyzerNode.frequencyBinCount);return this.analyzerNode.getByteFrequencyData(e),Math.floor(65535*(0===(t=e).length?0:t.reduce(((e,t)=>e+t),0)/t.length)/255);var t}createAnalyserNode(e){const t=this.audioContext.createAnalyser();return t.fftSize=1024,t.smoothingTimeConstant=.1,e.connect(t),t}},oM=class e{constructor(e){this.name=e,this.sharedState={mark:new Map,measure:[]}}mark(e,t){const i=kt();this.sharedState.mark.set(e,{name:e,ts:i,startTime:bt(Nt+i),details:t})}measure(e,t){const i=this.sharedState.mark.get(t.start),n=this.sharedState.mark.get(t.end);if(i&&n){const r={...t,parentName:this.name===e?"":this.name};this.sharedState.measure.push({name:e,details:r,duration:bt(n.ts-i.ts),startTime:i.startTime})}}markAndMeasure(e,t,i,n){!1===this.sharedState.mark.has(t)&&this.mark(t,i);const r=this.sharedState.mark.get(e),s=this.sharedState.mark.get(t);if(r&&s){const e={...n,parentName:this.name===t?"":this.name};this.sharedState.measure.push({name:t,details:e,duration:bt(s.ts-r.ts),startTime:r.startTime})}}clone(t){const i=new e(`${this.name}|${t}`);return i.setSharedState(this.sharedState),i}setSharedState(e){this.sharedState=e}getReport(){return this.sharedState.measure.map((e=>({name:e.name,duration:e.duration,ts:e.startTime,parentName:e.details.parentName})))}},lM=class e{mark(){}measure(){}markAndMeasure(){}clone(){return new e}getReport(){return[]}},dM=class{constructor(e){this.enableTimerTracker=e,this.timerTrackers={},this.timerTrackerOptions={}}getTimerTracker(e,t){if(!this.enableTimerTracker)return new lM;const i=new oM(e);if(this.timerTrackers[e]){const t=this.timerTrackerOptions[e];if(t?.first)return new lM;t?.last&&(this.timerTrackers[e]=[i]),t?.all&&this.timerTrackers[e].push(i)}else this.timerTrackers[e]=[i],this.timerTrackerOptions[e]=t;return i}getReport(){if(this.enableTimerTracker)return Object.keys(this.timerTrackers).reduce(((e,t)=>{const i=this.timerTrackerOptions[t];return(i.first||i.last)&&(e[t]=[this.timerTrackers[t][0]?.getReport()]),i.all&&(e[t]=Object.values(this.timerTrackers[t]).map((e=>e?.getReport()))),e}),{})}},cM=class{constructor(){this.presentationAPIUserDuration=0,this.presentationAudioDuration=0,this.isActiveScreenSharing=!1}handleInputLevel(e,t){this.isActiveScreenSharing&&("ScreenShare"===e&&t>0&&(this.presentationAPIUserDuration+=tt.TIME_INTERVAL.SEC_1),"Audio"===e&&t>0&&(this.presentationAudioDuration+=tt.TIME_INTERVAL.SEC_1))}updateScreenSharingStream(e,t){"ScreenShare"===t&&(this.isActiveScreenSharing=!!e)}getPresentationAudioDuration(){return this.presentationAudioDuration}getPresentationAudioAPIUserDuration(){return this.presentationAPIUserDuration}},hM=/profile-level-id=(.{6})/,uM=class{constructor(e,t,i=(()=>{}),n=(()=>this),r=(()=>{}),s=new iR,a){this.configProvider=e,this.dmDiagnostics=t,this.addSessionStatsError=i,this.newNativeSession=n,this.commitNativeSession=r,this.dshDiagnostics=s,this.getSessionRef=a,this.data={startTime:Date.now(),duration:0,offeredSrtp:"unknown",negotiatedSrtp:"unknown",iceConnectionState:"none",iceConnectionStatePrevious:"none",signalingState:"none",signalingStatePrevious:"none",relayCandidate:"none",iceTransportPolicy:"none",iceServers:"none",fakeIceCandidate:!1,bweType:"Unknown",sdpSemantics:"none",bundlePolicy:"none",iceCandidateErrors:[],H264Profiles:[],numInterfaces:0,statsReports:[],aggregatedModalityStats:{},multiViewStats:[],networkInfo:[],statsErrors:[],statsOnSubscribed:{},recvVideoStreamCount:{min:0,max:0,mode:0},reportedReceiveBandwidth:[],encodedStreamWorker:!1,audioCodecEvents:"none",totalVideoRecvMblocksRates:{macroblockRateReceivedMax:0,macroblockRateReceivedAvg:0,macroblockRateDecodedMax:0,macroblockRateDecodedAvg:0,macroblockRateMaxDecoderLossPercent:0,macroblockRateDecoderLossPercent:0},timerTrackerReport:{},loopIntervalMax:-1,loopIntervalMedian:-1,fetchTimeMax:-1,fetchTimeMedian:-1,videoPerformanceEvent:[],ovcToSubscriptionEvents:[],presentationAPIUserDuration:0,presentationAudioDuration:0,earlyMediaNumStatsPolls:0},this.timerTracker=new dM(this.configProvider.config.enableTimerTracker),this.presentationAudioTelemetry=new cM,Rt(this.data,{duration:()=>this.data.endTime?this.data.endTime-this.data.startTime:Date.now()-this.data.startTime,bandwidthReport:()=>this.bandwidthStatsRef?.getBandwidthReport(),timerTrackerReport:()=>this.timerTracker.getReport(),presentationAPIUserDuration:()=>this.presentationAudioTelemetry.getPresentationAudioAPIUserDuration(),presentationAudioDuration:()=>this.presentationAudioTelemetry.getPresentationAudioDuration()}),Object.defineProperty(this.data,"IPAddress",{enumerable:!1,writable:!0,configurable:!0}),Object.defineProperty(this.data,"reflexiveLocalIP",{enumerable:!1,writable:!0,configurable:!0})}getTimerTracker(e,t){return this.timerTracker.getTimerTracker(e,t)}get deviceManager(){return this.dmDiagnostics}get audioLevel(){return this.analyzer?.getInputLevel()}get reflexiveLocalIP(){return this.data.reflexiveLocalIP}set bandwidthDiagnostic(e){this.bandwidthStatsRef=e}get callIsMuted(){return this.getSessionRef?.().callIsMuted}get sharingAudioLevel(){return this.analyzerSharing?.getInputLevel()}set offeredModalities(e){this.data.offeredModalities=e,this.data.activeModalities=e}set negotiatedModalities(e){this.data.negotiatedModalities=e,this.data.activeModalities=e}set offeredSrtp(e){this.data.offeredSrtp=pM(e)}set negotiatedSrtp(e){this.data.negotiatedSrtp=pM(e)}set iceConnectionState(e){this.data.iceConnectionStatePrevious=this.data.iceConnectionState,this.data.iceConnectionState=e}set signalingConnectionState(e){this.data.signalingStatePrevious=this.data.signalingState,this.data.signalingState=e}set relayCandidateInfo(e){this.data.relayCandidate=JSON.stringify(e)}set iceTransportPolicy(e){this.data.iceTransportPolicy=e}set iceServers(e){const t=e.map((e=>{const t={...e};return t.username&&(t.username="true"),t.credential&&(t.credential="true"),t}));this.data.iceServers=JSON.stringify(t)}set fakeIceCandidate(e){this.data.fakeIceCandidate=e}set bweType(e){this.data.bweType=e}set sdpSemantics(e){this.data.sdpSemantics=e}set isCodecsSupported(e){this.data.codecSupport=e}set bundlePolicy(e){this.data.bundlePolicy=e}set latestRawReport(e){this.data.latestRawReport=e}set recvVideoStreamsCount(e){this.data.recvVideoStreamCount=e}set aggregatedStatsRef(e){this.data.aggregatedModalityStats=e}set multiViewStats(e){this.data.multiViewStats=e}set videoCapabilities(e){if(!e?.codecs)return;const t=[];e.codecs.forEach((e=>{if("h264"===e.mimeType&&e.sdpFmtpLine){const i=hM.exec(e.sdpFmtpLine)?.[1];i&&t.push(i)}})),this.data.H264Profiles=[...new Set(this.data.H264Profiles.concat(t))]}set sentBWSeed(e){var t;(t=this.data).initialBWSeed??(t.initialBWSeed=e),this.data.sentBWSeed=e}set reportedSendBandwidth(e){this.data.reportedSendBandwidth=e,(!this.data.reportedSendBandwidthMin||this.data.reportedSendBandwidthMin>e)&&(this.data.reportedSendBandwidthMin=e),(!this.data.reportedSendBandwidthMax||this.data.reportedSendBandwidthMax<e)&&(this.data.reportedSendBandwidthMax=e)}set maxSessionBandwidth(e){this.data.maxSessionBandwidth=e}set bwStabiliationTime(e){this.data.bwStabilizationTime=e}set bwDownlinkStabiliationTime(e){this.data.bwDownlinkStabilizationTime=e}set statsOnSubscribed(e){this.data.statsOnSubscribed=e}set loopIntervalMax(e){this.data.loopIntervalMax=e}set loopIntervalMedian(e){this.data.loopIntervalMedian=e}set fetchTimeMax(e){this.data.fetchTimeMax=e}set fetchTimeMedian(e){this.data.fetchTimeMedian=e}setTotalVideoRecvMblocksRates(e){this.data.totalVideoRecvMblocksRates=e}setCandidateDetails(e){"host"===e.type&&"udp"===e.protocol?(this.data.numInterfaces++,this.data.IPAddress||(this.data.IPAddress=e.ip)):"srflx"!==e.type||this.data.reflexiveLocalIP||(this.data.reflexiveLocalIP=e.ip)}setAudioSendStream(e,t){if(this.configProvider.config.useAudioAnalyzer){const i=new aM(e.rawStream);"ScreenShare"===t&&e.hasAudio()?(this.analyzerSharing?.dispose(),this.analyzerSharing=i):"Audio"===t&&(this.analyzer?.dispose(),this.analyzer=i)}}addNetworkInfo(e){At(this.data.networkInfo,e,this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples)}addIceCandidateError(e){this.data.iceCandidateErrors.push(e)}clearIceCandidateErrors(){this.data.iceCandidateErrors=[]}registerEarlyMediaPoll(){this.data.earlyMediaNumStatsPolls++}addReportedReceiveBandwidth(e){At(this.data.reportedReceiveBandwidth,e,this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples)}addOvcSubscriptionReport(e,t,i){const n=this.data.ovcToSubscriptionEvents[this.data.ovcToSubscriptionEvents.length-1];n?.ovc.count!==e&&At(this.data.ovcToSubscriptionEvents,{ovc:{ts:Date.now(),count:e,subsCount:t,...i},subs:[]},this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples)}addSubscriptionToOvcEvent(e){const t=this.data.ovcToSubscriptionEvents[this.data.ovcToSubscriptionEvents.length-1];t&&t.subs.push({ts:Date.now(),count:e})}addStatsReport(e){At(this.data.statsReports,e,this.configProvider.config.diagnostics.collectionLimits.numStatsReports)}addStatsError(e,t){const i=this.data.statsErrors.find((i=>i.error===t&&i.origin===e));i?i.count++:At(this.data.statsErrors,{origin:e,error:t,count:1},this.configProvider.config.diagnostics.collectionLimits.numStatsErrors),this.addSessionStatsError(`nativeSession:${e}`,t)}setPresentationAudioOnScreenSharing(e,t){this.presentationAudioTelemetry.updateScreenSharingStream(e,t)}handlePresentationAudioInputLevel(){this.presentationAudioTelemetry.handleInputLevel("Audio",this.audioLevel),this.presentationAudioTelemetry.handleInputLevel("ScreenShare",this.sharingAudioLevel)}terminate(){this.data.endTime=Date.now(),this.analyzer?.dispose(),this.analyzer=null,this.analyzerSharing?.dispose(),this.analyzerSharing=null}newQualityManagerDiagnostics(){const e=new rR(this.configProvider,((e,t)=>this.addStatsError(`qualityManagerDiagnostics:${e}`,t)));return this.data.qualityManager=e.getObjectRef(),e}newRemoteVideoManagerDiagnostics(){const e=new sR(this.configProvider);return this.data.remoteVideoManager=e.getObjectRef(),e}newSubscriptionManagerDiagnostics(){const e=new nR(this.configProvider,(e=>this.addStatsError("subscriptionManagerDiagnostics",e)));return this.data.subscriptionManager=e.getObjectRef(),e}set encodedStreamWorker(e){this.data.encodedStreamWorker=e}set audioCodecEvents(e){this.data.audioCodecEvents=e}getObjectRef(){return this.data}registerVideoPerformanceEvent(e,t){const i={type:t,perfEvent:e,resRequestEvent:null,resChangedEvent:[]};this.data.videoPerformanceEvent=this.data.videoPerformanceEvent.concat(i)}registerResolutionChanageRequest(e){const t=this.data.videoPerformanceEvent[this.data.videoPerformanceEvent.length-1];t&&(t.resRequestEvent=e)}registerResolutionChanageEvent(e){const t=this.data.videoPerformanceEvent[this.data.videoPerformanceEvent.length-1];e.ts-t?.resRequestEvent.ts<this.configProvider.config.diagnostics.performanceMonitoring.telemetryResolutionRequestSpanMs&&t.resChangedEvent.push(e)}};function pM(e){let t="";return e.dtls&&(t+="dtls"),e.sdes&&(t+="sdes"),t}var gM=Symbol("sessionDiagnosticsRef"),mM=class{constructor(e,t,i,n,r,s){this.logger=e,this.configProvider=t,this.diagnosticsReport=i,this.dmDiagnostics=n,this.dshDiagnostics=new iR,this.data={creationTime:Date.now(),callNumber:0,sessionId:"unknown",isMultiParty:!1,dtmfSuccessCount:0,dtmfFailureCount:0,iceInitTime:0,iceConnectedStateTime:0,negotiationCount:0,rejectedNegotiationCount:0,initialNegotiationCompleted:!1,finalAnswerTime:0,transportReconnectedCount:0,rollbackNegotiation:[],activeModalities:{},allowedAudioSend:!0,allowedVideoSend:!0,allowedScreensharingSend:!0,noIceCandidatesEventCount:{good:0,bad:0},noRelayIceCandidatesEventCount:{good:0,bad:0},microphoneInUseEventCount:{good:0,bad:0},cameraInUseEventCount:{good:0,bad:0},cameraFreezeEventCount:{start:0,end:0},rawMedia:{audio:{recv:{numAttempts:0,durationRatio:0},send:{numAttempts:0,durationRatio:0}}},ufds:[],statsErrors:[],webrtcSessions:[],isOngoing:!1,duration:0,callMutedRatio:0,callOsMuted:0,callHwSilent:0,callSwMuted:0,callIsMuted:!1,callSpeakerMuted:0,callIsSpeaking:0,networkRecvUFD:void 0,networkSendUFD:void 0,deviceManager:void 0,relayTimers:void 0,authTokenFetcherStats:void 0,dominantSpeaker:this.dshDiagnostics.getObjectRef(),[gM]:this},this.transportDisconnected=!1,this.commonMuteTracker=new SM,this.swMuteTracker=new SM,this.osMuteTracker=new SM,this.speakerMuteTracker=new SM,this.hwSilentTracker=new SM,this.isSpeakingTracker=new SM,this.networkRecv=new vM,this.networkSend=new vM,this.rawMediaTimers={audio:{send:new SM,recv:new SM}},this.dmFragmenter=new fM(this.dmDiagnostics),this.durationTimer=new SM,this.data.callNumber=r,this.data.sessionId=s,this.durationTimer.start(),Rt(this.data,{isOngoing:()=>void 0===this.data.terminationTime,duration:()=>this.durationTimer.elapsed,callMutedRatio:()=>yM(this.commonMuteTracker.elapsed,this.data.duration),callOsMuted:()=>this.osMuteTracker.elapsed,callHwSilent:()=>this.hwSilentTracker.elapsed,callSwMuted:()=>this.swMuteTracker.elapsed,callIsMuted:()=>this.swMuteTracker.isRunning,callSpeakerMuted:()=>this.speakerMuteTracker.elapsed,callIsSpeaking:()=>this.isSpeakingTracker.elapsed,networkRecvUFD:()=>({good:this.networkRecv.getCount("Good"),poor:this.networkRecv.getCount("Poor"),bad:this.networkRecv.getCount("Bad"),goodRatio:yM(this.networkRecv.getElapsed("Good"),this.data.duration),poorRatio:yM(this.networkRecv.getElapsed("Poor"),this.data.duration),badRatio:yM(this.networkRecv.getElapsed("Bad"),this.data.duration)}),networkSendUFD:()=>({good:this.networkSend.getCount("Good"),poor:this.networkSend.getCount("Poor"),bad:this.networkSend.getCount("Bad"),goodRatio:yM(this.networkSend.getElapsed("Good"),this.data.duration),poorRatio:yM(this.networkSend.getElapsed("Poor"),this.data.duration),badRatio:yM(this.networkSend.getElapsed("Bad"),this.data.duration)}),deviceManager:()=>this.dmFragmenter.getFragment(this.dmDiagnostics),relayTimers:()=>this.relayManagerTimers?.getStats(),authTokenFetcherStats:()=>this.relayManagerTimers?.getAuthTokenStats()}),Rt(this.data.rawMedia.audio.recv,{durationRatio:()=>yM(this.rawMediaTimers.audio.recv.elapsed,this.data.duration)}),Rt(this.data.rawMedia.audio.send,{durationRatio:()=>yM(this.rawMediaTimers.audio.send.elapsed,this.data.duration)})}get telemetryReport(){const e={type:"WebRtcMediaStats",data:this.diagnosticsReport.getSessionTelemetry(this.data.sessionId)},t={};return nt(e.data,((e,i,n)=>{let r=0;Tg.test(e)?(r=13,t[i]="IPv4"):Eg.test(e)&&(r=4,t[i]="IPv6"),n[i]={type:r,value:e,__VALUE__:!0}})),e.data.metrics.piiFields={type:0,value:JSON.stringify(t),__VALUE__:!0},e}get mediaStatsReport(){return this.diagnosticsReport.getMediaSessionStats(this.data.sessionId)}get realtimeTelemetryReport(){return this.diagnosticsReport.getTeamsRealtimeTelemetry(this.data.sessionId)}get e2eDiagnostics(){return this.diagnosticsReport.getDiagnosticsForE2eTests(this.data.sessionId)}set relayManager(e){this.relayManagerTimers=e}set isMultiParty(e){this.data.isMultiParty=e}set mediaLegId(e){this.data.mediaLegId=e.process()}set ETag(e){this.data.ETag=e}set configIds(e){this.data.configIds=e}set reconnect(e){this.data.reconnect=e}set relay(e){this.data.relay={address:e.addresses.join(),expires:e.expires,realm:e.realm,credentials:!(!e.username||!e.password),ports:[e.udpPort?`udp:${e.udpPort}`:"",e.tcpPort?`tcp:${e.tcpPort}`:"",e.tlsPort?`tls:${e.tlsPort}`:""].join(","),fqdns:e.fqdns?e.fqdns.join():"none"}}set sessionError(e){this.data.error=e}set dtmfResult(e){e?this.data.dtmfSuccessCount++:this.data.dtmfFailureCount++}set swMute(e){e?this.swMuteTracker.start():this.swMuteTracker.stop(),this.updateCommonMute()}set speakerMute(e){e?this.speakerMuteTracker.start():this.speakerMuteTracker.stop()}set hwSilent(e){e?this.hwSilentTracker.start():this.hwSilentTracker.stop()}set isSpeaking(e){e?this.isSpeakingTracker.start():this.isSpeakingTracker.stop()}set iceInitTime(e){this.data.iceInitTime||(this.data.iceInitTime=e)}set finalAnswerTime(e){var t;(t=this.data).finalAnswerTime??(t.finalAnswerTime=e)}set iceConnectedStateTimestamp(e){this.data.iceConnectedStateTime||(this.data.iceConnectedStateTime=e)}set allowedModalities(e){this.data.allowedAudioSend=e.audio.some((e=>Ag(e))),this.data.allowedVideoSend=e.video.some((e=>Ag(e))),this.data.allowedScreensharingSend=e.sharing.some((e=>Ag(e)))}negotiationStart(e){var t;(t=this.data).initialNegotiationType??(t.initialNegotiationType=e),this.data.negotiationCount++}negotiationCompleted(e){this.data.initialNegotiationCompleted=!0,this.data.activeModalities=e,this.data.error=void 0}negotiationRejected(){this.data.rejectedNegotiationCount++}registerRollbackEvent(e){this.data.rollbackNegotiation.push({type:e.type,attempt:this.data.rollbackNegotiation.length+1,error:e.error})}registerRawMediaAccess(e,t,i){const n=this.data.rawMedia[e]?.[t];if(n){n.numAttempts++;const r=this.rawMediaTimers[e]?.[t];i?r?.start():r?.stop()}}registerQualityStateChangedEvent(e){switch(e.type){case"NoNetwork":"Good"===e.value?this.data.noIceCandidatesEventCount.good++:this.data.noIceCandidatesEventCount.bad++;break;case"NetworkRelaysNotReachable":"Good"===e.value?this.data.noRelayIceCandidatesEventCount.good++:this.data.noRelayIceCandidatesEventCount.bad++;break;case"DeviceCaptureNotFunctioning":"Good"===e.value?this.data.microphoneInUseEventCount.good++:this.data.microphoneInUseEventCount.bad++;break;case"VideoCapturerDeviceStartFailed":"Good"===e.value?this.data.cameraInUseEventCount.good++:this.data.cameraInUseEventCount.bad++;break;case"DeviceCaptureMute":"Bad"===e.value?this.osMuteTracker.start():this.osMuteTracker.stop(),this.updateCommonMute();break;case"NetworkRecvQuality":this.networkRecv.updateLevel(e.value);break;case"NetworkSendQuality":this.networkSend.updateLevel(e.value);break;case"VideoCaptureDeviceFreeze":"Good"===e.value?this.data.cameraFreezeEventCount.end++:this.data.cameraFreezeEventCount.start++}"DeviceSpeakWhileMuted"!==e.type&&At(this.data.ufds,{...e,timestamp:Date.now()},this.configProvider.config.diagnostics.collectionLimits.numUFDs)}registerTransportConnected(){this.transportDisconnected&&(this.transportDisconnected=!1,this.data.transportReconnectedCount++)}registerTransportDisconnected(){this.transportDisconnected=!0}registerTransportFailed(){this.transportDisconnected=!1}terminated(e){this.data.terminationReason=ut(e),this.data.terminationTime=Date.now(),this.durationTimer.stop(),this.swMuteTracker.stop(),this.speakerMuteTracker.stop(),this.hwSilentTracker.stop(),this.isSpeakingTracker.stop(),this.dmFragmenter.terminated(this.dmDiagnostics)}addStatsError(e,t){const i=this.data.statsErrors.find((i=>i.error===t&&i.origin===e));this.logger.safe.error(`Stats error from '${e}': ${t} (${i?.count??1})`),i?i.count++:At(this.data.statsErrors,{origin:e,error:t,count:1},this.configProvider.config.diagnostics.collectionLimits.numStatsErrors)}newNativeSessionDiag(e=!0){let t;return t=new uM(this.configProvider,this.dmDiagnostics,((e,t)=>this.addStatsError(e,t)),(e=>this.newNativeSessionDiag(e)),(()=>this.pushNativeSessionDiag(t.getObjectRef())),this.dshDiagnostics.resetState(),(()=>this.getObjectRef())),e&&At(this.data.webrtcSessions,t.getObjectRef(),this.configProvider.config.diagnostics.collectionLimits.numNativeSessions),t}pushNativeSessionDiag(e){At(this.data.webrtcSessions,e,this.configProvider.config.diagnostics.collectionLimits.numNativeSessions)}getObjectRef(){return this.data}updateCommonMute(){this.swMuteTracker.isRunning||this.osMuteTracker.isRunning?this.commonMuteTracker.start():this.swMuteTracker.isRunning||this.osMuteTracker.isRunning||this.commonMuteTracker.stop()}},fM=class{constructor(e){this.fragmentBase=this.sanitizeDiagnostics(e)}getFragment(e){const t=this.fragmentTerminated??e;return{devicesChangeCount:t.devicesChangeCount-this.fragmentBase.devicesChangeCount,deviceSelectionChangeCount:t.deviceSelectionChangeCount-this.fragmentBase.deviceSelectionChangeCount,deviceSelectionChangeCountFromInterface:t.deviceSelectionChangeCountFromInterface-this.fragmentBase.deviceSelectionChangeCountFromInterface,devicesPollChangeCount:t.devicesPollChangeCount-this.fragmentBase.devicesPollChangeCount}}terminated(e){this.fragmentTerminated=this.sanitizeDiagnostics(e)}sanitizeDiagnostics(e){return{devicesChangeCount:e.devicesChangeCount,deviceSelectionChangeCount:e.deviceSelectionChangeCount,deviceSelectionChangeCountFromInterface:e.deviceSelectionChangeCountFromInterface,devicesPollChangeCount:e.devicesPollChangeCount}}},SM=class{constructor(){this.startTime=0,this.elapsedInternal=0,this.countInternal=0}get isRunning(){return!!this.startTime}get elapsed(){return Math.round(this.startTime?this.elapsedInternal+kt()-this.startTime:this.elapsedInternal)}get count(){return this.countInternal}start(){this.startTime||(this.startTime=kt(),this.countInternal++)}stop(){this.startTime&&(this.elapsedInternal+=kt()-this.startTime,this.startTime=0)}},vM=class{constructor(){this.currentLevel="Good",this.stopWatches={},this.getStopWatch(this.currentLevel).start()}updateLevel(e){this.currentLevel!==e&&(this.getStopWatch(this.currentLevel).stop(),this.currentLevel=e,this.getStopWatch(this.currentLevel).start())}getCount(e){const t=this.stopWatches[e];return t?t.count:0}getElapsed(e){const t=this.stopWatches[e];return t?t.elapsed:0}getStopWatch(e){let t=this.stopWatches[e];return t||(t=new SM,this.stopWatches[e]=t),t}};function yM(e,t){return e/(0!==t?t:1)}function CM(e,t,i){return pt({recv:pt({id:t?.inboundRTP.id,ssrc:t?.inboundRTP.ssrc,mediaType:t?.inboundRTP.mediaType??t?.inboundRTP.kind,bytesReceived:Ft(e.audio?.recv,(e=>e.inboundRTP.bytesReceived)),packetsReceived:Ft(e.audio?.recv,(e=>e.inboundRTP.packetsReceived)),packetsLost:Ft(e.audio?.recv,(e=>e.inboundRTP.packetsLost)),googCodecName:t?.codec?.mimeType.split("/")[1],googTrackId:t?.track?.trackIdentifier,transport_id:t?.transport?.id,transportId:t?.inboundRTP.transportId,transport_selectedCandidatePairId:t?.transport?.selectedCandidatePairId,transport_dtlsCipher:t?.transport?.dtlsCipher,transport_srtpCipher:t?.transport?.srtpCipher,pair_id:t?.transport?.selectedCandidatePair?.id,pair_responsesSent:Ft(e.audio?.recv,(e=>e.transport?.selectedCandidatePair?.responsesSent)),pair_requestsReceived:Ft(e.audio?.recv,(e=>e.transport?.selectedCandidatePair?.requestsReceived)),pair_googRemoteCandidateType:t?.transport?.selectedCandidatePair?.remoteCandidate?.candidateType,pair_consentRequestsSent:Ft(e.audio?.recv,(e=>e.transport?.selectedCandidatePair?.consentRequestsSent)),pair_googTransportType:t?.transport?.selectedCandidatePair?.localCandidate?.protocol,pair_googLocalCandidateType:t?.transport?.selectedCandidatePair?.localCandidate?.candidateType,pair_googWritable:t?.transport?.selectedCandidatePair?.writable,pair_requestsSent:Ft(e.audio?.recv,(e=>e.transport?.selectedCandidatePair?.requestsSent)),pair_googRtt:Ft(e.audio?.recv,(e=>1e3*e.transport?.selectedCandidatePair?.currentRoundTripTime),!0),pair_googActiveConnection:t?.transport?.selectedCandidatePair?.nominated,pair_packetsDiscardedOnSend:t?.transport?.selectedCandidatePair?.packetsDiscardedOnSend,pair_bytesReceived:Ft(e.audio?.recv,(e=>e.transport?.selectedCandidatePair?.bytesReceived)),pair_responsesReceived:Ft(e.audio?.recv,(e=>e.transport?.selectedCandidatePair?.responsesReceived)),pair_remoteCandidateId:t?.transport?.selectedCandidatePair?.remoteCandidate?.id,pair_localCandidateId:t?.transport?.selectedCandidatePair?.localCandidate?.id,pair_packetsSent:Ft(e.audio?.recv,(e=>e.transport?.selectedCandidatePair?.packetsSent)),pair_googLocalAddress:t?.transport?.selectedCandidatePair?.localCandidate?.ip??t?.transport?.selectedCandidatePair?.localCandidate?.address,pair_googRemoteAddress:t?.transport?.selectedCandidatePair?.remoteCandidate?.ip??t?.transport?.selectedCandidatePair?.remoteCandidate?.address,pair_bytesSent:Ft(e.audio?.recv,(e=>e.transport?.selectedCandidatePair?.bytesSent)),pair_googReadable:t?.transport?.selectedCandidatePair?.nominated}),send:pt({id:i?.outboundRTP.id,ssrc:i?.outboundRTP.ssrc,mediaType:i?.outboundRTP.mediaType??i?.outboundRTP.kind,bytesSent:Ft(e.audio?.send,(e=>e.outboundRTP.bytesSent)),packetsSent:Ft(e.audio?.send,(e=>e.outboundRTP.packetsSent)),packetsLost:Ft(e.audio?.send,(e=>e.remoteInboundRTP?.packetsLost)),googCodecName:i?.codec?.mimeType.split("/")[1],googTrackId:i?.track?.trackIdentifier,transport_id:i?.transport?.id,transportId:i?.outboundRTP.transportId,transport_selectedCandidatePairId:i?.transport?.selectedCandidatePairId,transport_dtlsCipher:i?.transport?.dtlsCipher,transport_srtpCipher:i?.transport?.srtpCipher,pair_id:i?.transport?.selectedCandidatePair?.id,pair_responsesSent:Ft(e.audio?.send,(e=>e.transport?.selectedCandidatePair?.responsesSent)),pair_requestsReceived:Ft(e.audio?.send,(e=>e.transport?.selectedCandidatePair?.requestsReceived)),pair_googRemoteCandidateType:i?.transport?.selectedCandidatePair?.remoteCandidate?.candidateType,pair_consentRequestsSent:Ft(e.audio?.send,(e=>e.transport?.selectedCandidatePair?.consentRequestsSent)),pair_googTransportType:i?.transport?.selectedCandidatePair?.localCandidate?.protocol,pair_googLocalCandidateType:i?.transport?.selectedCandidatePair?.localCandidate?.candidateType,pair_googWritable:i?.transport?.selectedCandidatePair?.writable,pair_requestsSent:Ft(e.audio?.send,(e=>e.transport?.selectedCandidatePair?.requestsSent)),pair_googRtt:Ft(e.audio?.send,(e=>1e3*e.transport?.selectedCandidatePair?.currentRoundTripTime),!0),pair_googActiveConnection:i?.transport?.selectedCandidatePair?.nominated,pair_packetsDiscardedOnSend:i?.transport?.selectedCandidatePair?.packetsDiscardedOnSend,pair_bytesReceived:Ft(e.audio?.send,(e=>e.transport?.selectedCandidatePair?.bytesReceived)),pair_responsesReceived:Ft(e.audio?.send,(e=>e.transport?.selectedCandidatePair?.responsesReceived)),pair_remoteCandidateId:i?.transport?.selectedCandidatePair?.remoteCandidate?.id,pair_localCandidateId:i?.transport?.selectedCandidatePair?.localCandidate?.id,pair_packetsSent:Ft(e.audio?.send,(e=>e.transport?.selectedCandidatePair?.packetsSent)),pair_googLocalAddress:i?.transport?.selectedCandidatePair?.localCandidate?.ip??i?.transport?.selectedCandidatePair?.localCandidate?.address,pair_googRemoteAddress:i?.transport?.selectedCandidatePair?.remoteCandidate?.ip??i?.transport?.selectedCandidatePair?.remoteCandidate?.address,pair_bytesSent:Ft(e.audio?.send,(e=>e.transport?.selectedCandidatePair?.bytesSent)),pair_googReadable:i?.transport?.selectedCandidatePair?.nominated})})}function TM(e,t,i,n){return pt({recv:pt({id:i?.inboundRTP.id,ssrc:i?.inboundRTP.ssrc,mediaType:i?.inboundRTP.mediaType??i?.inboundRTP.kind,bytesReceived:Ft(t[e]?.recv,(e=>e.inboundRTP.bytesReceived)),packetsReceived:Ft(t[e]?.recv,(e=>e.inboundRTP.packetsReceived)),packetsLost:Ft(t[e]?.recv,(e=>e.inboundRTP.packetsLost)),googCodecName:i?.codec?.mimeType.split("/")[1],codecImplementationName:i?.inboundRTP.decoderImplementation,googTrackId:i?.track?.trackIdentifier,transport_id:i?.transport?.id,transportId:i?.inboundRTP.transportId,transport_selectedCandidatePairId:i?.transport?.selectedCandidatePairId,transport_dtlsCipher:i?.transport?.dtlsCipher,transport_srtpCipher:i?.transport?.srtpCipher,pair_id:i?.transport?.selectedCandidatePair?.id,pair_responsesSent:Ft(t[e]?.recv,(e=>e.transport?.selectedCandidatePair?.responsesSent)),pair_requestsReceived:Ft(t[e]?.recv,(e=>e.transport?.selectedCandidatePair?.requestsReceived)),pair_googRemoteCandidateType:i?.transport?.selectedCandidatePair?.remoteCandidate?.candidateType,pair_consentRequestsSent:Ft(t[e]?.recv,(e=>e.transport?.selectedCandidatePair?.consentRequestsSent)),pair_googTransportType:i?.transport?.selectedCandidatePair?.localCandidate?.protocol,pair_googLocalCandidateType:i?.transport?.selectedCandidatePair?.localCandidate?.candidateType,pair_googWritable:i?.transport?.selectedCandidatePair?.writable,pair_requestsSent:Ft(t[e]?.recv,(e=>e.transport?.selectedCandidatePair?.requestsSent)),pair_googRtt:Ft(t[e]?.recv,(e=>1e3*e.transport?.selectedCandidatePair?.currentRoundTripTime),!0),pair_googActiveConnection:i?.transport?.selectedCandidatePair?.nominated,pair_packetsDiscardedOnSend:i?.transport?.selectedCandidatePair?.packetsDiscardedOnSend,pair_bytesReceived:Ft(t[e]?.recv,(e=>e.transport?.selectedCandidatePair?.bytesReceived)),pair_responsesReceived:Ft(t[e]?.recv,(e=>e.transport?.selectedCandidatePair?.responsesReceived)),pair_remoteCandidateId:i?.transport?.selectedCandidatePair?.remoteCandidate?.id,pair_localCandidateId:i?.transport?.selectedCandidatePair?.localCandidate?.id,pair_packetsSent:Ft(t[e]?.recv,(e=>e.transport?.selectedCandidatePair?.packetsSent)),pair_googLocalAddress:i?.transport?.selectedCandidatePair?.localCandidate?.ip??i?.transport?.selectedCandidatePair?.localCandidate?.address,pair_googRemoteAddress:i?.transport?.selectedCandidatePair?.remoteCandidate?.ip??i?.transport?.selectedCandidatePair?.remoteCandidate?.address,pair_bytesSent:Ft(t[e]?.recv,(e=>e.transport?.selectedCandidatePair?.bytesSent)),pair_googReadable:i?.transport?.selectedCandidatePair?.nominated,framesDecoded:Ft(t[e]?.recv,(e=>e.inboundRTP.framesDecoded)),googFrameHeightReceived:Ft(t[e]?.recv,(e=>e.inboundRTP.frameHeight)),googFrameWidthReceived:Ft(t[e]?.recv,(e=>e.inboundRTP.frameWidth)),googFrameRateReceived:Ft(t[e]?.recv,(e=>e.extensions?.frameRateReceived||0)),googNacksSent:Ft(t[e]?.recv,(e=>e.inboundRTP.nackCount)),googPlisSent:Ft(t[e]?.recv,(e=>e.inboundRTP.pliCount)),keyFramesDecoded:Ft(t[e]?.recv,(e=>e.inboundRTP.keyFramesDecoded)),googFirsSent:Ft(t[e]?.recv,(e=>e.inboundRTP.firCount)),googJitterBufferMs:Ft(t[e]?.recv,(e=>e.extensions?.jitterBufferMs)),googFrameRateDecoded:Ft(t[e]?.recv,(e=>e.extensions?.frameRateDecoded||0)),googFrameRateOutput:i?.extensions?.trackRecvFps,jitter:i?.inboundRTP.jitter}),send:pt({id:n?.outboundRTP.id,ssrc:n?.outboundRTP.ssrc,mediaType:n?.outboundRTP.mediaType??n?.outboundRTP.kind,bytesSent:Ft(t[e]?.send,(e=>e.outboundRTP.bytesSent)),packetsSent:Ft(t[e]?.send,(e=>e.outboundRTP.packetsSent)),packetsLost:Ft(t[e]?.send,(e=>e.remoteInboundRTP?.packetsLost)),googCodecName:n?.codec?.mimeType.split("/")[1],codecImplementationName:n?.outboundRTP.encoderImplementation,googTrackId:n?.track?.trackIdentifier,transport_id:n?.transport?.id,transportId:n?.outboundRTP.transportId,transport_selectedCandidatePairId:n?.transport?.selectedCandidatePairId,transport_dtlsCipher:n?.transport?.dtlsCipher,transport_srtpCipher:n?.transport?.srtpCipher,pair_id:n?.transport?.selectedCandidatePair?.id,pair_responsesSent:Ft(t[e]?.send,(e=>e.transport?.selectedCandidatePair?.responsesSent)),pair_requestsReceived:Ft(t[e]?.send,(e=>e.transport?.selectedCandidatePair?.requestsReceived)),pair_googRemoteCandidateType:n?.transport?.selectedCandidatePair?.remoteCandidate?.candidateType,pair_consentRequestsSent:Ft(t[e]?.send,(e=>e.transport?.selectedCandidatePair?.consentRequestsSent)),pair_googTransportType:n?.transport?.selectedCandidatePair?.localCandidate?.protocol,pair_googLocalCandidateType:n?.transport?.selectedCandidatePair?.localCandidate?.candidateType,pair_googWritable:n?.transport?.selectedCandidatePair?.writable,pair_requestsSent:Ft(t[e]?.send,(e=>e.transport?.selectedCandidatePair?.requestsSent)),pair_googRtt:Ft(t[e]?.send,(e=>1e3*e.transport?.selectedCandidatePair?.currentRoundTripTime),!0),pair_googActiveConnection:n?.transport?.selectedCandidatePair?.nominated,pair_packetsDiscardedOnSend:n?.transport?.selectedCandidatePair?.packetsDiscardedOnSend,pair_bytesReceived:Ft(t[e]?.send,(e=>e.transport?.selectedCandidatePair?.bytesReceived)),pair_responsesReceived:Ft(t[e]?.send,(e=>e.transport?.selectedCandidatePair?.responsesReceived)),pair_remoteCandidateId:n?.transport?.selectedCandidatePair?.remoteCandidate?.id,pair_localCandidateId:n?.transport?.selectedCandidatePair?.localCandidate?.id,pair_packetsSent:Ft(t[e]?.send,(e=>e.transport?.selectedCandidatePair?.packetsSent)),pair_googLocalAddress:n?.transport?.selectedCandidatePair?.localCandidate?.ip??n?.transport?.selectedCandidatePair?.localCandidate?.address,pair_googRemoteAddress:n?.transport?.selectedCandidatePair?.remoteCandidate?.ip??n?.transport?.selectedCandidatePair?.remoteCandidate?.address,pair_bytesSent:Ft(t[e]?.send,(e=>e.transport?.selectedCandidatePair?.bytesSent)),pair_googReadable:n?.transport?.selectedCandidatePair?.nominated,framesEncoded:Ft(t[e]?.send,(e=>e.outboundRTP.framesEncoded)),googNacksReceived:Ft(t[e]?.send,(e=>e.outboundRTP.nackCount)),googPlisReceived:Ft(t[e]?.send,(e=>e.outboundRTP.pliCount)),googFirsReceived:Ft(t[e]?.send,(e=>e.outboundRTP.firCount)),keyFramesEncoded:Ft(t[e]?.send,(e=>e.outboundRTP.keyFramesEncoded)),googFrameHeightInput:n?.mediaSource?.height,googFrameWidthInput:n?.mediaSource?.width,googFrameRateInput:Ft(t[e]?.send,(e=>e.mediaSource?.framesPerSecond)),googFrameHeightSent:Ft(t[e]?.send,(e=>e.outboundRTP.frameHeight)),googFrameWidthSent:Ft(t[e]?.send,(e=>e.outboundRTP.frameWidth)),googFrameRateSent:Ft(t[e]?.send,(e=>e.extensions?.frameRateSent)),googRtt:Ft(t[e]?.send,(e=>1e3*(e.remoteInboundRTP?.roundTripTime??0)),!0),hugeFramesSent:n?.outboundRTP.hugeFramesSent,qpSum:Ft(t[e]?.send,(e=>e.outboundRTP.qpSum)),qualityLimitationDurations:n?JSON.stringify(n?.outboundRTP.qualityLimitationDurations):void 0,qualityLimitationReason:n?.outboundRTP.qualityLimitationReason,qualityLimitationResolutionChanges:n?.outboundRTP.qualityLimitationResolutionChanges,jitter:n?.remoteInboundRTP?.jitter})})}function EM(e){return e?.substring(e.indexOf("/")+1).toUpperCase()}var _M=e=>pt({id:e.outboundRTP.ssrc.toString(),codecName:EM(e.codec?.mimeType),bitrate:e.extensions?.bitrate,jitter:e.remoteInboundRTP?.jitter,packets:e.outboundRTP.packetsSent,packetsPerSecond:e.extensions?.packetsPerSecond,packetsLost:e.remoteInboundRTP?.packetsLost,packetsLostPerSecond:e.extensions?.packetsLostPerSecond,rtt:e.remoteInboundRTP?.roundTripTime,frameRateInput:e.mediaSource?.framesPerSecond,frameWidthInput:e.mediaSource?.width,frameHeightInput:e.mediaSource?.height,framesEncoded:e.outboundRTP.framesEncoded,frameRateEncoded:e.extensions?.frameRateEncoded,framesSent:e.outboundRTP.framesSent,frameRateSent:e.extensions?.frameRateSent,frameWidthSent:e.outboundRTP.frameWidth,frameHeightSent:e.outboundRTP.frameHeight,keyFramesEncoded:e.outboundRTP.keyFramesEncoded,nackCount:e.outboundRTP.nackCount,firCount:e.outboundRTP.firCount,pliCount:e.outboundRTP.pliCount,transportId:e.outboundRTP.transportId,altLayouts:e.altLayouts?.map(_M)}),bM=e=>pt({id:e.inboundRTP.ssrc.toString(),codecName:EM(e.codec?.mimeType),bitrate:e.extensions?.bitrate,jitter:e.inboundRTP.jitter,packets:e.inboundRTP.packetsReceived,packetsPerSecond:e.extensions?.packetsPerSecond,packetsLost:e.inboundRTP.packetsLost,packetsLostPerSecond:e.extensions?.packetsLostPerSecond,packetsDiscarded:e.inboundRTP.packetsDiscarded,rtt:e.remoteOutboundRTP?.roundTripTime,msi:e.renderer?.msi,jitterBufferMs:e.extensions?.jitterBufferMs,frameRateOutput:e.extensions?.frameRateDecoded,frameRateDecoded:e.extensions?.frameRateDecoded,frameRateReceived:e.extensions?.frameRateReceived,frameWidthReceived:e.inboundRTP.frameWidth,frameHeightReceived:e.inboundRTP.frameHeight,longestFreezeDuration:e.extensions?.longestFreeze,totalFreezeDuration:e.extensions?.totalFreezeDuration,framesReceived:e.inboundRTP.framesReceived,framesDropped:e.inboundRTP.framesDropped,framesDecoded:e.inboundRTP.framesDecoded,keyFramesDecoded:e.inboundRTP.keyFramesDecoded,nackCount:e.inboundRTP.nackCount,firCount:e.inboundRTP.firCount,pliCount:e.inboundRTP.pliCount,transportId:e.inboundRTP.transportId}),PM=e=>pt({id:e.outboundRTP.ssrc.toString(),codecName:EM(e.codec?.mimeType),bitrate:e.extensions?.bitrate,jitter:e.remoteInboundRTP?.jitter,packets:e.outboundRTP.packetsSent,packetsPerSecond:e.extensions?.packetsPerSecond,packetsLost:e.remoteInboundRTP?.packetsLost,packetsLostPerSecond:e.extensions?.packetsLostPerSecond,packetsDiscarded:e.remoteInboundRTP?.packetsDiscarded,rtt:e.remoteInboundRTP?.roundTripTime,audioLevel:e.mediaSource?.audioLevel,transportId:e.outboundRTP.transportId}),IM=e=>pt({id:e.inboundRTP.ssrc.toString(),codecName:EM(e.codec?.mimeType),bitrate:e.extensions?.bitrate,jitter:e.inboundRTP.jitter,packets:e.inboundRTP.packetsReceived,packetsPerSecond:e.extensions?.packetsPerSecond,packetsLost:e.inboundRTP.packetsLost,packetsLostPerSecond:e.extensions?.packetsLostPerSecond,packetsDiscarded:e.inboundRTP.packetsDiscarded,rtt:e.remoteOutboundRTP?.roundTripTime,jitterBufferMs:e.extensions?.jitterBufferMs,audioLevel:e.inboundRTP.audioLevel,healedRatio:e.extensions?.healedRatio,transportId:e.inboundRTP.transportId}),AM=e=>pt({id:e.id,state:e.state,dataChannelIdentifier:e.dataChannelIdentifier,messagesSent:e.messagesSent,bytesSent:e.bytesSent,messagesReceived:e.messagesReceived,bytesReceived:e.bytesReceived,sendBitrate:e.extensions?.sendBitrate,recvBitrate:e.extensions?.recvBitrate,messagesSentPerSecond:e.extensions?.sendMessageRate,messagesReceivedPerSecond:e.extensions?.recvMessageRate}),RM=e=>pt({id:e.id,rtt:e.selectedCandidatePair?.currentRoundTripTime,availableIncomingBitrate:e.selectedCandidatePair?.availableIncomingBitrate,availableOutgoingBitrate:e.selectedCandidatePair?.availableOutgoingBitrate,relayProtocol:e.selectedCandidatePair?.localCandidate?.relayProtocol,candidateType:`${e.selectedCandidatePair?.localCandidate?.candidateType??""}:${e.selectedCandidatePair?.remoteCandidate?.candidateType??""}`});function wM(e){const t=function(e){return(e.audio?.send??[]).map(PM)}(e),i=function(e){return(e.audio?.recv??[]).map(IM)}(e),n=function(e){return e.video?.send?.length?e.video.send.map(_M):[]}(e),r=function(e){return(e.video?.recv??[]).map(bM)}(e),s=function(e){return e.sharing?.send?.length?e.sharing.send.map(_M):[]}(e),a=function(e){return(e.sharing?.recv??[]).map(bM)}(e),o=function(e){return(e.data??[]).map(AM)}(e),l=function(e){return Object.values(e.transports??{}).map(RM)}(e);return{audio:{send:t,recv:i},video:{send:n,recv:r},screenShare:{send:s,recv:a},data:o,transports:l}}function MM(e){return 1e4*e}function OM(e,t=Number(new Date)){if(!e)return;const i=ut(e);return e.lastMsgDate&&(e.timeSinceLastMsg=e.lastMsgDate-t),delete i.lastMsgDate,delete i.lastHistory,pt(i)}function DM(e,t,i=0){const n=t.filter((e=>void 0!==e));let r;switch(e){case"Difference":r=n[n.length-1]-n[0];break;case"Average":r=n.reduce(((e,t)=>e+t),0)/n.length;break;case"LastValue":r=n[n.length-1]}return r||0===r?`${"number"==typeof r?+r.toFixed(i):r}`:void 0}function kM(e,t,i){return(i?e.map((e=>e?.[t]?.[i])):e.map((e=>e?.[t]))).filter((e=>void 0!==e)).reduce(((e,t)=>e.concat(t)),[])}function NM(e){const t=e[e.length-1]?.extensions?.powerEfficient;return void 0===t?"":t?"hw":"sw"}function LM(e,t){return e&t?"Bidirectional":e?"ReceiveFromPeer":t?"SendToPeer":"Inactive"}function xM(e){const t=e[e.length-1]?.extensions?.callIsMuted,i=e[e.length-1]?.extensions?.rawInputVolume;return t?"0":!t&&i>0?"2":t||0!==i?void 0:"1"}function FM(e,t){const i=kM(e,"audio","send"),n=kM(e,"audio","recv"),r=function(e){const t=e.find((e=>e?.transports));return t?t.transports[Object.keys(t.transports)[0]]:void 0}(e);if(i.length||n.length)return pt({mediaType:"Audio",mediaDirection:LM(n.length,i.length),"Received BW estimate":DM("Average",n.map((e=>e?.transport?.selectedCandidatePair?.availableIncomingBitrate))),"Recv Loss Rate (Avg)":DM("LastValue",n.map((e=>e?.extensions?.lossRate/100)),3),"Rtp Packets Received":DM("Difference",n.map((e=>e?.inboundRTP.packetsReceived))),"Rtp Packet Sent":DM("Difference",i.map((e=>e?.outboundRTP.packetsSent))),"Sent BW estimate":DM("Average",i.map((e=>e?.transport?.selectedCandidatePair?.availableOutgoingBitrate))),"Send Audio Codec":DM("LastValue",i.map((e=>e?.codec?.mimeType)))?.split("/")[1],"Send RTT (Avg)":DM("LastValue",i.map((e=>e?.extensions?.rttAvg))),"Audio NW jitter avg":DM("LastValue",n.map((e=>e?.extensions?.jitterAvg)),3),"Audio send bps":DM("Average",i.map((e=>e?.extensions?.bitrate))),"JB delay (ms)":DM("LastValue",n.map((e=>e?.extensions?.jitterBufferDelayMs))),"Recv Audio Codec":DM("LastValue",n.map((e=>e?.codec?.mimeType)))?.split("/")[1],"Current Render Device Name":t?.speaker,"Current Capture Device Name":t?.microphone,"Latest Network Type":r?.selectedCandidatePair?.localCandidate?.networkType,"Latest Transport Protocol":r?.selectedCandidatePair?.localCandidate?.protocol,"Latest Reflexive Address":sm(r?.extensions?.reflexiveLocalIP),"Local Address":sm(r?.selectedCandidatePair?.localCandidate?.ip),"Local short-term Healed Data Ratio":DM("LastValue",n.map((e=>e?.extensions?.healedRatio))),"Send activity (0=muted; 1=inactive; 2=active)":xM(i)})}function UM(e,t){const i=DM("LastValue",e.map((e=>e?.codec?.mimeType)))?.split("/")[1],n=i?i+` ${NM(e)}`:void 0;return{"Rtp Packet Sent":DM("Difference",e.map((e=>e?.outboundRTP.packetsSent))),"Sent BW estimate":DM("Average",e.map((e=>e?.transport?.selectedCandidatePair?.availableOutgoingBitrate))),"Send Current Bitrate":DM("Average",e.map((e=>e?.extensions?.bitrate))),"Allocated Send Bandwidth Average":DM("LastValue",e.map((e=>e?.extensions?.bitrateAvg))),"Send Actual Height":DM("LastValue",e.map((e=>e?.outboundRTP.frameHeight))),"Send Actual Width":DM("LastValue",e.map((e=>e?.outboundRTP.frameWidth))),"Send Current Frame Rate":DM("Average",e.map((e=>e?.extensions?.frameRateSent))),"Send RTT (Avg)":DM("LastValue",e.map((e=>e?.extensions?.rttAvg))),"Sent Codec Name":n,"Webcam Freeze Intervals":DM("LastValue",e.map((e=>e?.extensions?.captureFreezeIntervalsCount))),"Current Capture Device Name":t?.camera,"Number of Sync Frame Request per Minute":DM("LastValue",e.map((e=>e?.extensions?.pliRate)))}}function VM(e){const t=DM("LastValue",e.map((e=>e?.mediaEntity?.xSourceStreamId))),i=DM("LastValue",e.map((e=>e?.codec?.mimeType)))?.split("/")[1],n=i?i+` ${NM(e)}`:void 0;return{"Recv Loss Rate (Avg)":DM("LastValue",e.map((e=>e?.extensions?.lossRate)),3),"Received BW estimate":DM("Average",e.map((e=>e?.transport?.selectedCandidatePair?.availableIncomingBitrate))),"Receive Current Bitrate":DM("Average",e.map((e=>e?.extensions?.bitrate))),"Rtp Packets Received":DM("Difference",e.map((e=>e?.inboundRTP.packetsReceived))),"Receive Actual Height":DM("LastValue",e.map((e=>e?.inboundRTP.frameHeight))),"Receive Actual Width":DM("LastValue",e.map((e=>e?.inboundRTP.frameWidth))),"Receive Current Frame Rate":DM("Average",e.map((e=>e?.extensions?.frameRateReceived))),"Received Codec Name":n,"Received Total Freeze Fraction (ms per min)":DM("LastValue",e.map((e=>e?.extensions?.totalFreezeFraction))),videoSourceId:t?parseInt(t):void 0,"Received Fps Time Weighted Harmonic Average":DM("LastValue",e.map((e=>e?.extensions?.fpsHarmonicAverage)))}}function HM(e,t,i){const n=FM(e,t);n&&i.channels.push(n);const r=function(e,t){const i=[],n=function(e){const t={},i=i=>{e.map((e=>e?.video?.[i])).forEach((e=>{e?.forEach((e=>{var n;const r=e?.mediaEntity?.remoteSsrc;t[r]??(t[r]={}),(n=t[r])[i]??(n[i]=[]),t[r][i].push(e)}))}))};return i("recv"),i("send"),t}(e);for(const{send:e,recv:r}of Object.values(n)){let n={mediaType:"Camera",mediaDirection:LM(r?.length,e?.length)};r&&(n={...n,...VM(r)}),e&&(n={...n,...UM(e,t)}),i.push(pt(n))}return i}(e,t);r.length&&i.channels.push(...r);const s=function(e){const t=kM(e,"sharing","send"),i=kM(e,"sharing","recv");if(!i.length&&!t.length)return;let n={mediaType:"AppSharing",mediaDirection:"Bidirectional","Render Device Name":""};return i.length&&(n={...n,...VM(i)}),t.length&&(n={...n,...UM(t,{microphone:void 0,camera:"Screen sharing",speaker:void 0})}),pt(n)}(e);s&&i.channels.push(s)}function BM(e,t,i,n,r){return pt({recv:pt({id:i?.inboundRTP.id,ssrc:i?.inboundRTP.ssrc,mediaType:i?.inboundRTP.mediaType??i?.inboundRTP.kind,bytes:Ut(t[e]?.recv,(e=>e.inboundRTP.bytesReceived),r),packets:Ut(t[e]?.recv,(e=>e.inboundRTP.packetsReceived),r),packetsLost:Ut(t[e]?.recv,(e=>e.inboundRTP.packetsLost),r),codec:i?.codec?.mimeType.split("/")[1],codecReport:i?.aggregated?.codecReport,framesDecoded:Ut(t[e]?.recv,(e=>e.inboundRTP.framesDecoded),r),height:Ut(t[e]?.recv,(e=>e.inboundRTP.frameHeight),r),width:Ut(t[e]?.recv,(e=>e.inboundRTP.frameWidth),r),frameRate:Ut(t[e]?.recv,(e=>e.extensions?.frameRateReceived),r)}),send:pt({id:n?.outboundRTP.id,ssrc:n?.outboundRTP.ssrc,mediaType:n?.outboundRTP.mediaType??n?.outboundRTP.kind,bytes:Ut(t[e]?.send,(e=>e.outboundRTP.bytesSent),r),packets:Ut(t[e]?.send,(e=>e.outboundRTP.packetsSent),r),packetsLost:Ut(t[e]?.send,(e=>e.remoteInboundRTP?.packetsLost),r),codec:n?.codec?.mimeType.split("/")[1],framesEncoded:Ut(t[e]?.send,(e=>e.outboundRTP.framesEncoded),r),heightInput:n?.mediaSource?.height,widthInput:n?.mediaSource?.width,height:Ut(t[e]?.send,(e=>e.outboundRTP.frameHeight),r),width:Ut(t[e]?.send,(e=>e.outboundRTP.frameWidth),r),frameRate:Ut(t[e]?.send,(e=>e.extensions?.frameRateSent),r)})})}function $M(e,t,i,n){const r=t?.codec?.mimeType.split("/");return pt({recv:pt({id:t?.inboundRTP.id,ssrc:t?.inboundRTP.ssrc,mediaType:t?.inboundRTP.mediaType??t?.inboundRTP.kind,bytes:Ut(e.audio?.recv,(e=>e.inboundRTP.bytesReceived),n),packets:Ut(e.audio?.recv,(e=>e.inboundRTP.packetsReceived),n),packetsLost:Ut(e.audio?.recv,(e=>e.inboundRTP.packetsLost),n),codec:r?.[r?.length-1],audioLevel:Ut(e.audio?.recv,(e=>Math.floor(65535*e.inboundRTP.audioLevel)),n)}),send:pt({id:i?.outboundRTP.id,ssrc:i?.outboundRTP.ssrc,mediaType:i?.outboundRTP.mediaType??i?.outboundRTP.kind,bytes:Ut(e.audio?.send,(e=>e.outboundRTP.bytesSent),n),packets:Ut(e.audio?.send,(e=>e.outboundRTP.packetsSent),n),packetsLost:Ut(e.audio?.send,(e=>e.remoteInboundRTP?.packetsLost),n),codec:i?.codec?.mimeType.split("/")[1],audioLevel:Ut(e.audio?.send,(e=>Math.floor(65535*e.aggregated.audioLevel)),n)})})}var jM=class{constructor(e,t){this.rootRef=e,this.configProvider=t}get rootCopy(){return ut(this.rootRef)}get rawRootRef(){return this.rootRef}getSessionTelemetry(e){const t=this.rootRef.sessions.find((t=>t.sessionId===e)),i={metrics:{},Extensions:{}};if(!t)return;const n=kt();try{const e=t.callNumber>1?this.rootRef.sessions.find((e=>t.callNumber-1===e.callNumber)):void 0,n=e?.terminationTime??0,r=t.webrtcSessions[t.webrtcSessions.length-1];i.metrics=function(e,t,i,n){const r=e.webrtcSessions[e.webrtcSessions.length-1];return pt({MediaLegId:e.mediaLegId,CreationTime:MM(e.creationTime),CallNumber:e.callNumber,SessionId:e.sessionId,MultiParty:e.isMultiParty,ErrorType:e.error?.type??"none",ErrorDetail:e.error?.detail??"none",IncompatibleOffer:e.error?.type===tt.MEDIA_ERROR.incompatibleOffer,TerminationTime:MM(e.terminationTime),TerminationReason_code:e.terminationReason?.code,TerminationReason_subCode:e.terminationReason?.subCode,TerminationReason_phrase:e.terminationReason?.phrase,TerminationReason_remoteTerminated:e.terminationReason?.remoteTerminated,TerminationReason_clientReasonPhrase:e.terminationReason?.clientReasonPhrase,TerminationReason_clientReasonSubCode:e.terminationReason?.clientReasonSubCode,CallDuration:MM(e.duration),IceInitTime:MM(e.iceInitTime),IceConnectedStateTime:MM(e.iceConnectedStateTime),NegotiationCount:e.negotiationCount,RejectedNegotiationCount:e.rejectedNegotiationCount,InitialNegotiationCompleted:e.initialNegotiationCompleted,InitialNegotiationType:e.initialNegotiationType,FinalAnswerTime:MM(e.finalAnswerTime),TransportReconnectedCount:e.transportReconnectedCount,RollbackNegotiation:JSON.stringify(e.rollbackNegotiation),Relay:e.relay?JSON.stringify(e.relay):void 0,ActiveModalities:JSON.stringify(e.activeModalities),AllowedAudioSend:e.allowedAudioSend,AllowedVideoSend:e.allowedVideoSend,AllowedScreensharingSend:e.allowedScreensharingSend,RelayManager:JSON.stringify(e.relayTimers),AuthTokenStats:JSON.stringify(e.authTokenFetcherStats),CallMutedRatio:MM(e.callMutedRatio),CallOsMuted:MM(e.callOsMuted),CallHwSilent:MM(e.callHwSilent),CallSwMuted:MM(e.callSwMuted),CallSpeakerMuted:MM(e.callSpeakerMuted),CallIsSpeaking:MM(e.callIsSpeaking),DtmfSuccess:e.dtmfSuccessCount,DtmfFailure:e.dtmfFailureCount,ReconnectInProgress:e.reconnect?.isReconnecting,RetargetIncomingCount:e.reconnect?.retargetCount.incoming,RetargetOutgoingCount:e.reconnect?.retargetCount.outgoing,RetargetCompletedCount:e.reconnect?.retargetCount.completed,RetargetRejectedCount:e.reconnect?.retargetCount.rejected,EscalationAttemptedCount:e.reconnect?.escalationCount.attempted,EscalationCompletedCount:e.reconnect?.escalationCount.completed,EscalationRejectedCount:e.reconnect?.escalationCount.rejected,ReconnectAttemptedCount:e.reconnect?.reconnectCount.attempted,ReconnectConnectedCount:e.reconnect?.reconnectCount.connected,ReconnectAttempts:JSON.stringify(Lt(It(e.reconnect?.records,n.config.diagnostics.telemetryLimits.numReconnects),"startTime",e.creationTime)),NetworkEvents:JSON.stringify(Lt(It(e.reconnect?.tmpRecords,n.config.diagnostics.telemetryLimits.numNetworkEvents),"startTime",e.creationTime)),NoIceCandidatesGoodEventCount:e.noIceCandidatesEventCount.good,NoIceCandidatesBadEventCount:e.noIceCandidatesEventCount.bad,NoRelayIceCandidatesGoodEventCount:e.noRelayIceCandidatesEventCount.good,NoRelayIceCandidatesBadEventCount:e.noRelayIceCandidatesEventCount.bad,MicrophoneInUseGoodEventCount:e.microphoneInUseEventCount.good,MicrophoneInUseBadEventCount:e.microphoneInUseEventCount.bad,CameraInUseGoodEventCount:e.cameraInUseEventCount.good,CameraInUseBadEventCount:e.cameraInUseEventCount.bad,CameraFreezeStartEventCount:e.cameraFreezeEventCount.start,CameraFreezeEndEventCount:e.cameraFreezeEventCount.end,NetworkRecvGood:e.networkRecvUFD.good,NetworkRecvGoodRatio:e.networkRecvUFD.goodRatio,NetworkRecvPoor:e.networkRecvUFD.poor,NetworkRecvPoorRatio:e.networkRecvUFD.poorRatio,NetworkRecvBad:e.networkRecvUFD.bad,NetworkRecvBadRatio:e.networkRecvUFD.badRatio,NetworkSendGood:e.networkSendUFD.good,NetworkSendGoodRatio:e.networkSendUFD.goodRatio,NetworkSendPoor:e.networkSendUFD.poor,NetworkSendPoorRatio:e.networkSendUFD.poorRatio,NetworkSendBad:e.networkSendUFD.bad,NetworkSendBadRatio:e.networkSendUFD.badRatio,Connection_Downlink:Ft(r.networkInfo,(e=>e.downlink)),Connection_EffectiveType:Ft(r.networkInfo,(e=>e.effectiveType)),Connection_Rtt:Ft(r.networkInfo,(e=>e.rtt)),Connection_SaveData:wt(r.networkInfo)?.saveData,RawOutputAudioAccessAttempted:e.rawMedia.audio.recv.numAttempts,RawOutputAudioAccessDurationRatio:e.rawMedia.audio.recv.durationRatio,RawInputAudioOverrideAttempted:e.rawMedia.audio.send.numAttempts,RawInputAudioOverrideDurationRatio:e.rawMedia.audio.send.durationRatio,UFDs:JSON.stringify(Lt(It(e.ufds,n.config.diagnostics.telemetryLimits.numUFDs),"timestamp",e.creationTime)),MediaQosEnabled:i.configuration.mediaConfig?.enableMediaQoS??!1,PortRangeConfigured:!!i.configuration.mediaConfig?.mediaPortRanges,hardwareConcurrency:i.configuration.userAgentConfig.hardwareConcurrency,ETag:e.ETag,ConfigIds:e.configIds,GPUName:i.configuration.userAgentConfig.unmaskedGlRenderer,PermissionStates:JSON.stringify(i.deviceManager.permissionStates),DeviceList:JSON.stringify(i.deviceManager.deviceList),DeviceListDebug:JSON.stringify(i.deviceManager.deviceDebugStrings),DevicesChangeCount:e.deviceManager.devicesChangeCount,DevicesPollChangeCount:e.deviceManager.devicesPollChangeCount,DeviceSelectionChangeCount:e.deviceManager.deviceSelectionChangeCount,DeviceSelectionChangeFromInterfaceCount:e.deviceManager.deviceSelectionChangeCountFromInterface,DevicesCount:JSON.stringify(i.deviceManager.devicesCount),UsedMicrophone:i.deviceManager.usedDevices?.microphone,UsedSpeaker:i.deviceManager.usedDevices?.speaker,UsedCamera:i.deviceManager.usedDevices?.camera,DeviceEvents:JSON.stringify(Lt(i.deviceManager.deviceTelemetryEvents.filter((e=>e.timestamp>t)),"timestamp",e.creationTime)),VideoEffects:JSON.stringify(Lt(i.deviceManager.videoEffectsEvents.filter((e=>e.timestamp>t)),"timestamp",e.creationTime)),AudioEffects:JSON.stringify(Lt(i.deviceManager.audioEffectsEvents.filter((e=>e.timestamp>t)),"timestamp",e.creationTime)),MediaByPassEnabled:!!i.configuration.mediaConfig.enableMediaBypass,CallConstraints:JSON.stringify(n.getCallConstraintsTelemetry()),DominantSpeaker:JSON.stringify(OM(e.dominantSpeaker,e.terminationTime))})}(t,n,this.rootRef,this.configProvider),i.Extensions=function(e,t,i){const n=e.aggregatedModalityStats,r=wt(n.audio?.recv),s=wt(n.audio?.send),a=wt(n.video?.recv),o=wt(n.video?.send),l=wt(n.sharing?.recv),d=wt(n.sharing?.send),c=i=>i&&It(ut(i).map((i=>Lt(It(i.events,t.config.diagnostics.telemetryLimits.numCapabilitiesApplied,1),"timestamp",e.startTime))),t.config.diagnostics.telemetryLimits.numCapabilitiesRequested),h=c(e.qualityManager?.videoMaxCapabilitiesEvents),u=c(e.qualityManager?.videoMaxCapabilitiesErrors),p=c(e.qualityManager?.sharingMaxCapabilitiesEvents),g=c(e.qualityManager?.sharingMaxCapabilitiesErrors),m="REMB"!==e.bweType?e.bandwidthReport:void 0,f="REMB"===e.bweType?e.bandwidthReport:void 0,S=[],v=[];return e.statsOnSubscribed.video?.forEach((e=>S.push(e))),e.statsOnSubscribed.sharing?.forEach((e=>v.push(e))),pt({BundlePolicy:e.bundlePolicy,FakeIceCandidate:e.fakeIceCandidate,H264_available_profiles:JSON.stringify(e.H264Profiles),IceConnectionState:e.iceConnectionState,IceConnectionStatePrevious:e.iceConnectionStatePrevious,IceServers:e.iceServers,IceTransportPolicy:e.iceTransportPolicy,NegotiatedSrtp:JSON.stringify(e.negotiatedSrtp),OfferedSrtp:JSON.stringify(e.offeredSrtp),RelayCandidate:e.relayCandidate,SdpSemantics:e.sdpSemantics,iceCandidateErrors:JSON.stringify(e.iceCandidateErrors),SignalingState:e.signalingState,SignalingStatePrevious:e.signalingStatePrevious,WebRTCStats_statsErrors:JSON.stringify(i),MaxSessionBandwidth:e.maxSessionBandwidth,Bandwidth_uplinkStabilizationTime:JSON.stringify(e.bwStabilizationTime),Bandwidth_downlinkStabilizationTime:JSON.stringify(e.bwDownlinkStabilizationTime),totalVideoControlMessages:e.qualityManager?.numVideoControlMessages,outOfOrderVideoControlMessages:e.qualityManager?.numOutOfOrderVideoControlMessages,webcamFreezeIntervals:e.qualityManager?.numWebcamFreezeIntervals,processedStreamFreezeIntervals:e.qualityManager?.numProcessedStreamFreezeIntervals,IPAddress:e.IPAddress??"none",ReflexiveLocalIP:e.reflexiveLocalIP??"none",NumberOfInterfaces:e.numInterfaces,StartTime:e.startTime,EndTime:e.endTime,AudioTransportRecvBitrate:r?.transport?.extensions?.recvBWAvg,AudioTransportSendBitrate:r?.transport?.extensions?.sendBWAvg,AudioPayloadRecvBitrate:r?.aggregated?.bitrateAvg,AudioPayloadSendBitrate:s?.aggregated?.bitrateAvg,VideoPayloadRecvBitrate:a?.aggregated?.bitrateAvg,VideoPayloadSendBitrate:o?.aggregated?.bitrateAvg,WebRTCStats_bweStat_googAvailableReceiveBandwidth:Ft(n.video?.recv,(e=>e.transport?.selectedCandidatePair?.availableIncomingBitrate))??Ft(n.video?.send,(e=>e.transport?.selectedCandidatePair?.availableIncomingBitrate)),WebRTCStats_bweStat_googAvailableSendBandwidth:Ft(n.video?.send,(e=>e.transport?.selectedCandidatePair?.availableOutgoingBitrate))??Ft(n.video?.recv,(e=>e.transport?.selectedCandidatePair?.availableOutgoingBitrate)),ReportedSendBWMax:e.reportedSendBandwidthMax,ReportedSendBWMin:e.reportedSendBandwidthMin,Bandwidth_jumpsHistogram:JSON.stringify(o?.transport?.extensions?.bwJumpsHistogram),StartCallBWESendSide:JSON.stringify(m?.startOfTheCall),EndCallBWESendSide:JSON.stringify(m?.endOfTheCall),BWEStdSendSide:JSON.stringify(m?.std),BwPercentilesSendSide:JSON.stringify(m?.bwPercentiles),AvgBwSendSide:JSON.stringify(m?.avgBwe),StartCallBWE:JSON.stringify(f?.startOfTheCall),EndCallBWE:JSON.stringify(f?.endOfTheCall),BWEStd:JSON.stringify(f?.std),BwPercentiles:JSON.stringify(f?.bwPercentiles),AvgBw:JSON.stringify(f?.avgBwe),WebRTCStats_ssrc:pt({audio:CM(n,r,s),video:TM("video",n,a,o),sharing:TM("sharing",n,l,d)}),Audio_recv_jitterBufferAvgSize:r?.aggregated?.avgJitterBufferSize,Audio_recv_packetsLostRateMax:r?.aggregated?.lossRateMax,Audio_recv_jitterAvg:r?.aggregated?.jitterAvg,Audio_recv_networkAvgLossRate:r?.aggregated?.networkAvgLossRate,Audio_send_rttAvg:s?.aggregated?.rttAvg&&bt(1e3*s.aggregated.rttAvg),Audio_send_rttMax:s?.aggregated?.rttMax&&bt(1e3*s.aggregated.rttMax),Audio_send_RawInputVolume:Ft(n.audio?.send,(e=>e.aggregated?.rawInputVolume)),Audio_send_packetsLostRateMax:s?.aggregated?.lossRateMax,Audio_send_presentationAPIUserDuration:e.presentationAPIUserDuration,Audio_send_presentationDuration:e.presentationAudioDuration,Video_recv_DurationSeconds:a?.aggregated?.duration,Video_recv_FreezeHistogram:JSON.stringify(a?.aggregated?.freezeCountHistogram),Video_recv_FreezeTimestamps:JSON.stringify(xt(a?.aggregated?.freezeTimestampsHistogram,e.startTime)),Video_recv_LongestFreezeDuration:a?.aggregated?.longestFreeze,Video_recv_OngoingFreeze:a?.extensions?.isFrozen,Video_recv_OngoingFreezeDuration:a?.aggregated?.ongoingFreezeDuration,Video_recv_TotalFreezeDuration:a?.aggregated?.totalFreezeDuration,Video_recv_RecvAvgFreezeDuration:a?.aggregated?.avgFreezeDuration,Video_recv_NumResolutionSwitches:a?.aggregated?.numResolutionSwitches,Video_recv_ResolutionDurations:JSON.stringify(a?.aggregated?.resolutionDurations),Video_recv_StreamsMax:e.recvVideoStreamCount.max,Video_recv_StreamsMin:e.recvVideoStreamCount.min,Video_recv_StreamsMode:e.recvVideoStreamCount.mode,Video_recv_TimeToFirstFrame:e.remoteVideoManager?.firstTimeToFirstFrameVideo,Video_recv_TimeToFirstFrameSinceSubscriptionStart:e.remoteVideoManager?.firstTimeToFirstFrameVideo,Video_recv_bitrateAvg:a?.aggregated?.bitrateAvg,Video_recv_bitrateMax:a?.aggregated?.bitrateMax,Video_recv_frameRateAvg:a?.aggregated?.avgFrameRate,Video_recv_jitterBufferAvgSize:a?.aggregated?.avgJitterBufferSize,Video_recv_packetsLostRateMax:a?.aggregated?.lossRateMax,Video_recv_isRenderingEvents:JSON.stringify(It(e.remoteVideoManager?.isRenderingEvents.video,t.config.diagnostics.telemetryLimits.numIsRenderingEvents)),Video_recv_FpsHarmonicAverage:a?.aggregated?.fpsHarmonicAverage,Video_recv_PreferredResolution:e.remoteVideoManager?.preferredResolution.video?.toString(),Video_recv_statsOnSubscribed:JSON.stringify(S),Video_SubscriptionEvents:JSON.stringify(Lt(e.subscriptionManager?.video.events,"ts",e.startTime)),Video_SubscriptionCounters:JSON.stringify(e.subscriptionManager?.video.counters),Video_send_CaptureFramerateAvg:o?.aggregated?.captureFramerateAvg,Video_send_DurationSeconds:o?.aggregated?.duration,Video_send_FreezeIntervals:o?.extensions?.captureFreezeIntervalsCount,Video_send_MaxCapabilities:JSON.stringify(h),Video_send_MaxCapabilitiesErrors:JSON.stringify(u),Video_send_OvershootDurations:JSON.stringify({fs:o?.aggregated?.totalFsOvershootDuration,fps:o?.aggregated?.totalFpsOvershootDuration,br:o?.aggregated?.totalBrOvershootDuration}),Video_send_OvershootEvents:JSON.stringify(Lt(o?.aggregated.overshootEvents,"timestamp",e.startTime)),Video_send_QpAvg:o?.aggregated?.qpAvg,Video_send_bitrateAvg:o?.aggregated?.bitrateAvg,Video_send_bitrateMax:o?.aggregated?.bitrateMax,Video_send_frameRateAvg:o?.aggregated?.frameRateAvg,Video_send_AllocateBWAvg:o?.aggregated?.bweAvg,Video_send_CameraOpenWidth:o?.extensions?.cameraOpenResolution?.width,Video_send_CameraOpenHeight:o?.extensions?.cameraOpenResolution?.height,Video_send_packetsLostRateMax:o?.aggregated?.lossRateMax,Video_send_resolutionSwitches:JSON.stringify(o?.aggregated?.resolutionSwitches),Sharing_recv_DurationSeconds:l?.aggregated?.duration,Sharing_recv_FreezeHistogram:JSON.stringify(l?.aggregated?.freezeCountHistogram),Sharing_recv_FreezeTimestamps:JSON.stringify(xt(l?.aggregated?.freezeTimestampsHistogram,e.startTime)),Sharing_recv_LongestFreezeDuration:l?.aggregated?.longestFreeze,Sharing_recv_OngoingFreeze:l?.extensions?.isFrozen,Sharing_recv_TotalFreezeDuration:l?.aggregated?.totalFreezeDuration,Sharing_recv_RecvAvgFreezeDuration:l?.aggregated?.avgFreezeDuration,Sharing_recv_NumResolutionSwitches:l?.aggregated?.numResolutionSwitches,Sharing_recv_ResolutionDurations:JSON.stringify(l?.aggregated?.resolutionDurations),Sharing_recv_StreamsMax:e.recvVideoStreamCount.max,Sharing_recv_StreamsMin:e.recvVideoStreamCount.min,Sharing_recv_StreamsMode:e.recvVideoStreamCount.mode,Sharing_recv_TimeToFirstFrame:e.remoteVideoManager?.firstTimeToFirstFrameSharing,Sharing_recv_TimeToFirstFrameSinceSubscriptionStart:e.remoteVideoManager?.firstTimeToFirstFrameVideo,Sharing_recv_bitrateAvg:l?.aggregated?.bitrateAvg,Sharing_recv_bitrateMax:l?.aggregated?.bitrateMax,Sharing_recv_frameRateAvg:l?.aggregated?.avgFrameRate,Sharing_recv_jitterBufferAvgSize:l?.aggregated?.avgJitterBufferSize,Sharing_recv_packetsLostRateMax:l?.aggregated?.lossRateMax,Sharing_recv_FpsHarmonicAverage:l?.aggregated?.fpsHarmonicAverage,Sharing_recv_isRenderingEvents:JSON.stringify(It(e.remoteVideoManager?.isRenderingEvents.sharing,t.config.diagnostics.telemetryLimits.numIsRenderingEvents)),Sharing_recv_PreferredResolution:e.remoteVideoManager?.preferredResolution.sharing?.toString(),Sharing_recv_statsOnSubscribed:JSON.stringify(v),Sharing_SubscriptionEvents:JSON.stringify(Lt(e.subscriptionManager?.sharing.events,"ts",e.startTime)),Sharing_SubscriptionCounters:JSON.stringify(e.subscriptionManager?.sharing.counters),Sharing_send_CaptureFramerateAvg:d?.aggregated?.captureFramerateAvg,Sharing_send_DurationSeconds:d?.aggregated?.duration,Sharing_send_MaxCapabilities:JSON.stringify(p),Sharing_send_MaxCapabilitiesErrors:JSON.stringify(g),Sharing_send_OvershootDurations:JSON.stringify({fs:d?.aggregated?.totalFsOvershootDuration,fps:d?.aggregated?.totalFpsOvershootDuration,br:d?.aggregated?.totalBrOvershootDuration}),Sharing_send_resolutionSwitches:d?.aggregated?.resolutionSwitches,Sharing_send_OvershootEvents:JSON.stringify(Lt(d?.aggregated.overshootEvents,"timestamp",e.startTime)),Sharing_send_QpAvg:d?.aggregated?.qpAvg,Sharing_send_bitrateAvg:d?.aggregated?.bitrateAvg,Sharing_send_bitrateMax:d?.aggregated?.bitrateMax,Sharing_send_frameRateAvg:d?.aggregated?.frameRateAvg,Sharing_send_AllocateBWAvg:d?.aggregated?.bweAvg,Sharing_send_packetsLostRateMax:d?.aggregated?.lossRateMax,multipleVideoStreams:JSON.stringify(Lt(e.multiViewStats,"startTime",e.startTime)),ReportedReceiveBandwidth:e.reportedReceiveBandwidth,OvcToSubscriptions:JSON.stringify(e.ovcToSubscriptionEvents),EncodedStreamWorker:e.encodedStreamWorker,AudioCodecEvents:JSON.stringify(e.audioCodecEvents),HevcCodecSupport:JSON.stringify(e?.codecSupport),CallSetupTimeTracker:JSON.stringify(e.timerTrackerReport),InitialBWSeed:e.initialBWSeed,SentBWSeed:e.sentBWSeed,videoPerformanceEvent:JSON.stringify(e.videoPerformanceEvent),EarlyMedia_NumStatsPolls:e.earlyMediaNumStatsPolls})}(r,this.configProvider,t.statsErrors)}catch(e){t[gM].addStatsError("DiagnosticsReport:getSessionTelemetry",Ge(e)),i.Extensions.WebRTCStats_statsErrors=JSON.stringify(t.statsErrors)}return i.metrics.ReportGenerationTimeMs=bt(kt()-n),i}getTeamsRealtimeTelemetry(e){const t=this.rootRef.sessions.find((t=>t.sessionId===e));if(t)try{const e=t.webrtcSessions[t.webrtcSessions.length-1],i=this.configProvider.config.diagnostics.teamsRealtimeTelemetry.pollingInterval;return function(e,t){const i=kM(e,"inactiveTracks"),n={channels:[]};return HM(e,t,n),i.length&&HM(i,void 0,n),n}(e.statsReports.slice(e.statsReports.length-i),this.rootRef.deviceManager.rawUsedDevices)}catch(e){throw t[gM].addStatsError("DiagnosticsReport:getRealTimeTelemetry",Ge(e)),e}}getMediaSessionStats(e){const t=this.rootRef.sessions.find((t=>t.sessionId===e));if(t)try{const e=t.callNumber>1?this.rootRef.sessions.find((e=>t.callNumber-1===e.callNumber)):void 0,i=e?.terminationTime??0,n=t.webrtcSessions[t.webrtcSessions.length-1],r=n?.statsReports.length?n.statsReports[n.statsReports.length-1]:void 0,s=r?wM(r):void 0;return s&&(s.extensions=function(e,t){const i=e.qualityManager&&It(ut(e.qualityManager.videoMaxCapabilitiesEvents).map((i=>Lt(It(i.events,t.config.diagnostics.telemetryLimits.numCapabilitiesApplied,1),"timestamp",e.startTime))),t.config.diagnostics.telemetryLimits.numCapabilitiesRequested),n=e.qualityManager&&It(ut(e.qualityManager.sharingMaxCapabilitiesEvents).map((i=>Lt(It(i.events,t.config.diagnostics.telemetryLimits.numCapabilitiesApplied,1),"timestamp",e.startTime))),t.config.diagnostics.telemetryLimits.numCapabilitiesRequested);return pt({Video_SubscriptionEvents:JSON.stringify(Lt(e.subscriptionManager?.video.events,"ts",e.startTime)),Sharing_SubscriptionEvents:JSON.stringify(Lt(e.subscriptionManager?.sharing.events,"ts",e.startTime)),Video_send_MaxCapabilities:JSON.stringify(i),Sharing_send_MaxCapabilities:JSON.stringify(n),RelayCandidate:e.relayCandidate,Video_recv_TimeToFirstFrame:e.remoteVideoManager?.firstTimeToFirstFrameVideo,Sharing_recv_TimeToFirstFrame:e.remoteVideoManager?.firstTimeToFirstFrameSharing,Video_recv_TimeToFirstFrameSinceSubscriptionStart:e.remoteVideoManager?.timeToFirstFrameSinceSubscriptionStartVideo,Sharing_recv_TimeToFirstFrameSinceSubscriptionStart:e.remoteVideoManager?.timeToFirstFrameSinceSubscriptionStartSharing})}(n,this.configProvider),s.metrics=function(e,t,i){return pt({DeviceEvents:JSON.stringify(Lt(i.deviceManager.deviceTelemetryEvents.filter((e=>e.timestamp>t)),"timestamp",e.creationTime)),IceConnectedStateTime:1e4*e.iceConnectedStateTime})}(t,i,this.rootRef)),s}catch(e){throw t[gM].addStatsError("DiagnosticsReport:getMediaSessionStats",Ge(e)),e}}getDiagnosticsForE2eTests(e){const t=this.rootRef.sessions.find((t=>t.sessionId===e));let i={};if(t){try{const e=t.webrtcSessions[t.webrtcSessions.length-1],n=t.callNumber>1?this.rootRef.sessions.find((e=>t.callNumber-1===e.callNumber)):void 0,r=n?.terminationTime??0;i=function(e,t,i,n,r){const s=e.aggregatedModalityStats,a=wt(s.audio?.recv),o=wt(s.audio?.send),l=wt(s.video?.recv),d=wt(s.video?.send),c=wt(s.sharing?.recv),h=wt(s.sharing?.send),u=[],p=[];return e.statsOnSubscribed.video?.forEach((e=>u.push(e))),e.statsOnSubscribed.sharing?.forEach((e=>p.push(e))),pt({multipleVideoStreams:e.multiViewStats,WebRTCStats_ssrc:pt({audio:$M(s,a,o,r),video:BM("video",s,l,d,r),sharing:BM("sharing",s,c,h,r)}),CallSwMuted:1e3*t.callSwMuted,DeviceEvents:Lt(i.deviceManager.deviceTelemetryEvents.filter((e=>e.timestamp>n)),"timestamp",t.creationTime),VideoEffects:Lt(i.deviceManager.videoEffectsEvents.filter((e=>e.timestamp>n)),"timestamp",t.creationTime)})}(e,t,this.rootRef,r,this.configProvider.config.diagnostics.collectionLimits.numSamplesForE2E)}catch(e){t[gM].addStatsError("DiagnosticsReport:getSessionTelemetry",Ge(e))}return i}}},GM=class{constructor(e,t){this.configProvider=e,this.deviceManagerDiagnostics=t,this.root={creationTime:Date.now(),numTotalSessions:0,deviceManager:this.deviceManagerDiagnostics.getObjectRef(),configuration:{stackConfig:this.configProvider.stackConfig,defaultConfig:this.configProvider.defaultConfig,mediaConfig:{},userAgentConfig:{isAudioOutputSelectionSupported:this.configProvider.userAgentConfig.isAudioOutputSelectionSupported,isBrowserRollbackSupported:this.configProvider.userAgentConfig.isBrowserRollbackSupported,hardwareConcurrency:this.configProvider.userAgentConfig.hardwareConcurrency,unmaskedGlRenderer:this.configProvider.userAgentConfig.unmaskedGlRenderer,hasMediaApi:Cg.hasMediaApi(),hasCapabilitiesApi:Cg.hasCapabilitiesApi(),hasUnifiedPlanSupport:void 0},consoleOverrides:this.configProvider.consoleOverrides,fullConfig:ut(this.configProvider.config),ecsConfigUpdates:[]},browserInfo:li(),sessions:[]},this.diagnosticsReport=new jM(this.root,this.configProvider),this.configProvider.on("newConfigReceived",((e,t,i)=>{this.root.configuration.ecsConfigUpdates.push({timestamp:Date.now(),etag:t,configIds:i,config:e})})),this.configProvider.on("configUpdated",(()=>{this.root.configuration.consoleOverrides=this.configProvider.consoleOverrides,this.root.configuration.fullConfig=ut(this.configProvider.config)}))}get reportGenerator(){return this.diagnosticsReport}get rootRef(){return this.root}set mediaConfig(e){this.root.configuration.mediaConfig=e}newSession(e,t,i){this.root.configuration.userAgentConfig.hasUnifiedPlanSupport=this.configProvider.mediaConfig.simulcastSessionEnabled;const n=new mM(i,e,this.diagnosticsReport,this.root.deviceManager,++this.root.numTotalSessions,t);return At(this.root.sessions,n.getObjectRef(),this.configProvider.config.diagnostics.collectionLimits.numSessions),n}},WM=class e{constructor(e,t){this.safe=e,this.unsafe=t,this.safe||(this.safe=this.unsafe)}warn(...e){this.unsafe.warn(...e)}error(...e){this.unsafe.error(...e)}debug(...e){this.unsafe.debug(...e)}info(...e){this.unsafe.info(...e)}createChild(t){return new e(this.safe.createChild(t),this.unsafe.createChild(t))}},qM=i(496486),zM=class{constructor(e){this.logger=e,this.extensionId="nkeimhogjdpnpccoofpliimaahmaaome",this.editorExtensionId="ncbjelpjchkpbikbpkcchkhkblodoama",this.logId="TeamsWebRTCLogs",this.loggingState="unknown",this.connectionCount=0,window.webRtcInternalsCollector=this}get isExtensionAvailable(){return"unavailable"!==this.loggingState}async updateSessionCount(e){this.isExtensionAvailable&&(0===this.connectionCount&&1===e?("stopped"===this.loggingState&&await this.discardLogs(),await this.initialStartLogging()):0===e&&await this.stopLogging(),this.connectionCount=e)}async collect(){return this.isExtensionAvailable?this.collectPromise?this.collectPromise:this.collectPromise=new Promise((async e=>{try{this.connectionCount>0&&(this.logger.safe.info(`Stopping logger for gathering, open connections: ${this.connectionCount}`),await this.stopLogging()),await this.storeLogs();const t=await this.gatherFromStorage();this.connectionCount>0&&await this.continueLogging(),e(t.length>0?t.join("\r\n"):"")}catch(t){this.logger.safe.error("Error while collecting logs",t),e(JSON.stringify(t))}this.collectPromise=void 0})):""}async initialStartLogging(){try{await this.startLogging()}catch(e){if(e?.includes("A log is already open"))try{const t=e.match(/State=(\w+)/);await this.cleanState(t?.[1]),await this.startLogging()}catch(e){this.logger.safe.error("Error while starting logging at cleanup phase",e),this.loggingState="unknown"}else this.logger.safe.error("Error while starting logging",e),this.loggingState="unavailable"}}async continueLogging(){try{await this.startLogging()}catch(e){this.logger.safe.error("Error while continuing logging",e),this.loggingState="stopped"}}async startLogging(){await this.sendMessage(this.extensionId,{method:"logging.start"}),this.logger.safe.info("Logging started"),this.loggingState="started"}async cleanState(e){try{if("started"===e)await this.stopLogging(),await this.discardLogs();else{if("stopped"!==e)throw new Error(`Unexpected logging state: ${e}`);await this.discardLogs()}}catch(e){this.logger.safe.error("Error while cleaning state",e)}}async stopLogging(){try{await this.sendMessage(this.extensionId,{method:"logging.stop"}),this.logger.safe.info("Logging stopped"),this.loggingState="stopped"}catch(e){this.logger.safe.error("Error while stopping logging",e)}}async discardLogs(){try{await this.sendMessage(this.extensionId,{method:"logging.discard"}),this.logger.safe.info("Logs discarded"),this.loggingState="closed"}catch(e){this.logger.safe.error("Error while discarding logs",e)}}async storeLogs(){try{await this.sendMessage(this.extensionId,{method:"logging.store",logId:this.logId}),this.logger.safe.info(`Logs stored to ${this.logId}`),this.loggingState="closed"}catch(e){this.logger.safe.error("Error while storing logs",e)}}async gatherFromStorage(){const e=[];let t={offset:0};do{t=await this.sendMessage(this.editorExtensionId,{api:"getWebRtcLog",logId:this.logId,offset:t.offset}),e.push(t.data),this.logger.safe.info(`Batch gathered with offset: ${t.offset}, moreData: ${t.moreData}`)}while(t.moreData);return this.logger.safe.info("Finished gathering"),e}sendMessage(e,t){return new Promise(((i,n)=>{const r=chrome.runtime;r.sendMessage(e,t,(e=>{if(!e||e?.error){const i=e?JSON.stringify(e.error):r.lastError;n(`sendMessage ${JSON.stringify(t)} failed with error: ${i}`)}i(e)}))}))}},KM=(()=>{let e;return{getInstance:function(t,i){return i?.config.enableWebRtcInternalsLogs&&"EdgeAnaheim"===li().name&&chrome?.runtime?(e||(e=new zM(t)),e):(t.safe.info("WebRTC internal logging is disabled"),{collect:()=>Promise.resolve(""),updateSessionCount:()=>Promise.resolve()})}}})(),JM=class{getId(){return 0}getDeviceId(){return tt.EMPTY_DEVICE_ID}getPreviewAsync(e,t){return Promise.resolve(null)}getDescription(){return"display"}getType(){return 1}getIcon(e,t){return Promise.resolve(null)}},YM=class{constructor(e){this.descr=e}getId(){return 0}getDeviceId(){return this.descr.browserId}getPreviewAsync(e,t){return Promise.resolve(null)}getDescription(){return this.descr.label}getType(){return 3}getIcon(e,t){return Promise.resolve(null)}},QM=class{constructor(e){this.deviceManager=e,this.sharingSource=new JM}onScreensChanged(e){return{dispose:()=>{}}}enumerateScreensAsync(){return Promise.resolve([this.sharingSource])}enumerateWindowsAsync(){return Promise.resolve([])}async enumerateCamerasAsync(){return(await this.deviceManager.enumerateDevicesAsync()).filter((e=>"camera"===e.kind)).map((e=>new YM(e)))}},XM=class{constructor(){this.data={records:[],tmpRecords:[],isReconnecting:!1,networkRecoveredCount:0,disconnectedRecoveredCount:0,reconnectCount:{attempted:0,connected:0},retargetCount:{incoming:0,outgoing:0,completed:0,rejected:0},escalationCount:{attempted:0,completed:0,rejected:0}}}registerState(e){const t="connected"===e?this.activeTmpRecord:this.getTmpRecord();t&&t.events[t.events.length-1]?.type!==e&&(t.events.push({type:e,time:Date.now()-t.startTime}),"networkOnline"===e?this.data.networkRecoveredCount++:"connected"===e&&this.data.disconnectedRecoveredCount++,"reconnect"!==e&&"connected"!==e||(t.endTime=Date.now()-t.startTime,this.activeTmpRecord=null))}registerReconnectAttempt(e){this.activeRecord&&(this.activeAttempt={direction:e,startTime:Date.now()-this.activeRecord.startTime,status:!1},this.data.isReconnecting=!0,this.activeRecord.attempts.push(this.activeAttempt))}registerReconnectAttemptStatus(e){"completed"===e&&(this.data.isReconnecting=!1),this.activeAttempt&&this.activeRecord&&(this.activeAttempt.endTime=Date.now()-this.activeRecord.startTime,this.activeAttempt.status="completed"===e)}registerReconnect(e){if(this.data.reconnectCount[e]++,this.data.isReconnecting="attempted"===e,"attempted"===e){if(this.activeRecord)return;this.activeRecord={startTime:Date.now(),attempts:[]},this.data.records.push(this.activeRecord)}else if("connected"===e){if(!this.activeRecord)return;this.activeTmpRecord&&this.registerState("connected"),this.activeRecord.endTime=Date.now()-this.activeRecord.startTime,this.activeRecord=void 0,this.activeAttempt=void 0}}registerRetarget(e){this.data.retargetCount[e]++}registerEscalation(e){this.data.escalationCount[e]++}getObject(){return this.data}getTmpRecord(){return(!this.activeTmpRecord||this.activeTmpRecord.endTime>0)&&(this.activeTmpRecord={startTime:Date.now(),events:[]},this.data.tmpRecords.push(this.activeTmpRecord)),this.activeTmpRecord}},ZM=class{constructor(){}process(e){return this.mediaLegId=e||this.mediaLegId||gt().toUpperCase(),this.mediaLegId}},eO=class{constructor(e,t){this.relayManager=e,this.diagnostics=t}initialize(){}setRelayOverride(){}async queryRelaysAsync(e){const t=await this.relayManager.queryRelaysAsync(e);return t.length>0&&(this.diagnostics.relay=t[0]),t}getStats(){return this.relayManager.getStats?.()??{unavailable:"1"}}getAuthTokenStats(){return this.relayManager.getAuthTokenStats()}},tO=class{constructor(e,t,i){this.stats=e,this.diag=t,i&&t&&(i.reconnect=t.getObject())}registerState(e){this.diag?.registerState(e)}registerReconnectAttempt(e){this.stats.registerReconnectAttempt(e),this.diag?.registerReconnectAttempt(e)}registerReconnectAttemptStatus(e){switch(e){case"completed":this.stats.registerReconnectAttemptCompleted();break;case"rejected":this.stats.registerReconnectAttemptRejected()}this.diag?.registerReconnectAttemptStatus(e)}registerReconnect(e){switch(e){case"attempted":this.stats.registerReconnectAttempted();break;case"connected":this.stats.registerReconnectConnected()}this.diag?.registerReconnect(e)}registerRetarget(e){switch(e){case"completed":this.stats.registerRetargetCompleted();break;case"rejected":this.stats.registerRetargetRejected();break;case"incoming":this.stats.registerRetargetIncoming();break;case"outgoing":this.stats.registerRetargetOutgoing()}this.diag?.registerRetarget(e)}registerEscalation(e){switch(e){case"attempted":this.stats.registerEscalationStart();break;case"completed":this.stats.registerEscalationCompleted();break;case"rejected":this.stats.registerEscalationRejected()}this.diag?.registerEscalation(e)}},iO=class{constructor(e){this.initialCallbacks=e,this.queueCallbacks={onTerminated:this.genCallback(this.initialCallbacks.onTerminated),onSessionErrorOccurred:this.genCallback(this.initialCallbacks.onSessionErrorOccurred),onNegotiationRequired:this.genCallback(this.initialCallbacks.onNegotiationRequired),onAudioStateChanged:this.genCallback(this.initialCallbacks.onAudioStateChanged),onAudioHwSilentChanged:this.genCallback(this.initialCallbacks.onAudioHwSilentChanged),onTransportDisconnected:this.genCallback(this.initialCallbacks.onTransportDisconnected),onTransportConnected:this.genCallback(this.initialCallbacks.onTransportConnected),onTransportInitialized:this.genCallback(this.initialCallbacks.onTransportInitialized),onTransportFailed:this.genCallback(this.initialCallbacks.onTransportFailed),onUpdateMediaDescriptionsRequired:this.genCallback(this.initialCallbacks.onUpdateMediaDescriptionsRequired),onTeamsRealtimeTelemetryReport:this.genCallback(this.initialCallbacks.onTeamsRealtimeTelemetryReport)},this.queue=[]}flush(){this.queue.forEach((e=>{e.method.apply(null,e.args)})),this.clear()}clear(){this.queue=[]}genCallback(e){return(...t)=>this.queue.push({method:e,args:t})}},nO=class{constructor(e,t){this.relayConfig=e,this.logger=t}async ensureOnline(){if(0===this.relayConfig.length)return this.logger.safe.warn("No TURN servers defined"),0;if(this.probeDeferred)return this.probeDeferred.promise;this.logger.safe.info(`Starting TURN probes with ${JSON.stringify(this.relayConfig[0].urls)}`),this.checkStart=Date.now();let e=0;this.probeDeferred=Ei();const t=async()=>{await this.performCheck()&&this.finalize()},i=()=>{t(),e<3e3&&(e+=1e3),this.probeTimer=setTimeout(i,e)};return i(),this.probeDeferred.promise}finalize(){this.probeTimer&&(clearTimeout(this.probeTimer),this.probeTimer=0),this.probeDeferred&&(this.probeDeferred.resolve(Date.now()-this.checkStart),this.probeDeferred=null)}dispose(){this.finalize()}async performCheck(){this.logger.safe.info("Probing...");const e=this.tryCreatePc();if(!e)return!1;e.createDataChannel("probe");const t=Ei();function i(i){e.onicecandidate=void 0,e.close(),t.resolve(i)}let n=!1;return e.onicecandidate=e=>{const t=e.candidate;if(!t)return n||this.logger.safe.info("still offline"),void i(n);const r=t.type??Ug(t.candidate).type;"srflx"!==r&&"relay"!==r||(this.logger.safe.info(`Back online through ${r} candidate`),n=!0,"srflx"===r&&(this.ipFromRelay=t.address,i(!0)))},await e.setLocalDescription(await e.createOffer()),t.promise}tryCreatePc(){try{return new yg.window.RTCPeerConnection({iceServers:this.relayConfig})}catch(e){return this.logger.safe.info(`Failed to create PC, errCode=${e.code}`),null}}},rO=(e,t)=>e.reduce(((e,i)=>{const n=[],r=i.addresses&&i.addresses[0],s=i.fqdns&&i.fqdns.length>0,a=t.iceUdpAddressType,o=t.iceTcpAddressType,l=t.iceServerTransport;if(!r&&!s)return e;if(l.includes("udp")&&i.udpPort){const e=!s||"fqdn"!==a&&r?r:i.fqdns[0];n.push(`turn:${e}:${i.udpPort}?transport=udp`)}if(l.includes("tcp")&&i.tcpPort){const e=!s||"fqdn"!==o&&r?r:i.fqdns[0];n.push(`turn:${e}:${i.tcpPort}?transport=tcp`)}return l.includes("tls")&&i.tlsPort&&s&&n.push(`turns:${i.fqdns[0]}:${i.tlsPort}`),e.concat({urls:n,credential:i.password,username:i.username})}),[]),sO=(e,t)=>e.reduce(((e,i)=>{const n=[],r=i.addresses&&i.addresses[0],s=i.fqdns&&i.fqdns.length>0,a=t.iceUdpAddressType,o=t.iceServerTransport;if(!r&&!s)return e;if(o.includes("udp")&&i.udpPort){const e=!s||"fqdn"!==a&&r?r:i.fqdns[0];n.push(`stun:${e}:${i.udpPort}`)}return o.includes("tls")&&i.tlsPort&&s&&n.push(`turns:${i.fqdns[0]}:${i.tlsPort}`),e.concat({urls:n,credential:i.password,username:i.username})}),[]),aO=class{constructor(e,t,i,n,r,s,a,o){this.session=e,this.context=t,this.diagnostics=i,this.sessionOperationQueue=n,this.callback=r,this.sessionCallbacks=s,this.configProvider=a,this.relayManager=o,this.wasConnected=!1,this.isDisconnected=!1,this.isReconnectConference=!1,this.escalationType=0,this._isSignalingStable=!0,this.reconnectDelayTime=0,this._isReconnectScheduled=!1,this.isDisposing=!1,this.isWaitingForNetwork=!1,this.onOnline=async()=>{this.logger.safe.info("onOnline: Network is up"),this.diagnostics.registerState("networkOnline"),this.isOnlineDeferred?.resolve(),this.isOnlineDeferred=null},this.onOffline=()=>{this.logger.safe.info("onOffline: Network is down"),this.diagnostics.registerState("networkOffline"),this.isOnlineDeferred=um()},this.logger=t.getLogger().createChild("ReconnectManagerV2"),this.ufdManager=t.getUfdManager(),this.session.callbacks=s,this.reconnectManagerMessageQueue=new iO(s),window.addEventListener("online",this.onOnline),window.addEventListener("offline",this.onOffline)}get isOnline(){return!this.isOnlineDeferred}async createRelayProber(){if(!this._relayProber){const e=Date.now(),t=sO(await this.relayManager.queryRelaysAsync({relayType:"turn"}),this.configProvider.config),i=Date.now()-e;this.logger.safe.info(`RelayProber configuration fetched in ${i} ms`),i>5e3&&this.diagnostics.registerState("relayConfigFetched"),this._relayProber=new nO(t,this.logger.createChild("RelayProber"))}return this._relayProber}dispose(){this.isDisposing=!0,window.removeEventListener("online",this.onOnline),window.removeEventListener("offline",this.onOffline),this._relayProber?.dispose(),this.isOnlineDeferred?.reject(new Error("dispose")),this.reconnectTimer&&this.resetReconnectTimer()}get settings(){return(this.reconnectSession||this.session).getSessionConfig().config}getCurrentSession(){return this.reconnectSession||this.session}getMainSession(){return this.session||this.reconnectSession}getReconnectSession(){return this.reconnectSession}async onIceDisconnect(e){if(this.wasConnected)this.raiseReconnectEvent("Bad",e);else if(!this.settings.reconnectWithNoRelays&&!this.session.hasRelayCandidates())return void this.onReconnectFailed("no relays",e);if(this.isDisconnected=!0,!this.isReconnecting()&&!this.isWaitingForNetwork)return this.logger.safe.info(`[${e}] reconnect attempt after iceDisconnect error`),this.session.isFailed()&&this.diagnostics.registerState("failed"),this.diagnostics.registerReconnect("attempted"),this.reconnectAsync(e)}onTransportDisconnect(e){this.isDisconnected=!0,this.wasConnected&&(this.diagnostics.registerState("disconnected"),this.handleTmpConnectivityLoss(e))}onConnected(e){this.isDisconnected=!1,this.logger.safe.info(`[${e}] set allow UFD`),this.diagnostics.registerState("connected"),this.raiseReconnectEvent("Good",e),this.wasConnected=!0,this._relayProber?.finalize()}onNegotiationCompletedAsync(e){return this.logger.safe.info(`[${e}] handle negotiation completed`),this.setSignalingState(!0),this.isReconnecting()&&(this.diagnostics.registerRetarget("completed"),2===this.escalationType&&this.blockCurrentSession(e)),Promise.resolve()}async onSessionErrorOccurred(e,t){this.logger.safe.info(`[${t}] handle session error`,Ge(e)),await this.rejectReconnect(t),this.isReconnectAllowed()?await this.scheduleReconnectRetry(t,!1,!1):this.callback.onSessionErrorOccurred(e,t,this.wasConnected)}onNegotiationRejection(e,t){this.logger.safe.info(`[${t}] handle negotiation rejection`),this.diagnostics.registerRetarget("rejected");const i=1===this.escalationType;return this.rejectReconnect(t).then((()=>{const n=e.type===tt.RENEGOTIATION_ERROR.glare&&i;(e.type!==tt.RENEGOTIATION_ERROR.glare||i)&&(this.isRecoverableError(e.type)||n?this.scheduleReconnectRetry(t,n,i):this.onReconnectFailed(Ge(e),t))}))}async ensureNetwork(e){const t=this.isOnline;if(!this.isOnline){this.logger.safe.info(`[${e}] waiting for network...`);try{await this.isOnlineDeferred.promise}catch(t){return void this.logger.safe.info(`${e} call disposed while waiting for network`)}this.logger.safe.info(`[${e}] network seems up`)}if(this.isDisconnected){const i=await this.createRelayProber(),n=await i.ensureOnline();this.logger.safe.info(`[${e}] probing complete in ${n} ms`),this.diagnostics.registerState("relaysUp"),t&&n<1e3&&this.logger.safe.info(`[${e}] looks like network failed on remote side, recovery was quick`)}}oldSessionIsOnline(e){return!!this.session?.isConnected()&&(this.logger.safe.info(`[${e}] old session recovered`),this.isReconnecting()||this.diagnostics.registerReconnect("connected"),!0)}async waitForNetworkAndTryLightweightRecovery(e){const t=this.oldSessionIsOnline(e);if(t||!this.settings.reconnectWithProbes)return t;this.setReconnectTimer(),this.isWaitingForNetwork=!0;const i=this.getMaxNetworkWaitTime();return this.logger.safe.info(`[${e}] can wait up to ${i} ms`),await Promise.race([this.ensureNetwork(e),_i(i)]),this.isWaitingForNetwork=!1,this.session&&(this.session.isConnected()||this.session.isFailed()||(this.logger.safe.info(`[${e}] giving session a moment to recover`),await _i(this.settings.reconnectWaitTimeAfterProbe)),this.oldSessionIsOnline(e))?(this.resetReconnectTimer(),!0):this.checkIfTimerFailed(e)?(this.logger.safe.info(`[${e}] session reconnect timer reached during network checks`),!0):!!this.isDisposing&&(this.logger.safe.info(`[${e}] session is disposed`),!0)}reconnectAsync(e,t=!1,i=!1){return this.logger.safe.info(`[${e}] queueing reconnect, force=${t}, escalation=${i}`),this.diagnostics.registerReconnectAttempt(i?"local escalation":"out"),this._isReconnectScheduled=!0,i&&(this.escalationType=1),this.sessionOperationQueue.queueOperation((async()=>{if(this._isReconnectScheduled=!1,t||!await this.waitForNetworkAndTryLightweightRecovery(e))return this.isReconnecting()?(this.logger.safe.info(`[${e}] ongoing reconnect is in progress`),void this.sessionOperationQueue.completeCurrentOperation()):(this.diagnostics.registerState("reconnect"),await this.initReconnect(e),await this.reconnectSession.configureModalitiesAsync(this.getConfiguredModalities(),e),void this.sessionOperationQueue.completeCurrentOperation());this.sessionOperationQueue.completeCurrentOperation()}),e)}async acceptReconnectStartAsync(e,t){return this.logger.safe.info(`[${t}] accepting reconnect`),this.diagnostics.registerRetarget("incoming"),e?(this.escalationType=2,this.diagnostics.registerEscalation("attempted")):(!this.isReconnecting()&&this.isDisconnected?this.diagnostics.registerReconnect("attempted"):this.isReconnecting()&&await this.rejectReconnect(t),this.diagnostics.registerState("reconnect"),this.diagnostics.registerReconnectAttempt("in")),this.initReconnect(t)}acceptReconnectFinish(e){const t=this.getConfiguredModalities();return this.reconnectSession.configureModalitiesAsync(t,e).then((()=>t))}isReconnecting(){return!!this.reconnectSession}isReconnectScheduled(){return this._isReconnectScheduled}cleanUp(){this.sessionCallbacks=null,this.reconnectSession=null}async terminateAsync(e){try{await(this.session?.terminate(e,{}))}catch{}try{await this.terminateReconnectSessionAsync(e,!0)}catch{}this.cleanUp()}completeReconnect(e){return this.logger.safe.info(`[${e}] completing reconnect`),2===this.escalationType&&(this.unblockCurrentSession(),this.diagnostics.registerEscalation("completed")),this.escalationType=0,this.reconnectSession&&(this.context.config.isConference=this.isReconnectConference,this.disposeActiveSession(e),this.session=this.reconnectSession,this.reconnectManagerMessageQueue.clear(),this.diagnostics.registerReconnectAttemptStatus("completed"),this._isSignalingStable||this.diagnostics.registerRetarget("completed"),this.isDisconnected&&this.diagnostics.registerReconnect("connected"),this.resetReconnectTimer(),this.reconnectDelayTime=0,this.reconnectSession=null,this.negotiationPausePromise=null,this.session.callbacks=this.sessionCallbacks||{}),Promise.resolve()}async rejectReconnect(e){this.logger.safe.info(`[${e}] rejecting reconnect`),this.setSignalingState(!1),2===this.escalationType&&this.diagnostics.registerEscalation("rejected"),this.escalationType=0,this.reconnectSession&&(await this.terminateReconnectSessionAsync(e,!1),this.diagnostics.registerReconnectAttemptStatus("rejected")),this.session&&(this.reconnectManagerMessageQueue.flush(),this.session.callbacks=this.sessionCallbacks,this.unblockCurrentSession())}configureModalitiesAsync(e,t){this.lastKnownConfiguredModalities=e;const i=[];return this.session&&i.push(this.session.configureModalitiesAsync(e,t)),this.reconnectSession&&i.push(this.reconnectSession.configureModalitiesAsync(e,t)),Promise.all(i).then((()=>Promise.resolve()))}canSendDtmf(){return this.getMainSession().canSendDtmf()}getExtensionsManager(){return this.getMainSession().getExtensionsManager()}muteHold(e,t){this.getMainSession().muteHold(e,t)}muteInputAsync(e){return this.getMainSession().muteInputAsync(e)}unmuteInputAsync(e){return this.getMainSession().unmuteInputAsync(e)}muteOutputAsync(e){return this.getMainSession().muteOutputAsync(e)}unmuteOutputAsync(e){return this.getMainSession().unmuteOutputAsync(e)}_deviceSelectionChanged(){this.session&&this.session.deviceSelectionChanged(),this.reconnectSession&&this.reconnectSession.deviceSelectionChanged()}disposeActiveSession(e){if(this.session&&this.isReconnecting()){this.logger.safe.info(`[${e}] About to dispose current session...`);const t=this.session;return this.lastKnownConfiguredModalities=this.session.getConfiguredModalities(),t.callbacks=this.reconnectManagerMessageQueue.queueCallbacks,t.move(this.reconnectSession,e),this.session=null,t.terminate(e,{},!1)}return Promise.resolve()}registerRetargetOutgoing(){this.diagnostics.registerRetarget("outgoing")}isSignalingStable(){return this._isSignalingStable}getConfiguredModalities(){return this.getMainSession().getConfiguredModalities()||this.lastKnownConfiguredModalities}checkIfTimerFailed(e){return!(this.isReconnectAllowed()||this.session&&!this.session.isFailed()||(this.onReconnectFailed("the time limit was reached",e),0))}async scheduleReconnectRetry(e,t,i){const n=this.getReconnectDelayTime();if(this.logger.safe.info(`[${e}}] scheduling reconnect retry attempt in ${n}`),await _i(n),t||!this.checkIfTimerFailed(e))return this.reconnectAsync(e,i,i)}isRecoverableError(e){return tt.RENEGOTIATION_ERROR.media===e||tt.RENEGOTIATION_ERROR.signaling===e}async resetReconnectSession(e){this.logger.safe.info(`[${e}] Resetting reconnect session. Session exists: old: ${!!this.session}, new: ${!!this.reconnectSession}`),this.isReconnectConference=0!==this.escalationType||this.context.config.isConference;const t=0!==this.escalationType||this.context.config.isConference&&this.wasConnected&&!this.isDisconnected,i=this.getMainSession(),n=this.configProvider.getConfigView(this.isReconnectConference,i.getSessionConfig()),r=i.clone(t,n);r.callbacks={...this.sessionCallbacks,onTransportConnected:e=>{2!==this.escalationType&&this.completeReconnect(e),this.raiseReconnectEvent("Good",e),this.sessionCallbacks.onTransportConnected(e)}},this.session&&(this.session.callbacks={...this.reconnectManagerMessageQueue.queueCallbacks,onSessionErrorOccurred:(e,t)=>(e.type!==tt.MEDIA_ERROR.iceConnectionError&&this.reconnectManagerMessageQueue.queueCallbacks.onSessionErrorOccurred(e,t),Promise.resolve())}),this.reconnectSession&&(this.reconnectSession.move(r,e),this.logger.safe.info(`[${e}] reconnect session still exists during reconnect clone operation`),await this.terminateReconnectSessionAsync(e,!1)),this.logger.safe.info(`[${e}] New session reset.`),this.reconnectSession=r}async initReconnect(e){this.logger.safe.info(`[${e}] initiate reconnect`),this.setReconnectTimer(),await this.resetReconnectSession(e),this.setSignalingState(!1),this.session&&(this.blockCurrentSession(e),await Promise.all([this.reconnectSession.muteInputAsync(e),this.reconnectSession.muteOutputAsync(e)]))}blockCurrentSession(e){this.negotiationPausePromise=this.session.pauseNegotiations(e)}unblockCurrentSession(){this.negotiationPausePromise&&(this.negotiationPausePromise.resolve(),this.negotiationPausePromise=null)}raiseReconnectEvent(e,t){this.ufdManager.signalEvent("NetworkReconnect",e,"Audio",!0,t)}async terminateReconnectSessionAsync(e,t){if(this.reconnectSession){const i=new iO(this.sessionCallbacks);this.reconnectSession.callbacks={...i.queueCallbacks,onTerminated:t?this.sessionCallbacks.onTerminated:i.queueCallbacks.onTerminated},await this.reconnectSession.terminate(e,{},!1),i.clear(),this.reconnectSession=null}}setReconnectTimer(){const e=this.wasConnected?this.settings.reconnectTimeLimit:this.settings.initialReconnectTimeLimit;e>0&&!this.reconnectTimer&&(this.reconnectTimerStart=Date.now(),this.reconnectTimer=window.setTimeout((()=>this.resetReconnectTimer()),e))}resetReconnectTimer(){clearTimeout(this.reconnectTimer),this.reconnectTimer=null}isReconnectAllowed(){return!!this.reconnectTimer&&!this.isDisposing}getReconnectDelayTime(){return 1e3*Math.min(++this.reconnectDelayTime,this.settings.maxReconnectDelayTime)}getMaxNetworkWaitTime(){const e=this.reconnectTimerStart>0?Date.now()-this.reconnectTimerStart:0;return Math.max(this.settings.reconnectTimeLimit-e,0)}onReconnectFailed(e,t){this.callback.onSessionErrorOccurred({type:tt.MEDIA_ERROR.iceConnectionError,detail:`Reconnect failed, error - ${Ge(e)}`},t,this.wasConnected)}setSignalingState(e){this._isSignalingStable=e}async handleTmpConnectivityLoss(e){this.logger.safe.info(`[${e}] Session went into disconnected state, giving it ${this.settings.losingConnectivityTimeoutMs}ms to recover`),-1!==this.settings.losingConnectivityTimeoutMs&&(await _i(this.settings.losingConnectivityTimeoutMs),this.isDisconnected&&this.raiseReconnectEvent("Poor",e)),this.isDisconnected&&this.settings.reconnectOnDisconnect&&(this.logger.safe.info(`[${e}] Session is still down, triggering reconnect`),this.onIceDisconnect(e))}},oO=class{constructor(e,t){this.stats=e,this.diagnostics=t}set mediaLegId(e){this.stats.setMediaLegId(e.process()),this.diagnostics&&(this.diagnostics.mediaLegId=e)}set isMultiParty(e){e&&this.stats.setMultiParty(),this.diagnostics&&(this.diagnostics.isMultiParty=e)}set allowedModalities(e){this.stats.setSendModalities(e),this.diagnostics&&(this.diagnostics.allowedModalities=e)}set sessionError(e){this.stats.setError(e),this.diagnostics&&(this.diagnostics.sessionError=e)}set finalAnswerTime(e){this.stats.setFinalAnswerTimestamp(e),this.diagnostics&&(this.diagnostics.finalAnswerTime=e)}set dtmfResult(e){this.stats.dtmfResult(e),this.diagnostics&&(this.diagnostics.dtmfResult=e)}set swMute(e){this.stats.setSwMute(e),this.diagnostics&&(this.diagnostics.swMute=e)}set speakerMute(e){this.stats.setSpeakerMute(e),this.diagnostics&&(this.diagnostics.speakerMute=e)}set hwSilent(e){this.stats.setHwSilent(e),this.diagnostics&&(this.diagnostics.hwSilent=e)}set isSpeaking(e){this.stats.setSpeakingState(e),this.diagnostics&&(this.diagnostics.isSpeaking=e)}set iceConnectedStateTimestamp(e){this.stats.setIceConnectedStateTimestamp(e),this.diagnostics&&(this.diagnostics.iceConnectedStateTimestamp=e)}set iceInitTime(e){this.stats.setIceInitTimestamp(e),this.diagnostics&&(this.diagnostics.iceInitTime=e)}set ETag(e){this.stats.setETag(e),this.diagnostics&&(this.diagnostics.ETag=e)}set configIds(e){this.stats.setConfigIds(e),this.diagnostics&&(this.diagnostics.configIds=e)}set relay(e){this.stats.setRelay(e),this.diagnostics&&(this.diagnostics.relay=e)}negotiationStart(e){switch(this.diagnostics?.negotiationStart(e),e){case"Offering":this.stats.negotiation.offering.started();break;case"Answering":this.stats.negotiation.answering.started()}}negotiationCompleted(e){this.stats.negotiation.current.completed(e),this.diagnostics?.negotiationCompleted(e)}negotiationRejected(){this.stats.negotiation.current.rejected(),this.diagnostics?.negotiationRejected()}registerTransportConnected(){this.stats.registerTransportConnected(),this.diagnostics?.registerTransportConnected()}registerTransportDisconnected(){this.stats.registerTransportDisconnected(),this.diagnostics?.registerTransportDisconnected()}registerTransportFailed(){this.stats.registerTransportFailed(),this.diagnostics?.registerTransportFailed()}registerRollbackEvent(e){this.stats.registerRollbackEvent(e),this.diagnostics?.registerRollbackEvent(e)}registerRawMediaAccess(e,t,i){"send"===t?this.stats.registerSetInputRawMedia(i):this.stats.registerOutputRawMediaAccess(),this.diagnostics?.registerRawMediaAccess(e,t,i)}registerQualityStateChangedEvent(e){this.stats.registerQualityStateChangedEvent(e),this.diagnostics?.registerQualityStateChangedEvent(e)}terminated(e){this.stats.terminated(e),this.diagnostics?.terminated(e)}},lO=class{constructor(e){this.logger=e,this.operationQueue=null,this.currentOperationDeferred=null,this.operationQueue=new _I(this.logger)}queueOperation(e,t=Re()){this.logger.safe.info(`[${t}] queueing operation`);const i=new Mu,n=this.operationQueue.add((()=>(this.currentOperationDeferred=i,e())),t);return this.operationQueue.add(i,t),n}completeCurrentOperation(){this.currentOperationDeferred&&(this.logger.safe.info("completing operation"),this.currentOperationDeferred.resolve())}},dO=class extends Qe{constructor(e,t,i,n,r,s,a,o=i.getLogger().createChild("SessionV2",t)){super(o),this.session=e,this.context=i,this.callback=n,this.statistics=r,this.configProvider=s,this.diagnostics=a,this.logger=o,this.audioStreamStates={[tt.STREAMING_STATE.inactive]:[tt.STREAMING_STATE.started,tt.STREAMING_STATE.active,tt.STREAMING_STATE.failed],[tt.STREAMING_STATE.started]:[tt.STREAMING_STATE.active,tt.STREAMING_STATE.removed,tt.STREAMING_STATE.stopped,tt.STREAMING_STATE.failed],[tt.STREAMING_STATE.active]:[tt.STREAMING_STATE.removed,tt.STREAMING_STATE.stopped,tt.STREAMING_STATE.failed]},this.mediaLegId=new ZM,this.rejectedNegotiations=0,this.negotiationState=null,this.audioStreamState=tt.STREAMING_STATE.inactive,this.deviceManagerDisposables=[],this.visibilityChangedHandler=()=>{if(this.logger.safe.debug(`document.visibilityState changed: ${document.visibilityState}`),"visible"===document.visibilityState&&this.pcClosedInfo){const e=this.pcClosedInfo;this.pcClosedInfo=null,Date.now()<e.timestamp+this.configProvider.config.reconnectWakeupTimeLimit?(this.logger.safe.info(`[${e.causeId}] start reconnect after wakeup`),this.startReconnect(e.causeId)):(this.logger.safe.info(`[${e.causeId}] terminate a call after wakeup because allowed time limit for reconnect exceeded`),this.endCallOnFailure(e.mediaError,e.causeId))}},this.ufdManager=i.getUfdManager(),this.ufdManagerDisposable=this.ufdManager.on("onQualityChanged",(e=>this.qualityChanged(e))),this.sessionOperationQueue=new lO(this.logger),this.mediaLegId=new ZM,this.diagnosticsWrapper=new oO(this.statistics,this.diagnostics),this.statistics.setId(t),this.diagnosticsWrapper.mediaLegId=this.mediaLegId,this.diagnosticsWrapper.ETag=this.configProvider.ETag,this.diagnosticsWrapper.configIds=this.configProvider.ecsConfigIds,this.diagnosticsWrapper.isMultiParty=!!i.config.isConference,this.recoverableErrors=this.configProvider.config.recoverableMediaErrors.split(","),this.forceReconnectErrors=this.configProvider.config.forceReconnectErrors.split(",");const l=this.getSessionCallbacks();e.callbacks=l,e.relayManagerProvider=this,this.reconnectManager=new aO(e,i,new tO(this.statistics,this.diagnostics?new XM:void 0,this.diagnostics),this.sessionOperationQueue,this.getReconnectManagerCallbacks(),l,this.configProvider,this.getRelayManager()),this.deviceManager=this.context.callDeviceManager.getDefaultDeviceManager(),this.deviceManagerDisposables.push(this.deviceManager.on("onDevicesPermissionChanged",(()=>this.diagnosticsWrapper.allowedModalities=this.getAllowedModalities()))),this.deviceManagerDisposables.push(this.deviceManager.on("onSelectedDevicesChanged",(()=>this.deviceSelectionChanged()))),this.deviceManagerDisposables.push(this.deviceManager.on("onDevicesChanged",((e,t)=>this.deviceListChanged(t)))),this.statistics.setDevicesCount(this.deviceManager.getDevicesCount()),this.ufdManager.applyCurrentState((e=>this.qualityChanged(e))),document.addEventListener("visibilitychange",this.visibilityChangedHandler),this.requestWakeLock()}async requestWakeLock(){if(Cg.isWakeLockSupported()&&this.configProvider.config.useWakeLockApi)try{this.wakeLock=await window.navigator.wakeLock.request("screen")}catch(e){this.logger.safe.info(`Wakelock request failed - ${e.message}`)}}enableTeamsRealTimeTelemetry(){this.realtimeTelemetryInterval||(this.logger.safe.info("teams realtime telemetry is enabled"),this.getSessionCallbacks().onTeamsRealtimeTelemetryReport(),this.realtimeTelemetryInterval=window.setInterval((()=>{this.getSessionCallbacks().onTeamsRealtimeTelemetryReport()}),1e3*this.configProvider.config.diagnostics.teamsRealtimeTelemetry.pollingInterval))}getMediaStatsReport(){return this.diagnostics?.mediaStatsReport}createOfferAsync(e){return this.sessionOperationQueue.queueOperation((async()=>{this.diagnosticsWrapper.negotiationStart("Offering");try{const t=await this.getCurrentSession().createOfferAsync(e);return this.updateSelectedDevices(),t.mediaLegId=this.mediaLegId.process(t.mediaLegId),this.diagnosticsWrapper.mediaLegId=this.mediaLegId,this.reconnectManager.isReconnecting()&&!this.reconnectManager.isSignalingStable()&&(this.reconnectManager.registerRetargetOutgoing(),t.newOffer=!0),t}catch(e){throw this.diagnosticsWrapper.sessionError=e,e}}),e)}setCallConstraints(e,t){return this.getCurrentSession().setCallConstraints(e,t)}processOfferAsync(e,t){return this.sessionOperationQueue.queueOperation((async()=>{this.diagnosticsWrapper.negotiationStart("Answering"),e.mediaLegId=this.mediaLegId.process(e.mediaLegId);try{e.newOffer&&await this.reconnectManager.acceptReconnectStartAsync(e.escalationOccurring,t);const i=await this.getCurrentSession().processOfferAsync(e,t);if(e.newOffer){const e=await this.reconnectManager.acceptReconnectFinish(t);return i.sharing===tt.MEDIA_STATE.sendReceive&&(i.sharing=e.sharing===tt.MEDIA_STATE.send?tt.MEDIA_STATE.send:tt.MEDIA_STATE.receive),i}return i}catch(e){throw this.diagnosticsWrapper.sessionError=e,e}}),t)}async processAnswerAsync(e,t,i,n){try{return await this.getCurrentSession().processAnswerAsync(e,t,i,n)}catch(e){throw this.diagnosticsWrapper.sessionError=e,e}}async completeNegotiationAsync(e){this.rejectedNegotiations=0;try{const t=await this.getCurrentSession().completeNegotiationAsync(e);return this.negotiationState=t,this.diagnosticsWrapper.finalAnswerTime=Date.now(),this.diagnosticsWrapper.negotiationCompleted?.(t.activeModalities),await this.reconnectManager.onNegotiationCompletedAsync(e),this.sessionOperationQueue.completeCurrentOperation(),this.negotiationState}catch(e){throw this.diagnosticsWrapper.sessionError=e,e}}ignoreNotReconnectError(e){return e.detail?.type!==tt.MEDIA_ERROR.incompatibleOriginator}async rejectNegotiationAsync(e,t){this.logger.safe.info(`[${t}] rejectNegotiationAsync`,e);try{if(this.reconnectManager.isReconnecting()&&this.ignoreNotReconnectError(e))return await this.reconnectManager.onNegotiationRejection(e,t),this.registerNegotiationRejection(this.negotiationState),this.sessionOperationQueue.completeCurrentOperation(),this.negotiationState;{const i=await this.getCurrentSession().rejectNegotiationAsync(e,t,this.isRenegotiationAllowed(e.type));return this.sessionOperationQueue.completeCurrentOperation(),this.registerNegotiationRejection(i),i}}catch(e){throw this.diagnosticsWrapper.sessionError=e,e}}completeEscalationAsync(e){return this.reconnectManager.completeReconnect(e)}rejectEscalationAsync(e){return this.reconnectManager.rejectReconnect(e)}async terminate(e,t){this.logger.safe.info(`terminate reject reason: ${JSON.stringify(t||"")}`),this.registerVideoEffectsTelemetryEvent(this.deviceManager.effectsManager.getStats("Video","StatsQuery")),this.registerAudioEffectsTelemetryEvent(this.deviceManager.effectsManager.getStats("Audio")),this.statistics.setPermissionStates(await this.deviceManager.getKnownPermissionStates()),this.diagnosticsWrapper.terminated(t);const i=()=>this.cleanUp();return this.reconnectManager.terminateAsync(e).then(i,i)}async getStatsAsync(e){return this.configProvider.config.diagnostics.useForTelemetry?this.diagnostics?.telemetryReport:this.getMainSession().getStatsAsync(e).then((e=>this.prepareStats(e)))}getLastKnownStats(e=!1){return this.configProvider.config.diagnostics.useForTelemetry?this.diagnostics?.telemetryReport:this.prepareStats(this.getMainSession().getLastKnownStats(e),e)}getCallTechnicalInfo(){return this.diagnostics?.realtimeTelemetryReport}async createAnswerAsync(e,t){try{const i=await this.getCurrentSession().createAnswerAsync(e,t);return this.updateSelectedDevices(),i.mediaLegId=this.mediaLegId.process(i.mediaLegId),this.diagnosticsWrapper.mediaLegId=this.mediaLegId,i}catch(e){throw this.diagnosticsWrapper.sessionError=e,e}}configureModalitiesAsync(e,t){return it(e,((t,i)=>{t||delete e[i]})),this.reconnectManager.configureModalitiesAsync(e,t)}getAllowedModalities(){return this.deviceManager.getAllowedModalities()}createRemoteRenderer(e){return this.getMainSession().createRemoteRenderer(e)}async sendDtmf(e){try{const t=await this.getMainSession().sendDtmf(e);return this.diagnosticsWrapper.dtmfResult=!0,t}catch(e){throw this.diagnosticsWrapper.dtmfResult=!1,e}}canSendDtmf(){return this.reconnectManager.canSendDtmf()}getExtensionsManager(){return this.reconnectManager.getExtensionsManager()}muteHold(e,t){this.reconnectManager.muteHold(e,t)}muteInputAsync(e){return this.diagnosticsWrapper.swMute=!0,this.ufdManager.setSwMute(!0),this.reconnectManager.muteInputAsync(e)}unmuteInputAsync(e){return this.diagnosticsWrapper.swMute=!1,this.ufdManager.setSwMute(!1),this.reconnectManager.unmuteInputAsync(e)}muteOutputAsync(e){return this.diagnosticsWrapper.speakerMute=!0,this.reconnectManager.muteOutputAsync(e)}unmuteOutputAsync(e){return this.diagnosticsWrapper.speakerMute=!1,this.reconnectManager.unmuteOutputAsync(e)}getAcceptedTypes(){return this.reconnectManager.getCurrentSession().getAcceptedTypes()}useNullAudioStreamClient(){this.getCurrentSession().useNullAudioStreamClient()}createAudioElement(e){this.getCurrentSession().createAudioElement(e)}getIncomingRawAudioStream(){return this.diagnosticsWrapper.registerRawMediaAccess("audio","recv",!0),this.getCurrentSession().getIncomingRawAudioStream()}getUnmixedAudioProvider(){return this.getCurrentSession().getUnmixedAudioProvider()}deviceSelectionChanged(){this.updateSelectedDevices(),this.reconnectManager._deviceSelectionChanged()}registerDeviceTelemetryEvent(e){this.getCurrentSession().onDeviceEvent(e),this.statistics.registerDeviceTelemetryEvent(e)}registerVideoEffectsTelemetryEvent(e){this.statistics.registerVideoEffectsTelemetryEvent(e)}registerAudioEffectsTelemetryEvent(e){this.statistics.registerAudioEffectsTelemetryEvent(e)}reconnectAsync(e,t=!1){return this.reconnectManager.reconnectAsync(e,!0,t)}isReconnecting(){return this.reconnectManager.isReconnecting()}getRelayManager(){return this.relayManager??(this.relayManager=new eO(this.context.maContext.getRelayManager(),this.diagnosticsWrapper))}getSessionConfig(){return this.reconnectManager.getCurrentSession().getSessionConfig()}getDiagnostics(){return this.diagnostics}getLocalMediaTrackId(e){return this.reconnectManager.getMainSession().getLocalMediaTrackId(e)}getSubscriptionManager(){return this.getCurrentSession().getSubscriptionManager()}getDisabledModalities(){return this.getCurrentSession().getDisabledModalities()}configureSpatialAudio(e,t){this.getCurrentSession().configureSpatialAudio(e,t)}setParticipantSpatialAudioPositions(e,t){this.getCurrentSession().setParticipantSpatialAudioPositions(e,t)}startMediaDescriptionsUpdateAsync(e){return this.getCurrentSession().startMediaDescriptionsUpdateAsync(e)}completeMediaDescriptionsUpdateAsync(e){return this.getCurrentSession().completeMediaDescriptionsUpdateAsync(e)}rejectMediaDescriptionsUpdateAsync(e,t){return this.getCurrentSession().rejectMediaDescriptionsUpdateAsync(e,t)}processNotification(e,t){this.session.processNotification(e,t)}async cleanUp(){this.callback=null,this.deviceManagerDisposables.forEach((e=>e.dispose())),this.ufdManagerDisposable.dispose(),this.reconnectManager.dispose(),this.pcClosedInfo=null,document.removeEventListener("visibilitychange",this.visibilityChangedHandler),window.clearInterval(this.realtimeTelemetryInterval),this.wakeLock&&(await this.wakeLock.release(),this.wakeLock=null)}updateSelectedDevices(){const e=this.deviceManager.getSelectedDevices(),t=e=>e?this.deviceManager.getDeviceNameAsync(e).then((e=>Pt(e,this.configProvider.config.devices.piiSafeWords))):Promise.resolve("none");Promise.all([t(e.microphone),t(e.speaker),t(e.camera)]).then((([e,t,i])=>{this.statistics.setUsedDevices({microphone:e,speaker:t,camera:i})}))}getCurrentSession(){return this.reconnectManager.getCurrentSession()}getMainSession(){return this.reconnectManager.getMainSession()}setAudioStreamState(e,t,i){this.isAudioStateValid(e)?this.raiseAudioStateChanged(e,t,i):this.logger.safe.error(`[${t}] audio state transition is invalid: ${this.audioStreamState} -> ${e}`)}isAudioStateValid(e){return this.audioStreamStates[this.audioStreamState].indexOf(e)>=-1}raiseAudioStateChanged(e,t,i){if(this.logger.safe.info(`[${t}] audio state changed to ${e}`),this.callback.onAudioStateChanged){const t={content:"audio",direction:"receive",stream:e};this.callback.onAudioStateChanged(t,i)}}getReconnectManagerCallbacks(){return{onSessionErrorOccurred:(e,t,i)=>{this.isNetworkMediaError(e)&&!i&&this.ufdManager.raisePendingWhitelistingUFD(),this.endCallOnFailure(e,t)}}}isNetworkMediaError(e){return e.type===tt.MEDIA_ERROR.iceConnectionError||e.type===tt.MEDIA_ERROR.noNetworkError}isRecoverableMediaError(e){return this.recoverableErrors.includes(e.type)}startReconnect(e=Re()){return this.reconnectManager.onIceDisconnect(e)}shouldForceReconnect(e){return this.forceReconnectErrors.includes(e.type)}isUnexpectedPcClose(e){return e.type===tt.MEDIA_ERROR.unexpectedClose}getSessionCallbacks(){return this.sessionCallbacks||(this.sessionCallbacks={onTerminated:()=>{this.logger.safe.warn("call onTerminated"),this.event("onTerminated").raise(this)},onSessionErrorOccurred:(e,t=Re())=>this.isUnexpectedPcClose(e)?this.handlePcClosed(e,t):this.shouldForceReconnect(e)?this.reconnectManager.reconnectAsync(t,!0):this.isRecoverableMediaError(e)?this.reconnectManager.isReconnecting()?this.reconnectManager.onSessionErrorOccurred(e,t):this.startReconnect(t):(this.endCallOnFailure(e,t),Promise.resolve()),onNegotiationRequired:e=>this.callback.onNegotiationRequired(e),onAudioHwSilentChanged:e=>{this.diagnosticsWrapper.hwSilent=e},onAudioStateChanged:(e,t)=>{this.setAudioStreamState(e,t)},onTransportConnected:(e=Re())=>{this.logger.safe.info(`[${e}] Transport connectivity established`),this.ufdManager.cancelPendingWhitelistingUFD(),this.reconnectManager.onConnected(e),this.diagnosticsWrapper.registerTransportConnected(),this.diagnosticsWrapper.iceConnectedStateTimestamp=Date.now(),this.callback?.onTransportConnected(e)},onTransportDisconnected:(e=Re())=>{this.logger.safe.warn(`[${e}] Transport connectivity lost`),this.reconnectManager.onTransportDisconnect(e),this.diagnosticsWrapper.registerTransportDisconnected()},onTransportFailed:()=>{this.diagnosticsWrapper.registerTransportFailed()},onTransportInitialized:()=>{this.diagnosticsWrapper.iceInitTime=Date.now()},onUpdateMediaDescriptionsRequired:e=>this.callback.onUpdateMediaDescriptionsRequired(e),onTeamsRealtimeTelemetryReport:()=>this.callback.onRealtimeTelemetryReport()}),this.sessionCallbacks}registerNegotiationRejection(e){this.rejectedNegotiations++,this.diagnosticsWrapper.negotiationRejected?.(),e.rollback&&this.diagnosticsWrapper.registerRollbackEvent(e.rollback)}isRenegotiationAllowed(e){return this.rejectedNegotiations<this.context.configProvider.config.renegotiationAttempts&&!this.reconnectManager.isReconnectScheduled&&(tt.RENEGOTIATION_ERROR.signaling===e||tt.RENEGOTIATION_ERROR.media===e)}prepareStats(e,t=!1){this.statistics.setDeviceList(this.deviceManager.getDeviceDescriptions(),this.deviceManager.getDeviceListDebugInfo()),this.statistics.setRelayManagerTimers(this.getRelayManager().getStats()),this.statistics.setVideoEffectStats(this.context.callDeviceManager.getDeviceManager("Video").effectsManager.getStats("Video","StatsQuery")),this.statistics.setAudioEffectStats(this.deviceManager.effectsManager.getStats("Audio"));const i=this.statistics.generateStatistics(e,this.mediaLegId,t);return this.configProvider.config.diagnostics.features.useNewerStatisticsMetrics&&(i.data.metrics=this.diagnostics?.telemetryReport?.data.metrics),i}deviceListChanged(e){e&&this.statistics.deviceChangedByPoll(),this.statistics.devicesChanged(),this.statistics.setDevicesCount(this.deviceManager.getDevicesCount())}qualityChanged(e){const t=e.deviceManagerId;!t||this.context.callDeviceManager.hasDevice(t)?this.callback?.onQualityChanged&&(this.diagnosticsWrapper.registerQualityStateChangedEvent(e),"DeviceSpeakWhileMuted"===e.type&&(this.diagnosticsWrapper.isSpeaking="Good"!==e.value),this.callback.onQualityChanged(e)):this.logger.info(`${t} - is not added to Call, skipping UFD.`)}endCallOnFailure(e,t,i){this.callback&&(this.callback.onSessionErrorOccurred&&this.callback.onSessionErrorOccurred(e,t),this.diagnosticsWrapper.sessionError=e,this.setAudioStreamState(tt.STREAMING_STATE.failed,t,i))}async handlePcClosed(e,t){const i=this.configProvider.config.reconnectWakeupTimeLimit;return this.logger.safe.info(`[${t}] handle unexpected PC closed event`,`visibilityState=${document.visibilityState}, wakeupLimit=${this.configProvider.config.reconnectWakeupTimeLimit}`),"visible"===document.visibilityState?this.startReconnect(t):i?void(this.pcClosedInfo={timestamp:Date.now(),causeId:t,mediaError:e}):this.endCallOnFailure(e,t,"suspended")}},cO=class{constructor(e){this.creationTime=e,this.records=[],this.activeRecord=null,this.activeAttempt=null,this.reconnectState=!1}getReport(){return this.records.length?JSON.stringify(this.records):""}isReconnecting(){return this.reconnectState}onReconnectStart(){this.reconnectState=!0,this.activeRecord||(this.activeRecord={attempts:[],endTime:null,startTime:Date.now()-this.creationTime},this.records.push(this.activeRecord))}onReconnectAttempt(e){if(!this.activeRecord)return null;this.activeAttempt={direction:e,status:!1,endTime:null,startTime:this.getTimestamp()},this.reconnectState=!0,this.activeRecord.attempts.push(this.activeAttempt)}onReconnectConnected(){if(!this.activeRecord)return null;this.reconnectState=!1,this.activeRecord.endTime=this.getTimestamp(),this.activeRecord=this.activeAttempt=null}onReconnectCompleted(){this.reconnectState=!1,this.resolveReconnectAttempt(!0)}onReconnectRejected(){this.resolveReconnectAttempt(!1)}resolveReconnectAttempt(e){this.activeAttempt&&this.activeRecord&&(this.activeAttempt.status=e,this.activeAttempt.endTime=this.getTimestamp())}getTimestamp(){return Date.now()-this.creationTime-this.activeRecord.startTime}},hO=window.navigator,uO=class{constructor(e="Good"){this.stopWatches=[],this.currentLevel=e,this.getStopWatch(e).start()}updateLevel(e){this.currentLevel!==e&&(this.getStopWatch(this.currentLevel).stop(),this.currentLevel=e,this.getStopWatch(this.currentLevel).start())}getCount(e){const t=this.stopWatches[e];return t?t.count:0}getElapsed(e){const t=this.stopWatches[e];return t?t.elapsed:0}getStopWatch(e){let t=this.stopWatches[e];return t||(t=new SM,this.stopWatches[e]=t),t}},pO=RegExp(/^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\:[0-9]{2,5})?$/),gO=RegExp(/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))(:[0-9]{2,5})?$/),mO=class{constructor(e,t,i){this.configProvider=e,this.callNumber=t,this.sessionDiagnostics=i,this.negotiation={offering:this.offering(),answering:this.answering(),current:this.current()},this.creationTime=Date.now(),this.negotiationCount=0,this.initialNegotiationCompleted=!1,this.activeModalities={},this.multiParty=!1,this.noIceCandidatesGoodEventCount=0,this.noIceCandidatesBadEventCount=0,this.noRelayIceCandidatesGoodEventCount=0,this.noRelayIceCandidatesBadEventCount=0,this.cameraInUseBadEventCount=0,this.cameraInUseGoodEventCount=0,this.microphoneInUseBadEventCount=0,this.microphoneInUseGoodEventCount=0,this.cameraFreezeStartEventCount=0,this.cameraFreezeEndEventCount=0,this.networkRecv=new uO,this.networkSend=new uO,this.retargetIncomingCount=0,this.retargetOutgoingCount=0,this.retargetCompletedCount=0,this.retargetRejectedCount=0,this.reconnectAttemptedCount=0,this.reconnectConnectedCount=0,this.escalationAttemptedCount=0,this.escalationCompletedCount=0,this.escalationRejectedCount=0,this.durationTimer=new SM,this.terminationReason={},this.terminationTime=0,this.sessionId="0",this.rejectedNegotiationCount=0,this.mediaError={type:"none",detail:"none"},this.incompatibleOffer=!1,this.dtmfSuccess=0,this.dtmfFailure=0,this.relay=null,this.relayManagerTimers=null,this.allowedAudioSend=!0,this.allowedVideoSend=!0,this.allowedScreensharingSend=!0,this.iceInitTime=0,this.finalAnswerTime=0,this.iceConnectedStateTime=0,this.usedDevices=null,this.deviceSelectionChangeCount=0,this.devicesChangeCount=0,this.devicesPollChangeCount=0,this.mute=new SM,this.osMute=new SM,this.hwSilent=new SM,this.isSpeaking=new SM,this.swMute=new SM,this.speakerMute=new SM,this.deviceTelemetryEvents=[],this.videoEffectsTelemetryEvents=new zA(this.configProvider.config.effectsTelemetryBufferSize),this.audioEffectsTelemetryEvents=new zA(this.configProvider.config.effectsTelemetryBufferSize),this.devicesCount=null,this.reconnectStats=new cO(this.creationTime),this.transportDisconnected=!1,this.transportReconnectedCount=0,this.ufds=[],this.mediaQosEnabled=!1,this.portRangeConfigured=!1,this.rollbackNegotiation=[],this.rawOutputAudioAccess={attempt:0,timer:new SM},this.rawInputAudioOverride={attempt:0,timer:new SM},this.connectionEffectiveTypeSeries=new zA(this.configProvider.config.navConnectionNumSamplesToCollect),this.connectionRttSeries=new zA(this.configProvider.config.navConnectionNumSamplesToCollect),this.connectionDownlinkSeries=new zA(this.configProvider.config.navConnectionNumSamplesToCollect),this.navigatorConnectionInterval=setInterval((()=>{const e=hO?.connection;e&&("number"==typeof e.downlink&&this.connectionDownlinkSeries.add(e.downlink),"number"==typeof e.rtt&&this.connectionRttSeries.add(e.rtt),"number"==typeof e.effectiveType&&this.connectionEffectiveTypeSeries.add(e.effectiveType))}),this.configProvider.config.navConnectionPollingInterval),this.durationTimer.start()}terminated(e){this.terminationReason=ut(e),this.terminationTime=Date.now(),this.durationTimer.stop(),this.osMute.stop(),this.swMute.stop(),this.hwSilent.stop(),this.isSpeaking.stop(),this.mute.stop(),this.speakerMute.stop(),this.rawInputAudioOverride.timer.stop(),this.rawOutputAudioAccess.timer.stop(),clearInterval(this.navigatorConnectionInterval)}setMultiParty(){this.multiParty=!0}updateCommonMute(){this.swMute.isRunning||this.osMute.isRunning?this.mute.start():this.mute.stop()}setDeviceList(e,t){this.deviceList=e.map((e=>({label:Pt(e.label,this.configProvider.config.devices.piiSafeWords),kind:e.kind}))),t&&(this.deviceDebugStrings=ut(t))}setPermissionStates(e){this.permissionStates=e}setSwMute(e){e?this.swMute.start():this.swMute.stop(),this.updateCommonMute()}setSpeakerMute(e){e?this.speakerMute.start():this.speakerMute.stop()}setHwSilent(e){e?this.hwSilent.start():this.hwSilent.stop()}setSpeakingState(e){e?this.isSpeaking.start():this.isSpeaking.stop()}setETag(e){this.ETag=e}setConfigIds(e){this.configIds=e}setVideoEffectStats(e){e&&this.videoEffectsTelemetryEvents.add(e)}setAudioEffectStats(e){e&&this.audioEffectsTelemetryEvents.add(e)}registerQualityStateChangedEvent(e){switch(e.type){case"NoNetwork":"Good"===e.value?this.noIceCandidatesGoodEventCount++:this.noIceCandidatesBadEventCount++;break;case"NetworkRelaysNotReachable":"Good"===e.value?this.noRelayIceCandidatesGoodEventCount++:this.noRelayIceCandidatesBadEventCount++;break;case"DeviceCaptureNotFunctioning":"Good"===e.value?this.microphoneInUseGoodEventCount++:this.microphoneInUseBadEventCount++;break;case"VideoCapturerDeviceStartFailed":"Good"===e.value?this.cameraInUseGoodEventCount++:this.cameraInUseBadEventCount++;break;case"DeviceCaptureMute":"Audio"===e.mediaType&&("Bad"===e.value?this.osMute.start():this.osMute.stop(),this.updateCommonMute());break;case"NetworkRecvQuality":this.networkRecv.updateLevel(e.value);break;case"NetworkSendQuality":this.networkSend.updateLevel(e.value);break;case"VideoCaptureDeviceFreeze":"Good"===e.value?this.cameraFreezeEndEventCount++:this.cameraFreezeStartEventCount++}"DeviceSpeakWhileMuted"!==e.type&&this.ufds.push({...e,timestamp:Date.now()-this.creationTime}),this.ufds.length>this.configProvider.config.maxStoredUFDCount&&this.ufds.shift()}registerRetargetIncoming(){this.retargetIncomingCount++}registerRetargetOutgoing(){this.retargetOutgoingCount++}registerRetargetCompleted(){this.retargetCompletedCount++}registerRetargetRejected(){this.retargetRejectedCount++}registerEscalationStart(){this.escalationAttemptedCount++}registerEscalationCompleted(){this.escalationCompletedCount++}registerEscalationRejected(){this.escalationRejectedCount++}registerRollbackEvent(e){e&&this.rollbackNegotiation.push({type:e.type,attempt:this.rollbackNegotiation.length+1,error:e.error?e.error:""})}registerReconnectAttempted(){this.reconnectAttemptedCount++,this.reconnectStats.onReconnectStart()}registerReconnectConnected(){this.reconnectConnectedCount++,this.reconnectStats.onReconnectConnected()}registerDeviceTelemetryEvent(e){e.timestamp=e.timestamp-this.creationTime,this.deviceTelemetryEvents.push(e)}registerVideoEffectsTelemetryEvent(e){e&&(e.timestamp=e.timestamp-this.creationTime,this.videoEffectsTelemetryEvents.add(e))}registerAudioEffectsTelemetryEvent(e){if(e){e.timestamp=e.timestamp-this.creationTime;const t=this.audioEffectsTelemetryEvents.items.pop();t&&this.audioEffectsChanged(t,e)&&this.audioEffectsTelemetryEvents.add(t),this.audioEffectsTelemetryEvents.add(e)}}audioEffectsChanged(e,t){return e.payload.fallback!==t.payload.fallback||void 0!==t.payload.userNoiseSuppressionMethod&&e.payload.userNoiseSuppressionMethod!==t.payload.userNoiseSuppressionMethod||void 0!==t.payload.userAudioEffect&&e.payload.userAudioEffect!==t.payload.userAudioEffect}registerReconnectAttempt(e){this.reconnectStats.onReconnectAttempt(e)}registerReconnectAttemptCompleted(){this.reconnectStats.onReconnectCompleted()}registerReconnectAttemptRejected(){this.reconnectStats.onReconnectRejected()}setMediaLegId(e){this.mediaLegId=e}setId(e){this.sessionId=e}setError(e){e.type===tt.MEDIA_ERROR.incompatibleOffer&&(this.incompatibleOffer=!0),this.mediaError.type=e.type||tt.MEDIA_ERROR.internalError,this.mediaError.detail=e.detail||e.toString()}setRelay(e){this.relay={address:e.addresses.join(),expires:e.expires,realm:e.realm,credentials:!(!e.username||!e.password),ports:[e.udpPort?`udp:${e.udpPort}`:"",e.tcpPort?`tcp:${e.tcpPort}`:"",e.tlsPort?`tls:${e.tlsPort}`:""].join(","),fqdns:e.fqdns?e.fqdns.join():"none"}}setRelayManagerTimers(e){this.relayManagerTimers=e}setSendModalities(e){this.allowedAudioSend=e.audio.some((e=>Ag(e))),this.allowedVideoSend=e.video.some((e=>Ag(e))),this.allowedScreensharingSend=e.sharing.some((e=>Ag(e)))}setIceInitTimestamp(e){this.iceInitTime||(this.iceInitTime=e)}setFinalAnswerTimestamp(e){this.finalAnswerTime||(this.finalAnswerTime=e)}setIceConnectedStateTimestamp(e){this.iceConnectedStateTime||(this.iceConnectedStateTime=e)}dtmfResult(e){e?++this.dtmfSuccess:++this.dtmfFailure}setUsedDevices(e){this.usedDevices&&JSON.stringify(e)!==JSON.stringify(this.usedDevices)&&this.deviceSelectionChangeCount++,this.usedDevices=e}setDevicesCount(e){this.devicesCount=e}setMediaQosEnabled(e){this.mediaQosEnabled=e}setPortRangeConfigured(e){this.portRangeConfigured=e}devicesChanged(){this.devicesChangeCount++}deviceChangedByPoll(){this.devicesPollChangeCount++}registerOutputRawMediaAccess(){this.rawOutputAudioAccess.attempt++,this.rawOutputAudioAccess.timer.start()}registerSetInputRawMedia(e){this.rawInputAudioOverride.attempt++,e?this.rawInputAudioOverride.timer.start():this.rawInputAudioOverride.timer.stop()}getReport(){const e=this.usedDevices||{microphone:"none",speaker:"none",camera:"none"};return{RawOutputAudioAccessDurationRatio:this.getDurationRatio(this.rawOutputAudioAccess.timer.elapsed),RawOutputAudioAccessAttempted:this.rawOutputAudioAccess.attempt,RawInputAudioOverrideDurationRatio:this.getDurationRatio(this.rawInputAudioOverride.timer.elapsed),RawInputAudioOverrideAttempted:this.rawInputAudioOverride.attempt,SessionId:this.sessionId,CallNumber:this.callNumber,NoIceCandidatesBadEventCount:this.noIceCandidatesBadEventCount,NoIceCandidatesGoodEventCount:this.noIceCandidatesGoodEventCount,NoRelayIceCandidatesBadEventCount:this.noRelayIceCandidatesBadEventCount,NoRelayIceCandidatesGoodEventCount:this.noRelayIceCandidatesGoodEventCount,CameraInUseBadEventCount:this.cameraInUseBadEventCount,CameraInUseGoodEventCount:this.cameraInUseGoodEventCount,MicrophoneInUseBadEventCount:this.microphoneInUseBadEventCount,MicrophoneInUseGoodEventCount:this.microphoneInUseGoodEventCount,CameraFreezeStartEventCount:this.cameraFreezeStartEventCount,CameraFreezeEndEventCount:this.cameraFreezeEndEventCount,RetargetIncomingCount:this.retargetIncomingCount,RetargetOutgoingCount:this.retargetOutgoingCount,RetargetCompletedCount:this.retargetCompletedCount,RetargetRejectedCount:this.retargetRejectedCount,ReconnectAttemptedCount:this.reconnectAttemptedCount,ReconnectConnectedCount:this.reconnectConnectedCount,EscalationAttemptedCount:this.escalationAttemptedCount,EscalationCompletedCount:this.escalationCompletedCount,EscalationRejectedCount:this.escalationRejectedCount,CreationTime:this.getHpTimeFromMillis(this.creationTime),InitTime:this.getHpTimeFromMillis(this.creationTime),TerminationTime:this.getHpTimeFromMillis(this.terminationTime),CallDuration:this.getHpTimeFromMillis(this.getCurrentDuration()),InitialNegotiationType:this.initialNegotiationType||"none",InitialNegotiationCompleted:this.initialNegotiationCompleted,ActiveModalities:JSON.stringify(this.activeModalities),NegotiationCount:this.negotiationCount,RejectedNegotiationCount:this.rejectedNegotiationCount,MediaLegId:this.mediaLegId,MultiParty:this.multiParty,ErrorType:this.mediaError.type,ErrorDetail:this.mediaError.detail,TerminationReason:this.terminationReason,IncompatibleOffer:this.incompatibleOffer,DtmfSuccess:this.dtmfSuccess,DtmfFailure:this.dtmfFailure,Relay:this.relay?JSON.stringify(this.relay):"none",RelayManager:this.relayManagerTimers?JSON.stringify(this.relayManagerTimers):"none",AllowedAudioSend:this.allowedAudioSend,AllowedVideoSend:this.allowedVideoSend,AllowedScreensharingSend:this.allowedScreensharingSend,IceInitTime:this.getHpTimeFromMillis(this.iceInitTime),FinalAnswerTime:this.getHpTimeFromMillis(this.finalAnswerTime),IceConnectedStateTime:this.getHpTimeFromMillis(this.iceConnectedStateTime),UsedMicrophone:e.microphone,UsedSpeaker:e.speaker,UsedCamera:e.camera,DeviceSelectionChangeCount:this.deviceSelectionChangeCount,DevicesChangeCount:this.devicesChangeCount,DevicesPollChangeCount:this.devicesPollChangeCount,DevicesCount:this.devicesCount?JSON.stringify(this.devicesCount):"none",ETag:this.ETag||"",ConfigIds:this.configIds?Array.isArray(this.configIds)?this.configIds.join(","):this.configIds:"",CallMutedRatio:this.getDurationRatio(this.mute.elapsed),CallOsMuted:this.getHpTimeFromMillis(this.osMute.elapsed),CallHwSilent:this.getHpTimeFromMillis(this.hwSilent.elapsed),CallSwMuted:this.getHpTimeFromMillis(this.swMute.elapsed),CallSpeakerMuted:this.getHpTimeFromMillis(this.speakerMute.elapsed),CallIsSpeaking:this.getHpTimeFromMillis(this.isSpeaking.elapsed),NetworkRecvGood:this.networkRecv.getCount("Good")-1,NetworkRecvPoor:this.networkRecv.getCount("Poor"),NetworkRecvBad:this.networkRecv.getCount("Bad"),NetworkSendGood:this.networkSend.getCount("Good")-1,NetworkSendPoor:this.networkSend.getCount("Poor"),NetworkSendBad:this.networkSend.getCount("Bad"),NetworkRecvGoodRatio:this.getDurationRatio(this.networkRecv.getElapsed("Good")),NetworkRecvPoorRatio:this.getDurationRatio(this.networkRecv.getElapsed("Poor")),NetworkRecvBadRatio:this.getDurationRatio(this.networkRecv.getElapsed("Bad")),NetworkSendGoodRatio:this.getDurationRatio(this.networkSend.getElapsed("Good")),NetworkSendPoorRatio:this.getDurationRatio(this.networkSend.getElapsed("Poor")),NetworkSendBadRatio:this.getDurationRatio(this.networkSend.getElapsed("Bad")),DeviceEvents:JSON.stringify(this.deviceTelemetryEvents),DeviceList:JSON.stringify(this.deviceList),DeviceListDebug:JSON.stringify(this.deviceDebugStrings),VideoEffects:JSON.stringify(this.videoEffectsTelemetryEvents.items),AudioEffects:JSON.stringify(this.audioEffectsTelemetryEvents.items),PermissionStates:JSON.stringify(this.permissionStates),ReconnectAttempts:this.reconnectStats.getReport(),NetworkEvents:JSON.stringify(Lt(It(this.sessionDiagnostics?.getObjectRef().reconnect?.tmpRecords,this.configProvider.config.diagnostics.telemetryLimits.numNetworkEvents),"startTime",this.creationTime)),ReconnectInProgress:this.reconnectStats.isReconnecting(),TransportReconnectedCount:this.transportReconnectedCount,UFDs:JSON.stringify(this.ufds),MediaQosEnabled:this.mediaQosEnabled,PortRangeConfigured:this.portRangeConfigured,RollbackNegotiation:JSON.stringify(this.rollbackNegotiation),hardwareConcurrency:Cg.hardwareConcurrency,GPUName:Cg.unmaskedGlRenderer,Connection_Downlink:Ft(this.connectionDownlinkSeries.items,(e=>e)),Connection_EffectiveType:Ft(this.connectionEffectiveTypeSeries.items,(e=>e)),Connection_Rtt:Ft(this.connectionRttSeries.items,(e=>e)),Connection_SaveData:hO?.connection?.saveData,MediaByPassEnabled:!!this.configProvider.mediaConfig.mediaBypassEnabled,CallConstraints:JSON.stringify(this.configProvider.getCallConstraintsTelemetry()),DominantSpeaker:JSON.stringify(OM(this.sessionDiagnostics?.getObjectRef().dominantSpeaker,this.terminationTime))}}generateStatistics(e,t,i=!1){if(this.setMediaLegId(t.process()),"WebRtcMediaStats"!==e.type)throw new Error(`Unknown stats type - ${e.type}`);if(i){const e=this.deviceTelemetryEvents.length;this.deviceTelemetryEvents.splice(0,e-1),this.deviceDebugStrings=LA,this.audioEffectsTelemetryEvents.clear()}e.data.metrics=this.getReport();const n=this.sessionDiagnostics?.getObjectRef().statsErrors;if(n?.length)if(e.data.Extensions?.WebRTCStats?.statsErrors){const t=JSON.parse(e.data.Extensions.WebRTCStats.statsErrors);t.push(...n),e.data.Extensions.WebRTCStats.statsErrors=JSON.stringify(t)}else e.data.Extensions.WebRTCStats.statsErrors=JSON.stringify(n);const r={};return nt(e.data,((e,t,i)=>{let n=0;pO.test(e)?(n=13,r[t]="IPv4"):gO.test(e)&&(n=4,r[t]="IPv6"),i[t]={type:n,value:e,__VALUE__:!0}})),e.data.metrics.piiFields={type:0,value:JSON.stringify(r),__VALUE__:!0},e}registerTransportConnected(){this.transportDisconnected&&(this.transportDisconnected=!1,this.transportReconnectedCount++)}registerTransportDisconnected(){this.transportDisconnected=!0}registerTransportFailed(){this.transportDisconnected=!1}resetError(){this.setError({type:"none",detail:"none"})}offering(){return{started:()=>{this.currentNegotiationType="Offering",this.negotiationStarted()}}}answering(){return{started:()=>{this.currentNegotiationType="Answering",this.negotiationStarted()}}}negotiationStarted(){this.initialNegotiationType=this.initialNegotiationType||this.currentNegotiationType,++this.negotiationCount}current(){return{completed:e=>{this.initialNegotiationCompleted=!0,this.activeModalities=e,this.resetError()},rejected:()=>{++this.rejectedNegotiationCount}}}getDurationRatio(e){const t=this.getCurrentDuration();return e/(0!==t?t:1)}getCurrentDuration(){return this.durationTimer.elapsed}getHpTimeFromMillis(e){return 1e4*e}},fO=class{constructor(e,t,i,n){this.onActiveSpeakersChanged=e,this.onDominantSpeakersChanged=t,this.diagnostics=i,this.logger=n}setStrategy(e){this.disposeStrategy(),this.dshStrategy=e,this.dshStrategy?.setOnDominantSpeakerChanged(this.onDominantSpeakerHistoryChanged.bind(this)),this.diagnostics?.setCurrentActiveStrategy("client")}onContributingSourcesChanged(e){this.onActiveSpeakersChanged(e),this.dshStrategy?.setSources(e)}onDominantSpeakerHistoryChanged(e,t){this.onDominantSpeakersChanged(e),this.diagnostics?.recordHistoryEvent(e,t),"client"!==t&&this.dshStrategy&&(this.logger.safe.info("Disposing client DSH strategy and switching to MP provided DSH"),this.disposeStrategy())}dispose(){this.disposeStrategy(),this.onActiveSpeakersChanged=null,this.onDominantSpeakersChanged=null}disposeStrategy(){this.dshStrategy?.dispose(),this.dshStrategy=null}},SO=4294967040,vO=class{constructor(){this.ssrc=Math.floor(4294967039*Math.random())+1}nextAudioStreamSsrc(){return this.nextSsrc(0)}nextVideoStreamSsrc(){return this.nextSsrc(99)}nextSsrc(e){let t=this.ssrc;do{t=this.ssrc,this.ssrc=(this.ssrc+e+1)%SO,0===this.ssrc&&(this.ssrc=1)}while(t+e>SO);return{min:t,max:t+e}}},yO=class{};yO.SourceNone=-1,yO.SourceAny=-2;var CO=class{constructor(e){this.listener=e,this.streams=[]}add(e){this.streams.some((t=>t.getId()===e.getId()))||(this.streams.push(e),this.listener.streamAdded(e))}remove(e){let t;ot(this.streams,(i=>i.getId()===e&&(t=i,!0)))&&this.listener.streamRemoved(t)}getStreams(){return this.streams}clear(){this.streams.forEach((e=>e.dispose())),this.streams=[]}},TO=class{constructor(e){this.subscription=e}get subscribedStream(){return this.subscription.stream?.getMediaStream()}get msi(){return this.checkDisposed(),this.subscription.msi}get modality(){return this.checkDisposed(),this.subscription.modality}get localMsi(){return this.checkDisposed(),this.subscription.localMsi}setOnMediaStreamChangedHandler(e){this.checkDisposed(),this.mediaStreamChanged=e,this.subscription.isStreamReady&&this.notifyMediaStreamChanged()}setOnErrorHandler(e){this.checkDisposed(),this.error=e}dispose(){this.subscription&&(this.subscription.dispose(Re(),this),this.subscription=null)}unsubscribe(){this.subscription&&(this.subscription.unsubscribe(),this.subscription=null)}notifyMediaStreamChanged(){if(this.mediaStreamChanged){const e=this.subscription.stream,t=this.subscription.isStreamReady;this.mediaStreamChanged(e&&t?e.getMediaStream():null)}}notifyError(e){this.error&&this.error(e)}checkDisposed(){if(!this.subscription)throw new Error("subscription disposed")}},EO=class extends Qe{constructor(e,t,i){super(),this.modality=e,this.msi=t,this.disposeDelay=i,this.clients=[],this.streamReady=!1}createClient(){const e=new TO(this);return this.clients.push(e),e}get isStreamReady(){return this.streamReady}get localMsi(){return this.subStream?.getSourceStreamId()}get isInactive(){return!this.clients.length}get stream(){return this.subStream}set stream(e){try{if(e===this.subStream)return;this.subStream&&(this.unsubscribe(!1),this.notifyStreamChanged()),this.subStream=e,e&&(this.streamReady=!1,e.requestSource(this.msi).then((()=>{this.streamReady=!0,this.notifyStreamChanged()})).catch((e=>{this.notifyError(e)})))}catch(e){this.event("onFailed").raise(this,e)}}notifyError(e){this.clients.forEach((t=>{t.notifyError(e)})),this.event("onFailed").raise(this,e)}dispose(e,t){t?(ot(this.clients,(e=>e===t)),this.isInactive&&(this.disposeTimeout=window.setTimeout((()=>{this.disposeTimeout=null,this.unsubscribeIfInactive()}),this.disposeDelay))):(this.clients=[],this.unsubscribe())}unsubscribeIfInactive(){this.isInactive&&(this.disposeTimeout&&clearTimeout(this.disposeTimeout),this.unsubscribe())}unsubscribe(e=!0){this.subStream&&(this.subStream.requestSource(yO.SourceNone).catch((()=>{})),this.streamReady=!1,this.subStream=null),e&&this.event("onDisposed").raise(this)}notifyStreamChanged(){this.clients.forEach((e=>e.notifyMediaStreamChanged())),this.event("onStreamChanged").raise()}},_O=class extends Qe{constructor(e,t,i,n){super(e),this.configProvider=t,this.diagnostics=n,this.videoSubscriptions=[],this.subscriptionEvents=new Map,this.setLogger(e),this.diagnostics??(this.diagnostics=new nR(this.configProvider,(()=>{}))),this.setStreamProvider(i),this.logger.safe.info("created")}getSubscriptionsCount(){return this.videoSubscriptions.length}setStreamProvider(e){this.streamProvider=e,this.streamProvider.setOnStreamsChangedHandler((()=>this.streamsChanged()))}setLogger(e){this.logger=e}subscribeVideo(e,t=yO.SourceAny){let i=this.videoSubscriptions.find((i=>i.msi===t&&i.modality===e));if(!i){const n=Date.now();this.disposeInactiveSubscriptionIfNeeded(e);const r=this.getAvailableStream(e),s=r?.getSourceStreamId();this.logger.safe.info(`creating new subscription #${t} for modality ${e}`),this.event("onSubscriptionChanged").raise(1,e,t,s,null),this.diagnostics.addSubscribe(e,t,s),i=new EO(e,t,this.configProvider.config.webrtcVideoSubscriptionDisposeTimeout);const a=[];a.push(i.on("onDisposed",(e=>this.onSubscriptionDisposed(e)))),a.push(i.on("onStreamChanged",(()=>{const r=i.stream?.getId(),s=i.localMsi;if(this.updateTrackIds(),i.isStreamReady){const i=Date.now();this.event("onSubscriptionChanged").raise(2,e,t,s,i-n,r),this.diagnostics.addSubscribed(e,t,s,i-n)}}))),a.push(i.on("onFailed",((e,t)=>this.onSubscriptionFailed(e,t)))),this.subscriptionEvents.set(i,a),this.videoSubscriptions.push(i),r&&this.assignStream(i,r)}return i.createClient()}dispose(){const e=Re();this.videoSubscriptions.concat().forEach((t=>t.dispose(e))),this.streamProvider.setOnStreamsChangedHandler(null),super.dispose(),this.logger.safe.info("disposed")}reriseSubscribeEvents(){this.logger.safe.info(`rerising subscription events: ${this.videoSubscriptions.length}`);const e=[];this.videoSubscriptions.forEach((t=>{const i=t.modality,n=t.msi,r=t.localMsi;this.event("onSubscriptionChanged").raise(1,i,n,r),this.diagnostics.addSubscribe(i,n,r),e.push(...this.getSubscriptionVideoTrackIds(t))})),this.diagnostics.subscribedTrackIds=e}setDiagnostics(e){this.diagnostics=e??new nR(this.configProvider,(e=>{this.logger.safe.warn(`Unhandled stats error from inactive subscription manager: ${e}`)}))}streamChangedByMsi(e){this.logger.safe.info(`streams changed, subscriptions active: ${this.videoSubscriptions.length}`);const t=this.videoSubscriptions.find((t=>t.msi===e));t?this.assignSubscriptionToStream(t):this.logger.safe.error(`Subscription for msi ${e} not found`)}streamsChanged(){this.logger.safe.info(`streams changed, subscriptions active: ${this.videoSubscriptions.length}`),this.videoSubscriptions.forEach((e=>{this.assignSubscriptionToStream(e)}))}assignSubscriptionToStream(e){const t=!e.stream||this.isStreamRemoved(e.stream);if(this.logger.safe.info(`Subscription for ${e.modality} ${e.msi} needs new stream: ${t}`),!t)return;const i=this.getAvailableStream(e.modality);i?this.assignStream(e,i):this.resignStream(e)}getAvailableStream(e){return this.streamProvider.getStreams().find((t=>e===t.getModality()&&t.getMsi()===yO.SourceNone))}isStreamRemoved(e){return!this.streamProvider.getStreams().some((t=>t===e))}assignStream(e,t){this.logger.safe.info(`assigning stream #${t.getId()} to subscription #${e.msi}`),e.stream=t}resignStream(e){e.stream&&(this.logger.safe.info(`removing stream from subscription #${e.msi}`),e.stream=null)}disposeInactiveSubscriptionIfNeeded(e){this.getAvailableStream(e)||this.videoSubscriptions.find((t=>t.modality===e&&t.isInactive))?.unsubscribeIfInactive()}onSubscriptionDisposed(e){const t=Re(),i=e.modality,n=e.msi,r=e.localMsi;this.event("onSubscriptionChanged").raise(3,i,n,r),this.diagnostics.addUnsubscribe(i,n,r),this.logger.safe.info(`disposing subscription for ${i} #${n}`),ot(this.videoSubscriptions,(t=>t===e)),this.streamsChanged(),this.updateTrackIds(),this.subscriptionEvents.has(e)&&(this.subscriptionEvents.get(e).forEach((e=>e.dispose(t))),this.subscriptionEvents.delete(e))}updateTrackIds(){const e=[],t=[];this.videoSubscriptions.forEach((i=>{if(!i.isStreamReady)return;const n=i.stream?.getId().split("-")[1];t.push(n),e.push(...this.getSubscriptionVideoTrackIds(i))})),this.event("onTrackIdsChanged").raise(e),this.diagnostics.subscribedTrackIds=e,this.configProvider.config.subscribeToSsrcForVideo&&this.event("onTrackSsrcChanged").raise(t)}getSubscriptionVideoTrackIds(e){return e?.stream?.getMediaStream()?.getVideoTracks().map((e=>e.id))??[]}onSubscriptionFailed(e,t){this.event("onSubscriptionFailed").raise(-1,e.modality,e.msi,e.localMsi,t),this.diagnostics.addFailed(e.modality,e.msi,e.localMsi,Ge(t))}},bO=T(be()),PO=class{constructor(e,t,i){this.logger=e,this.qualityManager=t,this.configProvider=i}getControlItem(){return this.controlItem}setControlItem(e){this.controlItem=e}dispose(){this.controlItem=null}setVideoControlMessage(e){this.controlItem=this.messageToControlItem(e),this.logger.safe.info(`BW limit requested to ${this.controlItem.bandwidth}`)}modifyDescriptor(e){if(!this.controlItem)return e;const t=bO.parse(e.sdp);if(!t.media[1])return this.logger.unsafe.warn("video modality is disabled, skipping sdp modification, ",e),e;const i=this.getCurrentResolutionBitrate();this.logger.safe.info(`Select the BW limit as min of requested ${this.controlItem.bandwidth} and Current Resolution Max BR ${i}`);const n=this.getSessionBitrate(t),r=Math.min(i,this.controlItem.bandwidth,n);if(t.media[1].bandwidth)t.media[1].bandwidth[0].limit=r;else{const e={limit:r,type:"AS"};t.media[1].bandwidth=[e]}return e.sdp=bO.write(t),e}messageToControlItem(e){const t=new hR(e.controlVideoStreaming.controlInfo[0].fmtParams),i="max-br";if(!t.contains(i))return null;const n=Math.round(1.2*+t.get(i));return{sourceId:e.controlVideoStreaming.controlInfo[0].sourceId,streamMsid:e.controlVideoStreaming.controlInfo[0].streamMsid,bandwidth:n}}getCurrentResolutionBitrate(){const e=this.qualityManager.getCurrentResolution(),t=NI.Send.getResolutionByFs(e);return e&&t?Math.floor(NI.Send.getBitrateForResolution(t.width,t.height).maxBitrate/1e3):Number.MAX_VALUE}getSessionBitrate(e){let t=Number.MAX_SAFE_INTEGER;return this.configProvider.mediaConfig.maxBandwidthInKbps&&(t=this.configProvider.mediaConfig.maxBandwidthInKbps),e.bandwidth&&(t=Math.min(e.bandwidth[0].limit,t)),t-(this.configProvider.config.audioBandwidthInKbps||0)}},IO=class{constructor(e,t,i){this.pc=e,this.configProvider=t,this.logger=i.createChild("MediaRollbackModifier")}modifyDescriptor(e){const t=bO.parse(e.sdp);return bO.parse(this.pc.localDescription.sdp).media.forEach(((e,i)=>{const n=t.media[i];(AR(e)&&!e.bundleOnly||!n||AR(n))&&(this.logger.safe.info(`Adding disabled media ${e.type}, position ${i}`),t.media[i]=Yw(e.type,void 0,e.protocol,void 0))})),new Ow(this.configProvider).modify(t),e.sdp=bO.write(t),e}},AO=class{constructor(e){this.manager=null,this.extensionType=e}initialize(e){e.manager&&(this.manager=e.manager),e.logger&&(this.logger=e.logger.createChild(this.extensionType)),e.configProvider&&(this.configProvider=e.configProvider)}dispose(){this.manager&&(this.manager=null),this.logger&&(this.logger.safe.info("disposed"),this.logger=this.logger.createChild("DISPOSED"))}configure(e){this.options=e}getOptions(){return this.options}getType(){return this.extensionType}},RO=class extends AO{constructor(){super("dominantSpeakerHistory"),this.callback=null}initialize(e){super.initialize(e),this.extensionManagerSubscription=this.manager.on("onDominantHistoryMessage",((e,t)=>this.onDominantHistoryMessage(e,t))),e&&e.callback&&(this.callback=e.callback)}dispose(){this.extensionManagerSubscription.dispose(),this.extensionManagerSubscription=null,this.callback=null,super.dispose()}onDominantHistoryMessage(e,t){this.callback&&("server"===t?this.callback(e.history,t):"signaling"===t&&this.callback(e.previousDominantSpeakerHistory,t))}},wO=class{constructor(e,t,i,n,r,s){this.logger=e,this.emulator=t,this.qualityManager=i,this.diagnostics=n,this.configProvider=r,this.statsGatherer=s,this.previousSequenceNumber=new Map,this.modifiers=this.configProvider.mediaConfig.simulcastSessionEnabled?[]:[new PO(this.logger.createChild("rembModifier"),this.qualityManager,this.configProvider)]}dispose(){this.cleanupDevToolsInjector(),this.modifiers&&(this.modifiers.forEach((e=>e.dispose())),this.modifiers=null),this.emulator=null,this.logger=this.logger.createChild("DISPOSED")}handleMessage(e){const t=e.controlInfo[0].sourceId;if(this.previousSequenceNumber.has(t)&&e.sequenceNumber<this.previousSequenceNumber.get(t))return this.statsGatherer.addVideoControlMessage(!0),this.diagnostics?.addVideoControlMessage(!0),this.logger.safe.info(`Discarded old media stream control message for sourceId ${t}: (${JSON.stringify(e)})`),Promise.resolve();this.previousSequenceNumber.set(t,e.sequenceNumber),this.statsGatherer.addVideoControlMessage(),this.diagnostics?.addVideoControlMessage(),this.configProvider.config.enableDevtoolsAPI&&this.injectFmtpHandler(e);const i={controlVideoStreaming:e};return this.configureResolution(i),this.modifiers.length?(this.modifiers.forEach((e=>e.setVideoControlMessage(i))),this.emulator.renegotiate(this.modifiers)):Promise.resolve()}configureResolution(e){this.logger.safe.info(`Signaling FMTP: ${JSON.stringify(e.controlVideoStreaming)}`);const t=String(e.controlVideoStreaming.sequenceNumber),i=e.controlVideoStreaming.controlInfo[0].fmtParamsList,n=e.controlVideoStreaming.controlInfo[0].fmtParams,r=i&&this.configProvider.config.webrtcFmtParamListSupported?this.parseFmtParamsList(i):[this.parseFmtParams(n)],s=+e.controlVideoStreaming.controlInfo[0].sourceId,a=[{causeId:t,isSimulcast:r.some((e=>void 0!==e.rid))||r.length>1,capabilities:r,sourceId:s}];this.qualityManager.setMaxCapabilities(a)}parseFmtParamsList(e){return e.map((e=>this.parseFmtParams(e)))}parseFmtParams(e){const t=new hR(e);return{maxFs:+t.get(tt.VIDEO_CAPABILITIES.MAX_FS_PATH),maxMbps:+t.get(tt.VIDEO_CAPABILITIES.MAX_MBPS_PATH),maxFps:+t.get(tt.VIDEO_CAPABILITIES.MAX_FPS_PATH)/100,maxBr:1200*+t.get(tt.VIDEO_CAPABILITIES.MAX_BR_PATH),ssrc:+t.get(tt.VIDEO_CAPABILITIES.SSRC_PATH),rid:t.get(tt.VIDEO_CAPABILITIES.RID_PATH),keyframe:this.shouldGenerateKeyFrame(t),vlaDebug:t.get(tt.VIDEO_CAPABILITIES.VLA_DEBUG)}}shouldGenerateKeyFrame(e){return e.get(tt.VIDEO_CAPABILITIES.KEYFRAME_PATH)?!!+e.get(tt.VIDEO_CAPABILITIES.KEYFRAME_PATH):this.configProvider.config.webrtcAllowRestoreKeyframe}injectFmtpHandler(e){const t=window;t&&t.webMA&&(t.webMA.fmtp||(t.webMA.fmtp={handleMessage:this.handleMessage.bind(this)}),t.webMA.fmtp.lastFmtp=e)}cleanupDevToolsInjector(){const e=window;e&&e.webMA&&delete e.webMA.fmtp}},MO=class{constructor(){this.sequence=0}getVideoControlMessage(e,t,i){const n={controlVideoStreaming:{sequenceNumber:++this.sequence,globalTimeStamp:(new Date).toString(),controlInfo:[{control:"start",sourceId:t,streamMsid:e}]}};return i&&(n.controlVideoStreaming.controlInfo[0].fmtParams=cR(i)),n}getSourceRequestMessage(e,t,i,n,r){if(!n)throw new Error("Failed to construct SourceRequestMessage, missing fmtParams");const s={sourceId:t,streamMsid:e,fmtParams:n};return s.subStreamIndex=r,{applyChannelParameters:{multiChannelParameter:{mids:[i],mediaParameter:JSON.stringify({controlVideoStreaming:{sequenceNumber:++this.sequence,controlInfo:s}})}}}}getBandwidthInfoMessage(e,t){return{applyChannelParameters:{multiChannelParameter:{mids:e,mediaParameter:JSON.stringify({remoteUplinkBWE:{bw:t.toString()}})}}}}getMaxVideoSendCapabilitiesMessage(e){function t(e){return 16*Math.ceil(e/16)}const{streamMIDs:i,capabilities:n,useMax:r,sendMaxFs:s,sendMaxMbps:a}=e;let o=t(n.maxWidth),l=t(n.maxHeight);r&&(o=l=Math.max(o,l));const d={[tt.VIDEO_CAPABILITIES.MAX_FPS_PATH]:n.maxFps,[tt.VIDEO_CAPABILITIES.MAX_WIDTH]:o,[tt.VIDEO_CAPABILITIES.MAX_HEIGHT]:l};return s&&(d[tt.VIDEO_CAPABILITIES.MAX_FS_PATH]=n.maxFs),a&&(d[tt.VIDEO_CAPABILITIES.MAX_MBPS_PATH]=n.maxMbps),{applyChannelParameters:{multiChannelParameter:{mids:i,mediaParameter:JSON.stringify({maxVideoSendCapabilities:{caps:d}})}}}}},OO=class{constructor(e){this.logger=e}dispose(){this.sender=null}configure(e){this.sender=e.sender}async sendMessage(e,t){if(!this.checkConfigured())return this.logger.safe.warn("extension not configured with sender"),null;let i,n;return"ApplyChannelParametersSourceRequest"===e&&(i=JSON.parse(t.applyChannelParameters.multiChannelParameter.mediaParameter),n=i.controlVideoStreaming.sequenceNumber),this.logger.safe.info(`sending video control message: ${JSON.stringify(t)}`),this.sender.send(e,t,i,n)}checkConfigured(){return!!this.sender}},DO=class extends AO{constructor(){super("videoStreamControl"),this.messageGenerator=new MO}initialize(e){super.initialize(e),this.subscribeListeners(),this.sourceRequester=new OO(e.logger),this.streamConfigurationHandler=new wO(e.logger,e.negotiationEmulator,e.qualityManager,e.diagnostics,e.configProvider,e.statisticsGatherer)}configure(e){super.configure(e),this.sourceRequester.configure(e)}sendSourceRequest(e,t,i,n,r){if(this.configProvider?.config.useApplyChannelParametersForSourceRequests){const s=this.messageGenerator.getSourceRequestMessage(e,t,i,n,r);return this.sourceRequester.sendMessage("ApplyChannelParametersSourceRequest",s)}const s=this.messageGenerator.getVideoControlMessage(e,t,n?.[0]);return this.sourceRequester.sendMessage("ControlVideoStreaming",s)}sendBandwidthInfo(e,t){const i=this.messageGenerator.getBandwidthInfoMessage(e,t);return this.sourceRequester.sendMessage("ApplyChannelParametersBandwidth",i)}sendMaxVideoSendCapabilities(e,t){const i=this.messageGenerator.getMaxVideoSendCapabilitiesMessage({streamMIDs:e,capabilities:t,sendMaxFs:this.configProvider.config.maxSendVideoCapabilitiesReportingSendMaxFs,sendMaxMbps:this.configProvider.config.maxSendVideoCapabilitiesReportingSendMaxMbps,useMax:this.configProvider.config.maxSendVideoCapabilitiesReportingUseMaximumWidthHeight});return this.sourceRequester.sendMessage("ApplyChannelParametersVideoCapabilities",i)}dispose(){this.unsubscribeListeners(),this.streamConfigurationHandler&&(this.streamConfigurationHandler.dispose(),this.streamConfigurationHandler=null),this.sourceRequester&&(this.sourceRequester.dispose(),this.sourceRequester=null),super.dispose()}onMediaStreamControlMessage(e){this.streamConfigurationHandler.handleMessage(e)}subscribeListeners(){this.extensionManagerSubscription=this.manager.on("onMediaStreamControlMessage",(e=>this.onMediaStreamControlMessage(e)))}unsubscribeListeners(){this.extensionManagerSubscription.dispose(),this.extensionManagerSubscription=null}},kO=class extends AO{constructor(){super("bandwidthTelemetry")}initialize(e){super.initialize(e),this.statisticsGatherer=e.statisticsGatherer,this.diagnostics=e.diagnostics,this.extensionManagerSubscription=this.manager.on("onBandwidthMessage",(e=>this.onBandwidthMessage(e)))}dispose(){super.dispose(),this.extensionManagerSubscription.dispose(),this.extensionManagerSubscription=null}onBandwidthMessage(e){this.statisticsGatherer.addReportedReceiveBandwidth(e.bw),this.diagnostics.addReportedReceiveBandwidth(e.bw)}},NO=class{constructor(e){this.key=e.config.bwSeedOptions.localStorageKey||"bwSeed";const t=localStorage.getItem(this.key);parseInt(t)||localStorage.setItem(this.key,e.config.bwSeedOptions.constValue.toString())}getSeed(){const e=localStorage.getItem(this.key),t=parseInt(e);return isNaN(t)?void 0:t}saveSeed(e){localStorage.setItem(this.key,e.toString())}static localStorageAvailable(){try{const e=window.localStorage,t="someKey",i="someValue";return e.setItem(t,i),e.removeItem(t),!0}catch(e){return!1}}},LO=class e{constructor(t){e.value??(e.value=t.config.bwSeedOptions.constValue)}getSeed(){return e.value}saveSeed(t){e.value=t}},xO=class{constructor(e){this.value=e}addValue(e){}getAggregated(){return this.value}},FO=class{addValue(e){this.value=e}getAggregated(){return this.value}},UO=class{constructor(e){this.values=new zA(e)}addValue(e){this.values.add(e)}getAggregated(){return Math.floor(at(this.values.items))}},VO=class{constructor(){this.total=0,this.duration=0,this.max=0,this.minNonZero=Number.MAX_SAFE_INTEGER}get avg(){return 0!==this.duration?this.total/this.duration:0}get maxSample(){return this.max}get minNonZeroSample(){return this.minNonZero}captureSample(e){(e||0===e)&&(this.total+=e,this.duration++,this.max=Math.max(e,this.max),0!==e&&(this.minNonZero=Math.min(e,this.minNonZero)))}},HO=class{constructor(){this.sampleCounts={}}get min(){const e=Object.keys(this.sampleCounts).map(Number).filter((e=>e>0));return e.length>0?Math.min(...e):0}get max(){const e=Object.keys(this.sampleCounts).map(Number);return e.length>0?Math.max(...e):0}get mode(){const e=Object.keys(this.sampleCounts).map(Number);return e.length>0?e.reduce(((e,t)=>this.sampleCounts[t]>this.sampleCounts[e]?t:e),e[0]):0}captureSample(e){var t;if(void 0!==e){const i=`${e}`;(t=this.sampleCounts)[i]??(t[i]=0),this.sampleCounts[i]++}}},BO=class{get delta(){if(void 0!==this.cur&&void 0!==this.last)return this.cur-this.last}captureSample(e,t){void 0!==e&&(void 0!==this.cur&&(this.last=this.cur),this.cur=e)}},$O=class{constructor(e=0){this.precision=e}get delta(){if(void 0!==this.currentSample&&void 0!==this.prevSample){let e=1;return void 0!==this.currentTimestamp&&void 0!==this.prevTimestamp&&(e=(this.currentTimestamp-this.prevTimestamp)/1e3),e&&bt((this.currentSample-this.prevSample)/e,this.precision)}}captureSample(e,t){if(this.currentTimestamp!==t){if(void 0===e)return this.prevSample=void 0,this.currentSample=void 0,this.prevTimestamp=void 0,void(this.currentTimestamp=void 0);void 0!==this.currentSample&&(this.prevSample=this.currentSample),this.prevTimestamp=this.currentTimestamp,this.currentTimestamp=t,this.currentSample=e}}},jO=class{constructor(){this.startTime=Date.now()}get elapsed(){return bt((Date.now()-this.startTime)/1e3,0)}},GO=class{constructor(){this.eventCount=0,this.totalActiveDuration=0,this.countBuckets={seconds1to3:0,seconds3to5:0,seconds5to8:0,seconds8to15:0,seconds15to60:0,seconds60toMax:0},this.timestampBuckets={seconds1to3:[],seconds3to5:[],seconds5to8:[],seconds8to15:[],seconds15to60:[],seconds60toMax:[]},this.averager=new VO}get active(){return!!this.current}get ongoingDuration(){return this.current?.elapsed||0}get avgDuration(){return this.averager.avg}get longestDuration(){return this.averager.maxSample}get numEvents(){return this.eventCount}get totalDuration(){return this.current?this.totalActiveDuration+this.current.elapsed:this.totalActiveDuration}get timestamps(){return ut(this.timestampBuckets)}get counts(){return ut(this.countBuckets)}set active(e){if(!this.current&&e)this.current=new jO;else if(this.current&&!e){const e=this.current.elapsed;this.averager.captureSample(e),this.totalActiveDuration+=e;for(const t of Object.keys(tt.HISTOGRAM_BATCH))if(e<=tt.HISTOGRAM_BATCH[t]){this.countBuckets[t]++,this.timestampBuckets[t].push(this.current.startTime);break}this.eventCount++,this.current=void 0}}},WO=class{constructor(){this.sampleChangeCount=0,this.sampleDurations={}}get durations(){return ut(this.sampleDurations)}get sortedDurations(){return Object.keys(this.sampleDurations).sort(((e,t)=>this.sampleDurations[t]-this.sampleDurations[e]))}get durationRatios(){const e={};let t=0;for(const e in this.sampleDurations)t+=this.sampleDurations[e];for(const i in this.sampleDurations)e[i]=bt(this.sampleDurations[i]/t*100);return e}get changeCount(){return this.sampleChangeCount}captureSample(e){this.sampleDurations[e]||(this.sampleDurations[e]=0),this.sampleDurations[e]++,e!==this.lastSample&&(this.sampleChangeCount++,this.lastSample=e)}},qO=class{constructor(e,t){this.validTimeBetweenFramesArrival=e,this.invalidFPSAboveMax=t,this.lastSampleTimestamp=-1,this.fpsHarmonicSumWeigtsTs=0,this.fpsHarmonicWeigtedSumsFramePerDelayTs=0}captureSample(e){const t=Date.now();if(e>0&&this.lastSampleTimestamp>0){const i=t-this.lastSampleTimestamp;if(this.lastSampleTimestamp=t,i<0||i>this.validTimeBetweenFramesArrival||e>this.invalidFPSAboveMax)return;const n=i/e;this.fpsHarmonicSumWeigtsTs+=i,this.fpsHarmonicWeigtedSumsFramePerDelayTs+=i*n}(this.lastSampleTimestamp<0||0===e)&&(this.lastSampleTimestamp=t)}get harmonicMean(){return this.fpsHarmonicWeigtedSumsFramePerDelayTs>0?1e3*this.fpsHarmonicSumWeigtsTs/this.fpsHarmonicWeigtedSumsFramePerDelayTs:0}},zO=class{constructor(e){this.samplesNum=e,this.samples=[],this.lastReport={avg:-1,max:-1,median:-1,volatilityPercent:-1}}isReportComplete(){return this.samples.length===this.samplesNum}getReport(){return this.lastReport}captureSample(e){void 0===e||e<0||(At(this.samples,e,this.samplesNum),this.lastReport={avg:this.getAvg(),max:this.getMax(),median:this.getMedian(),volatilityPercent:this.getVolatility()})}getAvg(){return at(this.samples)}getMax(){return Math.max(...this.samples)}getMedian(){return this.samples.sort(((e,t)=>e-t)),this.samples.length%2==1?this.samples[Math.floor(this.samples.length/2)]:(this.samples[this.samples.length/2]+this.samples[this.samples.length/2-1])/2}getVolatility(){const e=this.getAvg();if(0===e)return 0;let t=0;return this.samples.forEach((i=>{t+=Math.abs(i-e)})),bt(t/this.samples.length*100/e,2)}},KO=class{constructor(){this.duration=0,this.reportAggr={avg:0,max:0,median:0,volatilityPercent:0}}captureSample(e){!e||e.avg<0||(this.reportAggr={avg:this.reportAggr.avg+e.avg,max:Math.max(this.reportAggr.max,e.max),median:this.reportAggr.median+e.median,volatilityPercent:this.reportAggr.volatilityPercent+e.volatilityPercent},this.duration++)}getReport(){if(0!==this.duration)return{avg:this.reportAggr.avg/this.duration,max:this.reportAggr.max,median:this.reportAggr.median/this.duration,volatilityPercent:this.reportAggr.volatilityPercent/this.duration}}},JO=class{constructor(e=0){this.allowedOvershoot=e,this.past=[],this.totalOvershootDuration=0,this.lastAllowed=0}get isOvershooting(){return!!this.current}get events(){return this.current?[...this.past,this.current]:this.past}get totalDuration(){return this.totalOvershootDuration}captureSample(e,t){const i=bt(e-t);i>this.allowedOvershoot&&(0===this.lastAllowed||t===this.lastAllowed||!this.current&&t>this.lastAllowed)?(this.totalOvershootDuration++,this.current?(this.current.min=Math.min(this.current.min,i),this.current.max=Math.max(this.current.max,i)):this.current={timestamp:Date.now(),min:i,max:i}):this.current&&(this.current.duration=Date.now()-this.current.timestamp,this.past.push(this.current),this.current=void 0),this.lastAllowed=t}},YO=class{constructor(e=100){this.minPackets=e,this.prevLost=0,this.prevReceived=0}calculate(e,t){if(void 0===e||void 0===t)return;const i=e-this.prevReceived,n=t-this.prevLost;return i+n<this.minPackets?void 0:(this.prevReceived=e,this.prevLost=t,n*this.minPackets/(n+i))}},QO=class{constructor(){this.capturedSamples=[]}captureSample(e){e&&this.capturedSamples.push(e)}calculateStd(){if(!this.capturedSamples.length)return;const e=this.capturedSamples.reduce(((e,t)=>e+t),0)/this.capturedSamples.length,t=this.capturedSamples.map((t=>(t-e)**2)),i=t.reduce(((e,t)=>e+t),0)/t.length;return bt(Math.sqrt(i),2)}getFirst(){return this.capturedSamples[0]}getLast(){if(this.capturedSamples.length)return this.capturedSamples[this.capturedSamples.length-1]}calculatePercentile(e){if(!this.capturedSamples.length)return;const t=this.capturedSamples.sort(((e,t)=>e-t)),i=(t.length-1)*e,n=Math.floor(i),r=i-n;return void 0!==t[n+1]?t[n]+r*(t[n+1]-t[n]):t[n]}};function XO(e){if(!e)return;const t=["libvpx","ffmpeg"];let i=!0;for(const n of t)if(e.toLowerCase().includes(n)){i=!1;break}return i}var ZO=class{constructor(e){this.samplesCount=e,this.capturedSamples=[]}captureSample(e){void 0!==e&&At(this.capturedSamples,e,this.samplesCount)}getRate(){if(!this.capturedSamples.length)return;const e=this.samplesCount/this.capturedSamples.length;return this.capturedSamples.reduce(((e,t)=>e+t))*e/this.samplesCount}},eD=class{constructor(e=5){this.limit=e,this.curWidth=0,this.curHeight=0,this.resolutionSwitches=[]}captureSample(e,t){e===this.curWidth&&t===this.curHeight||(At(this.resolutionSwitches,`${e}x${t}`,this.limit),this.curWidth=e,this.curHeight=t)}get switches(){if(this.resolutionSwitches.length)return this.resolutionSwitches}};function tD(e,t,i){return e&&t?Math.ceil(e/tt.MACROBLOCK_SIZE)*Math.ceil(t/tt.MACROBLOCK_SIZE)*i:0}var iD=class{constructor(){this.macroblockRateAveragerReceived=new VO,this.macroblockRateAveragerDecoded=new VO,this.maxDecoderLoss=0,this.decoderLoss=0}captureSample(e,t){this.macroblockRateAveragerReceived.captureSample(e),this.macroblockRateAveragerDecoded.captureSample(t);let i=this.maxDecoderLoss;e&&(i=(e-t)/e*100),this.decoderLoss=i,this.maxDecoderLoss=Math.max(i,this.maxDecoderLoss)}getReport(){return{macroblockRateReceivedMax:this.macroblockRateAveragerReceived.maxSample,macroblockRateReceivedAvg:this.macroblockRateAveragerReceived.avg,macroblockRateDecodedMax:this.macroblockRateAveragerDecoded.maxSample,macroblockRateDecodedAvg:this.macroblockRateAveragerDecoded.avg,macroblockRateMaxDecoderLossPercent:Math.floor(this.maxDecoderLoss),macroblockRateDecoderLossPercent:Math.floor(this.decoderLoss)}}},nD=class{constructor(){this.codecReport={}}captureSample(e,t){var i,n;const r=e.split("/")[1];return void 0===this.activeMsi||this.activeMsi!==t?(this.activeMsi=t,this.previousCodec=r,void((i=this.codecReport)[t]??(i[t]={[r]:1,codecSwitchCounter:0}))):this.previousCodec!==r?((n=this.codecReport[t])[r]??(n[r]=0),this.codecReport[t][r]++,this.codecReport[t].codecSwitchCounter++,void(this.previousCodec=r)):void this.codecReport[t][r]++}get report(){return this.codecReport}},rD=class{constructor(){this.bandwidthAverager=new VO}addValue(e){this.bandwidthAverager.captureSample(e)}getAggregated(){return Math.floor(this.bandwidthAverager.avg)}},sD=class{constructor(e){this.configProvider=e,this.aggregator=this.getAggregator(),this.storage=this.getStorage(),this.cappingValue=this.configProvider.config.bwSeedOptions.cappingValue,this.minValue=this.configProvider.config.bwSeedOptions.minValue??-1}getSeed(){const e=this.storage.getSeed()??-1;return this.cappingValue>0?Math.min(Math.max(e,this.minValue),this.cappingValue):Math.max(e,this.minValue)}saveSeed(e){this.aggregator.addValue(e);const t=this.aggregator.getAggregated();this.storage.saveSeed(t)}getAggregator(){switch(this.configProvider.config.bwSeedOptions.aggregation){case"avg":return this.configProvider.config.bwSeedOptions.aggregateLastN>0?new UO(this.configProvider.config.bwSeedOptions.aggregateLastN):new rD;case"last":return new FO;default:return new xO(this.configProvider.config.bwSeedOptions.constValue)}}getStorage(){return this.configProvider.config.bwSeedOptions.useLocalStorage&&NO.localStorageAvailable()?new NO(this.configProvider):new LO(this.configProvider)}},aD=class extends AO{constructor(){super("bandwidthCache")}initialize(e){super.initialize(e),this.bandwidthCache=new sD(e.configProvider),this.onBandwidthMessageSubscription=this.manager.on("onBandwidthMessage",(e=>{this.bandwidthCache.saveSeed(e.bw)}))}getBWSeed(){return this.bandwidthCache.getSeed()}dispose(){super.dispose(),this.onBandwidthMessageSubscription?.dispose(),this.onBandwidthMessageSubscription=null}},oD=class{static getExtension(e){switch(e){case"dominantSpeakerHistory":return new RO;case"videoStreamControl":return new DO;case"bandwidthTelemetry":return new kO;case"bandwidthCache":return new aD;default:throw new Error(`Extension of type ${e} is not found`)}}},lD=class extends Qe{constructor(e){super(e),this.logger=e,this.extensions=[]}dispose(){this.extensions.map((e=>e.dispose())),this.extensions=[],super.dispose()}addExtension(e,t){t.manager||(t.manager=this);const i=oD.getExtension(e);i.initialize(t),this.extensions.push(i)}getExtension(e){return this.extensions.find((t=>t.getType()===e))}configureExtension(e,t){this.getExtension(e)?.configure(t)}processNotification(e,t){switch(e){case"ControlVideoStreaming":this.event("onMediaStreamControlMessage").raise(t);break;case"DominantSpeakerInfo":this.event("onDominantHistoryMessage").raise(t,"signaling");break;case"McpDominantSpeakerInfo":this.event("onDominantHistoryMessage").raise(t,"server");break;case"BandwithNotification":this.event("onBandwidthMessage").raise(t);break;default:this.logger.safe.error(`Notification message handler not found for type: ${e}`)}}},dD=class{constructor(e,t){this.diagnostics=e,this.configProvider=t,this.recvExtenders=new Map,this.sendExtenders=new Map}processStats(e){if(!e)return;const t=new Set;if(e.send){this.diagnostics.handlePresentationAudioInputLevel();for(const i of e.send)try{t.add(i.outboundRTP.id);let e=this.sendExtenders.get(i.outboundRTP.id)??new uD(this.diagnostics,this.configProvider);i.outboundRTP.bytesSent<e.lastBytes&&(e=new uD(this.diagnostics,this.configProvider)),this.sendExtenders.set(i.outboundRTP.id,e),e.processSample(i)}catch(e){this.diagnostics.addStatsError("AudioStatsProcessor:send",Ge(e))}}if(Vt(this.sendExtenders,t),t.clear(),e.recv)for(const i of e.recv)try{t.add(i.inboundRTP.id);let e=this.recvExtenders.get(i.inboundRTP.id)??new cD(this.configProvider);i.inboundRTP.bytesReceived<e.lastBytes&&(e=new cD(this.configProvider)),this.recvExtenders.set(i.inboundRTP.id,e),e.processSample(i)}catch(e){this.diagnostics.addStatsError("AudioStatsProcessor:recv",Ge(e))}Vt(this.recvExtenders,t)}},cD=class{constructor(e){this.configProvider=e,this.useLastSampleDeltaPerSecondConverter=this.configProvider.config.diagnostics.features.useLastSampleDeltaPerSecondConverter,this.duration=0,this.lossRateCalculator=new YO,this.bytesReceivedDiff=this.useLastSampleDeltaPerSecondConverter?new $O:new BO,this.totalSamplesReceivedDiff=this.useLastSampleDeltaPerSecondConverter?new $O:new BO,this.concealedSamplesDiff=this.useLastSampleDeltaPerSecondConverter?new $O:new BO,this.silentConcealedSamplesDiff=this.useLastSampleDeltaPerSecondConverter?new $O:new BO,this.packetsDelta=this.useLastSampleDeltaPerSecondConverter?new $O:new BO,this.packetsLostDelta=this.useLastSampleDeltaPerSecondConverter?new $O:new BO,this.concealedRatioAverager=new VO,this.stretchedRatioAverager=new VO,this.codecSwitchesTracker=new WO,this.packetDurationTracker=new WO,this.jitterAverager=new VO,this.jitterBufferDelayAverager=new VO,this.lastBytes=0}processSample(e){let t,i,n,r,s;const a=this.lossRateCalculator.calculate(e.inboundRTP.packetsReceived,e.inboundRTP.packetsLost)??0;this.lastBytes=e.inboundRTP.bytesReceived,this.bytesReceivedDiff.captureSample(e.inboundRTP.bytesReceived,e.inboundRTP.timestamp),this.totalSamplesReceivedDiff.captureSample(e.inboundRTP.totalSamplesReceived,e.inboundRTP.timestamp),this.concealedSamplesDiff.captureSample(e.inboundRTP.concealedSamples,e.inboundRTP.timestamp),this.silentConcealedSamplesDiff.captureSample(e.inboundRTP.silentConcealedSamples,e.inboundRTP.timestamp);const o=this.bytesReceivedDiff.delta&&8*this.bytesReceivedDiff.delta;this.packetsDelta.captureSample(e.inboundRTP.packetsReceived,e.inboundRTP.timestamp),this.packetsLostDelta.captureSample(e.inboundRTP.packetsLost,e.inboundRTP.timestamp);const l=e.inboundRTP.jitterBufferDelay&&e.inboundRTP.jitterBufferEmittedCount&&bt(e.inboundRTP.jitterBufferDelay/e.inboundRTP.jitterBufferEmittedCount*1e3,0);if(this.jitterAverager.captureSample(1e3*e.inboundRTP.jitter),this.jitterBufferDelayAverager.captureSample(e.inboundRTP.jitterBufferDelay),t=this.totalSamplesReceivedDiff.delta&&this.concealedSamplesDiff.delta&&this.silentConcealedSamplesDiff.delta&&bt((this.concealedSamplesDiff.delta-this.silentConcealedSamplesDiff.delta)/this.totalSamplesReceivedDiff.delta),e.customHealerStats){e.customHealerStats.numSamplesPerFrame&&(r=e.customHealerStats.decodedSamples/e.customHealerStats.numSamplesPerFrame,s=e.customHealerStats.cngSamples/e.customHealerStats.numSamplesPerFrame),t=e.customHealerStats.healedSamples/(e.customHealerStats.decodedSamples+e.customHealerStats.healedSamples),n=e.customHealerStats.concealSamples&&e.customHealerStats.concealSamples/(e.customHealerStats.decodedSamples+e.customHealerStats.healedSamples),i=e.customHealerStats.stretchSamples&&e.customHealerStats.stretchSamples/(e.customHealerStats.decodedSamples+e.customHealerStats.healedSamples);const a=e.customHealerStats.packetDurationInMs&&e.customHealerStats.packetDurationInMs>100?100:e.customHealerStats.packetDurationInMs;this.concealedRatioAverager.captureSample(n),this.stretchedRatioAverager.captureSample(i),this.codecSwitchesTracker.captureSample(`${e.customHealerStats.pullAdspPayloadType}`),this.packetDurationTracker.captureSample(`${a}`)}e.extensions={lossRate:a,packetsPerSecond:this.packetsDelta.delta,packetsLostPerSecond:this.packetsLostDelta.delta,duration:this.duration,healedRatio:t,jitterBufferMs:l,bitrate:o||0,customHealerStats:e.customHealerStats&&{concealedDataRatio:n,concealedDataRatioMax:this.concealedRatioAverager.maxSample,stretchedDataRatio:i,stretchedDataRatioMax:this.stretchedRatioAverager.maxSample,numberOfDecodedFrames:r,usageMetricsCodecId:this.codecSwitchesTracker.sortedDurations,percentageOfPtime:this.packetDurationTracker.durationRatios,pushPacketProcessingTimes:e.customHealerStats.pushProcessingTimes,pullPacketProcessingTimes:e.customHealerStats.pullProcessingTimes,pullProcessingTimePerStreamNumber:e.customHealerStats.pullProcessingTimePerStreamNumber,cnpPushCount:e.customHealerStats.cnpPushCount,cnpPullCount:e.customHealerStats.cnpPullCount,numberOfCNFrames:s,redPacketsCount:e.customHealerStats.redPacketsCount,pullNumOfStreamsCounter:e.customHealerStats.pullNumOfStreamsCounter},jitterAvg:bt(this.jitterAverager.avg),jitterBufferDelayMs:bt(this.jitterBufferDelayAverager.avg)},this.duration++}},hD=class{constructor(){this.duration=0,this.lossRateAverager=new VO,this.bitrateAverager=new VO,this.jitterBufferAverager=new VO,this.jitterAverager=new VO,this.jitterBufferDelayAverager=new VO,this.healedRatioAverager=new VO}processSample(e,t,i){const n=e[0],r={inboundRTP:n.inboundRTP};if(n.transport&&Object.defineProperty(r,"transport",{value:n.transport,configurable:!1,enumerable:!1}),n.codec&&(r.codec=n.codec),n.track&&(r.track=n.track),n.remoteOutboundRTP&&(r.remoteOutboundRTP=n.remoteOutboundRTP),n.extensions){this.lossRateAverager.captureSample(n.extensions.lossRate),this.bitrateAverager.captureSample(n.extensions.bitrate),this.healedRatioAverager.captureSample(n.extensions.healedRatio),this.jitterBufferAverager.captureSample(n.extensions.jitterBufferMs),this.jitterAverager.captureSample(1e3*n.inboundRTP.jitter),this.jitterBufferDelayAverager.captureSample(n.inboundRTP.jitterBufferDelay);const e=n.inboundRTP.packetsReceived+n.inboundRTP.packetsLost;r.aggregated={lossRateMax:this.lossRateAverager.maxSample,lossRateAvg:this.lossRateAverager.avg,networkAvgLossRate:e>0?n.inboundRTP.packetsLost/e:0,duration:this.duration,bitrateAvg:bt(this.bitrateAverager.avg,0),bitrateMax:bt(this.bitrateAverager.maxSample,0),jitterAvg:this.jitterAverager.avg,avgJitterBufferSize:this.jitterBufferAverager.avg,healedRatioAvg:this.healedRatioAverager.avg,healedRatioMax:this.healedRatioAverager.maxSample,customHealerStats:n.extensions.customHealerStats&&{concealedDataRatio:n.extensions.customHealerStats.concealedDataRatio,concealedDataRatioMax:n.extensions.customHealerStats.concealedDataRatioMax,stretchedDataRatio:n.extensions.customHealerStats.stretchedDataRatio,stretchedDataRatioMax:n.extensions.customHealerStats.stretchedDataRatioMax,numberOfDecodedFrames:n.extensions.customHealerStats.numberOfDecodedFrames,usageMetricsCodecId:n.extensions.customHealerStats.usageMetricsCodecId,percentageOfPtime:n.extensions.customHealerStats.percentageOfPtime,pushPacketProcessingTimes:n.extensions.customHealerStats.pushPacketProcessingTimes,pullPacketProcessingTimes:n.extensions.customHealerStats.pullPacketProcessingTimes,pullProcessingTimePerStreamNumber:n.extensions.customHealerStats.pullProcessingTimePerStreamNumber,cnpPushCount:n.extensions.customHealerStats.cnpPushCount,cnpPullCount:n.extensions.customHealerStats.cnpPullCount,numberOfCNFrames:n.extensions.customHealerStats.numberOfCNFrames,redPacketsCount:n.extensions.customHealerStats.redPacketsCount,pullNumOfStreamsCounter:n.extensions.customHealerStats.pullNumOfStreamsCounter}},this.duration++}At(t,r,i)}},uD=class{constructor(e,t){this.diagnostics=e,this.configProvider=t,this.useLastSampleDeltaPerSecondConverter=this.configProvider.config.diagnostics.features.useLastSampleDeltaPerSecondConverter,this.duration=0,this.lossRateCalculator=new YO,this.packetsDelta=this.useLastSampleDeltaPerSecondConverter?new $O:new BO,this.packetsLostDelta=this.useLastSampleDeltaPerSecondConverter?new $O:new BO,this.bytesSendDiff=this.useLastSampleDeltaPerSecondConverter?new $O:new BO,this.rttAverager=new VO,this.lastBytes=0}processSample(e){const t=this.lossRateCalculator.calculate(e.remoteInboundRTP?.packetsReceived,e.remoteInboundRTP?.packetsLost)??0;this.packetsDelta.captureSample(e.outboundRTP.packetsSent,e.outboundRTP.timestamp),this.packetsLostDelta.captureSample(e.remoteInboundRTP?.packetsLost,e.remoteInboundRTP?.timestamp),this.lastBytes=e.outboundRTP.bytesSent,this.bytesSendDiff.captureSample(e.outboundRTP.bytesSent,e.outboundRTP.timestamp);const i=this.bytesSendDiff.delta;this.rttAverager.captureSample(1e3*(e.remoteInboundRTP?.roundTripTime??0)),e.extensions={lossRate:t,packetsPerSecond:this.packetsDelta.delta,packetsLostPerSecond:this.packetsLostDelta.delta,duration:this.duration,bitrate:i?8*i:0,rttAvg:bt(this.rttAverager.avg),callIsMuted:this.diagnostics.callIsMuted,rawInputVolume:this.diagnostics.audioLevel},this.duration++}},pD=class{constructor(e){this.diagnostics=e,this.duration=0,this.lossRateAverager=new VO,this.bitrateAverager=new VO,this.rttAverager=new VO}processSample(e,t,i){const n=e[0],r={outboundRTP:n.outboundRTP};n.transport&&Object.defineProperty(r,"transport",{value:n.transport,configurable:!1,enumerable:!1}),n.codec&&(r.codec=n.codec),n.track&&(r.track=n.track),n.mediaSource&&(r.mediaSource=n.mediaSource),n.remoteInboundRTP&&(r.remoteInboundRTP=n.remoteInboundRTP),n.extensions&&(this.lossRateAverager.captureSample(n.extensions.lossRate),this.bitrateAverager.captureSample(n.extensions.bitrate),this.rttAverager.captureSample(n.remoteInboundRTP?.roundTripTime),r.aggregated={duration:this.duration,lossRateMax:this.lossRateAverager.maxSample,bitrateAvg:bt(this.bitrateAverager.avg,0),bitrateMax:bt(this.bitrateAverager.maxSample,0),rttAvg:bt(this.rttAverager.avg),rttMax:bt(this.rttAverager.maxSample),rawInputVolume:this.diagnostics.audioLevel,audioLevel:n.track?.audioLevel??n.mediaSource?.audioLevel},this.duration++),At(t,r,i)}},gD=i(496486),mD={fs:0,fps:1},fD=class{constructor(e){this.logger=e,this.allowed=new Map,this.lastParams=new Map,this.currentEvents=new Map,this.finishedEvents=[]}setMaxCapabilities(e){e.forEach((e=>{if(e.ssrc||0===e.ssrc){this.finishIfActive(e.ssrc),this.allowed.set(e.ssrc,{fs:e.maxFs+mD.fs,fps:e.maxFps+mD.fps});const t=this.lastParams.get(e.ssrc);t&&this.setCurrentParams(e.ssrc,t.fs,t.fps)}}))}setCurrentParams(e,t,i){this.lastParams.set(e,{fs:t,fps:i});const n=this.getAllowedParams(e);n&&(t>n.fs||i>n.fps)?(this.captureOvershoot(e,i,n.fps,"fps"),this.captureOvershoot(e,t,n.fs,"fs")):n&&this.finishIfActive(e)}flush(){this.currentEvents.forEach(((e,t)=>this.finishIfActive(t)))}getEvents(){const e=[...ut(this.finishedEvents)],t=Date.now();return this.currentEvents.forEach((i=>i.forEach((i=>e.push({ssrc:i.ssrc,timestamp:i.timestamp,duration:t-i.timestamp,overshootType:i.overshootType,amount:i.amount}))))),e}captureOvershoot(e,t,i,n){const r=this.currentEvents.get(e)||[],s=r.findIndex((e=>e.overshootType===n)),a=r[s],o=t-i,l=mD[n];o<=l&&a?(a.duration=Date.now()-a.timestamp,this.finishedEvents.push(a),this.logger.debug(`stopped overshooting ${n} by ${a.amount}`),r.splice(s,1)):o>l&&!a?(this.logger.safe.info(`overshooting ${n} by ${t-i}`),r.push({ssrc:e,timestamp:Date.now(),duration:-1,overshootType:n,amount:{min:o,max:o}})):o>l&&a&&(a.amount={min:Math.min(a.amount.min,o),max:Math.max(a.amount.max,o)}),r.length?this.currentEvents.set(e,r):this.currentEvents.has(e)&&this.currentEvents.delete(e)}getAllowedParams(e){const t=this.allowed.get(e);return t||this.allowed.get(0)}finishIfActive(e){const t=this.currentEvents.get(e);if(t){const i=Date.now();t.forEach((t=>{t.duration=i-t.timestamp,this.finishedEvents.push(t),this.logger.debug(`finished overshooting ${t.overshootType} by min:${t.amount.min} max:${t.amount.max} for ${t.duration}ms for ssrc ${e}`)})),this.currentEvents.delete(e)}}},SD=class{constructor(e,t){this.diagnostics=e,this.configProvider=t,this.recvExtenders=new Map,this.sendExtenders=new Map}processStats(e){if(!e)return;const t=new Set;if(e.send&&(0,gD.flatMap)(e.send,(e=>[e,...e.altLayouts??[]])).forEach((e=>{try{t.add(e.outboundRTP.id);let i=this.sendExtenders.get(e.outboundRTP.id)??new CD(this.diagnostics,this.configProvider);e.outboundRTP.bytesSent<i.lastBytes&&(i=new CD(this.diagnostics,this.configProvider)),this.sendExtenders.set(e.outboundRTP.id,i),i.processSample(e)}catch(e){this.diagnostics.addStatsError("VideoStatsProcessor:send",Ge(e))}})),Vt(this.sendExtenders,t),t.clear(),e.recv)for(const i of e.recv)try{t.add(i.inboundRTP.id);let e=this.recvExtenders.get(i.inboundRTP.id)??new vD(this.configProvider);i.inboundRTP.bytesReceived<e.lastBytes&&(e=new vD(this.configProvider)),this.recvExtenders.set(i.inboundRTP.id,e),e.processSample(i)}catch(e){this.diagnostics.addStatsError("VideoStatsProcessor:recv",Ge(e))}Vt(this.recvExtenders,t)}},vD=class{constructor(e){this.configProvider=e,this.useLastSampleDeltaPerSecondConverter=this.configProvider.config.diagnostics.features.useLastSampleDeltaPerSecondConverter,this.duration=0,this.lossRateCalculator=new YO,this.bytesReceivedDelta=this.useLastSampleDeltaPerSecondConverter?new $O:new BO,this.framesReceivedDelta=this.useLastSampleDeltaPerSecondConverter?new $O:new BO,this.framesDecodedDelta=this.useLastSampleDeltaPerSecondConverter?new $O:new BO,this.trackFramesDelta=this.useLastSampleDeltaPerSecondConverter?new $O:new BO,this.decodeTimeDelta=this.useLastSampleDeltaPerSecondConverter?new $O(2):new BO,this.packetsDelta=this.useLastSampleDeltaPerSecondConverter?new $O:new BO,this.packetsLostDelta=this.useLastSampleDeltaPerSecondConverter?new $O:new BO,this.freezeHistogram=new GO,this.harmonicDecodedFps=new qO(this.configProvider.config.webrtcStatPollInterval*this.configProvider.config.coeffOfValidTimeDelayBetweenFramesArrival,this.configProvider.config.invalidFPSAboveMax),this.prevTimeToFirstFrame=-1,this.lastBytes=0,this.macroblockStatsTracker=new iD}processSample(e){const t=this.lossRateCalculator.calculate(e.inboundRTP.packetsReceived,e.inboundRTP.packetsLost)??0;this.framesReceivedDelta.captureSample(e.inboundRTP.framesReceived,e.inboundRTP.timestamp),this.framesDecodedDelta.captureSample(e.inboundRTP.framesDecoded,e.inboundRTP.timestamp),this.trackFramesDelta.captureSample(e.inboundRTP.framesReceived??e.track?.framesReceived,e.inboundRTP.timestamp),this.packetsDelta.captureSample(e.inboundRTP.packetsReceived,e.inboundRTP.timestamp),this.packetsLostDelta.captureSample(e.inboundRTP.packetsLost,e.inboundRTP.timestamp);const i=this.framesReceivedDelta.delta,n=this.framesDecodedDelta.delta;this.harmonicDecodedFps.captureSample(n),this.decodeTimeDelta.captureSample(e.inboundRTP.totalDecodeTime,e.inboundRTP.timestamp);const r=this.decodeTimeDelta.delta&&n&&bt(this.decodeTimeDelta.delta/n*1e3,0),s=e.renderer?.timeToFirstFrame??-1;this.freezeHistogram.active=-1!==s&&-1!==this.prevTimeToFirstFrame&&(0===n||0===i),this.prevTimeToFirstFrame=s,this.lastBytes=e.inboundRTP.bytesReceived,this.bytesReceivedDelta.captureSample(e.inboundRTP.bytesReceived,e.inboundRTP.timestamp);const a=this.bytesReceivedDelta.delta,o=e.inboundRTP.jitterBufferEmittedCount&&bt((e.inboundRTP.jitterBufferDelay??0)/e.inboundRTP.jitterBufferEmittedCount*1e3),l=tD(e.inboundRTP.frameWidth,e.inboundRTP.frameHeight,i||0),d=tD(e.inboundRTP.frameWidth,e.inboundRTP.frameHeight,n||0);this.macroblockStatsTracker.captureSample(l,d),e.extensions={lossRate:t,packetsPerSecond:this.packetsDelta.delta,packetsLostPerSecond:this.packetsLostDelta.delta,duration:this.duration,frameRateReceived:i,frameRateDecoded:n,trackRecvFps:this.trackFramesDelta.delta,decodeTime:r||0,jitterBufferMs:o,bitrate:a?8*a:0,isFrozen:this.freezeHistogram.active,macroblockRateReceived:l,macroblockRateDecoded:d,macroblockRateStats:this.macroblockStatsTracker.getReport(),longestFreeze:this.freezeHistogram.longestDuration,totalFreezeDuration:this.freezeHistogram.totalDuration,powerEfficient:void 0!==e.inboundRTP.powerEfficientDecoder?e.inboundRTP.powerEfficientDecoder:XO(e.inboundRTP.decoderImplementation),totalFreezeFraction:this.duration?this.freezeHistogram.totalDuration/this.duration:0,fpsHarmonicAverage:bt(this.harmonicDecodedFps.harmonicMean)},this.duration++}},yD=class{constructor(e){this.configProvider=e,this.duration=0,this.lossRateAverager=new VO,this.bitrateAverager=new VO,this.jitterAverager=new VO,this.frameRateAverager=new VO,this.freezeHistogram=new GO,this.harmonicDecodedFps=new qO(this.configProvider.config.webrtcStatPollInterval*this.configProvider.config.coeffOfValidTimeDelayBetweenFramesArrival,this.configProvider.config.invalidFPSAboveMax),this.resolutionDurations=new WO,this.codecCalculator=new nD}processSample(e,t,i){const n=e.sort(((e,t)=>t.inboundRTP.frameHeight*t.inboundRTP.frameWidth-e.inboundRTP.frameHeight*e.inboundRTP.frameWidth))[0],r={inboundRTP:n.inboundRTP};n.transport&&Object.defineProperty(r,"transport",{value:n.transport,configurable:!1,enumerable:!1}),n.codec&&(r.codec=n.codec,this.configProvider?.config.isAv1Allowed&&"sharing"===n.mediaEntity?.modality&&this.codecCalculator.captureSample(n.codec.mimeType,n.renderer?.msi)),n.track&&(r.track=n.track),n.remoteOutboundRTP&&(r.remoteOutboundRTP=n.remoteOutboundRTP),n.extensions&&(r.extensions=n.extensions),n.extensions&&(this.harmonicDecodedFps.captureSample(n.extensions.frameRateDecoded),this.lossRateAverager.captureSample(n.extensions.lossRate),this.bitrateAverager.captureSample(n.extensions.bitrate),this.jitterAverager.captureSample(1e3*(n.inboundRTP.jitter??0)),this.frameRateAverager.captureSample(n.extensions.frameRateReceived??n.extensions.frameRateDecoded),this.freezeHistogram.active=n.extensions.isFrozen,n.inboundRTP.frameWidth&&n.inboundRTP.frameHeight&&this.resolutionDurations.captureSample(`${n.inboundRTP.frameWidth}x${n.inboundRTP.frameHeight}`),r.aggregated={lossRateMax:this.lossRateAverager.maxSample,duration:this.duration,avgFrameRate:bt(this.frameRateAverager.avg),fpsHarmonicAverage:bt(this.harmonicDecodedFps.harmonicMean),avgJitterBufferSize:bt(this.jitterAverager.avg),bitrateAvg:bt(this.bitrateAverager.avg,0),bitrateMax:bt(this.bitrateAverager.maxSample,0),bitrateMinNonZero:bt(this.bitrateAverager.minNonZeroSample,0),ongoingFreezeDuration:this.freezeHistogram.ongoingDuration,numFreezes:this.freezeHistogram.numEvents,avgFreezeDuration:bt(this.freezeHistogram.avgDuration),longestFreeze:this.freezeHistogram.longestDuration,totalFreezeDuration:this.freezeHistogram.totalDuration,freezeCountHistogram:this.freezeHistogram.counts,freezeTimestampsHistogram:this.freezeHistogram.timestamps,numResolutionSwitches:this.resolutionDurations.changeCount,resolutionDurations:this.resolutionDurations.durations,resolutionDurationRatios:this.resolutionDurations.durationRatios,macroblockRateStats:n.extensions.macroblockRateStats,codecReport:this.codecCalculator?.report},this.duration++),At(t,r,i)}},CD=class{constructor(e,t){this.diagnostics=e,this.configProvider=t,this.useLastSampleDeltaPerSecondConverter=this.configProvider.config.diagnostics.features.useLastSampleDeltaPerSecondConverter,this.duration=0,this.lossRateCalculator=new YO,this.lossRateAverager=new VO,this.captureFreezeIntervalsCount=0,this.bytesSendDelta=this.useLastSampleDeltaPerSecondConverter?new $O:new BO,this.encodedFramesDelta=this.useLastSampleDeltaPerSecondConverter?new $O:new BO,this.sentFramesDelta=this.useLastSampleDeltaPerSecondConverter?new $O:new BO,this.packetsDelta=this.useLastSampleDeltaPerSecondConverter?new $O:new BO,this.packetsLostDelta=this.useLastSampleDeltaPerSecondConverter?new $O:new BO,this.harmonicEncodedFps=new qO(this.configProvider.config.webrtcStatPollInterval*this.configProvider.config.coeffOfValidTimeDelayBetweenFramesArrival,this.configProvider.config.invalidFPSAboveMax),this.encodeTimeDelta=this.useLastSampleDeltaPerSecondConverter?new $O(2):new BO,this.qpDelta=this.useLastSampleDeltaPerSecondConverter?new $O(3):new BO,this.fsOvershoot=new JO,this.fpsOvershoot=new JO(1),this.brOvershoot=new JO,this.plisDelta=new BO,this.pliRate=new ZO(60),this.resolutionSwitcherTracker=new eD(this.configProvider.config.diagnostics.collectionLimits.numResolutionSwitches),this.bitrateAverager=new VO,this.rttAverager=new VO,this.lastBytes=0}processSample(e){const t=this.lossRateCalculator.calculate(e.remoteInboundRTP?.packetsReceived,e.remoteInboundRTP?.packetsLost);this.lossRateAverager.captureSample(t),this.plisDelta.captureSample(e.outboundRTP.pliCount),this.pliRate.captureSample(this.plisDelta.delta),this.packetsDelta.captureSample(e.outboundRTP.packetsSent,e.outboundRTP.timestamp),this.packetsLostDelta.captureSample(e.remoteInboundRTP?.packetsLost,e.remoteInboundRTP?.timestamp),this.lastBytes=e.outboundRTP.bytesSent,this.bytesSendDelta.captureSample(e.outboundRTP.bytesSent,e.outboundRTP.timestamp);const i=this.bytesSendDelta.delta,n=i?8*i:void 0;this.bitrateAverager.captureSample(n),this.rttAverager.captureSample(1e3*(e.remoteInboundRTP?.roundTripTime??0)),this.encodedFramesDelta.captureSample(e.outboundRTP.framesEncoded,e.outboundRTP.timestamp);const r=this.encodedFramesDelta.delta;this.sentFramesDelta.captureSample(e.outboundRTP.framesSent,e.outboundRTP.timestamp);const s=this.sentFramesDelta.delta||0;this.harmonicEncodedFps.captureSample(r);const a=e.mediaSource?.framesPerSecond;0===a&&void 0!==this.lastCaptureFramerate&&this.lastCaptureFramerate>0&&this.captureFreezeIntervalsCount++,this.lastCaptureFramerate=a,this.encodeTimeDelta.captureSample(e.outboundRTP.totalEncodeTime,e.outboundRTP.timestamp);const o=this.encodeTimeDelta.delta&&r&&bt(this.encodeTimeDelta.delta/r*1e3,0);this.qpDelta.captureSample(e.outboundRTP.qpSum,e.outboundRTP.timestamp);const l=this.qpDelta.delta&&r&&bt(this.qpDelta.delta/r,2);e.outboundRTP.frameWidth&&e.outboundRTP.frameHeight&&this.resolutionSwitcherTracker.captureSample(e.outboundRTP.frameWidth,e.outboundRTP.frameHeight);const d=this.diagnostics.deviceManager?.latestCameraOpenResolution,c=e.appliedCapabilities??e.requestedCapabilities;c&&(void 0!==e.outboundRTP.frameHeight&&void 0!==e.outboundRTP.frameWidth&&this.fsOvershoot.captureSample(e.outboundRTP.frameHeight/16*(e.outboundRTP.frameWidth/16),c.maxFs),this.fpsOvershoot.captureSample(s,c.maxFps),c.maxBr&&this.brOvershoot.captureSample(n,c.maxBr));const h=[];for(const e of this.fsOvershoot.events)h.push({...e,overshootType:"fs"});for(const e of this.fpsOvershoot.events)h.push({...e,overshootType:"fps"});for(const e of this.brOvershoot.events)h.push({...e,overshootType:"br"});h.sort(((e,t)=>e.timestamp-t.timestamp)),e.extensions={cameraOpenResolution:d,lossRate:t,packetsPerSecond:this.packetsDelta.delta,packetsLostPerSecond:this.packetsLostDelta.delta,duration:this.duration,pliRate:this.pliRate.getRate(),frameRateEncoded:this.encodedFramesDelta.delta,frameRateSent:s,bitrate:n||0,encodeTime:o||0,qp:l||0,captureFreezeIntervalsCount:this.captureFreezeIntervalsCount,isFsOvershooting:this.fsOvershoot.isOvershooting,isFpsOvershooting:this.fpsOvershoot.isOvershooting,isBrOvershooting:this.brOvershoot.isOvershooting,totalFsOvershootDuration:this.fsOvershoot.totalDuration,totalFpsOvershootDuration:this.fpsOvershoot.totalDuration,totalBrOvershootDuration:this.brOvershoot.totalDuration,overshootEvents:h,powerEfficient:void 0!==e.outboundRTP.powerEfficientEncoder?e.outboundRTP.powerEfficientEncoder:XO(e.outboundRTP.encoderImplementation),bitrateAvg:bt(this.bitrateAverager.avg,0),rttAvg:bt(this.rttAverager.avg)},this.duration++}},TD=class{constructor(e){this.configProvider=e,this.duration=0,this.lossRateAverager=new VO,this.bitrateAverager=new VO,this.sendBWEAverager=new VO,this.rttAverager=new VO,this.framerateAverager=new VO,this.captureFpsAverager=new VO,this.captureFreezeIntervalsCount=0,this.lastCaptureFps=void 0,this.resolutionDurations=new WO,this.fsOvershoot=new JO,this.fpsOvershoot=new JO(1),this.brOvershoot=new JO,this.harmonicEncodedFps=new qO(this.configProvider.config.webrtcStatPollInterval*this.configProvider.config.coeffOfValidTimeDelayBetweenFramesArrival,this.configProvider.config.invalidFPSAboveMax)}processSample(e,t,i){e.length>1&&e.sort(((e,t)=>{const i=e.appliedCapabilities??e.requestedCapabilities,n=t.appliedCapabilities??t.requestedCapabilities;return i?.maxMbps&&n?.maxMbps?n.maxMbps-i.maxMbps:0}));const n=e[0],r={outboundRTP:n.outboundRTP};if(n.transport&&Object.defineProperty(r,"transport",{value:n.transport,configurable:!1,enumerable:!1}),n.codec&&(r.codec=n.codec),n.track&&(r.track=n.track),n.mediaSource&&(r.mediaSource=n.mediaSource),n.remoteInboundRTP&&(r.remoteInboundRTP=n.remoteInboundRTP),n.extensions&&(r.extensions=n.extensions),n.extensions){this.lossRateAverager.captureSample(n.extensions.lossRate),this.bitrateAverager.captureSample(n.extensions.bitrate),this.sendBWEAverager.captureSample(n.transport?.selectedCandidatePair?.availableOutgoingBitrate),this.rttAverager.captureSample(n.remoteInboundRTP?.roundTripTime),this.framerateAverager.captureSample(n.extensions.frameRateSent);const e=n.mediaSource?.framesPerSecond;this.captureFpsAverager.captureSample(e),0===e&&void 0!==this.lastCaptureFps&&this.lastCaptureFps>0&&this.captureFreezeIntervalsCount++,this.lastCaptureFps=e,n.outboundRTP.frameWidth&&n.outboundRTP.frameHeight&&this.resolutionDurations.captureSample(`${n.outboundRTP.frameWidth}x${n.outboundRTP.frameHeight}`);const t=n.appliedCapabilities??n.requestedCapabilities;t&&(void 0!==n.outboundRTP.frameHeight&&void 0!==n.outboundRTP.frameWidth&&this.fsOvershoot.captureSample(n.outboundRTP.frameHeight/16*(n.outboundRTP.frameWidth/16),t.maxFs),this.fpsOvershoot.captureSample(n.extensions.frameRateSent,t.maxFps),t.maxBr&&this.brOvershoot.captureSample(n.extensions?.bitrate,t.maxBr)),this.harmonicEncodedFps.captureSample(n.extensions.frameRateEncoded);const i=[];for(const e of this.fsOvershoot.events)i.push({...e,overshootType:"fs"});for(const e of this.fpsOvershoot.events)i.push({...e,overshootType:"fps"});for(const e of this.brOvershoot.events)i.push({...e,overshootType:"br"});i.sort(((e,t)=>e.timestamp-t.timestamp)),r.aggregated={lossRateMax:this.lossRateAverager.maxSample,duration:this.duration,frameRateAvg:bt(this.framerateAverager.avg),captureFramerateAvg:bt(this.captureFpsAverager.avg),fpsHarmonicAverage:bt(this.harmonicEncodedFps.harmonicMean),qpAvg:bt(n.outboundRTP.qpSum/n.outboundRTP.framesSent),rttAvg:bt(this.rttAverager.avg),bitrateAvg:bt(this.bitrateAverager.avg,0),bitrateMax:bt(this.bitrateAverager.maxSample,0),bitrateMinNonZero:bt(this.bitrateAverager.minNonZeroSample,0),bweAvg:bt(this.sendBWEAverager.avg,0),captureFreezeIntervalsCount:this.captureFreezeIntervalsCount,numResolutionSwitches:this.resolutionDurations.changeCount,resolutionDurations:this.resolutionDurations.durations,resolutionDurationRatios:this.resolutionDurations.durationRatios,isFsOvershooting:this.fsOvershoot.isOvershooting,isFpsOvershooting:this.fpsOvershoot.isOvershooting,isBrOvershooting:this.brOvershoot.isOvershooting,totalFsOvershootDuration:this.fsOvershoot.totalDuration,totalFpsOvershootDuration:this.fpsOvershoot.totalDuration,totalBrOvershootDuration:this.brOvershoot.totalDuration,overshootEvents:i},this.duration++}At(t,r,i)}},ED=class{constructor(e,t){this.diagnostics=e,this.configProvider=t,this.extenders=new Map}processStats(e){const t=new Set;for(const i in e)try{t.add(i);const n=e[i],r=this.extenders.get(n.id)??new _D(this.configProvider,this.diagnostics);this.extenders.set(n.id,r),r.processSample(n)}catch(e){this.diagnostics.addStatsError("TransportStatsProcessor",Ge(e))}Vt(this.extenders,t)}},_D=class{constructor(e,t){this.configProvider=e,this.diagnostics=t,this.useLastSampleDeltaPerSecondConverter=this.configProvider.config.diagnostics.features.useLastSampleDeltaPerSecondConverter,this.bwJumpsHistogramCollector=new GO,this.sendBWEAverager=new VO,this.recvBWEAverager=new VO,this.sendBW=this.useLastSampleDeltaPerSecondConverter?new $O:new BO,this.recvBW=this.useLastSampleDeltaPerSecondConverter?new $O:new BO,this.sendBWAverager=new VO,this.recvBWAverager=new VO}processSample(e){this.sendBWEAverager.captureSample(e.selectedCandidatePair?.availableOutgoingBitrate),this.recvBWEAverager.captureSample(e.selectedCandidatePair?.availableIncomingBitrate),this.sendBW.captureSample(e.selectedCandidatePair?.bytesSent,e.selectedCandidatePair?.timestamp),this.recvBW.captureSample(e.selectedCandidatePair?.bytesReceived,e.selectedCandidatePair?.timestamp);const t=this.sendBW.delta,i=this.recvBW.delta,n=t?8*t:void 0,r=i?8*i:void 0;this.sendBWAverager.captureSample(n),this.recvBWAverager.captureSample(r);const s=e.selectedCandidatePair?.availableOutgoingBitrate;s&&(this.bwJumpsHistogramCollector.active=this.bwJumpsHistogramCollector.active&&s<this.configProvider.config.webrtcBWJumpUpperLimit||s<this.configProvider.config.webrtcBWJumpLowerLimit),e.extensions={sendBWEAvg:bt(this.sendBWEAverager.avg,0),sendBWEMax:bt(this.sendBWEAverager.maxSample,0),recvBWEAvg:bt(this.recvBWEAverager.avg,0),recvBWEMax:bt(this.recvBWEAverager.maxSample,0),sendBitrate:n,recvBitrate:r,sendBWAvg:bt(this.sendBWAverager.avg,0),sendBWMax:bt(this.sendBWAverager.maxSample,0),recvBWAvg:bt(this.recvBWAverager.avg,0),recvBWMax:bt(this.recvBWAverager.maxSample,0),bwJumpsHistogram:this.bwJumpsHistogramCollector.counts,reflexiveLocalIP:this.diagnostics.reflexiveLocalIP}}},bD=class{constructor(e,t){this.diagnostics=e,this.configProvider=t,this.extenders=new Map}processStats(e){if(!e)return;const t=new Set;for(const i of e)try{t.add(i.id);const e=this.extenders.get(i.id)??new PD(this.configProvider);this.extenders.set(i.id,e),e.processSample(i)}catch(e){this.diagnostics.addStatsError("DataChannelStatsProcessor",Ge(e))}Vt(this.extenders,t)}},PD=class{constructor(e){this.configProvider=e,this.useLastSampleDeltaPerSecondConverter=this.configProvider.config.diagnostics.features.useLastSampleDeltaPerSecondConverter,this.sendBytesDeltaCalculator=this.useLastSampleDeltaPerSecondConverter?new $O:new BO,this.recvBytesDeltaCalculator=this.useLastSampleDeltaPerSecondConverter?new $O:new BO,this.sendMessagesDeltaCalculator=this.useLastSampleDeltaPerSecondConverter?new $O:new BO,this.recvMessagesDeltaCalculator=this.useLastSampleDeltaPerSecondConverter?new $O:new BO}processSample(e){this.sendBytesDeltaCalculator.captureSample(e.bytesSent,e.timestamp),this.recvBytesDeltaCalculator.captureSample(e.bytesReceived,e.timestamp);const t=this.sendBytesDeltaCalculator.delta,i=this.recvBytesDeltaCalculator.delta,n=t?8*t:void 0,r=i?8*i:void 0;this.sendMessagesDeltaCalculator.captureSample(e.messagesSent,e.timestamp),this.recvMessagesDeltaCalculator.captureSample(e.messagesReceived,e.timestamp);const s=this.sendMessagesDeltaCalculator.delta,a=this.recvMessagesDeltaCalculator.delta;e.extensions={sendBitrate:n,recvBitrate:r,sendMessageRate:s,recvMessageRate:a}}},ID=class{constructor(e){this.collecVideoStatsAfterSubscription=e,this.videoStatsEvent=[],this.count=0}prepareCollectingStatsOnSubscribed(e){this.count=0,this.videoStatsEvent.push({ts:Date.now(),framesDecoded:[],bytesReceived:[],height:[],msi:e})}captureStatsOnSubscribed(e,t,i,n){if(this.count>=this.collecVideoStatsAfterSubscription)return;const r=wt(this.videoStatsEvent);r&&(r.framesDecoded.push(e),r.bytesReceived.push(t),void 0!==i&&r.height.push(i)),this.count++}getStatsOnSubscribed(){return this.videoStatsEvent}},AD=class{constructor(e,t,i,n){this.slidingWindowSize=e,this.maxDeviation=t,this.minBandwidth=i,this.directionalityCheck=n,this.slidingWindow=new zA(this.slidingWindowSize),this.currentModality=null,this.previousModality=null,this.inProcess=!1}processBandwidth(e,t,i){this.currentModality?this.handleStopEvent(t,i):this.handleStartEvent(t,i),this.inProcess&&(this.stabilizationTime++,this.slidingWindow.add(e),this.inProcess=!this.slidingWindow.isFull||!this.isBandwidthStable())}getReport(e=!1){if(void 0!==this.stabilizationTime)return{time:this.inProcess?this.stabilizationTime:Math.max(this.stabilizationTime-this.slidingWindowSize,0),bandwidth:e?bt(this.averageBandwidth,2):this.averageBandwidth,finished:!this.inProcess,modality:this.previousModality}}handleStartEvent(e,t){this.currentModality=this.GetModalityString(e),t&&this.currentModality&&!this.previousModality&&(this.previousModality=this.currentModality,this.stabilizationTime=0,this.slidingWindow.clear(),this.inProcess=!0)}handleStopEvent(e,t){t&&(this.directionalityCheck(e.audio)||this.directionalityCheck(e.video)||this.directionalityCheck(e.sharing))||(this.currentModality=null,this.inProcess=!1)}GetModalityString(e){return[this.directionalityCheck(e.audio)?tt.MODALITY.audio:null,this.directionalityCheck(e.video)?tt.MODALITY.video:null,this.directionalityCheck(e.sharing)?tt.MODALITY.sharing:null].filter(Boolean).join(", ")}isBandwidthStable(){if(this.averageBandwidth=at(this.slidingWindow.items),this.averageBandwidth<this.minBandwidth)return!1;{const e=this.averageBandwidth*this.maxDeviation,t=this.averageBandwidth-e,i=this.averageBandwidth+e;return this.slidingWindow.items.every((e=>yt(e,t,i)))}}},RD=class{constructor(e,t){this.diagnostics=e,this.configProvider=t,this.uplinkStabilizationTelemetry=new AD(this.configProvider.config.uplinkBWStabilizationSlidingWindowSize,this.configProvider.config.uplinkBWStabilizationMaxDeviation,this.configProvider.config.uplinkBWStabilizationMinBandwidth,Ag),this.downlinkSabilizationTelemetry=new AD(this.configProvider.config.downlinkBWStabilizationSlidingWindowSize,this.configProvider.config.downlinkBWStabilizationMaxDeviation,this.configProvider.config.downlinkBWStabilizationMinBandwidth,Rg),this.bandwidthCalculator=new QO,this.bandwidthAvg=new VO}processStats(e){const t=this.diagnostics.getObjectRef(),i=t?.activeModalities;if(!i||!e.transports)return;const n=e.transports[Object.keys(e.transports)[0]],r=t?.reportedReceiveBandwidth?.[t.reportedReceiveBandwidth.length-1],s=n?.selectedCandidatePair?.availableOutgoingBitrate,a=e.audio?.send?.length>0||e.video?.send?.length>0||e.sharing?.send?.length>0,o=e.audio?.recv?.length>0||e.video?.recv?.length>0||e.sharing?.recv?.length>0;this.bweType!==t?.bweType&&(this.bandwidthCalculator=new QO,this.bandwidthAvg=new VO,this.bweType=t?.bweType);const l="REMB"===t?.bweType?"availableIncomingBitrate":"availableOutgoingBitrate",d=n?.selectedCandidatePair?.[l];this.bandwidthCalculator.captureSample(d),this.bandwidthAvg.captureSample(d);try{this.uplinkStabilizationTelemetry.processBandwidth(s,i,a),this.downlinkSabilizationTelemetry.processBandwidth(r,i,o)}catch(e){this.diagnostics.addStatsError("BandwithStatsProcessor",Ge(e))}}getStabilizedReport(e=!1){return this.uplinkStabilizationTelemetry.getReport(e)}getDownlinkStabilizedReport(e=!1){return this.downlinkSabilizationTelemetry.getReport(e)}calculateBwPercentiles(){if(!this.bandwidthCalculator.getFirst())return;const e=this.configProvider.config.bwPercentiles,t={};return e.forEach((e=>{Object.defineProperty(t,e,{value:this.bandwidthCalculator.calculatePercentile(e/100),enumerable:!0})})),t}getBandwidthReport(){return{startOfTheCall:this.bandwidthCalculator.getFirst(),endOfTheCall:this.bandwidthCalculator.getLast(),std:this.bandwidthCalculator.calculateStd(),bwPercentiles:this.calculateBwPercentiles(),avgBwe:bt(this.bandwidthAvg.avg,2)}}},wD=class{constructor(e,t){this.configProvider=e,this.diagnostics=t,this.dataChannelStatsProcessor=new bD(this.diagnostics,this.configProvider),this.transportStatsProcessor=new ED(this.diagnostics,this.configProvider),this.audioStatsProcessor=new dD(this.diagnostics,this.configProvider),this.videoStatsProcessor=new SD(this.diagnostics,this.configProvider),this.sharingStatsProcessor=new SD(this.diagnostics,this.configProvider),this.bandwithStatsProcessor=new RD(this.diagnostics,this.configProvider),this.macroblockStatsTracker=new iD,this.statsAggregators={audio:{recv:new hD,send:new pD(this.diagnostics)},video:{recv:new yD(this.configProvider),send:new TD(this.configProvider)},sharing:{recv:new yD(this.configProvider),send:new TD(this.configProvider)}},this.aggregatedModalityStats={},this.recvVideoStreamsCounter=new HO,this.multiviewData={},this.multiviewKeySet=new Set,this.statsOnSubscribedData={video:{},sharing:{}},this.statsOnSubscribed={video:[],sharing:[]},this.diagnostics.aggregatedStatsRef=this.aggregatedModalityStats,this.diagnostics.statsOnSubscribed=this.statsOnSubscribed,this.diagnostics.bandwidthDiagnostic=this.bandwithStatsProcessor}processStats(e){this.dataChannelStatsProcessor.processStats(e.data),this.transportStatsProcessor.processStats(e.transports),this.audioStatsProcessor.processStats(e.audio),this.videoStatsProcessor.processStats(e.video),this.sharingStatsProcessor.processStats(e.sharing),this.bandwithStatsProcessor.processStats(e),this.diagnostics.bwStabiliationTime=this.bandwithStatsProcessor.getStabilizedReport(!0),this.diagnostics.bwDownlinkStabiliationTime=this.bandwithStatsProcessor.getDownlinkStabilizedReport(!0),this.recvVideoStreamsCounter.captureSample(e.video?.recv?.length),this.diagnostics.recvVideoStreamsCount={min:this.recvVideoStreamsCounter.min,max:this.recvVideoStreamsCounter.max,mode:this.recvVideoStreamsCounter.mode};try{this.processAggregated(e)}catch(e){this.diagnostics.addStatsError("webrtcStatistics:processAggregated",Ge(e))}try{this.processMultiview(e.video?.recv??[])}catch(e){this.diagnostics.addStatsError("webrtcStatistics:processMultiview",Ge(e))}try{const e=navigator?.connection;e&&this.diagnostics.addNetworkInfo({downlink:e.downlink,rtt:e.rtt,effectiveType:e.effectiveType,saveData:e.saveData})}catch(e){this.diagnostics.addStatsError("webrtcStatistics:processStats(networkInfo)",Ge(e))}try{this.processMacroblockRateStats(e.video?.recv)}catch(e){this.diagnostics.addStatsError("webrtcStatistics: processMacroblockRateStats",Ge(e))}}signalNoConnection(){this.transportStatsProcessor=new ED(this.diagnostics,this.configProvider),this.audioStatsProcessor=new dD(this.diagnostics,this.configProvider),this.videoStatsProcessor=new SD(this.diagnostics,this.configProvider),this.sharingStatsProcessor=new SD(this.diagnostics,this.configProvider)}processMultiview(e){const t=new Set;for(const i of e){const e=i.inboundRTP.id;t.add(e);let n=this.multiviewData[e];n&&this.multiviewKeySet.has(e)?n.stats.duration++:(n={bitrateAverager:new VO,jitterAverager:new VO,frameRateAverager:new VO,freezeHistogram:new GO,resolutionDurations:new WO,isRenderingEvents:[],statsOnSubscribed:new ID(this.configProvider.config.diagnostics.telemetryLimits.maxVideoStatsAfterSubscription),stats:{ssrc:i.inboundRTP.ssrc,startTime:Date.now(),duration:0,framesDecoded:[],bytesReceived:[],height:[],width:[]}},n.statsOnSubscribed.prepareCollectingStatsOnSubscribed(i.renderer?.msi),this.multiviewData[e]=n),n.statsOnSubscribed.captureStatsOnSubscribed(i.inboundRTP.framesDecoded,i.inboundRTP.bytesReceived,i.inboundRTP.frameHeight),n.bitrateAverager.captureSample(i.extensions?.bitrate),n.jitterAverager.captureSample(1e3*(i.inboundRTP.jitter??0)),n.frameRateAverager.captureSample(i.extensions.frameRateReceived),n.freezeHistogram.active=i.extensions?.isFrozen,i.inboundRTP.frameWidth&&i.inboundRTP.frameHeight&&n.resolutionDurations.captureSample(`${i.inboundRTP.frameWidth}x${i.inboundRTP.frameHeight}`);const r=i.renderer?.isRendering??!1;(!n.isRenderingEvents.length&&r||n.isRenderingEvents.length&&wt(n.isRenderingEvents).isRendering!==r)&&At(n.isRenderingEvents,{isRendering:r,ts:Date.now()},this.configProvider.config.diagnostics.collectionLimits.numIsRenderingEvents),n.stats.frameRateAvg=bt(n.frameRateAverager.avg),n.stats.bitrateAvg=bt(n.bitrateAverager.avg,0),n.stats.bitrateMax=bt(n.bitrateAverager.maxSample,0),n.stats.bitrateMinNonZero=bt(n.bitrateAverager.minNonZeroSample),n.stats.freezeHistogram=n.freezeHistogram.counts,n.stats.freezeTimestamps=n.freezeHistogram.timestamps,n.stats.avgFreezeDuration=bt(n.freezeHistogram.avgDuration),n.stats.totalFreezeDuration=n.freezeHistogram.totalDuration,n.stats.ongoingFreeze=n.freezeHistogram.active,n.stats.ongoingFreezeDuration=n.freezeHistogram.ongoingDuration,n.stats.numResolutionSwitches=n.resolutionDurations.changeCount,n.stats.rendererSize=`${i.renderer?.rendererSize?.width}x${i.renderer?.rendererSize?.height}`,n.stats.resolutionDurations=n.resolutionDurations.durations,n.stats.timeToFirstFrame=i.renderer?.timeToFirstFrame,n.stats.timeToFirstFrameSinceSubscriptionStart=i.renderer?.timeToFirstFrameSinceSubscriptionStart,n.stats.isRenderingEvents=n.isRenderingEvents,n.stats.statsOnSubscribed=n.statsOnSubscribed.getStatsOnSubscribed(),n.stats.msi=i.renderer?.msi,n.stats.rendererStates=i.renderer?.rendererStates,At(n.stats.framesDecoded,i.inboundRTP.framesDecoded,this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples),At(n.stats.bytesReceived,i.inboundRTP.bytesReceived,this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples),At(n.stats.height,i.inboundRTP.frameHeight,this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples),At(n.stats.width,i.inboundRTP.frameWidth,this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples);const s=i.extensions?.macroblockRateStats??{};for(const e in s)n.stats[e]=bt(s[e],0)}this.diagnostics.multiViewStats=Object.values(this.multiviewData).map((e=>e.stats)),this.multiviewKeySet=t}processAggregated(e){for(const t of["audio","video","sharing"])if(e[t])for(const i in e[t])this.processAggregatedModality(e,t,i)}processAggregatedModality(e,t,i){var n,r;const s=e[t]?.[i]?.length??0;s>0&&((n=this.aggregatedModalityStats)[t]??(n[t]={}),(r=this.aggregatedModalityStats[t])[i]??(r[i]=[]),s>1&&("audio"===t||"sharing"===t)&&this.diagnostics.addStatsError("webrtcStatistics:processAggregatedModality",`Multiple ${t} ${i} streams: ${s}`),this.statsAggregators[t][i].processSample(e[t][i],this.aggregatedModalityStats[t][i],this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples),"sharing"!==t&&"video"!==t||"recv"!==i||this.processStatsOnSubscribed(e[t][i],t))}processStatsOnSubscribed(e,t){const i=new Set;for(const n of e)if(n.inboundRTP){const e=`${n.inboundRTP.id}x${n.renderer?.msi}`;let r=this.statsOnSubscribedData[t]?.[e];i.add(e),r||(r=new ID(this.configProvider.config.diagnostics.telemetryLimits.maxVideoStatsAfterSubscription),r.prepareCollectingStatsOnSubscribed(n.renderer?.msi),this.statsOnSubscribedData[t][e]=r,this.statsOnSubscribed[t].push(...r.getStatsOnSubscribed())),r.captureStatsOnSubscribed(n.inboundRTP.framesDecoded,n.inboundRTP.bytesReceived)}!function(e,t){const i=[];for(const n of Object.keys(e))t.has(n)||i.push(n);for(const t of i)delete e[t]}(this.statsOnSubscribedData[t],i)}processMacroblockRateStats(e){if(!e?.length)return;let t=0,i=0;for(const n of e)t+=n.extensions?.macroblockRateReceived,i+=n.extensions?.macroblockRateDecoded;this.macroblockStatsTracker.captureSample(t,i),this.diagnostics.setTotalVideoRecvMblocksRates(this.macroblockStatsTracker.getReport())}},MD=i(496486),OD=class{constructor(e,t,i,n){this.logger=e,this.configProvider=t,this.diagnostics=i,this.mediaManager=n,this.webrtcStats=new wD(this.configProvider,this.diagnostics),this.ssrcToRecvTrackMap=new Map,this.activeChannels={}}setAudioDecoderStatsProvider(e){this.audioDecoderStatsProvider=e}signalNoConnection(){this.webrtcStats.signalNoConnection()}processRawReport(e){this.diagnostics.latestRawReport=e;const t={loopTime:-1,fetchTime:-1,convertTime:-1,processingTime:-1,legacyProcessingTime:-1};try{let i=kt(),n=i;const r=this.convertStatsReport(e);return r.perfCounters=t,i=kt(),t.convertTime=i-n,n=i,this.webrtcStats.processStats(r),this.diagnostics.addStatsReport(r),i=kt(),t.processingTime=i-n,r}catch(e){const t=Ge(e);return this.logger.safe.error(`Error processing raw stats: ${t}`),void this.diagnostics.addStatsError("StatisticsGatherer:processRawReport",t)}}setSsrcTrackPair(e,t){null===t?this.ssrcToRecvTrackMap.delete(e):this.ssrcToRecvTrackMap.set(e,t)}convertStatsReport(e){const t={transports:this.processTransportStats(e)};return this.appendPcStats(e,t),this.appendSendMediaStats(e,t),this.appendRecvMediaStats(e,t),e["data-channel"]&&(t.data=Object.values(e["data-channel"])),t}processTransportStats(e){if(e.transport){const t={};for(const i in e.transport){const n=e.transport[i];if(t[i]=ht(n),n.selectedCandidatePairId){const r=ht(e["candidate-pair"][n.selectedCandidatePairId]);r.localCandidate=e["local-candidate"][r.localCandidateId],r.remoteCandidate=e["remote-candidate"][r.remoteCandidateId],t[i].selectedCandidatePair=r}n.localCertificateId&&e.certificate&&(t[i].localCertificate=e.certificate[n.localCertificateId]),n.remoteCertificateId&&e.certificate&&(t[i].remoteCertificate=e.certificate[n.remoteCertificateId])}return t}if(e["candidate-pair"]){const t={};for(const i in e["candidate-pair"]){const n=ht(e["candidate-pair"][i]);n.selected&&(n.localCandidate=e["local-candidate"][n.localCandidateId],n.remoteCandidate=e["remote-candidate"][n.remoteCandidateId],t.faketransport={id:"faketransport",timestamp:n.timestamp,type:"transport",selectedCandidatePair:n,selectedCandidatePairId:n.id})}return t}}appendPcStats(e,t){let i="";e["peer-connection"]&&(Object.keys(e["peer-connection"]).forEach((e=>{""===i?i=e:(this.logger.safe.error(`Unexpected second peer connection stats id ${e}, also found ${i}`),this.diagnostics.addStatsError("StatisticsGatherer","Unexpected second peer connection stats"))})),t.peerConnection=e["peer-connection"][i])}appendSendMediaStats(e,t){var i,n,r,s;for(const a in e["outbound-rtp"]){const o=e["outbound-rtp"][a],l={outboundRTP:o};o.codecId&&e.codec&&(l.codec=e.codec[o.codecId]),Object.defineProperty(l,"transport",{value:t.transports[o.transportId??"faketransport"],configurable:!1,enumerable:!1}),o.remoteId&&e["remote-inbound-rtp"]&&(l.remoteInboundRTP=e["remote-inbound-rtp"][o.remoteId]),o.mediaSourceId&&e["media-source"]&&(l.mediaSource=e["media-source"][o.mediaSourceId]),o.trackId&&e.track&&(l.track=e.track[o.trackId]);const d=xD(this.mediaManager,l.track?.trackIdentifier??l.mediaSource?.trackIdentifier,o.rid)??LD(this.mediaManager,o.ssrc,o.rid)??HD(this.mediaManager,l.outboundRTP.mid,o.rid);if(!d?.getLocalTrackId())continue;l.mediaEntity=d.serialize(),!l.mediaSource&&l.mediaEntity&&e["media-source"]&&(l.mediaSource=Object.values(e["media-source"]).find((e=>e.trackIdentifier===l.mediaEntity.localTrackId)));const c="video"===o.kind?"sharing"===d?.getModality()?"sharing":"video":o.kind;if((i=this.activeChannels)[c]??(i[c]={}),(n=this.activeChannels[c]).send??(n.send={}),Ag(this.diagnostics.getObjectRef().activeModalities?.[c])){if(t[c]||(t[c]={}),t[c].send||(t[c].send=[]),"video"===o.kind){const e=FD(this.diagnostics,c,o.ssrc)??FD(this.diagnostics,c,0);e&&(l.requestedCapabilities=e);const i=UD(this.diagnostics,c,o.ssrc)??UD(this.diagnostics,c,0);i&&(l.appliedCapabilities=i);const n=t[c].send.find((e=>e.outboundRTP.trackId===l.outboundRTP.trackId));if(n){const e=parseInt(n.outboundRTP.rid,10)>parseInt(l.outboundRTP.rid,10);if(!n.altLayouts&&e&&(n.altLayouts=[]),e)n.altLayouts.push(l);else{l.altLayouts=[],l.altLayouts.push(n);const e=t[c].send.indexOf(n);t[c].send[e]=l}continue}}this.activeChannels[c].send[o.id]=l,t[c].send.push(l)}else this.activeChannels[c].send[o.id]&&"sharing"!==c&&(t.inactiveTracks??(t.inactiveTracks={}),(r=t.inactiveTracks)[c]??(r[c]={}),(s=t.inactiveTracks[c]).send??(s.send=[]),t.inactiveTracks[c].send.push(this.activeChannels[c].send[o.id]))}}appendRecvMediaStats(e,t){var i,n,r,s;const a=this.diagnostics.getObjectRef().subscriptionManager?.subscribedTrackIds;for(const o in e["inbound-rtp"]){const l=e["inbound-rtp"][o],d={inboundRTP:l};l.codecId&&e.codec&&(d.codec=e.codec[l.codecId]),"audio"===l.kind&&d.inboundRTP.ssrc===this.audioDecoderStatsProvider?.ssrc&&(d.codec||(d.codec={transportId:l.transportId??"faketransport",id:"fakeCodec",payloadType:999,timestamp:l.timestamp,type:"codec",mimeType:"unk"}),d.codec.mimeType=this.audioDecoderStatsProvider.codecName,d.inboundRTP=(0,MD.merge)(d.inboundRTP,this.audioDecoderStatsProvider.getWebRtcCompatibaleStats()),d.customHealerStats=this.audioDecoderStatsProvider.getWasmStats()),t.transports[l.transportId??"faketransport"]&&Object.defineProperty(d,"transport",{value:t.transports[l.transportId??"faketransport"],configurable:!1,enumerable:!1}),l.remoteId&&e["remote-outbound-rtp"]&&(d.remoteOutboundRTP=e["remote-outbound-rtp"][l.remoteId]);const c=d.inboundRTP.trackIdentifier??this.ssrcToRecvTrackMap.get(l.ssrc);if(l.trackId||c){l.trackId&&e.track?d.track=e.track[l.trackId]:c&&(d.track={id:"ssrcToTrackId",kind:l.kind,timestamp:l.timestamp,type:"track",trackIdentifier:c});const t=VD(this.diagnostics,d.track?.trackIdentifier);t&&(d.renderer=t)}const h=ND(this.mediaManager,d.track?.trackIdentifier)??kD(this.mediaManager,l.ssrc);if(!h)continue;d.mediaEntity=h.serialize();const u="video"===l.kind&&d.track?"sharing"===h?.getModality()?"sharing":"video":l.kind;(i=this.activeChannels)[u]??(i[u]={}),(n=this.activeChannels[u]).recv??(n.recv={}),"video"!==l.kind||a.some((e=>e&&e===d.track?.trackIdentifier))?Rg(this.diagnostics.getObjectRef().activeModalities?.[u])&&(t[u]||(t[u]={}),t[u].recv||(t[u].recv=[]),this.activeChannels[u].recv[l.id]=d,t[u].recv.push(d)):this.activeChannels[u].recv[l.id]&&"sharing"!==u&&(t.inactiveTracks??(t.inactiveTracks={}),(r=t.inactiveTracks)[u]??(r[u]={}),(s=t.inactiveTracks[u]).recv??(s.recv=[]),t.inactiveTracks[u].recv.push(this.activeChannels[u].recv[l.id]))}}};function DD(e,t){return!t||e.getSimulcastContext()?.activeRids.map(String).some((e=>e===t))}function kD(e,t){return e.getMediaEntities().find((e=>e.getRemoteSsrc()===t))}function ND(e,t){const i=e.getMediaEntities();return void 0!==t?i.find((e=>e.getRemoteTrackId()===t)):void 0}function LD(e,t,i){return e.getMediaEntities().find((e=>e.getLocalSsrc()===t&&DD(e,i)))}function xD(e,t,i){const n=e.getMediaEntities();return t?n.find((e=>e.getLocalTrackId()===t&&DD(e,i))):void 0}function FD(e,t,i){const n=e.getObjectRef().qualityManager;return"video"===t?n?.currentVideoSsrcRequestedCapabilities[`${i}`]:"sharing"===t?n?.currentSharingSsrcRequestedCapabilities[`${i}`]:void 0}function UD(e,t,i){const n=e.getObjectRef().qualityManager;return"video"===t?n?.currentVideoSsrcAppliedCapabilities[`${i}`]:"sharing"===t?n?.currentSharingSsrcAppliedCapabilities[`${i}`]:void 0}function VD(e,t){return e.getObjectRef().remoteVideoManager?.renderers.find((e=>e.trackId===t))}function HD(e,t,i){const n=e.getMediaEntities();return t?n.find((e=>e.getMid()===t&&DD(e,i))):void 0}var BD=class{constructor(){this.googCandidatePair={},this.ssrc={},this.googComponent={},this.VideoBwe={bweforvideo:{}}}},$D=class{constructor(){this.statistics=new BD,this.statsDiffMap=new Map,this.ssrcTrackMap=new Map}build(e){return this.statistics=new BD,this.constructGoogCandidatePair(e),this.constructGoogSsrc(e),this.constructGoogComponent(e),this.constructDataChannel(e),this.constructBwe(e),this.statistics}setSsrcTrackPair(e,t){null===t?this.ssrcTrackMap.delete(e):this.ssrcTrackMap.set(e,t)}setAudioDecoderStatsProvider(e){this.audioDecoderStatsProvider=e}constructGoogSsrc(e){const t={};if(e.hasOwnProperty("outbound-rtp")){const i=e["outbound-rtp"];Object.keys(i).forEach((n=>{const r=`ssrc_${i[n].ssrc}_send`,s=this.constructSendSsrc(e,i[n]);t[r]=s}))}if(e.hasOwnProperty("inbound-rtp")){const i=e["inbound-rtp"];Object.keys(i).forEach((n=>{const r=`ssrc_${i[n].ssrc}_recv`,s=this.constructRecvSsrc(e,i[n]);t[r]=s}))}this.statistics.ssrc=t}constructSendSsrc(e,t){const i=t.trackId?e.track[t.trackId]:null,n=t.mediaSourceId?e["media-source"][t.mediaSourceId]:null,r=e["remote-inbound-rtp"]?.[t.remoteId],s=`ssrc_${t.ssrc}_send`,a=n?.trackIdentifier??i?.trackIdentifier??this.ssrcTrackMap.get(t.ssrc);let o={id:s,ssrc:t.ssrc,mediaType:t.mediaType??t.kind,bytesSent:t.bytesSent,bytesSentDiff:this.calculateDiff(s,t.bytesSent,4),packetsSent:t.packetsSent,packetsLost:r?.packetsLost,jitter:r?.jitter,googRtt:this.getRtt(r),googCodecName:this.getCodec(e,t.codecId),transportId:t.transportId,googTrackId:a};return"audio"===o.mediaType&&(o={...o,...this.constructAudioSendSsrc(t,n)}),"video"===o.mediaType&&(o={...o,...this.constructVideoSendSsrc(t,n,s,i)}),pt(o)}constructAudioSendSsrc(e,t){return{audioInputLevel:t?.audioLevel,totalAudioEnergy:t?.totalAudioEnergy,fecPacketsSent:e.fecPacketsSent}}constructVideoSendSsrc(e,t,i,n){return{framesEncoded:e.framesEncoded,googFrameRateEncoded:this.calculateDiff(i,e.framesEncoded,2),googFrameRateSent:this.calculateDiff(i,e.framesSent??n?.framesSent,1),googFrameRateInput:t?.framesPerSecond,googFrameHeightSent:e.frameHeight??n?.frameHeight,googFrameWidthSent:e.frameWidth??n?.frameWidth,googFrameHeightInput:t?.height,googFrameWidthInput:t?.width,hugeFramesSent:e.hugeFramesSent??n?.hugeFramesSent,keyFramesEncoded:e.keyFramesEncoded,qpSum:e.qpSum,qp:this.calculateDiff(i,e.qpSum,8),googPlisReceived:e.pliCount,googFirsReceived:e.firCount,googNacksReceived:e.nackCount,qualityLimitationDurations:e.qualityLimitationDurations,qualityLimitationReason:e.qualityLimitationReason,qualityLimitationResolutionChanges:e.qualityLimitationResolutionChanges,codecImplementationName:e.encoderImplementation,rid:e.rid,encodeTime:e.totalEncodeTime&&Math.round(1e3*this.calculateDiff(i,e.totalEncodeTime,6))}}constructRecvSsrc(e,t){const i=t.trackId?e.track[t.trackId]:null,n=`ssrc_${t.ssrc}_recv`,r=t.trackIdentifier??i?.trackIdentifier??this.ssrcTrackMap.get(t.ssrc);let s={id:n,ssrc:t.ssrc,mediaType:t.mediaType??t.kind,bytesReceived:t.bytesReceived,bytesReceivedDiff:this.calculateDiff(n,t.bytesReceived,5),packetsReceived:t.packetsReceived,packetsLost:t.packetsLost,jitter:t.jitter,googJitterBufferMs:t.jitterBufferEmittedCount&&Math.round(t.jitterBufferDelay/t.jitterBufferEmittedCount*1e3),googCodecName:this.getCodec(e,t.codecId),googTrackId:r,transportId:t.transportId};return"audio"===s.mediaType&&(s={...s,...this.constructAudioRecvSsrc(t,i)}),"video"===s.mediaType&&(s={...s,...this.constructVideoRecvSsrc(t,n,i)}),pt(s)}constructAudioRecvSsrc(e,t){const i=this.audioDecoderStatsProvider?.ssrc===e.ssrc?this.audioDecoderStatsProvider?.getWebRtcCompatibaleStats():e,n={audioOutputLevel:i.audioLevel??t?.audioLevel,totalAudioEnergy:i.totalAudioEnergy??t?.totalAudioEnergy,concealedSamples:i.concealedSamples,silentConcealedSamples:i.silentConcealedSamples,totalSamplesReceived:i.totalSamplesReceived,healedRatio:i.totalSamplesReceived&&(i.concealedSamples-i.silentConcealedSamples)/i.totalSamplesReceived,fecPacketsReceived:i.fecPacketsReceived,fecPacketsDiscarded:i.fecPacketsDiscarded,packetsDiscarded:i.packetsDiscarded};if(this.audioDecoderStatsProvider?.ssrc===e.ssrc){n.googJitterBufferMs=i.jitterBufferEmittedCount&&Math.round(i.jitterBufferDelay/i.jitterBufferEmittedCount*1e3),n.googCodecName=this.audioDecoderStatsProvider.codecName;const e=this.audioDecoderStatsProvider.getDecoderStats();n.pushCount=e.pushCount,n.pushErrCount=e.pushErrCount,n.pullCount=e.pullCount,n.pullErrCount=e.pullErrCount}return n}constructVideoRecvSsrc(e,t,i){return{framesDecoded:e.framesDecoded,googFrameRateDecoded:this.calculateDiff(t,e.framesDecoded,3),googFrameRateReceived:this.calculateDiff(t,e.framesReceived??i?.framesReceived,0),googFrameHeightReceived:e.frameHeight??i?.frameHeight,googFrameWidthReceived:e.frameWidth??i?.frameWidth,keyFramesDecoded:e.keyFramesDecoded,googPlisSent:e.pliCount,googFirsSent:e.firCount,googNacksSent:e.nackCount,codecImplementationName:e.decoderImplementation,decodeTime:e.totalDecodeTime&&Math.round(1e3*this.calculateDiff(t,e.totalDecodeTime,7))}}constructGoogCandidatePair(e){const t=e["candidate-pair"];t&&Object.keys(t).forEach((i=>{const n=this.constructPair(e,t[i]);this.statistics.googCandidatePair[n.id]=n}))}constructPair(e,t){const i=e["local-candidate"][t.localCandidateId],n=e["remote-candidate"][t.remoteCandidateId];return pt({bytesReceived:t.bytesReceived,bytesSent:t.bytesSent,googTransportType:i.protocol,googRtt:t.currentRoundTripTime?Math.round(1e3*t.currentRoundTripTime):void 0,googLocalAddress:`${i.ip?i.ip:i.address}:${i.port}`,googLocalCandidateType:i.candidateType,localRelayProtocol:i.relayProtocol,localNetworkType:i.networkType,googRemoteAddress:`${n.ip?n.ip:n.address}:${n.port}`,googRemoteCandidateType:n.candidateType,googActiveConnection:t.nominated,requestsReceived:t.requestsReceived,requestsSent:t.requestsSent,responsesReceived:t.responsesReceived,responsesSent:t.responsesSent,consentRequestsSent:t.consentRequestsSent,id:t.id,remoteCandidateId:t.remoteCandidateId,localCandidateId:t.localCandidateId,googWritable:t.writable,selected:t.selected,packetsDiscardedOnSend:t.packetsDiscardedOnSend})}constructGoogComponent(e){e.transport&&Object.keys(e.transport).forEach((t=>{this.statistics.googComponent[t]={id:t,selectedCandidatePairId:e.transport[t].selectedCandidatePairId}}))}constructDataChannel(e){if(!e.hasOwnProperty("data-channel"))return;const t=e["data-channel"];this.statistics.data=Object.keys(t).map((e=>{const i=t[e];return{bytesReceived:i.bytesReceived,bytesSent:i.bytesSent,dataChannelIdentifier:i.dataChannelIdentifier,label:i.label,messagesReceived:i.messagesReceived,messagesSent:i.messagesSent,protocol:i.protocol,state:i.state,timestamp:i.timestamp,type:i.type}}))}constructBwe(e){const t=Object.values(e["outbound-rtp"]??{})?.find((e=>{const t=e.mediaType??e.kind;return"audio"===t||"video"===t}));if(!t)return;const i=e.transport?.[t.transportId];if(!i)return;const n=e["candidate-pair"]?.[i.selectedCandidatePairId];if(!n)return;const r={googAvailableSendBandwidth:n.availableOutgoingBitrate,googAvailableReceiveBandwidth:n.availableIncomingBitrate};this.statistics.VideoBwe.bweforvideo=pt(r)}getRtt(e){const t=e?.roundTripTime;return t?Math.round(1e3*t):void 0}getCodec(e,t){if(t&&e.codec&&e.codec[t])return e.codec[t].mimeType.split("/")[1]}calculateDiff(e,t,i){if(void 0===t)return;let n=t;const r=this.statsDiffMap.has(e)?this.statsDiffMap.get(e):new Map;if(r.has(i)){const e=r.get(i);e<=t&&(n=t-e)}return r.set(i,t),this.statsDiffMap.set(e,r),isNaN(n)?void 0:n}},jD=i(496486),GD=i(496486),WD=class{constructor(e){this.healedRatio=0,this.healedRatioMax=0,this.healedRatioDuration=0,this.healedRatioTotal=0,this.totalSamplesReceivedDiff=0;const t=e.config;this.networkDetectionDuration=t.webrtcStatNetworkDetectionDuration,this.networkRecvQualityDiagnostics=t.networkRecvQualityDiagnostics,this.networkRecvQualityDiagnostics&&(this.healedRatioAccumulator=new zA(t.webrtcHealedRatioExtendedWindowSize),this.concealedSamplesAccumulator=new zA(t.webrtcHealedRatioExtendedWindowSize),this.silentConcealedSamplesAccumulator=new zA(t.webrtcHealedRatioExtendedWindowSize),this.totalSamplesReceivedAccumulator=new zA(t.webrtcHealedRatioExtendedWindowSize),this.concealedSamplesDiffAccumulator=new zA(t.webrtcHealedRatioExtendedWindowSize),this.silentConcealedSamplesDiffAccumulator=new zA(t.webrtcHealedRatioExtendedWindowSize),this.totalSamplesReceivedDiffAccumulator=new zA(t.webrtcHealedRatioExtendedWindowSize))}captureHealedRatioSamples(e,t,i){!e||!t||!i||e.length<=this.networkDetectionDuration||t.length<=this.networkDetectionDuration||i.length<=this.networkDetectionDuration||this.setHealedRatioPerDuration(e,t,i)}getHealedRatioMax(){return this.healedRatioMax}getHealedRatioAvg(){return this.healedRatioDuration?this.healedRatioTotal/this.healedRatioDuration:0}getHealedRatio(){return this.healedRatio}getTotalSamplesReceivedDiff(){return this.totalSamplesReceivedDiff}setHealedRatioPerDuration(e,t,i){const n=-1-this.networkDetectionDuration,r=Math.max((0,GD.last)(e)-(0,GD.nth)(e,n),0),s=Math.max((0,GD.last)(t)-(0,GD.nth)(t,n),0);this.totalSamplesReceivedDiff=Math.max((0,GD.last)(i)-(0,GD.nth)(i,n),0),0!==this.totalSamplesReceivedDiff&&(this.healedRatio=(r-s)/this.totalSamplesReceivedDiff,this.healedRatioDuration++,this.healedRatioTotal+=this.healedRatio,this.healedRatioMax=Math.max(this.healedRatioMax,this.healedRatio),this.networkRecvQualityDiagnostics&&(this.concealedSamplesAccumulator.add((0,GD.last)(e)),this.silentConcealedSamplesAccumulator.add((0,GD.last)(t)),this.totalSamplesReceivedAccumulator.add((0,GD.last)(i)),this.concealedSamplesDiffAccumulator.add(r),this.silentConcealedSamplesDiffAccumulator.add(s),this.totalSamplesReceivedDiffAccumulator.add(this.totalSamplesReceivedDiff),this.healedRatioAccumulator.add(this.healedRatio)))}getDiagnostics(e){return{quality:(0,GD.last)(e),qualityLevels:e,concealedSamples:this.concealedSamplesAccumulator.items,silentConcealedSamples:this.silentConcealedSamplesAccumulator.items,totalSamplesReceived:this.totalSamplesReceivedAccumulator.items,concealedSamplesDiff:this.concealedSamplesDiffAccumulator.items,silentConcealedSamplesDiff:this.silentConcealedSamplesDiffAccumulator.items,totalSamplesReceivedDiff:this.totalSamplesReceivedDiffAccumulator.items,healedRatio:this.healedRatioAccumulator.items.map((e=>bt(e)))}}},qD=class{constructor(e=100){this.minPacketsReceivedToCalculatePacketLossRate=e,this.packetsReceivedForPrevWindow=0,this.packetsLostForPrevWindow=0,this.packetLostRateMax=0,this.totalPacketsLost=0,this.totalPacketsRecv=0,this.packetsLostDuration=0}capturePacketsLostAndPacketsReceived(e,t){this.packetsLostDuration+=tt.TIME_INTERVAL.SEC_1,this.totalPacketsRecv=t,this.totalPacketsLost=e,this.calculateMaxLostRateInWindowSize(e,t)}getPacketsLostRateMax(){return this.packetLostRateMax}getNetworkAvgLostRate(){const e=this.totalPacketsLost+this.totalPacketsRecv;return e>0?this.totalPacketsLost/e:0}getAvgPacketsLost(){return this.totalPacketsLost?bt(this.totalPacketsLost/this.packetsLostDuration,2):0}calculateMaxLostRateInWindowSize(e,t){const i=t-this.packetsReceivedForPrevWindow;if(i<this.minPacketsReceivedToCalculatePacketLossRate)return;this.packetsReceivedForPrevWindow=t;const n=e-this.packetsLostForPrevWindow;this.packetsLostForPrevWindow=e,this.packetLostRateMax=Math.max(bt(n*this.minPacketsReceivedToCalculatePacketLossRate/(n+i),2),this.packetLostRateMax)}},zD=class{constructor(e){this.configProvider=e,this.audioAnalyzers=new Map,this.jitterBufferDuration=0,this.jitterBufferTotal=0,this.jitterTotal=0,this.jitterDuration=0,this.rttDuration=0,this.rttTotal=0,this.rttMax=0,this.jitterMax=0,this.webrtcAudioPacketLossRate=new qD(e.config.minPacketsReceivedToCalculatePacketLossRate)}captureJitterBuffer(e){this.jitterBufferDuration+=tt.TIME_INTERVAL.SEC_1,this.jitterBufferTotal+=e}captureJitter(e){const t=1e3*e;this.jitterTotal+=t,this.jitterMax=Math.max(t,this.jitterMax),this.jitterDuration+=tt.TIME_INTERVAL.SEC_1}getJitterAvg(){return this.jitterDuration?bt(this.jitterTotal/this.jitterDuration):0}getAvgJitterBuffer(){return this.jitterBufferDuration?Math.round(this.jitterBufferTotal/this.jitterBufferDuration):0}capturePacketsLostAndPacketsReceived(e,t){this.webrtcAudioPacketLossRate.capturePacketsLostAndPacketsReceived(e,t)}getPacketsLostRateMax(){return this.webrtcAudioPacketLossRate.getPacketsLostRateMax()}getNetworkAvgLostRate(){return this.webrtcAudioPacketLossRate.getNetworkAvgLostRate()}getAvgPacketsLost(){return this.webrtcAudioPacketLossRate.getAvgPacketsLost()}captureRtt(e){if(null!==e){const t=parseInt(e);this.rttDuration+=tt.TIME_INTERVAL.SEC_1,this.rttTotal+=t,this.rttMax=Math.max(this.rttMax,t)}}getAvgRtt(){return this.rttDuration?bt(this.rttTotal/this.rttDuration):0}getMaxRtt(){return this.rttMax}getJitterMax(){return this.jitterMax}updateSendStream(e,t){if(!this.configProvider.config.useAudioAnalyzer)return;const i=this.audioAnalyzers.get(t);i&&(i.dispose(),this.audioAnalyzers.delete(t)),e?.rawStream?.getAudioTracks().length&&this.audioAnalyzers.set(t,new aM(e.rawStream))}getInputLevel(e){const t=this.audioAnalyzers.get(e);return t?.getInputLevel()}},KD=class{constructor(e,t){this.dropBadBandwidth=e,this.dropGoodBandwidth=t,this.dropDurationCounts={},Object.keys(tt.HISTOGRAM_BATCH).forEach((e=>{this.dropDurationCounts[e]=0}))}recordSendBandwidth(e){this.currentDropDuration&&e<this.dropGoodBandwidth||e<this.dropBadBandwidth?this.initiateDrop():this.currentDropDuration&&e>this.dropGoodBandwidth&&this.recoverDrop()}getReport(){const e=ht(this.dropDurationCounts);return this.currentDropDuration&&(e.ongoingDuration=this.currentDropDuration),e}initiateDrop(){this.currentDropDuration?this.currentDropDuration++:this.currentDropDuration=1}recoverDrop(){for(const e of Object.keys(tt.HISTOGRAM_BATCH))if(this.currentDropDuration<=tt.HISTOGRAM_BATCH[e]){this.dropDurationCounts[e]+=1,this.currentDropDuration=0;break}}},JD=i(496486),YD=class{constructor(e,t,i,n){this.lowThreshold=e,this.highThreshold=t,this.isLowerBetter=i,this.curInLowerRange=i,this.stateTracker=new QD(n)}onSample(e,t){let i=this.curInLowerRange;this.curInLowerRange?e>this.highThreshold&&(i=!1):e<this.lowThreshold&&(i=!0);const n=this.stateTracker.onNewState(this.getQuality(i),t);return n!==this.getQuality(this.curInLowerRange)&&(this.curInLowerRange=i),n}getQuality(e){return e===this.isLowerBetter?"Good":"Bad"}},QD=class{constructor(e){this.stickinessTime=e}onNewState(e,t){return"Good"!==e&&"Bad"!==e?this.curState:0===this.stickinessTime?e:e===this.curState?(this.stickTimerStarted=0,this.curState):("Bad"===this.curState?0===this.stickTimerStarted?this.stickTimerStarted=t:t-this.stickTimerStarted>this.stickinessTime&&(this.curState=e,this.stickTimerStarted=0):(this.curState=e,this.stickTimerStarted=0),this.curState)}},XD=class{constructor(e,t,i,n){this.stateProcessor=e,this.windowSize=t,this.extendedWindowSize=i,this.addDiagnosticData=n,this.dataAccumulator=new zA(i),this.avgAccumulator=new zA(i)}getLatestSendQuality(e,t,i){if(this.dataAccumulator.add(e),this.dataAccumulator.items.length>=this.windowSize){const e=this.dataAccumulator.items.slice(-this.windowSize),i=(0,JD.mean)(e);return this.addDiagnosticData&&this.avgAccumulator.add(i),this.stateProcessor.onSample(i,t)}return i}getData(){return this.dataAccumulator.items.map((e=>bt(e)))}getAggregatedData(){return this.avgAccumulator.items.map((e=>bt(e)))}},ZD=class{constructor(e,t,i){this.configProvider=e,this.newStatsApi=t,this.webrtcHealedRatio=i,this.sendAccumulator=new zA(this.configProvider.config.webrtcLossRateExtendedWindowSize),this.lostAccumulator=new zA(this.configProvider.config.webrtcLossRateExtendedWindowSize),this.sendDiffAccumulator=new zA(this.configProvider.config.webrtcLossRateExtendedWindowSize),this.lostDiffAccumulator=new zA(this.configProvider.config.webrtcLossRateExtendedWindowSize),this.totalAccumulator=new zA(this.configProvider.config.webrtcLossRateExtendedWindowSize),this.sendQualityAccumulator=new zA(this.configProvider.config.webrtcLossRateExtendedWindowSize),this.sendDiagnosticsEnabled=this.configProvider.config.networkSendQualityDiagnostics,this.recvDiagnosticsEnabled=this.configProvider.config.networkRecvQualityDiagnostics,this.recvQualityAccumulator=new zA(this.configProvider.config.webrtcHealedRatioExtendedWindowSize);const n=Number(this.configProvider.config.webrtcStatNetworkDetectionHysteresis);this.networkDetectionBadLevelHigh=Number(this.configProvider.config.webrtcStatNetworkDetectionBadLevel)+n/2,this.networkDetectionBadLevelLow=this.networkDetectionBadLevelHigh-n,this.networkDetectionGoodLevelHigh=Number(this.configProvider.config.webrtcStatNetworkDetectionGoodLevel)+n/2,this.networkDetectionGoodLevelLow=this.networkDetectionGoodLevelHigh-n;const r=new YD(e.config.webrtcJitterLowThreshold,e.config.webrtcJitterHighThreshold,!0,e.config.webrtcJitterSticknessTime),s=new YD(e.config.webrtcLossRateLowThreshold,e.config.webrtcLossRateHighThreshold,!0,e.config.webrtcLossRateSticknessTime);this.jitterCalculator=new XD(r,e.config.webrtcJitterWindowSize,e.config.webrtcJitterExtendedWindowSize,this.sendDiagnosticsEnabled),this.lossRateCalculator=new XD(s,e.config.webrtcLossRateWindowSize,e.config.webrtcLossRateExtendedWindowSize,this.sendDiagnosticsEnabled)}calculateNetworkSendQualityLevel(e,t,i,n){if(!e||!t)return{quality:n};if(e.length<2||t.length<2||(0,JD.last)(e)<this.configProvider.config.webrtcMinPacketsSentForNetworkSendQuality)return{quality:n};const r=Date.now(),s=(0,JD.last)(i),a=this.jitterCalculator.getLatestSendQuality(s,r,n),[o,l]=e.slice(-2),[d,c]=t.slice(-2),h=this.getLossRate(l,o,c,d),u=this.lossRateCalculator.getLatestSendQuality(h,r,n),p="Good"===a&&"Good"===u?"Good":"Bad";return this.sendDiagnosticsEnabled&&(this.sendAccumulator.add(l),this.lostAccumulator.add(c),this.sendQualityAccumulator.add(p)),this.sendDiagnosticsEnabled?{quality:p,packetsSend:this.sendAccumulator.items,packetsLost:this.lostAccumulator.items,packetsSendDiff:this.sendDiffAccumulator.items,packetsLostDiff:this.lostDiffAccumulator.items,lossRates:this.lossRateCalculator.getData(),lossRatesAggregated:this.lossRateCalculator.getAggregatedData(),jitter:this.jitterCalculator.getData(),jitterAggregated:this.jitterCalculator.getAggregatedData(),qualityLevels:this.sendQualityAccumulator.items}:{quality:p}}calculateNetworkRecvQualityLevel(e){if(this.newStatsApi){const t=e;return this.calculateNetworkRecvQualityLevelNewStatsApi(t.concealedSamples,t.silentConcealedSamples,t.totalSamplesReceived,t.oldNetworkLevel)}{const t=e;return this.calculateNetworkRecvQualityLevelLegacyStatsApi(t.googDecodingCTN,t.googDecodingPLC,t.oldNetworkLevel)}}calculateNetworkRecvQualityLevelLegacyStatsApi(e,t,i){const n=this.configProvider.config.webrtcStatNetworkDetectionDuration;if(!e||!t||e.length<2*n)return{quality:i};let r=e.length-1-n;const s=e[e.length-1];for(;r>=0&&s-e[r]<100*n;)r--;if(r<0)return{quality:i};const a=s-e[r],o=t[t.length-1]-t[r];if(a<=0)return{quality:i};const l=o/a;return{quality:this.getRecvQuality(l,i)}}calculateNetworkRecvQualityLevelNewStatsApi(e,t,i,n){const r=this.configProvider.config.webrtcStatNetworkDetectionDuration;if(!e||e.length<=r||!t||t.length<=r||!i||i.length<=r)return{quality:n};if((0,JD.last)(i)<this.configProvider.config.webrtcMinAudioSamplesRecvForNetworkRecvQuality)return{quality:n};if(0===this.webrtcHealedRatio.getTotalSamplesReceivedDiff())return{quality:n};const s=this.webrtcHealedRatio.getHealedRatio(),a=this.getRecvQuality(s,n);return this.recvDiagnosticsEnabled?(this.recvQualityAccumulator.add(a),this.webrtcHealedRatio.getDiagnostics(this.recvQualityAccumulator.items)):{quality:a}}getRecvQuality(e,t){return e<this.networkDetectionGoodLevelLow?"Good":e<this.networkDetectionGoodLevelHigh?"Good"===t?"Good":"Poor":e<this.networkDetectionBadLevelLow?"Poor":e<this.networkDetectionBadLevelHigh?"Bad"===t?"Bad":"Poor":"Bad"}getLossRate(e,t,i,n){const r=e-t,s=i-n,a=r+s;return this.sendDiagnosticsEnabled&&(this.sendDiffAccumulator.add(r),this.lostDiffAccumulator.add(s),this.totalAccumulator.add(a)),a>0?s/a:0}},ek=class{constructor(e){this.configProvider=e,this.qualityLimitationReasonEvents=[]}setQualityLimitationReason(e){this.lastQualityLimitationReason!==e&&this.qualityLimitationReasonEvents.push({event:e,startTime:Date.now(),endTime:Date.now()}),this.qualityLimitationReasonEvents.length>this.configProvider.config.maxStoredQualityLimitationReasonEvents&&this.qualityLimitationReasonEvents.shift(),this.lastQualityLimitationReason=e}getQualityLimitationReasonEvents(){return this.qualityLimitationReasonEvents.reduce(((e,t,i)=>"none"===t.event?e:[...e,{...t,endTime:this.qualityLimitationReasonEvents[i+1]?.startTime??Date.now()}]),[])}},tk=class{constructor(){this.bitrateData={[tt.MEDIA_DIRECTION.SEND]:{lastBytes:0,lastTimestamp:0,maxSample:0,bitrateTotal:0,nSamples:0,allocateBW:0,allocateBWSamples:0},[tt.MEDIA_DIRECTION.RECV]:{lastBytes:0,lastTimestamp:0,maxSample:0,bitrateTotal:0,nSamples:0}}}captureSample(e,t){const i=Date.now()/1e3;if(0!==this.bitrateData[e].lastTimestamp&&t>this.bitrateData[e].lastBytes){const n=i-this.bitrateData[e].lastTimestamp,r=8*(t-this.bitrateData[e].lastBytes)/n;this.onBitrateSample(e,r)}this.bitrateData[e].lastTimestamp=i,this.bitrateData[e].lastBytes=t}getMax(e){return Math.round(this.bitrateData[e].maxSample)}getAvg(e){return 0===this.bitrateData[e].nSamples?0:Math.round(this.bitrateData[e].bitrateTotal/this.bitrateData[e].nSamples)}stopCapture(e){this.bitrateData[e].lastBytes=0,this.bitrateData[e].lastTimestamp=0}onBitrateSample(e,t){t>this.bitrateData[e].maxSample&&(this.bitrateData[e].maxSample=t),this.bitrateData[e].bitrateTotal+=t,this.bitrateData[e].nSamples++}captureAllocateBandwidth(e){if(e){const t=parseInt(e[e.length-1]);this.bitrateData[tt.MEDIA_DIRECTION.SEND].allocateBW+=t,this.bitrateData[tt.MEDIA_DIRECTION.SEND].allocateBWSamples+=1}}getAllocateBandwidthAvg(){const e=this.bitrateData[tt.MEDIA_DIRECTION.SEND].allocateBW,t=this.bitrateData[tt.MEDIA_DIRECTION.SEND].allocateBWSamples;if(e>0&&t>0)return Math.floor(e/t)}},ik=class{constructor(e,t){this.maxAppliedCapabilitiesCount=t,this.events=[],this.events.push({eventType:"req",timestamp:Date.now(),capabilities:e.capabilities,isSimulcast:e.isSimulcastEnabled})}setMaxCapabilitiesApplied(e){this.events.push({eventType:"app",timestamp:Date.now(),capabilities:e.capabilities,error:e.error?`${e.error}`:"none"}),this.maxAppliedCapabilitiesCount&&this.events.length>this.maxAppliedCapabilitiesCount+1&&this.events.splice(1,1)}getEvents(){return this.events}},nk=class{constructor(e,t){this.configProvider=e,this.logger=t,this.resolutionChangeRequestRecords={},this.currentResolutionsByRid={},this.resolutionChangeCounterByRid={},this.events=[],this.errors=[]}setMaxCapabilitesRequested(e){const t=new ik(e,this.configProvider.config.webrtcLastAppliedVideoCapabilitiesCount);this.events.push({causeId:e.causeId,seq:t}),this.recordResolutionChange(e),this.configProvider.config.webrtcLastAppliedVideoCapabilitiesSequenceCount&&this.events.length>this.configProvider.config.webrtcLastAppliedVideoCapabilitiesSequenceCount&&this.events.shift()}setMaxCapabilitesApplied(e){const t=this.events.find((t=>t.causeId===e.causeId));t?(t.seq.setMaxCapabilitiesApplied(e),e.error&&this.errors.push(t)):this.logger.safe.warn(`Requested capabilities with id ${e.causeId} not found`)}getEvents(){return this.events.map((e=>({causeId:e.causeId,events:e.seq.getEvents()})))}getErrors(){return this.errors.map((e=>({causeId:e.causeId,events:e.seq.getEvents()})))}getResolutionRecords(){if(this.configProvider.config.specCompliantSimulcast?.collectResolutionInfo)return{req:this.resolutionChangeRequestRecords,count:this.resolutionChangeCounterByRid}}recordResolutionChange(e){if(this.configProvider.config.specCompliantSimulcast?.collectResolutionInfo){const t=Object.keys(this.currentResolutionsByRid),i=e=>e.rid||"default";[...t,...e.capabilities.map((e=>i(e)))].forEach((t=>{const n=e.capabilities.find((e=>i(e)===t)),r=this.currentResolutionsByRid[t]||0,s=n?.maxFs||0;if(r===s)return;this.resolutionChangeRequestRecords[t]||(this.resolutionChangeRequestRecords[t]=[],this.resolutionChangeCounterByRid[t]=0);const a=this.resolutionChangeRequestRecords[t].find((e=>e.from===r&&e.to===s));a?a.counter++:this.resolutionChangeRequestRecords[t].push({from:r,to:s,counter:1}),this.currentResolutionsByRid[t]=s,this.resolutionChangeCounterByRid[t]++}))}}},rk=class{constructor(){this.delayCur=[],this.delayTotal=0,this.delayEventCount=0}analyzeDelay(e,t){if(t&&""!==t){this.delayCur.length===e&&this.delayCur.shift();const i=parseInt(t);this.delayCur.push(i),this.delayTotal+=i,this.delayEventCount+=tt.TIME_INTERVAL.SEC_1}}getDelayCur(){if(this.delayCur.length>0){const e=this.delayCur.reduce(((e,t)=>e+t))/this.delayCur.length;return e<0?0:e}}getDelayAvg(){if(this.delayEventCount>0&&this.delayTotal>0){const e=this.delayTotal/this.delayEventCount;return e<0?0:e}}},sk=class{constructor(e,t){this.configProvider=e,this.startTime=t,this.recvTotalFreezeDuration=-1,this.recvFreezeDurations=[],this.recvFreezeIsOngoing=!1,this.recvCurrentFreezeDuration=0,this.recvFreezeCount=0,this.receiveFreezeDurationCounts={},this.longestRecvFreezeDuration=0,this.sendCameraFreezeIntervalsCount=0,this.previousInputFrame=0,this.recvCurrentFreezeStartTimestamp=0,this.receiveFreezeDurationTimestamps={},this.finalFreezeIsOngoing=!1,this.finalRecvCurrentFreezeDuration=0,this.mediaStarted=!1,this.lastBytesRecv=0,this.currentLowBitrateDuration=0,Object.keys(tt.HISTOGRAM_BATCH).forEach((e=>{this.receiveFreezeDurationCounts[e]=0,this.receiveFreezeDurationTimestamps[e]=[]}))}gatherFreezeData({frameRateDecoded:e,frameRateRecv:t,bytesReceived:i,mediaType:n}){if(e){const r=parseInt(e[e.length-1],10),s=t?.length>0?parseInt(t[t.length-1],10):void 0;void 0!==i&&"ScreenShare"!==n&&this.configProvider.config.isBytesRecvUsedInIsRenderingCalculation&&!this.configProvider.config.isRenderingBasedOnRawStatistics&&this.calculateBitrate(i,r),-1===this.recvTotalFreezeDuration&&(this.recvTotalFreezeDuration=0),r>0&&(this.mediaStarted=!0),0!==r&&0!==s||!this.mediaStarted?r>0&&(void 0===s||s>0)&&this.recvFreezeIsOngoing&&this.stopRecvDataGathering(!1):(this.recvFreezeIsOngoing||(this.recvCurrentFreezeStartTimestamp=Date.now()-this.startTime),this.recvFreezeIsOngoing=!0,this.recvCurrentFreezeDuration+=tt.TIME_INTERVAL.SEC_1,this.recvTotalFreezeDuration+=tt.TIME_INTERVAL.SEC_1)}}getIsRendering(e){return this.recvCurrentFreezeDuration<e&&this.currentLowBitrateDuration<e&&this.mediaStarted}detectCaptureFreeze(e){if(e){const t=parseInt(e[e.length-1],10);this.previousInputFrame>0&&0===t&&(this.sendCameraFreezeIntervalsCount+=1),this.previousInputFrame=t}}getSendCameraFreezeIntervals(){return this.sendCameraFreezeIntervalsCount>0?this.sendCameraFreezeIntervalsCount:void 0}stopRecvDataGathering(e=!0){this.finalFreezeIsOngoing=this.recvFreezeIsOngoing,this.recvFreezeIsOngoing=!1,e&&(this.mediaStarted=!1),this.recvCurrentFreezeDuration>0&&(this.populateLongestRecvFreezeDuration(),this.populateRecvFreezeDurationCounts(),this.recvFreezeDurations.push(this.recvCurrentFreezeDuration),this.recvFreezeCount+=1),this.finalRecvCurrentFreezeDuration=this.recvCurrentFreezeDuration,this.recvCurrentFreezeDuration=0}getRecvFreezeDurationCounts(){return this.recvFreezeCount>0?JSON.stringify(this.receiveFreezeDurationCounts):void 0}getRecvFreezeDurationTimestamps(e){if(0===this.recvFreezeCount)return;const t={};return Object.keys(this.receiveFreezeDurationTimestamps).forEach((i=>{const n=this.receiveFreezeDurationTimestamps[i].length;t[i]=n>e?this.receiveFreezeDurationTimestamps[i].slice(n-e):this.receiveFreezeDurationTimestamps[i]})),JSON.stringify(t)}getRecvFreezeIsOngoing(e){return this.finalRecvCurrentFreezeDuration>=e&&this.finalFreezeIsOngoing}getRecvTotalFreezeDuration(){return this.recvTotalFreezeDuration>=0?this.recvTotalFreezeDuration:void 0}getRecvAvgFreezeDuration(){if(this.recvTotalFreezeDuration>0&&this.recvFreezeCount>0)return this.recvTotalFreezeDuration/this.recvFreezeCount}getLongestRecvFreezeDuration(){return this.longestRecvFreezeDuration>0?this.longestRecvFreezeDuration:void 0}populateRecvFreezeDurationCounts(){for(const e of Object.keys(tt.HISTOGRAM_BATCH))if(this.recvCurrentFreezeDuration<=tt.HISTOGRAM_BATCH[e]){this.receiveFreezeDurationCounts[e]+=1,this.receiveFreezeDurationTimestamps[e].push(this.recvCurrentFreezeStartTimestamp);break}this.recvCurrentFreezeStartTimestamp=0}populateLongestRecvFreezeDuration(){this.recvCurrentFreezeDuration>this.longestRecvFreezeDuration&&(this.longestRecvFreezeDuration=this.recvCurrentFreezeDuration)}calculateBitrate(e,t){const i=(e-this.lastBytesRecv)/125;this.lastBytesRecv=e,i<this.configProvider.config.notRenderingLowBitrateThreshold&&t<this.configProvider.config.notRenderingLowFramerateThreshold?this.currentLowBitrateDuration++:this.currentLowBitrateDuration=0}},ak=class{constructor(){this.mediaData={[tt.MEDIA_DIRECTION.SEND]:{totalMediaDuration:-1,totalFrameCount:0,mediaStartTimestamp:new Date,mediaStarted:!1,timeSinceLastDecode:0,cameraFrameRate:0},[tt.MEDIA_DIRECTION.RECV]:{totalMediaDuration:-1,totalFrameCount:0,mediaStartTimestamp:new Date,mediaStarted:!1,timeSinceLastDecode:0,cameraFrameRate:0}},this.gatheringSendData=!1}captureMediaData(e,t,i){const n=this.mediaData[e];if(e===tt.MEDIA_DIRECTION.SEND&&(this.gatheringSendData=!0),t){const e=parseInt(t[t.length-1],10);n.totalFrameCount+=e}if(i){-1===n.totalMediaDuration&&(n.totalMediaDuration=0);const e=parseInt(i[i.length-1],10);n.mediaStarted||e>0&&(n.mediaStarted=!0,n.mediaStartTimestamp=new Date)}n.mediaStarted&&(n.totalMediaDuration+=tt.TIME_INTERVAL.SEC_1)}captureFrameRate(e){const t=this.mediaData[tt.MEDIA_DIRECTION.SEND];if(e){const i=parseInt(e[e.length-1],10);t.cameraFrameRate+=i}}stopRecvDataGathering(){const e=this.mediaData[tt.MEDIA_DIRECTION.RECV],t=(new Date).getTime();e.timeSinceLastDecode=e.totalMediaDuration>0?Math.round((t-e.mediaStartTimestamp.getTime())/1e3):0,e.mediaStarted=!1}isGatheringSendData(){return this.gatheringSendData}stopSendDataGathering(){const e=this.mediaData[tt.MEDIA_DIRECTION.SEND],t=new Date;e.timeSinceLastDecode=e.totalMediaDuration>0?Math.round((t.getTime()-e.mediaStartTimestamp.getTime())/1e3):0,this.gatheringSendData=!1,e.mediaStarted=!1}getAvgFrameRate(e){const t=this.mediaData[e];if(t.totalMediaDuration>0&&t.totalFrameCount>0)return t.totalFrameCount/t.totalMediaDuration}getTotalDuration(e){const t=this.mediaData[e];return t.totalMediaDuration>=0?t.totalMediaDuration:void 0}getTimeSinceLastDecode(e){const t=this.mediaData[e];return t.timeSinceLastDecode>0?t.timeSinceLastDecode:void 0}getSendCameraFramerate(){const e=this.mediaData[tt.MEDIA_DIRECTION.SEND];if(e.totalMediaDuration>0)return e.cameraFrameRate/e.totalMediaDuration}},ok=class{constructor(){this.qpData={[tt.MEDIA_DIRECTION.SEND]:{frames:0,qpSum:0},[tt.MEDIA_DIRECTION.RECV]:{frames:0,qpSum:0}}}captureQpData(e,t,i){const n=this.qpData[e];if(i&&i.length>0){const e=parseInt(i[i.length-1],10);e>0&&(n.frames=e)}if(t){const e=parseInt(t,10);e>0&&(n.qpSum=e)}}getQpAverage(e){const t=this.qpData[e];if(t.qpSum>0&&t.frames>0)return t.qpSum/t.frames}},lk=class{constructor(){this.resolutionChangedCount=0,this.resDurations={},this.preferredResolutionDurations={},this.preferredResolutions=[]}get resolutionSwitchCount(){return this.resolutionChangedCount}get resolutionDurationRatios(){return this.countResolutionDurationRatio(this.resDurations)}get preferredResolutionDurationRatios(){return this.countResolutionDurationRatio(this.preferredResolutionDurations)}get preferredResolution(){return this.preferredResolutions}captureSample(e){e&&e.width&&e.height&&(this.isResolutionChanged(this.lastResolution,e)&&this.resolutionChanged(e),this.updateResolutionDuration(this.getResolutionKey(e),this.resDurations)),this.lastPreferredResolution&&this.updatePreferredResolutionDurations()}capturePreferredResolution(e,t){const i=this.getResolutionKey(e);this.preferredResolution.includes(i)||(this.preferredResolutions.length>=t&&this.preferredResolutions.shift(),this.preferredResolutions.push(i)),this.isResolutionChanged(this.lastPreferredResolution,e)&&(this.preferredResolutionChanged(e),this.updatePreferredResolutionDurations())}getResolutionKey(e){return`${e.width}x${e.height}`}isResolutionChanged(e,t){return!e||e.width!==t.width||e.height!==t.height}countResolutionDurationRatio(e){const t={};let i=0;for(const t in e)i+=e[t];for(const n in e)t[n]=bt(e[n]/i*100,2);return t}updatePreferredResolutionDurations(){this.updateResolutionDuration(this.getResolutionKey(this.lastPreferredResolution),this.preferredResolutionDurations)}updateResolutionDuration(e,t){t[e]||(t[e]=0),t[e]++}preferredResolutionChanged(e){this.lastPreferredResolution=e}resolutionChanged(e){this.lastResolution=e,this.resolutionChangedCount++}},dk=class{constructor(){this.streamsTimers={}}countRecvStreams(e){const t=`${e}`;this.streamsTimers.hasOwnProperty(t)||(this.streamsTimers[t]=0),this.streamsTimers[t]++}getStreamCounts(){const e={min:void 0,max:void 0,mode:void 0},t=Object.keys(this.streamsTimers).map(Number);return 0===t.length||1===t.length&&0===t[0]||(e.min=Math.min(...t.filter((e=>e>0))),e.max=Math.max(...t),e.mode=t.reduce(((e,t)=>this.streamsTimers[t]>this.streamsTimers[e]?t:e),t[0])),e}},ck=class{constructor(e){this.configProvider=e,this.subscriptionEvents=[],this.subscriptionCounters={attempted:0,subscribed:0,unsubscribed:0,failed:0}}addSubscriptionEvent(e){switch(this.subscriptionEvents.length>this.configProvider.config.webrtcSubscriptionEventLimit&&this.subscriptionEvents.shift(),this.subscriptionEvents.push(e),e.evt){case 1:this.subscriptionCounters.attempted++;break;case 2:this.subscriptionCounters.subscribed++;break;case 3:this.subscriptionCounters.unsubscribed++;break;case-1:this.subscriptionCounters.failed++}}getSubscriptionEvents(){return this.subscriptionEvents.length>0?{events:this.subscriptionEvents}:void 0}getSubscriptionCounters(){return this.subscriptionEvents.length>0?this.subscriptionCounters:void 0}},hk=class{constructor(e,t,i,n="Video"){this.startTime=e,this.configProvider=t,this.logger=i,this.mediaType=n,this.subscriptionCounter=0,this.videoFreezeTelemetry=new sk(this.configProvider,this.startTime),this.videoDelayTelemetry=new rk,this.videoSubscriptionEvents=new ck(this.configProvider),this.videoQPEvents=new ok,this.videoResolutionTelemetry=new lk,this.videoGeneralTelemetry=new ak,this.videoStreamsCounters=new dk,this.videoBitrate=new tk,this.videoMaxCapabilities=new nk(this.configProvider,this.logger),this.videoOvershoot=new fD(this.logger),this.videoQualityLimitations=new ek(this.configProvider),this.videoPacketLostRate=new qD(this.configProvider.config.minPacketsReceivedToCalculatePacketLossRate),this.videoStatsOnSubscribed=new ID(this.configProvider.config.maxVideoStatsAfterSubscription),this.videoResolutionSwitchTracker=new eD(this.configProvider.config.diagnostics?.collectionLimits?.numResolutionSwitches),this.timeToFirstFrame=-1,this.timeToFirstFrameSinceSubscriptionStart=-1,this.currentTrackId="",this.recvTotalFreezeDurationMs=0,this.isRenderingEvents=[]}get trackId(){return this.currentTrackId}set trackId(e){this.currentTrackId=e}get isRecvDataGatheringEnabled(){return this.subscriptionCounter>0}startStopRecvDataGathering(e){this.logger.safe.info("Receive data gathering is "+(e?"enabled":"disabled")),e?this.subscriptionCounter++:this.subscriptionCounter--,this.subscriptionCounter<0&&this.logger.safe.error(`Subscription counter should not be less than 0. Actual value is ${this.subscriptionCounter}`),0===this.subscriptionCounter&&this.stopRecvGathering()}stopDataGathering(){this.stopRecvGathering(),this.stopSendGathering()}stopRecvGathering(){this.videoFreezeTelemetry.stopRecvDataGathering(),this.videoGeneralTelemetry.stopRecvDataGathering(),this.videoBitrate.stopCapture(tt.MEDIA_DIRECTION.RECV)}isSendGathering(){return this.videoGeneralTelemetry.isGatheringSendData()}stopSendGathering(){this.videoGeneralTelemetry.stopSendDataGathering(),this.videoBitrate.stopCapture(tt.MEDIA_DIRECTION.SEND),this.videoOvershoot.flush()}gatherRecvFreezeData(e,t,i){this.videoFreezeTelemetry.gatherFreezeData({frameRateDecoded:e,frameRateRecv:t,bytesReceived:i,mediaType:this.mediaType})}detectCaptureFreeze(e){this.videoFreezeTelemetry.detectCaptureFreeze(e)}getRecvFreezeDurationCounts(){return this.videoFreezeTelemetry.getRecvFreezeDurationCounts()}getRecvFreezeDurationTimestamps(){return this.videoFreezeTelemetry.getRecvFreezeDurationTimestamps(this.configProvider.config.maxVideoFreezeTimestampsInBucket)}getRecvTotalFreezeDuration(){return this.videoFreezeTelemetry.getRecvTotalFreezeDuration()}setRecvTotalFreezeDurationMs(e){this.recvTotalFreezeDurationMs=void 0!==e?this.recvTotalFreezeDurationMs+=e:void 0}analyzeDelay(e,t){this.videoDelayTelemetry.analyzeDelay(e,t)}getDelayCur(){return this.videoDelayTelemetry.getDelayCur()}getDelayAvg(){return this.videoDelayTelemetry.getDelayAvg()}addSubscriptionEvent(e){this.videoSubscriptionEvents.addSubscriptionEvent(e)}getSubscriptionEvents(){return this.videoSubscriptionEvents.getSubscriptionEvents()}getSubscriptionCounters(){return this.videoSubscriptionEvents.getSubscriptionCounters()}captureQpData(e,t,i){this.videoQPEvents.captureQpData(e,t,i)}getQpAverage(e){return this.videoQPEvents.getQpAverage(e)}captureMediaData(e,t,i){this.videoGeneralTelemetry.captureMediaData(e,t,i)}getIsRendering(){const e=this.configProvider.config.notRenderingTimeInterval["Video"===this.mediaType?"video":"sharing"];return this.videoFreezeTelemetry.getIsRendering(e)}captureFrameRate(e){this.videoGeneralTelemetry.captureFrameRate(e)}getTotalDuration(e){return this.videoGeneralTelemetry.getTotalDuration(e)}captureResolutionSample(e){this.videoResolutionTelemetry.captureSample(e)}countRecvStreams(e){this.videoStreamsCounters.countRecvStreams(e)}captureBitrateSample(e,t){this.videoBitrate.captureSample(e,t)}captureAllocateBandwidth(e){this.videoBitrate.captureAllocateBandwidth(e)}capturePreferredResolution(e,t){this.videoResolutionTelemetry.capturePreferredResolution(e,t)}setMaxCapabilitesRequested(e,t=!1){this.videoMaxCapabilities.setMaxCapabilitesRequested(e),t||1===e.capabilities.length&&!e.capabilities[0]?.ssrc||this.setMaxCapabilitiesOvershoot(e.capabilities)}setMaxCapabilitesApplied(e,t=!1){this.videoMaxCapabilities.setMaxCapabilitesApplied(e),t||1===e.capabilities.length&&!e.capabilities[0]?.ssrc||this.setMaxCapabilitiesOvershoot(e.capabilities)}getMaxCapabilitiesEvents(){const e=this.videoMaxCapabilities.getEvents();return JSON.stringify(e)}getMaxCapabilitiesResolutionChanges(){const e=this.videoMaxCapabilities.getResolutionRecords();return e?JSON.stringify(e):""}getMaxCapabilitiesErrors(){const e=this.videoMaxCapabilities.getErrors();return e?JSON.stringify(e):""}setCurrentParameters(e,t,i){this.videoOvershoot.setCurrentParams(e,t.height/16*(t.width/16),i)}setMaxCapabilitiesOvershoot(e){this.videoOvershoot.setMaxCapabilities(e)}getOvershootEvents(){let e=this.videoOvershoot.getEvents();return e=e.slice(Math.max(0,e.length-(this.configProvider.config.maxReportedOvershootingEvents+1)),e.length),e.forEach((e=>e.timestamp=e.timestamp-this.startTime)),JSON.stringify(e)}getOvershootTotalDurations(){const e=this.videoOvershoot.getEvents();return e.forEach((e=>e.timestamp=e.timestamp-this.startTime)),JSON.stringify({fs:e.reduce(((e,t)=>"fs"===t.overshootType?e+t.duration:e),0),fps:e.reduce(((e,t)=>"fps"===t.overshootType?e+t.duration:e),0)})}setQualityLimitationReason(e){this.videoQualityLimitations.setQualityLimitationReason(e)}getQualityLimitationReasonEvents(){return this.videoQualityLimitations.getQualityLimitationReasonEvents()}captureTimeToFirstFrame(e,t){-1!==e&&(this.timeToFirstFrame=e,this.timeToFirstFrameSinceSubscriptionStart=t)}getTimeToFirstFrame(){return this.timeToFirstFrame}setIsRendering(e){At(this.isRenderingEvents,{isRendering:e,ts:Date.now()},this.configProvider.config.diagnostics.telemetryLimits.numIsRenderingEvents)}capturePacketsLostAndPacketsReceved(e,t){this.videoPacketLostRate.capturePacketsLostAndPacketsReceived(e,t)}setMsi(e){this.msi=e}setLocalMsi(e){this.localMsi=e}prepareCollectingStatsOnSubscribed(e){this.videoStatsOnSubscribed.prepareCollectingStatsOnSubscribed(e)}captureStatsOnSubscribed(e,t){this.videoStatsOnSubscribed.captureStatsOnSubscribed(e,t)}calculateResolutinSwitches(e,t){this.videoResolutionSwitchTracker.captureSample(e,t)}getReport(e,t,i=!1){const n={};if(n[t+"DurationSeconds"]=this.getTotalDuration(e),n[t+"QpAvg"]=this.getQpAverage(e),n[t+"frameRateAvg"]=this.videoGeneralTelemetry.getAvgFrameRate(e),n[t+"bitrateAvg"]=this.videoBitrate.getAvg(e),n[t+"bitrateMax"]=this.videoBitrate.getMax(e),e===tt.MEDIA_DIRECTION.SEND)n[t+"DelayCur"]=this.getDelayCur(),n[t+"DelayAvg"]=this.getDelayAvg(),n[t+"TimeSinceLastEncodeStart"]=this.videoGeneralTelemetry.getTimeSinceLastDecode(e),n[t+"AllocateBWAvg"]=this.videoBitrate.getAllocateBandwidthAvg(),n[t+"CaptureFramerateAvg"]=this.videoGeneralTelemetry.getSendCameraFramerate(),n[t+"FreezeIntervals"]=this.videoFreezeTelemetry.getSendCameraFreezeIntervals(),n[t+"MaxCapabilities"]=i?"":this.getMaxCapabilitiesEvents(),n[t+"MaxCapabilitiesErrors"]=i?"":this.getMaxCapabilitiesErrors(),n[t+"OvershootEvents"]=this.getOvershootEvents(),n[t+"OvershootDurations"]=this.getOvershootTotalDurations(),n[t+"qualityLimitationReasonEvents"]=JSON.stringify(this.getQualityLimitationReasonEvents()),n[t+"MaxCapabilitiesResolutions"]=this.getMaxCapabilitiesResolutionChanges(),n[t+"ResolutionsSwitches"]=this.videoResolutionSwitchTracker.switches?JSON.stringify(this.videoResolutionSwitchTracker.switches):"";else if(e===tt.MEDIA_DIRECTION.RECV){n[t+"TimeSinceLastDecodeStart"]=this.videoGeneralTelemetry.getTimeSinceLastDecode(e),n[t+"FreezeHistogram"]=this.getRecvFreezeDurationCounts(),n[t+"FreezeTimestamps"]=this.getRecvFreezeDurationTimestamps(),n[t+"LongestFreezeDuration"]=this.videoFreezeTelemetry.getLongestRecvFreezeDuration(),n[t+"RecvAvgFreezeDuration"]=this.videoFreezeTelemetry.getRecvAvgFreezeDuration(),n[t+"TotalFreezeDuration"]=this.getRecvTotalFreezeDuration(),n[t+"TotalFreezeDurationMs"]=this.recvTotalFreezeDurationMs,n[t+"OngoingFreeze"]=this.videoFreezeTelemetry.getRecvFreezeIsOngoing(this.configProvider.config.webrtcEndOfCallFreezeThreshold),n[t+"NumResolutionSwitches"]=this.videoResolutionTelemetry.resolutionSwitchCount,n[t+"PreferredResolution"]=this.videoResolutionTelemetry.preferredResolution,n[t+"PreferredResolutionDurations"]=JSON.stringify(this.videoResolutionTelemetry.preferredResolutionDurationRatios),n[t+"packetsLostRateMax"]=this.videoPacketLostRate.getPacketsLostRateMax(),n[t+"ResolutionDurations"]=JSON.stringify(this.videoResolutionTelemetry.resolutionDurationRatios);const i=this.videoStreamsCounters.getStreamCounts();n[t+"StreamsMin"]=i.min,n[t+"StreamsMax"]=i.max,n[t+"StreamsMode"]=i.mode,n[t+"TimeToFirstFrame"]=this.timeToFirstFrame,n[t+"TimeToFirstFrameSinceSubscriptionStart"]=this.timeToFirstFrameSinceSubscriptionStart,n[t+"LocalMsi"]=this.localMsi,n[t+"Msi"]=this.msi,n[t+"isRenderingEvents"]=JSON.stringify(this.isRenderingEvents),n[t+"statsOnSubscribed"]=JSON.stringify(this.videoStatsOnSubscribed.getStatsOnSubscribed())}return n}},uk=Symbol("mslbase"),pk=Symbol("mslsamples"),gk=class{constructor(e,t){this.logger=e,this.configProvider=t,this.currentLayouts={},this.collectedModalitySessions=[],this.startTimestamp=Date.now()}get collectedSessions(){return this.collectedModalitySessions}get highestFidelitySSRC(){if(!this.currentModalitySession)return;let e;for(const t in this.currentLayouts)e=this.getHigherFidelitySSRC(t,e);return parseInt(e)}processStats(e){const t=Object.values(e.ssrc??{}).filter((e=>e.rid&&e.ssrc&&e.googFrameHeightInput&&this.lastMaxCapabilitiesEvent?.capabilities.some((t=>t.rid===e.rid)))),i=new Map(t.map((e=>[`${e.ssrc}`,e.rid])));for(const e in this.currentLayouts)i.has(e)||this.collectLayout(e);!this.currentModalitySession&&i.size>0&&(this.currentModalitySession={timestamp:Date.now()-this.startTimestamp,duration:0,numLayouts:0,layouts:[]},this.logger.safe.info("Modality session started")),t.forEach((e=>{this.currentLayouts[`${e.ssrc}`]||this.addLayout(e)})),0===i.size&&this.currentModalitySession&&this.collectSession(),t.forEach((e=>this.processLayoutData(e)))}setMaxCapabilities(e,t){if(this.lastMaxCapabilitiesEvent=e,Object.keys(this.currentLayouts).length)for(const i of e.capabilities){const n=Object.values(this.currentLayouts).find((e=>e.rid===i.rid));n&&(t?(At(n.fmtp,{...i,timestamp:Date.now()-this.startTimestamp-this.currentModalitySession.timestamp-n.timestamp,causeId:e.causeId},this.configProvider.config.simulcastTelemetryNumFMTP),n.gatherer.setMaxCapabilitesApplied(e)):n.gatherer.setMaxCapabilitesRequested(e),n.gatherer.setMaxCapabilitiesOvershoot([i]))}}finish(){this.logger.safe.info("Finishing statistics gathering");for(const e in this.currentLayouts)this.collectLayout(e);this.currentModalitySession&&this.collectSession()}addLayout(e){const t=`${e.ssrc}`,i=e.rid,n=this.lastMaxCapabilitiesEvent?.capabilities.find((e=>e.rid===i));this.logger.safe.info(`Adding layout for ssrc ${t} rid ${i}`);const r=Date.now()-this.startTimestamp-this.currentModalitySession.timestamp,s=new hk(r,this.configProvider,this.logger.createChild(`Telemetry#${t}`));this.currentLayouts[t]={ssrc:e.ssrc,rid:i,fmtp:[{...n,timestamp:r,causeId:this.lastMaxCapabilitiesEvent?.causeId}],timestamp:r,duration:0,gatherer:s,[uk]:{firCount:e.googFirsReceived,nackCount:e.googNacksReceived,pliCount:e.googPlisReceived,framesEncoded:e.framesEncoded,bytesSent:e.bytesSent,packetsSent:e.packetsSent,packetsLost:e.packetsLost,qpSum:e.qpSum},[pk]:{firCount:[],nackCount:[],pliCount:[],framesEncoded:[],bytesSent:[],packetsSent:[],packetsLost:[],qpSum:[],frameHeightInput:[],frameHeightSent:[],frameRateInput:[],frameRateSent:[]}},s.setMaxCapabilitiesOvershoot([n]),this.currentModalitySession.numLayouts++}processLayoutData(e){const t=`${e.ssrc}`,i=this.currentLayouts[t];this.processMediaStats(i,e),i.gatherer.captureMediaData(tt.MEDIA_DIRECTION.SEND,[String(e.googFrameRateSent)],[String(e.framesEncoded)]),i.gatherer.captureFrameRate([String(e.googFrameRateInput)]),i.gatherer.captureQpData(tt.MEDIA_DIRECTION.SEND,String(e.qpSum),[String(e.framesEncoded)]),i.gatherer.captureBitrateSample(tt.MEDIA_DIRECTION.SEND,e.bytesSent),i.gatherer.detectCaptureFreeze([String(e.googFrameRateInput)]),i.gatherer.setCurrentParameters(e.ssrc,{width:e.googFrameWidthSent,height:e.googFrameHeightSent},e.googFrameRateSent)}processMediaStats(e,t){const i=e[uk],n=t.googFirsReceived-i.firCount,r=t.googNacksReceived-i.nackCount,s=t.googPlisReceived-i.pliCount,a=t.framesEncoded-i.framesEncoded,o=t.bytesSent-i.bytesSent,l=t.packetsSent-i.packetsSent,d=t.packetsLost-i.packetsLost,c=t.qpSum-i.qpSum,h=e[pk],u=this.configProvider.config.webrtcStatStoredRecordsNumber;At(h.firCount,n,u),At(h.nackCount,r,u),At(h.pliCount,s,u),At(h.framesEncoded,a,u),At(h.bytesSent,o,u),At(h.packetsSent,l,u),At(h.packetsLost,d,u),At(h.qpSum,c,u),At(h.frameHeightInput,t.googFrameHeightInput,u),At(h.frameHeightSent,t.googFrameHeightSent,u),At(h.frameRateInput,t.googFrameRateInput,u),At(h.frameRateSent,t.googFrameRateSent,u)}collectLayout(e){this.logger.safe.info(`Collecting layout for ssrc ${e}`),this.currentLayouts[e].duration=Date.now()-this.startTimestamp-this.currentModalitySession.timestamp-this.currentLayouts[e].timestamp,this.currentLayouts[e].gatherer.isSendGathering()&&this.currentLayouts[e].gatherer.stopSendGathering();const t=this.currentLayouts[e].gatherer.getReport(tt.MEDIA_DIRECTION.SEND,"",!1);for(const i in t)this.currentLayouts[e][i]=t[i];for(const t in this.currentLayouts[e][pk])this.currentLayouts[e][t]=Ft(this.currentLayouts[e][pk][t],(e=>e));delete this.currentLayouts[e].gatherer,At(this.currentModalitySession.layouts,this.currentLayouts[e],this.configProvider.config.simulcastTelemetryLayoutsPerSession),delete this.currentLayouts[e]}collectSession(){this.logger.safe.info("Collecting session");for(const e in this.currentLayouts)this.collectLayout(e);this.currentModalitySession.duration=Date.now()-this.startTimestamp-this.currentModalitySession.timestamp,At(this.collectedModalitySessions,this.currentModalitySession,this.configProvider.config.simulcastTelemetryNumModalitySessions),this.currentModalitySession=void 0,this.lastMaxCapabilitiesEvent=void 0}getHigherFidelitySSRC(e,t){if(!e||!t)return e||t;const[i]=this.currentLayouts[e].fmtp.slice(-1),[n]=this.currentLayouts[t].fmtp.slice(-1);return(i?.maxMbps??0)>0&&(n?.maxMbps??0)>0?i.maxMbps>n.maxMbps?e:t:e||t}},mk=["googFrameHeightReceived","googFrameWidthReceived","googFrameHeightSent","googFrameWidthSent","googFrameRateInput","googFrameRateSent","googNacksSent","googNacksReceived","googPlisSent","googPlisReceived","googFirsSent","googFirsReceived","framesDecoded","googFrameRateDecoded","googFrameRateReceived","framesEncoded","packetsLost","packetsSent","packetsReceived","bytesReceived","bytesSent","googEncodeUsagePercent","audioInputLevel","audioOutputLevel","googDecodingCTN","googDecodingPLC","keyFramesEncoded","keyFramesDecoded","googRtt","concealedSamples","silentConcealedSamples","totalSamplesReceived","healedRatio","jitter","googJitterBufferMs","qpSum","fecPacketsReceived","fecPacketsDiscarded","fecPacketsSent","packetsDiscarded","pushCount","pushErrCount","pullCount","pullErrCount"],fk=["bytesSent","bytesReceived","googRtt","packetsSent","requestsSent","consentRequestsSent","responsesSent","requestsReceived","responsesReceived"],Sk=["googAvailableReceiveBandwidth","googAvailableSendBandwidth","googTransmitBitrate"];function vk(e,t,i){const n=i.value;i.value=function(...e){try{return n.apply(this,e)}catch(e){this.processStatsError(t,e)}}}var yk=class{constructor(e,t,i,n,r,s){this.logger=e,this.sessionInfo=t,this.configProvider=i,this.mediaManager=n,this.multiparty=r,this.newStatsApi=s,this.statsErrors=[],this.subscribedTrackIds=[],this.iceCandidateErrors=[],this.terminated=!1,this.hwSilent=!1,this.isSpeaking=!1,this.networkSendLevel={quality:"Good"},this.networkRecvLevel={quality:"Good"},this.audioTelemetry=new zD(this.configProvider),this.cameraOpenResolution={width:0,height:0},this.streamSenderStarted={},this.totalVideoControlMessages=0,this.outOfOrderVideoControlMessages=0,this.subscribedTrackSsrc=[],this.multiViewVideoTelemetry={},this.h264AvailableProfiles=[],this.timeToFirstFrame={},this.timeToFirstFrameSinceSubscriptionStart={},this.missedInitialPreferredResolution={},this.MSIDs=new Set,this.MSIDsPairs={},this.timerTrackerManager=new dM(this.configProvider.config.enableTimerTracker),this.extensions={WebRTCStats:{},AudioTransportRecvBitrate:0,AudioTransportSendBitrate:0,AudioPayloadSendBitrate:0,AudioPayloadRecvBitrate:0,VideoPayloadSendBitrate:0,VideoPayloadRecvBitrate:0,TimerAudioTransportRecvBitrate:0,TimerAudioTransportSendBitrate:0,TimerAudioPayloadRecvBitrate:0,TimerAudioPayloadSendBitrate:0,TimerVideoPayloadRecvBitrate:0,TimerVideoPayloadSendBitrate:0,StartTime:Date.now(),EndTime:Date.now(),Audio_recv_jitterBufferAvgSize:0,Audio_recv_jitterMax:0,Audio_recv_jitterAvg:0,Audio_send_rttAvg:0,Audio_send_rttMax:0,MaxSessionBandwidth:0,Video_recv_MSIDs:[],CallSetupTimeTracker:"",Audio_send_presentationUserAPIDuration:"",Audio_send_presentationDuration:""},this.report={type:"WebRtcMediaStats",data:{Extensions:this.extensions}},this.lastSSRCs=new Map,this.videoTelemetry=new hk(this.extensions.StartTime,this.configProvider,this.logger.createChild("Video"),"Video"),this.sharingTelemetry=new hk(this.extensions.StartTime,this.configProvider,this.logger.createChild("Sharing"),"ScreenShare"),this.dataTelemetry=new Ap,this.bandwidthTelemetry=new KD(this.configProvider.config.webrtcBWJumpLowerLimit,this.configProvider.config.webrtcBWJumpUpperLimit),this.stabilizationTelemetry=new AD(this.configProvider.config.uplinkBWStabilizationSlidingWindowSize,this.configProvider.config.uplinkBWStabilizationMaxDeviation,this.configProvider.config.uplinkBWStabilizationMinBandwidth,Ag),this.storedRecordsNumber=Number(this.configProvider.config.webrtcStatStoredRecordsNumber),this.hwSilentDetectionDuration=Number(this.configProvider.config.webrtcStatHwSilentDetectionDuration),this.hwSilentDetectionLevel=Number(this.configProvider.config.webrtcStatHwSilentDetectionLevel),this.audioHealedRatioTelemetry=new WD(this.configProvider),this.networkQualityTelemetry=new ZD(this.configProvider,this.newStatsApi,this.audioHealedRatioTelemetry),this.speakingWhileMutedBadDuration=Number(this.configProvider.config.webrtcSpeakingWhileMutedBadDuration),this.speakingWhileMutedDetectionLevel=Number(this.configProvider.config.webrtcSpeakingWhileMutedDetectionLevel),this.videoDelayTimePeriod=this.configProvider.config.webrtcVideoDelayThreshold,this.maxStoredPreferredResolutions=this.configProvider.config.maxStoredPreferredResolutionCount,this.simulcastVideo=new gk(this.logger.createChild("simulcastVideo"),this.configProvider),this.simulcastSharing=new gk(this.logger.createChild("simulcastSharing"),this.configProvider)}get currentVideoRecvTrackId(){return this.extensions.WebRTCStats.ssrc_video_recv?.googTrackId}get currentSharingRecvTrackId(){return this.extensions.WebRTCStats.ssrc_sharing_recv?.googTrackId}get isMultiViewVideoTelemetry(){return Object.getOwnPropertyNames(this.multiViewVideoTelemetry).length>0}onDeviceEvent(e){if("stream_acquired"===e.eventType){const t=e.payload;"Video"===t.mediaType&&(this.cameraOpenResolution=t.resolution)}}onMaxCapabilitiesRequested(e){(e.modality===tt.MODALITY.video?this.videoTelemetry:this.sharingTelemetry).setMaxCapabilitesRequested(e),(e.modality===tt.MODALITY.video?this.simulcastVideo:this.simulcastSharing).setMaxCapabilities(e,!1)}onMaxCapabilitiesApplied(e){(e.modality===tt.MODALITY.video?this.videoTelemetry:this.sharingTelemetry).setMaxCapabilitesApplied(e),(e.modality===tt.MODALITY.video?this.simulcastVideo:this.simulcastSharing).setMaxCapabilities(e,!0)}setSubscribedTrackIds(e){this.subscribedTrackIds=e||[]}setSubscribedTrackSsrc(e){this.subscribedTrackSsrc=e||[]}addSubscriptionEvent(e,t,i,n,r,s,a){const o={evt:e,ts:Date.now()-this.extensions.StartTime,msi:i,localMsi:n,duration:s};r&&(o.error=Ge(r));const l=this.getHandlerForModality(t);if(l.addSubscriptionEvent(o),a&&this.setMSIDsPair(i,n,a),1===e||3===e){const t=1===e;l.startStopRecvDataGathering(t)}2===e&&l.prepareCollectingStatsOnSubscribed(i)}setMSIDsPair(e,t,i){const n=`ssrc_${i.replace(/\D/g,"")}_recv`;this.MSIDsPairs[n]={msi:e,localMsi:t}}getHandlerForModality(e){switch(e){case tt.MODALITY.video:return this.videoTelemetry;case tt.MODALITY.sharing:return this.sharingTelemetry;default:throw new Error(`Handler not found for modality: ${e}`)}}setTerminated(){this.extensions.EndTime=(new Date).getTime(),this.terminated=!0}startWaitingForStreamStart(e){this.streamStartDetection||this.sessionInfo.setOfferedModalities(e),this.streamStartDetection=!0}recordDataChannelProtocolEvent(e){this.dataTelemetry.recordDataChannelProtocolEvent(e)}setSessionDataChannelState(e){this.dataTelemetry.setSessionDataChannelState(e)}recordDataChannelError(e){this.dataTelemetry.recordDataChannelError(e)}processStatsDict(e){if(this.processSimulcastStats(e),this.constructWebRtcReportForSingleStream(this.extensions.WebRTCStats,e),this.streamStartDetection&&(this.setStartTime(this.sessionInfo.offeredModalities)||this.terminated)&&(this.streamStartDetection=!1),Object.keys(this.missedInitialPreferredResolution).length>0&&(this.currentVideoRecvTrackId||this.currentSharingRecvTrackId)&&this.setMissedInitialPreferredResolution(),this.constructWebRTCDataReport(this.extensions.WebRTCStats,e),this.calculateHwSilentState(),this.calculateSpeakingState(),this.setHealedRatioSamples(),this.calculateNetworkRecvQualityLevel(),this.calculateNetworkSendQualityLevel(),this.sessionInfo.activeModalities&&(this.processBandwidthStats(),this.processAudioStats(),this.processVideoStatsRecv(this.videoTelemetry,this.extensions.WebRTCStats.ssrc_video_recv,!0),this.processVideoStatsSend(this.videoTelemetry,this.extensions.WebRTCStats.ssrc_video_send),this.processSharingStats(),this.processStreamsCounters()),this.configProvider.config.enableMultiViewStats){const t=this.extensions.WebRTCStats[tt.MULTIPLE_RECV_STREAMS]?this.extensions.WebRTCStats[tt.MULTIPLE_RECV_STREAMS]:{};this.constructWebRtcReportForMultipleStreams(t,e);for(const e of Object.keys(t)){const i=t[e];this.processVideoStatsRecv(this.multiViewVideoTelemetry[e],i)}this.extensions.WebRTCStats[tt.MULTIPLE_RECV_STREAMS]=t}this.extensions.WebRTCStats.statsErrors=JSON.stringify(this.statsErrors)}setTimeToFirstFrame(e,t,i){i in this.timeToFirstFrame||(this.timeToFirstFrame[i]=e,this.timeToFirstFrameSinceSubscriptionStart[i]=t)}getCurrentTimeToFirstFrame(e){return this.timeToFirstFrame[e]?this.timeToFirstFrame[e]:-1}getCurrentTimeToFirstFrameSinceSubscriptionStart(e){return this.timeToFirstFrameSinceSubscriptionStart[e]?this.timeToFirstFrameSinceSubscriptionStart[e]:-1}getVideoTelemetryBySsrc(e){let t;return this.extensions.WebRTCStats.ssrc_video_recv&&this.extensions.WebRTCStats.ssrc_video_recv.id===e?t=this.videoTelemetry:this.extensions.WebRTCStats.ssrc_sharing_recv&&this.extensions.WebRTCStats.ssrc_sharing_recv.id===e?t=this.sharingTelemetry:this.isMultiViewVideoTelemetry&&(t=this.multiViewVideoTelemetry[e]),t}getIsRendering(e){const t=this.getVideoTelemetryBySsrc(e);return t?t.getIsRendering():void 0}setFreezeDuration(e,t){for(const i of Object.keys(this.multiViewVideoTelemetry))this.multiViewVideoTelemetry[i].trackId===t&&this.isSubscribed(t)&&this.multiViewVideoTelemetry[i].setRecvTotalFreezeDurationMs(e);this.currentSharingRecvTrackId===t&&this.isSubscribed(t)&&this.sharingTelemetry.setRecvTotalFreezeDurationMs(e),this.currentVideoRecvTrackId===t&&this.isSubscribed(t)&&this.videoTelemetry.setRecvTotalFreezeDurationMs(e)}addVideoControlMessage(e){this.totalVideoControlMessages++,e&&this.outOfOrderVideoControlMessages++}setStreamSenderStarted(e,t){this.streamSenderStarted[e]=t}addReportedReceiveBandwidth(e){this.limitCaptureAmount(this.extensions,"ReportedReceiveBandwidth",e)}setHealedRatioSamples(){this.audioHealedRatioTelemetry.captureHealedRatioSamples(this.extensions?.WebRTCStats?.ssrc_audio_recv?.concealedSamples,this.extensions?.WebRTCStats?.ssrc_audio_recv?.silentConcealedSamples,this.extensions?.WebRTCStats?.ssrc_audio_recv?.totalSamplesReceived)}processSimulcastStats(e){this.simulcastVideo.processStats(e),this.simulcastSharing.processStats(e)}processBandwidthStats(){const e=this.extensions.WebRTCStats.bweStat?.googAvailableSendBandwidth;if(e){const t=this.streamSenderStarted.Video||this.streamSenderStarted.ScreenShare;this.bandwidthTelemetry.recordSendBandwidth(e[e.length-1]),this.stabilizationTelemetry.processBandwidth(parseInt(e[e.length-1]),this.sessionInfo.activeModalities,t)}}processAudioStats(){if(this.extensions.WebRTCStats.ssrc_audio_send&&this.limitCaptureAmount(this.extensions,"Audio_send_RawInputVolume",this.audioTelemetry.getInputLevel("Audio")),void 0!==this.extensions.WebRTCStats.ssrc_audio_recv?.googJitterBufferMs&&this.audioTelemetry.captureJitterBuffer((0,jD.last)(this.extensions.WebRTCStats.ssrc_audio_recv.googJitterBufferMs)),void 0!==this.extensions.WebRTCStats.ssrc_audio_recv?.packetsLost&&this.extensions.WebRTCStats.ssrc_audio_recv?.packetsReceived&&this.audioTelemetry.capturePacketsLostAndPacketsReceived((0,jD.last)(this.extensions.WebRTCStats.ssrc_audio_recv.packetsLost),(0,jD.last)(this.extensions.WebRTCStats.ssrc_audio_recv.packetsReceived)),void 0!==this.extensions.WebRTCStats.ssrc_audio_recv?.jitter&&this.audioTelemetry.captureJitter((0,jD.last)(this.extensions.WebRTCStats.ssrc_audio_recv.jitter)),this.extensions.WebRTCStats.ssrc_audio_send?.googRtt){const e=this.extensions.WebRTCStats.ssrc_audio_send.googRtt;this.audioTelemetry.captureRtt(e[e.length-1])}}stopGatheringIfNeeded(e,t,i,n){const r=`${t}${i}`;n!==this.lastSSRCs.get(r)&&(this.lastSSRCs.set(r,n),t===tt.MEDIA_DIRECTION.SEND?e.stopSendGathering():e.stopRecvGathering())}processVideoStatsSend(e,t){t&&Ag(this.sessionInfo.activeModalities.video)?(this.stopGatheringIfNeeded(e,tt.MEDIA_DIRECTION.SEND,"Video",t.ssrc),e.captureMediaData(tt.MEDIA_DIRECTION.SEND,t.googFrameRateSent,t.framesEncoded),e.captureFrameRate(t.googFrameRateInput),e.analyzeDelay(this.videoDelayTimePeriod,t.googAvgEncodeMs),e.captureQpData(tt.MEDIA_DIRECTION.SEND,t.qpSum,t.framesEncoded),e.captureBitrateSample(tt.MEDIA_DIRECTION.SEND,this.getLastSampleInt(t.bytesSent)),e.detectCaptureFreeze(t.googFrameRateInput),e.captureAllocateBandwidth(this.extensions.WebRTCStats.bweStat?.googAvailableSendBandwidth),e.setCurrentParameters(parseInt(t.ssrc),{width:this.getLastSampleInt(t.googFrameWidthSent),height:this.getLastSampleInt(t.googFrameHeightSent)},this.getLastSampleInt(t.googFrameRateSent)),e.setQualityLimitationReason(t.qualityLimitationReason),this.configProvider.config.specCompliantSimulcast?.collectResolutionInfo&&e.calculateResolutinSwitches(this.getLastSampleInt(t.googFrameWidthSent),this.getLastSampleInt(t.googFrameHeightSent))):e.isSendGathering()&&(e.stopSendGathering(),this.lastSSRCs.delete(`${tt.MEDIA_DIRECTION.SEND}Video`))}processVideoStatsRecv(e,t,i=!1){t&&Rg(this.sessionInfo.activeModalities.video)&&this.videoTelemetry.isRecvDataGatheringEnabled?(i&&this.stopGatheringIfNeeded(e,tt.MEDIA_DIRECTION.RECV,"Video",t.ssrc),e.trackId=t.googTrackId,e.gatherRecvFreezeData(t.googFrameRateDecoded,t.googFrameRateReceived,this.getLastSampleInt(t.bytesReceived)),e.captureMediaData(tt.MEDIA_DIRECTION.RECV,t.googFrameRateReceived,t.googFrameRateDecoded),e.captureTimeToFirstFrame(this.getCurrentTimeToFirstFrame(t.googTrackId),this.getCurrentTimeToFirstFrameSinceSubscriptionStart(t.googTrackId)),e.captureQpData(tt.MEDIA_DIRECTION.RECV,t.qpSum,t.framesDecoded),e.captureBitrateSample(tt.MEDIA_DIRECTION.RECV,this.getLastSampleInt(t.bytesReceived)),e.captureResolutionSample({width:this.getLastSampleInt(t.googFrameWidthReceived),height:this.getLastSampleInt(t.googFrameHeightReceived)}),this.extensions.WebRTCStats.ssrc_video_recv?.packetsLost&&this.extensions.WebRTCStats.ssrc_video_recv?.packetsReceived&&this.videoTelemetry.capturePacketsLostAndPacketsReceved((0,jD.last)(this.extensions.WebRTCStats.ssrc_video_recv.packetsLost),(0,jD.last)(this.extensions.WebRTCStats.ssrc_video_recv.packetsReceived)),e.captureStatsOnSubscribed(this.getLastSampleInt(t.framesDecoded),this.getLastSampleInt(t.bytesReceived))):i&&this.lastSSRCs.delete(`${tt.MEDIA_DIRECTION.RECV}Video`)}processSharingStats(){const e=this.extensions.WebRTCStats.ssrc_sharing_send,t=this.extensions.WebRTCStats.ssrc_sharing_recv;e&&Ag(this.sessionInfo.activeModalities.sharing)?(this.stopGatheringIfNeeded(this.sharingTelemetry,tt.MEDIA_DIRECTION.SEND,"Sharing",e.ssrc),this.sharingTelemetry.captureMediaData(tt.MEDIA_DIRECTION.SEND,e.googFrameRateSent,e.framesEncoded),this.sharingTelemetry.captureFrameRate(e.googFrameRateInput),this.sharingTelemetry.analyzeDelay(this.videoDelayTimePeriod,e.googAvgEncodeMs),this.sharingTelemetry.captureQpData(tt.MEDIA_DIRECTION.SEND,e.qpSum,e.framesEncoded),this.sharingTelemetry.captureBitrateSample(tt.MEDIA_DIRECTION.SEND,this.getLastSampleInt(e.bytesSent)),this.sharingTelemetry.detectCaptureFreeze(e.googFrameRateInput),this.sharingTelemetry.captureAllocateBandwidth(this.extensions.WebRTCStats.bweStat?.googAvailableSendBandwidth),this.sharingTelemetry.setCurrentParameters(parseInt(e.ssrc),{width:this.getLastSampleInt(e.googFrameWidthSent),height:this.getLastSampleInt(e.googFrameHeightSent)},this.getLastSampleInt(e.googFrameRateSent)),this.limitCaptureAmount(this.extensions,"Sharing_send_RawInputVolume",this.audioTelemetry.getInputLevel("ScreenShare"))):this.sharingTelemetry.isSendGathering()&&(this.sharingTelemetry.stopSendGathering(),this.lastSSRCs.delete(`${tt.MEDIA_DIRECTION.SEND}Sharing`)),t&&Rg(this.sessionInfo.activeModalities.sharing)&&this.sharingTelemetry.isRecvDataGatheringEnabled?(this.stopGatheringIfNeeded(this.sharingTelemetry,tt.MEDIA_DIRECTION.RECV,"Sharing",t.ssrc),this.sharingTelemetry.trackId=t.googTrackId,this.sharingTelemetry.gatherRecvFreezeData(t.googFrameRateDecoded,t.googFrameRateReceived),this.sharingTelemetry.captureMediaData(tt.MEDIA_DIRECTION.RECV,t.googFrameRateReceived,t.googFrameRateDecoded),this.sharingTelemetry.captureTimeToFirstFrame(this.getCurrentTimeToFirstFrame(t.googTrackId),this.getCurrentTimeToFirstFrameSinceSubscriptionStart(t.googTrackId)),this.sharingTelemetry.captureQpData(tt.MEDIA_DIRECTION.RECV,t.qpSum,t.framesDecoded),this.sharingTelemetry.captureBitrateSample(tt.MEDIA_DIRECTION.RECV,this.getLastSampleInt(t.bytesReceived)),this.sharingTelemetry.captureResolutionSample({width:this.getLastSampleInt(t.googFrameWidthReceived),height:this.getLastSampleInt(t.googFrameHeightReceived)}),this.sharingTelemetry.captureStatsOnSubscribed(this.getLastSampleInt(t.framesDecoded),this.getLastSampleInt(t.bytesReceived))):this.lastSSRCs.delete(`${tt.MEDIA_DIRECTION.RECV}Sharing`)}processStreamsCounters(){const e=this.extensions.WebRTCStats.recvCounters;e&&(this.videoTelemetry.countRecvStreams(e[tt.MODALITY.video]),this.sharingTelemetry.countRecvStreams(e[tt.MODALITY.sharing]))}setMissedInitialPreferredResolution(){it(this.missedInitialPreferredResolution,((e,t)=>{this.setPreferredResolution(t,e)})),this.missedInitialPreferredResolution={}}setPreferredResolution(e,t,i){if((i===tt.MEDIA_TYPE.video&&!this.currentVideoRecvTrackId||i===tt.MEDIA_TYPE.sharing&&!this.currentSharingRecvTrackId)&&(this.missedInitialPreferredResolution[e]=t),this.currentVideoRecvTrackId===e&&this.videoTelemetry.capturePreferredResolution(t,this.maxStoredPreferredResolutions),this.currentSharingRecvTrackId===e&&this.sharingTelemetry.capturePreferredResolution(t,this.maxStoredPreferredResolutions),this.isMultiViewVideoTelemetry){const i=this.multiViewVideoTelemetry[this.getSsrcIdFromMultipleVideoStream(e)];i&&i.capturePreferredResolution(t,this.maxStoredPreferredResolutions)}}setIsRendering(e,t,i){t===tt.MEDIA_TYPE.video&&this.videoTelemetry.setIsRendering(e),t===tt.MEDIA_TYPE.sharing&&this.sharingTelemetry.setIsRendering(e),this.isMultiViewVideoTelemetry&&this.multiViewVideoTelemetry[this.getSsrcIdFromMultipleVideoStream(i)]?.setIsRendering(e)}setReportedSendBandwidth(e){this.extensions.ReportedSendBWMax||this.extensions.ReportedSendBWMin?e>this.extensions.ReportedSendBWMax?this.extensions.ReportedSendBWMax=e:e<this.extensions.ReportedSendBWMin&&(this.extensions.ReportedSendBWMin=e):(this.extensions.ReportedSendBWMax=e,this.extensions.ReportedSendBWMin=e)}setMaxSessionBandwidth(e){this.extensions.MaxSessionBandwidth=e}isSubscribed(e,t){let i=this.subscribedTrackIds.some((t=>t===e));return!i&&this.configProvider.config.subscribeToSsrcForVideo&&(i=this.subscribedTrackSsrc.some((e=>e===`${t}`))),i||!this.multiparty&&this.configProvider.config.subscribeToSsrcForVideo}getReport(e=!1,t=!1){try{t&&this.resetPairValues(),e||(this.videoTelemetry.stopDataGathering(),this.sharingTelemetry.stopDataGathering());const i=this.videoTelemetry.getTotalDuration(tt.MEDIA_DIRECTION.RECV),n=this.videoTelemetry.getTotalDuration(tt.MEDIA_DIRECTION.SEND),r=this.sharingTelemetry.getTotalDuration(tt.MEDIA_DIRECTION.RECV),s=this.sharingTelemetry.getTotalDuration(tt.MEDIA_DIRECTION.SEND);if(i>=0&&(it(this.videoTelemetry.getReport(tt.MEDIA_DIRECTION.RECV,"Video_recv_",t),((e,t)=>this.extensions[t]=e)),!dt(this.multiViewVideoTelemetry))){const e=[];for(const i of Object.keys(this.multiViewVideoTelemetry)){const n={id:i};it(this.multiViewVideoTelemetry[i].getReport(tt.MEDIA_DIRECTION.RECV,"Video",t),((e,t)=>{void 0!==e&&(n[t]=e)})),e.push(n)}this.extensions[tt.MULTIPLE_RECV_STREAMS]=JSON.stringify(e)}r>=0&&it(this.sharingTelemetry.getReport(tt.MEDIA_DIRECTION.RECV,"Sharing_recv_",t),((e,t)=>this.extensions[t]=e)),n>=0&&(it(this.videoTelemetry.getReport(tt.MEDIA_DIRECTION.SEND,"Video_send_",t),((e,t)=>this.extensions[t]=e)),this.extensions.Bandwidth_jumpsHistogram=JSON.stringify(this.bandwidthTelemetry.getReport()),this.extensions.Bandwidth_uplinkStabilizationTime=JSON.stringify(this.stabilizationTelemetry.getReport(!0)),this.extensions.Video_send_CameraOpenWidth=this.cameraOpenResolution.width,this.extensions.Video_send_CameraOpenHeight=this.cameraOpenResolution.height),s>=0&&it(this.sharingTelemetry.getReport(tt.MEDIA_DIRECTION.SEND,"Sharing_send_",t),((e,t)=>this.extensions[t]=e)),it(this.dataTelemetry.getReport("Data_"),((e,t)=>this.extensions[t]=e)),e||t||(this.simulcastVideo.finish(),this.extensions.Video_send_Simulcast=JSON.stringify(this.simulcastVideo.collectedSessions),this.simulcastSharing.finish(),this.extensions.Sharing_send_Simulcast=JSON.stringify(this.simulcastSharing.collectedSessions)),this.iceCandidateErrors.length>0&&(this.extensions.iceCandidateErrors=JSON.stringify(this.iceCandidateErrors)),this.extensions.Audio_recv_jitterBufferAvgSize=this.audioTelemetry.getAvgJitterBuffer(),this.extensions.Audio_recv_packetsLostRateMax=this.audioTelemetry.getPacketsLostRateMax(),this.extensions.Audio_recv_networkAvgLossRate=this.audioTelemetry.getNetworkAvgLostRate(),this.extensions.Audio_recv_jitterMax=this.audioTelemetry.getJitterMax(),this.extensions.Audio_recv_jitterAvg=this.audioTelemetry.getJitterAvg(),this.extensions.Video_SubscriptionEvents=t?"":JSON.stringify(this.videoTelemetry.getSubscriptionEvents()),this.extensions.Video_SubscriptionCounters=t?"":JSON.stringify(this.videoTelemetry.getSubscriptionCounters()),this.extensions.Sharing_SubscriptionEvents=t?"":JSON.stringify(this.sharingTelemetry.getSubscriptionEvents()),this.extensions.Sharing_SubscriptionCounters=t?"":JSON.stringify(this.sharingTelemetry.getSubscriptionCounters()),this.extensions.Audio_recv_healedRatioMax=this.audioHealedRatioTelemetry.getHealedRatioMax(),this.extensions.Audio_recv_healedRatioAvg=this.audioHealedRatioTelemetry.getHealedRatioAvg(),this.extensions.Audio_recv_packetsLostAvg=this.audioTelemetry.getAvgPacketsLost(),this.extensions.Audio_send_rttAvg=this.audioTelemetry.getAvgRtt(),this.extensions.Audio_send_rttMax=this.audioTelemetry.getMaxRtt(),this.extensions.CallSetupTimeTracker=JSON.stringify(this.timerTrackerManager.getReport());for(const e of Object.keys(this.extensions))void 0===this.extensions[e]&&delete this.extensions[e];return delete this.extensions.WebRTCStats[tt.MULTIPLE_RECV_STREAMS],this.sessionInfo.fillExtensionInfo(this.extensions),Object.keys(this.extensions.WebRTCStats).length>0&&!this.extensions.WebRTCStats.hasStatsError&&this.calculateAverages(),this.extensions.H264_available_profiles=this.h264AvailableProfiles.join(),this.extensions.Video_recv_MSIDs=Array.from(this.MSIDs),this.totalVideoControlMessages>0&&(this.extensions.totalVideoControlMessages=this.totalVideoControlMessages,this.extensions.outOfOrderVideoControlMessages=this.outOfOrderVideoControlMessages),ut(this.report)}catch(e){throw this.processStatsError("Report",e),{error:e,partialReport:ut(this.report)}}}getAudioHwSilent(){return this.hwSilent}getSpeakingState(){return this.isSpeaking}getNetworkSendLevel(){return this.networkSendLevel}getNetworkRecvLevel(){return this.networkRecvLevel}addIceCandidateError(e){this.iceCandidateErrors.push(e)}clearIceCandidateErrors(){this.iceCandidateErrors=[]}addH264AvailableProfiles(e){this.h264AvailableProfiles=[...new Set(this.h264AvailableProfiles.concat(e))]}updateSendStream(e,t){this.audioTelemetry.updateSendStream(e,t)}getTimerTracker(e,t){return this.timerTrackerManager.getTimerTracker(e,t)}resetPairValues(){Object.keys(this.extensions.WebRTCStats).forEach((e=>{delete this.extensions.WebRTCStats[e].pair}))}limitCaptureAmount(e,t,i){void 0!==i&&(e[t]=Array.isArray(e[t])?e[t]:[],e[t].push(i),e[t].length>this.storedRecordsNumber&&e[t].shift())}setStartTime(e){const t=this.extensions.WebRTCStats;if(!t.ssrc_audio_send||!t.ssrc_audio_recv)return!1;const i=(e,t)=>!e||t&&-1===t?t:(new Date).getTime();return this.extensions.TimerAudioPayloadRecvBitrate=Rg(e.audio)?i(t.ssrc_audio_recv.bytesReceived,this.extensions.TimerAudioPayloadRecvBitrate):-1,this.extensions.TimerAudioPayloadSendBitrate=Ag(e.audio)?i(t.ssrc_audio_send.bytesSent,this.extensions.TimerAudioPayloadSendBitrate):-1,this.extensions.TimerAudioTransportRecvBitrate=Rg(e.audio)?i(t.ssrc_audio_recv.bytesReceived,this.extensions.TimerAudioTransportRecvBitrate):-1,this.extensions.TimerAudioTransportSendBitrate=Ag(e.audio)?i(t.ssrc_audio_send.bytesSent,this.extensions.TimerAudioTransportSendBitrate):-1,!!(t.ssrc_video_send&&t.ssrc_video_recv&&(this.extensions.TimerVideoPayloadRecvBitrate=Rg(e.video)?i(t.ssrc_video_recv.bytesReceived,this.extensions.TimerVideoPayloadRecvBitrate):-1,this.extensions.TimerVideoPayloadSendBitrate=Ag(e.video)?i(t.ssrc_video_send.bytesSent,this.extensions.TimerVideoSendBitrate):-1,this.extensions.TimerVideoPayloadRecvBitrate&&this.extensions.TimerVideoPayloadSendBitrate&&this.extensions.TimerAudioPayloadRecvBitrate&&this.extensions.TimerAudioPayloadSendBitrate&&this.extensions.TimerAudioTransportRecvBitrate&&this.extensions.TimerAudioTransportSendBitrate))}calculateAverages(){const e=this.extensions.EndTime,t=(t,i)=>t&&e-i>0&&0!==i&&-1!==i?Math.round(8*t/(e-i)):0,i=e=>{const t=e.split(".").reduce(((e,t)=>null==e?e:e[t]),this.extensions.WebRTCStats);return Array.isArray(t)?t[t.length-1]:t};this.extensions.AudioPayloadRecvBitrate=t(i("ssrc_audio_recv.bytesReceived"),this.extensions.TimerAudioPayloadRecvBitrate),this.extensions.AudioPayloadSendBitrate=t(i("ssrc_audio_send.bytesSent"),this.extensions.TimerAudioPayloadSendBitrate),this.extensions.VideoPayloadRecvBitrate=t(i("ssrc_video_recv.bytesReceived"),this.extensions.TimerVideoPayloadRecvBitrate),this.extensions.VideoPayloadSendBitrate=t(i("ssrc_video_send.bytesSent"),this.extensions.TimerVideoPayloadSendBitrate),this.extensions.AudioTransportRecvBitrate=t(i("ssrc_audio_send.pair.bytesReceived"),this.extensions.TimerAudioTransportRecvBitrate),this.extensions.AudioTransportSendBitrate=t(i("ssrc_audio_send.pair.bytesSent"),this.extensions.TimerAudioTransportSendBitrate)}addFilteredFields(e,t,i=[]){for(const n in t)if(t.hasOwnProperty(n)&&"type"!==n)if(-1!==i.indexOf(n)){const i=e[n]||[];i.push(this.formatFields(t,n)),i.length>this.storedRecordsNumber&&i.shift(),e[n]||(e[n]=i)}else e[n]=t[n]}formatFields(e,t){const i=e[t];switch(t){case"audioInputLevel":case"audioOutputLevel":return this.newStatsApi?Math.floor(65535*i):2*i;case"googJitterBufferMs":return parseInt(i);case"healedRatio":return bt(parseFloat(i),this.configProvider.config.healedRatioPrecision);case"jitter":return bt(parseFloat(i),this.configProvider.config.jitterPrecision);default:return i}}processSource(e,t,i){let n;if(this.addFilteredFields(e,t,mk),t.transportId){const r=i.googComponent?.[t.transportId];e.transport||(e.transport={}),r&&(this.addFilteredFields(e.transport,r),r.selectedCandidatePairId&&(n=i.googCandidatePair?.[r.selectedCandidatePairId]))}else n=Object.values(i.googCandidatePair).find((e=>e.selected));n&&(e.pair||(e.pair={}),this.addFilteredFields(e.pair,n,fk))}getWebrtcReport(e,t,i,n){const r=e.ssrc[i],s=n?r.id.replace(/[0-9]+/,n):r.id;t[s]?r.ssrc!==t[s].ssrc&&(s.endsWith("video_send")?this.videoTelemetry.stopSendGathering():s.endsWith("video_recv")?this.videoTelemetry.stopRecvGathering():s.endsWith("sharing_send")?this.sharingTelemetry.stopSendGathering():s.endsWith("sharing_recv")&&this.sharingTelemetry.stopRecvGathering()):t[s]={},this.processSource(t[s],r,e)}constructWebRTCDataReport(e,t){if(!t.data?.length)return;const i=t.data.sort(((e,t)=>t.timestamp-e.timestamp)),n=i.find((e=>"open"===e.state));e.data=n||i[0]}constructWebRtcReportForSingleStream(e,t){if(!t.ssrc)return;const i=this.selectSsrcsToCollect(t.ssrc);e.recvCounters=i.recvCounters,delete i.recvCounters,delete i.multiRecv,it(i,(i=>{it(i,((i,n)=>{this.getWebrtcReport(t,e,i,n)}))})),t.VideoBwe?.bweforvideo&&(e.bweStat||(e.bweStat={}),this.addFilteredFields(e.bweStat,t.VideoBwe.bweforvideo,Sk))}constructWebRtcReportForMultipleStreams(e,t){t.ssrc&&this.selectSsrcsToCollect(t.ssrc).multiRecv.forEach((i=>this.getWebrtcReport(t,e,i)))}getMediaType(e,t){let i=t?t.getModality():e.mediaType;return e.googTrackId?.match("applicationsharing")&&i!==tt.MEDIA_TYPE.sharing&&(i=tt.MEDIA_TYPE.sharing),i}selectSsrcsToCollect(e){const t={send:{},recv:{},recvCounters:{video:0,sharing:0},multiRecv:[]};if(!this.sessionInfo.activeModalities)return t;let i=[];for(const n of Object.keys(e)){const r=e[n],s=r.googTrackId;if(!s&&r.mediaType!==tt.MEDIA_TYPE.audio)continue;const a=this.getMediaEntity(s,r),o=this.getMediaType(r,a),l=a?.getXSourceStreamId();if(n.endsWith("send"))switch(o){case tt.MEDIA_TYPE.audio:Ag(this.sessionInfo.activeModalities.audio)&&(t.send.audio=n);break;case tt.MEDIA_TYPE.video:if(this.extensions.Video_send_SourceId=l,this.simulcastVideo.highestFidelitySSRC){this.simulcastVideo.highestFidelitySSRC===r.ssrc&&(t.send.video=n);break}this.streamSenderStarted.Video&&Ag(this.sessionInfo.activeModalities.video)&&a?.getLocalTrackId()&&(a?.getLocalTrackId()===r.googTrackId||this.configProvider.config.statsAllowAnyVideoSendTrack&&!t.send.video)&&(!r.rid||"1"===r.rid)&&(t.send.video=n);break;case tt.MEDIA_TYPE.sharing:if(this.simulcastSharing.highestFidelitySSRC){this.simulcastSharing.highestFidelitySSRC===r.ssrc&&(t.send.sharing=n);break}this.streamSenderStarted.ScreenShare&&Ag(this.sessionInfo.activeModalities.sharing)&&a?.getLocalTrackId()===r.googTrackId&&(t.send.sharing=n);break;default:this.logger.warn(`Unknown media type '${o}'`)}else if(n.endsWith("recv"))switch(o){case tt.MEDIA_TYPE.audio:Rg(this.sessionInfo.activeModalities.audio)&&(t.recv.audio=n);break;case tt.MEDIA_TYPE.video:void 0!==l&&this.MSIDs.add(l),this.isSubscribed(r.googTrackId,r.ssrc)&&Rg(this.sessionInfo.activeModalities.video)&&(i.push(r),+r.googFrameRateReceived>0&&t.recvCounters[tt.MODALITY.video]++);break;case tt.MEDIA_TYPE.sharing:this.isSubscribed(r.googTrackId,r.ssrc)&&Rg(this.sessionInfo.activeModalities.sharing)&&(t.recv.sharing=n,+r.googFrameRateReceived>0&&t.recvCounters[tt.MODALITY.sharing]++);break;default:this.logger.warn(`Unknown media type '${o}'`)}}if(i.length>0){i=i.sort(((e,t)=>+t.googFrameHeightReceived-+e.googFrameHeightReceived));const e=i.find((e=>e.mediaType===tt.MEDIA_TYPE.video));e&&(t.recv.video=e.id),this.multiparty&&this.configProvider.config.enableMultiViewStats&&(t.multiRecv=i.map((e=>e.id)),t.multiRecv.forEach((e=>{this.multiViewVideoTelemetry[e]||(this.multiViewVideoTelemetry[e]=new hk(this.extensions.StartTime,this.configProvider,this.logger.createChild(`Video[${e}]`,"Video")),this.multiViewVideoTelemetry[e].setMsi(this.MSIDsPairs[e]?.msi),this.multiViewVideoTelemetry[e].setLocalMsi(this.MSIDsPairs[e]?.localMsi),this.multiViewVideoTelemetry[e].prepareCollectingStatsOnSubscribed(this.MSIDsPairs[e]?.msi))})))}return t}getMediaEntityForTrack(e){if(e)return this.mediaManager.getMediaEntities().find((t=>t.getLocalTrackId()===e||t.getRemoteTrackId()===e))}getMediaEntityByRemoteSsrc(e){if(e)return this.mediaManager.getMediaEntities().find((t=>t.getRemoteSsrc()===+e))}getMediaEntity(e,t){const i=`${t.ssrc}`,n=t.id;let r=this.getMediaEntityForTrack(e);return!r&&this.configProvider.config.subscribeToSsrcForVideo&&n.endsWith("recv")&&(r=this.getMediaEntityByRemoteSsrc(i)),r}calculateHwSilentState(){const e=this.extensions.WebRTCStats.ssrc_audio_send?.audioInputLevel;if(!e||e.length<2*this.hwSilentDetectionDuration)return;let t=!0;for(let i=e.length-this.hwSilentDetectionDuration-1;i<e.length;i++)if(e[i]>this.hwSilentDetectionLevel){t=!1;break}this.hwSilent!==t&&(this.hwSilent=t,this.logger.safe.info(`HW silent changed to ${this.hwSilent}`))}calculateSpeakingState(){const e=this.newStatsApi&&this.configProvider.config.useAudioAnalyzer?this.extensions.Audio_send_RawInputVolume:this.extensions.WebRTCStats.ssrc_audio_send?.audioInputLevel;if(!e||e.length<=this.speakingWhileMutedBadDuration)return;let t=!1;for(let i=e.length-this.speakingWhileMutedBadDuration;i<e.length;i++)if(e[i]>this.speakingWhileMutedDetectionLevel){t=!0;break}this.isSpeaking=t}calculateNetworkRecvQualityLevel(){this.configProvider.config.enableNetworkRecvQualityUFD&&this.extensions.WebRTCStats.ssrc_audio_recv&&(this.networkRecvLevel=this.networkQualityTelemetry.calculateNetworkRecvQualityLevel({googDecodingCTN:this.extensions.WebRTCStats.ssrc_audio_recv.googDecodingCTN??[],googDecodingPLC:this.extensions.WebRTCStats.ssrc_audio_recv.googDecodingPLC??[],concealedSamples:this.extensions.WebRTCStats.ssrc_audio_recv.concealedSamples??[],silentConcealedSamples:this.extensions.WebRTCStats.ssrc_audio_recv.silentConcealedSamples??[],totalSamplesReceived:this.extensions.WebRTCStats.ssrc_audio_recv.totalSamplesReceived??[],oldNetworkLevel:this.networkRecvLevel.quality}))}calculateNetworkSendQualityLevel(){this.extensions.WebRTCStats.ssrc_audio_send&&(this.networkSendLevel=this.networkQualityTelemetry.calculateNetworkSendQualityLevel(this.extensions.WebRTCStats.ssrc_audio_send.packetsSent,this.extensions.WebRTCStats.ssrc_audio_send.packetsLost,this.extensions.WebRTCStats.ssrc_audio_send.jitter,this.networkSendLevel.quality))}processStatsError(e,t){const i=Ge(t);this.logger.safe.error(`webrtcStatistics error [${e}]: ${i}`);const n=this.statsErrors.find((t=>t.error===i&&t.origin===e));n?n.count++:this.statsErrors.push({origin:e,error:i,count:1}),this.statsErrors.length>10&&this.statsErrors.splice(1)}getLastSampleInt(e){return"number"==typeof e?e:e&&parseInt(e[e.length-1])||0}getSsrcIdFromMultipleVideoStream(e){let t;const i=this.extensions.WebRTCStats[tt.MULTIPLE_RECV_STREAMS]||{};for(const n in i){const r=i[n];if(r&&r.googTrackId===e){t=n;break}}return t}};E([vk],yk.prototype,"onDeviceEvent",1),E([vk],yk.prototype,"onMaxCapabilitiesRequested",1),E([vk],yk.prototype,"onMaxCapabilitiesApplied",1),E([vk],yk.prototype,"addSubscriptionEvent",1),E([vk],yk.prototype,"processSimulcastStats",1),E([vk],yk.prototype,"processBandwidthStats",1),E([vk],yk.prototype,"processAudioStats",1),E([vk],yk.prototype,"processVideoStatsSend",1),E([vk],yk.prototype,"processVideoStatsRecv",1),E([vk],yk.prototype,"processSharingStats",1),E([vk],yk.prototype,"processStreamsCounters",1),E([vk],yk.prototype,"setMissedInitialPreferredResolution",1),E([vk],yk.prototype,"setPreferredResolution",1),E([vk],yk.prototype,"setIsRendering",1),E([vk],yk.prototype,"setReportedSendBandwidth",1),E([vk],yk.prototype,"setMaxSessionBandwidth",1),E([vk],yk.prototype,"setStartTime",1),E([vk],yk.prototype,"calculateAverages",1),E([vk],yk.prototype,"addFilteredFields",1),E([vk],yk.prototype,"formatFields",1),E([vk],yk.prototype,"processSource",1),E([vk],yk.prototype,"getWebrtcReport",1),E([vk],yk.prototype,"constructWebRTCDataReport",1),E([vk],yk.prototype,"constructWebRtcReportForSingleStream",1),E([vk],yk.prototype,"constructWebRtcReportForMultipleStreams",1),E([vk],yk.prototype,"selectSsrcsToCollect",1),E([vk],yk.prototype,"calculateHwSilentState",1),E([vk],yk.prototype,"calculateSpeakingState",1),E([vk],yk.prototype,"calculateNetworkRecvQualityLevel",1),E([vk],yk.prototype,"calculateNetworkSendQualityLevel",1);var Ck=class extends Qe{constructor(e,t,i,n){super(),this.logger=e,this.configProvider=t,this.mediaManager=i,this.window=yg.window,this._sessionInfo=new sM,this.statisticsMapper=new $D,this.useNewStatsApi=this.configProvider.config.webrtcUseNewStatsApi&&this.configProvider.mediaConfig.simulcastSessionEnabled,this.webRtcStatistics=new yk(this.logger.createChild("WebrtcStatistics"),this._sessionInfo,this.configProvider,i,n,this.useNewStatsApi)}setAudioDecoderStatsProvider(e){this.statisticsMapper?.setAudioDecoderStatsProvider(e)}get sessionInfo(){return this._sessionInfo}get isDisposed(){return null===this.pc&&0===this.interval}initialize(e){this.pc=e}startWaitingForStreamStart(e){this.webRtcStatistics.startWaitingForStreamStart(e)}onDeviceEvent(e){this.webRtcStatistics.onDeviceEvent(e)}onMaxCapabilitiesRequested(e){this.webRtcStatistics.onMaxCapabilitiesRequested(e)}onMaxCapabilitiesApplied(e){this.webRtcStatistics.onMaxCapabilitiesApplied(e)}onSendersChanged(e,t){this.webRtcStatistics.setStreamSenderStarted(e,t)}addSubscriptionEvent(e,t,i,n,r,s,a){this.webRtcStatistics.addSubscriptionEvent(e,t,i,n,r,s,a)}setSubscribedTrackIds(e){this.webRtcStatistics.setSubscribedTrackIds(e)}setSubscribedTrackSsrc(e){this.webRtcStatistics.setSubscribedTrackSsrc(e)}setPreferredResolution(e,t,i){this.webRtcStatistics.setPreferredResolution(e,t,i)}setIsRendering(e,t,i){this.webRtcStatistics.setIsRendering(e,t,i)}setReportedSendBandwidth(e){this.webRtcStatistics.setReportedSendBandwidth(e)}setMaxSessionBandwidth(e){this.webRtcStatistics.setMaxSessionBandwidth(e)}setTerminated(){this.webRtcStatistics.setTerminated()}addIceCandidateError(e){this.webRtcStatistics.addIceCandidateError(e)}clearIceCandidateErrors(){this.webRtcStatistics.clearIceCandidateErrors()}recordDataChannelProtocolEvent(e){this.webRtcStatistics.recordDataChannelProtocolEvent(e)}setSessionDataChannelState(e){this.webRtcStatistics.setSessionDataChannelState(e)}recordDataChannelError(e){this.webRtcStatistics.recordDataChannelError(e)}updateSendStream(e,t){this.webRtcStatistics.updateSendStream(e,t)}getTimerTracker(e,t){return this.webRtcStatistics.getTimerTracker(e,t)}setH264AvailableProfiles(e){if(!e?.codecs)return;let t=[];e.codecs.forEach((e=>{if("h264"===e.mimeType&&e.sdpFmtpLine){const i=/profile-level-id=(.{6})/.exec(e.sdpFmtpLine);i?.[1]&&(t=t.concat(i[1]))}})),this.webRtcStatistics.addH264AvailableProfiles(t)}processRawReport(e){this.processStatsDict(this.statisticsMapper.build(e))}processLegacyReport(e){this.processStatsDict(function(e){const t={};return e.result().forEach((e=>{e.names().forEach((i=>{t[e.type]=t[e.type]||{},t[e.type][e.id]=t[e.type][e.id]||{},t[e.type][e.id][i]=e.stat(i)})),t[e.type][e.id].id=e.id})),t}(e))}getReport(e,t=!1){const i=this.webRtcStatistics.getReport(e,t);return this.addStreamInfoForE2ETests(i),i}dispose(){this.interval&&(this.window.clearInterval(this.interval),this.interval=0),this.pc=null}getLastStatistics(){return this.statistics}setTimeToFirstFrame(e,t,i){this.webRtcStatistics.setTimeToFirstFrame(e,t,i)}setFreezeDuration(e,t){this.webRtcStatistics.setFreezeDuration(e,t)}addVideoControlMessage(e=!1){this.webRtcStatistics.addVideoControlMessage(e)}setSsrcTrackPair(e,t){this.statisticsMapper.setSsrcTrackPair(e,t)}updateStatsWithLocalSsrcTrackInfo(){for(const e of this.mediaManager.getMediaEntities()){const t=e.getLocalSsrc();t&&this.statisticsMapper.setSsrcTrackPair(t,e.getLocalTrackId())}}addReportedReceiveBandwidth(e){this.webRtcStatistics.addReportedReceiveBandwidth(e)}addStreamInfoForE2ETests(e){const t=this._sessionInfo.negotiatedModalities;if(t&&!this.isDisposed)try{e.localStreams=this.getSendersReport(this.pc.getSenders(),{audio:Ag(t.audio),video:Ag(t.video)}),e.remoteStreams=this.getReceiversReport(this.pc.getReceivers(),{audio:Rg(t.audio),video:Rg(t.video)})}catch(e){this.logger.safe.warn(`addStreamInfoForE2ETests failed: ${Ge(e)}`)}}getReceiversReport(e,t){const i=[];return e.forEach((e=>{const n={tracks:[]};i.push(n),e.track&&("audio"===e.track.kind&&t.audio||"video"===e.track.kind&&t.video)&&n.tracks.push({stream:void 0,track:e.track})})),i}getSendersReport(e,t){const i=[],n={tracks:[]};return i.push(n),e.forEach((e=>{e.track&&("audio"===e.track.kind&&t.audio||"video"===e.track.kind&&t.video)&&n.tracks.push({stream:void 0,track:e.track})})),i}processStatsDict(e){this.webRtcStatistics.processStatsDict(e);let t=0,i=0;const n=e.VideoBwe?.bweforvideo;n&&(t=Number(n.googAvailableReceiveBandwidth),i=Number(n.googAvailableSendBandwidth));const r=1e3*((this.configProvider.mediaConfig.maxBandwidthInKbps||Math.floor(Number.MAX_SAFE_INTEGER/1e3))-(this.configProvider.config.audioBandwidthInKbps||0)),s=isNaN(t)?0:t,a=isNaN(i)?0:i,o={estimatedReceiveBandwidth:Math.min(s,r),estimatedSendBandwidth:Math.min(a,r),remoteVideoStreams:{},localVideoStreams:{},isSpeaking:this.webRtcStatistics.getSpeakingState(),audioHwSilent:this.webRtcStatistics.getAudioHwSilent(),networkSendLevel:this.webRtcStatistics.getNetworkSendLevel(),networkRecvLevel:this.webRtcStatistics.getNetworkRecvLevel()};it(e.ssrc,(e=>{if("video"!==e.mediaType)return;const t=e.googTrackId,i=e.id;-1!==i.indexOf("_recv")?(o.remoteVideoStreams[t]={trackId:t,frameRateReceived:Number(e.googFrameRateReceived),frameRateDecoded:Number(e.googFrameRateDecoded),framesDecoded:Number(e.framesDecoded)},this.configProvider.config.isRenderingBasedOnRawStatistics||(o.remoteVideoStreams[t].isRendering=this.webRtcStatistics.getIsRendering(i))):t&&-1!==i.indexOf("_send")&&(o.localVideoStreams[t]={trackId:t,ssrc:Number(e.ssrc),frameRateInput:Number(e.googFrameRateInput)})})),mt(this.statistics,o)||(this.statistics=o,this.notifyStatisticsChanged())}notifyStatisticsChanged(){this.event("onStatisticsChanged").raise(this.statistics)}},Tk=class extends Qe{constructor(e,t,i,n,r){super(),this.logger=e,this.configProvider=t,this.diagnostics=i,this.mediaManager=n,this.window=yg.window,this.useNewStatsApi=this.configProvider.config.webrtcUseNewStatsApi&&this.configProvider.mediaConfig.simulcastSessionEnabled,this.loopIntervalTracker=new zO(this.configProvider.config.diagnostics.performanceMonitoring.fluctuationSamplesNum),this.loopIntervalAggregator=new KO,this.fetchTimeTracker=new zO(this.configProvider.config.diagnostics.performanceMonitoring.fluctuationSamplesNum),this.fetchTimeAggregator=new KO,this.gathererV1=new Ck(this.logger.createChild("V1"),this.configProvider,this.mediaManager,r),this.gathererV1.on("onStatisticsChanged",(e=>this.event("onStatisticsChanged").raise(e))),this.useNewStatsApi&&t.config.diagnostics.sideBySide&&(this.gathererV2=new OD(this.logger.createChild("V2"),this.configProvider,this.diagnostics,this.mediaManager))}initialize(e){this.pc=e,this.gathererV1.initialize(e),this.interval??(this.interval=this.window.setInterval((()=>this.processStats()),this.configProvider.config.webrtcStatPollInterval))}setAudioDecoderStatsProvider(e){this.gathererV1.setAudioDecoderStatsProvider(e),this.gathererV2?.setAudioDecoderStatsProvider(e)}dispose(){super.dispose(),this.interval&&(this.window.clearInterval(this.interval),this.interval=void 0),this.gathererV1.dispose(),this.pc=void 0}get isDisposed(){return!this.pc&&void 0===this.interval}async processStats(){if(this.configProvider.config.diagnostics.collectWhileNotConnected){if(!this.pc||"closed"===this.pc.iceConnectionState)return}else if(!this.pc||"connected"!==this.pc.iceConnectionState&&"completed"!==this.pc.iceConnectionState)return void this.gathererV2?.signalNoConnection();if(this.useNewStatsApi){const e=kt(),t=void 0===this.loopTimer?-1:e-this.loopTimer;this.loopTimer=e,this.loopIntervalTracker.captureSample(t),this.loopIntervalAggregator.captureSample(this.loopIntervalTracker.getReport());const i=this.loopIntervalAggregator.getReport();i&&(this.diagnostics.loopIntervalMax=i.max,this.diagnostics.loopIntervalMedian=i.median);const n={};(await this.pc.getStats()).forEach((e=>{this.cleanupPii(e);const t=e.type;delete e.type,n[t]??(n[t]={}),n[t][e.id]=e}));const r=kt()-e;this.fetchTimeTracker.captureSample(r),this.fetchTimeAggregator.captureSample(this.fetchTimeTracker.getReport());const s=this.fetchTimeAggregator.getReport();s&&(this.diagnostics.fetchTimeMax=s.max,this.diagnostics.fetchTimeMedian=s.median);const a=this.gathererV2?.processRawReport(n);let o=kt();this.gathererV1.processRawReport(n),o=kt()-o,a&&this.event("onDiagnosticUpdated").raise(a),a?.perfCounters&&(a.perfCounters.loopTime=t,a.perfCounters.fetchTime=r,a.perfCounters.legacyProcessingTime=o)}else this.pc.getStats((e=>{e.result&&this.gathererV1.processLegacyReport(e)}))}cleanupPii(e){switch(e.type){case"local-candidate":case"remote-candidate":{const t=e;Object.defineProperty(t,"address",{enumerable:!1}),Object.defineProperty(t,"url",{enumerable:!1}),Object.defineProperty(t,"relatedAddress",{enumerable:!1}),Object.defineProperty(t,"ip",{enumerable:!1}),Object.defineProperty(t,"usernameFragment",{enumerable:!1});break}case"certificate":{const t=e;Object.defineProperty(t,"fingerprint",{enumerable:!1}),Object.defineProperty(t,"base64Certificate",{enumerable:!1});break}}}get sessionInfo(){return this.gathererV1.sessionInfo}setReportedSendBandwidth(e){this.gathererV1.setReportedSendBandwidth(e)}onMaxCapabilitiesApplied(e){this.gathererV1.onMaxCapabilitiesApplied(e)}clearIceCandidateErrors(){this.gathererV1.clearIceCandidateErrors()}setSsrcTrackPair(e,t){this.gathererV1.setSsrcTrackPair(e,t),this.gathererV2?.setSsrcTrackPair(e,t)}addSubscriptionEvent(e,t,i,n,r,s,a){this.gathererV1.addSubscriptionEvent(e,t,i,n,r,s,a)}setSubscribedTrackSsrc(e){this.gathererV1.setSubscribedTrackSsrc(e)}addIceCandidateError(e){this.gathererV1.addIceCandidateError(e)}setH264AvailableProfiles(e){this.gathererV1.setH264AvailableProfiles(e)}setTerminated(){this.gathererV1.setTerminated()}onDeviceEvent(e){this.gathererV1.onDeviceEvent(e)}getReport(e,t=!1){const i=this.gathererV1.getReport(e,t);if(this.gathererV2&&this.configProvider.config.diagnostics.sideBySide){const e=this.loopIntervalAggregator.getReport();e&&(i.data.Extensions.LoopIntervalMax=`${bt(e.max,1)}`,i.data.Extensions.LoopIntervalMedian=`${bt(e.median,1)}`);const t=this.fetchTimeAggregator.getReport();t&&(i.data.Extensions.FetchTimeMax=`${bt(t.max,1)}`,i.data.Extensions.FetchTimeMedian=`${bt(t.median,1)}`);const n=this.diagnostics.getObjectRef();i.data.Extensions.multipleVideoStreams=JSON.stringify(Lt(n.multiViewStats,"startTime",n.startTime)),i.data.Extensions.OvcToSubscriptions=JSON.stringify(n.ovcToSubscriptionEvents),i.data.Extensions.videoPerformanceEvent=JSON.stringify(n.videoPerformanceEvent);const r=n.bandwidthReport;"REMB"===n.bweType?(i.data.Extensions.StartCallBWE=JSON.stringify(r?.startOfTheCall),i.data.Extensions.EndCallBWE=JSON.stringify(r?.endOfTheCall),i.data.Extensions.BWEStd=JSON.stringify(r?.std),i.data.Extensions.BwPercentiles=JSON.stringify(r?.bwPercentiles),i.data.Extensions.AvgBwe=JSON.stringify(r?.avgBwe)):(i.data.Extensions.StartCallBWESendSide=JSON.stringify(r?.startOfTheCall),i.data.Extensions.EndCallBWESendSide=JSON.stringify(r?.endOfTheCall),i.data.Extensions.BWEStdSendSide=JSON.stringify(r?.std),i.data.Extensions.BwPercentilesSendSide=JSON.stringify(r?.bwPercentiles),i.data.Extensions.AvgBwSendSide=JSON.stringify(r?.avgBwe)),i.data.Extensions.InitialBWSeed=JSON.stringify(n.initialBWSeed),i.data.Extensions.SentBWSeed=JSON.stringify(n.sentBWSeed),i.data.Extensions.Bandwidth_downlinkStabilizationTime=JSON.stringify(n.bwDownlinkStabilizationTime);const s=n.aggregatedModalityStats?.video?.recv||[],a=n.aggregatedModalityStats?.audio?.recv||[],o=n.aggregatedModalityStats?.sharing?.recv||[],l=s[s.length-1],d=o[o.length-1],c=l?.aggregated?.macroblockRateStats??{},h=a[a.length-1]?.aggregated?.customHealerStats??{};if(h?.pullPacketProcessingTimes){const e=Bt(h.pullPacketProcessingTimes);h.pullPacketProcessingTimeP50=e.getPercentile(.5),h.pullPacketProcessingTimeP95=e.getPercentile(.95)}if(h?.pushPacketProcessingTimes){const e=Bt(h.pushPacketProcessingTimes);h.pushPacketProcessingTimeP50=e.getPercentile(.5),h.pushPacketProcessingTimeP95=e.getPercentile(.95)}for(const e in c)i.data.Extensions[`Video_recv_${e}`]=`${bt(c[e],0)}`;for(const e in n.totalVideoRecvMblocksRates)i.data.Extensions[`totalVideoRecv_${e}`]=`${bt(n.totalVideoRecvMblocksRates[e],0)}`;for(const e in h)if(void 0!==h[e]){const t="number"!=typeof h[e]?JSON.stringify(h[e]):h[e];i.data.Extensions[`Audio_recv_customHealer_${e}`]=t}i.data.Extensions.CallSetupTimeTracker=JSON.stringify(n.timerTrackerReport),i.data.Extensions.Audio_send_presentationAPIUserDuration=JSON.stringify(n.presentationAPIUserDuration),i.data.Extensions.Audio_send_presentationDuration=JSON.stringify(n.presentationAudioDuration),i.data.Extensions.CodecSupport=JSON.stringify(n.codecSupport),i.data.Extensions.Video_recv_FpsHarmonicAverage=l?.extensions.fpsHarmonicAverage?.toString(),i.data.Extensions.Sharing_recv_FpsHarmonicAverage=d?.extensions.fpsHarmonicAverage?.toString(),i.data.Extensions.Sharing_recv_CodecReport=JSON.stringify(d?.aggregated.codecReport),this.configProvider.config.diagnostics.features.takeFreezeTelemetryFromGathererV2&&(s.length&&(i.data.Extensions.Video_recv_FreezeHistogram=JSON.stringify(l.aggregated.freezeCountHistogram),i.data.Extensions.Video_recv_LongestFreezeDuration=JSON.stringify(l?.aggregated?.longestFreeze),i.data.Extensions.Video_recv_OngoingFreeze=JSON.stringify(l?.extensions?.isFrozen),i.data.Extensions.Video_recv_OngoingFreezeDuration=JSON.stringify(l?.aggregated?.ongoingFreezeDuration),i.data.Extensions.Video_recv_TotalFreezeDuration=JSON.stringify(l?.aggregated?.totalFreezeDuration),i.data.Extensions.Video_recv_RecvAvgFreezeDuration=JSON.stringify(l?.aggregated?.avgFreezeDuration),i.data.Extensions.Video_recv_FreezeTimestamps=JSON.stringify(xt(l?.aggregated?.freezeTimestampsHistogram,n.startTime))),o.length&&(i.data.Extensions.Sharing_recv_FreezeHistogram=JSON.stringify(d.aggregated.freezeCountHistogram),i.data.Extensions.Sharing_recv_LongestFreezeDuration=JSON.stringify(d?.aggregated?.longestFreeze),i.data.Extensions.Sharing_recv_OngoingFreeze=JSON.stringify(d?.extensions?.isFrozen),i.data.Extensions.Sharing_recv_OngoingFreezeDuration=JSON.stringify(d?.aggregated?.ongoingFreezeDuration),i.data.Extensions.Sharing_recv_TotalFreezeDuration=JSON.stringify(d?.aggregated?.totalFreezeDuration),i.data.Extensions.Sharing_recv_RecvAvgFreezeDuration=JSON.stringify(d?.aggregated?.avgFreezeDuration),i.data.Extensions.Sharing_recv_FreezeTimestamps=JSON.stringify(xt(d?.aggregated?.freezeTimestampsHistogram,n.startTime)))),i.data.Extensions.EarlyMedia={NumStatsPolls:`${n.earlyMediaNumStatsPolls}`}}return i}startWaitingForStreamStart(e){this.gathererV1.startWaitingForStreamStart(e)}getTimerTracker(e,t){return this.gathererV1.getTimerTracker(e,t)}getLastStatistics(){return this.gathererV1.getLastStatistics()}updateSendStream(e,t){this.gathererV1.updateSendStream(e,t)}setSubscribedTrackIds(e){this.gathererV1.setSubscribedTrackIds(e)}setMaxSessionBandwidth(e){this.gathererV1.setMaxSessionBandwidth(e)}updateStatsWithLocalSsrcTrackInfo(){this.gathererV1.updateStatsWithLocalSsrcTrackInfo()}onSendersChanged(e,t){this.gathererV1.onSendersChanged(e,t)}setPreferredResolution(e,t,i){this.gathererV1.setPreferredResolution(e,t,i)}setIsRendering(e,t,i){this.gathererV1.setIsRendering(e,t,i)}setTimeToFirstFrame(e,t,i){this.gathererV1.setTimeToFirstFrame(e,t,i)}setFreezeDuration(e,t){this.gathererV1.setFreezeDuration(e,t)}addVideoControlMessage(e){this.gathererV1.addVideoControlMessage(e)}setSessionDataChannelState(e){this.gathererV1.setSessionDataChannelState(e)}recordDataChannelError(e){this.gathererV1.recordDataChannelError(e)}onMaxCapabilitiesRequested(e){this.gathererV1.onMaxCapabilitiesRequested(e)}recordDataChannelProtocolEvent(e){this.gathererV1.recordDataChannelProtocolEvent(e)}addReportedReceiveBandwidth(e){this.gathererV1.addReportedReceiveBandwidth(e)}},Ek=101,_k=[48e3,32e3,24e3,16e3,12e3],bk=class{constructor(e){this.context=e,this.cname=gt(),this.dataMedia={type:tt.MEDIA_TYPE.data,protocol:tt.PROFILES.rtpSavp,port:0},this.configProvider=e.configProvider,this.logger=e.getLogger().createChild("WebkitSdpTrans")}fixTelephoneEvent(e){let t;return _k.forEach((t=>{SR(e,{codec:"telephone-event",rate:t})})),uR(e,Ek,999),gR(e,{codec:"telephone-event",rate:8e3},(e=>(t=e.rtp.payload,e.rtp.payload=Ek,e))),uR(e,999,t||Ek),t}toLocal(e,t,i){const n=t.isEmpty(),r=ut(e);let s;return r.media.forEach((e=>{if("audio"===e.type)n&&(s=this.fixTelephoneEvent(e)),Ik(e);else{s&&uR(e,Ek,s);const i=t.getLocalSsrcs().get(_R(e));this.enforceFixedSsrc(e,i)}const r=Zg(this.configProvider,e.type);"offer"===i&&Mk(e,r,n,this.logger)})),new ww(this.configProvider).modify(r),delete r.extmapAllowMixed,r}toOffer(e,t,i){return this.fromNative(e,t,i,!0)}toAnswer(e,t,i){return this.fromNative(e,t,i,!1)}toRemote(e,t,i,n){const r=ut(e);let s,a,o=this.configProvider.mediaConfig.maxBandwidthInKbps;r.bandwidth&&(!o||o>e.bandwidth[0].limit)&&(o=e.bandwidth[0].limit),r.media.forEach(((e,i)=>{t.getMediaEntity(i).isDisabled()&&e.type!==tt.MEDIA_TYPE.audio&&(e.port=0)}));let l=(d=r).groups?d.groups.find((e=>"BUNDLE"===e.type)):null;var d;if(!l){let e=!1;r.media.forEach(((i,n)=>{const r=t.getMediaEntity(n);!e&&r.isEnabled()?(i.mid=r.getMid(),e=!0):(r.disable(),i.port=0)})),e&&(r.groups||(r.groups=[]),l={type:"BUNDLE"},r.groups.push(l))}r.media.forEach((e=>{const t=_R(e);i[t]===tt.MEDIA_STATE.send&&(e.direction&&e.direction.toLowerCase()===tt.MEDIA_STATE.receive||(e.direction=tt.MEDIA_STATE.receive))}));const c=r.media.filter((e=>e.type===tt.MEDIA_TYPE.video));if(c.length>0){const e=c.filter((e=>0!==e.port));if(e.length>0){a=ut(e[0]),a.bandwidth&&delete a.bandwidth;const t=this.configProvider.config.audioBandwidthInKbps?this.configProvider.config.audioBandwidthInKbps:0;o&&o-t>0&&(a.bandwidth=[{limit:o-t,type:"AS"}]),a.mid="video",a.direction=null,delete a.label,a.ssrcs=[],a.ssrcGroups=[],delete a.msid,e.forEach((e=>{var t,i;e.ssrcs&&(a.ssrcs=a.ssrcs.concat(e.ssrcs)),e.ssrcGroups&&(a.ssrcGroups=a.ssrcGroups.concat(e.ssrcGroups)),a.direction=(t=a.direction,i=e.direction||tt.MEDIA_STATE.sendReceive,t===tt.MEDIA_STATE.sendReceive||i===tt.MEDIA_STATE.sendReceive?tt.MEDIA_STATE.sendReceive:t===i?t:t&&i&&t!==i?tt.MEDIA_STATE.sendReceive:t||i)})),Pk(a)}else a=Rk(tt.MEDIA_TYPE.video,void 0,c[0].protocol,c[0].payloads)}const h=r.media.find((e=>e.type===tt.MEDIA_TYPE.audio));if(h)if(0!==h.port)s=ut(h),s.mid="audio",delete s.label,function(e){SR(e,{codec:"g722",rate:8e3,encoding:2})}(s),Ik(s),Pk(s);else{s=Rk(tt.MEDIA_TYPE.audio,void 0,h.protocol,h.payloads);const e=r.media.find((e=>!!e.iceUfrag));e&&(s.port=9,s.direction="inactive",s.mid="audio",s.iceUfrag=e.iceUfrag,s.icePwd=e.icePwd,s.rtcpMux="rtcp-mux",e.crypto&&(s.crypto=e.crypto),e.fingerprint&&(s.fingerprint=e.fingerprint,s.setup=e.setup),s.rtp=[{payload:0,codec:"PCMU",rate:8e3}],s.payloads="0")}r.media.forEach(((e,t)=>{e.type===tt.MEDIA_TYPE.data&&(e.type=tt.MEDIA_TYPE.dataChannel,e.payloads=tt.PAYLOAD_TYPE.DATA_CHANNEL,e.protocol=tt.PROFILES.udpDtlsSctp,e.mid="data",delete e.xDataProtocol,delete e.direction,AR(e)&&(r.media[t]=Rk(e.type,void 0,e.protocol,e.payloads)))}));const u=Xg(this.context)?r.media.find((e=>e.type===tt.MEDIA_TYPE.dataChannel)):null;r.media=[s,a,u].filter((e=>e)),t.getMediaEntities()[0].getModality()!==tt.MODALITY.audio&&r.media.reverse();const p=Yg(this.context),g=xg(e);return r.media.forEach((e=>{e.type!==tt.MEDIA_TYPE.dataChannel&&(!p&&e.fingerprint&&e.crypto&&delete e.crypto,e.protocol=!g.dtls||g.sdes&&p?tt.PROFILES.rtpSavpf:tt.PROFILES.udpTlsRtpSavpf)})),"offer"===n&&(Mk(s,this.configProvider.config.allowedAudioCodecs,!1,this.logger),Mk(a,this.configProvider.config.allowedVideoCodecs,!1,this.logger)),Ak(r,this.configProvider.mediaConfig.isTransportUnbundled),r}splitMedia(e,t,i,n,r){const s=e.getMid(),a=e.getModality(),o=ut(t);if(o.label=bR(a),o.direction=n,o.mid=s,o.ssrcs=[],o.ssrcGroups=[],e.getModality()===tt.MODALITY.data)return o.type=tt.MEDIA_TYPE.data,o.payloads=tt.PAYLOAD_TYPE.X_DATA,o;const l=i.filter((e=>e.modality===a));if(l&&l.length){const e=[];t.ssrcs&&(l.forEach((i=>{const n=t.ssrcs.filter((e=>"msid"===e.attribute&&i.trackId===wk(e.value))).map((e=>e.id));e.push(...n)})),o.ssrcs=t.ssrcs.filter((t=>e.indexOf(t.id)>-1)),o.ssrcs.forEach((e=>{"cname"===e.attribute&&(e.value=this.cname)}))),t.ssrcGroups&&(o.ssrcGroups=t.ssrcGroups.filter((t=>t.ssrcs.split(" ").find((t=>e.indexOf(+t)>-1)))))}else{if(n===tt.MEDIA_STATE.send||n===tt.MEDIA_STATE.sendReceive)return Rk(t.type,bR(a),t.protocol,t.payloads);n!==tt.MEDIA_STATE.receive&&n!==tt.MEDIA_STATE.inactive||(r[t.type].ssrcs&&r[t.type].ssrcs[0]?o.ssrcs=[{id:r[t.type].ssrcs[0].id,attribute:"cname",value:this.cname}]:t.type===tt.MEDIA_TYPE.audio?o.ssrcs=[{id:4195875351,attribute:"cname",value:this.cname}]:t.type===tt.MEDIA_TYPE.video&&(o.ssrcs=[{id:1,attribute:"cname",value:this.cname}]))}return o}fromNative(e,t,i,n){const r=ut(e),s=this.configProvider.mediaConfig.maxBandwidthInKbps;s&&(r.bandwidth=[{limit:s,type:"CT"}]),new Mw(this.configProvider).modify(r);const a=r.media.find((e=>e.type===tt.MEDIA_TYPE.audio)),o=r.media.find((e=>e.type===tt.MEDIA_TYPE.video)),l=r.media.find((e=>e.type===tt.MEDIA_TYPE.dataChannel)),d={};d[tt.MODALITY.audio]=a,d[tt.MODALITY.video]=o,d[tt.MODALITY.sharing]=o,d[tt.MODALITY.data]=l||this.dataMedia;const c={};c[tt.MEDIA_TYPE.audio]=a,c[tt.MEDIA_TYPE.video]=o,c[tt.MEDIA_TYPE.data]=l||this.dataMedia;const h={};return h[tt.MODALITY.audio]=t.getMediaEntitiesByModality(tt.MODALITY.audio)[0],h[tt.MODALITY.video]=t.getMediaEntitiesByModality(tt.MODALITY.video)[0],h[tt.MODALITY.sharing]=t.getMediaEntitiesByModality(tt.MODALITY.sharing)[0],h[tt.MODALITY.data]=t.getMediaEntitiesByModality(tt.MODALITY.data)[0],r.media=[],t.getMediaEntities().forEach((e=>{let s,a=i[e.getModality()];!e.isEnabled()||0===d[e.getModality()].port||e!==h[e.getModality()]&&a===tt.MEDIA_STATE.send?(s=Rk(e.getType(),bR(e.getModality()),d[e.getModality()].protocol,d[e.getModality()].payloads),d[e.getModality()].payloads===tt.PAYLOAD_TYPE.DATA_CHANNEL&&(s.payloads=tt.PAYLOAD_TYPE.DATA_CHANNEL)):(a!==tt.MEDIA_STATE.inactive&&e!==h[e.getModality()]&&(a=tt.MEDIA_STATE.receive),s=this.splitMedia(e,d[e.getModality()],t.getLocalTracksInfo(),a,c),e!==h[e.getModality()]&&(s.candidates=[]));const o=d[e.getModality()].setup;o&&("actpass"!==o?e.setExtension("setup",o):n&&void 0!==e.getExtension("setup")&&(s.setup="actpass"!==e.getExtension("setup")?e.getExtension("setup"):o));const l=d[e.getModality()].iceUfrag,u=e.getExtension("iceUfrag");e.setExtension("iceRestart",!!l&&!!u&&u!==l),e.setExtension("iceUfrag",l),AR(s)&&e.disable(),r.media.push(s)})),new KR(this.context,i.data).modify(r),Ak(r,this.configProvider.mediaConfig.isTransportUnbundled),r}enforceFixedSsrc(e,t){let i=-1;if(!e.ssrcs)return;const n=[];if(e.ssrcs.forEach((e=>{"msid"===e.attribute&&n.push({ssrc:e.id,trackId:wk(e.value)})})),e.ssrcs.forEach((e=>{"cname"===e.attribute&&i++,t&&(e.id=this.getVideoSSRC(i,t))})),e.ssrcGroups){const t=e.ssrcs.filter((e=>"cname"===e.attribute)).map((e=>e.id));e.ssrcGroups.forEach(((e,i)=>{e.ssrcs=[t[2*i],t[2*i+1]].join(" ")}))}}getVideoSSRC(e,t){return e%2==1?t+50:t}};function Pk(e){const t=new Set(["urn:ietf:params:rtp-hdrext:sdes:mid","urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id","urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id"]);e.ext&&(e.ext=e.ext.filter((e=>!t.has(e.uri))))}function Ik(e){SR(e,{codec:"CN",rate:16e3})}function Ak(e,t){const i=e.groups?.findIndex((e=>"BUNDLE"===e.type)),n=e.groups?e.groups[i]:void 0;n&&(t?(n.mids=e.media.filter((e=>e.type===tt.MEDIA_TYPE.video)).map((e=>e.mid)).filter((e=>e)).join(" "),n.mids||delete e.groups[i]):n.mids=e.media.map((e=>e.mid)).filter((e=>e)).join(" "))}function Rk(e,t,i,n){return{type:e,port:0,label:t,payloads:n,protocol:i}}function wk(e){return e.split(" ")[1]}function Mk(e,t,i,n){t.length&&e?.port&&TR(e,im(t),i,n)}var Ok=T(be()),Dk=class{getCapabilities(e){const t=RTCRtpReceiver.getCapabilities(e);return t.codecs.forEach((e=>{const t=e.mimeType.toLowerCase().split("/");e.mimeType=t[1]||t[0]})),Promise.resolve(t)}},kk=class{constructor(e,t){this.noRequiredCodecsWorkaround=t,this.selfGlobal=e.global.capabilityGatherer=e.global.capabilityGatherer||{},this.getCapabilities("video")}async getCapabilities(e){if("video"!==e&&"audio"!==e)return Promise.reject(new Error(`capabilities for ${e} are not supported`));if(!this.selfGlobal.gatherTask){const e=um();this.selfGlobal.gatherTask=e.promise;const t=void 0!==yg.window.webkitRTCPeerConnection,i=t?new yg.window.webkitRTCPeerConnection(null):new yg.window.RTCPeerConnection(null),n=e=>t?new Promise(((t,n)=>{i.createOffer(t,n,e)})):(this.noRequiredCodecsWorkaround&&i.addTrack(i.addTransceiver("video").receiver.track),i.createOffer(e));try{const t=await n({offerToReceiveVideo:1,offerToReceiveAudio:1}),r={};Ok.parse(t.sdp).media.forEach((e=>{r[e.type]=e.rtp.map((t=>{const i={mimeType:t.codec.toLowerCase()};if("video"===e.type){const n=e.fmtp?.find((e=>e.payload===t.payload));i.sdpFmtpLine=n?.config}return i}))})),i.close(),e.resolve(r)}catch(t){this.selfGlobal.gatherTask=null,i.close(),e.reject(t)}}return this.selfGlobal.gatherTask.then((t=>({codecs:t[e]})))}},Nk={build:(e,t,i=!1)=>!t&&Cg.hasCapabilitiesApi()?new Dk:new kk(e,i)},Lk=T(be()),xk="rollback";function Fk(){const e=[].slice.apply(arguments);let t=e[0]&&Uk(e[0].type);e.splice(0,t?1:0,null);const i=new(Function.prototype.bind.apply(yg.window.RTCSessionDescription,e)),n=Object.getOwnPropertyDescriptor(yg.window.RTCSessionDescription.prototype,"type");return Object.defineProperty(i,"type",{get:()=>t?xk:n.get.call(i),set(e){t=Uk(e),t||n.set.call(i,e)}}),i}function Uk(e){return xk===e}var Vk={build:()=>Fk},Hk=[{codec:"telephone-event",rate:8e3},{codec:"cn",rate:16e3}];function Bk(e){const t=[],i=Vk.build(),n=[].slice.apply(arguments);var r,s;n.splice(0,1,null),r="iceTransportPolicy",s="iceTransports",n[1]&&n[1][r]&&(n[1][s]=n[1][r]);const a=new(Function.prototype.bind.apply(yg.window.webkitRTCPeerConnection,n));function o(e,t){let i;Object.defineProperty(this,"dtmf",{get:()=>"audio"===e.kind?(i=i||a.createDTMFSender(e),i):null}),this.track=e,this._stream=t}return[{name:"createOffer",reverseArgs:!0},"createAnswer","setRemoteDescription","setLocalDescription"].forEach((function(e){const t=e.name||e,i=a[t];a[t]=function(){const t=arguments;return new Promise((function(n,r){const s=[n,r];t.length>0&&s.splice(e.reverseArgs?s.length:0,0,t[0]),i.apply(a,s)}))}})),function(){["createOffer","createAnswer","setLocalDescription"].forEach((function(t){const i=a[t];a[t]=function(){const t=arguments;return e.getCapabilities("video").then((function(){return i.apply(i,t)}))}}));const t=a.setRemoteDescription;a.setRemoteDescription=function(i){return e.getCapabilities("video").then((function(e){const n=e.codecs,r=Lk.parse(i.sdp);return r.media.forEach((function(e){if("video"===e.type&&(e.rtp.some((function(e){return n.some((function(t){return e.codec.toLowerCase()===t.mimeType}))}))?function(e){gR(e,{codec:"h264",rate:9e4},(function(e){if(e.fmtp){const t=new hR,i=new hR(e.fmtp.config);["level-asymmetry-allowed","packetization-mode","profile-level-id"].forEach((function(e){if(i.contains(e)){let n=i.get(e);"profile-level-id"===e&&(n="42C02A"),t.setIfMissing(e,n)}})),e.fmtp.config=t.toString()}}))}(e):e.port=0),!function(e){return"RTP/SAVPF"!==e.protocol}(e)){const t=IR(r);t?e.crypto=t.crypto:e.port||r.media.some((function(t){return!!t.port&&(e.crypto=t.crypto,!0)}))}})),i.sdp=Lk.write(r),t(i)}))}}(),function(){const e=a.createAnswer;a.createAnswer=function(){const t=arguments;return e.apply(a,t).then((function(e){if(!a.localDescription||!a.localDescription.sdp)return e;const t=Lk.parse(a.localDescription.sdp),n=[];if(t.media.forEach((function(e){Hk.forEach((function(t){gR(e,t,(function(e){n.push(e)}))}))})),n.length){const t=Lk.parse(e.sdp);let r=!1;t.media.forEach((function(e){n.forEach((function(t){gR(e,{codec:t.rtp.codec,rate:t.rtp.rate},(function(e){e.rtp.payload!==t.rtp.payload&&(e.rtp.payload=t.rtp.payload,r=!0)}))}))})),r&&(e=new i({type:e.type,sdp:Lk.write(t)}))}return e}))}}(),function(){const e=a.createOffer;a.createOffer=function(t){const i=arguments;return t&&t.offerToReceiveVideo>1&&(t.offerToReceiveVideo=1),e.apply(a,i)}}(),a.getSenders&&a.addTrack&&a.removeTrack||(a.getSenders=function(){return t.slice()},a.addTrack=function(e,i){if(!e||!i)throw new Error("both media track and stream need to be provided");a.getLocalStreams().some((function(e){return e.id===i.id}))||a.addStream(i);let n=t.find((function(t){return t.track.id===e.id}));return n||(n=new o(e,i),t.push(n)),n},a.removeTrack=function(e){a.getLocalStreams().filter((function(t){return t.id===e._stream.id})).forEach((function(e){a.removeStream(e)})),ot(t,(t=>t===e))}),a}var $k={build:e=>Bk.bind(null,e)},jk=class{constructor(e){const t=e.configProvider.config.useSdpCapabilitiesLegacySession,i=e.configProvider.config.noRequiredCodecsWorkaround;this.RTCRtpReceiver=Nk.build(e,t,i),this.SdpTransform=bk,this.RTCPeerConnection=$k.build(this.RTCRtpReceiver),this.RTCSessionDescription=Vk.build()}};function Gk(){function e(){throw new Error("unsupported platform")}this.SdpTransform=e,this.RTCPeerConnection=e,this.RTCSessionDescription=e,this.RTCRtpReceiver=e}var Wk={build:e=>void 0!==yg.window.webkitRTCPeerConnection?new jk(e):new Gk},qk=class{constructor(e,t,i,n){this.logger=e,this.configProvider=t,this.activeSpeakerManager=i,this.contributingSourcesProvider=n,this.lastSources=[],this.poll=()=>{const e=this.contributingSourcesProvider.getContributingSources();if(!e)return this.logger.safe.info("Contributing sources are not supported on this client"),void this.dispose();this.activeSpeakerManager.onContributingSourcesChanged(e.filter((e=>{const t=this.lastSources.find((t=>t.source===e.source));return!t||t.timestamp!==e.timestamp})).map((e=>e.source))),this.updateLastSources(e),this.timer=window.setTimeout(this.poll,this.configProvider.config.webrtcContributingSourcesPollingInterval)},this.contributingSourcesProvider=n,this.logger.safe.info("Polling started"),this.timer=window.setTimeout(this.poll,this.configProvider.config.webrtcContributingSourcesPollingInterval)}dispose(){this.timer&&(window.clearTimeout(this.timer),this.timer=void 0),this.contributingSourcesProvider=void 0,this.logger.safe.info("Polling stopped")}updateLastSources(e){this.lastSources=e.map((e=>({source:e.source,timestamp:e.timestamp})))}},zk=class{constructor(e,t){this.logger=e,this.peerConnection=t}getContributingSources(){try{if(!this.peerConnection?.getReceivers)return;const e=this.peerConnection.getReceivers().find((e=>"audio"===e.track.kind));return e?e.getContributingSources?.():[]}catch(e){return void this.logger.safe.error("Failed to get contributing sources",e)}}},Kk=i(496486),Jk=[2812,4218,8437,16875,33750,67500,108e3,135e3,198e3,244800,27e4,352500,52e4],Yk=class{constructor(e,t,i,n){this.initialMaxFS=e,this.initialMaxFPS=t,this.isAv1Allowed=i,this.h264SubscribeProfile=n,this.maxFS=e,this.maxFPS=t}setMaxFS(e,t){return!(this.maxFS===e||(this.maxFS=e,!t)||(t(this),0))}getMaxFS(){return this.maxFS}getMaxFPS(){return this.maxFPS}getMaxMBPS(){return this.calculateMbps(this.maxFS,this.maxFPS)}calculateMbps(e,t){return vt(Jk,e*t/100,!0)}resetToInitial(){this.maxFS=this.initialMaxFS,this.maxFPS=this.initialMaxFPS}fmtpParams(){return{"max-fs":this.getMaxFS(),"max-mbps":this.getMaxMBPS(),"max-fps":this.getMaxFPS()}}buildFmtp(){const e=[];let t=this.fmtpParams();return this.h264SubscribeProfile&&(t["profile-level-id"]=this.h264SubscribeProfile),e.push(t),this.isAv1Allowed&&(t=this.fmtpParams(),t.codec="AV1",e.push(t)),e}},Qk=class e{constructor(e,t){this.entity=e,this.configProvider=t}static getVideoCababilities(e,t,i){if(e!==tt.MEDIA_TYPE.video)return null;let n,r;t===tt.MODALITY.sharing?(n=i.config.webrtcScreensharingCapabilityMaxFS,r=i.config.webrtcScreensharingCapabilityMaxFPS):(n=i.config.webrtcVideoCapabilityMaxFS,r=i.config.webrtcVideoCapabilityMaxFPS,i.config.useMultiviewLimitsOnInitialRequest&&i.config.multiviewResolutionLimits[1]&&(n=NI.Send.getResolutionForHeight(i.config.multiviewResolutionLimits[1]).fs));const s=i.config.isAv1Allowed&&t===tt.MODALITY.sharing;return new Yk(n,r,s,i.config.h264SubscribeProfile)}static create(t,i,n){const r=function(e){switch(e){case tt.MODALITY.audio:return tt.MEDIA_TYPE.audio;case tt.MODALITY.video:case tt.MODALITY.sharing:return tt.MEDIA_TYPE.video;case tt.MODALITY.data:return tt.MEDIA_TYPE.data;default:return null}}(i),s=new e({modality:i,mid:n,mtype:r,extensions:{}},t);return s.localRecvCapabilities=e.getVideoCababilities(r,i,t),s}clone(){const t=new e((0,Kk.cloneDeep)(this.entity),this.configProvider);return t.setSimulcastContext(this.simulcastContext),t.localRecvCapabilities=this.localRecvCapabilities,t.remoteRecvCapabilities=this.remoteRecvCapabilities,t}getModality(){return this.entity.modality}getType(){return this.entity.mtype}getMid(){return this.entity.mid}disable(){this.entity.mid=null}update(t,i){this.entity.modality!==t&&(this.localRecvCapabilities=e.getVideoCababilities(this.entity.mtype,t,this.configProvider)),this.entity.modality=t,this.entity.mid=i,this.isEnabled()&&this.setExtension("rollback",!1)}isDisabled(){return!this.entity.mid}isEnabled(){return!!this.entity.mid}getLocalRecvCapabilities(){return this.localRecvCapabilities}getRemoteRecvCapabilities(){return{sourceId:this.getXSourceStreamId(),capabilities:this.remoteRecvCapabilities?[this.remoteRecvCapabilities]:[]}}setRemoteRecvCapabilities(e){this.remoteRecvCapabilities=e}getRemoteStreamId(){return this.entity.remoteStreamId}setRemoteStreamId(e){this.entity.remoteStreamId=e}setRemoteSsrc(e){this.entity.remoteSsrc=e}getRemoteSsrc(){return this.entity.remoteSsrc}setLocalSsrc(e){this.entity.localSsrc=e}getLocalSsrc(){return this.entity.localSsrc}getRemoteTrackId(){return this.entity.remoteTrackId}setRemoteTrackId(e){this.entity.remoteTrackId=e}getXSourceStreamId(){return this.entity.xSourceStreamId}setXSourceStreamId(e){this.entity.xSourceStreamId=e}setLocalTrackId(e){this.entity.localTrackId=e}getLocalTrackId(){return this.entity.localTrackId}setSubStreamIndex(e){this.entity.subStreamIndex=e}getSubstreamIndex(){return this.entity.subStreamIndex}getExtension(e){return this.entity.extensions[e]}setExtension(e,t){this.entity.extensions[e]=t}getRtpHeaderExtensions(){return this.entity.rtpExt}setRtpHeaderExtensions(e){this.entity.rtpExt=e}setSimulcastContext(e){this.simulcastContext=e}getSimulcastContext(){return this.simulcastContext}serialize(){return ut(this.entity)}},Xk=class{constructor(e){this.mediaEntities=[],this.mediaEntitiesBackup=[],this.mediaTracks=[],this.localSsrcs=new Map,this.ssrcGenerator=new vO,this.logger=e.logger.createChild("MM"),this.configProvider=e.configProvider,this.numVideoChannels=e.numVideoChannels}fromOffer(e,t){e.media.forEach((e=>{if(e.type===tt.MEDIA_TYPE.audio)tt.MODALITY.audio in t&&this.addMediaEntity(tt.MODALITY.audio);else if(e.type===tt.MEDIA_TYPE.video){if(tt.MODALITY.video in t)for(let e=0;e<this.numVideoChannels;e++)this.addMediaEntity(tt.MODALITY.video);tt.MODALITY.sharing in t&&this.addMediaEntity(tt.MODALITY.sharing)}else e.type===tt.MEDIA_TYPE.data&&tt.MODALITY.data in t&&this.addMediaEntity(tt.MODALITY.data)}))}fromRemote(e,t){e.media.forEach(((e,i)=>{const n=_R(e);if(AR(e)||!(n in t))this.mediaEntities[i]?this.mediaEntities[i].disable():this.addDisabledMediaEntity(n),this.mediaEntities[i].setRemoteStreamId(null),this.mediaEntities[i].setRemoteTrackId(null);else{if(this.mediaEntities[i]?this.mediaEntities[i].update(n,e.mid||this.generateMid(i)):this.addMediaEntity(n,e.mid||this.generateMid(i)),e.msid)this.mediaEntities[i].setRemoteStreamId(e.msid.split(" ")[0]),this.mediaEntities[i].setRemoteTrackId(e.msid.split(" ")[1]);else if(e.ssrcs){const t=e.ssrcs.find((e=>"msid"===e.attribute));t?(this.mediaEntities[i].setRemoteStreamId(t.value.split(" ")[0]),this.mediaEntities[i].setRemoteTrackId(t.value.split(" ")[1])):this.logger.safe.warn(`No ssrc msid for media of type ${e.type} with mid ${e.mid}`)}const t=e.xSourceStreamId||this.generateSourceStreamId(i);this.mediaEntities[i].setXSourceStreamId(t)}}))}isEmpty(){return 0===this.mediaEntities.length}addMediaEntity(e,t){this.createMediaEntity(e,t||this.generateMid(this.mediaEntities.length))}addDisabledMediaEntity(e){this.createMediaEntity(e)}getMediaEntities(){return this.mediaEntities}createMediaEntity(e,t){const i=Qk.create(this.configProvider,e,t);return this.mediaEntities.push(i),i}getMediaEntity(e){return this.mediaEntities[e]}getMediaEntityByMid(e){return this.mediaEntities.find((t=>t.getMid()===e))}getMediaEntitiesByModality(e){return this.mediaEntities.filter((t=>t.getModality()===e))}getMediaEntityByRemoteStreamId(e){return this.mediaEntities.find((t=>t.getRemoteStreamId()===e))}getMediaEntityByLocalTrackId(e){return this.mediaEntities.find((t=>t.getLocalTrackId()===e))}getMediaEntityByXSourceStreamId(e){return this.mediaEntities.find((t=>t.getXSourceStreamId()===e))}reset(){this.mediaEntities=[]}syncModalities(e,t,i){this.disableModalities(t),i||(this.enableModalities(t),this.addModalities(t))}enableModalities(e){this.mediaEntities.forEach(((t,i)=>{t.getModality()in e&&t.isDisabled()&&t.update(t.getModality(),this.generateMid(i))}))}disableModalities(e){this.mediaEntities.forEach((t=>{t.getModality()in e||t.disable()}))}setRollbackUpdateHandler(e){}addModalities(e){const t={};this.mediaEntities.map((e=>e.getModality())).forEach((e=>{t[e]=!0}));for(const i in e)i in t||this.addMediaEntity(i)}setLocalTracksInfo(e){this.mediaTracks=e,this.updateLocalSsrc(this.mediaTracks)}getLocalTracksInfo(){return this.mediaTracks}getLocalSsrcs(){return this.localSsrcs}updateMediaEntitiesWithLocalTracks(){this.mediaTracks&&(this.mediaEntities.forEach((e=>e.setLocalTrackId(null))),this.mediaTracks.forEach((e=>{const t=this.getMediaEntitiesByModality(e.modality)[0];t?t.setLocalTrackId(e.trackId):this.logger.safe.error(`Media entity is not found for modality: ${JSON.stringify(e.modality)}`)})))}updateMediaEntitiesWithActivityState(e,t){}backup(){this.mediaEntitiesBackup=[],this.mediaEntities.forEach((e=>{this.mediaEntitiesBackup.push(e.clone())}))}commit(){this.mediaEntitiesBackup=[]}rollback(){this.mediaEntities=this.mediaEntitiesBackup}generateSourceStreamId(e){return e+10}generateMid(e){return`media_${e}`}updateLocalSsrc(e){e.forEach((e=>{if(!this.localSsrcs.get(e.modality)){const t=this.ssrcGenerator.nextVideoStreamSsrc().min;this.logger.safe.debug(`Ssrc updated for modality: ${e.modality}: ${t}`),this.localSsrcs.set(e.modality,t)}}))}},Zk=T(be()),eN=class{constructor(e,t,i,n,r){this.logger=e,this.RtcDescType=t,this.sessionDescription=i,this.negotiationQueue=n,this.mediaManager=r}dispose(){this.peerConnection=null}configure(e){this.peerConnection=e}renegotiateNow(){return this.renegotiate(null,!0)}renegotiate(e,t=!1,i="local"){if(!this.peerConnection)throw new Error("trying to renegotiate during empty peerConnection");const n="local"===i?this.createNegotiationTaskForHaveLocalOffer(e):this.createNegotiationTaskForHaveRemoteOffer(e);return t?(this.logger.safe.info(`forced ${i} renegotiation starting`),Promise.resolve(n())):this.negotiationQueue.add(n)}normalizeRemoteSdpSDES(e,t){if(t.media[0].crypto)e.media.forEach((e=>{delete e.fingerprint,delete e.setup,e.crypto=e.crypto.filter((e=>t.media[0].crypto.some((t=>t.id===e.id)))).slice(0,1)})),e.fingerprint&&delete e.fingerprint;else{const t=this.mediaManager.getMediaEntities().find((e=>void 0!==e.getExtension("setup")));e.media.forEach((e=>{const i=t?.getExtension("setup")||"actpass";"actpass"===e.setup&&(e.setup="active"===i?"passive":"active")}))}}normalizeRemoteSdpExtensions(e,t){e.media.forEach(((e,i)=>{const n=new Set(t.media[i].ext?.map((e=>e.value))||[]);e.ext=e.ext?.filter((e=>n.has(e.value)))}))}throwIfNoPeerConnection(){if(!this.peerConnection)throw this.logger.safe.warn("no peer connection present"),new Error("trying to renegotiate during empty peerConnection")}createNegotiationTaskForHaveLocalOffer(e){return()=>{let t=this.peerConnection.remoteDescription.sdp;const i=this.peerConnection.localDescription.sdp;this.logger.safe.info(`local renegotiation starting remoteSdp=${!!t} localSdp=${!!i}`);const n=Zk.parse(t),r=Zk.parse(i);this.normalizeRemoteSdpSDES(n,r),this.normalizeRemoteSdpExtensions(n,r),t=Zk.write(n);let s=new this.RtcDescType({sdp:t,type:"answer"});return e&&e.forEach((e=>{s=e.modifyDescriptor(s)})),Promise.resolve().then((()=>(this.logger.safe.info("creating offer"),this.throwIfNoPeerConnection(),this.peerConnection.createOffer()))).then((e=>{this.throwIfNoPeerConnection();const t=this.sessionDescription.createLocalOffer(e.sdp),i=new this.RtcDescType({sdp:t.toLocal(),type:"offer"});return this.logger.safe.info("setting local description"),this.logger.unsafe.debug(`local description, sdp: ${i.sdp}`),this.peerConnection.setLocalDescription(i)})).then((()=>(this.throwIfNoPeerConnection(),this.logger.safe.info("setting remote description"),this.logger.unsafe.debug(`remote description, sdp: ${s.sdp}`),this.peerConnection.setRemoteDescription(s)))).then((e=>(this.logger.safe.debug("local renegotiation done"),e))).catch((e=>{throw this.logger.safe.error("local renegotiation failed: ",e.toString()),e}))}}createNegotiationTaskForHaveRemoteOffer(e){return this.logger.safe.info("createNegotiationTaskForRemote"),()=>(this.logger.safe.info("proceed with setting local sdp start"),Promise.resolve().then((()=>(this.logger.safe.info("creating answer"),this.throwIfNoPeerConnection(),this.peerConnection.createAnswer()))).then((e=>{this.logger.safe.info("applying answer"),this.throwIfNoPeerConnection();const t=this.sessionDescription.createLocalAnswer(e.sdp),i=new this.RtcDescType({sdp:t.toLocal(),type:"answer"});return this.logger.safe.info("setting [answer] local description"),this.logger.unsafe.debug(`[answer] local description, sdp: ${i.sdp}`),this.peerConnection.setLocalDescription(i)})).then((e=>(this.logger.safe.info("local answer for renegotiation is done"),e))).catch((e=>{throw this.logger.safe.error("local answer for renegotiation failed: ",e.toString()),e})))}},tN=15e3,iN=class{constructor(e,t,i){this.settings=e,this.listener=t,this.logger=i,this.lastSendBW=0,this.coolingDown=!1,this.cooldownTimer=null,this.cooldownEnd=0,this.active=!1,this.maxResolution=this.settings.maxResolution,this.settings.scalingEnabled?this.active=!0:this.logger.safe.info("Resolution management disabled: no resolution management for 1x1 calls")}dispose(){this.currentResolution=null,this.pendingResolution=null,this.maxResolution=null,this.listener=null,this.active=!1,clearTimeout(this.cooldownTimer),this.cooldownTimer=null,this.listener=null}setMaxResolution(e){const t=NI.Send.getResolutionByFs(e);t!==this.maxResolution&&(this.logger.safe.info(`Setting max resolution: ${t}`),this.maxResolution=t,this.lastSendBW&&this.processEstimatedBandwidth(this.lastSendBW))}updateEstimatedSendBandwidth(e){e!==this.lastSendBW&&(this.logger.safe.debug(`Send BW: ${e}`),this.processEstimatedBandwidth(e))}resetCurrentResolution(){this.currentResolution=null}getCurrentResolution(){return this.currentResolution?.fs}setCurrentResolution(e){this.currentResolution=e}applyRes(e){this.pendingResolution=e,this.coolingDown&&(!this.currentResolution||e.fs>this.currentResolution.fs)||(this.coolingDown=!0,this.logger.safe.info(`Changing resolution to ${e}`),this.listener&&this.listener.onResolutionChanged(e.fs).then((t=>{t?(e===this.pendingResolution&&(this.pendingResolution=null),this.coolingDown&&!this.currentResolution&&(this.coolingDown=!1),this.currentResolution=e,this.cooldown()):(this.logger.safe.info("Unable to apply resolution at the moment"),this.cooldown(5e3))})).catch((e=>{this.logger.safe.error(`Error while applying new resolution: ${JSON.stringify(e)}`),this.pendingResolution=null})))}cooldown(e=15e3){!this.active||this.coolingDown&&this.cooldownEnd-Date.now()>tN||(this.cooldownTimer&&clearTimeout(this.cooldownTimer),this.coolingDown=!0,this.cooldownEnd=Date.now()+tN,this.cooldownTimer=setTimeout((()=>{this.logger.safe.debug("Resolution changer cooled down"),this.coolingDown=!1,this.cooldownTimer=null,this.pendingResolution?this.proposeResolution(this.pendingResolution):this.processEstimatedBandwidth(this.lastSendBW)}),e))}proposeResolution(e){let t=e;this.maxResolution&&this.maxResolution.fs<t.fs&&(t=this.maxResolution),this.currentResolution&&t.fs===this.currentResolution.fs||this.applyRes(t)}processEstimatedBandwidth(e){const{lowRes:t,highRes:i}=NI.Send.getResolutionForBitrate(e),n=e<this.lastSendBW?i:t;e<this.lastSendBW&&n&&this.currentResolution&&this.currentResolution.fs<n.fs||(n&&this.proposeResolution(n),this.lastSendBW=e)}};function nN(e,t){const i=1e3*((t.mediaConfig.maxBandwidthInKbps||Math.floor(Number.MAX_SAFE_INTEGER/1e3))-(t.config.audioBandwidthInKbps||0)),n=e.transport?.selectedCandidatePair?.availableOutgoingBitrate??0;return Math.min(i,n)}var rN=class extends Qe{constructor(e,t){super(t),this.configProvider=e,this.logger=t,this.lastReportedAgo=1/0,this._forceUpdate=!1}forceUpdate(){this._forceUpdate=!0}onBandwidthChanged(e){this._forceUpdate?this.updateBandwidth(e,"forceUpdate"):this.processEstimatedBandwidth(e)}processEstimatedBandwidth(e){if(this.lastReportedAgo++,!e||this.bandwidth===e)return;const t=this.configProvider.config.webrtcSendBandwidthIgnoredUpdateLimit,i=this.configProvider.config.webrtcSendBandwidthThreshold,n=this.lastReportedAgo===1/0,r=!t&&!i,s=t&&this.lastReportedAgo>=t,a=i&&Math.abs((e-this.bandwidth)/this.bandwidth)>=i;if(n||r||s||a){const t=+n|+r<<1|+s<<2|+a<<3,i=this.getUpdateReason(t);this.updateBandwidth(e,i)}}updateBandwidth(e,t){this.bandwidth=e,this.logger.safe.debug(`Updating send bandwidth: ${this.bandwidth}, reason: ${t}`),this.notifySendBandwidthChanged()}notifySendBandwidthChanged(){this._forceUpdate=!1,this.event("onSendBandwidthChanged").raise(this.bandwidth),this.lastReportedAgo=0}getUpdateReason(e){return 1&e?"firstReport":2&e?"throttlingDisabled":4&e?"noReportsForTooLong":8&e?"bigMovement":"none"}},sN=class{constructor(e,t,i,n,r,s,a){this.listener=e,this.statisticsGatherer=t,this.diagnostics=i,this.logger=n,this.configProvider=r,this.isSimulcastEnabled=a,this.serialQueue=new _I(this.logger),this.modality=tt.MODALITY.video;const o=s.maxResolution?{maxFs:s.maxResolution.fs}:null;this.validator=new jI(this.logger.createChild("CapsValidator"),o),this.resolutionManager=new iN(s,this,this.logger.createChild("rm")),this.statisticsGatherer.on("onStatisticsChanged",(e=>this.onStatisticsChanged(e))),this.statisticsGatherer.on("onDiagnosticUpdated",(e=>this.onDiagnosticUpdated(e)))}async setMaxCapabilities(e,t){const i={modality:this.modality,causeId:e,capabilities:t,isSimulcastEnabled:this.isSimulcastEnabled};this.statisticsGatherer.onMaxCapabilitiesRequested(i),this.diagnostics?.onMaxCapabilitiesRequested(i),this.causeId=e;const n=this.validator.ensureValidity(t[0]);this.streamSenderParams={...t[0],...n},this.resolutionManager.setMaxResolution(this.streamSenderParams.maxFs),this.configProvider.mediaConfig.simulcastSessionEnabled&&await this.applyCapabilities(this.getParamsToApply())}resetCurrentResolution(){this.resolutionManager.resetCurrentResolution()}getCurrentResolution(){return this.resolutionManager.getCurrentResolution()}setCurrentResolution(e){this.resolutionManager.setCurrentResolution(e)}async onResolutionChanged(e){return this.applyCapabilities(this.getParamsToApply(e))}dispose(){this.resolutionManager.dispose(),this.resolutionManager=null}async applyCapabilities(e){return e?this.lastAppliedSenderParams===e?(this.logger.safe.info(`Capabilities already applied: ${JSON.stringify(e)}`),!0):(this.logger.safe.info(`Capabilities to apply: ${JSON.stringify(e)}`),this.lastAppliedSenderParams=e,this.listener.onReceiveCapabilitiesChanged(this.modality,this.causeId,[e])):(this.logger.safe.error("Send capabilities are not set. Cannot apply constraints"),!1)}getParamsToApply(e){if(!this.streamSenderParams)return null;const t=e||this.resolutionManager.getCurrentResolution();if(!t||this.streamSenderParams.maxFs<=t)return this.streamSenderParams;const i=ht(this.streamSenderParams);return i.maxFs=t,i}onStatisticsChanged(e){this.configProvider.config.diagnostics.features.useNewSendBandwidthCalculation||this.resolutionManager.updateEstimatedSendBandwidth(e.estimatedSendBandwidth)}onDiagnosticUpdated(e){if(this.configProvider.config.diagnostics.features.useNewSendBandwidthCalculation){if(!e.video?.send?.length||!e.video.send[0])return;const t=nN(e.video.send[0],this.configProvider);this.resolutionManager.updateEstimatedSendBandwidth(t)}}};E([WA()],sN.prototype,"applyCapabilities",1);var aN=class{constructor(e,t,i,n,r){this.modality=e,this.listener=t,this.statisticsGatherer=i,this.diagnostics=n,this.isSimulcastEnabled=r}setMaxCapabilities(e,t){const i={modality:this.modality,causeId:e,capabilities:t,isSimulcastEnabled:this.isSimulcastEnabled};this.statisticsGatherer.onMaxCapabilitiesRequested(i),this.diagnostics?.onMaxCapabilitiesRequested(i),this.listener.onReceiveCapabilitiesChanged(this.modality,e,t)}dispose(){}resetCurrentResolution(){}getCurrentResolution(){return null}setCurrentResolution(e){}},oN=class{constructor(e,t,i,n,r,s){this.logger=e,this.settings=t,this.listener=i,this.statsGatherer=n,this.diagnostics=r,this.configProvider=s,this.mediaSourceModels=[],this.pendingCapabilities=new Map,this.statsGatherer.on("onDiagnosticUpdated",(e=>this.onDiagnosticUpdated(e))),this.statsGatherer.on("onStatisticsChanged",(e=>this.onStatisticsChanged(e)))}dispose(){this.mediaSourceModels.forEach((e=>{e.handler&&(e.handler.dispose(),e.handler=null)})),this.mediaSourceModels=null,this.sendBandwidthCalculator&&this.disableSendBandwidthCalculator()}updateRegisteredSources(e){this.logger.safe.info(`Local media params updated: ${JSON.stringify(e)}`);const t=[];this.mediaSourceModels.forEach((e=>t.push(e.sourceId)));const i=e.map((e=>e.sourceId)),n=Tt(t,i);this.removeSourcesWithIds(n);const r=Tt(i,t);this.addSourcesWithIds(r,e),this.settings.sendBandwidthNotificationsEnabled&&this.updateSendBandwidthCalculator()}setMaxCapabilities(e){for(const t of e){if(!t.capabilities.length)continue;if(!t.sourceId){this.logger.safe.info(`SourceId is not defined to apply recv capabilities: ${JSON.stringify(t)}`);continue}const e=this.getModelWithSourceId(t.sourceId);if(!e){this.logger.safe.info(`Model is not registered for sourceId: ${t.sourceId}`),this.configProvider.config.enableCachingFMTP&&this.pendingCapabilities.set(t.sourceId,t);continue}this.logger.safe.info(`Capabilities handler found for sourceId: ${t.sourceId}`);const i=this.getOrCreateHandlerForModel(e,t.isSimulcast);i?i.setMaxCapabilities(t.causeId,t.capabilities):this.logger.safe.info(`Handler is not found for sourceId: ${t.sourceId}`)}this.logger.safe.debug("Max capabilities application completed")}setPendingCapabilities(){if(!this.configProvider.config.enableCachingFMTP)return;this.logger.safe.info(`Apply pending capabilties for sources [${Array.from(this.pendingCapabilities.keys())}]`);const e=Array.from(this.pendingCapabilities.values());this.setMaxCapabilities(e),this.pendingCapabilities.clear()}clearPendingCapabilities(){this.pendingCapabilities.clear()}resetCurrentResolution(){const e=this.mediaSourceModels.find((e=>e.modality===tt.MODALITY.video));e?.handler&&e.handler.resetCurrentResolution()}getCurrentResolution(){const e=this.mediaSourceModels.find((e=>e.modality===tt.MODALITY.video));return e?.handler?e.handler.getCurrentResolution():this.currentResolution?.fs}setCurrentResolution(e){const t=this.mediaSourceModels.find((e=>e.modality===tt.MODALITY.video));t?.handler?t.handler.setCurrentResolution(e):this.currentResolution=e}onStatisticsChanged(e){this.configProvider.config.diagnostics.features.useNewSendBandwidthCalculation||this.sendBandwidthCalculator.onBandwidthChanged(e.estimatedSendBandwidth)}onDiagnosticUpdated(e){if(this.configProvider.config.diagnostics.features.useNewSendBandwidthCalculation){if(!e.video?.send?.length||!e.video?.send[0])return;const t=nN(e.video.send[0],this.configProvider);this.sendBandwidthCalculator.onBandwidthChanged(t)}}getOrCreateHandlerForModel(e,t){return e.handler||(e.handler=this.getCapabilitiesHandler(e.modality,t)),e.handler}addSourcesWithIds(e,t){e.forEach((e=>{const i=t.find((t=>t.sourceId===e));this.registerSource(e,i.modality)}))}removeSourcesWithIds(e){e.forEach((e=>this.unregisterSource(e)))}registerSource(e,t){this.logger.safe.info(`SourceId ${e} registered with mediaType: ${t}`),this.mediaSourceModels.push({modality:t,sourceId:e})}unregisterSource(e){const t=this.mediaSourceModels.find((t=>t.sourceId===e));t?(t.handler&&t.handler.dispose(),this.mediaSourceModels.splice(this.mediaSourceModels.indexOf(t),1),this.logger.safe.info(`SourceId ${e} unregistered`)):this.logger.safe.info(`Model doesn't exist with sourceId ${e}`)}updateSendBandwidthCalculator(){this.mediaSourceModels.some((e=>[tt.MODALITY.video,tt.MODALITY.sharing].indexOf(e.modality)>-1))?this.enableSendBandwidthCalculator():this.disableSendBandwidthCalculator()}enableSendBandwidthCalculator(){this.sendBandwidthCalculator||(this.sendBandwidthCalculator=new rN(this.configProvider,this.logger.createChild("SendBwCalc")),this.sendBandwidthCalculatorSubscription=this.sendBandwidthCalculator.on("onSendBandwidthChanged",(e=>this.onSendBandwidthChanged(e))))}disableSendBandwidthCalculator(){this.sendBandwidthCalculatorSubscription&&(this.sendBandwidthCalculatorSubscription.dispose(),this.sendBandwidthCalculatorSubscription=null),this.sendBandwidthCalculator&&(this.sendBandwidthCalculator.dispose(),this.sendBandwidthCalculator=null)}getModelWithSourceId(e){return this.mediaSourceModels.find((t=>t.sourceId===e))}getCapabilitiesHandler(e,t){if(e===tt.MODALITY.audio)return null;if(e===tt.MODALITY.video&&!t&&this.settings.customBwEstimationEnabled){const e=new sN(this.listener,this.statsGatherer,this.diagnostics,this.logger.createChild("ach"),this.configProvider,this.settings,t);return this.currentResolution&&e.setCurrentResolution(this.currentResolution),e}return new aN(e,this.listener,this.statsGatherer,this.diagnostics,t)}onSendBandwidthChanged(e){return this.listener.onSendBandwidthChanged(e).catch((e=>{this.logger.safe.error("Error while reporting send bandwidth change",e),this.sendBandwidthCalculator.forceUpdate()}))}},lN=class extends Qe{constructor(e,t,i,n,r,s){super(e),this.logger=e,this.multiParty=t,this.configProvider=i,this.mediaManager=n,this.statsGatherer=r,this.diagnostics=s,this.rendererResolutions=new Map,this.rendererResolutionsApplied=new Map,this.rendererResolutionMax=new Map,this.hasPendingLimitResolutionUpdate=!1}addRenderer(e){this.rendererResolutions.set(e,{width:0,height:0}),e.on("onRendererSizeChanged",((e,t)=>{this.onRendererSizeChanged(e,t)})),this.scheduleUpdateLimitedResolutions()}removeRenderer(e){this.rendererResolutions.delete(e),this.rendererResolutionsApplied.delete(e),this.rendererResolutionMax.delete(e),this.scheduleUpdateLimitedResolutions()}clearRenderers(){this.rendererResolutions.clear(),this.rendererResolutionsApplied.clear(),this.rendererResolutionMax.clear()}getMaxAllowedVideoFS(){const e=this.getMaxHeightFromConfig(this.renderersCount);return this.getMaxFSForHeight(e)}limitResolutionOnPoorPerformance(e){const t=this.getRendererByMsi(e);if(!t)return;const i=t.resolution.height>t.resolution.width,n=NI.Recv.getNextLowerResolution(t.resolution.width,t.resolution.height);if(!n)return void this.logger.safe.info("Poor perf. Lowest resolution reached. Not limiting resolution");const r={width:i?n.height:n.width,height:i?n.width:n.height};this.rendererResolutionMax.set(t.renderer,r),this.diagnostics?.registerResolutionChanageRequest({ts:Date.now(),msi:t.renderer.getMsi(),res:r}),this.logger.safe.info(`Poor perf. Limiting resolution for renderer msi: ${t.renderer.getMsi()} from ${t.resolution.height}p to ${r.height}p`),this.onRendererSizeChanged(t.renderer,r)}get renderersCount(){return this.rendererResolutions.size}getMaxFSForHeight(e){return this.limitMaxFS(NI.Recv.getResolutionForHeight(e).fs)}getRendererByMsi(e){for(const[t,i]of this.rendererResolutions.entries())if(t.getMsi()===e)return{renderer:t,resolution:i};return null}applyRendererResolution(e,t){this.setMaxFSCapabilities(e,t),this.rendererResolutionsApplied.set(e,t);const i=e.getMediaStream()&&e.getMediaStream().getVideoTracks();i?.[0]&&this.statsGatherer.setPreferredResolution(i[0].id,t,e.getModality())}onRendererSizeChanged(e,t){this.rendererResolutions.set(e,t),this.scheduleUpdateLimitedResolutions()}scheduleUpdateLimitedResolutions(){this.hasPendingLimitResolutionUpdate||(this.hasPendingLimitResolutionUpdate=!0,window.setTimeout((()=>{this.hasPendingLimitResolutionUpdate=!1;const e=this.groupMaxRenderersResolutionsByMsi();this.logger.safe.info(`Updating resolution limits: renderers count ${this.renderersCount}`),this.spotlightedRenderer=this.findSpotlightedRenderer(),this.spotlightedRenderer&&this.logger.safe.info(`Spotlighted renderer: ${this.spotlightedRenderer.getMsi()}`);for(const[t,i]of this.rendererResolutions.entries()){if(!i.height)continue;const n=e.get(t.getMsi()),r=this.limitRendererResolution(t,n||i),s=this.rendererResolutionsApplied.get(t);(!s||s.height!==r.height||s.width!==r.width)&&this.applyRendererResolution(t,r)}}),this.configProvider.config.multiviewResolutionLimitUpdateThrottleDelay))}findSpotlightedRenderer(){if(1===this.renderersCount||!this.configProvider.config.isSpotlightEnabled)return;let e,t=0,i=0;for(const[n,r]of this.rendererResolutions.entries()){if(!r.height)continue;i++;const s=NI.Recv.getMaxFS(r.width,r.height);s>t?(e=n,t=s):s===t&&(e=void 0)}return i<=1?void 0:e}getMaxHeightFromConfig(e,t=!1){return t?this.configProvider.config.maxSpotlightResolution:this.configProvider.config.multiviewResolutionLimits[`${e}`]||this.configProvider.config.multiviewResolutionLimits.more}getMaxHeight(e){const t=this.spotlightedRenderer?.getMsi()===e.getMsi();let i=this.getMaxHeightFromConfig(this.renderersCount,t);const n=this.rendererResolutionMax.get(e);return n&&(i=Math.min(i,Math.min(n.height,n.width))),i}limitRendererResolution(e,t){const i=this.getMaxHeight(e);if(!i)return t;if(t.height>t.width&&t.width>i){const e=i/t.width;return{height:Math.ceil(t.height*e),width:i,limited:!0}}if(t.width>t.height&&t.height>i){const e=i/t.height;return{height:i,width:Math.ceil(t.width*e),limited:!0}}return t}setMaxFSCapabilities(e,t){const i=e.getMediaStream();if(!i)return void this.logger.safe.warn("renderer has no stream attached");const n=this.mediaManager.getMediaEntityByRemoteStreamId(i.id);if(!n?.getLocalRecvCapabilities())return void this.logger.safe.warn(`no capabilities for provided modality: ${e.getModality()}`);const r=t.limited?this.getMaxFSForHeight(t.height):this.getMaxFS(t.width,t.height),s=n.getLocalRecvCapabilities();s.setMaxFS(r,(()=>{if(this.logger.safe.info(`updated max-fs video capability to ${r} for renderer msi: ${e.getMsi()}`),this.multiParty&&this.configProvider.config.webrtcMultiPartyRecvVideoSignaling){const t=e.getMsi(),n=s.buildFmtp();this.event("onSourceRequestRequired").raise(i.id,t,n)}else this.event("onNegotiationRequired").raise()}))}getMaxFS(e,t){return this.limitMaxFS(NI.Recv.getMaxFS(e,t))}limitMaxFS(e){return this.multiParty?Math.min(e,this.configProvider.config.webrtcMultiPartyRecvVideoMaxFS):Math.min(e,this.configProvider.config.webrtcRecvVideoMaxFS)}groupMaxRenderersResolutionsByMsi(){const e=new Map;return this.rendererResolutions.forEach(((t,i)=>{const n=i.getMsi(),r=e.get(n);(!r||t.width>r.width&&t.height>r.height)&&e.set(n,t)})),e}},dN=class extends Qe{constructor(e,t){super(),this.configProvider=e,this.getModality=t,this.isRendering=!1,this.currentFreezeDuration=0,this.mediaStarted=!1,this.lastBytesRecv=0,this.currentLowBitrateDuration=0}captureRawStatistics(e){const t=e.googFrameRateDecoded,i=e.googFrameRateReceived,n=e.bytesReceived;void 0!==n&&this.getModality()!==tt.MODALITY.sharing&&this.configProvider.config.isBytesRecvUsedInIsRenderingCalculation&&this.calculateBitrate(n,t),t>0&&(this.mediaStarted=!0),0===t||0===i?this.currentFreezeDuration+=tt.TIME_INTERVAL.SEC_1:t>0&&(void 0===i||i>0)&&(this.currentFreezeDuration=0);const r=this.configProvider.config.notRenderingTimeInterval[this.getModality()];this.setIsRendering(r)}updateRenderingTracker(e){const t=e.extensions.frameRateDecoded||0,i=e.extensions.frameRateReceived||0,n=e.extensions.bitrate;void 0!==n&&this.getModality()!==tt.MODALITY.sharing&&this.configProvider.config.isBytesRecvUsedInIsRenderingCalculation&&this.calculateLowBitrateDuration(n,t),t>0&&(this.mediaStarted=!0),0===t||0===i?this.currentFreezeDuration+=tt.TIME_INTERVAL.SEC_1:t>0&&(void 0===i||i>0)&&(this.currentFreezeDuration=0);const r=this.configProvider.config.notRenderingTimeInterval[this.getModality()];this.setIsRendering(r)}calculateLowBitrateDuration(e,t){e/1e3<this.configProvider.config.notRenderingLowBitrateThreshold&&t<this.configProvider.config.notRenderingLowFramerateThreshold?this.currentLowBitrateDuration++:this.currentLowBitrateDuration=0}calculateBitrate(e,t){const i=8*(e-this.lastBytesRecv);this.lastBytesRecv=e,this.calculateLowBitrateDuration(i,t)}setIsRendering(e){const t=this.currentFreezeDuration<e&&this.currentLowBitrateDuration<e&&this.mediaStarted;t!==this.isRendering&&(this.isRendering=t,this.event("onIsRenderingChanged").raise(this.isRendering))}},cN=class extends Qe{constructor(e,t,i){super(),this.videoElement=e,this.configProvider=t,this.getTimeToFirstFrame=i,this.prevCurrentTime=0,this.prevDecodedFrameCount=0,this.prevTimestamp=Date.now(),this.currentFreezeDuration=0,this.freezeDurationTimer=window.setInterval((()=>{this.calcFreezeDurationMs()}),this.configProvider.config.freezeIntervalFrequency)}calcFreezeDurationMs(){const e=this.videoElement.currentTime,t=e===this.prevCurrentTime,i=this.videoElement.webkitDecodedFrameCount,n=void 0===i||i===this.prevDecodedFrameCount;if(this.prevCurrentTime=e,this.prevDecodedFrameCount=i,-1!==this.getTimeToFirstFrame())if(t&&n){const e=Date.now();this.currentFreezeDuration+=e-this.prevTimestamp,this.prevTimestamp=e}else{if(this.currentFreezeDuration>this.configProvider.config.freezeMinDuration){const e=this.calcFreeze();this.event("onFreezeEnded").raise(e)}this.currentFreezeDuration=0}this.prevTimestamp=Date.now()}getEndOfTheFreeze(){let e=0;return this.currentFreezeDuration>0&&(e=this.calcFreeze(),this.currentFreezeDuration=0),e}dispose(){const e=this.getEndOfTheFreeze();this.event("onFreezeEnded").raise(e),clearInterval(this.freezeDurationTimer)}calcFreeze(){const e=Date.now()-this.prevTimestamp;return this.currentFreezeDuration+e}},hN=class extends MI{constructor(e,t,i,n,r,s){super(r,e.createChild("remote"),t),this.diagnostics=i,this.subscriptionManager=n,this.sessionDiagnostics=s,this.disposed=!1,this.currentIsRendering=!1,this.startTimeTTFF=0,this.timeToFirstFrame=-1,this.isTimeToFirstFrameReported=!1,this.configProvider.config.freezeIntervalFrequency&&(this.freezeTracker=new cN(this.getVideoElement(),this.configProvider,(()=>this.timeToFirstFrame)),this.freezeTracker.on("onFreezeEnded",(e=>{this.diagnostics?.addFreezeDuration(e),this.event("onFreezeEnded").raise(e)}))),this.configProvider.config.isRenderingBasedOnRawStatistics&&(this.isRenderingTracker=new dN(this.configProvider,this.getModality.bind(this)),this.isRenderingChangedSubscription=this.isRenderingTracker.on("onIsRenderingChanged",(e=>{this.setIsRendering(e)}))),this.overlayStats=new II(this.configProvider.config.showStatsInCall,r,this)}getEndOfTheFreeze(){return this.freezeTracker?.getEndOfTheFreeze()}resetTimeToFirstFrameFlag(){this.isTimeToFirstFrameReported=!1}setIsRendering(e){this.currentIsRendering!==e&&(this.currentIsRendering=e,this.captureIsRenderingEvent(e))}updateStatsOverlay(e){this.overlayStats.setStats(e)}updateIsRenderingTracker(e){this.isRenderingTracker?.updateRenderingTracker(e)}subscribeVideoAsync(e,t){return this.timeToFirstFrameSinceSubscriptionStart=Date.now(),new Promise(((i,n)=>{this.modality=t?tt.MODALITY.sharing:tt.MODALITY.video,this.diagnostics&&(this.diagnostics.msi=e,this.diagnostics.modality=this.modality),this.trackElementSizeChange(),this.unsubscribe(),this.sessionDiagnostics&&this.modality===tt.MODALITY.video&&(this.on("onVideoSizeChanged",((t,i)=>{if(this.sessionDiagnostics.registerResolutionChanageEvent({ts:Date.now(),msi:e,res:{width:t,height:i}}),!this.isTimeToFirstFrameReported){if(-1===this.timeToFirstFrame){const e=Date.now();this.timeToFirstFrame=e-this.startTimeTTFF,this.timeToFirstFrameSinceSubscriptionStart=Date.now()-this.timeToFirstFrameSinceSubscriptionStart}const e=this.getTrackId();e&&(this.diagnostics.timeToFirstFrameSinceSubscriptionStart=this.timeToFirstFrameSinceSubscriptionStart,this.diagnostics.timeToFirstFrame=this.timeToFirstFrame,this.sizeTracker?.triggerVideoElementSizeChange(),this.event("onVideoStarted").raise(this.timeToFirstFrame,this.timeToFirstFrameSinceSubscriptionStart,e),this.isTimeToFirstFrameReported=!0)}})),this.on("onVideoRendererStateChanged",(e=>{this.diagnostics.addStateChange(e)})));const r=this.subscriptionManager.subscribeVideo(this.modality,e);this.subscription=r,this.logger.safe.info(`subscribing renderer to type: ${r.modality} msi: ${r.msi}`),r.setOnMediaStreamChangedHandler((e=>{const t=this.getMediaStream();this.attachMediaStream(e),e&&(this.startTimeTTFF=Date.now());const n=this.getTrackId();n&&this.diagnostics&&(this.diagnostics.trackId=n),this.logger.safe.info(`subscribed renderer to type: ${r.modality} msi: ${r.msi} on stream #${e?e.id:"none"}`),e&&t!==e&&this.sizeTracker?.triggerVideoElementSizeChange(),i()})),r.setOnErrorHandler((t=>{this.logger.safe.error(`failed to subscribe renderer ${Ge(t)}`),"webRtcSession cleanup"===JSON.stringify(t)&&(this.logger.safe.info(`Retry to subscribe to video stream with msi: ${e}. Previous session was cleaned up`),this.subscriptionManager.streamChangedByMsi(e),i()),n(t)}))}))}dispose(){this.disposed?this.logger.safe.warn("renderer already disposed"):(this.disposed=!0,this.logger.safe.info("disposing"),this.unsubscribe(),this.captureIsRenderingEvent(!1),this.freezeTracker?.dispose(),this.isRenderingChangedSubscription?.dispose(),this.overlayStats.dispose(),this.diagnostics?.dispose(),this.event("onRendererDisposed").raise(this),super.dispose())}getModality(){return this.modality}getMsi(){return this.subscription?.msi??yO.SourceNone}getLocalMsi(){return this.subscription?.localMsi}getCurrentResolution(){return this.resolution??{width:0,height:0}}unsubscribeNow(){this.subscription?.unsubscribe(),this.subscription=null}trackElementSizeChange(){const e=this.modality===tt.MODALITY.sharing,t=e?this.configProvider.config.webrtcScreensharingCapabilityCheckIntervalMin:this.configProvider.config.webrtcVideoCapabilityCheckIntervalMin,i=e?this.configProvider.config.webrtcScreensharingCapabilityCheckIntervalMax:this.configProvider.config.webrtcVideoCapabilityCheckIntervalMax;t&&i?(this.sizeTracker=new LI(this.getVideoElement(),t,i,this.configProvider.config.enableDevicePixelRatio),this.sizeTracker.changed((()=>this.onSizeTrackerChanged()))):this.logger.safe.info("skipping video size tracking")}onSizeTrackerChanged(){this.resolution={width:this.sizeTracker.width,height:this.sizeTracker.height},this.logger.safe.info(`video renderer size changed to ${this.resolution.width}x${this.resolution.height}`),this.diagnostics&&(this.diagnostics.rendererSize=this.resolution),this.event("onRendererSizeChanged").raise(this,this.resolution)}unsubscribe(){this.subscription?.dispose(),this.subscription=null}captureIsRenderingEvent(e){this.diagnostics&&(this.diagnostics.isRendering=e),this.event("onIsRenderingChanged").raise(e,this.getModality(),this.getTrackId())}},uN=class{constructor(e,t,i,n,r,s){this.logger=e,this.configProvider=t,this.statsGatherer=i,this.sessionDiagnostics=n,this.remoteVideoResolutionManager=r,this.domOverrides=s,this.remoteRendererSubscriptions=new Map,this.diagnostics=n?.newRemoteVideoManagerDiagnostics()}createRenderer(e,t,i){const n=new hN((i??this.logger).createChild("videorenderer"),this.configProvider,this.diagnostics?.newRendererDiagnostics(),t,e,this.sessionDiagnostics);return this.domOverrides.onMediaElementAdded&&this.domOverrides.onMediaElementAdded(n.getVideoElement()),this.addRenderer(n),n}moveRenderers(e){this.renderers.forEach((t=>{t.resetTimeToFirstFrameFlag(),e.addRenderer(t),this.removeRenderer(t)}))}getMaxAllowedVideoFS(){return this.remoteVideoResolutionManager.getMaxAllowedVideoFS()}dispose(){this.renderers.forEach((e=>e.resetTimeToFirstFrameFlag())),this.renderers.forEach((e=>{const t=e.getTrackId(),i=e.getEndOfTheFreeze();this.statsGatherer.setFreezeDuration(i,t)})),this.remoteRendererSubscriptions.forEach(((e,t)=>{t.dispose(),e.forEach((e=>e.dispose()))})),this.remoteRendererSubscriptions.clear(),this.remoteVideoResolutionManager.clearRenderers()}processStatsReport(e){this.configProvider.config.isRenderingBasedOnRawStatistics&&this.onDiagnosticUpdated(e),this.updateOverlayStats(e)}processLegacyStats(e){this.configProvider.config.isRenderingBasedOnRawStatistics||this.renderers.forEach((t=>{const i=t.getTrackId();if(e.remoteVideoStreams[i]){const n=e.remoteVideoStreams[i].isRendering;void 0!==n&&t.setIsRendering(n)}}))}get renderers(){return Array.from(this.remoteRendererSubscriptions,(([e])=>e))}addRenderer(e){this.remoteRendererSubscriptions.set(e,this.subscribeOnEvents(e)),this.logger.safe.info("Added renderer to manager"),this.remoteVideoResolutionManager.addRenderer(e)}generateVideoRecvStats(e){const t=new Map,i=e=>{e?.forEach((e=>{const i=e.track?.trackIdentifier??e.inboundRTP.trackIdentifier;t.set(i,e)}))};return i(e.sharing?.recv),i(e.video?.recv),t}updateOverlayStats(e){const t=this.generateVideoRecvStats(e);this.renderers.forEach((e=>{const i=e.getTrackId();t.has(i)&&e.updateStatsOverlay(t.get(i))}))}onDiagnosticUpdated(e){const t=[...e.video?.recv??[],...e.sharing?.recv??[]];if(t.length){const e=new Map;t.forEach((t=>{e.set(t.track?.trackIdentifier,t)})),this.renderers.forEach((t=>{const i=t.getTrackId();e.has(i)&&t.updateIsRenderingTracker(e.get(i))}))}}subscribeOnEvents(e){return[e.on("onRendererDisposed",(e=>this.onRendererDisposed(e))),e.on("onVideoStarted",((e,t,i)=>this.onVideoStarted(e,t,i))),e.on("onFreezeEnded",(t=>{const i=e.getTrackId();this.statsGatherer.setFreezeDuration(t,i)})),e.on("onIsRenderingChanged",((e,t,i)=>this.statsGatherer.setIsRendering(e,t,i)))]}onRendererDisposed(e){this.logger.safe.debug("Renderer removed from manager"),this.removeRenderer(e),this.domOverrides.onMediaElementRemoved&&this.domOverrides.onMediaElementRemoved(e.getVideoElement())}removeRenderer(e){this.remoteRendererSubscriptions.get(e).forEach((e=>e.dispose())),this.remoteRendererSubscriptions.delete(e),this.remoteVideoResolutionManager.removeRenderer(e)}onVideoStarted(e,t,i){this.statsGatherer.setTimeToFirstFrame(e,t,i)}},pN=class extends Qe{constructor(e,t,i){super(),this.configProvider=t,this.callDeviceManager=i,this.lastFramerateInput=-1,this.trackInfo=[],this.timeoutId=null,this.logger=e.createChild("localStreamWatcher"),this.callDeviceManagerSub=i.on("onSelectedVirtualDevicesChanged",(()=>{this.logger.info("VirtualDevice changed, updating subscriptions"),this.handleDeviceManagerChange()}))}get effectsManager(){return this.callDeviceManager.getDeviceManager("Video").effectsManager}startWatching(e){this.configProvider.config.videoCaptureFreezeTimeout&&(this.trackInfo=e,this.videoEffectManagerSubscription||(this.videoEffectManagerSubscription=this.effectsManager.on("videoFreezeDetected",(e=>this.onVideoFreezeDetected(e)))))}stopWatching(){this.trackInfo=[],this.videoEffectManagerSubscription?.dispose(),this.videoEffectManagerSubscription=null,0!==this.lastFramerateInput||this.timeoutId||this.event("onVideoCaptureFreeze").raise(!1,!this.effectsManager.isEffectEnabled("Video")),this.disposeTimer(),this.lastFramerateInput=-1}dispose(e){this.callDeviceManagerSub?.dispose(),super.dispose(e),this.stopWatching()}onDiagnosticUpdated(e){if(!this.trackInfo.length||!e.video?.send?.length)return;const t=e.video?.send[0];let i,n=0;[t,...t.altLayouts??[]].forEach((e=>{const t=e.mediaSource,r=t?.framesPerSecond??0;this.trackInfo.some((e=>e.trackId===t.trackIdentifier))&&(!i||n<r)&&(i=t,n=r)})),i?n!==this.lastFramerateInput&&(0===n?this.scheduleCaptureFreezeStart(i.trackIdentifier,!this.effectsManager.isEffectEnabled("Video")):0===this.lastFramerateInput&&(this.timeoutId?this.disposeTimer():(this.logger.info(`onVideoCaptureFreeze end for trackId: ${i.trackIdentifier}`),this.event("onVideoCaptureFreeze").raise(!1,!this.effectsManager.isEffectEnabled("Video")))),this.lastFramerateInput=n):this.logger.safe.warn("WebRTC Stats for send video not found")}onStatisticsChanged(e){if(!this.trackInfo.length)return;let t;Object.keys(e.localVideoStreams).forEach((i=>{const n=e.localVideoStreams[i];this.trackInfo.some((e=>e.trackId===n.trackId))&&(!t||t.frameRateInput<n.frameRateInput)&&(t=n)})),t?t.frameRateInput!==this.lastFramerateInput&&(0===t.frameRateInput?this.scheduleCaptureFreezeStart(t.trackId,!this.effectsManager.isEffectEnabled("Video")):0===this.lastFramerateInput&&(this.timeoutId?this.disposeTimer():(this.logger.info(`onVideoCaptureFreeze end for trackId: ${t.trackId}`),this.event("onVideoCaptureFreeze").raise(!1,!this.effectsManager.isEffectEnabled("Video")))),this.lastFramerateInput=t.frameRateInput):this.logger.safe.warn("WebRTC Stats for send video not found")}onVideoFreezeDetected(e){this.logger.info(`onVideoCaptureFreeze, webcam freeze detected trackId: ${e}`),this.event("onVideoCaptureFreeze").raise(!1,!0)}scheduleCaptureFreezeStart(e,t){this.timeoutId=window.setTimeout((()=>{this.timeoutId=null,this.logger.info(`onVideoCaptureFreeze start for trackId: ${e}`),this.event("onVideoCaptureFreeze").raise(!0,t)}),this.configProvider.config.videoCaptureFreezeTimeout)}disposeTimer(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)}handleDeviceManagerChange(){this.videoEffectManagerSubscription?.dispose(),this.videoEffectManagerSubscription=this.effectsManager.on("videoFreezeDetected",(e=>this.onVideoFreezeDetected(e)))}},gN=class{constructor(e,t,i,n,r,s,a){this.mediaStream=e,this.receiver=t,this.modality=i,this.sourceStreamId=n,this.controller=r,this.videoCapabilties=s,this.getMaxAllowedVideoFS=a,this.msi=yO.SourceNone,this.operations=Promise.resolve()}dispose(){this.receiver=null,this.mediaStream=null}getId(){return this.mediaStream.id}getModality(){return this.modality}getMsi(){return this.msi}getMediaStream(){return this.mediaStream}getReceiver(){return this.receiver}getSourceStreamId(){return this.sourceStreamId}requestSource(e){this.msi=e;const t=this.operations.then((()=>{let t;return this.videoCapabilties&&(this.videoCapabilties.resetToInitial(),this.getMaxAllowedVideoFS&&this.videoCapabilties.setMaxFS(Math.min(this.getMaxAllowedVideoFS(),this.videoCapabilties.getMaxFS())),t=this.videoCapabilties.buildFmtp(),this.videoCapabilties.resetToInitial()),this.controller.requestSource(this.mediaStream.id,e,t)}));return this.operations=t.catch((()=>{})),t}},mN=class{constructor(e){this.queue=[],this.logger=e}cleanup(){this.queue.forEach((e=>{e.reject({notSent:e.tones})})),this.queue=[]}waitForNotification(e){return e?(this.logger.unsafe.info("sending dtmf tones: ",e),new Promise(((t,i)=>{this.queue.push({tones:e,resolve:t,reject:i})}))):Promise.reject(new Error("invalid input"))}toneSent(e){this.queue[0]&&(e===this.queue[0].tones[0]?(this.queue[0].tones=this.queue[0].tones.substr(1),""===this.queue[0].tones&&(this.queue[0].resolve(),this.queue.shift())):(this.queue[0].reject(new Error(`sent tone does not match: expected '${this.queue[0].tones[0]}' got '${e}'`)),this.queue.shift(),this.toneSent(e)))}},fN=class{constructor(e){this.webRtcSender=null,this.configProvider=e.configProvider,this.queue=new mN(e.logger)}sendDtmf(e,t){return e&&e.getSenders?(this.syncSender(e),this.webRtcSender?(this.webRtcSender.ontonechange=this.onToneChange.bind(this),this.webRtcSender.insertDTMF(this.webRtcSender.toneBuffer+t,this.configProvider.config.dtmf.toneDuration,this.configProvider.config.dtmf.toneGap),this.queue.waitForNotification(t)):Promise.reject(new Error("not available"))):Promise.reject(new Error("bad peerConnection"))}canSendDtmf(e){return!(!e||!e.getSenders)&&(this.syncSender(e),!!this.webRtcSender&&this.webRtcSender.canInsertDTMF)}dispose(){this.queue.cleanup()}syncSender(e){const t=e.getSenders().filter((e=>e.track&&"audio"===e.track.kind)).filter((e=>e.dtmf&&e.dtmf.canInsertDTMF))[0];this.webRtcSender&&t&&t.dtmf!==this.webRtcSender&&(this.webRtcSender.ontonechange=null,this.queue.cleanup()),this.webRtcSender=t?t.dtmf:null}onToneChange(e){e.tone&&this.queue.toneSent(e.tone)}},SN={build:e=>new fN(e)},vN=0,yN=class e{constructor(e,t,i){this.context=e,this.callId=t,this.callback=i,this.callbacks={},this.multiParty=this.context.config?.isConference,this.configProvider=this.context.configProvider,this.logger=this.context.getLogger().createChild("webrtc-"+ ++vN),this.deviceManager=this.context.callDeviceManager.getDefaultDeviceManager(),this.webrtcAdapter=Wk.build({global:this.context.maContext,configProvider:this.configProvider}),this.iceHostCandidateOnly=this.multiParty&&Ct("iceHostCandidateOnly",this.context.config,this.configProvider.config),this.mediaManager=new Xk({logger:this.logger,configProvider:this.configProvider,numVideoChannels:this.multiParty&&this.configProvider.config.numVideoChannelsGvc||1,useSimulcast:!1}),this.sessionDescription=nM.build({sdpTransform:new this.webrtcAdapter.SdpTransform(this.context),mediaManager:this.mediaManager,logger:this.logger,configProvider:this.configProvider,configuration:this.getStreamTransformConfiguration()}),this.allowedMediaContentType=Ct("webrtcAllowedMediaContentType",this.context.config,this.configProvider.config).concat(),this.receiveStreamCollection=new CO({streamAdded:e=>this.streamAdded(e),streamRemoved:e=>this.streamRemoved(e)}),this.stats=new Tk(this.logger.createChild("stats"),this.configProvider,void 0,this.mediaManager,this.multiParty),this.maxResolution=this.multiParty?NI.Send.getResolutionByFs(this.configProvider.config.webrtcMultipartyMaxScalingFs):NI.Send.getResolutionByFs(this.configProvider.config.webrtcMaxScalingFs),this.qualityManager=new oN(this.logger.createChild("qm"),{scalingEnabled:this.configProvider.config.webrtcVideoScaling,cooldownTimeout:this.configProvider.config.webrtcResolutionManagerCooldownTimeout,retryDelay:this.configProvider.config.webrtcResolutionManagerRetryDelay,maxResolution:this.maxResolution,customBwEstimationEnabled:!0,sendBandwidthNotificationsEnabled:this.multiParty&&this.configProvider.config.webrtcSendBandwidthNotificationsEnabled},{onReceiveCapabilitiesChanged:(e,t,i)=>this.applyCapabilitiesForModality(e,t,i),onSendBandwidthChanged:e=>this.onSendBandwidthChanged(e)},this.stats,void 0,this.configProvider),this.localVideoStreamWatcher=new pN(this.logger,this.configProvider,this.context.callDeviceManager),this.activeSpeakerManager=new fO(this.callback.onContributingSourcesChanged,this.callback.onDominantSpeakerChanged,null,this.logger.createChild("ActiveSpeakerManager")),this.senders={},this.negotiationQueue=new _I(this.logger),this.negotiationEmulator=new eN(this.logger.createChild("negotiationEmulator"),this.webrtcAdapter.RTCSessionDescription,this.sessionDescription,this.negotiationQueue,this.mediaManager),this.extensionsManager=this.setupExtensionsManager(),this.toBeCalledAfterConnected=[],this.iceTransportPolicy=this.configProvider.config.iceTransportPolicyForced||this.context.config.iceTransportPolicy||tt.ICE_TRANSPORT_POLICY.all,this.isMuteHold=!1,this.peerConnection=null,this.mediaStreams=new Map,this.doAudioMute=this.context.config.muted,this.iceCandidatesDeferred=new Mu,this.relayCandidateGathered=!1,this.iceCandidatesTimer=null,this.triggerRenegotiationFlag=!1,this.canTriggerRenegotiation=!0,this.noIceCandidates=!1,this.noRelayIceCandidates=!1,this.forceMediaStreamUpdate=!1,this.negotiatedModalities={},this.disabledModalities={},this.iceDisconnectedTimer=null,this.statisticsReport=Promise.resolve({}),this.terminated=!1,this.initiator=!1,this.streamsChangedListener=null,this.dtmfSender=SN.build({logger:this.logger,configProvider:this.configProvider}),this.mediaContentType=Ct("webrtcMediaContentType",this.context.config,this.configProvider.config),this.streamsChangedNotificationScheduled=!1,this.subscriptionManager=new _O(this.logger.createChild("subs"),this.configProvider,{getStreams:()=>this.getStreams(),setOnStreamsChangedHandler:e=>this.onStreamsChanged(e)}),this.remoteVideoResolutionManager=new lN(this.logger.createChild("rvrm"),this.multiParty,this.configProvider,this.mediaManager,this.stats),this.remoteVideoManager=new uN(this.logger.createChild("RemoteVideoManager"),this.configProvider,this.stats,void 0,this.remoteVideoResolutionManager,this.context.maContext.domOverrides),this.hwSilent=!1,this.configuredModalitiesPromise=Promise.resolve(),this.negotiationCompletedPromise=new Mu,this.ssrcGenerator=new vO,this.ssrcs={Audio:this.getSsrcRangeForMediaType("Audio"),Video:this.getSsrcRangeForMediaType("Video"),ScreenShare:this.getSsrcRangeForMediaType("ScreenShare")},this.forceKeyFramePromise=null,this.ufdManager=e.getUfdManager(),this.stats.on("onStatisticsChanged",(e=>{this.remoteVideoManager.processLegacyStats(e),this.localVideoStreamWatcher?.onStatisticsChanged(e),this.updateQualityLevels(e)})),this.negotiationCompletedPromise.promise.catch((()=>{})),this.negotiationCompletedPromise.reject("placeholder"),this.remoteVideoResolutionManager.on("onNegotiationRequired",(()=>this.triggerRenegotiation(!0))),this.remoteVideoResolutionManager.on("onSourceRequestRequired",((e,t,i)=>this.requestSource(e,t,i))),this.setSubsForSubscriptionManager(),this.localVideoStreamWatcher.on("onVideoCaptureFreeze",(e=>{this.isConnected()&&this.ufdManager.signalEvent("VideoCaptureDeviceFreeze",e?"Bad":"Good","Video")})),this.configProvider.mediaConfig.maxBandwidthInKbps&&this.stats.setMaxSessionBandwidth(this.configProvider.mediaConfig.maxBandwidthInKbps),this.createAudioRenderer(),this.configProvider.config.webrtcVideoScaling&&this.onOptimalVideoReceiversCountChanged(this.configProvider.config.nonEstimatedDefaultVideoReceiversCount)}get audioStream(){return this.mediaStreams.get("Audio")}get videoStream(){return this.mediaStreams.get("Video")}get displayStream(){return this.mediaStreams.get("ScreenShare")}useNullAudioStreamClient(){}getIncomingRawAudioStream(){return null}configureSpatialAudio(e,t){}setParticipantSpatialAudioPositions(e,t){}getAcceptedTypes(){return this.allowedMediaContentType}clone(t=!1){const i=ht(this.context);i.config=ht(this.context.config),i.config.webrtcMediaContentType=this.mediaContentType,i.config.webrtcAllowedMediaContentType=this.allowedMediaContentType,t?i.config.isConference=!0:(i.config.iceHostCandidateOnly=!1,this.configProvider.config.waitForRelayOnReconnect&&(i.config.webrtcIceGatheringTimeoutIncreased=!0));const n=new e(i,this.callId,this.callback);return this.relayManagerProvider&&(n.relayManagerProvider=this.relayManagerProvider),n.callbacks.onNegotiationRequired=this.callbacks.onNegotiationRequired,n}setInternals(e){if(e.extensionsManager&&this.extensionsManager){const t=e.extensionsManager.getExtension("videoStreamControl");t&&t.getOptions()&&this.extensionsManager.configureExtension("videoStreamControl",t.getOptions())}e.subscriptionManager&&(this.subscriptionManager&&this.subscriptionManager.dispose(),this.subscriptionManager=e.subscriptionManager,this.subscriptionManager.setStreamProvider({getStreams:()=>this.getStreams(),setOnStreamsChangedHandler:e=>this.onStreamsChanged(e)}),this.setSubsForSubscriptionManager(),this.subscriptionManager.reriseSubscribeEvents(),this.notifyStreamsChanged()),e.audioRenderer&&(e.audioRenderer.play(this.audioRenderer.getStream()),this.audioRenderer=e.audioRenderer),e.remoteVideoManager&&e.remoteVideoManager.moveRenderers(this.remoteVideoManager)}setSubsForSubscriptionManager(){this.subscriptionManagerSubs=[this.subscriptionManager.on("onTrackIdsChanged",(e=>this.stats.setSubscribedTrackIds(e))),this.subscriptionManager.on("onTrackSsrcChanged",(e=>this.stats.setSubscribedTrackSsrc(e))),this.subscriptionManager.on("onSubscriptionChanged",((e,t,i,n,r,s)=>this.stats.addSubscriptionEvent(e,t,i,n,null,r,s))),this.subscriptionManager.on("onSubscriptionFailed",((e,t,i,n,r)=>this.stats.addSubscriptionEvent(e,t,i,n,r)))]}move(e,t){e.setInternals({subscriptionManager:this.subscriptionManager,extensionsManager:this.extensionsManager,audioRenderer:this.audioRenderer,remoteVideoManager:this.remoteVideoManager}),e.muteHold(this.isMuteHold,t),this.doAudioMute?e.muteInputAsync(t):e.unmuteInputAsync(t),this.subscriptionManager=null,this.audioRenderer=null,this.callbacks.onTerminated=null}setMute(e,t,i){this.logger.safe.info(`[${i}] call setMuteAsync with mute state ${t}, audio stream exists: ${!!this.audioStream}`),"Audio"===e&&this.audioStream?this.audioStream.setMuted(t,i):"Video"===e&&this.videoStream?this.videoStream.setMuted(t,i):"ScreenShare"===e&&this.displayStream&&this.displayStream.setMuted(t,i),this.updateQualityLevels(this.stats.getLastStatistics())}setCallConstraints(e,t){return Promise.reject(new Error("Not supported"))}configureModalitiesAsync(e,t){const i=this.configuredModalitiesPromise.then((()=>{if(!e||!e.audio&&!e.video&&!e.sharing)throw new Error(`Invalid parameters! ${JSON.stringify(e)}`);const i=!this.configuredModalities||!Ng(e,this.negotiatedModalities);return this.configuredModalities=e,this.logger.safe.info(`[${t}] configure modalities`,`audio: ${e.audio}`,`video: ${e.video}`,`sharing: ${e.sharing}`,`peerconnection: ${!!this.peerConnection}`,`pc.signalingState: ${this.peerConnection?this.peerConnection.signalingState:"-"}`,`needNewRenegotiation: ${i}`),i&&this.triggerRenegotiation(!1,t),this.configuredModalities}));return this.configuredModalitiesPromise=i.catch((e=>{this.logger.safe.warn(`[${t}] Error during configuring modalities: ${Ge(e)}`)})).then((()=>{})),i.then((()=>{}))}getConfiguredModalities(){return this.configuredModalities}getDisabledModalities(){return this.disabledModalities}getSubscriptionManager(){return null}createAudioElement(e){}createOfferAsync(e){const t=this.negotiationQueue.add((()=>new Promise((t=>{this.logger.safe.info(`[${e}] create [offer] configured: ${JSON.stringify(this.configuredModalities)}`),this.initiator=!0,this.throwIfModalitiesNotConfigured("no configured modalities to create offer for"),this.canTriggerRenegotiation=!1,this.negotiatingModalities=this.configuredModalities,this.offeredModalities=this.negotiatingModalities,this.configProvider.config.webrtcNegotiateDisabledDataModality&&!this.offeredModalities[tt.MODALITY.data]&&this.multiParty&&(this.offeredModalities[tt.MODALITY.data]=tt.MEDIA_STATE.inactive),Mg(this.offeredModalities)&&!dt(this.negotiatedModalities)&&Object.keys(this.offeredModalities).forEach((e=>{void 0===this.negotiatedModalities[e]&&delete this.offeredModalities[e]})),t(this.updatePeerConnectionStreamsAsync(this.offeredModalities,!0,!0,e).then((()=>{const t=this.createNegotiationConstraints(this.offeredModalities);return this.logger.safe.info(`[${e}] create [offer] offered: ${JSON.stringify(this.offeredModalities)} constraints: ${JSON.stringify(t)}`),this.peerConnection.createOffer(t)})).then((t=>{this.logger.unsafe.debug(`[${e}] create [offer] offer from peer connection`,"sdp:",t.sdp);const i=this.sessionDescription.createLocalOffer(t.sdp);this.hasIceCandidates(i)||this.resetCandidateGathering(e),this.stats.startWaitingForStreamStart(this.offeredModalities);const n=new this.webrtcAdapter.RTCSessionDescription({sdp:i.toLocal(),type:"offer"});return this.setupIceGatheringTimeout(e),Promise.all([this.peerConnection.setLocalDescription(n),this.iceCandidatesDeferred.promise])})).then((()=>{const t=this.sessionDescription.createLocalOffer(this.peerConnection.localDescription.sdp);t.updateModalities(this.offeredModalities),this.checkIceCandidates(t);const i=t.toOffer();this.logger.unsafe.debug("CREATE OFFER","sdp:",i);const n={blob:i,contentType:this.mediaContentType};return""===this.configProvider.config.webrtcRequiredFeatures||this.multiParty||(n.requiredFeatures=this.configProvider.config.webrtcRequiredFeatures),this.configProvider.countryCode&&(n.clientLocation=this.configProvider.countryCode),this.doRetargetIfNeeded(n,t,e),n})))}))),e);return this.resetNegotiationQueue(e),t}processOfferAsync(e,t){const i=this.negotiationQueue.add((()=>new Promise((i=>{const n=e.blob;if(this.logger.unsafe.debug(`[${t}] process [offer]`,"sdp:",n),this.configProvider.config.webrtcCompareContentTypeInOffer&&(ft(e.contentType,this.allowedMediaContentType),this.mediaContentType=e.contentType),e.requiredFeatures){const t=this.configProvider.config.webrtcRejectedFeatures.split(",");St(e.requiredFeatures.split(","),t)}this.initiator=!1,this.offeredDescription=this.sessionDescription.createRemoteOffer(n),this.canTriggerRenegotiation=!1,this.offeredModalities=Pg(this.offeredDescription.getModalities()),this.peerConnection||(this.context.configProvider.mediaConfig.isTransportUnbundled?this.context.configProvider.mediaConfig.isTransportUnbundled=this.offeredDescription.couldBeUnbundled():this.context.configProvider.mediaConfig.isTransportUnbundled=this.offeredDescription.isUnbundled());let r=Promise.resolve(this.offeredModalities);if(Ag(this.offeredModalities.video)||Rg(this.offeredModalities.video)||Ag(this.offeredModalities.sharing)||Rg(this.offeredModalities.sharing)){const e=this.offeredDescription.getVideoCodecs();r=this.webrtcAdapter.RTCRtpReceiver.getCapabilities("video").then((i=>{if(!i.codecs.some((t=>e.some((e=>t.mimeType===e))))){this.logger.safe.warn(`[${t}] offer doesn't contain any supported video codecs`);const e=ht(this.offeredModalities);return this.disabledModalities.video=e.video,this.disabledModalities.sharing=e.sharing,e.video=void 0,e.sharing=void 0,e}return this.offeredModalities})).catch((e=>(this.logger.safe.error(`[${t}] failed to get video capability ${Ge(e)}`),this.offeredModalities)))}i(r.then((e=>(this.logger.safe.info(`[${t}] process [offer] offered: ${JSON.stringify(this.offeredModalities)} acceptable: ${JSON.stringify(e)}`),e))))}))),t);return this.resetNegotiationQueue(t),i}createAnswerAsync(e,t){return new Promise((i=>{if(e)return void i({blob:"",contentType:this.mediaContentType});this.logger.safe.info(`[${t}] create [answer] offered: ${JSON.stringify(this.offeredModalities)} configured: ${JSON.stringify(this.configuredModalities)}`),this.throwIfModalitiesNotConfigured("no configured modalities to create answer for"),this.negotiatingModalities=this.configuredModalities;let n=Og(this.offeredModalities,this.negotiatingModalities);const r=this.offeredDescription.clone();i(this.updatePeerConnectionStreamsAsync(n,!0,!1,t).then((()=>this.handleCodecSwitchUnsupported(t))).then((()=>{const e=this.offeredDescription.toRemote(n);this.mediaManager.updateMediaEntitiesWithLocalTracks(),this.registerMediaSources();const i=new this.webrtcAdapter.RTCSessionDescription({sdp:e,type:"offer"});return this.updateDescriptor(i,r),this.logger.unsafe.info(`[${t}] create [answer] set remote description`,"negotiated:",n,"sdp:",i.sdp),this.peerConnection.setRemoteDescription(i)})).then((()=>(this.callbacks.onTransportInitialized&&this.callbacks.onTransportInitialized(),this.updatePeerConnectionStreamsAsync(n,!1,!0,t)))).then((()=>(this.handleSharingRecvCapabilities(r),this.handleVideoRecvCapabilities(r)))).then((()=>this.peerConnection.createAnswer())).then((e=>{this.logger.unsafe.debug(`[${t}] create [answer] answer from peer connection`,"sdp:",e.sdp);const i=this.sessionDescription.createLocalAnswer(e.sdp);this.hasIceCandidates(i)||this.resetCandidateGathering(t),this.stats.startWaitingForStreamStart(n);const r=new this.webrtcAdapter.RTCSessionDescription({sdp:i.toLocal(),type:"answer"});return this.setupIceGatheringTimeout(t),Promise.all([this.peerConnection.setLocalDescription(r),this.iceCandidatesDeferred.promise])})).then((()=>{const e=this.sessionDescription.createLocalAnswer(this.peerConnection.localDescription.sdp);e.updateModalities(n),this.checkIceCandidates(e);const i=e.toAnswer();n=e.getModalities(),kg(this.configuredModalities,this.negotiatingModalities,n)||this.triggerRenegotiation(!0,t),this.setNegotiatedModalities(n),this.stats.sessionInfo.setBweType(e.getBweType()),this.logger.unsafe.debug("CREATE ANSWER","sdp:",i);const r={blob:i,contentType:this.mediaContentType};return this.configProvider.countryCode&&(r.clientLocation=this.configProvider.countryCode),r})))}))}processAnswerAsync(e,t,i){const n=e.blob;if(this.logger.unsafe.debug(i?"PROCESS PRANSWER":"PROCESS ANSWER","sdp:",n),i)return this.logger.safe.info(`[${t}] process [pranswer] ignored`),Promise.resolve();this.mediaContentType=e.contentType,-1===this.allowedMediaContentType.indexOf(this.mediaContentType)&&this.allowedMediaContentType.push(this.mediaContentType);const r=this.sessionDescription.createRemoteAnswer(n),s=r.clone(),a=Pg(r.getModalities());this.setNegotiatedModalities(a);const o=r.toRemote(this.negotiatedModalities);this.mediaManager.updateMediaEntitiesWithLocalTracks(),this.registerMediaSources(),this.stats.sessionInfo.setBweType(r.getBweType());const l=new this.webrtcAdapter.RTCSessionDescription({sdp:o,type:"answer"});return this.updateDescriptor(l,s),this.logger.unsafe.info(`[${t}] process [answer] set remote description`,"negotiated:",this.negotiatedModalities,"sdp:",l.sdp),this.peerConnection.setRemoteDescription(l).then((()=>(this.callbacks.onTransportInitialized&&this.callbacks.onTransportInitialized(),this.negotiatedModalities))).then((()=>(this.handleSharingRecvCapabilities(s),this.handleVideoRecvCapabilities(s)))).then((e=>{e&&this.triggerRenegotiation(!0,t)}))}completeNegotiationAsync(e){return new Promise((t=>{this.mediaManager.commit();const i=this.configuredModalities,n=this.forceMediaStreamUpdate&&!Mg(this.negotiatedModalities)||!kg(i,this.negotiatingModalities,this.negotiatedModalities)||this.triggerRenegotiationFlag,r=!n;this.canTriggerRenegotiation=!0,this.logger.safe.info(`[${e}] negotiation completed isComplete: ${r} configured: ${JSON.stringify(this.configuredModalities)} negotiating: ${JSON.stringify(this.negotiatingModalities)} offered: ${JSON.stringify(this.offeredModalities)} negotiated: ${JSON.stringify(this.negotiatedModalities)}`),n&&this.triggerRenegotiation(!1,e),this.negotiationCompletedPromise.resolve(),t({isComplete:r,activeModalities:this.negotiatedModalities,offeredModalities:this.offeredModalities,attemptedModalities:this.negotiatingModalities,configuredModalities:this.configuredModalities,initiator:this.initiator})}))}rejectNegotiationAsync(e,t,i=!1){return Promise.resolve().then((()=>{if(this.mediaManager.rollback(),this.logger.safe.warn(`[${t}] negotiation rejected isComplete: ${!i} error: ${Ge(e)} configured: ${JSON.stringify(this.configuredModalities)} negotiating: ${JSON.stringify(this.negotiatingModalities)} offered: ${JSON.stringify(this.offeredModalities)} negotiated: ${JSON.stringify(this.negotiatedModalities)}`),this.peerConnection){if("have-local-offer"===this.peerConnection.signalingState)return this.logger.safe.info(`[${t}] rolling back local description`),this.configProvider.config.webrtcHandleRollback?(this.logger.safe.info(`[${t}] rolling back using local renegotiation`),this.negotiationEmulator.renegotiateNow().then((()=>{this.logger.safe.info(`[${t}] rolling back using local complete`)}))):this.peerConnection.setLocalDescription(new this.webrtcAdapter.RTCSessionDescription({type:"rollback"}));this.logger.safe.error(`[${t}] cannot rollback local description in currrent state: ${this.peerConnection.signalingState}`)}})).then((()=>{this.canTriggerRenegotiation=!0,this.negotiationCompletedPromise.reject("negotiation rejected"),this.getAddedMediaTypes(this.negotiatedModalities,this.negotiatingModalities).forEach((e=>{this.removeTrackByMediaType(e),this.disposeStreamByMediaType(e)})),this.registerLocalStreams()})).then((()=>(i&&(this.logger.safe.info(`[${t}] retrying failed negotiation`),this.triggerRenegotiation(!1,t)),{isComplete:!i,activeModalities:this.negotiatedModalities,offeredModalities:this.offeredModalities,attemptedModalities:this.negotiatingModalities,configuredModalities:this.configuredModalities,initiator:this.initiator})))}startMediaDescriptionsUpdateAsync(e){return Promise.reject(new Error("Not supported"))}completeMediaDescriptionsUpdateAsync(e){return Promise.reject(new Error("Not supported"))}rejectMediaDescriptionsUpdateAsync(e,t){return Promise.reject(new Error("Not supported"))}createRemoteRenderer(e){return this.remoteVideoManager.createRenderer(e,this.subscriptionManager,this.logger)}getStatsAsync(e){return this.terminated||(this.statisticsReport=this.statisticsReport.then((()=>this.stats.getReport(e))).catch((e=>(this.logger.safe.error(`getting statistics should never fail: ${e.error}`),e.partialReport)))),this.statisticsReport}getLastKnownStats(e=!1){return this.stats.getReport(!1,e)}muteHold(e,t){this.isMuteHold=e;const i=[tt.MODALITY.audio,tt.MODALITY.video,tt.MODALITY.sharing].filter((e=>Ag(this.negotiatedModalities[e])&&(e!==tt.MODALITY.audio||!this.doAudioMute)));for(const n of i)this.setMute($g(n),e,t)}async muteInputAsync(e){this.doAudioMute=!0,this.setMute("Audio",!0,e)}async unmuteInputAsync(e){this.doAudioMute=!1,this.setMute("Audio",!1,e)}muteOutputAsync(e){return this.audioRenderer.setMuted(!0,e),Promise.resolve()}unmuteOutputAsync(e){return this.audioRenderer.setMuted(!1,e),Promise.resolve()}sendDtmf(e){return this.dtmfSender.sendDtmf(this.peerConnection,e)}canSendDtmf(){return this.dtmfSender.canSendDtmf(this.peerConnection)}pauseNegotiations(e=Re()){const t=new Mu;return this.negotiationCompletedPromise.promise.catch((()=>{})).then((()=>{this.setNegotiationPromise(t,e)})),t}getExtensionsManager(){return this.extensionsManager}onDeviceEvent(e){this.stats.onDeviceEvent(e)}deviceSelectionChanged(){this.peerConnection&&(this.audioRenderer&&this.audioRenderer.getStream()&&this.audioRenderer.setOutputDevice(this.deviceManager.getOutputDeviceId()),Mg(this.negotiatedModalities)||(this.forceMediaStreamUpdate=!0,this.triggerRenegotiation(!0)))}async terminate(e,t,i=!0){this.logger.safe.info(`[${e}] terminate`),this.stats.setTerminated(),this.canTriggerRenegotiation=!1,this.cleanUp(e);try{i&&await this.getStatsAsync(!1)}catch(t){this.logger.safe.error(`[${e}] Error while gathering stats ${Ge(t)}`)}finally{this.stats.dispose(),this.terminated=!0}}processNotification(e,t){this.extensionsManager.processNotification(e,t)}cleanUp(e){this.negotiationQueue.dispose(),this.localVideoStreamWatcher.dispose(),this.remoteVideoManager.dispose(),this.resetPeerConnection(e),this.subscriptionManagerSubs.forEach((e=>e.dispose())),this.subscriptionManager&&this.subscriptionManager.dispose(),this.clearIceDisconnectedTimer(),this.extensionsManager&&this.extensionsManager.dispose(),this.callbacks.onTerminated&&this.callbacks.onTerminated(),this.negotiationCompletedPromise.reject("webRtcSession cleanup")}resetPeerConnection(e){this.logger.safe.info(`[${e}] reset peer connection`),this.audioRenderer&&this.audioRenderer.dispose(),this.dtmfSender&&(this.dtmfSender.dispose(),this.dtmfSender=null),this.peerConnection&&this.peerConnection.close(),this.toBeCalledAfterConnected=[],this.disposeStreams(),this.peerConnection=null,this.contributingSources?.dispose(),this.activeSpeakerManager.dispose(),this.negotiationEmulator.configure(null),this.peerConnectionPromise=null,this.resetCandidateGathering(e),this.canTriggerRenegotiation=!0,this.negotiatedModalities={}}resetNegotiationQueue(e=Re()){this.negotiationCompletedPromise.reject("promise expired"),this.setNegotiationPromise(new Mu,e)}setNegotiationPromise(e,t=Re()){this.terminated||(this.negotiationCompletedPromise=e,this.negotiationQueue.add(this.negotiationCompletedPromise,t))}setupExtensionsManager(){const e=new lD(this.logger.createChild("ExtMgr"));return e.addExtension("dominantSpeakerHistory",{logger:this.logger,callback:this.activeSpeakerManager.onDominantSpeakerHistoryChanged.bind(this.activeSpeakerManager)}),e.addExtension("videoStreamControl",{logger:this.logger,negotiationEmulator:this.negotiationEmulator,qualityManager:this.qualityManager,configProvider:this.configProvider,statisticsGatherer:this.stats}),e}updateQualityLevels(e){if(!e)return;this.hwSilent!==e.audioHwSilent&&(this.hwSilent=e.audioHwSilent,this.callbacks.onAudioHwSilentChanged&&this.callbacks.onAudioHwSilentChanged(this.hwSilent)),this.ufdManager.signalEvent("NetworkRecvQuality",e.networkRecvLevel.quality,void 0,void 0,void 0,void 0,{recvQualityData:e.networkRecvLevel}),this.ufdManager.signalEvent("NetworkSendQuality",e.networkSendLevel.quality,void 0,void 0,void 0,void 0,{sendQualityData:e.networkSendLevel});const t=!(!e.isSpeaking||!this.doAudioMute);this.ufdManager.signalEvent("DeviceSpeakWhileMuted",t?"Bad":"Good")}triggerRenegotiation(e,t=Re()){this.canTriggerRenegotiation?(this.canTriggerRenegotiation=!1,this.triggerRenegotiationFlag=!1,this.logger.safe.info(`[${t}] triggering renegotiation`),this.mediaManager.backup(),this.callbacks.onNegotiationRequired&&this.callbacks.onNegotiationRequired(t)):e&&(this.logger.safe.info(`[${t}] renegotiation postponed`),this.triggerRenegotiationFlag=!0)}throwIfModalitiesNotConfigured(e){if(!this.configuredModalities)throw new Error(e)}addTrack(e,t,i){if(!e)return;const n=this.modalityByMediaType(i);if(this.logger.safe.info(`add media track kind: ${e.kind} id: ${e.id}`),this.senders[n])throw new Error("track already created, modality:"+n+", kind:"+e.kind+", id:"+e.id);"closed"!==this.peerConnection.iceConnectionState&&(this.senders[n]=this.peerConnection.addTrack(e,t))}registerMediaSources(){const e=[];if(this.mediaStreams.forEach(((t,i)=>{const n={sourceId:this.getSourceIdForStream(t),defaultSSRC:this.ssrcs[i].min,modality:this.modalityByMediaType(i)};e.push(n)})),this.qualityManager.updateRegisteredSources(e),this.videoStream){const e=this.videoStream.getResolution();this.qualityManager.setCurrentResolution(new DI(e.width,e.height))}}updateStream(e,t){return e.start().then((()=>{try{const i=this.mediaStreams.get(t);if(i&&e.isSameStream(i))return e.dispose(),null;if(this.updateSsrcRangeForMediaType(t),this.removeTrackByMediaType(t),this.disposeStreamByMediaType(t),!this.peerConnection)return e.dispose(),null;if(this.addTrack(e.rawTrack,e.rawStream,t),e.onApplyConstraints=i=>{this.removeTrackByMediaType(t),i.then((()=>{this.addTrack(e.rawTrack,e.rawStream,t),this.registerLocalStreams(),this.mediaManager.updateMediaEntitiesWithLocalTracks()}))},this.mediaStreams.set(t,e),"Video"===t){const e=[this.getMediaTrackInfo(t)];this.localVideoStreamWatcher.startWatching(e)}}catch(i){throw this.removeTrackByMediaType(t),this.disposeStreamByMediaType(t),e.dispose(),i}}))}getSourceIdForStream(e){const t=e.rawStream.getTracks()[0].id,i=this.mediaManager.getMediaEntityByLocalTrackId(t);return i?(this.logger.safe.info(`Media entity found: ${JSON.stringify(i.getXSourceStreamId())}`),i.getXSourceStreamId()):(this.logger.safe.error(`Media entity is not found for stream: ${JSON.stringify(t)}`),0)}updatePeerConnectionStreamsAsync(e,t,i,n){const r=Ag(this.negotiatedModalities.audio),s=Ag(this.negotiatedModalities.video),a=Ag(this.negotiatedModalities.sharing),o=Mg(this.negotiatedModalities),l=Ag(e.audio),d=Ag(e.video),c=Ag(e.sharing),h=Mg(e);return o||h||(this.stats.onSendersChanged("Audio",l),this.stats.onSendersChanged("Video",d),this.stats.onSendersChanged("ScreenShare",c)),this.assurePeerConnectionAsync(n).then((async()=>{if(this.logger.safe.info("updatePeerConnectionStreamsAsync","pc state",this.peerConnection.signalingState,"hold","[",o,"->",h,"]","audio","[",r,"->",l,"]","video","[",s,"->",d,"]","sharing","[",a,"->",c,"]"),o!==h){if(this.videoStream&&this.videoStream.setHold(h),this.audioStream&&this.audioStream.setHold(h),this.displayStream&&this.displayStream.setHold(h),h)return;if(!h&&this.audioStream){this.removeTrackByMediaType("Audio");const e=this.audioStream.clone();this.audioStream.dispose(),this.mediaStreams.set("Audio",e),this.addTrack(this.audioStream.rawStream.getAudioTracks()[0],this.audioStream.rawStream,"Audio")}}if((r!==l||s!==d||a!==c||this.forceMediaStreamUpdate)&&(i&&(this.forceMediaStreamUpdate=!1),t&&(this.logger.safe.info("not using any media(track api) track, remove all senders"),l||(this.removeTrackByMediaType("Audio"),this.disposeStreamByMediaType("Audio")),i&&d||(this.removeTrackByMediaType("Video"),this.disposeStreamByMediaType("Video")),i&&c||(this.removeTrackByMediaType("ScreenShare"),this.disposeStreamByMediaType("ScreenShare"))),i)){const e=[];if(d){const t=await this.deviceManager.getVideoStream(!1);e.push(this.updateStream(t,"Video"))}if(c){const t=this.deviceManager.getDisplayStream();e.push(this.updateStream(t,"ScreenShare"))}if(l){const t=await this.deviceManager.getAudioStream(!1);e.push(this.updateStream(t,"Audio").then((()=>{this.audioStream.setMuted(this.doAudioMute)})))}return Promise.all(e).then((()=>this.registerLocalStreams()))}}))}getMediaTrackInfo(e){const t=this.modalityByMediaType(e),i=this.mediaStreams.get(e).rawStream.getTracks()[0].id;return i||this.logger.safe.error(`No media track for modality found: ${t}`),{trackId:i,modality:t}}getSsrcRangeForMediaType(e){const t={min:1,max:1};switch(e){case"Audio":return this.ssrcGenerator.nextAudioStreamSsrc();case"Video":case"ScreenShare":return this.ssrcGenerator.nextVideoStreamSsrc();default:return t}}updateSsrcRangeForMediaType(e){"Video"!==e&&"ScreenShare"!==e||(this.ssrcs[e]=this.ssrcGenerator.nextVideoStreamSsrc())}getStreamTransformConfiguration(){return{unifiedPlanEnabled:!1,addPrefixForMsid:this.configProvider.config.addPrefixForMsidInSdp}}registerLocalStreams(){const e=[];this.mediaStreams.forEach(((t,i)=>{e.push(this.getMediaTrackInfo(i))})),this.mediaManager.setLocalTracksInfo(e)}handleVideoRecvCapabilities(e){if(this.configProvider.config.enableLocalVideoConstraints&&Rg(e.getModalities().video)){if(this.videoStream){const t=e.getVideoRecvCapabilities();if(!t)return this.logger.safe.error("No fmt params found for video modality"),Promise.resolve(!1);const i=this.generateReceiveCapabilities(t,this.videoStream);this.qualityManager.setMaxCapabilities([i])}this.logger.safe.error("remote endpoint didn't specify video receive capability")}return Promise.resolve(!1)}handleSharingRecvCapabilities(e){if(this.configProvider.config.enableLocalVideoConstraints&&Rg(e.getModalities().sharing)&&this.displayStream){const t=e.getSharingRecvCapabilities();if(!t)return void this.logger.safe.error("No fmt params found for sharing modality");const i=this.generateReceiveCapabilities(t,this.displayStream);this.qualityManager.setMaxCapabilities([i])}}generateReceiveCapabilities(e,t){const i={ssrc:0,rid:"0",keyframe:!1,...e},n={causeId:Re(),isSimulcast:!1,sourceId:this.getSourceIdForStream(t),capabilities:[i]};return this.logger.safe.info(`Generated receive capabilities for stream ${t.id}: ${JSON.stringify(n)}`),n}updateDescriptor(e,t){const i=t.getVideoRecvCapabilities(),n={sourceId:0,streamMsid:0,bandwidth:0};if(i&&this.videoStream&&!this.displayStream&&(n.sourceId=this.getSourceIdForStream(this.videoStream),n.streamMsid=this.videoStream.id,n.bandwidth=i.maxBr?i.maxBr:Number.MAX_VALUE),n.bandwidth>0){n.bandwidth=Math.floor(n.bandwidth/1200);const t=new PO(this.logger.createChild("rembModifier"),this.qualityManager,this.configProvider);t.setControlItem(n),t.modifyDescriptor(e)}}removeTrackByMediaType(e){return this.removeTracksByModality(this.modalityByMediaType(e))}modalityByMediaType(e){switch(e){case"Audio":return tt.MODALITY.audio;case"Video":return tt.MODALITY.video;case"ScreenShare":return tt.MODALITY.sharing;default:throw new Error(`Modality is not defined for media type: ${e}`)}}removeTracksByModality(e){this.forceKeyFramePromise&&"sharing"===e?this.forceKeyFramePromise.then((()=>{this.removeTracksByModality(e)})):e in this.senders&&(this.logger.safe.info(`remove sender track kind: ${this.senders[e].track.kind} track id: ${this.senders[e].track.id}`),"closed"!==this.peerConnection.iceConnectionState&&this.peerConnection.removeTrack(this.senders[e]),delete this.senders[e])}handleCodecSwitchUnsupported(e){return this.offeredDescription.isCodecSwitchSupported()?Promise.resolve():this.webrtcAdapter.RTCRtpReceiver.getCapabilities(tt.MEDIA_TYPE.audio).then((e=>{const t=e.codecs.map((e=>e.mimeType));this.offeredDescription.usePrimaryAudioCodecOnly(t)})).catch((t=>{this.logger.safe.error(`[${e}] failed to set primary codec based on audio capability ${Ge(t)}`)}))}disposeStreamByMediaType(e){const t=this.mediaStreams.get(e);t&&(this.mediaStreams.delete(e),t.dispose(),"Video"===e&&this.localVideoStreamWatcher.stopWatching())}disposeStreams(){this.mediaStreams.forEach(((e,t)=>this.disposeStreamByMediaType(t)))}assurePeerConnectionAsync(e){if(!this.peerConnectionPromise){if(!this.relayManagerProvider)throw new Error("relay manager provider is not set!");this.logger.safe.info("fetching relay details from RelayManager...");const t={relayType:"turn",isRemoteClientLync:this.context.config.isRemoteClientLync};this.peerConnectionPromise=this.relayManagerProvider.getRelayManager().queryRelaysAsync(t).then((t=>{if(this.terminated)throw new Error("session already disposed");const i={optional:[]},n=rO(t,this.configProvider.config),r=this.configureCrypto(i);this.configureCpuThreshold(i),this.logger.safe.info("create peer connection");const s=this.context.configProvider.mediaConfig.isTransportUnbundled?"balanced":"max-bundle",a=this.peerConnection=new this.webrtcAdapter.RTCPeerConnection({iceServers:n,rtcpMuxPolicy:"require",iceTransportPolicy:this.iceTransportPolicy,bundlePolicy:s,sdpSemantics:"plan-b",audioPortRange:this.configProvider.mediaConfig.audioPortRange,videoPortRange:this.configProvider.mediaConfig.videoPortRange,enableDtlsSrtp:1===r,offerExtmapAllowMixed:!1},i);this.negotiationEmulator.configure(a),this.stats.initialize(a),this.stats.sessionInfo.setIceServers(n),this.stats.sessionInfo.setIceTransportPolicy(this.iceTransportPolicy),this.stats.sessionInfo.setBundlePolicy(s),this.webrtcAdapter.RTCRtpReceiver.getCapabilities("video").then((e=>this.stats.setH264AvailableProfiles(e))),a.onnegotiationneeded=()=>{this.logger.safe.info(`onnegotiationneeded signalingState: ${a.signalingState}`)},a.onsignalingstatechange=()=>{this.stats.sessionInfo.setSignalingConnectionState(a.signalingState),this.logger.safe.info(`onsignalingstatechange signalingState: ${a.signalingState}`)},a.onicecandidateerror=e=>{const[t,i]=[e.address,e.port];this.logger.safe.warn(`On ICE candidate error ${e.url} | ${t}:${i}: code ${e.errorCode}: ${e.errorText}`),this.isConnected()&&!this.iceCandidatesDeferred.isPending||this.stats.addIceCandidateError({address:t,port:+i,url:e.url,errorCode:e.errorCode,errorText:e.errorText})};const o=e=>{if(!this.isConnected())return this.logger.safe.info("onaddstream handling postponed till PC is connected"),void this.toBeCalledAfterConnected.push((()=>o(e)));const t=e.stream;this.logger.safe.info(`onaddstream stream: ${t.id}`);let i=this.mediaManager.getMediaEntityByRemoteStreamId(t.id);if(i||(this.logger.safe.info(`cannot find media entity with stream id ${t.id} trying to fallback`),t.getAudioTracks()[0]&&(i=this.mediaManager.getMediaEntitiesByModality(tt.MODALITY.audio)[0])),i){const e=this.createReceiveStream(t,i);this.receiveStreamCollection.add(e)}else this.logger.safe.error(`could not find media entity for an added stream: ${t.id}`)};a.onaddstream=o,a.ontrack=e=>{this.logger.safe.info(`ontrack track: ${e.track}`)};const l=e=>{if(!this.isConnected())return this.logger.safe.info("onremovestream handling postponed till PC is connected"),void this.toBeCalledAfterConnected.push((()=>l(e)));this.logger.safe.info(`onremovestream stream: ${e.stream.id}`),this.receiveStreamCollection.remove(e.stream.id)};a.onremovestream=l,a.onicecandidate=t=>{const i=t.candidate;if(i){const t=Ug(i.candidate);this.logger.safe.info(`[${e}] onicecandidate candidate: prio:${t.priority} type:${t.type} port:${t.port}`),this.logger.unsafe.info(`[${e}] candidate details: ${i.candidate}`),!this.relayCandidateGathered&&i.candidate.indexOf("typ relay")>-1&&(this.stats.sessionInfo.setRelayCandidateInfo({priority:i.priority||i.candidate.split(" ")[3],time:Date.now()-this.iceRelayCandidatesGatherStartTime}),this.relayCandidateGathered=!0)}else this.logger.safe.info(`[${e}] onicecandidate candidate: null`);if(!this.iceCandidatesDeferred.isPending)return;const r=!this.initiator||!this.context.config.webrtcIceGatheringTimeoutIncreased,s=this.iceHostCandidateOnly||0===n.length;if(!i&&r||s){i&&this.logger.safe.info(`[${e}] Not waiting for ICE candidates, hoping that host/prflx is enough`),this.logger.safe.info(`[${e}] Is connected:`,this.isConnected(),a.iceConnectionState,a.signalingState);let t=!0;this.context.configProvider.mediaConfig.isTransportUnbundled&&i&&(t=this.sessionDescription.createLocalOffer(this.peerConnection.localDescription.sdp).hasUnbundledIceCandidates()),t&&this.completeCandidateGathering(e)}else if(this.relayCandidateGathered){let t=!0;this.context.configProvider.mediaConfig.isTransportUnbundled&&(t=this.sessionDescription.createLocalOffer(this.peerConnection.localDescription.sdp).hasUnbundledRelayIceCandidates()),t&&(this.stats.clearIceCandidateErrors(),this.completeCandidateGathering(e))}},a.onicegatheringstatechange=()=>{this.logger.safe.info(`onicegatheringstatechange iceGatheringState: ${a.iceGatheringState}`)},a.oniceconnectionstatechange=()=>{const e=Re();if(!this.terminated){if(this.stats.sessionInfo.setIceConnectionState(a.iceConnectionState),this.logger.safe.info(`[${e}] oniceconnectionstatechange iceConnectionState: ${a.iceConnectionState} pc.signalingState: ${a.signalingState}`),"connected"===a.iceConnectionState||"completed"===a.iceConnectionState)this.onTransportConnected(e);else if("failed"===a.iceConnectionState){if(this.iceCandidatesDeferred.isPending)return this.logger.safe.info(`[${e}] ice failed while gathering candidates, suppressing error`),void this.completeCandidateGathering(e);this.raiseError({type:tt.MEDIA_ERROR.iceConnectionError,detail:"ice transport failed"},e),this.configProvider.config.webrtcCloseAfterIceFailure&&a.close(),this.onTransportFailed()}"disconnected"===a.iceConnectionState?(this.onTransportDisconnected(e),this.startIceDisconnectedTimer(e)):this.clearIceDisconnectedTimer()}},this.multiParty&&(this.contributingSources=new qk(this.logger.createChild("ContributingSources"),this.configProvider,this.activeSpeakerManager,new zk(this.logger.createChild("ContributingSourcesProvider"),a)))}))}return this.peerConnectionPromise}configureCrypto(e){let t=!1;const i=Yg(this.context);if(this.offeredDescription){const e=this.offeredDescription.getSrtpInfo();this.stats.sessionInfo.setOfferedSrtpInfo(e),t=!e.dtls||e.sdes&&i}else t=i;return t&&(this.logger.safe.info("configuring peer connection to use sdes"),e.optional.push({DtlsSrtpKeyAgreement:!1})),this.stats.sessionInfo.setNegotiatedSrtpInfo({dtls:!t,sdes:!!t}),t?0:1}configureCpuThreshold(e){this.configProvider.config.webrtcNativeCpuOveruseDisabled&&this.multiParty&&e.optional.push({googCpuOveruseDetection:!1})}completeCandidateGathering(e){this.iceCandidatesDeferred.isPending&&(this.logger.safe.info(`[${e}] ICE candidates gathered completely`),this.iceCandidatesDeferred.resolve())}onTransportConnected(e){if(this.logger.safe.info(`[${e}] audio transport connected`),this.stats.clearIceCandidateErrors(),!this.terminated)for(this.callbacks.onAudioStateChanged(tt.STREAMING_STATE.active,e),this.callbacks.onTransportConnected&&this.callbacks.onTransportConnected(e);this.toBeCalledAfterConnected.length;)this.toBeCalledAfterConnected.shift()()}onTransportDisconnected(e){this.callbacks.onTransportDisconnected&&this.callbacks.onTransportDisconnected(e)}onTransportFailed(){this.callbacks.onTransportFailed&&this.callbacks.onTransportFailed()}startIceDisconnectedTimer(e){this.configProvider.config.iceDisconnectedTimeoutMs&&(this.iceDisconnectedTimer=setTimeout((()=>{this.logger.safe.error(`[${e}] ice disconnected for ${this.configProvider.config.iceDisconnectedTimeoutMs}ms. Raise CONSTANTS.MEDIAthis._ERROR.iceConnectionError`),this.raiseError({type:tt.MEDIA_ERROR.iceConnectionError,detail:"ice transport disconnected"},e)}),this.configProvider.config.iceDisconnectedTimeoutMs))}clearIceDisconnectedTimer(){this.iceDisconnectedTimer&&(clearTimeout(this.iceDisconnectedTimer),this.iceDisconnectedTimer=null)}raiseError(e,t=Re()){this.logger.safe.error(`[${t}] Media error occurred type: ${e.type} detail: ${e.detail}`),this.callbacks.onSessionErrorOccurred&&this.callbacks.onSessionErrorOccurred(e,t)}createNegotiationConstraints(e){function t(e){return!!e&&(Rg(e)||"inactive"===e)}return{offerToReceiveAudio:t(e.audio),offerToReceiveVideo:t(e.video)||t(e.sharing)}}resetCandidateGathering(e){this.logger.safe.info(`[${e}] reset candidate gathering`),this.iceCandidatesDeferred.promise.then((()=>{}),(()=>{})),this.iceCandidatesDeferred.reject(new Error("reset candidate gathering")),this.iceCandidatesDeferred=new Mu}checkIceCandidates(e){const t=this.hasIceCandidates(e);if(t===this.noIceCandidates&&(this.noIceCandidates=!this.noIceCandidates,this.ufdManager.signalEvent("NoNetwork",this.noIceCandidates?"Bad":"Good"),this.noIceCandidates))throw{type:tt.MEDIA_ERROR.noNetworkError,detail:"no ice candidates"};if(t){const t=this.hasRelayIceCandidates(e);if(t===this.noRelayIceCandidates){if(!t&&("connected"===this.peerConnection.iceConnectionState||"completed"===this.peerConnection.iceConnectionState))return;this.noRelayIceCandidates=!this.noRelayIceCandidates,this.ufdManager.signalEvent("NetworkRelaysNotReachable",this.noRelayIceCandidates?"Bad":"Good")}}}hasIceCandidates(e){return this.configProvider.mediaConfig.isTransportUnbundled?e.hasUnbundledIceCandidates():e.hasIceCandidates()}hasRelayIceCandidates(e){return this.configProvider.mediaConfig.isTransportUnbundled?e.hasUnbundledRelayIceCandidates():e.hasRelayIceCandidates()}doRetargetIfNeeded(e,t,i){const n=t.isIceRestart();this.logger.safe.info(`[${i}] ICE restart: ${n}`),this.context.configProvider.mediaConfig.isTransportUnbundled&&this.offeredDescription?.isMSRTC()&&n&&!this.multiParty&&t.getSrtpInfo().sdes&&(e.newOffer=!0)}getAddedMediaTypes(e,t){e||(e={}),t||(t={});const i=[];return CN(e.audio,t.audio)&&i.push("Audio"),CN(e.video,t.video)&&i.push("Video"),CN(e.sharing,t.sharing)&&i.push("ScreenShare"),i}applyCapabilitiesForModality(e,t,i){return e===tt.MODALITY.video?this.applyCapabilitiesForVideo(t,i[0]):e===tt.MODALITY.sharing?this.applyCapabilitiesForSharing(t,i[0]):Promise.resolve(!1)}applyCapabilitiesForSharing(e,t){return this.displayStream?this.applyCapabilities(this.displayStream,t).then((i=>(this.stats.onMaxCapabilitiesApplied({causeId:e,modality:tt.MODALITY.sharing,capabilities:[t]}),this.configProvider.config.webrtcAllowRestoreKeyframe?this.forceKeyframe(this.senders[tt.MODALITY.sharing]).then((()=>i)):Promise.resolve(i)))):(this.logger.safe.info(`${JSON.stringify(t)} is ignored as no sharing stream is sent, no renegotiation`),Promise.resolve(!1))}forceKeyframe(e){if(!e)return this.logger.safe.error("forceKeyframe: No sender available for sharing"),null;if(this.forceKeyFramePromise)return this.logger.safe.warn("forceKeyframe: already in progress"),this.forceKeyFramePromise;this.logger.safe.info("Restoring keyframe");const t=e.track;return this.forceKeyFramePromise=e.replaceTrack(null).then((()=>e.replaceTrack(t))).then((()=>{this.forceKeyFramePromise=null,this.logger.safe.info("Restoring keyframe finished")})).catch((e=>{this.forceKeyFramePromise=null,this.logger.safe.error(`Restoring keyframe failed: ${e}`),delete this.senders[tt.MODALITY.sharing]})),this.forceKeyFramePromise}applyCapabilitiesForVideo(e,t){return this.negotiationCompletedPromise.isPending?(this.logger.safe.info("##### Renegotiation is in progress, no local resolution switch for now #####"),this.negotiationCompletedPromise.promise.then((()=>Promise.resolve(!1)))):this.videoStream?this.scheduleApplyCapabilities(this.videoStream,e,t):(this.logger.safe.info(`${JSON.stringify(t)} is ignored as no video is sent, no renegotiation`),Promise.resolve(!0))}scheduleApplyCapabilities(e,t,i){this.logger.safe.info("Queueing local renegotiation...");let n=!1;return this.negotiationQueue.add((()=>(this.logger.safe.info("############# LOCAL RENEGOTIATION START #############"),this.applyCapabilities(e,i).then((()=>{this.stats.onMaxCapabilitiesApplied({causeId:t,modality:tt.MODALITY.video,capabilities:[i]}),n=!0})))),t),this.negotiationEmulator.renegotiate().then((()=>(this.logger.safe.info(`############# LOCAL RENEGOTIATION END. RESULT: ${n}  #############`),n)))}applyCapabilities(e,t){return e?(this.logger.safe.info(`Changing resolution to ${JSON.stringify(t)}`),e.applyCapabilities(t)):(this.logger.safe.info(`Resolution ${JSON.stringify(t)} ignored, no stream is being sent`),Promise.resolve(!1))}onOptimalVideoReceiversCountChanged(e){this.callback.onOptimalVideoReceiversCountChanged&&this.callback.onOptimalVideoReceiversCountChanged(e)}async onSendBandwidthChanged(e){if(!this.isConnected())return;const t=this.extensionsManager.getExtension("videoStreamControl"),i=this.mediaManager.getMediaEntities().filter((e=>[tt.MODALITY.video,tt.MODALITY.sharing].indexOf(e.getModality())>-1)).filter((e=>e.isEnabled())).map((e=>e.getMid()));return 0!==i.length?t.sendBandwidthInfo(i,e).then((()=>{this.stats.setReportedSendBandwidth(e)})):void 0}getStreams(){return this.receiveStreamCollection.getStreams()}onStreamsChanged(e){this.streamsChangedListener=e}notifyStreamsChanged(){this.logger.safe.info(`Scheduling stream changed notification: ${this.streamsChangedNotificationScheduled}`),this.streamsChangedNotificationScheduled||this.negotiationCompletedPromise.promise.catch((()=>{})).then((()=>{this.streamsChangedNotificationScheduled=!1,this.streamsChangedListener&&this.streamsChangedListener()}))}streamAdded(e){tt.MODALITY.audio===e.getModality()&&(this.audioRenderer.setOutputDevice(this.deviceManager.getOutputDeviceId()),this.audioRenderer.play(e.getMediaStream())),this.notifyStreamsChanged()}streamRemoved(e){tt.MODALITY.audio===e.getModality()&&this.audioRenderer.getStream()===e.getMediaStream()&&this.audioRenderer.stop(),this.notifyStreamsChanged()}setNegotiatedModalities(e){this.negotiatedModalities=e,this.stats.sessionInfo.setNegotiatedModalities(e)}setupIceGatheringTimeout(e){this.iceRelayCandidatesGatherStartTime=Date.now();const t=this.context.config.webrtcIceGatheringTimeoutIncreased?this.configProvider.config.relayWaitSaneTimeoutMs:this.configProvider.config.webrtcIceGatheringTimeoutMs;if(!t)return;this.iceCandidatesTimer>0&&clearTimeout(this.iceCandidatesTimer);const i=this.iceCandidatesDeferred;this.iceCandidatesTimer=setTimeout((()=>{this.iceCandidatesTimer=0,i.isPending&&(this.logger.safe.warn(`[${e}] ICE candidates gathering terminated due to timeout ${t}`),i.resolve())}),t)}createAudioRenderer(){this.audioRenderer=new EI(this.logger.createChild("AudioRenderer"),this.configProvider),this.context.maContext.domOverrides.onMediaElementAdded&&this.audioRenderer.on("onAudioElementAdded",this.context.maContext.domOverrides.onMediaElementAdded),this.context.maContext.domOverrides.onMediaElementRemoved&&this.audioRenderer.on("onAudioElementRemoved",this.context.maContext.domOverrides.onMediaElementRemoved)}isConnected(){const e=this.peerConnection;return e&&("connected"===e.iceConnectionState||"completed"===e.iceConnectionState)}isFailed(){return this.peerConnection&&("failed"===this.peerConnection.iceConnectionState||"closed"===this.peerConnection.iceConnectionState)}hasRelayCandidates(){return this.relayCandidateGathered}createReceiveStream(e,t){const i=this.configProvider.config.addFmtpToInitialSubscription?t.getLocalRecvCapabilities():null,n=this.configProvider.config.useMultiviewLimitsOnInitialRequest&&t.getModality()!==tt.MODALITY.sharing?()=>this.remoteVideoManager.getMaxAllowedVideoFS():null;return new gN(e,null,t.getModality(),+t.getXSourceStreamId(),this,i,n)}requestSource(e,t,i){if(!this.multiParty)return Promise.resolve();const n=this.mediaManager.getMediaEntityByRemoteStreamId(e);return!this.isMuteHold&&this.negotiatedModalities[n.getModality()]!==tt.MEDIA_STATE.inactive||t===yO.SourceNone?this.negotiationCompletedPromise.isPending?this.negotiationCompletedPromise.promise.catch((()=>{})).then((()=>this.requestSource(e,t))):Promise.resolve().then((()=>this.extensionsManager.getExtension("videoStreamControl").sendSourceRequest(n.getXSourceStreamId(),t,n?.getMid(),i,n.getSubstreamIndex()))):pm(10).then((()=>this.requestSource(e,t)))}getSessionConfig(){return this.configProvider}getUnmixedAudioProvider(){return null}};function CN(e,t){return!Ag(e)&&Ag(t)}var TN={build:(e,t,i)=>new yN(e,t,i)},EN=class{constructor(e,t,i,n){this.worker=e,this.clientId=t,this.transformType=i,this.listener=n,this.worker.subscribeClient(this.clientId,this.transformType,(e=>this.processMsg(e))),this.worker.sendTransformCommand(this.clientId,{operation:"add",transformType:this.transformType})}processMsg(e){if(this.listener&&e.name in this.listener)return this.listener[e.name].apply(this.listener,e.args);throw`unexpected message received for transform type ${this.transformType}: ${JSON.stringify(e)}`}},_N=class{constructor(e){this.logger=e}createBaseInstanse(e){this.imp=new bN(this.logger.safe),e.addTransform(this.imp)}createWorkerInstanse(e,t){this.imp=new PN(e,t)}},bN=class{constructor(e){this.logger=e,this.transformType=0}transform(e){return this.processChunk(e),e}dispose(){}getStartCodeSize(e){const t=e.getUint32(0);return 1===t?4:256==(4294967040&t)?3:0}processChunk(e){if("key"!==e.type)return;const t=this.isH264KeyFrame(e.data)?`${this.getH264Profile(e.data)}(H264)`:"unknown";this.logger.info(`keyframe metadata: ${JSON.stringify(e.getMetadata())}, profile=${t}`)}isH264KeyFrame(e){if(e.byteLength<7)return!1;const t=new DataView(e),i=this.getStartCodeSize(t);return!!i&&7==(31&t.getUint8(i))}getH264Profile(e){const t=new DataView(e),i=this.getStartCodeSize(t);return(16777215&t.getUint32(i)).toString(16)}},PN=class extends EN{constructor(e,t){super(e,t,0,void 0)}},IN=i(496486),AN=[tt.MODALITY.audio,tt.MODALITY.video,tt.MODALITY.sharing],RN=class{constructor(e,t,i,n,r){this.peerConnection=t,this.mediaManager=i,this.reinvitelessContext=r,this.entityTransceiverMap=new Map,this.logger=e.createChild("TM"),this.configProvider=n.configProvider,this.isMultiparty=n.config.isConference,this.isPstnCall=n.config.isPstnCall,this.isParkedCall=n.config.isParkedCall,this.numVideoChannels=this.isMultiparty&&this.configProvider.config.numVideoChannelsGvc||1,n.configProvider.config.enableRollbackHandler&&this.mediaManager.setRollbackUpdateHandler(this.handleMediaEntitiesRollback.bind(this))}getTransceivers(){return this.peerConnection.getTransceivers().filter(ON)}assureTransceivers(e){this.assureNegotiatedOrder(),this.addModalities(e),this.logTransceiversInfo("assureTransceivers"),this.setDirections(e)}syncTransceivers(e){this.syncWithMediaEntities(),this.setDirections(e)}assureNegotiatedOrder(){const e=this.getTransceivers();this.mediaManager.getMediaEntities().forEach((t=>{-1!==AN.indexOf(t.getModality())&&(DN(this.entityTransceiverMap.get(t),e)||this.createTransceiverForEntity(t))}))}addModalities(e){const t=this.mediaManager.isEmpty();this.isMultiparty||!t||this.isPstnCall||(e.video=e.video||"inactive",e.sharing=e.sharing||"inactive"),this.configProvider.config.webrctRemoveVideoModalitiesForPstn&&this.isPstnCall&&!this.isParkedCall&&(delete e.video,delete e.sharing);for(const i of AN){if(this.mediaManager.getMediaEntitiesByModality(i)[0]||!e[i])continue;const n=i===tt.MODALITY.video?this.numVideoChannels:1;(0,IN.times)(n,(e=>{const n=this.mediaManager.createMediaEntity(i);n.setExtension("reinviteless",t&&this.reinvitelessContext.maxStreamsForModality[i]>e),this.createTransceiverForEntity(n)}))}}createTransceiverForEntity(e){const t=e.getModality();this.logger.safe.info(`createTransceiver: modality=${t}`);const i=t===tt.MODALITY.audio?tt.MEDIA_TYPE.audio:tt.MEDIA_TYPE.video,n=e.getSimulcastContext(),r=this.createTransceiver(i,n);this.setCodecPreferences(r,i,!0),this.setExtensionPreferences(r,t),this.entityTransceiverMap.set(e,r),e.setExtension("unnegotiatedModality",!0)}setCodecPreferences(e,t,i){const n=Zg(this.configProvider,t);if(!n?.length||!Cg.hasCapabilitiesApi()||this.configProvider.config.filterCodecsInSdp)return;const r=yg.window.RTCRtpReceiver.getCapabilities(t);if(!r)return;const s=[];if(i)for(const e of n){const t=r.codecs.filter((t=>wN(e,t)));s.push(...t)}else for(const e of r.codecs)n.some((t=>wN(t,e)))&&s.push(e);s.length&&e.setCodecPreferences&&e.setCodecPreferences(s)}setExtensionPreferences(e,t){if(!this.configProvider.config.headerExtensionsToUpdate?.[t])return;if(!e.getHeaderExtensionsToNegotiate||!e.setHeaderExtensionsToNegotiate)return void this.logger.safe.debug("setExtensionPreferences: transceiver.setHeaderExtensionsToNegotiate is not supported");const i=this.configProvider.config.headerExtensionsToUpdate[t],n=e.getHeaderExtensionsToNegotiate();for(const e of n){const t=i.find((t=>t.uri===e.uri));t&&(e.direction=t.direction)}try{e.setHeaderExtensionsToNegotiate(n)}catch(e){this.logger.safe.error(`setExtensionPreferences: transceiver.setHeaderExtensionsToNegotiate failed, err ${Ge(e)}`)}}async createSender(e,t,i){const n=await this.associateTrackWithTransceiver(e,t,i);if(!n)throw new Error(`Transceiver for modality=${i} is not found`);const r=this.findEntityForTransceiver(n),s=i!==tt.MODALITY.sharing||r?.getExtension("reinviteless")?tt.MEDIA_STATE.sendReceive:tt.MEDIA_STATE.send;return n.direction=s,this.logger.safe.info(`Replace track completed direction:${n.direction} for transceiver mid=${n.mid}`),n.sender}removeSender(e){this.removeSenderInternal(e,!1)}async removeSenderAsync(e){return this.removeSenderInternal(e,!0)}removeSenderInternal(e,t){if("closed"===(this.peerConnection.connectionState||this.peerConnection.iceConnectionState))return void this.logger.safe.info("Not removing sender from pc, connection is closed");const i=this.getTransceivers().find((t=>t.sender===e));if(!i)throw new Error(`Transceiver for sender with track=${e.track?.id} is not found`);const n=this.findEntityForTransceiver(i),r=!!n?.getExtension("reinviteless");this.logger.safe.info(`Remove sender with track=${e.track?.id} for transceiver mid=${i.mid}, reinviteless=${r}, doAsync=${t}`);let s=Promise.resolve();return r&&t?s=i.sender.replaceTrack(null):this.peerConnection.removeTrack(e),t?s:void 0}createTransceiver(e,t){const i={direction:"inactive"};return this.addSimulcastEnvelopeIfNeeded(i,t),this.peerConnection.addTransceiver(e,i)}addSimulcastEnvelopeIfNeeded(e,t){t?.shouldUseSimulcast()&&(e.sendEncodings=(0,IN.times)(t.config.layerScaleFactors.length,(e=>{const i=`${t.ridList[e]}`,n=t.config.layerScaleFactors[e];return this.logger.safe.debug(`Added layer ${e} with rid: ${i} SF: ${n}`),{rid:i,scaleResolutionDownBy:n}})))}async associateTrackWithTransceiver(e,t,i){const n=this.findAvailableTransceiverToSend(i);if(n){this.logger.safe.info(`Associate track=${e?.id} (${i}) with existing transceiver mid=${n.mid}`);try{await n.sender.replaceTrack(e),this.configProvider.config.useSetStreamsForSender&&n.sender.setStreams&&n.sender.setStreams(t)}catch(e){throw this.logger.safe.error(`replaceTrack failed, err ${JSON.stringify(e)}`),e}return n}return null}syncWithMediaEntities(){const e=this.getTransceivers();this.mediaManager.getMediaEntities().forEach((t=>{let i=this.entityTransceiverMap.get(t);i=DN(i,e)?i:e.find((e=>e.mid===t.getMid())),this.entityTransceiverMap.set(t,i)})),this.logTransceiversInfo("syncWithMediaEntities")}getTransceiversByModality(e){return this.mediaManager.getMediaEntitiesByModality(e).map((e=>this.entityTransceiverMap.get(e))).filter(ON)}setDirections(e){const t=!Mg(e);for(const i of AN)for(const[n,r]of this.getTransceiversByModality(i).entries()){const s=this.findEntityForTransceiver(r);if(s?.getExtension("reinviteless")&&t){r.direction="sendrecv";continue}const a=e[i]||tt.MEDIA_STATE.inactive;r.direction=0===n&&r.currentDirection?a:MN(a)}this.logTransceiversInfo("setDirections")}handleMediaEntitiesRollback(e,t){e.forEach((e=>{const i=this.entityTransceiverMap.get(e),n=t.find((t=>t.getMid()===e.getMid()));this.entityTransceiverMap.set(n,i)})),this.logTransceiversInfo("handleMediaEntitiesRollback")}findAvailableTransceiverToSend(e){const t=this.mediaManager.getMediaEntitiesByModality(e)[0];return this.entityTransceiverMap.get(t)}findEntityForTransceiver(e){for(const[t,i]of this.entityTransceiverMap)if(i===e)return t}logTransceiversInfo(e){let t=`${e}: transceivers details:`;for(const e of AN){const i=this.getTransceiversByModality(e);t+=` ${e}(${i.length}) [${i.map((e=>`mid=${e.mid}, direction=${e.direction}`)).join(";")}]`}this.logger.safe.debug(t)}};function wN(e,t){return!(!(0,IN.isUndefined)(e.channels)&&e.channels!==t.channels||!(0,IN.isUndefined)(e.clockRate)&&e.clockRate!==t.clockRate||!(0,IN.isUndefined)(e.mimeType)&&e.mimeType.toLowerCase()!==t.mimeType.toLowerCase()||!(0,IN.isUndefined)(e.sdpFmtpLine)&&-1===t.sdpFmtpLine.toLowerCase().indexOf(e.sdpFmtpLine.toLowerCase()))}function MN(e){let t=e;return Ag(e)&&(t=Ig(e)),t||tt.MEDIA_STATE.inactive}function ON(e){return e&&"stopped"!==e.direction&&!e.stopped}function DN(e,t){return ON(e)&&-1!==t.indexOf(e)}var kN=class{constructor(e,t){this.transforms=[];const i=new TransformStream({transform:(e,t)=>{let i=e;for(const e of this.transforms)if(i=e.transform(i),!i)return;t.enqueue(i)}});e.pipeThrough(i).pipeTo(t)}clearTransforms(){for(const e of this.transforms)e.dispose();this.transforms=[]}addTransform(e){this.transforms.push(e)}getTransform(e){return this.transforms.find((t=>t.transformType===e))}},NN=class{constructor(e,t){this.logger=t,this.clientsMap=new Map,this.loaded=!1,this.initDefer=um();try{this.worker=e.getWorker(),this.worker.onmessage=e=>this.handleEvent(e.data),this.worker.onerror=e=>{this.logger.safe.error(`error inside worker: ${e.message}`),this.initDefer.resolve()}}catch(e){this.logger.safe.error("failed to create worker"),this.initDefer.resolve()}}initialize(){return Promise.race([this.initDefer.promise,pm(5e3)])}isWorkerLoaded(){return this.loaded}sendTransformCommand(e,t,i=[]){const n={type:"transform",clientId:e,payload:t};this.worker.postMessage(n,i)}subscribeClient(e,t,i){const n=this.clientsMap.get(e)??new Map;n.set(t,i),this.clientsMap.set(e,n)}dispose(){this.worker.postMessage({type:"generic",payload:{operation:"dispose"}}),this.worker.terminate()}handleEvent(e){switch(e.type){case"init":this.initDefer.resolve(),this.loaded=!0;break;case"transform":{const t=this.clientsMap.get(e.payload.clientId),i=t?.get(e.payload.event.transformType);i?.(e.payload.event),i||this.logger.safe.error(`received event for unknown Client ${e.payload.clientId} or transformType ${e.payload.event.transformType}`)}break;case"log":switch(e.level){case"debug":this.logger.safe.debug(e.msg);break;case"info":this.logger.safe.info(e.msg);break;case"warn":this.logger.safe.warn(e.msg);break;case"error":this.logger.safe.error(e.msg);break;default:this.logger.safe.error(`unknown log level ${e.level}`)}break;default:this.logger.safe.error(`received unsupported event from worker ${e.type}`)}}},LN=class extends Qe{constructor(e,t,i){super(),this.configProvider=e,this.workerProvider=t,this.logger=i,this.transformsCollections=new Map}async initialize(){return this.configProvider.config.useInsertableStreams&&this.workerProvider&&Cg.hasEncodedStreamApi()&&(this.worker=new NN(this.workerProvider,this.logger)),this.worker?this.worker.initialize():Promise.resolve()}initTransformsCollection(e,t,i){const n=Cg.hasScriptTransformApi()||this.workerProvider;if(!this.configProvider.config.useInsertableStreams||!Cg.hasEncodedStreamApi()||n&&!this.isWorkerLoaded())return null;if(!this.transformsCollections.has(e)){const n=this.worker?new FN(this.worker,e):new xN(e);this.transformsCollections.set(e,{collection:n,mediaType:i,objType:t})}const r=this.transformsCollections.get(e);return this.event("onTransformsCollectionCreated").raise(r),r.collection}clearTransformsCollection(e){const t=this.transformsCollections.get(e);t&&(this.event("onTransformsCollectionCleared").raise(t),t.collection.clearTransforms())}dispose(){for(const e of this.transformsCollections.values())this.event("onTransformsCollectionCleared").raise(e),e.collection.clearTransforms();this.transformsCollections.clear(),this.worker?.dispose(),super.dispose()}isWorkerLoaded(){return!!this.worker?.isWorkerLoaded()}},xN=class{constructor(e){const{readable:t,writable:i}=e.createEncodedStreams();this.streamTransformer=new kN(t,i)}addTransform(e){e.createBaseInstanse(this.streamTransformer)}clearTransforms(){this.streamTransformer.clearTransforms()}},FN=class{constructor(e,t){if(this.workerHandler=e,this.clientId=t.track.id,Cg.hasScriptTransformApi())return void(t.transform=new RTCRtpScriptTransform(this.workerHandler.worker,{clientId:this.clientId}));const{readable:i,writable:n}=t.createEncodedStreams(),r=[i,n];this.workerHandler.sendTransformCommand(this.clientId,{operation:"init",readable:i,writable:n},r)}addTransform(e){e.createWorkerInstanse(this.workerHandler,this.clientId)}clearTransforms(){this.workerHandler.sendTransformCommand(this.clientId,{operation:"clear"})}},UN=i(496486),VN=class extends Qe{constructor(e,t){super(t),this.logger=t,this.id=-1,this.parentId=-1,this.rawStream=null,this.rawTrack=null,this.deviceId=null,this.mediaType=e}start(){return this.logger.safe.debug("start"),Promise.resolve()}clone(){return this.logger.safe.debug("clone"),this}setMuted(e,t){this.logger.safe.debug("setMuted")}setHold(e){this.logger.safe.debug("setHold")}getResolution(){return this.logger.safe.debug("getResolution"),{width:240,height:180}}getFrameRate(){return this.logger.safe.debug("getFrameRate"),1}hasAudio(){return this.logger.safe.debug("hasAudio"),!1}hasVideo(){return this.logger.safe.debug("hasVideo"),!1}isSameStream(e){return this.logger.safe.debug("isSameStream"),e===this}applyCapabilities(e){return this.logger.safe.debug("applyCapabilities"),Promise.resolve(!1)}onApplyConstraints(e){this.logger.safe.debug("onApplyConstraints")}update(e){this.logger.safe.debug("update")}isActive(){return!1}isDisposed(){return!1}},HN=class e extends Qe{constructor(e,t,i,n){super(n),this.callDeviceManager=e,this.configProvider=t,this.serialQueue=i,this.logger=n,this.mediaStreams={Audio:null,Video:null,ScreenShare:null},this.streamSubscriptions=new Map,this.deviceManagerSubscriptions=[],this.isNullAudioStream=!1}get currentMediaTypes(){return ct(this.streams).filter((e=>!!this.streams[e]))}get streams(){return this.mediaStreams}useNullAudioStreamClient(){this.isNullAudioStream=!0}async update(e,t){const i=ct(e).filter((t=>e[t]));return mt(i,this.currentMediaTypes)?(this.logger.safe.info("Requested modalities have not changed. Do nothing"),Gg(this.streams)):(this.logger.safe.info(`Starting media session with modalities: ${JSON.stringify(e)}`),await this.updateStreams(i,t),this.subscribeOnDeviceManagerEvents(),Gg(this.streams))}async stopAsync(){this.logger.safe.info("Stopping streams async"),this.stop()}stop(){this.logger.safe.info("Stopping streams"),this.unsubscribeFromDeviceManagerEvents(),ct(this.mediaStreams).forEach((e=>this.removeStreamByType(e)))}async ensureUpdateCompleted(){this.logger.safe.debug("streams updated")}dispose(){this.stop(),super.dispose()}async updateStreams(e,t){const i=this.getAvailableMediaTypes(),n=(0,UN.intersection)(e,i),r=ct(this.mediaStreams).filter((e=>this.mediaStreams[e])),s=t?[]:Tt(n,r),a=Tt(r,n);this.logger.safe.info(`Adding media streams for types: ${JSON.stringify(s)}`),await Promise.all(s.map((async e=>{await this.addStream(e,!1),this.mediaStreams[e]&&this.event("onStreamAdded").raise(e)}))),this.logger.safe.info(`Removing media streams for types: ${JSON.stringify(a)}`),a.forEach((e=>{this.event("onStreamRemoving").raise(e),this.removeStreamByType(e)}))}getAvailableMediaTypes(){const e=this.callDeviceManager.getDefaultDeviceManager().getSelectedDevices(),t=[];return e.microphone&&t.push("Audio"),e.camera&&t.push("Video"),t.push("ScreenShare"),t}async addStream(e,t){if(this.mediaStreams[e])return void this.logger.safe.warn(`Stream with type: ${e} is already registered`);const i=await this.getStream(e,t);this.subscribeOnMediaStreamEvents(i);try{await i.start()}catch(t){return this.logger.safe.error(`Media stream request error: ${JSON.stringify(t)}`),void this.event("onStreamError").raise(e,t)}this.mediaStreams[e]=i}removeStreamByType(e){const t=this.mediaStreams[e];t?(this.unsubscribeFromMediaStreamEvents(t),t.dispose(),this.mediaStreams[e]=null):this.logger.safe.warn(`Stream with type: ${e} is not registered`)}async updateStream(e,t,i=!1){i&&"Audio"===e?await this.updateStreamWithEffect(e):(this.removeStreamByType(e),await this.addStream(e,t)),this.event("onStreamUpdated").raise(e)}async updateStreamWithEffect(e){const t=this.mediaStreams[e];t&&this.unsubscribeFromMediaStreamEvents(t);const i=await this.getStreamByMediaType(e,!0);this.subscribeOnMediaStreamEvents(i);try{await i.start()}catch(t){return this.logger.safe.error(`updateStreamWithEffect. Media stream request error: ${JSON.stringify(t)}`),void this.event("onStreamError").raise(e,t)}this.mediaStreams[e]=i,t?.dispose()}subscribeOnMediaStreamEvents(e){if(this.streamSubscriptions.has(e))return;const t=[];t.push(e.on("onStreamClientError",((e,t)=>this.onStreamError(e,t)))),t.push(e.on("onStreamClientDisposing",(e=>this.onStreamDisposing(e)))),this.streamSubscriptions.set(e,t)}unsubscribeFromMediaStreamEvents(e){this.streamSubscriptions.has(e)&&(this.streamSubscriptions.get(e).forEach((e=>e.dispose())),this.streamSubscriptions.delete(e))}async getStream(e,t){const i=this.mediaStreams[e];return i?(this.logger.safe.info(`Stream exists with id: ${i.id}, type: ${e}`),i):this.getStreamByMediaType(e,t)}async getStreamByMediaType(e,t){switch(e){case"Audio":return this.isNullAudioStream?new VN("Audio",this.logger.createChild("NullStreamClient")):this.getDeviceManagerByType("Audio").getAudioStream(t,"sessionStream");case"Video":return this.getDeviceManagerByType("Video").getVideoStream(t,"sessionStream");case"ScreenShare":return this.getDeviceManagerByType("ScreenShare").getDisplayStream("sessionStream");default:throw new Error(`Media type is not supported: ${e}`)}}getMediaTypeForStream(e){const t=Object.keys(this.mediaStreams).find((t=>this.mediaStreams[t]===e));return t||this.logger.safe.error(`Media type is not found for stream: ${Ge(e)}`),t}subscribeOnDeviceManagerEvents(){if(0!==this.deviceManagerSubscriptions.length)return;if(this.callDeviceManager.isVirtualDeviceEnabled){const e=this.callDeviceManager.on("onSelectedVirtualDevicesChanged",((e,t)=>{const i=e;if(!e.camera){this.logger.info("Virtual DeviceID for camera is undefined, falling back to default device");const{camera:e}=this.callDeviceManager.getDefaultDeviceManager().getSelectedDevices();i.camera=e}this.callDeviceManager.isModalityEnabled("Video")&&t.camera!==i.camera&&(this.logger.info("Updating stream for camera"),this.updateStreamForVirtualDeviceChange("Video")),this.callDeviceManager.isModalityEnabled("ScreenShare")&&t.screenshare!==i.screenshare&&(this.logger.info("Updating stream for screenshare"),this.updateStreamForVirtualDeviceChange("ScreenShare"))}));this.deviceManagerSubscriptions.push(e)}const e=this.callDeviceManager.getDefaultDeviceManager();this.deviceManagerSubscriptions.push(e.on("onSelectedDevicesChanged",((e,t)=>this.onSelectedDevicesChanged(e,t))),e.on("onStreamUpdateRequested",((e,t)=>this.requestStreamUpdate(e,!1,t))),e.on("onAudioSharingToggled",(e=>this.onAudioSharingToggled(e))))}unsubscribeFromDeviceManagerEvents(){0!==this.deviceManagerSubscriptions.length&&(this.deviceManagerSubscriptions.forEach((e=>e.dispose())),this.deviceManagerSubscriptions=[])}getMediaTypesToUpdate(e,t){const i=[];return this.currentMediaTypes.some((e=>"Audio"===e))&&e.microphone&&e.microphone!==t.microphone&&i.push("Audio"),!this.callDeviceManager.getSelectedDevices().camera&&this.currentMediaTypes.some((e=>"Video"===e))&&e.camera&&e.camera!==t.camera&&i.push("Video"),i}removeStream(e){const t=this.getMediaTypeForStream(e);this.removeStreamByType(t)}async onSelectedDevicesChanged(t,i){if(this.configProvider.config.enablePermissionsWorkaround&&e.isDeviceListEmpty(t,i))return void this.logger.safe.info("Device list is empty, permission workaround enabled");const n=this.getMediaTypesToUpdate(t,i);this.logger.safe.info(`Media types to update: ${JSON.stringify(n)}`),await Promise.all(n.map((e=>this.updateStream(e,!1))))}async onAudioSharingToggled(e){if(this.configProvider.config.postponeAudioMixerForAudioSharing&&e)return this.updateStream("ScreenShare",!0)}async requestStreamUpdate(e,t,i=!1){if(this.currentMediaTypes.some((t=>t===e))||t)return this.logger.safe.debug(`UpdateStream with media type: ${e}, force: ${t}`),this.updateStream(e,t,i);this.logger.safe.debug(`Stream with media type: ${e} is not active. Do nothing`)}onStreamError(e,t){this.removeStream(e)}onStreamDisposing(e){this.removeStream(e)}static isDeviceListEmpty(e,t){return!e.camera&&!e.microphone||!t.microphone&&!t.camera}getDeviceManagerByType(e){return this.callDeviceManager.getDeviceManager(e)}async updateStreamForVirtualDeviceChange(e){return this.updateStream(e,!1)}};E([WA()],HN.prototype,"update",1),E([WA()],HN.prototype,"stopAsync",1),E([WA()],HN.prototype,"ensureUpdateCompleted",1),E([WA()],HN.prototype,"onSelectedDevicesChanged",1),E([WA()],HN.prototype,"onAudioSharingToggled",1),E([WA()],HN.prototype,"requestStreamUpdate",1),E([WA()],HN.prototype,"updateStreamForVirtualDeviceChange",1);var BN=HN,$N=i(496486),jN=[5e4,1e6,15e5,2e6,25e5,375e4,4e6],GN=[7e4,2e5,4e5,8e5,15e5,2499990,25e5],WN=class{constructor(e){this.logger=e,this.availableBandwidth=0,this.receivers=new Map,this.currentLayout={},this.ladders={}}setAvailableBandwidth(e){this.availableBandwidth=e,this.logger.safe.debug(`Total available bandwidth updated: ${e}`),this.updateLayouts()}addReceiverCapability(e,t){this.logger.safe.debug(`Receiver maxBr set: ${e}/${t}`),this.receivers.set(e,t),this.updateLayouts()}removeReceiver(e){this.logger.safe.debug(`Receiver maxBr removed: ${e}`),this.receivers.delete(e),this.updateLayouts()}getLayouts(){return this.currentLayout}setLadder(e,t){this.ladders[e]=t}updateLayouts(){const e=this.generateLayouts();(0,$N.isEqual)(e,this.currentLayout)||(this.currentLayout=e,this.logger.safe.debug(`Bandwidth distribution updated: ${Ge(e)}`))}generateLayouts(){const e={},t={};for(const i of Object.keys(this.ladders)){const n=this.receivers.get(i);n&&(t[i]=n||Number.MAX_SAFE_INTEGER,e[i]=0)}let i=this.availableBandwidth,n=0;const r=()=>{if(!i)return!1;for(const e of Object.values(t))if(e)return!0;return!1};for(;r();){for(const r of Object.keys(e)){const s=this.ladders[r];let a=s[n]||s[s.length-1];a=Math.min(a,i,t[r]),e[r]+=a,i-=a,t[r]-=a}n++}return e}},qN=class{constructor(e,t,i){this.timeout=t,this.logger=i,this.isFirstTimeDeferred=!0,this.internalCallback=t=>{this.logger.safe.debug(`Trigger reason: ${t}`),e()}}invoke(e){if(this.logger.safe.debug(`Schedule shouldDefer: ${e}`),this.createTimerIfNeeded(e),this.timer)return e?this.startTimer():this.stopTimerAndTrigger();this.internalCallback("request")}dispose(){this.stopTimer()}startTimer(){this.timer.isActive||(this.timer.start(this.timeout),this.logger.safe.debug(`Timer started for : ${this.timeout}ms`))}stopTimer(){this.timer?.isActive&&(this.timer.stop(),this.logger.safe.debug("Timer stopped"))}stopTimerAndTrigger(){this.stopTimer(),this.internalCallback("request")}createTimerIfNeeded(e){e&&this.isFirstTimeDeferred&&(this.isFirstTimeDeferred=!1,this.timer=new hm((()=>{this.internalCallback("timeout"),this.timer=null})))}},zN=class{constructor(e){this.logger=e,this.currentFrameSize=NI.Send.initialResolution.fs}setAvailableBandwidth(e){e!==this.lastSendBW&&(this.logger.safe.debug(`Available bandwidth updated ${e}`),this.processEstimatedBandwidth(e))}setMaxFrameSize(e){this.logger.safe.debug(`SetMaxFrameSize ${e}`),e!==this.maxFrameSize?(this.maxFrameSize=e,this.lastSendBW?(this.logger.safe.debug(`Setting max frame size: ${e}`),this.processEstimatedBandwidth(this.lastSendBW)):this.logger.safe.debug("Last send bwe is not defined. Do nothing")):this.logger.safe.debug(`Max frame size did not change. Do nothing, maxFs: ${e}`)}getFrameSize(){return this.currentFrameSize}processEstimatedBandwidth(e){if(this.logger.safe.debug(`Process estimated bandwidth ${e}`),0===e)return this.lastSendBW=0,void this.proposeResolution(0);const{lowRes:t,highRes:i}=NI.Send.getResolutionForBitrate(e);this.logger.safe.debug("low",t,"hi",i);const n=e<this.lastSendBW?i.fs:t.fs;e<this.lastSendBW&&this.currentFrameSize<n?this.logger.safe.debug(`proposed resolution is above the existing one, so we should stay on the current resolution, last bw: ${e}`):(n&&this.proposeResolution(n),this.logger.safe.debug(`Updating last bw: ${e}`),this.lastSendBW=e)}proposeResolution(e){this.logger.safe.debug(`Propose resolution ${e}`);const t=this.maxFrameSize?Math.min(e,this.maxFrameSize):e;t!==this.currentFrameSize&&(this.currentFrameSize=t,this.logger.safe.debug(`Proposed new frame size: ${t} based on bandwidth: ${this.lastSendBW}`))}},KN=[{bwe:2e5,param:5e5},{bwe:5e5,param:12e5},{bwe:8e5,param:25e5},{bwe:12e5,param:4e6}],JN=[{bwe:2e5,param:240},{bwe:3e5,param:405},{bwe:5e5,param:920},{bwe:9e5,param:2040}],YN=(e,t,i)=>{for(const n of i)if(t<n.bwe)return Math.min(e,n.param);return e},QN=(e,t,i=KN)=>YN(e,t,i),XN=class extends Qe{constructor(e,t,i){super(t),this.configProvider=e,this.logger=t,this.layoutsNumber=i,this.totalBandwidth=1e8,this.totalBandwidthMax=0,this.logger.safe.debug("Created")}dispose(){this.logger.safe.debug("Disposed"),this.outputLayouts=null,super.dispose()}setAvailableBandwidth(e){this.storeAvailableBandwidth(e),this.inputLayouts?(this.recalculateLayouts(),this.checkForChangesAndNotify()):this.logger.safe.debug("Layouts are not set. Skip update")}setLayouts(e,t){this.storeAvailableBandwidth(t),e.length===this.layoutsNumber?(this.logger.safe.debug(`Set layouts: ${JSON.stringify(e)}`),this.inputLayouts=this.getPrioritizedLayouts(e),this.recalculateLayouts(),this.checkForChangesAndNotify()):this.logger.safe.warn(`Incorrect number of layouts! ${JSON.stringify(e)}, expected ${this.layoutsNumber}`)}getLayouts(){return this.inputLayouts}getPrioritizedLayouts(e){return e}checkForChangesAndNotify(){const e=this.getLayouts();mt(this.outputLayouts,e)?this.logger.safe.debug("Layout has not changed, skip update"):(this.outputLayouts=e.slice(),this.event("onLayoutsChanged").raise())}storeAvailableBandwidth(e){this.logger.safe.debug(`Set available bandwidth: ${e}`),this.totalBandwidth=e,this.totalBandwidthMax=Math.max(this.totalBandwidthMax,this.totalBandwidth)}},ZN=class extends XN{constructor(e,t){super(e,t,2),this.resolutionManager=new zN(this.logger.createChild("BWEControlledResolutionManager"))}getLayouts(){return this.hiFiLayout?[this.loFiLayout,this.hiFiLayout]:[this.loFiLayout]}dispose(){super.dispose(),this.resolutionManager=null}getHighLayoutBandwidth(e){const t=this.inputLayouts?.[0].maxBr||0,i=Math.max(e-t,0);this.logger.safe.debug(`Setting available bandwidth for layouts. High: ${i}, low: ${t||"not set"}, total: ${e}`);const n=this.configProvider.config.specCompliantSimulcast?.allowedBweOvershootRatio||1;return Math.floor(i*n)}recalculateLayouts(){const e=this.hiFiLayout,t=this.getHighLayoutBandwidth(this.totalBandwidth);this.resolutionManager.setAvailableBandwidth(t),this.resolutionManager.setMaxFrameSize(this.inputLayouts[1].maxFs),this.loFiLayout=this.getMinimalLayoutParams(this.inputLayouts),this.hiFiLayout=this.getHighLayoutParams(this.inputLayouts,t,this.loFiLayout),this.loFiLayout=this.adjustLowLayoutBasedOnHighLayout(this.hiFiLayout,this.loFiLayout,e)}adjustLowLayoutBasedOnHighLayout(e,t,i){return this.configProvider.config.useMediaQualityControllerForceKeyFrame&&!e&&i&&(this.logger.safe.debug("Forcing kayframe on low layout due to disabling high layout"),t.keyframe=!0),e?(t.maxBr===e.maxBr&&t.maxBr--,t):t}getPrioritizedLayouts(e){return e.sort(((e,t)=>e.maxFs-t.maxFs?e.maxFs-t.maxFs:e.maxFps-t.maxFps))}getHighLayoutParams(e,t,i){const n=e[1];if(n.maxBr<=t)return this.logger.safe.debug(`High layout bandwidth suits requested caps. Applying as-is: ${JSON.stringify(n)}`),n;const r={...e[1],maxFs:this.resolutionManager.getFrameSize(),maxBr:Math.min(t,e[1].maxBr),maxFps:e[1].maxFps},s=r.maxBr<i.maxBr||r.maxFs<i.maxFs||r.maxFs===i.maxFs&&r.maxFps<=i.maxFps,a=`Potential high layout: ${JSON.stringify(r)}`;return!this.hiFiLayout&&s?(this.logger.safe.debug(`High layout is already disabled. Do nothing. ${a}`),null):this.hiFiLayout&&s?(this.logger.safe.debug(`High layout gets disabled. ${a}`),null):(this.hiFiLayout&&mt(r,this.hiFiLayout)?this.logger.safe.debug(`High layout has not been changed. Do nothing. ${a}`):this.hiFiLayout?this.logger.safe.debug(`High layout updated. ${a}`):this.logger.safe.debug(`High layout enabled. ${a}`),r)}getMinimalLayoutParams(e){const t=Math.min(e[0].maxBr,e[1].maxBr),i=this.configProvider.config.specCompliantSimulcast.maxBrControlEnabled?QN(t,this.totalBandwidth,this.configProvider.config.specCompliantSimulcast.bitrateToBweTable):t;return{...e[0],maxBr:i,maxFps:Math.min(e[0].maxFps,e[1].maxFps),maxFs:Math.min(e[0].maxFs,e[1].maxFs)}}},eL=class extends XN{constructor(e,t,i){super(t,i,1),this.couldLimitFs=e}getLayouts(){return[this.layout]}recalculateLayouts(){let e=this.inputLayouts[0].maxFs;if(this.configProvider.config.specCompliantSimulcast.allowResLimit&&this.couldLimitFs&&this.totalBandwidthMax){const t=this.configProvider.config.specCompliantSimulcast.fsToBweTable;e=((e,t,i=JN)=>YN(e,t,i))(this.inputLayouts[0].maxFs,this.totalBandwidthMax,t)}const t=this.configProvider.config.specCompliantSimulcast.bitrateToBweTable,i=QN(this.inputLayouts[0].maxBr,this.totalBandwidth,t);this.layout={...this.inputLayouts[0],maxFs:e,maxBr:i}}},tL=class extends Qe{constructor(e){super(e),this.logger=e,this.logger.safe.debug("Created")}dispose(){this.logger.safe.debug("Disposed"),super.dispose()}setAvailableBandwidth(e){this.logger.safe.debug(`Available bandwidth updated ${e}`)}setLayouts(e,t){this.layouts=e,this.setAvailableBandwidth(t)}getLayouts(){return this.layouts}},iL=class extends Qe{constructor(e,t,i,n){super(n),this.supportSingleBwControl=e,this.configProvider=i,this.logger=n,this.multiStream=!1,this.deferredOperation=new qN((()=>this.updateStrategy()),this.configProvider.config.layoutControlTimeout,this.logger.createChild("DeferredOperation")),this.createStrategy(this.multiStream,t)}configure(e){const t=this.isMultiStream(e);this.multiStream!==t&&(this.multiStream=t,this.deferredOperation.invoke(this.multiStream&&!this.configProvider.config.specCompliantSimulcast?.maxBrControlEnabled))}setLayouts(e,t){mt(this.latestLayouts,e)&&this.latestBandwidth===t?this.logger.safe.debug("Layouts and bandwidth are not changed. Skipping update"):(this.latestLayouts=e,this.latestBandwidth=t,this.strategy.setLayouts(this.latestLayouts,t))}setAvailableBandwidth(e){this.latestBandwidth!==e?(this.strategy.setAvailableBandwidth(e),this.latestBandwidth=e):this.logger.safe.debug("Bandwidth is not changed. Skipping update")}getLayouts(){return this.strategy.getLayouts()}dispose(){this.strategy.dispose(),this.strategy=null,this.deferredOperation.dispose(),this.deferredOperation=null,super.dispose()}updateStrategy(){this.strategy.dispose(),this.createStrategy(this.multiStream),this.latestLayouts&&this.strategy.setLayouts(this.latestLayouts,this.latestBandwidth)}isMultiStream(e){return e>1}createStrategy(e,t=!1){this.strategy=this.getNewStrategy(e,t),this.strategy.on("onLayoutsChanged",(()=>{this.event("onLayoutsChanged").raise()}))}getNewStrategy(e,t){return e?new ZN(this.configProvider,this.logger.createChild("BWEControlledStrategy")):this.configProvider.config.specCompliantSimulcast?.maxBrControlEnabled&&this.supportSingleBwControl?new eL(t,this.configProvider,this.logger.createChild("BWEControlledStrategySingle")):new tL(this.logger.createChild("NoControlStrategy"))}},nL=class extends Qe{constructor(e,t){super(t),this.configProvider=e,this.logger=t,this.bandwidthAllocator=null,this.sendBandwidthCalculator=new rN(this.configProvider,this.logger.createChild("SendBandwidthCalculator")),this.layoutProviders=new Map,this.hadLayoutProvider=new Set,this.bandwidthAllocator=function(e,t){const i=new WN(e.createChild("BandwidthAllocator"));return i.setLadder("ScreenShare",t.config.sharingBitrateLadderOverride||jN),i.setLadder("Video",t.config.videoBitrateLadderOverride||GN),i}(this.logger,this.configProvider),this.sendBandwidthCalculator.on("onSendBandwidthChanged",(e=>this.onAvailableBandwidthChanged(e)))}dispose(){this.bandwidthAllocator=null,this.layoutProviders.forEach((e=>e.dispose())),this.layoutProviders.clear(),this.layoutProviders=null,super.dispose()}addReceiver(e,t){this.logger.safe.debug(`Set receiver max capabilities for ${e}: ${JSON.stringify(t)}`),this.configureProviders(e,t.length);const i=t.map((e=>e.maxBr)).reduce(((e,t)=>e+t));this.bandwidthAllocator.addReceiverCapability(e,i);const n=this.bandwidthAllocator.getLayouts();this.layoutProviders.get(e).setLayouts(t,n[e]),this.updateBandwidthDistribution()}removeReceiver(e){this.logger.safe.debug(`Removing receiver for ${e}`),this.layoutProviders.get(e)?.dispose(),this.layoutProviders.delete(e),this.bandwidthAllocator.removeReceiver(e),this.updateBandwidthDistribution()}getLayouts(e){return this.layoutProviders.get(e).getLayouts()}onStatisticsChanged(e){this.sendBandwidthCalculator.onBandwidthChanged(e.estimatedSendBandwidth)}onDiagnosticUpdated(e){e.video?.send?.length&&e.video?.send[0]&&this.sendBandwidthCalculator.onBandwidthChanged(nN(e.video.send[0],this.configProvider))}configureProviders(e,t){if(!this.layoutProviders.has(e)){const t=this.createProvider(e);this.layoutProviders.set(e,t)}this.layoutProviders.get(e).configure(t)}createProvider(e){const t=new iL("Video"===e,!this.hadLayoutProvider.has(e),this.configProvider,this.logger.createChild(`LG:${e}`));return t.on("onLayoutsChanged",(()=>{const i=t.getLayouts();this.logger.safe.debug(`New layouts generated: ${JSON.stringify(i)}`),this.event("onLayoutsUpdated").raise(e)})),this.hadLayoutProvider.add(e),t}onAvailableBandwidthChanged(e){this.bandwidthAllocator.setAvailableBandwidth(e),this.updateBandwidthDistribution()}updateBandwidthDistribution(){const e=this.bandwidthAllocator.getLayouts();for(const[t,i]of Object.entries(e))this.layoutProviders.get(t)?.setAvailableBandwidth(i)}},rL=i(496486);function sL(e,t,i){if("Video"!==e||!i)return i;const{maxBitrate:n,maxResolution:r,maxFramerate:s}=t.config.outgoingVideoLimit??{},a=n??1/0,o=r?(l=r,NI.Send.getResolutionForHeight(l).fs):1/0;var l;const d=s??1/0;return a===1/0&&o===1/0&&d===1/0?i:i.map((e=>({...e,maxFs:st(e.maxFs,o),maxBr:st(e.maxBr,a),maxFps:st(e.maxFps,d)})))}var aL=class{constructor(e,t,i,n,r){this.sender=e,this.streamResolution=t,this.maxSimulcastLayerCount=i,this.logger=n,this.configProvider=r}async setCapabilities(e){if(!(0,rL.isEqual)(this.currentCapabilities,e))return this.defaultCapabilities=(0,rL.cloneDeep)(e),this.currentCapabilities=(0,rL.cloneDeep)(e),await this.generateKeyFrameIfNeeded(e),this.applyCapabilities(e,0);this.logger.safe.info(`Capabilities already applied: ${JSON.stringify(e)}. Do nothing`)}async updateStreamQualityParams(e,t,i){if(e&&!(0,rL.isEqual)(this.streamResolution,e))return this.logger.safe.debug(`Stream params changed: ${JSON.stringify(e)}@${t}`),this.streamResolution=e,this.applyCapabilities(this.currentCapabilities,i);this.logger.safe.debug(`Resolution is not defined or same: ${JSON.stringify(e)}@${t}`)}async stop(){return this.logger.safe.info("Stopping senders."),this.deactivateSenders()}applyCallConstraints(e){return this.logger.safe.info(`[${e}] Applying call constraints`),this.currentCapabilities=sL(this.sender.mediaType,this.configProvider,this.defaultCapabilities),this.applyCapabilities(this.currentCapabilities,3)}getScaleFactor(e){const t=NI.Send.getResolutionByFs(e),i=this.streamResolution;let n=Math.min(i.width,i.height)/t.height;return this.logger.safe.debug(`Scale factor is taken from resolution: ${JSON.stringify(i)} and new Fs: ${e} as ${n}`),n<1&&(this.logger.safe.error("Scale factor cannot be less than 1! Limiting to 1"),n=1),n}deactivateSenders(){const e=this.sender.rtpSender.getParameters();return e.encodings.forEach((e=>e.active=!1)),this.logger.safe.info(`Stopping senders. Encoding params to set: ${JSON.stringify(e.encodings)}`),this.sender.rtpSender.setParameters(e)}async generateKeyFrameIfNeeded(e){const t=this.sender.rtpSender.getParameters(),i=[];if(e.forEach((e=>{const n=this.getEncondingIndexForRid(e.rid,t.encodings),r=t.encodings[n];e.keyframe&&r.active?(this.logger.safe.info(`Keyframe is needed for encoder with index ${n}`),i.push(n)):this.logger.safe.info(`Keyframe is not needed for index ${n} because encoding is active: ${r.active} or KF is requested: ${e.keyframe}`)})),0===i.length)return void this.logger.safe.info("No keyframes needed. Skipping");const n=this.getParamsForKeyFrame(t,i);return this.logger.safe.info(`Applying keyframe encoding params new: ${JSON.stringify(n.encodings)}, old: ${JSON.stringify(t.encodings)}`),this.sender.rtpSender.setParameters(n)}async applyCapabilities(e,t){if(!e)return void this.logger.safe.info("Capabilities are not set. Do nothing");await this.applyStreamCapabilities(e,t);const i=this.sender.rtpSender.getParameters(),n=(0,rL.cloneDeep)(i);return e.forEach((e=>{const t=this.getEncondingIndexForRid(e.rid,i.encodings);this.updateEncodingsWithCaps(i.encodings[t],e)})),this.updateActiveStates(i,e),this.logger.safe.info(`Encoding params new: ${JSON.stringify(i.encodings)}, old: ${JSON.stringify(n.encodings)}`),this.sender.rtpSender.setParameters(i)}async applyStreamCapabilities(e,t){if(!this.configProvider.config.specCompliantSimulcast?.video?.useApplyConstraints||2===t||!e.length||"Video"!==this.sender.mediaType)return;let i=e[0];for(const t of e)i.maxFs<t.maxFs&&(i=t);e.length>1&&(i=(0,rL.cloneDeep)(i),i.maxFs=Math.max(this.configProvider.config.specCompliantSimulcast.video.minFsForSimulcast||0,i.maxFs)),this.streamResolution=await this.sender.applyStreamCapabilities(i)}getEncondingIndexForRid(e,t){if(!e)return this.logger.safe.error("No RID found in incoming params. Returning index 0"),0;const i=t.findIndex((t=>t.rid===e));return i<0||i-1>this.maxSimulcastLayerCount?(this.logger.safe.error("Incorrect index deduced from requested RID. Returning index 0"),0):i}updateEncodingsWithCaps(e,t){e?(e.maxBitrate=t.maxBr,e.scaleResolutionDownBy=this.getScaleFactor(t.maxFs),e.maxFramerate=t.maxFps):this.logger.safe.error(`SenderParams does not exist for caps: ${JSON.stringify(t)}`)}updateActiveStates(e,t){const i=e.encodings.map((e=>e.rid)),n=i.filter((e=>t.some((t=>e===t.rid)))),r=Tt(i,n);n.forEach((t=>this.changeEncodingState(e,t,!0))),r.forEach((t=>this.changeEncodingState(e,t,!1)))}changeEncodingState(e,t,i){const n=e.encodings.find((e=>e.rid===t));n?n.active=i:this.logger.safe.error(`Encoding not found for RID: ${t}`)}getParamsForKeyFrame(e,t){const i=(0,rL.cloneDeep)(e);return t.forEach((e=>{i.encodings[e].active&&i.encodings[e].scaleResolutionDownBy&&(i.encodings[e]=this.getEncodingParamsForKeyFrame(i.encodings[e]))})),i}getEncodingParamsForKeyFrame(e){const t=(0,rL.cloneDeep)(e);return t.scaleResolutionDownBy&&(t.scaleResolutionDownBy=1.1*e.scaleResolutionDownBy),t}},oL=class{constructor(e,t,i){this.sender=e,this.logger=t,this.configProvider=i}applyCallConstraints(e){this.logger.safe.info(`[${e}] Applying call constraints`);const t=sL(this.sender.mediaType,this.configProvider,this.currentCapabilities);return this.setCapabilities(t)}async setCapabilities(e){if(0===e.length||1!==e.length)return void this.logger.safe.error("Incorrect number of sender params!");this.currentCapabilities=e;const t=this.currentCapabilities?.find((e=>"1"===e.rid))??this.currentCapabilities?.[0];await this.sender.setParameters(t),await this.sender.start()}updateStreamQualityParams(e,t,i){return this.sender.updateStreamQualityParams(e,t,i)}async stop(){await this.sender.stop()}},lL=i(496486),dL=new Set(["maintain-framerate","maintain-resolution","balanced"]),cL=class{constructor(e,t){this.configProvider=e,this.logger=t}async setActive(e,t){const i=this.getSenderParameters(e);return i.encodings[0].active=t,this.setSenderParameters(e,i,"setActive")}getScaleFactor(e,t){if(!t.width||!t.height)return this.logger.safe.warn("Stream resolution is not set yet. Cannot calculate scale factor. Returning 1"),1;const i=NI.Send.getResolutionByFs(e);let n=Math.min(t.width,t.height)/i.height;return this.logger.safe.debug(`Scale factor is taken from resolution: ${JSON.stringify(t)} and new Fs: ${e} as ${n}`),n<1&&(this.logger.safe.warn("Scale factor cannot be less than 1! Limiting to 1"),n=1),n}async generateKeyFrameIfNeeded(e,t){if(!t.track)return void this.logger.safe.info("No track attached. Skipping");const i=this.getSenderParameters(t),n=e.filter((e=>e.keyframe)).map((e=>e.rid));if(0!==n.length&&i.encodings.some((e=>e.active)))if(this.configProvider.config.useKeyFrameApi){const e=[];i.encodings.forEach((t=>{!t.active||t.rid&&!n.includes(t.rid)?e.push({keyFrame:!1}):e.push({keyFrame:!0})})),await this.setSenderParameters(t,i,"generateKeyFrameAPI",!0,{encodingOptions:e})}else{const e=i.encodings.map(((e,t)=>e.active?e.rid&&!n.includes(e.rid)?null:{idx:t,factor:e.scaleResolutionDownBy||1}:null)).filter((e=>e));for(const t of e)i.encodings[t.idx].scaleResolutionDownBy=t.factor*this.configProvider.config.forceKeyFrameV2ScaleFactor;this.logger.safe.debug(`Restoring keyframe starting. Update scaleResolutionDownBy for encodings: ${JSON.stringify(i.encodings)}`),await this.setSenderParameters(t,i,"generateKeyFrameStart");const r=this.getSenderParameters(t);for(const t of e)r.encodings[t.idx].scaleResolutionDownBy=t.factor;await this.setSenderParameters(t,r,"generateKeyFrameEnd"),this.logger.safe.debug(`Restoring keyframe completed. Set scaleResolutionDownBy back for encodings: ${JSON.stringify(r.encodings)}`)}else this.logger.safe.info("No keyframes needed. Skipping")}getSenderParameters(e){const t=e.getParameters();if(t.encodings?.length||(t.encodings=[{}]),this.configProvider.config.reuseLastSetParameters&&this.lastSetEncodings){this.logger.safe.info(`Override returned encodings ${JSON.stringify(t.encodings)}`);const e=(0,lL.merge)((0,lL.cloneDeep)(t.encodings),this.lastSetEncodings);this.logger.safe.info(`Overrided encodings ${JSON.stringify(e)}`),t.encodings=e}return t}async setSenderParameters(e,t,i,n=!0,r){try{await e.setParameters(t,r),this.logger.safe.info(`${i}: Parameters applied for sender: encodings: ${JSON.stringify(t.encodings)}, degradationPreference: ${t.degradationPreference}`),this.lastSetEncodings=t.encodings}catch(e){const r=`${i}: setParameters failed. Parameters: ${JSON.stringify(t.encodings)}, error:  ${Ge(e)}`;if(this.logger.safe.error(r),n)throw new Error(r)}}getAdjustedBitrate(e,t){let i=e||0;const n=NI.Send.getResolutionRecord(t.width,t.height);return i=Math.min(i||n.maxBitrate,n.maxBitrate),i}async updateStreamParameters(e,t,i){if(e.getCurrentConstraints().withEffect&&t?.maxFs){const i=NI.Send.getResolutionByFs(t.maxFs),n={width:i.width,height:i.height};this.logger.safe.info(`Applying video constrains for video effetcs ${JSON.stringify(n)}`),e.resetEffectsOutputConstraints(n)}i&&await e.applyCapabilities(t)}augmentDegradationPreference(e,t){dL.has(t)&&e.degradationPreference!==t&&(e.degradationPreference=t,this.logger.safe.info(`degradationPreference changed to: ${e.degradationPreference}`))}},hL=class{constructor(e,t,i){this.maxSimulcastLayerCount=e,this.configProvider=t,this.logger=i,this.capabiltiesHelper=new cL(this.configProvider,this.logger)}setSender(e){this.rtpSender=e}updateStream(e){this.stream=e,this.streamResolution=e.getResolution()}setActive(e){return this.capabiltiesHelper.setActive(this.rtpSender,e)}async setCapabilities(e){(0,lL.isEqual)(this.currentCapabilities,e)?this.logger.safe.info(`Capabilities already applied: ${JSON.stringify(e)}. Do nothing`):(this.defaultCapabilities=(0,lL.cloneDeep)(e),this.currentCapabilities=(0,lL.cloneDeep)(e),await this.applyLastCapabilities(),await this.capabiltiesHelper.generateKeyFrameIfNeeded(e,this.rtpSender))}async updateStreamQualityParams(e,t,i){if(e&&!(0,lL.isEqual)(this.streamResolution,e))return this.streamResolution=e,this.logger.safe.debug(`Stream params changed: ${JSON.stringify(e)}@${t}`),this.applyLastCapabilities();this.logger.safe.debug(`Resolution is not defined or same: ${JSON.stringify(e)}@${t}`)}async startSender(){}async stopSender(){this.logger.safe.info("Stopping senders.");const e=this.capabiltiesHelper.getSenderParameters(this.rtpSender);return e.encodings.forEach((e=>e.active=!1)),this.capabiltiesHelper.setSenderParameters(this.rtpSender,e,"Stopping senders")}async applyLastCapabilities(){if(!this.currentCapabilities)return void this.logger.safe.info("Capabilities are not set. Do nothing");this.currentCapabilities=sL(this.stream.mediaType,this.configProvider,this.defaultCapabilities),await this.applyStreamCapabilities(this.currentCapabilities);const e=this.capabiltiesHelper.getSenderParameters(this.rtpSender),t=(0,lL.cloneDeep)(e);return this.currentCapabilities.forEach((t=>{const i=this.getEncondingIndexForRid(t.rid,e.encodings);this.updateEncodingsWithCaps(e.encodings[i],t)})),this.capabiltiesHelper.augmentDegradationPreference(e,this.configProvider.config.degradationPreference),this.updateActiveStates(e,this.currentCapabilities),this.logger.safe.info(`Encoding params new: ${JSON.stringify(e.encodings)}, old: ${JSON.stringify(t.encodings)}`),this.capabiltiesHelper.setSenderParameters(this.rtpSender,e,"applyCapabilities")}async applyCallConstraints(e){return this.logger.safe.info(`[${e}] Applying call constraints`),this.applyLastCapabilities()}async applyStreamCapabilities(e){if("Video"!==this.stream.mediaType||!e.length)return;let t=e[0];for(const i of e)t.maxFs<i.maxFs&&(t=i);e.length>1&&(t=(0,lL.cloneDeep)(t),t.maxFs=Math.max(this.configProvider.config.specCompliantSimulcast.video.minFsForSimulcast||0,t.maxFs));const i=this.configProvider.config.specCompliantSimulcast.video.useApplyConstraints;await this.capabiltiesHelper.updateStreamParameters(this.stream,t,i),i&&(this.streamResolution=this.stream.getResolution())}getEncondingIndexForRid(e,t){if(!e)return this.logger.safe.error("No RID found in incoming params. Returning index 0"),0;const i=t.findIndex((t=>t.rid===e));return i<0||i-1>this.maxSimulcastLayerCount?(this.logger.safe.error("Incorrect index deduced from requested RID. Returning index 0"),0):i}updateEncodingsWithCaps(e,t){e?(e.maxBitrate=t.maxBr,e.scaleResolutionDownBy=this.capabiltiesHelper.getScaleFactor(t.maxFs,this.streamResolution),e.maxFramerate=t.maxFps):this.logger.safe.error(`SenderParams does not exist for caps: ${JSON.stringify(t)}`)}updateActiveStates(e,t){const i=e.encodings.map((e=>e.rid)),n=i.filter((e=>t.some((t=>e===t.rid)))),r=Tt(i,n);n.forEach((t=>this.changeEncodingState(e,t,!0))),r.forEach((t=>this.changeEncodingState(e,t,!1)))}changeEncodingState(e,t,i){const n=e.encodings.find((e=>e.rid===t));n?n.active=i:this.logger.safe.error(`Encoding not found for RID: ${t}`)}},uL=class{constructor(e,t){this.configProvider=e,this.logger=t,this.capabiltiesHelper=new cL(this.configProvider,this.logger)}get params(){return this.currentCapabilities?.find((e=>"1"===e.rid))??this.currentCapabilities?.[0]}async applyCallConstraints(e){return this.logger.safe.info(`[${e}] Applying call constraints`),this.applyLastCapabilities(3)}setSender(e){this.rtpSender=e}updateStream(e){this.stream=e,this.streamResolution=e.getResolution()}setActive(e){return this.capabiltiesHelper.setActive(this.rtpSender,e)}async setCapabilities(e){(0,lL.isEqual)(this.currentCapabilities,e)?this.logger.safe.info(`Capabilities already applied: ${JSON.stringify(e)}. Do nothing`):1===e.length?(this.defaultCapabilities=(0,lL.cloneDeep)(e),this.currentCapabilities=(0,lL.cloneDeep)(e),await this.applyLastCapabilities(0),await this.capabiltiesHelper.generateKeyFrameIfNeeded(e,this.rtpSender)):this.logger.safe.error("Incorrect number of sender params!")}async updateStreamQualityParams(e,t,i){if(e&&!(0,lL.isEqual)(this.streamResolution,e))return this.streamResolution=e,this.logger.safe.debug(`Stream params changed: ${JSON.stringify(e)}@${t}`),this.applyLastCapabilities(i);this.logger.safe.debug(`Resolution is not defined or same: ${JSON.stringify(e)}@${t}`)}async startSender(e){this.logger.safe.info(`Replace sender with track: ${e.id}`),await this.rtpSender.replaceTrack(e),this.logger.safe.info("replaceTrack completed"),this.configProvider.config.applySenderParamsBeforeStart&&this.currentCapabilities&&await this.capabiltiesHelper.generateKeyFrameIfNeeded(this.currentCapabilities,this.rtpSender)}async stopSender(){this.logger.safe.info("Replace sender with track: null"),await this.rtpSender.replaceTrack(null),this.logger.safe.info("replaceTrack completed")}async applyLastCapabilities(e){this.currentCapabilities?(this.currentCapabilities=sL(this.stream.mediaType,this.configProvider,this.defaultCapabilities),this.logger.safe.info(`Applying params: ${JSON.stringify(this.params)}`),await this.applyParams(this.params,e),await this.applyBitrate(this.params.maxBr)):this.logger.safe.debug("Capabilities are not yet set, nothing to apply")}applyBitrate(e){let t=e||0;return"Video"===this.stream.mediaType&&(t=this.capabiltiesHelper.getAdjustedBitrate(t,this.streamResolution)),this.setSingleEncodingParameters(this.rtpSender,{maxBitrate:t},"applyBitrate",!1)}async applyParams(e,t){if(this.configProvider.config.useSetParametersToApplyCapabilities)return this.setSingleEncodingParameters(this.rtpSender,{scaleResolutionDownBy:this.capabiltiesHelper.getScaleFactor(e.maxFs,this.streamResolution),maxFramerate:e.maxFps},"applyParams");2!==t&&await this.capabiltiesHelper.updateStreamParameters(this.stream,e,!0)}async setSingleEncodingParameters(e,t,i,n=!0){const r=this.capabiltiesHelper.getSenderParameters(e);return(0,lL.merge)(r.encodings[0],t),0===r.encodings[0].maxBitrate&&(this.configProvider.config.setParametersMaxBitrateUndefined?r.encodings[0].maxBitrate=void 0:delete r.encodings[0].maxBitrate),this.capabiltiesHelper.augmentDegradationPreference(r,this.configProvider.config.degradationPreference),this.capabiltiesHelper.setSenderParameters(this.rtpSender,r,i,n)}},pL=class{constructor(e,t,i){this.transitionStates=e,this.logger=i,this.stateInternal=t}get state(){return this.stateInternal}isDestinationStateValid(e){return this.transitionStates[this.stateInternal].indexOf(e)>-1}setState(e){return this.isDestinationStateValid(e)?(this.stateInternal=e,!0):(this.logger.safe.info(`Invalid state transition ${this.stateInternal} -> ${e}`),!1)}isCurrentStateMatchedWith(e){return this.stateInternal===e||(this.logger.safe.info(`State does not match. Current: ${this.stateInternal} required: ${e}`),!1)}},gL=i(496486),mL=class{constructor(e,t=document.body){this.logger=e,this.parentElement=t,this.container=this.createContainerElement(),this.video=this.createVideoElement(),this.canvas=this.createCanvasElement(),this.context=this.canvas.getContext("2d"),this.medaiQuery=window.matchMedia("(orientation: portrait)"),this.isPortrait=this.medaiQuery.matches,this.captureFrameRate=30,this.mediaQueryChangeListener=e=>{this.isPortrait=e.matches},this.container.append(this.video,this.canvas),this.parentElement.prepend(this.container),this.medaiQuery.addEventListener("change",this.mediaQueryChangeListener)}modify(e){this.logger.safe.info("modify()"),this.clearAnimationFrames(),this.disposeStream(),this.stream=this.canvas.captureStream(this.captureFrameRate),this.video.srcObject=new MediaStream([e]),this.video.play();let t=e.getSettings(),i=0,n=0;const r=()=>{t=e.getSettings();const s=this.isPortrait?Math.min(t.width,t.height):Math.max(t.width,t.height),a=this.isPortrait?Math.max(t.width,t.height):Math.min(t.width,t.height);i===s&&n===a||(this.canvas.width=s,this.canvas.height=a,i=s,n=a),this.context.drawImage(this.video,0,0,s,a),this.animationFrame=requestAnimationFrame(r)};return this.animationFrame=requestAnimationFrame(r),this.stream.getVideoTracks()[0]}dispose(){this.logger.safe.info("dispose()"),this.clearAnimationFrames(),this.disposeStream(),this.container.parentElement.removeChild(this.container),this.medaiQuery.removeEventListener("change",this.mediaQueryChangeListener)}disposeStream(){this.stream&&(this.stream.getTracks().forEach((e=>e.stop())),this.stream=void 0)}createContainerElement(){const e=document.createElement("div");return e.style.opacity="0",e.style.position="fixed",e.style.zIndex="-2147483648",e.style.pointerEvents="none",e.style.top="0",e.style.left="0",e.style.bottom="0",e.style.right="0",e}createVideoElement(){const e=document.createElement("video");return e.setAttribute("muted",""),e.setAttribute("playsinline",""),e.setAttribute("autoplay",""),e.style.top="0",e.style.left="0",e}createCanvasElement(){const e=document.createElement("canvas");return e.style.right="0",e.style.bottom="0",e}clearAnimationFrames(){this.logger.safe.info("clearAnimationFrames()"),this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.animationFrame=void 0)}},fL=class extends Qe{constructor(e){super(e),this.logger=e,this.audioContext=new yg.window.AudioContext,this.destination=this.audioContext.createMediaStreamDestination(),this.streamNodeMap=new Map,this.logger.safe.info(`Destination stream: ${this.destination.stream.id}, track: ${this.getDestinationTrack().id}`),this.subscribeOnMediaTrackEvents(this.getDestinationTrack())}get numberOfStreams(){return this.streamNodeMap.size}addSourceStream(e){if(!e.rawStream)return;if(this.streamNodeMap.has(e.rawStream))return;const t=e.on("onStreamClientDisposing",(()=>{this.removeSourceStream(e.rawStream),t.dispose()}));this.logger.safe.info(`Add stream: ${e.rawStream.id}, track: ${SL(e.rawStream).id}`),this.addStream(e.rawStream,e.mediaType)}getDestinationTrack(){return SL(this.destination.stream)}dispose(){super.dispose(),this.unsubscribeFromMediaTrackEvents(this.getDestinationTrack());for(const e of this.streamNodeMap.keys())this.removeSourceStream(e);this.audioContext.close(),this.audioContext=null}addStream(e,t="Audio"){const i=this.audioContext.createMediaStreamSource(e);i.connect(this.destination),this.streamNodeMap.set(e,{mediaType:t,sourceNode:i})}removeSourceStream(e){const t=this.streamNodeMap.get(e);t&&(this.logger.safe.info(`Remove stream: ${e.id}, track: ${SL(e).id}`),t.sourceNode.disconnect(),this.streamNodeMap.delete(e))}subscribeOnMediaTrackEvents(e){e.onended=t=>{this.logger.safe.info(`Track ${e.id} ended: ${JSON.stringify(t)}`)},e.onmute=()=>{this.logger.safe.info(`Track ${e.id} muted`)},e.onunmute=()=>{this.logger.safe.info(`Track ${e.id} unmuted`)}}unsubscribeFromMediaTrackEvents(e){e.onended=null,e.onmute=null,e.onunmute=null}};function SL(e){return e.getAudioTracks()[0]}var vL=class{constructor(e){this.logger=e}createBaseInstanse(e){this.imp=new yL,e.addTransform(this.imp)}createWorkerInstanse(e,t){this.imp=new CL(e,t)}mute(e){this.logger.safe.info(`Dropping audio chunks: ${e}`),this.imp.mute(e)}},yL=class{constructor(){this.transformType=1,this.muted=!1}transform(e){return this.muted?null:e}mute(e){this.muted=e}dispose(){}},CL=class extends EN{constructor(e,t){super(e,t,1,void 0)}mute(e){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"mute",args:[e]}})}},TL=class extends Qe{constructor(e,t,i,n,r,s){super(),this.mediaConnection=e,this.contextStream=i,this.logger=n,this.configProvider=r,this.encStreamsManager=s,this.isActive=!1,this.isMuted=!1,this.configProvider.config.renderThroughCanvas&&(this.videoThroughCanvas=new mL(this.logger.createChild("videoThroughCanvas"))),this.stream=t.clone("streamSender ctor"),this.streamResolution=this.stream.getResolution()}get rtpSender(){return this.sender}get trackId(){const e=this.rawTrack;return e?.id}get mediaType(){return this.stream.mediaType}get rawTrack(){return this.audioMixer?.getDestinationTrack()||this.stream.rawTrack}get canvasedRawTrack(){return this.configProvider.config.renderThroughCanvas?"Video"!==this.stream.mediaType?this.rawTrack:this.videoThroughCanvas?.modify(this.rawTrack)??this.rawTrack:this.rawTrack}async init(){this.sender=await this.createSender(),this.isActive=!0,this.addStreamTransforms()}async start(){this.isActive?this.logger.safe.info("Already active. Do nothing"):(this.logger.safe.info("Starting"),this.isActive=!0,await this.wakeSender(),this.params&&await this.applyParams(this.params,0),this.logger.safe.info("Started"))}async stop(){if(this.isActive){if(this.logger.safe.info("Stopping"),this.isActive=!1,"Audio"!==this.stream.mediaType){const e=this.configProvider.config.webrtcDisabledSenderBitrate;await this.applyBitrate(e,!1)}await this.sleepSender(),this.logger.safe.info("Stopped")}else this.logger.safe.info("Already stopped. Do nothing")}setMuted(e,t,i){this.isMuted=e,this.stream.setMuted(e,t),e&&this.audioMixer&&1!==this.audioMixer.numberOfStreams||this.audioMuteTransform?.mute(e),!this.configProvider.config.requestNewStreamOnUnmute||e||i||this.stream.isActive()||this.event("onNewStreamNeeded").raise()}async setHold(e,t){return this.activateSender(!e,t)}async setMainStream(e){if(this.stream.dispose(),this.stream=e.clone("streamSender setMainStream"),this.streamResolution=this.stream.getResolution(),this.stream.setMuted(this.isMuted),this.params&&await this.applyCapabilities(this.params,1),this.audioMixer?.addSourceStream(this.stream),this.isActive){const e=this.rawTrack?.id;this.logger.safe.info(`Replace sender with track: ${e}`),await this.sender.replaceTrack(this.canvasedRawTrack),this.logger.safe.info("Replace completed")}}async addAdditionalStream(e){if("Audio"===this.stream.mediaType){if(this.configProvider.config.postponeAudioMixerForAudioSharing&&this.setupAudioMixer(),this.audioMixer||this.logger.safe.error(`addAdditionalStream is called when audioMixer is not created. Main stream type is ${this.stream.mediaType}.`),this.audioMixer?.addSourceStream(e),this.audioMuteTransform?.mute(!1),this.configProvider.config.postponeAudioMixerForAudioSharing){if(!this.sender)return void this.logger.safe.error("Sender not created, cannot replace track");this.logger.safe.info(`addAdditionalStream replace sender with track: ${this.rawTrack?.id}`),await this.sender.replaceTrack(this.canvasedRawTrack),this.logger.safe.info("addAdditionalStream replace completed")}}else this.logger.safe.error("Not adding additional stream for non-audio stream")}async setParameters(e,t=!1,i=0){if(t||this.params!==e){if(this.params=e,this.isActive)return this.applyParams(this.params,i);this.logger.safe.info("Sender is not active, preserving params")}}dispose(){this.removeSender(),this.cleanUp()}async terminateAsync(){await this.removeSenderAsync(),this.cleanUp()}getActiveStreamIndexes(){return this.getSenderParameters().encodings.filter((e=>e.active)).map((e=>+e.rid))}async updateStreamQualityParams(e,t,i){if(this.configProvider.config.useSetParametersToApplyCapabilities)if(e){if(this.logger.safe.debug(`Stream resolution has changed to ${JSON.stringify(e)}@${t}, re-applying send parameters`),this.streamResolution=e,this.params)return this.setParameters(this.params,!0,i);this.logger.safe.debug("Params are not yet set, do nothing")}else this.logger.safe.debug(`Resolution is not defined: ${JSON.stringify(e)}@${t}`)}async applyStreamCapabilities(e){return await this.stream.applyCapabilities(e),this.stream.getResolution()}async applyParams(e,t){this.logger.safe.info(`Applying params: ${JSON.stringify(e)}`),await this.applyCapabilities(e,t),await this.applyBitrate(e.maxBr),this.params.keyframe&&await this.forceKeyframe()}applyBitrate(e,t=!0){const i=t?this.getAdjustedBitrate(e):e;return this.setEncodingParameters({maxBitrate:i},"applyBitrate")}getAdjustedBitrate(e){let t=e||0;if("Video"===this.stream.mediaType){const e=NI.Send.getResolutionRecord(this.streamResolution.width,this.streamResolution.height);t=Math.min(t||e.maxBitrate,e.maxBitrate)}return t}async activateSender(e,t){await this.setEncodingParameters({active:e},"activateSender"),this.logger.safe.info(`[${t}] Active state applied isActive = ${e}`)}async forceKeyframe(){if(!this.sender)return this.logger.safe.error("No sender available"),null;if(!this.sender.track)return void this.logger.safe.info("Sender track does not exist, not restoring keyframe");this.logger.safe.info("Restoring keyframe starting");const e=this.getSenderParameters().encodings[0].scaleResolutionDownBy||1;await this.setEncodingParameters({scaleResolutionDownBy:e*this.configProvider.config.forceKeyFrameV2ScaleFactor},"forceKeyframe start"),await this.setEncodingParameters({scaleResolutionDownBy:e},"forceKeyframe end"),this.logger.safe.info("Restoring keyframe finished")}removeSender(){this.logger.safe.info("Removing sender from pc");try{this.mediaConnection.removeSender(this.sender)}catch(e){this.logger.safe.warn(`Error removing sender: ${Ge(e)}`)}}async removeSenderAsync(){this.logger.safe.info("Removing sender from pc");try{await this.mediaConnection.removeSenderAsync(this.sender)}catch(e){this.logger.safe.warn(`Error removing sender: ${Ge(e)}`)}}async createSender(){return this.configProvider.config.postponeAudioMixerForAudioSharing||this.setupAudioMixer(),this.mediaConnection.createSender(this.canvasedRawTrack,this.contextStream,jg(this.stream.mediaType))}async wakeSender(){this.logger.safe.info("Wake started"),await this.sender.replaceTrack(this.canvasedRawTrack),this.logger.safe.info("Wake completed")}async sleepSender(){this.logger.safe.info("Sleep started"),await this.sender.replaceTrack(null),this.logger.safe.info("Sleep completed")}addStreamTransforms(){const e=this.encStreamsManager.initTransformsCollection(this.sender,"Sender",this.stream.mediaType);e&&("Audio"===this.stream.mediaType?this.configProvider.config.useInsertableStreams?.audioExtendedMute&&(this.audioMuteTransform=new vL(this.logger.createChild("SendAudioPayload")),e.addTransform(this.audioMuteTransform)):this.configProvider.config.useInsertableStreams?.videoStreamAnalyzer&&e.addTransform(new _N(this.logger.createChild(`SendStreamAnalyzer [${this.stream.mediaType}]`))))}clearStreamTransforms(){this.encStreamsManager.clearTransformsCollection(this.sender)}setupAudioMixer(){this.configProvider.config.enableAudioSharing?"Audio"===this.stream.mediaType?this.configProvider.config.audioSharingMemoryLeakFix&&this.audioMixer?this.logger.safe.debug("Audio mixer already created, not creating new one"):(this.audioMixer=new fL(this.logger.createChild("AudioMixer")),this.audioMixer.addSourceStream(this.stream)):this.logger.safe.error("Not setting up audio mixer for non-audio stream"):this.logger.safe.info("Audio sharing is disabled, not setting up audio mixer")}getSenderParameters(){const e=this.sender.getParameters();return e.encodings?.length||(e.encodings=[{}]),e}async setEncodingParameters(e,t,i=!1){const n=this.getSenderParameters();(0,gL.merge)(n.encodings[0],e),0===n.encodings[0].maxBitrate&&(this.configProvider.config.setParametersMaxBitrateUndefined?n.encodings[0].maxBitrate=void 0:delete n.encodings[0].maxBitrate);try{await this.sender.setParameters(n),this.logger.safe.info(`${t}: Parameters applied for sender: ${JSON.stringify(n.encodings[0])}`)}catch(e){if(this.logger.safe.error(`${t}: setParameters failed: ${Ge(e)}, parameters ${JSON.stringify(n.encodings[0])}`),i)throw e}}async applyCapabilities(e,t){this.configProvider.config.useSetParametersToApplyCapabilities?await this.setEncodingParameters({scaleResolutionDownBy:this.getScaleFactor(e.maxFs),maxFramerate:e.maxFps},"applyCapabilities",!0):2!==t&&await this.applyStreamCapabilities(e)}getScaleFactor(e){const t=NI.Send.getResolutionByFs(e),{width:i,height:n}=this.streamResolution,r=Math.min(i,n)/t.height;return this.logger.safe.debug(`Current stream resolution: ${i}x${n}, scale factor: ${r}`),r<1?(this.logger.safe.warn(`Resolution scale factor is less than 1: ${r}`),1):r}cleanUp(){super.dispose(),this.clearStreamTransforms(),this.sender=null,this.audioMixer?.dispose(),this.stream.dispose(),this.stream=null,this.isActive=!1,this.videoThroughCanvas?.dispose()}},EL=class extends Qe{constructor(e,t,i,n,r,s,a){super(),this.mediaConnection=e,this.contextStream=i,this.logger=n,this.configProvider=r,this.encStreamsManager=s,this.capabilitiesManager=a,this.isActive=!1,this.isMuted=!1,this.stream=t.clone("streamSender ctor"),this.subscribeOnStreamClientMuted(),this.capabilitiesManager.updateStream(this.stream)}get rawTrack(){return this.audioMixer?.getDestinationTrack()||this.stream.rawTrack}get trackId(){const e=this.rawTrack;return e?.id}get rtpSender(){throw new Error("rtpSender getter not implemented.")}get mediaType(){throw new Error("mediaType getter not implemented.")}setParameters(e){throw new Error("setParameters not implemented.")}applyStreamCapabilities(e){throw new Error("applyStreamCapabilities not implemented.")}applyCallConstraints(e){return this.capabilitiesManager.applyCallConstraints(e)}async init(){this.sender=await this.createSender(),this.isActive=!0,this.addStreamTransforms(),this.capabilitiesManager.setSender(this.sender)}async start(){this.isActive?this.logger.safe.info("Already active. Do nothing"):(this.logger.safe.info("Starting"),this.isActive=!0,await this.capabilitiesManager.startSender(this.rawTrack),this.logger.safe.info("Started"))}async stop(){this.isActive?(this.logger.safe.info("Stopping"),this.isActive=!1,await this.capabilitiesManager.stopSender(),this.logger.safe.info("Stopped")):this.logger.safe.info("Already stopped. Do nothing")}async setCapabilities(e){this.configProvider.config.applySenderParamsBeforeStart||await this.start(),await this.capabilitiesManager.setCapabilities(e),await this.start()}updateStreamQualityParams(e,t,i){return this.capabilitiesManager.updateStreamQualityParams(e,t,i)}setMuted(e,t,i){this.isMuted=e,this.stream.setMuted(e,t),e&&this.audioMixer&&1!==this.audioMixer.numberOfStreams||this.audioMuteTransform?.mute(e),!this.configProvider.config.requestNewStreamOnUnmute||e||i||this.stream.isActive()||this.event("onNewStreamNeeded").raise()}async setHold(e,t){if(this.configProvider.config.holdSkipActivation)return;const i=!e;this.logger.safe.info(`[${t}] change isActive state to ${i}`);try{return this.capabilitiesManager.setActive(i)}catch(e){const n=this.configProvider.config.holdRetryActivationDelay;if(n>=0)return this.logger.safe.info(`[${t}] retrying after delay of ${n}`),await _i(n),this.logger.safe.info(`[${t}] change isActive state to ${i}, second attempt`),this.capabilitiesManager.setActive(i);throw e}}async setMainStream(e){return this.stream.dispose(),this.onStreamClientMutedSubscription?.dispose(),this.stream=e.clone("streamSender setMainStream"),this.stream.setMuted(this.isMuted),this.audioMixer?.addSourceStream(this.stream),this.isActive&&(this.logger.safe.info(`Replace sender with track: ${this.rawTrack?.id}`),await this.sender.replaceTrack(this.rawTrack),this.logger.safe.info("Replace completed")),this.capabilitiesManager.updateStream(this.stream),this.subscribeOnStreamClientMuted(),this.capabilitiesManager.applyLastCapabilities(1)}async addAdditionalStream(e){if("Audio"===this.stream.mediaType){if(this.configProvider.config.postponeAudioMixerForAudioSharing&&this.setupAudioMixer(),this.audioMixer||this.logger.safe.error(`addAdditionalStream is called when audioMixer is not created. Main stream type is ${this.stream.mediaType}.`),this.audioMixer?.addSourceStream(e),this.audioMuteTransform?.mute(!1),this.configProvider.config.postponeAudioMixerForAudioSharing){if(!this.sender)return void this.logger.safe.error("Sender not created, cannot replace track");this.logger.safe.info(`addAdditionalStream replace sender with track: ${this.rawTrack?.id}`),await this.sender.replaceTrack(this.rawTrack),this.logger.safe.info("addAdditionalStream replace completed")}}else this.logger.safe.error("Not adding additional stream for non-audio stream")}dispose(){this.removeSender(),this.cleanUp()}async terminateAsync(){await this.removeSenderAsync(),this.cleanUp()}getActiveStreamIndexes(){return this.getSenderParameters().encodings.filter((e=>e.active)).map((e=>+e.rid))}removeSender(){this.logger.safe.info("Removing sender from pc");try{this.mediaConnection.removeSender(this.sender)}catch(e){this.logger.safe.warn(`Error removing sender: ${Ge(e)}`)}}async removeSenderAsync(){this.logger.safe.info("Removing sender from pc");try{await this.mediaConnection.removeSenderAsync(this.sender)}catch(e){this.logger.safe.warn(`Error removing sender: ${Ge(e)}`)}}async createSender(){return this.configProvider.config.postponeAudioMixerForAudioSharing||this.setupAudioMixer(),this.mediaConnection.createSender(this.rawTrack,this.contextStream,jg(this.stream.mediaType))}addStreamTransforms(){const e=this.encStreamsManager.initTransformsCollection(this.sender,"Sender",this.stream.mediaType);e&&("Audio"===this.stream.mediaType?this.configProvider.config.useInsertableStreams?.audioExtendedMute&&(this.audioMuteTransform=new vL(this.logger.createChild("SendAudioPayload")),e.addTransform(this.audioMuteTransform)):this.configProvider.config.useInsertableStreams?.videoStreamAnalyzer&&e.addTransform(new _N(this.logger.createChild(`SendStreamAnalyzer [${this.stream.mediaType}]`))))}clearStreamTransforms(){this.encStreamsManager.clearTransformsCollection(this.sender)}setupAudioMixer(){this.configProvider.config.enableAudioSharing?"Audio"===this.stream.mediaType?this.configProvider.config.audioSharingMemoryLeakFix&&this.audioMixer?this.logger.safe.debug("Audio mixer already created, not creating new one"):(this.audioMixer=new fL(this.logger.createChild("AudioMixer")),this.audioMixer.addSourceStream(this.stream)):this.logger.safe.error("Not setting up audio mixer for non-audio stream"):this.logger.safe.info("Audio sharing is disabled, not setting up audio mixer")}getSenderParameters(){const e=this.sender.getParameters();return e.encodings?.length||(e.encodings=[{}]),e}subscribeOnStreamClientMuted(){this.configProvider.config.recoverOnStreamUnmute&&(this.onStreamClientMutedSubscription=this.stream.on("onStreamClientMuted",(async(e,t)=>{t||await this.capabilitiesManager.applyLastCapabilities(1)})))}cleanUp(){super.dispose(),this.clearStreamTransforms(),this.sender=null,this.audioMixer?.dispose(),this.stream.dispose(),this.onStreamClientMutedSubscription?.dispose(),this.stream=null,this.isActive=!1}},_L=class e extends Qe{constructor(t,i,n,r,s,a,o,l,d,c){super(),this.mediaConnection=t,this.mainStream=i,this.contextStream=n,this.mediaType=r,this.serialQueue=s,this.logger=a,this.configProvider=o,this.isAlwaysActive=l,this.encStreamsManager=d,this.simulcastContext=c,this.isMuted=!1,this.isHold=!1,this.previousParameters=[],this.state=new pL(e.transitionStates,"NotStarted",this.logger),this.pendingStream=null,this.pendingParams=null,this.subscribeOnQualityUpdates(this.mainStream)}async start(){this.state.setState("Started")&&(this.sender=this.createSenderModel(),await this.sender.init(),this.notifyMaxVideoSendCapabilitiesChanged(),this.configProvider.config.deactiveAudioSender&&"Audio"===this.mediaType&&await this.sender.stop(),this.subscribeForSenderEvents())}async activate(){this.state.setState("Active")&&(this.pendingStream&&(await this.updateStreamInternal(this.pendingStream),this.pendingStream=null),this.isAlwaysActive&&!this.isMuted&&"Audio"===this.mediaType&&await this.sender.start(),this.isAlwaysActive?(this.event("onSendersChanged").raise(this,!0),this.logger.safe.info("Sender set to always active. Do not stopping")):await this.capabilitiesManager.stop(),this.configProvider.config.enableCachingFMTP&&this.pendingParams&&(this.logger.safe.info("Apply pending parameters"),await this.updateParametersInternal(this.pendingParams),this.pendingParams=null))}updateStream(e){return this.updateStreamInternal(e)}async addAdditionalStream(e){return this.sender.addAdditionalStream(e)}async updateParameters(e){if(this.state.isCurrentStateMatchedWith("Active"))return this.updateParametersInternal(e);this.configProvider.config.enableCachingFMTP?(this.logger.safe.info("Postpone params update until sender is activated"),this.pendingParams=e):this.logger.safe.warn("Ignore params update as sender is not activate")}async terminateAsync(){this.state.setState("Disposed")&&(this.logger.safe.info("Terminating async"),await this.sender.terminateAsync(),this.cleanUp())}dispose(){this.state.setState("Disposed")&&(this.logger.safe.info("Disposing"),this.sender.dispose(),this.cleanUp())}async setHold(e,t){if(this.isHold!==e)return this.logger.safe.info(`[${t}] Setting hold to: ${e}`),this.isHold=e,this.sender.setHold(e,t);this.logger.safe.info(`[${t}] Already in hold=${e} state`)}setMuted(e,t,i){this.logger.safe.info(`[${t}] Setting muted to: ${e}`),this.isMuted=e,this.sender.setMuted(this.isMuted,t,i),!this.isMuted&&"Audio"===this.mediaType&&this.state.isCurrentStateMatchedWith("Active")&&this.sender.start()}getActiveStreamIndexes(){return this.sender?this.sender.getActiveStreamIndexes():[]}getTrackInfo(){return{modality:jg(this.mediaType),trackId:this.sender.trackId}}applyCallConstraints(e){return this.capabilitiesManager.applyCallConstraints(e)}createSenderModel(){if(this.configProvider.config.useSenderV2){const e=new EL(this.mediaConnection,this.mainStream,this.contextStream,this.logger.createChild("SenderV2"),this.configProvider,this.encStreamsManager,this.getCapabilitiesManagerV2(this.simulcastContext));return this.capabilitiesManager=e,e}const e=new TL(this.mediaConnection,this.mainStream,this.contextStream,this.logger.createChild("Sender"),this.configProvider,this.encStreamsManager);return this.capabilitiesManager=this.getCapabilitiesManager(e,this.simulcastContext),e}subscribeForSenderEvents(){this.sender.on("onNewStreamNeeded",(()=>this.event("onNewStreamNeeded").raise()))}getCapabilitiesManager(e,t){return t?.shouldUseSimulcast()?new aL(e,this.mainStream.getResolution(),t.config.layerScaleFactors.length,this.logger.createChild("SimCapMgr"),this.configProvider):new oL(e,this.logger.createChild("SnglCapMgr"),this.configProvider)}getCapabilitiesManagerV2(e){return e?.shouldUseSimulcast()?new hL(e.config.layerScaleFactors.length,this.configProvider,this.logger.createChild("SimCapMgrV2")):new uL(this.configProvider,this.logger.createChild("SnglCapMgrV2"))}async updateStreamInternal(e){return this.state.isCurrentStateMatchedWith("Active")?this.mainStream!==e?(this.logger.safe.debug(`Switching streams: ${this.mainStream.parentId}:${this.mainStream.id} -> ${e.parentId}:${e.id}`),this.unsubscribeFromQualityEvents(),this.mainStream.dispose(),this.mainStream=e,this.subscribeOnQualityUpdates(this.mainStream),this.notifyMaxVideoSendCapabilitiesChanged(),await this.sender.setMainStream(this.mainStream),this.capabilitiesManager.updateStreamQualityParams(this.mainStream.getResolution(),this.mainStream.getFrameRate(),1)):void this.logger.safe.info("Stream has not been changed. Skipping update"):(this.logger.safe.info("Postponing stream update until sender is activated"),void this.setPendingStream(e))}async updateParametersInternal(e){await this.capabilitiesManager.setCapabilities(e),function(e,t,i){const n=[];return e.forEach((e=>{t.some((t=>i(e,t)))||n.push(e)})),0===n.length&&e.length===t.length}(this.previousParameters,e,((e,t)=>e.ssrc===t.ssrc))||(this.previousParameters=e,this.event("onSendersChanged").raise(this,!0))}setPendingStream(e){this.pendingStream=e;const t=e.on("onStreamClientDisposing",(()=>{this.pendingStream===e&&(this.pendingStream=null,t.dispose())}))}subscribeOnQualityUpdates(e){this.sub=e.on("onStreamQualityChanged",((e,t,i,n)=>this.updateStreamQualityParams(t,i,n)))}updateStreamQualityParams(e,t,i){return i===Yh.EffectQualityChangeReason.Performance&&this.notifyMaxVideoSendCapabilitiesChanged({resolution:e,fps:t}),this.capabilitiesManager.updateStreamQualityParams(e,t,2)}unsubscribeFromQualityEvents(){this.sub?.dispose(),this.sub=null}notifyMaxVideoSendCapabilitiesChanged(e){if(!["Video","ScreenShare"].includes(this.mediaType))return;const{width:t,height:i}=e?.resolution??this.mainStream.getResolution(),n=e?.fps??this.mainStream.getFrameRate();if(!t||!i||!n)return;const r=new DI(t,i),s={maxFs:r.fs,maxMbps:r.fs*n,maxFps:n,maxWidth:r.width,maxHeight:r.height};this.logger.safe.info(`Capabilities for ${this.mediaType} stream: ${JSON.stringify(s)}`),this.event("onMaxVideoSendCapabilitiesChanged").raise(s)}cleanUp(){this.unsubscribeFromQualityEvents(),this.mainStream.dispose(),this.mainStream=null,this.pendingStream&&this.pendingStream.dispose(),this.pendingStream=null,this.sender=null,this.contextStream=null,this.event("onSendersChanged").raise(this,!1),super.dispose()}};_L.transitionStates={NotStarted:["Started","Disposed"],Started:["Active","Disposed"],Active:["NotStarted","Disposed"],Disposed:[]},E([WA()],_L.prototype,"start",1),E([WA()],_L.prototype,"activate",1),E([WA()],_L.prototype,"updateStream",1),E([WA()],_L.prototype,"addAdditionalStream",1),E([WA()],_L.prototype,"updateParameters",1),E([WA()],_L.prototype,"terminateAsync",1),E([WA()],_L.prototype,"setHold",1),E([WA()],_L.prototype,"updateStreamQualityParams",1);var bL=_L,PL=class extends Qe{constructor(e,t,i,n,r,s,a,o){super(t),this.mediaManager=e,this.logger=t,this.callDeviceManager=i,this.configProvider=n,this.statisticsGatherer=r,this.diagnostics=s,this.isMultiparty=a,this.encStreamsManager=o,this.senders=new Map,this.previousMediaModalitites={Audio:!1,Video:!1,ScreenShare:!1},this.serialQueue=new _I(this.logger),this.muted=new Map([["Audio",!1],["Video",!1]]),this.subs=new Map,this.senderId=0,this.callConstraintsCauseId=void 0,this.streamsProvider=new BN(i,n,this.serialQueue,this.logger.createChild("StreamsProvider")),this.subscribeToStreamProviderEvents(),this.localVideoStreamWatcher=new pN(this.logger,this.configProvider,this.callDeviceManager),this.statisticsGatherer.on("onDiagnosticUpdated",(e=>this.onDiagnosticUpdated(e))),this.statisticsGatherer.on("onStatisticsChanged",(e=>this.onStatisticsChanged(e))),this.subscribeToStreamWatcherEvents(),this.configProvider.config.useMediaQualityController&&(this.mediaQualityController=new nL(this.configProvider,this.logger.createChild("MQC")),this.mediaQualityController.on("onLayoutsUpdated",(e=>this.updateLayouts(e))))}onStatisticsChanged(e){this.configProvider.config.diagnostics.features.useNewSendBandwidthCalculation||this.mediaQualityController?.onStatisticsChanged(e),this.configProvider.config.diagnostics.features.useNewStatsForLocalVideoStreamWatcher||this.localVideoStreamWatcher?.onStatisticsChanged(e)}onDiagnosticUpdated(e){this.configProvider.config.diagnostics.features.useNewSendBandwidthCalculation&&this.mediaQualityController?.onDiagnosticUpdated(e),this.configProvider.config.diagnostics.features.useNewStatsForLocalVideoStreamWatcher&&this.localVideoStreamWatcher?.onDiagnosticUpdated(e)}dispose(){this.senders.forEach(((e,t)=>{this.event("onSendStreamChanged").raise(null,t),this.configProvider.config.disposeSendersSync?e.dispose():e.terminateAsync()})),this.senders.clear(),this.subs.forEach((e=>e.forEach((e=>e.dispose())))),this.subs.clear(),this.mediaConnection=null,this.unsubscribeFromStreamProviderEvents(),this.configProvider.config.disposeStreamsSync?this.streamsProvider.stop():this.streamsProvider.stopAsync(),this.streamsProvider=null,this.localVideoStreamWatcherSubs?.dispose(),this.localVideoStreamWatcher?.dispose(),this.localVideoStreamWatcher=null,this.mediaManager=null,this.logger=this.logger.createChild("DISPOSED"),this.mediaQualityController?.dispose(),this.mediaQualityController=null,super.dispose()}registerRtpSenderManager(e){this.mediaConnection=e}useNullAudioStreamClient(){this.streamsProvider.useNullAudioStreamClient()}async update(e,t,i,n){n?.mark("startUpdateStreams");const r=Hg(e),s=await this.updateStreams(r,t);return n?.markAndMeasure("startUpdateStreams","updateStreamsWithModalities"),await this.updateSenders(),n?.markAndMeasure("updateStreamsWithModalities","updateSenders"),this.applyMuteState(i,!0),this.setAndUpdateLocalTracksInfo(!1),this.previousMediaModalitites=ht(s),Bg(e,this.previousMediaModalitites)}async activate(e){this.logger.info(`[${e}] activate senders`),await Promise.all([...this.senders.values()].map((async e=>e.activate())))}applyCallConstraints(e){const t=this.senders.get("Video");return t?t.applyCallConstraints(e):(this.logger.info(`[${e}] Caching call constraints until sender is created`),this.callConstraintsCauseId=e,this.applyCallConstraintsDeferred=um(),this.applyCallConstraintsDeferred.promise)}async applyCapabilities(e,t,i){this.logger.safe.info(`[${e}] Applying incoming ${t} FMTP: ${JSON.stringify(i)}`);const n=$g(t);this.lastCauseId=e;let r=i;return this.mediaQualityController&&(this.mediaQualityController.addReceiver(n,i),r=this.mediaQualityController.getLayouts(n)),this.updateParameters(e,n,r)}getLocalMediaSources(){const e=this.getTracksInfo(),t=[];return e.forEach((e=>{t.some((t=>t.modality===e.modality))||t.push({sourceId:this.getSourceIdForTrack(e),modality:e.modality})})),t}setMuted(e,t,i){this.muted.set(e,t),this.applyMuteState(i,!1)}async setHold(e,t){await Promise.all([...this.senders.values()].map((async i=>i.setHold(e,t))))}async updateParameters(e,t,i){try{await this.applyCapabilitiesForMediaType(t,i),this.logger.safe.debug(`[${e}] Capabilities completed`);const n={modality:jg(t),causeId:e,capabilities:i};this.statisticsGatherer.onMaxCapabilitiesApplied(n),this.diagnostics?.onMaxCapabilitiesApplied(n)}catch(n){const r=Ge(n);this.logger.safe.error(`[${e}] Error applying capabilities ${r}`);const s={modality:jg(t),causeId:e,capabilities:i,error:r};this.statisticsGatherer.onMaxCapabilitiesApplied(s),this.diagnostics?.onMaxCapabilitiesApplied(s)}}async applyCapabilitiesForMediaType(e,t){const i=this.senders.get(e);if(i)return i.updateParameters(t);this.logger.safe.info(`[${this.lastCauseId}] Capabilities ignored ${JSON.stringify(t)} ignored, no sender for media type ${JSON.stringify(e)}`)}applyMuteState(e,t){for(const[i,n]of this.muted)this.senders.get(i)&&this.senders.get(i).setMuted(n,e,t)}setAndUpdateLocalTracksInfo(e){const t=this.getTracksInfo();this.mediaManager.setLocalTracksInfo(t),e&&(this.mediaManager.updateMediaEntitiesWithLocalTracks(),this.configProvider.config.mapSsrcToTrackForStats&&this.statisticsGatherer.updateStatsWithLocalSsrcTrackInfo())}getTracksInfo(){const e=[];return this.senders.forEach((t=>{e.push(t.getTrackInfo())})),e}async updateStreams(e,t){const i=await this.streamsProvider.update(e,t);return this.logger.safe.info(`Streams updated, modalities requested: ${JSON.stringify(e)}, result: ${JSON.stringify(i)}`),i}async updateSenders(){await this.streamsProvider.ensureUpdateCompleted();const e=Gg(this.streamsProvider.streams);await Promise.all(ct(e).map((async t=>{const i=e[t];if(i===this.previousMediaModalitites[t])return void this.logger.safe.info(`Sender for mediaType: ${JSON.stringify(t)} are not changed. enabled=${i}`);if(!i)return this.logger.safe.info(`Removing sender for mediaType: ${JSON.stringify(t)}`),void await this.removeSender(t);const n=this.streamsProvider.streams[t];if(await this.createAndStartSender(n,t),this.logger.safe.info(`Sender for mediaType: ${JSON.stringify(t)} is added`),this.applyCallConstraintsDeferred&&"Video"===t){const e=this.senders.get("Video");try{await e.applyCallConstraints(this.callConstraintsCauseId),this.applyCallConstraintsDeferred.resolve()}catch(e){this.applyCallConstraintsDeferred.reject(e)}this.applyCallConstraintsDeferred=void 0,this.callConstraintsCauseId=void 0}await this.addAudioSharingStream(n),this.event("onSendStreamChanged").raise(n,t)}))),this.logger.safe.info("Senders updated")}createAndStartSender(e,t){if(this.senders.get(t))return this.logger.safe.error(`Sender already created, modality: ${JSON.stringify(t)}`),this.senders.get(t).start();const i=this.mediaManager.getMediaEntitiesByModality(jg(t))[0],n=i?.getSimulcastContext(),r="Audio"===t||!this.isMultiparty||!!n?.shouldUseSimulcast(),s=new bL(this.mediaConnection,e,new MediaStream,t,this.serialQueue,this.logger.createChild(`Sender_${JSON.stringify(t)}:${this.senderId++}`),this.configProvider,r,this.encStreamsManager,n);this.senders.set(t,s);const a=[s.on("onSendersChanged",((e,t)=>this.onSenderStateChanged(e,t))),s.on("onNewStreamNeeded",(()=>this.streamsProvider.requestStreamUpdate(t,!0))),s.on("onMaxVideoSendCapabilitiesChanged",(e=>this.event("onMaxVideoSendCapabilitiesChanged").raise(t,e)))];return this.subs.set(s,a),s.start()}async removeSender(e){const t=this.senders.get(e);t&&(this.senders.delete(e),this.event("onSendStreamChanged").raise(null,e),await t.terminateAsync(),this.subs.get(t).forEach((e=>e.dispose())),this.subs.delete(t),this.logger.safe.info(`Removed sender with mediaType: ${JSON.stringify(e)}`)),this.mediaQualityController?.removeReceiver(e)}async updateLayouts(e){const t=this.mediaQualityController.getLayouts(e);return this.logger.safe.debug(`Update layouts for ${e}: ${JSON.stringify(t)}`),this.updateParameters(this.lastCauseId,e,t)}getSourceIdForTrack(e){const t=e.trackId,i=this.mediaManager.getMediaEntityByLocalTrackId(t);return i?(this.logger.safe.info(`Media entity found: ${JSON.stringify(i.getXSourceStreamId())}`),i.getXSourceStreamId()):(this.logger.safe.error(`Media entity is not found for stream: ${JSON.stringify(t)}`),0)}subscribeToStreamProviderEvents(){this.streamProviderSubscriptions=[this.streamsProvider.on("onStreamAdded",(e=>this.onStreamUpdated(e,!1))),this.streamsProvider.on("onStreamUpdated",(e=>this.onStreamUpdated(e,!0)))]}unsubscribeFromStreamProviderEvents(){this.streamProviderSubscriptions.forEach((e=>e.dispose())),this.streamProviderSubscriptions=null}subscribeToStreamWatcherEvents(){this.localVideoStreamWatcherSubs=this.localVideoStreamWatcher.on("onVideoCaptureFreeze",((e,t)=>{e||(t?this.diagnostics.registerWebcamFreeze():this.diagnostics.registerProcessedStreamFreeze()),this.event("onVideoCaptureFreeze").raise(e)}))}async onStreamUpdated(e,t){if(!this.senders.has(e))return void this.logger.safe.warn(`Sender with media type ${e} does not exist, do not update media stream`);let i=this.streamsProvider.streams[e];if(i||(this.logger.safe.info(`Stream is missing for mediaType: ${e}, using fake stream...`),i=new VN(e,this.logger.createChild("NullStreamClient"))),i.isDisposed())return void this.logger.safe.info(`Stream is already disposed for mediaType: ${e}`);this.event("onSendStreamChanged").raise(i,e);const n=this.senders.get(e);await this.addAudioSharingStream(i),await n.updateStream(i),this.setAndUpdateLocalTracksInfo(t)}onSenderStateChanged(e,t){if(this.mediaManager&&this.mediaManager.updateMediaEntitiesWithActivityState(e.mediaType,e.getActiveStreamIndexes()),this.statisticsGatherer.onSendersChanged(e.mediaType,t),"Video"===e.mediaType)if(t){const e=this.getTracksInfo().filter((e=>e.modality===tt.MODALITY.video));this.localVideoStreamWatcher.startWatching(e)}else this.localVideoStreamWatcher.stopWatching()}async addAudioSharingStream(e){"ScreenShare"===e.mediaType&&e.hasAudio()&&(this.logger.safe.info("Adding audio stream from sharing to audio sender"),await(this.senders.get("Audio")?.addAdditionalStream(e)))}},IL=class{constructor(e,t,i,n,r){this.pc=e,this.cryptoMethod=t,this.logger=i,this.configProvider=n,this.stateChangedCallback=r,this.logger=i.createChild("TransportStateProvider"),this.subscribeForConnectionState()}get hasPcConnectionState(){return"connectionState"in this.pc&&this.configProvider.config.useConnectionState}subscribeForConnectionState(){this.pc.oniceconnectionstatechange=()=>{this.logger.safe.info(`RTCPeerConnection oniceconnectionstatechange iceConnectionState: ${this.pc.iceConnectionState} pc.signalingState: ${this.pc.signalingState}`),this.shouldRaise(0)&&this.stateChangedCallback(this.pc.iceConnectionState)},1===this.cryptoMethod&&this.hasPcConnectionState&&(this.pc.onconnectionstatechange=()=>{this.logger.safe.info(`RTCPeerConnection onconnectionStatechange connectionState: ${this.pc.connectionState} pc.signalingState: ${this.pc.signalingState}`),this.shouldRaise(1)&&this.stateChangedCallback(this.pc.connectionState)})}subscribeForDtlsTransportState(){if(!this.configProvider.config.useDtlsTrasportConnectionCheck||this.transport||1!==this.cryptoMethod||this.hasPcConnectionState)return;const e=this.pc.getReceivers().find((e=>!!e.transport));this.transport=e&&e.transport,this.transport&&(this.transport.onstatechange=()=>{this.logger.safe.info(`RTCDtlsTransport onstatechange state: ${this.transport.state} pc.signalingState: ${this.pc.signalingState}`),this.shouldRaise(2)&&this.stateChangedCallback(this.transport.state)})}dispose(){this.pc.oniceconnectionstatechange=null,this.transport&&(this.transport.onstatechange=null,this.transport=null),this.pc.onconnectionstatechange&&(this.pc.onconnectionstatechange=null),this.pc=null,this.stateChangedCallback=null}shouldRaise(e){switch(e){case 2:if(1!==this.cryptoMethod)throw new Error(`DTLS transport is used with cryptoMethod=${this.cryptoMethod}`);return!this.configProvider.config.ignoreClosedDtlsTransportState||"closed"!==this.transport.state;case 1:return 1===this.cryptoMethod&&!this.transport;case 0:return!(!this.configProvider.config.ignoreClosedDtlsTransportState||!this.transport||"closed"!==this.pc.iceConnectionState)||0===this.cryptoMethod||!this.transport&&!this.hasPcConnectionState||this.transport&&"disconnected"===this.pc.iceConnectionState||"connected"===this.transport?.state&&"connected"===this.pc.iceConnectionState;default:return this.logger.safe.error(`unknown StateMethod=${e}`),!1}}},AL=class{constructor(e,t,i,n,r){this.recvStream=e,this.mainTrack=t,this.receiveStreamCollection=i,this.logger=n,this.settings=r,this.removeOtherTracks(t),this.subscribeOnStreamEvents()}get stream(){return this.recvStream.getMediaStream()}dispose(){this.unsubscribeFromStreamEvents(),this.receiveStreamCollection=null,this.mainTrack=null,this.recvStream.dispose()}getId(){return this.recvStream.getId()}getModality(){return this.recvStream.getModality()}getMsi(){return this.recvStream.getMsi()}getMediaStream(){return this.stream}getReceiver(){return this.recvStream.getReceiver()}requestSource(e){return this.recvStream.requestSource(e)}getSourceStreamId(){return this.recvStream.getSourceStreamId()}removeOtherTracks(e){this.settings.onAddTrackRemoveOtherTracks&&this.stream.getTracks().forEach((t=>{t.id!==e.id&&this.stream.removeTrack(t)}))}subscribeOnStreamEvents(){const e=e=>this.logger.safe.info(`${e} track: ${this.mainTrack.id}, stream: ${this.stream.id}`);this.stream.onremovetrack=()=>{e("onremovetrack"),this.receiveStreamCollection.remove(this.stream.id)},this.mainTrack.onended=()=>{e("onended"),this.settings.removeRecvStreamOnEnded&&this.receiveStreamCollection.remove(this.stream.id)},this.mainTrack.onmute=()=>e("onmute"),this.mainTrack.onunmute=()=>e("onunmute")}unsubscribeFromStreamEvents(){this.stream.onremovetrack=null,this.mainTrack.onended=null,this.mainTrack.onmute=null,this.mainTrack.onunmute=null}},RL=class{constructor(e){this.startTimestamp=0,this.totalTime=0,this.lastActiveTime=0,this.id=e}},wL=class{constructor(e){this.speakersHistory=[],this.sources=[],this.configProvider=e.configProvider,this.ping=this.setupTimer()}setSources(e=[]){const t=e.map(this.getOrCreateSource.bind(this)),i=this.excludeSources(this.sources,t);t.forEach((e=>{this.isAlreadyActive(e)||this.updateSourceTimestamp(e),this.updateSourceLastActiveTime(e)})),i.forEach((e=>{this.updateTotalTime(e),this.resetStartTimestamp(e)})),this.ping||(this.ping=this.setupTimer())}setOnDominantSpeakerChanged(e){this.callback=e}dispose(){this.clearTimer(),this.sources=null,this.callback=null}excludeSources(e,t){return e.filter((e=>!t.some((t=>e.id===t.id))))}trigger(){if(!this.hasAnyoneSpoken())return void this.clearTimer();const e=this.sources.map(this.updateTotalTime).sort(((e,t)=>t.totalTime-e.totalTime||t.lastActiveTime-e.lastActiveTime)).map((e=>e.id)).slice(0,this.configProvider.config.ovcMaxCount);e.length&&!mt(this.speakersHistory,e)&&(this.speakersHistory=e,this.callback&&this.callback(this.speakersHistory,"client")),this.sources.map(this.resetTotalTime).filter(this.isAlreadyActive).forEach(this.updateSourceTimestamp)}isAlreadyActive(e){return!!e.startTimestamp}setupTimer(){return window.setInterval(this.trigger.bind(this),this.configProvider.config.activeSpeaker.timeToPromote)}clearTimer(){this.ping&&(clearInterval(this.ping),this.ping=null)}getOrCreateSource(e){if(this.isExist(e))return this.sourceById(e);{const t=new RL(e);return this.sources.push(t),t}}isExist(e){return this.sources.some((t=>e===t.id))}hasAnyoneSpoken(){return this.sources.some((e=>0!==e.startTimestamp||0!==e.totalTime))}sourceById(e){return this.sources.find((t=>e===t.id))}updateSourceTimestamp(e){e.startTimestamp=Date.now()}updateSourceLastActiveTime(e){e.lastActiveTime=Date.now()}updateTotalTime(e){return e.startTimestamp&&(e.totalTime+=Date.now()-e.startTimestamp),e}resetStartTimestamp(e){return e.startTimestamp=0,e}resetTotalTime(e){return e.totalTime=0,e}},ML=class{constructor(e){this.modifierList=e}modify(e){for(const t of this.modifierList)t.modify(e)}},OL=class{constructor(e,t,i,n){this.context=e,this.mediaManager=t,this.modalities=i,this.cname=n}build(e){switch(e.sdpSource){case 0:return new ML([new ww(this.context.configProvider),new dw(this.context.configProvider),new Vw(this.mediaManager,this.context.configProvider),new Uw(this.mediaManager),new yw(this.context.configProvider),new mw(this.context.configProvider),new uw(this.mediaManager,this.context.configProvider,e.sdpType),new hw(this.mediaManager,this.context.configProvider),new Jw(this.context.configProvider,e.sdpType)]);case 2:return new ML([new WR(this.mediaManager,this.modalities),new cw,new qR(this.mediaManager,!0),new kw(this.context.configProvider,this.mediaManager),new ZR(this.modalities,this.mediaManager),new Ew,new vw,new Cw,new Tw(this.context.configProvider),new Sw(this.context.configProvider),new Rw(this.context.configProvider),new tw,new jR(this.context),new xw(this.mediaManager),new lw(this.context.configProvider),new Gw,new jw(this.context.configProvider),new Hw(this.context.configProvider),new rw(this.mediaManager,this.modalities,this.context.configProvider),new XR(this.context),new Ww(this.context.configProvider),new YR(this.context.configProvider),new uw(this.mediaManager,this.context.configProvider,e.sdpType),new pw(this.mediaManager,this.context.configProvider,e.sdpType),new bw(this.context.configProvider,this.context.getLogger()),new nw,new zw(this.context.configProvider),new Ow(this.context.configProvider)]);case 1:return new ML([new KR(this.context,this.modalities.data),new qR(this.mediaManager,!1),new sw(this.context.configProvider),new WR(this.mediaManager,this.modalities),new iw(this.mediaManager),new vw,new fw(this.context.configProvider),new GR(this.mediaManager,"offer"===e.sdpType,this.context.configProvider),new Fw(this.mediaManager,this.context.getLogger()),new $w(this.context.configProvider,this.mediaManager),new ew(this.context.config.isConference,this.cname),new aw(this.mediaManager),new ow,new Mw(this.context.configProvider),new QR(this.context.configProvider),new qw(this.context.configProvider),new Kw(this.context.configProvider),new pw(this.mediaManager,this.context.configProvider,e.sdpType),new Aw(this.mediaManager,this.context.configProvider,e.sdpType),new Ow(this.context.configProvider)])}}},DL=class{constructor(e){this.context=e,this.cname=gt()}toLocal(e,t,i){return this.modify({sdpSource:0,sdpType:i},e,t)}toOffer(e,t,i){return this.modify({sdpSource:1,sdpType:"offer"},e,t,i)}toAnswer(e,t,i){return this.modify({sdpSource:1,sdpType:"answer"},e,t,i)}toRemote(e,t,i,n){return this.modify({sdpSource:2,sdpType:n},e,t,i)}modify(e,t,i,n){const r=new OL(this.context,i,n,this.cname).build(e),s=ut(t);return r.modify(s),s}},kL=class{get sdp(){return this.originalDescription.sdp}set sdp(e){this.originalDescription=new yg.window.RTCSessionDescription({sdp:e,type:this.originalDescription.type})}get type(){return this.originalDescription.type}set type(e){this.originalDescription=new yg.window.RTCSessionDescription({sdp:this.originalDescription.sdp,type:e})}constructor(e){this.originalDescription=new yg.window.RTCSessionDescription(e)}toJSON(){return this.originalDescription.toJSON()}},NL=i(496486),LL=class{constructor(e,t,i){this.mediaEntity=e,this.logger=t,this.configProvider=i,this.activeRids=[],this.isLocalDescSet=!1,this.enabledLocally=!1,this.enabledRemotely=!1;const n=$g(this.mediaEntity.getModality());this.config=tm(n,this.configProvider),this.config?this.logger.safe.debug(`Adding simulcast info to ${e.getModality()} with mid: ${e.getMid()}, config: ${JSON.stringify(this.config)}`):this.logger.safe.debug(`Simulast is disabled for ${e.getModality()}`)}get ridList(){return this.config?(0,NL.times)(this.config.layerScaleFactors.length,(e=>e+1)):[]}localDescriptionIsApplied(){this.isLocalDescSet=!0}enableInLocalDesc(){this.enabledLocally=!0}shouldBeEnabledInLocalDesc(){return!!this.config&&(this.config.enableLocally||this.enabledRemotely)}enableInRemoteDesc(){this.enabledRemotely=!0}shouldBeEnabledInRemoteDesc(){return!!this.config&&(this.enabledLocally||this.config.allowEnableRemotely&&this.isMidRidHeaderExtPresented()&&!this.isLocalDescSet)}shouldUseSimulcast(){return this.shouldBeEnabledInLocalDesc()}getSsrcRange(){return this.shouldUseSimulcast()?99:0}isMidRidHeaderExtPresented(){const e=this.mediaEntity.getRtpHeaderExtensions();return e?.some((e=>"mid"===e.headerType||"rid"===e.headerType||"rrid"===e.headerType))}},xL={toffset:"toffset","abs-send-time":"abs-send-time","video-orientation":"video-orientation","draft-holmer-rmcat-transport-wide-cc-extensions-01":"transport-cc","video-content-type":"video-content-type","video-timing":"video-timing","color-space":"color-space","video-layers-allocation00":"vla","video-layers-allocation00-non-advertised":"non-adv-vla",mid:"mid","rtp-stream-id":"rid","repaired-rtp-stream-id":"rrid","fast_bandwidth_feedback#version_3":"fast_bandwidth_feedback#version_3","frame-counters-gvc":"frame-counters-gvc"},FL=class{constructor(e){this.context=e,this.mediaEntities=[],this.mediaEntitiesBackup=[],this.mediaTracks=[],this.ssrcGenerator=new vO,this.rollbackHandlers=[],this.logger=e.logger.createChild("MM2"),this.configProvider=e.configProvider}fromOffer(e,t,i=!1){this.updateMediaEntitiesFromModel(e,i),this.updateSharingEntity(!!t.sharing),e.media.forEach((e=>{const t=this.getMediaEntityByMid(e.mid);t&&this.saveLocalSsrc(t,e)}))}fromRemote(e,t){const i=0===this.mediaEntities.length;this.updateMediaEntitiesFromModel(e,!1,t),e.media.forEach(((e,t)=>{const i=this.getMediaEntityByMid(e.mid);i&&(this.saveRemoteMsid(i,e),this.saveRemoteSsrc(i,e),this.saveRtpHeaderExtensions(i,e),i.setXSourceStreamId(e.xSourceStreamId||this.generateSourceStreamId(t)),i.setRemoteRecvCapabilities(RR(e)),i.setSubStreamIndex(e.subStreamIndex))})),i&&this.updateReinvitelessState(e)}isEmpty(){return 0===this.mediaEntities.length}createMediaEntity(e,t){const i=Qk.create(this.configProvider,e,t);return this.context.useSimulcast&&!this.mediaEntities.find((t=>t.getModality()===e))&&this.setSimulcastContext(i),i.setExtension("reinviteless",!1),this.mediaEntities.push(i),i}getMediaEntities(){return this.mediaEntities}getMediaEntity(e){return this.mediaEntities[e]}getMediaEntityByMid(e){return this.mediaEntities.find((t=>t.getMid()===e))}getMediaEntitiesByModality(e){return this.mediaEntities.filter((t=>t.getModality()===e))}getMediaEntitiesByMediaType(e){const t=$g(e);return this.getMediaEntitiesByModality(t)}getMediaEntityByRemoteStreamId(e){return this.mediaEntities.find((t=>t.getRemoteStreamId()===e))}getMediaEntityByLocalTrackId(e){return this.mediaEntities.find((t=>t.getLocalTrackId()===e))}getMediaEntityByXSourceStreamId(e){return this.mediaEntities.find((t=>t.getXSourceStreamId()===e))}reset(){this.mediaEntities=[],this.rollbackHandlers=[]}syncModalities(e,t,i=!1){this.fromOffer(e,t,i)}setLocalTracksInfo(e){this.mediaTracks=e}getLocalTracksInfo(){return this.mediaTracks}backup(){this.logger.safe.debug("backup"),this.mediaEntitiesBackup=[],this.mediaEntities.forEach((e=>{this.mediaEntitiesBackup.push(e.clone())}))}commit(){this.mediaEntitiesBackup=[],this.mediaEntities.forEach((e=>{e.setExtension("unnegotiatedModality",!1)}))}rollback(){this.logger.safe.debug(`rollback, if backup exists: ${!!this.mediaEntitiesBackup.length}`),this.mediaEntitiesBackup.length&&(this.rollbackHandlers.forEach((e=>e(this.mediaEntities,this.mediaEntitiesBackup))),this.mediaEntities.forEach(((e,t)=>{this.mediaEntitiesBackup[t]?this.mediaEntities[t]=this.mediaEntitiesBackup[t]:(e.disable(),e.setExtension("rollback",!0))})))}updateMediaEntitiesWithLocalTracks(){this.mediaTracks&&(this.mediaEntities.forEach((e=>e.setLocalTrackId(null))),this.mediaTracks.forEach((e=>{const t=this.getMediaEntitiesByModality(e.modality)[0];t?t.setLocalTrackId(e.trackId):this.logger.safe.error(`Media entity is not found for modality: ${JSON.stringify(e.modality)}`)})))}updateMediaEntitiesWithActivityState(e,t){this.logger.safe.debug(`Updating activity indexes for ${e} to ${JSON.stringify(t)}`);const i=jg(e),n=this.getMediaEntitiesByModality(i)[0];if(!n)return void this.logger.safe.error(`Media entity is not found for modality: ${JSON.stringify(i)}`);const r=n.getSimulcastContext();r&&(r.activeRids=t)}setRollbackUpdateHandler(e){this.rollbackHandlers.push(e)}saveRtpHeaderExtensions(e,t){if(e.isDisabled())return void e.setRtpHeaderExtensions(void 0);const i=t.ext?.map((e=>this.getHeaderExtension(e)));this.logger.safe.debug(`RTP header ext for mid=${t.mid}, modality=${e.getModality()}: ${JSON.stringify(i)}`),e.setRtpHeaderExtensions(i)}getHeaderExtension(e){let t="unknown";for(const[i,n]of Object.entries(xL))if(e.uri.endsWith(i)){t=n;break}return{headerType:t,value:e.value}}saveRemoteMsid(e,t){if(AR(t))e.setRemoteStreamId(null);else if(t.msid)e.setRemoteStreamId(t.msid.split(" ")[0]);else if(t.ssrcs){const i=t.ssrcs.find((e=>"msid"===e.attribute));i?e.setRemoteStreamId(i.value.split(" ")[0]):this.logger.safe.warn(`No ssrc msid for media of type ${t.type} with mid ${t.mid}`)}}saveRemoteSsrc(e,t){if(t.ssrcs?.length){const i=t.ssrcs[0];e.setRemoteSsrc(i.id)}}saveLocalSsrc(e,t){const i=t.ssrcs?.[0]?.id;if(!Ag(t.direction))return void e.setLocalSsrc(i);const n=i||e.getLocalSsrc()||this.ssrcGenerator.nextVideoStreamSsrc().min;e.setLocalSsrc(n)}updateMediaEntitiesFromModel(e,t,i){e.media.forEach(((e,n)=>{this.mediaEntities[n]?AR(e)?this.mediaEntities[n].disable():this.mediaEntities[n].update(this.mediaEntities[n].getModality(),e.mid||this.mediaEntities[n].getMid()):t||this.createMediaEntity(_R(e),e.mid||n.toString()),this.mediaEntities[n]&&i&&!(this.mediaEntities[n].getModality()in i)&&this.mediaEntities[n].disable()}))}updateSharingEntity(e){if(e&&!this.getMediaEntitiesByModality(tt.MODALITY.sharing).length){const e=this.getMediaEntitiesByModality(tt.MODALITY.video).pop();e.update(tt.MODALITY.sharing,e.getMid())}}setSimulcastContext(e){if(!e||e.getSimulcastContext())return;const t=new LL(e,this.logger.createChild(`SimContext:${e.getModality()}`),this.configProvider);e.setSimulcastContext(t)}generateSourceStreamId(e){return e+10}updateReinvitelessState(e){const t={[tt.MODALITY.audio]:0,[tt.MODALITY.video]:0,[tt.MODALITY.sharing]:0};for(const i of e.media){const e=_R(i);void 0!==t[e]&&t[e]++;const n=this.getMediaEntityByMid(i.mid);if(n){const r=this.context.reinviteltessContext?.maxStreamsForModality[e]>=t?.[e]&&(!i.direction||"sendrecv"===i.direction);n.setExtension("reinviteless",r)}}}},UL=class extends EN{constructor(e,t,i){super(e,t,2,i)}init(e){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"init",args:[e]}})}setCodec(e,t){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"setCodec",args:[e,t]}})}passWriteableStreams(e,t){const i=e.concat(t);this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"passWriteableStreams",args:[e,t]}},i)}setAvailableStreams(e){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"setAvailableStreams",args:[e]}})}setRecvPayloads(e){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"setRecvPayloads",args:[e]}})}debugLogging(e){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"debugLogging",args:[e]}})}sendApiRecordingData(){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"sendApiRecordingData",args:[]}})}},VL=class{constructor(e){this.logger=e,this.audioContext=new AudioContext,this.destination=this.audioContext.createMediaStreamDestination()}get stream(){return this.destination.stream}isSingleInputStream(){return 0===this.mixerImp?.mixerType}dispose(){this.audioContext.close(),this.audioContext=null}setMixerType(e,t){this.mixerImp?.mixerType!==e&&(this.mixerImp?.reset(),this.mixerImp=this.createMixer(e),this.mixerImp.setupMixer(this.audioContext,this.destination,t))}setStreamSources(e){this.mixerImp.setStreamSources?.(e)}setParticipantSpatialAudioPositions(e){this.mixerImp.setParticipantSpatialAudioPositions?.(e)}createMixer(e){switch(e){case 0:return new BL;case 1:return new $L(this.logger.createChild("MixingStreamsMixer"));case-1:return new HL;default:throw new Error(`unknown mixer type: ${e}`)}}},HL=class{constructor(){this.mixerType=-1}reset(){}setupMixer(e,t,i){}},BL=class{constructor(){this.mixerType=0}reset(){this.sourceNode.disconnect()}setupMixer(e,t,i){this.sourceNode=e.createMediaStreamSource(i[0]),this.sourceNode.connect(t)}},$L=class{constructor(e){this.logger=e,this.sourcePositions=new Map,this.pannerNodes=[],this.mixerType=1}reset(){for(const e of this.pannerNodes)e.disconnect();this.pannerNodes=[]}setupMixer(e,t,i){for(const n of i){const i=e.createMediaStreamSource(n),r=new PannerNode(e,{panningModel:"HRTF"});i.connect(r),r.connect(t),this.pannerNodes.push(r)}this.logger.safe.info(`setupMixer is done for ${i.length} streams.`)}setStreamSources(e){for(let t=0;t<e.length;t++)this.setStreamPosition(t,e[t])}setParticipantSpatialAudioPositions(e){this.sourcePositions=new Map(e.map((e=>[e.sourceId,e])))}setStreamPosition(e,t){const i=this.sourcePositions.get(t)??{sourceId:t,x:0,y:0},n=this.pannerNodes[e];n.positionX.value=i.x,n.positionY.value=i.y}},jL=class extends Ye{constructor(e){super(),this.logger=e,this.mediaStreams=[],this.cnStream=null,this.isActive=!1}get active(){return this.isActive}get streams(){return this.mediaStreams}get comfortNoiseStream(){return this.cnStream}setupStreams(e,t){this.logger.safe.debug(`setup ${e} streams with extra Comfort Noise stream: ${t}`),this.mediaStreams=[];const i=[];for(;e--;){const e=new MediaStreamTrackGenerator({kind:"audio"});i.push(e),this.streams.push(new MediaStream([e]))}const n=t?new MediaStreamTrackGenerator({kind:"audio"}):null;return this.cnStream=n?new MediaStream([n]):null,this.event("onStreamsChanged").raise(),{streams:i.map((e=>e.writable)),cnStream:n?.writable}}setStreamSources(e){this.isActive&&this.event("onStreamSourcesUpdated").raise(e)}activateUnmixedProvider(e){this.isActive!==e&&(this.isActive=e,this.event("onActiveStateChanged").raise())}},GL=class extends Qe{constructor(e,t){super(),this.logger=e,this.maxNumOfStreamsFactor=t,this.statsProvider=new WL,this.streamMixer=new VL(this.logger),this.unmixedAudioProvider=new jL(this.logger),this.codec="None",this.recvPayloads=[],this.initCompleted=!1,this.enabledApiRecording=!1;try{this.enabledApiRecording="true"===localStorage.getItem("enableApiRecording")}catch{}this.injectWebMA()}get stream(){return this.streamMixer.stream}dispose(){super.dispose(),this.streamMixer.dispose(),this.removeWebMA()}activateTransform(e){this.logger.safe.debug("Activating WASM decoder transform"),e.addTransform(this)}deactivateTransform(){this.logger.safe.debug("Deactivating WASM decoder transform"),this.imp=null,this.initCompleted=!1,this.codec="None",this.streamMixer.setMixerType(-1,[])}createBaseInstanse(e){this.logger.warn("WASM decoder could only be instantiated in worker")}createWorkerInstanse(e,t){this.imp=function(e,t,i){return new UL(e,t,i)}(e,t,this),this.imp.init(this.enabledApiRecording)}setCodec(e){if(this.logger.safe.debug(`Setting codec to ${e}`),!this.initCompleted)return this.logger.safe.debug("Decoder is not initialized yet, postponing codec setting"),void(this.codec=e);this.codec!==e&&(this.codec=e,this.setCodecInternal())}setRecvPayloads(e){this.recvPayloads=e,this.imp?.setRecvPayloads(e)}negotiationCompleted(e){this.logger.safe.debug(`Negotiation completed, negotiated=${e}`),e||(this.codec="None",this.imp?.setCodec(this.codec,this.streamMixer.isSingleInputStream()))}setParticipantSpatialAudioPositions(e){this.streamMixer.setParticipantSpatialAudioPositions(e)}getStatsProvider(){return this.statsProvider}getUnmixedAudioProvider(){return this.unmixedAudioProvider}async storeApiRecording(){if(this.enabledApiRecording&&this.initCompleted)return this.recordingCompletePromise?.resolve(),this.recordingCompletePromise=new Mu,this.imp.sendApiRecordingData(),this.recordingCompletePromise.promise}initDone(e,t){if(this.healerCapabilities=t,this.logger.safe.info(`Init done, errorCode=${e}`),0!==e)return void this.event("initFailed").raise(e);this.logger.safe.info(`healerCapabilities=${JSON.stringify(t)}`),this.initCompleted=!0;const i=Math.floor(this.healerCapabilities.maxNumStreamsPerPacket*this.maxNumOfStreamsFactor),n=this.unmixedAudioProvider.setupStreams(i,!0);this.imp.passWriteableStreams(n.streams,n.cnStream),this.setCodecInternal(),this.imp.setRecvPayloads(this.recvPayloads)}usedDecoderChanged(e){this.logger.safe.info(`Used decoder changed to custom=${e}, configured codec=${this.codec}`),this.event("usedDecoderChanged").raise(e),this.unmixedAudioProvider.activateUnmixedProvider(e&&"MUCHv2"===this.codec)}packetReceived(e,t,i){this.statsProvider.ssrc=t,this.statsProvider.addPushStats(e,i)}newDataWrittenToStreams(e){const t=Array.from(new Int32Array(e));this.unmixedAudioProvider.setStreamSources(t),this.streamMixer.setStreamSources(t);const i=t.reduce(((e,t,i)=>(0===t&&e.push(i),e)),[]);this.imp?.setAvailableStreams(i)}packetDecoded(e,t,i){this.statsProvider.addPullStats(e,t,i,i.extra.samplingRatekHz*this.healerCapabilities.frameLengthMs)}apiRecordingAvailable(e,t,i){if(this.logger.safe.debug(`API recording available: errorCode=${e}, name=${t}, buffer length=${i.byteLength}`),this.recordingCompletePromise?.resolve(),0===i.byteLength)return;const n=new Blob([i],{type:"application/octet-stream"}),r=URL.createObjectURL(n),s=document.createElement("a");s.href=r,s.download=t,s.click()}setCodecInternal(){this.streamMixer.setMixerType(function(e){switch(e){case"SatinFB":return 0;case"MUCHv2":return 1;case"None":return-1;default:throw new Error(`unknown codec: ${e}`)}}(this.codec),this.unmixedAudioProvider.streams),this.imp.setCodec(this.codec,this.streamMixer.isSingleInputStream()),this.statsProvider.codecName=this.codec}injectWebMA(){const e=window.webMA;e&&(e.wasmDecoder={debugLogging:e=>this.imp?.debugLogging(e),sendApiRecordingData:()=>this.imp?.sendApiRecordingData()})}removeWebMA(){const e=window.webMA;e&&delete e.wasmDecoder}},WL=class{constructor(){this.customHealerStats={numSamplesPerFrame:0,FECPayloadDecodedSamples:0,concealSamples:0,stretchSamples:0,healedSamples:0,decodedSamples:0,redPacketsCount:0,pushProcessingTimes:{},pullProcessingTimes:{},pullProcessingTimePerStreamNumber:{},pullNumOfStreamsCounter:{}},this.inboudStats={silentConcealedSamples:0,concealedSamples:0,totalSamplesReceived:0,audioLevel:0,jitterBufferDelay:0,jitterBufferEmittedCount:0},this.decoderStats={pushCount:0,pushErrCount:0,pullCount:0,pullErrCount:0},this.packetPushProccesingTimes=new qL(0,1e3),this.packetPullProccesingTimes=new qL(0,1e3),this.numOfStreamsCounter=new qL(0,10),this.pullProcessingTimePerStreamNumber={}}get codecName(){return this.codec}set codecName(e){this.codec=e}addPushStats(e,t){this.decoderStats.pushCount++,this.decoderStats.pushErrCount+=0!==e?1:0,this.inboudStats.jitterBufferDelay+=t.webrtc.jitterBufferDelay,this.customHealerStats.packetDurationInMs=t.extra.packetDurationInMs,this.packetPushProccesingTimes.addSample(t.extra.processingTime),this.customHealerStats.pushProcessingTimes=this.packetPushProccesingTimes.getFrequencies(),this.customHealerStats.cnpPushCount=t.extra.totalCountCNPackets,this.customHealerStats.redPacketsCount+=0!==t.extra.redundancyTimestampOffset?1:0}addPullStats(e,t,i,n){var r;this.decoderStats.pullCount++,this.decoderStats.pullErrCount+=0!==e?1:0,this.inboudStats.audioLevel=i.webrtc.audioLevel,this.inboudStats.totalAudioEnergy=i.webrtc.totalAudioEnergy,this.inboudStats.jitterBufferEmittedCount=i.webrtc.jitterBufferEmittedCount,this.inboudStats.totalSamplesReceived=i.webrtc.totalSamplesReceived,this.inboudStats.concealedSamples=i.webrtc.concealedSamples,this.inboudStats.silentConcealedSamples=i.webrtc.silentConcealedSamples,this.numOfStreamsCounter.addSample(t),this.customHealerStats.FECPayloadDecodedSamples=i.extra.FECPayloadDecodedSamples,this.customHealerStats.numSamplesPerFrame=n,this.customHealerStats.pullAdspPayloadType=i.extra.pullAdspPayloadType,this.customHealerStats.concealSamples=i.extra.concealSamples,this.customHealerStats.stretchSamples=i.extra.stretchSamples,this.customHealerStats.healedSamples=i.extra.healedSamples,this.customHealerStats.decodedSamples=i.extra.decodeSamples,this.packetPullProccesingTimes.addSample(i.extra.processingTime),this.customHealerStats.pullProcessingTimes=this.packetPullProccesingTimes.getFrequencies(),this.customHealerStats.cnpPullCount=i.extra.totalCountCNGeneratedFrames,this.customHealerStats.cngSamples=i.extra.cngSamples,this.customHealerStats.pullNumOfStreamsCounter=this.numOfStreamsCounter.getFrequencies(),(r=this.pullProcessingTimePerStreamNumber)[t]??(r[t]=new qL(0,200)),this.pullProcessingTimePerStreamNumber[t].addSample(i.extra.processingTime);for(const e of Object.keys(this.pullProcessingTimePerStreamNumber))this.customHealerStats.pullProcessingTimePerStreamNumber[e]=this.pullProcessingTimePerStreamNumber[e].getFrequencies()}getWebRtcCompatibaleStats(){return this.inboudStats}getWasmStats(){return this.customHealerStats}getDecoderStats(){return this.decoderStats}},qL=class{constructor(e,t){this.minSample=e,this.maxSample=t,this.frequencyDict={}}addSample(e){if(void 0===e)return;const t=Math.min(this.maxSample,Math.max(this.minSample,e));this.frequencyDict[t]=(this.frequencyDict[t]??0)+1}getFrequencies(){return{...this.frequencyDict}}},zL=class extends EN{constructor(e,t,i){super(e,t,3,i)}init(e){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"init",args:[e]}})}setCodec(e){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"setCodec",args:[e]}})}debugLogging(e){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"debugLogging",args:[e]}})}},KL=["SatinFB"],JL=class extends Qe{constructor(e){super(),this.logger=e,this.codec="None",this.injectWebMA()}dispose(){super.dispose(),this.removeWebMA()}activateTransform(e){this.logger.safe.debug("Activating WASM encoder transform"),e.addTransform(this)}deactivateTransform(){this.logger.safe.debug("Deactivating WASM encoder transform"),this.imp=null,this.encodersInitCodes=void 0,this.codec="None"}createBaseInstanse(e){this.logger.warn("WASM encoder could only be instantiated in worker")}createWorkerInstanse(e,t){this.imp=function(e,t,i){return new zL(e,t,i)}(e,t,this),this.imp.init(KL)}setCodec(e){if(this.logger.safe.debug(`Setting codec to ${e}`),!this.encodersInitCodes)return this.logger.safe.debug("Encoder is not initialized yet, postponing codec setting"),void(this.codec=e);this.codec!==e&&(this.codec=e,this.setCodecInternal())}isCodecAllowed(e){return KL.includes(e)}negotiationCompleted(e){e||(this.codec="None",this.imp?.setCodec(this.codec))}initDone(e){this.logger.safe.info(`initDone: ${JSON.stringify(e)}`),this.encodersInitCodes=e,this.setCodecInternal()}packetEncoded(e){0!==e&&this.logger.safe.info(`encode failed: ${e}`)}setCodecInternal(){const e=this.encodersInitCodes[this.codec]??-2147024809;if("None"!==this.codec&&0!==e)return this.logger.safe.error(`WASM encoder is failed to init codec ${this.codec}, err code: ${e}`),void this.event("initCodecFailed").raise(e);this.imp.setCodec(this.codec)}injectWebMA(){const e=window.webMA;e&&(e.wasmEncoder={debugLogging:e=>this.imp?.debugLogging(e)})}removeWebMA(){const e=window.webMA;e&&delete e.wasmEncoder}},YL=i(496486),QL=class extends Qe{constructor(e,t,i){super(),this.encStreamsManager=e,this.logger=t,this.configProvider=i,this.isEnabled=!1,this.sessionStats=new ZL,this.subs=[],this.codecContext=this.configProvider.mediaConfig.audioCodecContext,this.codecConfig=this.configProvider.config.useInsertableStreams?.audioWasmCodec}get decoder(){return this.decoderImp}get encoder(){return this.encoderImp}init(e){if(!e||!this.codecContext||!this.codecConfig?.enable)return;this.isEnabled=!0;const t=this.codecConfig.maxNumOfStreamsFactor||1;this.decoderImp=new GL(this.logger.createChild("AudioWasmDecoder"),t),this.codecConfig.enableSend&&(this.encoderImp=new JL(this.logger.createChild("AudioWasmEncoder"))),this.subscribeToStreamManagerEvents(this.encStreamsManager),this.subscribeToCodecsEvents()}dispose(){super.dispose(),this.unsubscribeFromEvents(),this.decoderImp?.dispose(),this.encoderImp?.dispose()}getSessionEvents(){return this.sessionStats.getSessionEvents()}prepareForNegotiation(e){if(!this.isEnabled)return;const t=this.configProvider.mediaConfig.spatialAudioEnabled?"MUCHv2":this.codecConfig.codec||"None";this.codecContext.codec!==t&&(this.codecContext.initSendFailed=!1),this.codecContext.lastUsedCodec=this.codecContext.codec,this.codecContext.codec=t,this.codecContext.enabledLocally=!this.codecContext.initFailed&&"None"!==t,this.codecContext.enabledForSend=this.codecContext.enabledLocally&&!this.codecContext.initSendFailed&&!!this.codecConfig?.enableSend&&this.encoder?.isCodecAllowed(t),this.logger.safe.info(`Audio codec state: context=${JSON.stringify(this.codecContext)}`),this.codecContext.initFailed||!e&&this.codecContext.disabledRemotely||(this.sessionStats.toggleState("None"!==t),this.decoderImp?.setCodec(t),this.encoderImp?.setCodec(this.codecContext.enabledForSend?t:"None"))}negotiationCompleted(){if(!this.isEnabled)return!1;const e=this.codecContext.enabledLocally&&!this.codecContext.disabledRemotely;return this.decoderImp?.negotiationCompleted(e),this.encoderImp?.negotiationCompleted(e),this.sessionStats.negotiationCompleted(e,this.codecContext.enabledForSend),e}configureSpatialAudio(e,t){return!!this.isEnabled&&((e&&"MUCHv2"!==this.codecContext.codec||!e&&"MUCHv2"===this.codecContext.codec)&&this.event("negotiationNeeded").raise(t),!0)}subscribeToStreamManagerEvents(e){this.subs.push(e.on("onTransformsCollectionCreated",(e=>this.handleTransformsCollectionCreated(e))),e.on("onTransformsCollectionCleared",(e=>this.handleTransformsCollectionCleared(e))))}handleTransformsCollectionCreated(e){"Audio"===e.mediaType&&(this.decoderImp&&"Receiver"===e.objType?this.decoderImp.activateTransform(e.collection):this.encoderImp&&"Sender"===e.objType&&this.encoderImp.activateTransform(e.collection))}handleTransformsCollectionCleared(e){"Audio"===e.mediaType&&(this.decoderImp&&"Receiver"===e.objType?this.decoderImp.deactivateTransform():this.encoderImp&&"Sender"===e.objType&&this.encoderImp.deactivateTransform())}subscribeToCodecsEvents(){this.decoderImp&&this.subs.push(this.decoderImp.on("initFailed",(e=>this.handleCodecInitFailed("decoder",e)))),this.encoderImp&&this.subs.push(this.encoderImp.on("initCodecFailed",(e=>this.handleCodecInitFailed("encoder",e))))}unsubscribeFromEvents(){this.subs.forEach((e=>e.dispose())),this.subs=[]}handleCodecInitFailed(e,t){"decoder"===e?this.codecContext.initFailed=!0:this.codecContext.initSendFailed=!0;const i=Re();this.logger.safe.warn(`[${i}] Audio ${e} init failed ${t}`),this.sessionStats.initFailed(t,e),this.event("negotiationNeeded").raise(i)}},XL=class e{constructor(){this.sessionEvents={negotiationAttempts:[],toggleCount:0,negotiatedCount:0,failedNegotiationCount:0,decoderInitError:0,encoderInitError:0}}toggleState(t){this.sessionEvents.toggleCount++,this.inProgressNegotiation={ts:Date.now(),enabled:t,negotiated:!1,sendEnabled:!1},At(this.sessionEvents.negotiationAttempts,this.inProgressNegotiation,e.maxStoreNegotiations)}negotiationCompleted(e,t){this.inProgressNegotiation&&(this.sessionEvents.negotiatedCount+=e?1:0,this.sessionEvents.failedNegotiationCount+=this.inProgressNegotiation.enabled&&!e?1:0,this.inProgressNegotiation.negotiated=e,this.inProgressNegotiation.sendEnabled=t,this.inProgressNegotiation=void 0)}initFailed(e,t){"decoder"===t?this.sessionEvents.decoderInitError=e:this.sessionEvents.encoderInitError=e}getSessionEvents(){return(0,YL.clone)(this.sessionEvents)}};XL.maxStoreNegotiations=5;var ZL=XL,ex=class extends Qe{constructor(e,t){super(),this.configProvider=e,this.logger=t,this.bandwidthEstimationAvailable=!1,this.smoothingWindow=[],this.totalSamples=0,this.isStarted=!1,this.maxCountStatic=this.configProvider.config.ovcMaxCount,this.previousParticipantsCount=0;const i=window.navigator;this.updateStaticConstraint(i.hardwareConcurrency,this.configProvider.config.ovcAvailableConcurrencyForBiggerGrid,4),this.updateStaticConstraint(i.deviceMemory,this.configProvider.config.ovcMemoryForBiggerGrid,4),this.throttler=new tx(this.logger.createChild("ovcThrottler"),this.configProvider.config.ovcRampDownCooldown,this.configProvider.config.ovcRampUpCooldown)}start(){this.isStarted=!0,this.throttler.changed((()=>this.event("calculatorStateChanged").raise(2,{ovc:this.throttler.value,ovcPayload:this.payload})))}stop(){this.isStarted=!1}dispose(){super.dispose(),this.throttler.dispose()}processEstimatedBandwidth(e){const t=this.getOVCEstimate(e),i=Math.max(1,Math.min(t,this.maxCountStatic));this.payload={bandwidth:e,reason:0},this.throttler.setValue(i,0)}updateParticipantCount(e){if(!this.configProvider||e===this.previousParticipantsCount)return;const t=this.configProvider.config.ovcXLParticipantsCount;e>t&&this.previousParticipantsCount<=t&&(this.maxCountStatic=this.configProvider.config.ovcMaxCountXL),e<=t&&this.previousParticipantsCount>t&&(this.maxCountStatic=this.configProvider.config.ovcMaxCount),this.previousParticipantsCount=e;let i=this.maxCountStatic;this.payload?.bandwidth&&(i=this.getOVCEstimate(this.payload.bandwidth),this.payload.reason=1),this.throttler.setValue(Math.max(1,Math.min(i,this.maxCountStatic)),1)}getOVCEstimate(e){this.bandwidthEstimationAvailable||(this.bandwidthEstimationAvailable=this.isStarted&&e>0&&(this.totalSamples++>=this.configProvider.config.ovcIgnoreFirstSamples||Math.floor(e)/this.configProvider.config.ovcBandwidthPerVideoReceiver>=this.configProvider.config.nonEstimatedDefaultVideoReceiversCount));let t=this.configProvider.config.nonEstimatedDefaultVideoReceiversCount;return this.bandwidthEstimationAvailable&&(t=Math.floor(this.sampleSmoothed(e)/this.configProvider.config.ovcBandwidthPerVideoReceiver)),t}sampleSmoothed(e){if(this.smoothingWindow.length>=this.configProvider.config.ovcSlidingWindowSamples?this.smoothingWindow.shift():this.smoothingWindow.length===this.configProvider.config.ovcSlidingWindowSamples-1&&(this.smoothingWindow=this.smoothingWindow.map((()=>e))),this.smoothingWindow.push(e),this.smoothingWindow.length>=this.configProvider.config.ovcSlidingWindowSamples){const e=this.smoothingWindow.slice().sort(),t=at(e);return e[e.length-1]-(e[e.length-1]-t*(1-this.configProvider.config.ovcSlidingWindowPercentile))}return e}updateStaticConstraint(e,t,i){e&&e<t&&(this.maxCountStatic=Math.min(this.maxCountStatic,i))}},tx=class extends Qe{constructor(e,t,i){super(e),this.logger=e,this.throttleDownCooldown=t,this.throttleUpCooldown=i,this.wasRampingUp=!0,this.lastUpdateTime=0}get value(){return this.lastValue}setValue(e,t){if(e===this.lastValue)return;const i=e>this.lastValue,n=void 0!==this.lastValue&&i!==this.wasRampingUp?i?this.throttleUpCooldown:this.throttleDownCooldown:-1,r=Date.now();r-this.lastUpdateTime<n&&(1!==t||i)||(void 0!==this.lastValue&&(this.lastUpdateTime=r,this.wasRampingUp=i),this.logger.safe.info(`optimal video receivers count updated ${this.lastValue} -> ${e}`),this.lastValue=e,this.raiseChanged())}},ix=class e{constructor(e,t=30){this.logger=e,this.maxEventNum=t,this.report=[],this.started=!1}isSupported(){return Boolean(window.chrome?.runtime?.connect)}start(){this.isSupported?(this.started=!0,this.logger.debug("Starting collecting CPU metric"),this.port=window.chrome.runtime.connect(e.extensionID,{name:e.extensionName}),this.port.onMessage.addListener((e=>{e&&At(this.report,{timeStamp:Date.now(),value:e},this.maxEventNum)}))):this.logger.debug("Chrome runtime is not supported")}stop(){this.port?.disconnect(),this.port=null,this.started=!1}getSamples(){return this.report}getLastSample(){return wt(this.report)}getCurrentCpuSample(){return new Promise(((t,i)=>{this.started&&t(wt(this.report)),this.isSupported()||i("Not supported"),this.port=window.chrome.runtime.connect(e.extensionID,{name:e.extensionName}),this.port.onMessage.addListener((e=>{this.stop(),e||i("Not supported"),t({timeStamp:Date.now(),value:e})}))}))}clearStats(){this.report=[]}};ix.extensionID="nkeimhogjdpnpccoofpliimaahmaaome",ix.extensionName="processCpu";var nx=ix,rx=class{constructor(e){this.logger=e,this.started=!1}static isSupported(){return void 0!==globalThis.PressureObserver}get cpuState(){return this.currentCpuState}start(){if(this.logger.safe.debug("Starting CPU pressure observer"),this.started)this.logger.safe.debug("CPU pressure observer is already started");else{try{this.cpuObserver=new globalThis.PressureObserver((e=>{e.forEach((t=>{"cpu"===t.source&&this.currentCpuState!==t.state&&(this.logger.safe.debug(`CPU pressure state changed: ${JSON.stringify(e)}`),this.currentCpuState=t.state)}))}),{sampleRate:1})}catch(e){throw this.logger.safe.error(`Error while creating pressure observer: ${e}`),e}this.started=!0,this.cpuObserver?.observe("cpu")}}stop(){this.started=!1,this.cpuObserver?.disconnect()}},sx=class{static getStrategy(e){switch(e.config.diagnostics.performanceMonitoring.monitoringStrategy){case"decodeTime":default:return new ax(e);case"renderedFps":return new ox(e);case"rendererVolatility":return new lx(e)}}},ax=class{constructor(e){this.configProvider=e,this.decodeThresholds=this.configProvider.config.diagnostics.performanceMonitoring.decodeThresholds,this.defaultThreshold=this.configProvider.config.diagnostics.performanceMonitoring.defaultThrehold,this.badPerfCount=new Map}checkQuality(e){let t=!1,i=!1;const n=this.decodeThresholds[e.frameHeight]||this.defaultThreshold,r=e.decodeTimeTracker.getReport();return r.median>n.maxDecodeTime&&(this.badPerfCount.set(e.msi,this.badPerfCount.get(e.msi)||1),t=!0),r.median<n.maxDecodeTime&&this.badPerfCount.get(e.msi)&&(this.badPerfCount.set(e.msi,this.badPerfCount.get(e.msi)-1),i=!0),t?0:i?2:1}},ox=class{constructor(e){this.configProvider=e,this.fpsDiffThresholds=this.configProvider.config.diagnostics.performanceMonitoring.fpsDiffThresholds,this.defaultFpsDiffThreshold=this.configProvider.config.diagnostics.performanceMonitoring.defaultFpsDiffThreshold,this.badPerfCount=new Map}checkQuality(e){let t=!1,i=!1;const n=this.fpsDiffThresholds[e.frameHeight]||this.defaultFpsDiffThreshold,r=e.incomingFps.getReport(),s=e.rendererFps.getReport(),a=r.median-s.median;return a>=n.fpsDiff&&(this.badPerfCount.set(e.msi,this.badPerfCount.get(e.msi)||1),t=!0),a<n.fpsDiff&&this.badPerfCount.get(e.msi)&&(this.badPerfCount.set(e.msi,this.badPerfCount.get(e.msi)-1),i=!0),t?0:i?2:1}},lx=class{constructor(e){this.configProvider=e,this.volatilityThresholds=this.configProvider.config.diagnostics.performanceMonitoring.volatilityThresholds,this.defaultVolatilityThreshold=this.configProvider.config.diagnostics.performanceMonitoring.defaultVolatilityThreshold,this.badPerfCount=new Map}checkQuality(e){let t=!1,i=!1;const n=this.volatilityThresholds[e.frameHeight]||this.defaultVolatilityThreshold,r=e.rendererFps.getReport(),s=e.incomingFps.getReport(),a=Math.abs(r.volatilityPercent-s.volatilityPercent);return n&&a>=n&&(this.badPerfCount.set(e.msi,this.badPerfCount.get(e.msi)||1),t=!0),a<n&&this.badPerfCount.get(e.msi)&&(this.badPerfCount.set(e.msi,this.badPerfCount.get(e.msi)-1),i=!0),t?0:i?2:1}},dx=class extends Qe{constructor(e,t,i,n){super(),this.statsGatherer=e,this.diagnostics=t,this.configProvider=i,this.logger=n,this.paused=!1,this.started=!1,this.cpuMetricCollector=new nx(this.logger,this.configProvider.config.diagnostics.performanceMonitoring.cpuMetricCollector),this.trackInterval=this.configProvider.config.diagnostics.performanceMonitoring.remoteVideoTrackInterval,this.badPerfIds=new Set,this.perfTrackerMap=new Map,this.subs=[],this.rendererFpsCap=40,this.configProvider.config.diagnostics.performanceMonitoring.useComputePressure&&rx.isSupported()&&(this.cpuPressureObserver=new rx(this.logger))}start(){this.logger.safe.debug("Starting RemoteVideoPerformanceCalculator"),this.started?this.logger.safe.debug("RemoteVideoPerformanceCalculator already running. Do nothing."):(this.calculatorStrategy=sx.getStrategy(this.configProvider),this.started=!0,this.cpuPressureObserver?.start(),this.subs.push(this.statsGatherer.on("onDiagnosticUpdated",(e=>this.processStats(e)))))}stop(){this.logger.safe.debug("Stopping RemoteVideoPerformanceCalculator"),this.started=!1,this.subs.forEach((e=>{e.dispose()})),this.cpuMetricCollector.stop(),this.cpuPressureObserver?.stop()}dispose(){this.logger.safe.debug("Disposing RemoteVideoPerformanceCalculator"),this.cleanupMaps(),this.stop()}cleanupMaps(){this.badPerfIds.clear(),this.perfTrackerMap.clear()}async processStats(e){this.paused||e.video?.recv?.length&&e.video?.recv?.forEach((async t=>{const i=t.renderer?.msi;if(!this.perfTrackerMap.has(i)){const e={id:t.mediaEntity.remoteTrackId,decodeTimeTracker:new zO(this.trackInterval),macroblockLossTracker:new zO(this.trackInterval),macroblockMaxLossTracker:0,freezeDurationPercent:0,frameHeight:0,rendererFps:new zO(this.trackInterval),incomingFps:new zO(this.trackInterval),framesReceived:0,framesDecoded:0,decoder:"",msi:i};this.perfTrackerMap.set(i,e)}const n=this.perfTrackerMap.get(i);if(t.inboundRTP.totalDecodeTime&&t.inboundRTP.framesDecoded){const e=bt(t.inboundRTP.totalDecodeTime/t.inboundRTP.framesDecoded*1e3,2);n.decodeTimeTracker.captureSample(e)}const r=t.extensions.macroblockRateStats?.macroblockRateDecoderLossPercent;n.macroblockLossTracker.captureSample(r),n.macroblockMaxLossTracker=t.extensions.macroblockRateStats?.macroblockRateMaxDecoderLossPercent,t.extensions.duration&&(n.freezeDurationPercent=t.extensions.totalFreezeDuration/t.extensions.duration*100),n.frameHeight=t.inboundRTP.frameHeight||0,void 0!==t.extensions.frameRateDecoded&&void 0!==t.inboundRTP.framesPerSecond&&t.extensions.frameRateDecoded<=this.rendererFpsCap&&t.inboundRTP.framesPerSecond<=this.rendererFpsCap&&(n.rendererFps.captureSample(t.extensions.frameRateDecoded),n.incomingFps.captureSample(t.inboundRTP.framesPerSecond)),t.inboundRTP.framesReceived&&t.inboundRTP.framesDecoded&&(n.framesReceived=t.inboundRTP.framesReceived,n.framesDecoded=t.inboundRTP.framesDecoded),n.decoder=t.inboundRTP.decoderImplementation,n.rendererFps.isReportComplete()&&n.incomingFps.isReportComplete()&&n.decodeTimeTracker.isReportComplete()&&(this.paused=!0,await this.checkQuality(n,e.perfCounters),this.paused=!1)}))}async checkQuality(e,t){const i=[];let n;try{n=await this.cpuMetricCollector.getCurrentCpuSample()}catch{this.logger.safe.debug("CPU sampling is not supported")}const r={ts:Date.now(),trackId:e.id,decodeTime:e.decodeTimeTracker.getReport(),macroblockLossPercent:e.macroblockLossTracker.getReport(),macroblockMaxLossPercent:e.macroblockMaxLossTracker,freezeDurationPercent:e.freezeDurationPercent,perfCounters:t,cpuUsage:n,rendererFps:e.rendererFps.getReport(),incomingFps:e.incomingFps.getReport(),framesDecoded:e.framesDecoded,framesReceived:e.framesReceived,msi:e.msi,frameHeight:e.frameHeight,decoder:e.decoder};i.push(r);const s=this.calculatorStrategy.checkQuality(e);0===s&&(this.diagnostics.registerVideoPerformanceEvent(i,1),this.logger.safe.debug(`Bad perf detected for msi ${e.msi}: ${JSON.stringify(i)}`),this.event("calculatorStateChanged").raise(1,{msi:e.msi})),2===s&&(this.diagnostics.registerVideoPerformanceEvent(i,0),this.logger.safe.debug(`Good perf detected for msi ${e.msi}: ${JSON.stringify(i)}`),this.event("calculatorStateChanged").raise(0,{msi:e.msi})),this.perfTrackerMap.delete(e.msi)}},cx=class extends Qe{constructor(e,t,i,n){super(),this.statsGatherer=e,this.diagnostics=t,this.configProvider=i,this.logger=n,this.calculators=new Map,this.subs=[]}on(e,t){switch(e){case"onIncomingVideoQualityChanged":this.addCalculator(0),this.startCalculator(0);break;case"onOptimalVideoCountChanged":this.addCalculator(2),this.startCalculator(2)}return this.subscribe({changed:void 0,on:{name:String(e),handler:t}})}addCalculator(e){let t=this.calculators.get(e);if(!t){switch(e){case 0:if(!this.configProvider.config.diagnostics.performanceMonitoring.enableRemoteVideoCalculator)return;t=new dx(this.statsGatherer,this.diagnostics,this.configProvider,this.logger.createChild("RemoteVideoPerformanceCalculator"));break;case 2:if(!this.configProvider.config.enableOptimalVideoCount)return;t=new ex(this.configProvider,this.logger.createChild("OptimalVideoCountCalculator"));break;case 1:throw new Error("Not implemented")}this.subs.push(t.on("calculatorStateChanged",((t,i)=>{this.handleChanged(e,t,i)}))),this.calculators.set(e,t)}}startCalculator(e){this.logger.safe.debug(`adding calculator with id ${e}`);const t=this.calculators.get(e);t&&t.start()}stopCalculator(e){this.logger.safe.debug(`stopping calculator with id ${e}`);const t=this.calculators.get(e);t&&t.stop()}processNotification(e,t){switch(e){case"BandwithNotification":this.calculators.get(2)?.processEstimatedBandwidth(t.bw);break;case"ParticipantCountChanged":this.calculators.get(2)?.updateParticipantCount(t.count);break;default:this.logger.safe.info(`Notification message handler not found for type: ${e}`)}}dispose(){super.dispose(),this.calculators.forEach((e=>{e.dispose()})),this.subs.forEach((e=>{e.dispose()}))}handleChanged(e,t,i){switch(this.logger.info(`calculatorStateChanged  ${t}: calculatorType ${e} ${JSON.stringify(i)}`),e){case 0:this.configProvider.config.diagnostics.performanceMonitoring.enableLowerResolution&&this.event("onIncomingVideoQualityChanged").raise(t,i?.msi);break;case 2:this.event("onOptimalVideoCountChanged").raise(i?.ovc,i?.ovcPayload)}}},hx=i(496486),ux=class{constructor(e){this.configProvider=e,this.outboundNetworkQuality="Good",this.inboundNetworkQuality="Good",this.jitterAccumulator=new zA(this.configProvider.config.webrtcJitterWindowSize),this.healedRatioAccumulator=new zA(this.configProvider.config.webrtcHealedRatioWindowSize),this.jitterStateProcessor=new YD(e.config.webrtcJitterLowThreshold,e.config.webrtcJitterHighThreshold,!0,e.config.webrtcJitterSticknessTime),this.lossRateStateProcessor=new YD(e.config.webrtcLossRateLowThreshold,e.config.webrtcLossRateHighThreshold,!0,e.config.webrtcLossRateSticknessTime)}processReport(e){e.audio?.recv?.length&&(this.inboundNetworkQuality=this.processInboundSample((0,hx.last)(e.audio.recv))),e.audio?.send?.length&&(this.outboundNetworkQuality=this.processOutboundSample((0,hx.last)(e.audio.send)))}getInboundNetworkQuality(){return this.inboundNetworkQuality}getOutboundNetworkQuality(){return this.outboundNetworkQuality}processInboundSample(e){const t=this.inboundNetworkQuality,{totalSamplesReceived:i}=e.inboundRTP,{healedRatio:n}=e.extensions??{};null!=n&&this.healedRatioAccumulator.add(n);const r=(0,hx.mean)(this.healedRatioAccumulator.items);return!i||i<this.configProvider.config.webrtcMinAudioSamplesRecvForNetworkRecvQuality?t:r&&this.healedRatioAccumulator.isFull?this.determineInboundQualityLevel(r):t}determineInboundQualityLevel(e){const t=this.inboundNetworkQuality,i=this.configProvider.config.webrtcStatNetworkDetectionHysteresis,n=this.configProvider.config.webrtcStatNetworkDetectionBadLevel,r=this.configProvider.config.webrtcStatNetworkDetectionGoodLevel;return e<r-i/2?"Good":e<r+i/2?"Good"===t?"Good":"Poor":e<n-i/2?"Poor":e<n+i/2?"Bad"===t?"Bad":"Poor":"Bad"}processOutboundSample(e){const t=this.outboundNetworkQuality,{packetsSent:i,timestamp:n}=e.outboundRTP,{jitter:r}=e.remoteInboundRTP??{},{lossRate:s}=e.extensions??{};if(!i||i<this.configProvider.config.webrtcMinPacketsSentForNetworkSendQuality)return t;null!=r&&this.jitterAccumulator.add(r);const a=(0,hx.mean)(this.jitterAccumulator.items),o=this.jitterAccumulator.isFull?this.jitterStateProcessor.onSample(a,n):"Good",l=s?this.lossRateStateProcessor.onSample(s,n):"Good";return"Good"===o&&"Good"===l?"Good":"Bad"}},px=i(496486),gx=class{constructor(e){this.configProvider=e,this.speechWindow=new zA(e.config.webrtcSpeakingWhileMutedDetectionWindow)}processReport(e){if(!e.audio?.send?.length)return!1;const t=e.audio.send[0],{rawInputVolume:i,callIsMuted:n}=t.extensions??{},{audioLevel:r}=t.mediaSource??{},{useAudioAnalyzer:s,webrtcSpeakingWhileMutedDetectionLevel:a}=this.configProvider.config;if(!n)return this.speechWindow.clear(),!1;const o=s?i:r;return null!=o&&this.speechWindow.add(o),!!this.speechWindow.isFull&&(0,px.mean)(this.speechWindow.items)>a}},mx=0,fx=class e{constructor(e,t,i){this.context=e,this.callId=t,this.callback=i,this.callbacks={},this.multiParty=this.context.config?.isConference,this.configProvider=this.context.configProvider,this.logger=this.context.getLogger().createChild("webrtc2-"+ ++mx),this.deviceManager=this.context.callDeviceManager.getDefaultDeviceManager(),this.capabilityGatherer=Nk.build({global:this.context.maContext},this.configProvider.config.useSdpCapabilities,this.configProvider.config.noRequiredCodecsWorkaround),this.reinvitelessContext=lm(this.context.config.reinvitelessConfig,this.multiParty),this.iceHostCandidateOnly=this.multiParty&&Ct("iceHostCandidateOnly",this.context.config,this.configProvider.config),this.mediaManager=new FL({logger:this.logger,configProvider:this.configProvider,numVideoChannels:this.multiParty&&this.configProvider.config.numVideoChannelsGvc||1,useSimulcast:this.multiParty,reinviteltessContext:this.reinvitelessContext}),this.sessionDescription=nM.build({sdpTransform:new DL(this.context),mediaManager:this.mediaManager,logger:this.logger,configProvider:this.configProvider,configuration:this.getStreamTransformConfiguration()}),this.allowedMediaContentType=Ct("webrtcAllowedMediaContentType",this.context.config,this.configProvider.config).concat(),this.receiveStreamCollection=new CO({streamAdded:e=>this.streamAdded(e),streamRemoved:e=>this.streamRemoved(e)}),this.diagnostics=this.context.diagnostics,this.qmDiagnostics=this.diagnostics?.newQualityManagerDiagnostics(),this.statsGatherer=new Tk(this.logger.createChild("stats"),this.configProvider,this.diagnostics,this.mediaManager,this.multiParty),this.networkQualityDiagnostics=new ux(this.configProvider),this.speechDetectionDiagnostics=new gx(this.configProvider),this.qualityManager=new oN(this.logger.createChild("qm"),{scalingEnabled:this.configProvider.config.webrtcVideoScaling,customBwEstimationEnabled:this.configProvider.config.webrtcEnabledCustomBwEstimationForVideo,sendBandwidthNotificationsEnabled:this.multiParty&&this.configProvider.config.webrtcSendBandwidthNotificationsEnabled},this,this.statsGatherer,this.qmDiagnostics,this.configProvider),this.activeSpeakerManager=new fO(this.callback.onContributingSourcesChanged,this.callback.onDominantSpeakerChanged,this.diagnostics?.dshDiagnostics,this.logger.createChild("ActiveSpeakerManager")),this.negotiationQueue=new _I(this.logger),this.negotiationEmulator=new eN(this.logger.createChild("negotiationEmulator"),kL,this.sessionDescription,this.negotiationQueue,this.mediaManager),this.extensionsManager=this.setupExtensionsManager(),this.wasConnected=!1,this.toBeCalledAfterConnected=[],this.peerConnection=null,this.doAudioMute=this.context.config.muted,this.iceCandidatesDeferred=new Mu,this.iceCandidatesTimer=null,this.relayCandidateGathered=!1,this.iceCandidateReceived=!1,this.triggerRenegotiationFlag=!1,this.canTriggerRenegotiation=!0,this.noIceCandidates=!1,this.noRelayIceCandidates=!1,this.forceMediaStreamUpdate=!1,this.negotiatedModalities={},this.disabledModalities={},this.reinvitelessRequestedModalities={},this.reinvitelessAppliedModalities={},this.iceDisconnectedTimer=null,this.statisticsReport=Promise.resolve({type:"WebRtcMediaStats",data:{}}),this.terminated=!1,this.initiator=!1,this.streamsChangedListener=null,this.dtmfSender=SN.build({logger:this.logger,configProvider:this.configProvider}),this.mediaContentType=Ct("webrtcMediaContentType",this.context.config,this.configProvider.config),this.streamsChangedNotificationScheduled=!1,this.subscriptionManager=new _O(this.logger.createChild("subs"),this.configProvider,{getStreams:()=>this.receiveStreamCollection.getStreams(),setOnStreamsChangedHandler:e=>this.streamsChangedListener=e},this.diagnostics?.newSubscriptionManagerDiagnostics()),this.remoteVideoResolutionManager=new lN(this.logger.createChild("rvrm"),this.multiParty,this.configProvider,this.mediaManager,this.statsGatherer,this.diagnostics),this.remoteVideoManager=new uN(this.logger.createChild("RemoteVideoManager"),this.configProvider,this.statsGatherer,this.diagnostics,this.remoteVideoResolutionManager,this.context.maContext.domOverrides),this.transceiverManager=null,this.encStreamsManager=new LN(this.configProvider,this.context.maContext.getEncodedStreamsWorkerProvider?.(),this.logger.createChild("EncodedStreamsManager")),this.streamSendersManager=new PL(this.mediaManager,this.logger.createChild("SSM"),this.context.callDeviceManager,this.configProvider,this.statsGatherer,this.qmDiagnostics,this.multiParty,this.encStreamsManager),this.hwSilent=!1,this.configuredModalitiesPromise=Promise.resolve(),this.negotiationCompletedPromise=new Mu,this.transportStateProvider=null,this.isMuteHold=!1,this.rawIncomingAudioStreamManager=new mp(this.logger.createChild("rawIncomingAudioStream")),this.useNullAudioStream=!1,this.audioCodecManager=new QL(this.encStreamsManager,this.logger,this.configProvider),this.perfMonitorSubs=[],this.ufdManager=e.getUfdManager(),this.statsGatherer.on("onDiagnosticUpdated",(e=>this.processStatsReport(e))),this.statsGatherer.on("onStatisticsChanged",(e=>this.processLegacyStats(e))),this.negotiationCompletedPromise.promise.catch((()=>{})),this.negotiationCompletedPromise.reject("placeholder"),this.remoteVideoResolutionManager.on("onNegotiationRequired",(()=>this.triggerRenegotiation(!0))),this.remoteVideoResolutionManager.on("onSourceRequestRequired",((e,t,i)=>this.requestSource(e,t,i))),this.performanceMonitor=new cx(this.statsGatherer,this.diagnostics,this.configProvider,this.logger.createChild("PerformanceMonitor")),this.setSubsForSubscriptionManager(),this.setSubsForStreamManagerEvents(),this.configProvider.mediaConfig.maxBandwidthInKbps&&(this.statsGatherer.setMaxSessionBandwidth(this.configProvider.mediaConfig.maxBandwidthInKbps),this.diagnostics&&(this.diagnostics.maxSessionBandwidth=this.configProvider.mediaConfig.maxBandwidthInKbps)),this.createAudioRenderer(),this.dmSub=this.getVideoDeviceManager().on("onLocalRendererStarted",(e=>e.setStatsProvider(this.statsGatherer))),this.context.callDeviceManager.isVirtualDeviceEnabled&&this.setupCallDeviceManagerSubs(),this.configProvider.config.enableActiveSpeakerBasedDSH&&this.activeSpeakerManager.setStrategy(new wL({configProvider:this.configProvider})),this.perfMonitorSubs.push(this.performanceMonitor.on("onIncomingVideoQualityChanged",((e,t)=>{this.onIncomingVideoQualityChanged(e,t)}))),this.configProvider.config.webrtcVideoScaling&&(this.perfMonitorSubs.push(this.performanceMonitor.on("onOptimalVideoCountChanged",((e,t)=>{this.onOptimalVideoCountChanged(e,t)}))),this.onOptimalVideoCountChanged(this.configProvider.config.nonEstimatedDefaultVideoReceiversCount))}get iceTransportPolicy(){return this.configProvider.getIceTransportPolicy()}getAcceptedTypes(){return this.allowedMediaContentType}clone(t,i){const n=ht(this.context);n.config=ht(this.context.config),n.config.webrtcMediaContentType=this.mediaContentType,n.config.webrtcAllowedMediaContentType=this.allowedMediaContentType,n.configProvider=i,n.diagnostics=this.context.diagnostics?.newNativeSession(!1),t?(n.config.isConference=!0,n.config.isPstnCall=!1):(n.config.iceHostCandidateOnly=!1,this.configProvider.config.waitForRelayOnReconnect&&(n.config.webrtcIceGatheringTimeoutIncreased=!0));const r=new e(n,this.callId,this.callback);return this.useNullAudioStream&&r.useNullAudioStreamClient(),this.relayManagerProvider&&(r.relayManagerProvider=this.relayManagerProvider),r.callbacks.onNegotiationRequired=this.callbacks.onNegotiationRequired,r}async setCallConstraints(e,t){const i=this.configProvider.setCallConstraints(e);if(this.logger.safe.info(`[${t}] Setting call constraints ${JSON.stringify(i)}, enableDynamicCallConstraints: ${this.configProvider.config.enableDynamicCallConstraints}`),this.configProvider.config.enableDynamicCallConstraints)try{await this.streamSendersManager.applyCallConstraints(t),this.configProvider.addCallConstraintsTelemetryEvent(i,"applied")}catch(e){throw this.logger.safe.error(`Error while applying constraints: ${e}`),e}else this.configProvider.addCallConstraintsTelemetryEvent(i,"applied");return i}setInternals(e,t){if(this.logger.safe.info(`[${t}] Setting internals from previous session`),this.diagnostics?.commitNativeSession(),e.extensionsManager&&this.extensionsManager){const t=e.extensionsManager.getExtension("videoStreamControl");t?.getOptions()&&this.extensionsManager.configureExtension("videoStreamControl",t.getOptions())}e.subscriptionManager&&(this.subscriptionManager?.dispose(),this.subscriptionManager=e.subscriptionManager,this.subscriptionManager.setDiagnostics(this.diagnostics?.newSubscriptionManagerDiagnostics()),this.subscriptionManager.setStreamProvider({getStreams:()=>this.receiveStreamCollection.getStreams(),setOnStreamsChangedHandler:e=>this.streamsChangedListener=e}),this.subscriptionManager.setLogger(this.logger.createChild("subs")),this.setSubsForSubscriptionManager(),this.subscriptionManager.reriseSubscribeEvents(),this.notifyStreamsChanged()),e.audioRenderer&&(e.audioRenderer.play(this.audioRenderer.getStream()),this.audioRenderer=e.audioRenderer),e.remoteVideoManager?.moveRenderers(this.remoteVideoManager),e.rawIncomingAudioStreamManager&&this.rawIncomingAudioStreamManager.updateHandlers(e.rawIncomingAudioStreamManager.handlerMap),this.audioRenderer.getStream()&&this.rawIncomingAudioStreamManager.streamChanged(this.audioRenderer.getStream())}setSubsForSubscriptionManager(){this.subscriptionManagerSubs=[this.subscriptionManager.on("onTrackIdsChanged",(e=>this.statsGatherer.setSubscribedTrackIds(e))),this.subscriptionManager.on("onTrackSsrcChanged",(e=>this.statsGatherer.setSubscribedTrackSsrc(e))),this.subscriptionManager.on("onSubscriptionChanged",((e,t,i,n,r,s)=>this.onSubscriptionChanged(e,t,i,n,r,s))),this.subscriptionManager.on("onSubscriptionFailed",((e,t,i,n,r)=>this.statsGatherer.addSubscriptionEvent(e,t,i,n,r)))]}onSubscriptionChanged(e,t,i,n,r,s){t===tt.MODALITY.video&&(2===e&&this.diagnostics.addSubscriptionToOvcEvent(this.subscriptionManager.getSubscriptionsCount()),3===e&&this.diagnostics.addSubscriptionToOvcEvent(this.subscriptionManager.getSubscriptionsCount())),this.statsGatherer.addSubscriptionEvent(e,t,i,n,null,r,s)}setSubsForStreamManagerEvents(){this.streamSendersManager.on("onSendStreamChanged",((e,t)=>{this.statsGatherer.updateSendStream(e,t),e?.hasAudio()&&this.diagnostics?.setAudioSendStream(e,t),this.diagnostics?.setPresentationAudioOnScreenSharing(e,t)})),this.streamSendersManager.on("onVideoCaptureFreeze",(e=>{this.isConnected()&&this.ufdManager.signalEvent("VideoCaptureDeviceFreeze",e?"Bad":"Good","Video")})),this.streamSendersManager.on("onMaxVideoSendCapabilitiesChanged",((e,t)=>this.onMaxVideoSendCapabilitiesChanged(e,t)))}move(e,t){this.logger.safe.info(`[${t}] moving to new session`),e.setInternals({subscriptionManager:this.subscriptionManager,extensionsManager:this.extensionsManager,audioRenderer:this.audioRenderer,remoteVideoManager:this.remoteVideoManager,rawIncomingAudioStreamManager:this.rawIncomingAudioStreamManager},t),e.muteHold(this.isMuteHold,t),this.doAudioMute?e.muteInputAsync(t):e.unmuteInputAsync(t),this.subscriptionManager=null,this.audioRenderer=null,this.rawIncomingAudioStreamManager=null,this.callbacks.onTerminated=null}setMute(e,t,i){this.logger.safe.info(`[${i}] call setMute for ${e} with mute state ${t}`),this.streamSendersManager.setMuted(e,t,i),this.processLegacyStats(this.statsGatherer.getLastStatistics())}configureModalitiesAsync(e,t){const i=(async()=>{if(await this.configuredModalitiesPromise,!e||!e.audio&&!e.video&&!e.sharing)throw new Error(`Invalid parameters! ${JSON.stringify(e)}`);const i=ht(e),n=ht(this.negotiatedModalities);this.configProvider.config.alwaysNegotiateDataChannel&&(delete i.data,delete n.data);const r=!this.configuredModalities||!Ng(i,n);this.configuredModalities=e,this.logger.safe.info(`[${t}] configure modalities`,`audio: ${e.audio}`,`video: ${e.video}`,`sharing: ${e.sharing}`,`data: ${e.data}`,`peerconnection: ${!!this.peerConnection}`,`pc.signalingState: ${this.peerConnection?.signalingState??"-"}`,`needNewRenegotiation: ${r}`),r&&(this.updateSendStreamsReinviteless(t)||(this.configProvider.config.removeSendersOnConfigureModalities&&!Mg(this.configuredModalities)&&await this.streamSendersManager.update(this.configuredModalities,!0,t),this.triggerRenegotiation(!1,t)))})();return this.configuredModalitiesPromise=i.catch((e=>{this.logger.safe.warn(`[${t}] Error during configuring modalities: ${Ge(e)}`)})),i}getConfiguredModalities(){return this.configuredModalities}getDisabledModalities(){return this.disabledModalities}createAudioElement(e){this.audioRenderer.assureAudioElement(e)}useNullAudioStreamClient(){this.useNullAudioStream=!0,this.streamSendersManager.useNullAudioStreamClient()}createOfferAsync(e){const t=this.negotiationQueue.add((()=>this.doCreateOfferAsync(e)),e);return this.resetNegotiationQueue(e),t}getTimerTracker(e,t){return this.diagnostics?this.diagnostics.getTimerTracker(e,t):this.statsGatherer.getTimerTracker(e,t)}async doCreateOfferAsync(e){const t=this.getTimerTracker("createOfferAsync",{first:!0});t.mark("start"),this.logger.safe.info(`[${e}] create [offer] configured: ${JSON.stringify(this.configuredModalities)}`),this.initiator=!0,this.throwIfModalitiesNotConfigured("no configured modalities to create offer for"),this.canTriggerRenegotiation=!1,this.negotiatingModalities=this.configuredModalities,await this.assurePeerConnectionAsync(e,t.clone("assurePeerConnectionAsync")),t.markAndMeasure("start","assurePeerConnectionAsync"),this.logger.safe.info(`[${e}] updatePeerConnectionStreamsAsync, pc state: ${JSON.stringify(this.peerConnection.signalingState)}`),Mg(this.negotiatingModalities)&&!dt(this.negotiatedModalities)&&Object.keys(this.negotiatingModalities).forEach((e=>{void 0===this.negotiatedModalities[e]&&delete this.negotiatingModalities[e]})),this.transceiverManager.assureTransceivers(this.negotiatingModalities);const i=await this.assureStreamsAndDataChannel(this.negotiatingModalities,e,t.clone("assureStreamsAndDataChannel"));t.markAndMeasure("assurePeerConnectionAsync","assureStreamsAndDataChannel"),this.offeredModalities=i,!Xg(this.context)&&this.configProvider.config.webrtcNegotiateDisabledDataModality&&!this.offeredModalities[tt.MODALITY.data]&&this.multiParty&&(this.offeredModalities[tt.MODALITY.data]=tt.MEDIA_STATE.inactive),this.configureAudioCodec(),this.logger.safe.info(`[${e}] create [offer] offered: ${JSON.stringify(this.offeredModalities)}`);const n=await this.peerConnection.createOffer();t.markAndMeasure("assureStreamsAndDataChannel","createOffer"),this.logger.unsafe.debug(`[${e}] create [offer] offer from peer connection, sdp: ${n.sdp}`);const r=this.sessionDescription.createLocalOffer(n.sdp);this.hasIceCandidates(r)||this.resetCandidateGathering(e),this.statsGatherer.startWaitingForStreamStart(this.offeredModalities),this.diagnostics&&(this.diagnostics.offeredModalities=i),this.setupIceGatheringTimeout(e);const s=r.toLocal();this.logger.unsafe.debug(`[${e}] create [offer] set local description`,"sdp:",s),await this.peerConnection.setLocalDescription({sdp:s,type:"offer"}),t.markAndMeasure("createOffer","sLD"),await this.iceCandidatesDeferred.promise,t.markAndMeasure("sLD","candidates");const a=this.sessionDescription.createLocalOffer(this.peerConnection.localDescription.sdp);this.fixLocalDescription(a),a.updateModalities(this.offeredModalities),this.checkIceCandidates(a);const o=a.toOffer();this.logger.unsafe.debug(`[${e}] CREATE OFFER`,"sdp:",o);const l={blob:o,contentType:this.mediaContentType};return""===this.configProvider.mediaConfig.webrtcRequiredFeatures||this.multiParty||(l.requiredFeatures=this.configProvider.mediaConfig.webrtcRequiredFeatures),this.audioCodecManager.decoder?.setRecvPayloads(a.getPayloadsForMedia(tt.MEDIA_TYPE.audio)),this.configProvider.countryCode&&(l.clientLocation=this.configProvider.countryCode),this.mediaManager.getMediaEntities().forEach((e=>{e.setExtension("midApplied",!0)})),this.doRetargetIfNeeded(l,r,e),this.reinvitelessContext.enabled&&(this.mediaManager.updateMediaEntitiesWithLocalTracks(),l.mediaDescriptions=this.getMediaDescriptions(this.offeredModalities)),this.setBWSeed(l),t.markAndMeasure("start","createOfferAsync"),l}processOfferAsync(e,t){const i=this.negotiationQueue.add((()=>this.doProcessOfferAsync(e,t)),t);return this.resetNegotiationQueue(t),i}async doProcessOfferAsync(e,t){const i=this.getTimerTracker("processOfferAsync",{first:!0});i.mark("start"),this.mediaManager.backup();const n=e.blob;if(this.logger.unsafe.debug(`[${t}] process [offer]`,"sdp:",n),this.configProvider.config.webrtcCompareContentTypeInOffer&&(ft(e.contentType,this.allowedMediaContentType),this.mediaContentType=e.contentType),this.checkOfferOriginator(e),this.offerOriginator=e.originator,e.requiredFeatures){const t=this.configProvider.mediaConfig.webrtcRejectedFeatures.split(",");St(e.requiredFeatures.split(","),t)}if(this.initiator=!1,this.offeredDescription=this.sessionDescription.createRemoteOffer(n),this.configProvider.config.multiStreamSupported){const e=function(e){const t=e.match(/a=x-multi-stream:(\d+)/);if(t)return parseInt(t[1])}(n),i=this.configProvider.config.numVideoChannelsGvc-this.configProvider.config.nonMultiStreamChannels;this.context.configProvider.mediaConfig.multiStreamChannelsOffered=e,e&&e<i&&(this.logger.safe.info(`Received ${e} multi stream channels, ${i} channels supported`),this.triggerRenegotiation(!0,t))}this.canTriggerRenegotiation=!1,this.offeredModalities=Pg(this.offeredDescription.getModalities()),this.assignUnbundledTransport();let r=this.configProvider.config.removeUnsupportedVideoModality?this.offeredModalities:ht(this.offeredModalities);if(Ag(this.offeredModalities.video)||Rg(this.offeredModalities.video)||Ag(this.offeredModalities.sharing)||Rg(this.offeredModalities.sharing)){const e=this.offeredDescription.getVideoCodecs();try{i.mark("startGetCapabilities");const n=await this.capabilityGatherer.getCapabilities("video");i.markAndMeasure("startGetCapabilities","getCapabilities"),n.codecs.some((t=>e.some((e=>t.mimeType===e&&this.configProvider.config.primaryVideoCodecs.includes(e)))))||(this.logger.safe.warn(`[${t}] offer doesn't contain any supported video codecs`),this.disabledModalities.video=r.video,this.disabledModalities.sharing=r.sharing,delete r.video,delete r.sharing)}catch(e){this.logger.safe.error(`[${t}] failed to get video capability ${Ge(e)}`)}}return(!Xg(this.context)&&(Ag(this.offeredModalities.data)||Rg(this.offeredModalities.data))||this.dataChannel&&"Failed"===this.dataChannel.state)&&(this.logger.safe.info(`[${t}] Supressing data modality as data channel is not possible`),r=ht(r),delete r.data),i.markAndMeasure("start","processOfferAsync"),this.logger.safe.info(`[${t}] process [offer] offered: ${JSON.stringify(this.offeredModalities)} acceptable: ${JSON.stringify(r)}`),r}assignUnbundledTransport(){this.peerConnection||(this.context.configProvider.mediaConfig.isTransportUnbundled?this.context.configProvider.mediaConfig.isTransportUnbundled=this.offeredDescription.couldBeUnbundled():this.context.configProvider.mediaConfig.isTransportUnbundled=this.offeredDescription.isUnbundled())}checkOfferOriginator(e){if(this.offerOriginator&&this.offerOriginator!==e.originator&&this.configProvider.config.rejectIncompatibleOriginator)throw{detail:"mediaContent.originator is different on renegotiation",type:tt.MEDIA_ERROR.incompatibleOriginator}}async createAnswerAsync(e,t){if(e)return{blob:"",contentType:this.mediaContentType};const i=this.getTimerTracker("createAnswerAsync",{first:!0});i.mark("start"),this.logger.safe.info(`[${t}] create [answer] offered: ${JSON.stringify(this.offeredModalities)} configured: ${JSON.stringify(this.configuredModalities)}`),this.throwIfModalitiesNotConfigured("no configured modalities to create answer for");const n=this.configuredModalities;let r=this.negotiatingModalities=Og(this.offeredModalities,n);await this.assurePeerConnectionAsync(t,i.clone("assurePeerConnectionAsync")),i.markAndMeasure("start","assurePeerConnectionAsync"),this.logger.safe.info(`[${t}] updatePeerConnectionStreamsAsync, pc state: ${JSON.stringify(this.peerConnection.signalingState)}`),await this.handleCodecSwitchUnsupported(t),i.markAndMeasure("assurePeerConnectionAsync","handleCodecSwitchUnsupported"),this.configureAudioCodec();const s=this.offeredDescription.toRemote(r);this.logger.unsafe.info(`[${t}] create [answer] set remote description', 'negotiated:`,r,"sdp:",s),await this.peerConnection.setRemoteDescription({sdp:s,type:"offer"}),i.markAndMeasure("handleCodecSwitchUnsupported","setRemoteDescription"),this.transceiverManager.syncTransceivers(r),this.mediaManager.getMediaEntities().forEach((e=>{e.setExtension("midApplied",!0)})),await this.assureStreamsAndDataChannel(r,t,i.clone("assureStreamsAndDataChannel")),i.markAndMeasure("setRemoteDescription","assureStreamsAndDataChannel"),this.callbacks.onTransportInitialized&&this.callbacks.onTransportInitialized();const a=await this.peerConnection.createAnswer();i.markAndMeasure("assureStreamsAndDataChannel","createAnswer"),this.logger.unsafe.debug(`[${t}] create [answer] answer from peer connection`,"sdp:",a.sdp);const o=this.sessionDescription.createLocalAnswer(a.sdp);this.hasIceCandidates(o)||this.resetCandidateGathering(t),this.statsGatherer.startWaitingForStreamStart(r),this.diagnostics&&(this.diagnostics.offeredModalities=r),this.setupIceGatheringTimeout(t);const l=o.toLocal();this.logger.unsafe.debug(`[${t}] create [answer] set local description`,"sdp:",l),await this.peerConnection.setLocalDescription({sdp:l,type:"answer"}),i.markAndMeasure("createAnswer","sLD"),await this.iceCandidatesDeferred.promise,i.markAndMeasure("sLD","candidates");const d=this.sessionDescription.createLocalAnswer(this.peerConnection.localDescription.sdp);this.fixLocalDescription(d),d.updateModalities(r),this.checkIceCandidates(d);const c=d.toAnswer();this.audioCodecManager.decoder?.setRecvPayloads(d.getPayloadsForMedia(tt.MEDIA_TYPE.audio)),this.checkAudioCodecNegotiated(t),await this.streamSendersManager.activate(t),i.markAndMeasure("candidates","streamSendersManagerActivate"),this.updateLocalMediaSources(),this.applyReceiveCapabilities(),r=d.getModalities(),this.reinvitelessContext.enabled&&(r=Fg(this.negotiatingModalities,r)),kg(this.configuredModalities,this.negotiatingModalities,r)||this.triggerRenegotiation(!0,t),this.setNegotiatedModalities(r),this.statsGatherer.sessionInfo.setBweType(d.getBweType()),this.diagnostics&&(this.diagnostics.bweType=d.getBweType()),this.logger.unsafe.debug(`[${t}] CREATE ANSWER`,"sdp:",c);const h={blob:c,contentType:this.mediaContentType};return this.configProvider.countryCode&&(h.clientLocation=this.configProvider.countryCode),this.reinvitelessContext.enabled&&(h.mediaDescriptions=this.getMediaDescriptions(r)),this.setBWSeed(h),i.markAndMeasure("start","createAnswerAsync"),h}async processAnswerAsync(e,t,i,n=!1){const r=e.blob;this.logger.unsafe.debug(i?`[${t}] PROCESS PRANSWER`:`[${t}] PROCESS ANSWER`,"sdp:",r);const s=i?"pranswer":"answer";if(i&&(!nm(this.context,n)||"have-local-offer"!==this.peerConnection.signalingState))return void this.logger.safe.info(`[${t}] process [${s}] ignored`);const a=this.getTimerTracker(i?"processProvisionalAnswerAsync":"processAnswerAsync",{first:!0});a.mark("start");const o=this.sessionDescription.createRemoteAnswer(r);let l=Pg(o.getModalities());this.reinvitelessContext.enabled&&(l=Fg(this.offeredModalities,l));const d=o.toRemote(l);i||(this.mediaContentType=e.contentType,-1===this.allowedMediaContentType.indexOf(this.mediaContentType)&&this.allowedMediaContentType.push(this.mediaContentType),Mg(l)||(await this.streamSendersManager.update(l,!0,t),a.markAndMeasure("start","streamSendersManagerUpdate"),Ag(this.offeredModalities.data)&&!l.data&&this.dataChannel?.disable()),this.setNegotiatedModalities(l),this.updateLocalMediaSources(),this.statsGatherer.sessionInfo.setBweType(o.getBweType()),this.diagnostics&&(this.diagnostics.bweType=o.getBweType())),this.callbacks.onTransportInitialized?.(),this.logger.unsafe.info(`[${t}] process [${s}] set remote description`,"negotiated:",l,"sdp:",d),a.mark("startSetRemoteDescription"),await this.peerConnection.setRemoteDescription({sdp:d,type:s}),a.markAndMeasure("startSetRemoteDescription","setRemoteDescription"),i||(await this.streamSendersManager.activate(t),a.markAndMeasure("setRemoteDescription","streamSendersManagerActivate"),this.applyReceiveCapabilities(),this.checkAudioCodecNegotiated(t),this.transceiverManager.syncTransceivers(l),a.markAndMeasure("start","processAnswerAsync"))}async completeNegotiationAsync(e){this.mediaManager.commit();const t=this.configuredModalities,i=this.forceMediaStreamUpdate&&!Mg(this.negotiatedModalities)||!kg(t,this.negotiatingModalities,this.negotiatedModalities)||this.triggerRenegotiationFlag,n=!i;this.canTriggerRenegotiation=!0,this.logger.safe.info(`[${e}] negotiation completed isComplete: ${n} configured: ${JSON.stringify(this.configuredModalities)} negotiating: ${JSON.stringify(this.negotiatingModalities)} offered: ${JSON.stringify(this.offeredModalities)} negotiated: ${JSON.stringify(this.negotiatedModalities)}`),i&&this.triggerRenegotiation(!1,e);for(const e of this.getVideoDeviceManager().getLocalVideoRenderers())e.setStatsProvider(this.statsGatherer);return this.negotiationCompletedPromise.resolve(),{isComplete:n,activeModalities:this.negotiatedModalities,offeredModalities:this.offeredModalities,attemptedModalities:this.negotiatingModalities,configuredModalities:this.configuredModalities,initiator:this.initiator}}async rejectNegotiationAsync(e,t,i=!1){let n;this.mediaManager.rollback(),this.logger.safe.warn(`[${t}] negotiation rejected isComplete: ${!i} error: ${Ge(e)} configured: ${JSON.stringify(this.configuredModalities)} negotiating: ${JSON.stringify(this.negotiatingModalities)} offered: ${JSON.stringify(this.offeredModalities)} negotiated: ${JSON.stringify(this.negotiatedModalities)}`),this.qualityManager.clearPendingCapabilities();const r=this.getModalitiesForRollback(t);if(this.transceiverManager?.syncTransceivers(r),await this.assureStreamsAndDataChannel(r,t),"have-local-offer"===this.peerConnection?.signalingState){n={},this.logger.safe.info(`[${t}] rolling back local description`);try{if(!this.isRollbackSupported||this.configProvider.config.webrtcHandleRollback){n.type="LocalRN",this.logger.safe.info(`[${t}] rolling back using local renegotiation`);const e=[new IO(this.peerConnection,this.configProvider,this.logger)];await this.negotiationEmulator.renegotiate(e,!0),this.logger.safe.info(`[${t}] rolling back using local complete`)}else this.logger.safe.info(`[${t}] rolling back using rollback`),n.type="Rollback",await this.peerConnection.setLocalDescription({type:"rollback"})}catch(e){this.logger.safe.error(`[${t}] rollback error`,e),n.error=e}}else if("have-remote-offer"===this.peerConnection?.signalingState){n={};try{if(!this.isRollbackSupported||this.configProvider.config.webrtcHandleRemoteRollback){n.type="RemoteRN",this.logger.safe.info(`[${t}] applying answer for remote renegotiation`);const e=[new IO(this.peerConnection,this.configProvider,this.logger)];await this.negotiationEmulator.renegotiate(e,!0,"remote")}else this.logger.safe.info(`[${t}] rolling back using rollback on remote description`),n.type="Rollback",await this.peerConnection.setRemoteDescription({type:"rollback"})}catch(e){this.logger.safe.error(`[${t}] rollback error`,e),n.error=e}}else this.peerConnection&&this.logger.safe.error(`[${t}] cannot rollback local description in current state: ${this.peerConnection.signalingState}`);return this.canTriggerRenegotiation=!0,this.negotiationCompletedPromise.reject("negotiation rejected"),i&&(this.logger.safe.info(`[${t}] retrying failed negotiation`),this.triggerRenegotiation(!1,t)),{isComplete:!i,activeModalities:r,offeredModalities:this.offeredModalities,attemptedModalities:this.negotiatingModalities,configuredModalities:this.configuredModalities,initiator:this.initiator,rollback:n}}async startMediaDescriptionsUpdateAsync(e){return this.reinvitelessAppliedModalities=await this.assureStreamsAndDataChannel(this.reinvitelessRequestedModalities,e),this.updateLocalMediaSources(),await this.streamSendersManager.activate(e),this.getMediaDescriptions(this.reinvitelessAppliedModalities)}async completeMediaDescriptionsUpdateAsync(e){this.logger.safe.info(`[${e}] complete media descriptions update`),this.setNegotiatedModalities(this.reinvitelessAppliedModalities);const t=this.reinvitelessAppliedModalities,i=this.reinvitelessRequestedModalities;return this.reinvitelessAppliedModalities={},this.reinvitelessRequestedModalities={},{appliedModalities:t,requestedModalities:i}}async rejectMediaDescriptionsUpdateAsync(e,t=!1){this.logger.safe.info(`[${e}] reject media descriptions update`),t&&(this.logger.safe.info(`[${e}] trigger renegotiation after failed media descriptions update`),this.triggerRenegotiation(!1,e));const i=await this.streamSendersManager.update(this.negotiatedModalities,!0,e),n=this.reinvitelessRequestedModalities;return this.reinvitelessAppliedModalities={},this.reinvitelessRequestedModalities={},{appliedModalities:i,requestedModalities:n}}createRemoteRenderer(e){return this.remoteVideoManager.createRenderer(e,this.subscriptionManager,this.logger)}getStatsAsync(e){if(this.statsGatherer&&!this.statsGatherer.isDisposed){if(this.audioCodecManager){const e=this.audioCodecManager.getSessionEvents();this.statsGatherer.sessionInfo.setAudiocCodecEvents(e),this.diagnostics&&(this.diagnostics.audioCodecEvents=e)}this.statisticsReport=this.statisticsReport.then((()=>this.statsGatherer.getReport(e))).catch((e=>(this.logger.safe.error(`getting statistics should never fail: ${e.error}`),e.partialReport)))}return this.statisticsReport}getLastKnownStats(e){return this.statsGatherer.getReport(!1,e)}muteHold(e,t){this.logger.safe.info(`[${t}] set muteHold state ${e}`),this.isMuteHold=e;const i=[tt.MODALITY.audio,tt.MODALITY.video,tt.MODALITY.sharing].filter((e=>Ag(this.negotiatedModalities[e])&&(e!==tt.MODALITY.audio||!this.doAudioMute)));for(const n of i)this.setMute($g(n),e,t)}async muteInputAsync(e){this.doAudioMute=!0,this.setMute("Audio",!0,e)}async unmuteInputAsync(e){this.doAudioMute=!1,this.setMute("Audio",!1,e)}muteOutputAsync(e){return this.audioRenderer.setMuted(!0,e)}unmuteOutputAsync(e){return this.audioRenderer.setMuted(!1,e)}sendDtmf(e){return this.dtmfSender.sendDtmf(this.peerConnection,e)}canSendDtmf(){return this.dtmfSender.canSendDtmf(this.peerConnection)}pauseNegotiations(e=Re()){const t=new Mu;return this.negotiationCompletedPromise.promise.catch((()=>{})).then((()=>{this.setNegotiationPromise(t,e)})),t}getExtensionsManager(){return this.extensionsManager}onDeviceEvent(e){this.statsGatherer.onDeviceEvent(e)}deviceSelectionChanged(){this.peerConnection&&this.audioRenderer?.getStream()&&this.audioRenderer.setOutputDevice(this.deviceManager.getOutputDeviceId())}async terminate(e,t,i=!0){this.logger.safe.info(`[${e}] terminate`),this.statsGatherer.setTerminated(),this.diagnostics?.terminate(),this.perfMonitorSubs.forEach((e=>e?.dispose())),this.performanceMonitor.dispose(),this.terminated=!0,this.canTriggerRenegotiation=!1,await(this.audioCodecManager.decoder?.storeApiRecording()),this.cleanUp(e);try{i&&await this.getStatsAsync(!1)}catch(t){this.logger.safe.error(`[${e}] Error while gathering stats ${Ge(t)}`)}finally{this.statsGatherer.dispose()}}getIncomingRawAudioStream(){this.logger.info("IRawStream for incoming audio stream requested");const e=this.audioRenderer.getStream();return this.rawIncomingAudioStreamManager.createIRawStreamClient(e)}getUnmixedAudioProvider(){return this.audioCodecManager.decoder?.getUnmixedAudioProvider()}configureSpatialAudio(e,t){this.configProvider.mediaConfig.spatialAudioEnabled=e,this.audioCodecManager.configureSpatialAudio(e,t)||this.ufdManager.signalEvent("SpatialAudioMUCHUnavailable","Bad","Audio",!0,t)}setParticipantSpatialAudioPositions(e,t){if(!this.configProvider.mediaConfig.spatialAudioEnabled||!this.audioCodecManager?.decoder)throw this.logger.safe.error(`[${t}] setParticipantSpatialAudioPositions is called while MUCH audio decoder is not created or not enabled`),"setParticipantSpatialAudioPositions not allowed";this.audioCodecManager.decoder?.setParticipantSpatialAudioPositions(e)}processNotification(e,t){this.performanceMonitor.processNotification(e,t)}cleanUp(e){this.negotiationQueue.dispose(),this.rawIncomingAudioStreamManager?.dispose(),this.remoteVideoManager.dispose(),this.dataChannel&&(this.dataChannel.dispose(),this.dataChannel=null),this.deviceManager.effectsManager.setAecRefStream(null),this.resetPeerConnection(e),this.subscriptionManagerSubs.forEach((e=>e.dispose())),this.subscriptionManager&&this.subscriptionManager.dispose(),this.dmSub.dispose(),this.callDeviceManagerSub?.dispose(),this.clearIceDisconnectedTimer(),this.extensionsManager&&this.extensionsManager.dispose(),this.callbacks.onTerminated&&this.callbacks.onTerminated(),this.negotiationCompletedPromise.reject("webRtcSession cleanup")}resetPeerConnection(e){this.logger.safe.info(`[${e}] reset peer connection`),this.contributingSources?.dispose(),this.activeSpeakerManager.dispose(),this.qualityManager?.dispose(),this.qualityManager=null,this.audioRenderer?.dispose(),this.dtmfSender?.dispose(),this.dtmfSender=null,this.streamSendersManager?.dispose(),this.streamSendersManager=null,this.transceiverManager=null,this.encStreamsManager.dispose(),this.receiveStreamCollection.clear(),this.transportStateProvider?.dispose(),this.transportStateProvider=null,this.audioCodecManager.dispose(),this.mediaManager.reset(),this.peerConnection?.close(),this.peerConnection=null,this.toBeCalledAfterConnected=[],this.negotiationEmulator.configure(null),this.peerConnectionPromise=null,this.resetCandidateGathering(e),this.canTriggerRenegotiation=!0,this.negotiatedModalities={}}resetNegotiationQueue(e){this.negotiationCompletedPromise.reject("promise expired"),this.setNegotiationPromise(new Mu,e)}setNegotiationPromise(e,t=Re()){this.terminated||(this.negotiationCompletedPromise=e,this.negotiationQueue.add(this.negotiationCompletedPromise,t))}setupExtensionsManager(){const e=new lD(this.logger.createChild("ExtMgr"));return e.addExtension("dominantSpeakerHistory",{logger:this.logger,callback:this.activeSpeakerManager.onDominantSpeakerHistoryChanged.bind(this.activeSpeakerManager)}),e.addExtension("videoStreamControl",{logger:this.logger,negotiationEmulator:this.negotiationEmulator,qualityManager:this.qualityManager,diagnostics:this.qmDiagnostics,configProvider:this.configProvider,statisticsGatherer:this.statsGatherer}),e.addExtension("bandwidthTelemetry",{statisticsGatherer:this.statsGatherer,diagnostics:this.diagnostics}),this.configProvider.config.setBWSeed&&e.addExtension("bandwidthCache",{logger:this.logger,configProvider:this.configProvider}),e}processStatsReport(e){if(this.remoteVideoManager.processStatsReport(e),this.configProvider.config.diagnostics.features.useNewNetworkUFD){this.networkQualityDiagnostics.processReport(e);const t=this.networkQualityDiagnostics.getInboundNetworkQuality();this.ufdManager.signalEvent("NetworkRecvQuality",t);const i=this.networkQualityDiagnostics.getOutboundNetworkQuality();this.ufdManager.signalEvent("NetworkSendQuality",this.doAudioMute?"Good":i)}this.configProvider.config.diagnostics.features.useNewSpeakingWhileMutedUFD&&this.ufdManager.signalEvent("DeviceSpeakWhileMuted",this.speechDetectionDiagnostics.processReport(e)?"Bad":"Good")}processLegacyStats(e){if(e&&(this.remoteVideoManager.processLegacyStats(e),this.hwSilent!==e.audioHwSilent&&(this.hwSilent=e.audioHwSilent,this.callbacks.onAudioHwSilentChanged&&this.callbacks.onAudioHwSilentChanged(this.hwSilent)),this.configProvider.config.diagnostics.features.useNewNetworkUFD||(this.ufdManager.signalEvent("NetworkRecvQuality",e.networkRecvLevel.quality,void 0,void 0,void 0,void 0,{recvQualityData:e.networkRecvLevel}),this.ufdManager.signalEvent("NetworkSendQuality",this.doAudioMute?"Good":e.networkSendLevel.quality,void 0,void 0,void 0,void 0,{sendQualityData:e.networkSendLevel})),!this.configProvider.config.diagnostics.features.useNewSpeakingWhileMutedUFD)){const t=!(!e.isSpeaking||!this.doAudioMute);this.ufdManager.signalEvent("DeviceSpeakWhileMuted",t?"Bad":"Good")}}triggerRenegotiation(e,t=Re()){this.canTriggerRenegotiation?(this.canTriggerRenegotiation=!1,this.triggerRenegotiationFlag=!1,this.logger.safe.info(`[${t}] triggering renegotiation`),this.mediaManager.backup(),this.callbacks.onNegotiationRequired&&this.callbacks.onNegotiationRequired(t)):e&&(this.logger.safe.info(`[${t}] renegotiation postponed`),this.triggerRenegotiationFlag=!0)}throwIfModalitiesNotConfigured(e){if(!this.configuredModalities)throw new Error(e)}async handleCodecSwitchUnsupported(e){if(!this.offeredDescription.isCodecSwitchSupported())try{const e=(await this.capabilityGatherer.getCapabilities(tt.MEDIA_TYPE.audio)).codecs.map((e=>e.mimeType));this.offeredDescription.usePrimaryAudioCodecOnly(e)}catch(t){this.logger.safe.error(`[${e}] failed to set primary codec based on audio capability ${Ge(t)}`)}}assurePeerConnectionAsync(e,t){return this.peerConnectionPromise??(this.peerConnectionPromise=this.getPeerConnectionPromise(e,t)),this.peerConnectionPromise}async getPeerConnectionPromise(e,t){if(!this.relayManagerProvider)throw new Error("relay manager provider is not set!");this.logger.safe.info(`[${e}] fetching relay details from RelayManager...`);const i={relayType:"turn",isRemoteClientLync:this.context.config.isRemoteClientLync};t.mark("startQueryRelaysAsync");const n=await this.relayManagerProvider.getRelayManager().queryRelaysAsync(i);if(t.markAndMeasure("startQueryRelaysAsync","queryRelaysAsync"),this.terminated)throw new Error("session already disposed");const r={optional:[]},s=rO(n,this.configProvider.config),a=this.configureCrypto(r);this.configureCpuThreshold(r),this.logger.safe.info("create peer connection");const o="unified-plan",l=this.context.configProvider.mediaConfig.isTransportUnbundled?"balanced":"max-bundle";try{this.peerConnection=new yg.window.RTCPeerConnection({iceServers:s,rtcpMuxPolicy:"require",iceTransportPolicy:this.iceTransportPolicy,iceCandidatePoolSize:this.configProvider.config.iceCandidatePoolSize,bundlePolicy:l,sdpSemantics:o,audioPortRange:this.configProvider.mediaConfig.audioPortRange,videoPortRange:this.configProvider.mediaConfig.videoPortRange,enableDtlsSrtp:1===a,encodedInsertableStreams:!!this.configProvider.config.useInsertableStreams},r)}catch(e){throw e.code===DOMException.INVALID_STATE_ERR&&this.ufdManager.signalEvent("NoNetwork","Bad"),e}const d=this.peerConnection;this.isRollbackSupported=1===a&&this.context.configProvider.userAgentConfig.isBrowserRollbackSupported,this.negotiationEmulator.configure(d),this.statsGatherer.initialize(d),this.statsGatherer.sessionInfo.setIceServers(s),this.statsGatherer.sessionInfo.setIceTransportPolicy(this.iceTransportPolicy),this.statsGatherer.sessionInfo.setSdpSemantics(o),this.statsGatherer.sessionInfo.setBundlePolicy(l),this.diagnostics&&(this.diagnostics.iceServers=s,this.diagnostics.iceTransportPolicy=this.iceTransportPolicy,this.diagnostics.sdpSemantics=o,this.diagnostics.bundlePolicy=l),await this.checkVideoCodecsSupport(),t.markAndMeasure("queryRelaysAsync","checkVideoCodecsSupport"),d.onnegotiationneeded=()=>{this.logger.safe.info(`onnegotiationneeded signalingState: ${d.signalingState}`)},d.onsignalingstatechange=()=>{const e=Re();this.statsGatherer.sessionInfo.setSignalingConnectionState(d.signalingState),this.diagnostics&&(this.diagnostics.signalingConnectionState=d.signalingState),this.logger.safe.info(`[${e}] onsignalingstatechange signalingState: ${d.signalingState}`),this.transportStateProvider&&this.transportStateProvider.subscribeForDtlsTransportState(),this.configProvider.config.reconnectOnPcClose&&!this.terminated&&"closed"===d.signalingState&&this.isTransportConnected()&&this.raiseError({type:tt.MEDIA_ERROR.unexpectedClose,detail:"PeerConnection is closed"},e)},d.onicecandidateerror=e=>{const t=e,[i,n]=[t.address,t.port];if(this.logger.safe.warn(`On ICE candidate error ${t.url} | ${i}:${n}: code ${t.errorCode}: ${t.errorText}`),!this.isConnected()||this.iceCandidatesDeferred.isPending){const e={address:i,port:+n,url:t.url,errorCode:t.errorCode,errorText:t.errorText};this.statsGatherer.addIceCandidateError(e),this.diagnostics?.addIceCandidateError(e)}};const c=e=>{const{track:t,receiver:i,transceiver:n}=e,r=e.streams[0]??new MediaStream([t]);if(!(this.configProvider.config.addAudioStreamBeforeConnection&&tt.TRACK_KIND.audio===t.kind||this.isConnected()))return this.logger.safe.info("ontrack handling postponed till PC is connected"),void this.toBeCalledAfterConnected.push((()=>c(e)));this.logger.safe.info(`ontrack track ${t.id}, stream: ${r?.id}, transceiver=${n?.mid}`);let s=r?.active;if(!s&&this.configProvider.config.useInactiveAudioTrack&&"audio"===t.kind&&(this.logger.safe.warn("ontrack override forcing to use inactive audio stream"),s=!0),!s||"stopped"===n?.currentDirection||n?.stopped)return void this.logger.safe.info("ontrack ignore non active stream");let a=this.mediaManager.getMediaEntityByRemoteStreamId(r.id);if(a||(this.logger.safe.info(`cannot find media entity with stream id ${r.id} trying to fallback`),r.getAudioTracks()[0]&&(a=this.mediaManager.getMediaEntitiesByModality(tt.MODALITY.audio)[0])),a){const e=this.createReceiveStream(r,i,t,a);a.setRemoteTrackId(t.id),this.addReceiveStreamTransforms(i,a.getModality()),this.receiveStreamCollection.add(e)}else this.logger.safe.error(`could not find media entity for an added stream: ${r.id}`)};d.onaddstream=e=>{this.logger.safe.info(`onaddstream stream: ${e.stream.id}`)},d.ontrack=c;const h=e=>{if(!this.isConnected())return this.logger.safe.info("onremovestream handling postponed till PC is connected"),void this.toBeCalledAfterConnected.push((()=>h(e)));this.logger.safe.info(`onremovestream stream: ${e.stream.id}`),this.receiveStreamCollection.remove(e.stream.id)};d.onremovestream=h,d.onicecandidate=t=>{const i=t.candidate;if(i){const t=Ug(i.candidate);if(this.logger.safe.info(`[${e}] onicecandidate candidate: component:${t.component} protocol:${t.protocol} prio:${t.priority} type:${t.type} port:${t.port}`),this.logger.unsafe.info(`[${e}] candidate details: ${i.candidate}`),"1"!==t.component)return;if(this.iceCandidateReceived=!0,this.statsGatherer.sessionInfo.setCandidateDetails(t),this.diagnostics?.setCandidateDetails(t),!this.relayCandidateGathered&&i.candidate.indexOf("typ relay")>-1){const e={priority:i.priority?.toString()||t.priority,time:Date.now()-this.iceRelayCandidatesGatherStartTime};this.statsGatherer.sessionInfo.setRelayCandidateInfo(e),this.diagnostics&&(this.diagnostics.relayCandidateInfo=e),this.relayCandidateGathered=!0}}else this.logger.safe.info(`[${e}] onicecandidate candidate: null`);if(!this.iceCandidatesDeferred.isPending)return;const n=!this.initiator||!this.context.config.webrtcIceGatheringTimeoutIncreased,r=this.iceHostCandidateOnly||0===s.length;if(!i&&n||r){i&&this.logger.safe.info(`[${e}] Not waiting for ICE candidates, hoping that host/prflx is enough`),this.logger.safe.info(`[${e}] Is connected:`,this.isConnected(),d.iceConnectionState,d.signalingState);let t=!0;this.context.configProvider.mediaConfig.isTransportUnbundled&&i&&(t=this.sessionDescription.createLocalOffer(d.localDescription.sdp).hasUnbundledIceCandidates()),t&&this.completeCandidateGathering(e)}else if(this.relayCandidateGathered){let t=!0;this.context.configProvider.mediaConfig.isTransportUnbundled&&(t=this.sessionDescription.createLocalOffer(d.localDescription.sdp).hasUnbundledRelayIceCandidates()),t&&(this.statsGatherer.clearIceCandidateErrors(),this.diagnostics?.clearIceCandidateErrors(),this.completeCandidateGathering(e))}},d.onicegatheringstatechange=()=>{this.logger.safe.info(`onicegatheringstatechange iceGatheringState: ${d.iceGatheringState}`)};const u=i=>{if(this.terminated)return;const n=this.wasConnected?Re():e,r=this.lastTransportConnectionState;if(this.lastTransportConnectionState=i,this.statsGatherer.sessionInfo.setIceConnectionState(i),this.diagnostics&&(this.diagnostics.iceConnectionState=i),"connecting"===i&&t.mark("transportConnecting"),"connected"===i||"completed"===i)t.markAndMeasure("transportConnecting","transportConnected"),this.onTransportConnected(n);else if("failed"===i||"closed"===i&&"failed"!==r){if(this.iceCandidatesDeferred.isPending)return this.logger.safe.info(`[${n}] ice failed while gathering candidates, suppressing error`),void this.completeCandidateGathering(n);this.raiseError({type:tt.MEDIA_ERROR.iceConnectionError,detail:"ice transport failed"},n),this.configProvider.config.webrtcCloseAfterIceFailure&&d.close(),this.callbacks.onTransportFailed?.()}"disconnected"===i?(this.callbacks.onTransportDisconnected?.(e),this.startIceDisconnectedTimer(n)):this.clearIceDisconnectedTimer()};this.transportStateProvider=new IL(d,a,this.logger,this.configProvider,(e=>u(e))),this.transceiverManager=new RN(this.logger,this.peerConnection,this.mediaManager,this.context,this.reinvitelessContext),this.streamSendersManager.registerRtpSenderManager(this.transceiverManager),Xg(this.context)&&!this.dataChannel&&(this.dataChannel=new Hp(this.peerConnection,this.statsGatherer,this.logger,this.configProvider),this.callback.onDataChannelUpdated(this.dataChannel)),this.multiParty&&(this.contributingSources=new qk(this.logger.createChild("ContributingSources"),this.configProvider,this.activeSpeakerManager,new zk(this.logger.createChild("ContributingSourcesProvider"),d))),t.mark("startInitialize"),await this.encStreamsManager.initialize(),t.markAndMeasure("startInitialize","encStreamsManagerInitialize");const p=this.encStreamsManager.isWorkerLoaded();this.initAudioCodec(p),this.statsGatherer.sessionInfo.setEncodedStreamWorkerLoaded(p),this.diagnostics&&(this.diagnostics.encodedStreamWorker=p)}configureCrypto(e){let t=!1;const i=Yg(this.context);if(this.offeredDescription){const e=this.offeredDescription.getSrtpInfo();this.statsGatherer.sessionInfo.setOfferedSrtpInfo(e),this.diagnostics&&(this.diagnostics.offeredSrtp=e),t=!e.dtls||e.sdes&&i}else t=i;t&&(this.logger.safe.info("configuring peer connection to use sdes"),e.optional.push({DtlsSrtpKeyAgreement:!1}));const n={dtls:!t,sdes:!!t};return this.statsGatherer.sessionInfo.setNegotiatedSrtpInfo(n),this.diagnostics&&(this.diagnostics.negotiatedSrtp=n),t?0:1}configureCpuThreshold(e){this.configProvider.config.webrtcNativeCpuOveruseDisabled&&this.multiParty&&e.optional.push({googCpuOveruseDetection:!1})}completeCandidateGathering(e){this.iceCandidatesDeferred.isPending&&(this.logger.safe.info(`[${e}] ICE candidates gathered completely`),this.iceCandidatesDeferred.resolve())}onTransportConnected(e){if(this.logger.safe.info(`[${e}] audio transport connected`),this.statsGatherer.clearIceCandidateErrors(),this.diagnostics?.clearIceCandidateErrors(),!this.terminated)for(this.wasConnected=!0,this.configProvider.config.webrtcPranswerWaitForMediaPollingInterval&&"have-remote-pranswer"===this.peerConnection.signalingState?this.handleEarlyMediaAudioState(e):this.callbacks.onAudioStateChanged?.(tt.STREAMING_STATE.active,e),this.callbacks.onTransportConnected?.(e);this.toBeCalledAfterConnected.length;)this.toBeCalledAfterConnected.shift()()}handleEarlyMediaAudioState(e){const t=this.peerConnection.getReceivers().filter((e=>"audio"===e.track.kind))[0];if(!t)return this.logger.safe.warn(`[${e}] Connected transport with provisional answer with no audio receiver`),void this.callbacks.onAudioStateChanged?.(tt.STREAMING_STATE.active,e);this.callbacks.onAudioStateChanged?.(tt.STREAMING_STATE.started,e);const i=setInterval((async()=>{try{let n;this.logger.safe.debug(`[${e}] Polling audio receiver stats to detect early media start`);const r=await t.getStats();this.diagnostics?.registerEarlyMediaPoll();for(const e of r.values())if("inbound-rtp"===e.type){n=e;break}(this.terminated||!n||n.bytesReceived>0||"have-remote-pranswer"!==this.peerConnection.signalingState)&&(this.logger.safe.debug(`[${e}] Finished polling early media audio stats ${!this.terminated}`),this.terminated||this.callbacks.onAudioStateChanged?.(tt.STREAMING_STATE.active,e),clearInterval(i))}catch(t){const n=Ge(t);this.logger.safe.error(`[${e}] Error polling stats for pranswer: ${n}`),this.diagnostics?.addStatsError("WebrtcSession::earlyMediaPolling",n),this.callbacks.onAudioStateChanged?.(tt.STREAMING_STATE.active,e),clearInterval(i)}}),this.configProvider.config.webrtcPranswerWaitForMediaPollingInterval)}startIceDisconnectedTimer(e){this.configProvider.config.iceDisconnectedTimeoutMs&&(this.iceDisconnectedTimer=setTimeout((()=>{this.logger.safe.error(`[${e}] ice disconnected for ${this.configProvider.config.iceDisconnectedTimeoutMs}ms. Raise ${tt.MEDIA_ERROR.iceConnectionError}`),this.raiseError({type:tt.MEDIA_ERROR.iceConnectionError,detail:"ice transport disconnected"},e)}),this.configProvider.config.iceDisconnectedTimeoutMs))}clearIceDisconnectedTimer(){this.iceDisconnectedTimer&&(clearTimeout(this.iceDisconnectedTimer),this.iceDisconnectedTimer=null)}raiseError(e,t=Re()){this.logger.safe.error(`[${t}] Media error occurred type: ${e.type} detail: ${e.detail}`),this.callbacks.onSessionErrorOccurred&&this.callbacks.onSessionErrorOccurred(e,t)}resetCandidateGathering(e){this.logger.safe.info(`[${e}] reset candidate gathering`),this.iceCandidatesDeferred.promise.then((()=>{}),(()=>{})),this.iceCandidatesDeferred.reject(new Error("reset candidate gathering")),this.iceCandidatesDeferred=new Mu,this.iceCandidateReceived=!1}checkIceCandidates(e){const t=this.hasIceCandidates(e);if(t===this.noIceCandidates&&(this.noIceCandidates=!this.noIceCandidates,this.ufdManager.signalEvent("NoNetwork",this.noIceCandidates?"Bad":"Good"),this.noIceCandidates))throw{type:tt.MEDIA_ERROR.noNetworkError,detail:"no ice candidates"};if(t){const t=this.hasRelayIceCandidates(e);if(t===this.noRelayIceCandidates){if(!t&&this.isIceConnected())return;this.noRelayIceCandidates=!this.noRelayIceCandidates,this.ufdManager.signalEvent("NetworkRelaysNotReachable",this.noRelayIceCandidates?"Bad":"Good")}}}hasIceCandidates(e){return this.configProvider.mediaConfig.isTransportUnbundled?e.hasUnbundledIceCandidates():e.hasIceCandidates()}hasRelayIceCandidates(e){return this.configProvider.mediaConfig.isTransportUnbundled?e.hasUnbundledRelayIceCandidates():e.hasRelayIceCandidates()}doRetargetIfNeeded(e,t,i){const n=t.isIceRestart();this.logger.safe.info(`[${i}] ICE restart: ${n}`),this.context.configProvider.mediaConfig.isTransportUnbundled&&this.offeredDescription&&this.offeredDescription.isMSRTC()&&n&&!this.multiParty&&t.getSrtpInfo().sdes&&(e.newOffer=!0)}notifyStreamsChanged(){this.logger.safe.info(`Scheduling stream changed notification: ${this.streamsChangedNotificationScheduled}`),this.streamsChangedNotificationScheduled||this.negotiationCompletedPromise.promise.catch((()=>{})).then((()=>{this.streamsChangedNotificationScheduled=!1,this.streamsChangedListener&&this.streamsChangedListener()}))}async streamAdded(e){if(tt.MODALITY.audio===e.getModality()&&(this.webrtcAudioRecvStream=e.getMediaStream(),await this.audioRenderer.setOutputDevice(this.deviceManager.getOutputDeviceId()),await this.updateAudioRendererStream(this.webrtcAudioRecvStream)),this.configProvider.config.mapSsrcToTrackForStats){const t=this.mediaManager.getMediaEntityByRemoteStreamId(e.getMediaStream().id);this.statsGatherer.setSsrcTrackPair(t.getRemoteSsrc(),t.getRemoteTrackId())}this.notifyStreamsChanged()}async updateAudioRendererStream(e){await this.audioRenderer.play(e),await this.deviceManager.effectsManager.setAecRefStream(e),this.rawIncomingAudioStreamManager.streamChanged(e)}streamRemoved(e){if(tt.MODALITY.audio===e.getModality())this.audioRenderer.getStream()===e.getMediaStream()&&(this.audioRenderer.stop(),this.rawIncomingAudioStreamManager.streamChanged(null)),this.deviceManager.effectsManager.setAecRefStream(null),this.webrtcAudioRecvStream=null;else if(tt.MODALITY.video===e.getModality()){const t=this.mediaManager.getMediaEntityByRemoteStreamId(e.getMediaStream().id);t?.getLocalRecvCapabilities()?.resetToInitial()}this.clearReceiveStreamTransforms(e.getReceiver()),e.dispose(),this.notifyStreamsChanged()}setNegotiatedModalities(e){this.logger.safe.info(`setNegotiatedModalities ${JSON.stringify(e)}`),this.negotiatedModalities=e,this.statsGatherer.sessionInfo.setNegotiatedModalities(e),this.diagnostics&&(this.diagnostics.negotiatedModalities=e)}setupIceGatheringTimeout(e){this.iceRelayCandidatesGatherStartTime=Date.now();const t=this.context.config.webrtcIceGatheringTimeoutIncreased?this.configProvider.config.relayWaitSaneTimeoutMs:this.configProvider.config.webrtcIceGatheringTimeoutMs;if(!t)return;this.iceCandidatesTimer>0&&clearTimeout(this.iceCandidatesTimer);const i=this.iceCandidatesDeferred;this.iceCandidatesTimer=setTimeout((()=>{this.iceCandidatesTimer=0,i.isPending&&(this.logger.safe.warn(`[${e}] ICE candidates gathering terminated due to timeout ${t}`),i.resolve())}),t)}isConnected(){return this.isTransportConnected()&&"closed"!==this.peerConnection.signalingState}isFailed(){return this.peerConnection&&("failed"===this.lastTransportConnectionState||"closed"===this.lastTransportConnectionState)}hasRelayCandidates(){return this.relayCandidateGathered}isIceConnected(){return"connected"===this.peerConnection?.iceConnectionState||"completed"===this.peerConnection?.iceConnectionState}isTransportConnected(){return this.peerConnection&&("connected"===this.lastTransportConnectionState||"completed"===this.lastTransportConnectionState)}createReceiveStream(e,t,i,n){const r=this.configProvider.config.addFmtpToInitialSubscription?n.getLocalRecvCapabilities():null,s=this.configProvider.config.useMultiviewLimitsOnInitialRequest&&n.getModality()!==tt.MODALITY.sharing?()=>this.remoteVideoManager.getMaxAllowedVideoFS():null,a=new gN(e,t,n.getModality(),+n.getXSourceStreamId(),this,r,s);return new AL(a,i,this.receiveStreamCollection,this.logger.createChild("RecvStream"),this.configProvider.config)}async requestSource(e,t,i){if(!this.multiParty)return;const n=this.mediaManager.getMediaEntityByRemoteStreamId(e);if((this.isMuteHold||this.negotiatedModalities[n.getModality()]===tt.MEDIA_STATE.inactive)&&t!==yO.SourceNone)return await pm(10),this.requestSource(e,t);if(this.negotiationCompletedPromise.isPending)try{await this.negotiationCompletedPromise.promise}catch{this.logger.safe.error("source request should be sent even if negotiation rejected")}if(!this.isConnected()){this.logger.safe.info("requestSource is postponed till transport is connected");const e=um();this.toBeCalledAfterConnected.push((()=>e.resolve())),await e.promise}return this.extensionsManager.getExtension("videoStreamControl").sendSourceRequest(n.getXSourceStreamId(),t,n?.getMid(),i,n.getSubstreamIndex())}async assureStreamsAndDataChannel(e,t,i){this.logger.safe.info(`[${t}] assureStreamsAndDataChannel `,this.negotiatedModalities,"offered",this.offeredModalities," mod ",e),this.dataChannel&&this.dataChannel.updateDataModalityState(e.data),i?.mark("startConfigureHold");const n=await this.configureHold(this.negotiatedModalities,e,t);if(i?.markAndMeasure("startConfigureHold","configureHold"),n)return this.logger.safe.info(`[${t}] Hold is configured. Not updating streams`),e;const r=await this.streamSendersManager.update(e,!1,t,i?.clone("updateStreams"));return i?.markAndMeasure("configureHold","updateStreams"),this.dataChannel&&e.data&&(r.data=e.data),r}async configureHold(e,t,i){const n=Mg(e),r=Mg(t);return n!==r&&await this.streamSendersManager.setHold(r,i),r}getStreamTransformConfiguration(){return{unifiedPlanEnabled:!0,addPrefixForMsid:this.configProvider.config.addPrefixForMsidInSdp}}applyReceiveCapabilities(){const e=this.mediaManager.getMediaEntities().map((e=>e.getRemoteRecvCapabilities()));this.multiParty?this.qualityManager.setPendingCapabilities():this.qualityManager.setMaxCapabilities(e)}async onReceiveCapabilitiesChanged(e,t,i){if(!this.streamSendersManager)return!1;try{return await this.streamSendersManager.applyCapabilities(t,e,i),!0}catch(e){return!1}}onOptimalVideoCountChanged(e,t){this.callback.onOptimalVideoReceiversCountChanged&&this.callback.onOptimalVideoReceiversCountChanged(e),this.diagnostics.addOvcSubscriptionReport(e,this.subscriptionManager?.getSubscriptionsCount(),t)}async onSendBandwidthChanged(e){if(!this.isConnected())return;const t=this.extensionsManager.getExtension("videoStreamControl"),i=this.mediaManager.getMediaEntities().filter((e=>[tt.MODALITY.video,tt.MODALITY.sharing].indexOf(e.getModality())>-1)).filter((e=>e.isEnabled())).map((e=>e.getMid()));0!==i.length&&(await t.sendBandwidthInfo(i,e),this.statsGatherer.setReportedSendBandwidth(e),this.diagnostics&&(this.diagnostics.reportedSendBandwidth=e))}onMaxVideoSendCapabilitiesChanged(e,t){if("Video"===e&&this.configProvider.config.maxSendVideoCapabilitiesReportingForVideoEnabled||"ScreenShare"===e&&this.configProvider.config.maxSendVideoCapabilitiesReportingForSharingEnabled)return this.isConnected()?void this.notifyMaxVideoCapabilitiesChanged(e,t):(this.logger.safe.info("sendMaxVideoSendCapabilities is postponed till transport is connected"),void this.toBeCalledAfterConnected.push((()=>this.notifyMaxVideoCapabilitiesChanged(e,t))))}notifyMaxVideoCapabilitiesChanged(e,t){const i=this.extensionsManager.getExtension("videoStreamControl"),n=jg(e),r=this.mediaManager.getMediaEntitiesByModality(n)[0];if(!r)return;const s=r.getMid();i.sendMaxVideoSendCapabilities([s],t)}createAudioRenderer(){this.audioRenderer=new EI(this.logger.createChild("AudioRenderer"),this.configProvider),this.context.maContext.domOverrides.onMediaElementAdded&&this.audioRenderer.on("onAudioElementAdded",this.context.maContext.domOverrides.onMediaElementAdded),this.context.maContext.domOverrides.onMediaElementRemoved&&this.audioRenderer.on("onAudioElementRemoved",this.context.maContext.domOverrides.onMediaElementRemoved),this.audioRenderer.on("onAudioPlaybackError",((e,t,i)=>this.onAudioPlaybackError(e,t,i)))}onAudioPlaybackError(e,t,i){const n={type:t,detail:i,isAudio:!0};this.deviceManager.raiseTelemetryEvent("reconnect_on_audio_playback_error",{error:e,mediaError:t,message:i}),this.context.reconnectRetry&&this.configProvider.config.audioRendererFailedRetryCodes?.includes(e)&&(this.logger.warn(`Reconnect required, attempt No: ${this.context.reconnectRetry}`),this.context.reconnectRetry--,this.raiseError(n))}getModalitiesForRollback(e){const t=Fg(this.negotiatedModalities,this.negotiatingModalities);return this.logger.safe.debug(`[${e}] configured modalities for rollback: ${JSON.stringify(t)}`),t}fixLocalDescription(e){this.configProvider.config.insertFakeCandidateIfNeeded&&(this.iceCandidateReceived||!this.iceCandidateReceived&&this.isIceConnected())&&e.insertFakeCandidateIfNeeded(this.statsGatherer.sessionInfo,this.diagnostics),e.fixDataModality()}getSessionConfig(){return this.configProvider}getLocalMediaTrackId(e){const t=this.mediaManager.getLocalTracksInfo(),i=jg(e),n=t.find((e=>e.modality===i));return n?n.trackId:null}addReceiveStreamTransforms(e,t){const i=this.encStreamsManager.initTransformsCollection(e,"Receiver",$g(t));i&&t!==tt.MODALITY.audio&&this.configProvider.config.useInsertableStreams?.videoStreamAnalyzer&&i.addTransform(new _N(this.logger.createChild(`RecvStreamAnalyzer [${t}/${e.track.id}]`)))}clearReceiveStreamTransforms(e){this.encStreamsManager.clearTransformsCollection(e)}async checkVideoCodecsSupport(){try{const e=await this.capabilityGatherer.getCapabilities("video");this.statsGatherer.setH264AvailableProfiles(e);const t=await Cg.isCodecsSupported(this.configProvider.config.hevcCodecs);this.diagnostics&&(this.diagnostics.videoCapabilities=e,this.diagnostics.isCodecsSupported=t);const i=new Set(e?.codecs?.map((e=>e.mimeType.toLocaleLowerCase()))||[]);for(const e of this.configProvider.config.requiredVideoCodecs)if(!i.has(e)){this.ufdManager.signalEvent("NoRequiredVideoCodecs","Bad","Video");break}}catch(e){this.logger.safe.error(`failed to get video capability ${Ge(e)}`)}}getMediaDescriptions(e){if(Mg(e))return{};const t=[];for(const i of this.mediaManager.getMediaEntities()){if(!i.getExtension("reinviteless"))continue;const n=e[i.getModality()],r={mid:i.getMid(),direction:!i.getLocalTrackId()&&Ag(n)?Ig(n):n};t.push(r)}return{descriptions:t}}updateSendStreamsReinviteless(e){if(dt(this.negotiatedModalities)||Mg(this.negotiatedModalities)||Mg(this.configuredModalities))return!1;this.reinvitelessRequestedModalities=ht(this.negotiatedModalities);for(const[e,t]of Object.entries(this.configuredModalities)){const i=this.mediaManager.getMediaEntitiesByModality(e)[0];i?.getExtension("reinviteless")&&(this.reinvitelessRequestedModalities[e]=t)}return!mt(this.reinvitelessRequestedModalities,this.negotiatedModalities)&&(this.callbacks?.onUpdateMediaDescriptionsRequired?.(e),mt(this.reinvitelessRequestedModalities,this.configuredModalities))}setBWSeed(e){if(!this.configProvider.config.setBWSeed)return;const t=this.extensionsManager.getExtension("bandwidthCache").getBWSeed();e.applyChannelParameters={multiChannelParameter:{mids:this.configProvider.config.bwSeedOptions.mids,mediaParameter:JSON.stringify({sendSideBWSeed:{seedValueBitsPerSec:t}})}},this.diagnostics.sentBWSeed=t}getSubscriptionManager(){return this.subscriptionManager}initAudioCodec(e){this.audioCodecManager.init(e);const t=this.audioCodecManager.decoder;t&&(t.on("usedDecoderChanged",(e=>{this.updateAudioRendererStream(e?t.stream:this.webrtcAudioRecvStream),this.statsGatherer.setAudioDecoderStatsProvider(e?t.getStatsProvider():void 0)})),this.audioCodecManager.on("negotiationNeeded",(e=>this.triggerRenegotiation(!0,e))))}configureAudioCodec(){this.audioCodecManager.prepareForNegotiation(this.initiator)}checkAudioCodecNegotiated(e){const t=this.audioCodecManager.negotiationCompleted();if(this.configProvider.mediaConfig.spatialAudioEnabled){const i=t?"Good":"Bad";this.ufdManager.signalEvent("SpatialAudioMUCHUnavailable",i,"Audio",!0,e)}}onIncomingVideoQualityChanged(e,t){1===e&&this.remoteVideoResolutionManager.limitResolutionOnPoorPerformance(t)}getVideoDeviceManager(){return this.context.callDeviceManager.getDeviceManager("Video")}setupCallDeviceManagerSubs(){this.callDeviceManagerSub=this.context.callDeviceManager.on("onSelectedVirtualDevicesChanged",(()=>{this.logger.info("VirtualDevice changed, disposing onLocalRendererStarted sub"),this.dmSub.dispose(),this.logger.info("New onLocalRendererStarted created"),this.dmSub=this.getVideoDeviceManager().on("onLocalRendererStarted",(e=>e.setStatsProvider(this.statsGatherer)))}))}updateLocalMediaSources(){this.mediaManager.updateMediaEntitiesWithLocalTracks(),this.configProvider.config.mapSsrcToTrackForStats&&this.statsGatherer.updateStatsWithLocalSsrcTrackInfo();const e=this.streamSendersManager.getLocalMediaSources();this.qualityManager.updateRegisteredSources(e)}},Sx={build:(e,t,i)=>new fx(e,t,i)},vx=class{constructor(e,t,i,n,r,s,a,o){this.logger=e,this.context=t,this.configProvider=i,this.diagnostics=n,this.ufdManager=r,this.deviceManager=s,this.capabilities=a,this.midCallTelemetry=o,this.activeSessions=[],this.pendingDeviceTelemetryEvents=[],this.pendingVideoEffectsTelemetryEvents=[],this.pendingAudioEffectsTelemetryEvents=[],this.callsCount=0,this.mediaConfig={},this.configProvider.on("configUpdated",(()=>this.configApplied())),this.deviceManager.on("onDeviceTelemetryEvent",(e=>this.onDeviceTelemetryEvent(e))),this.deviceManager.on("onVideoEffectsTelemetryEvent",(e=>this.onVideoEffectsTelemetryEvent(e))),this.deviceManager.on("onAudioEffectsTelemetryEvent",(e=>this.onAudioEffectsTelemetryEvent(e)))}createSession(e,t,i,n){this.configProvider.setMediaConfiguration(this.mediaConfig);const r=this.configProvider.getConfigView(i?.isConference),s=this.logger,a=this.diagnostics.newSession(r,t,this.logger.createChild("sessionDiagnostics")),o={getLogger:()=>s,getUfdManager:()=>this.ufdManager,maContext:this.context,config:i??{},configProvider:r,diagnostics:a.newNativeSessionDiag(),reconnectRetry:r.config.audioRendererFailedReconnectTimes,callDeviceManager:n},l=(r.mediaConfig.simulcastSessionEnabled?Sx:TN).build(o,t,e),d=new mO(r,++this.callsCount,a);d.setMediaQosEnabled(!!this.mediaConfig.enableMediaQoS),d.setPortRangeConfigured(!!this.mediaConfig.mediaPortRanges);const c=new dO(l,t,o,e,d,this.configProvider,a);for(c.on("onTerminated",(e=>this.onSessionTerminated(e))),this.activeSessions.push(c),this.configProvider.updateSessionCount(this.activeSessions.length),this.webRtcInternalsCollector=KM.getInstance(this.logger.createChild("WebRtcInternals"),r),this.webRtcInternalsCollector.updateSessionCount(this.activeSessions.length);this.pendingDeviceTelemetryEvents.length>0;)c.registerDeviceTelemetryEvent(this.pendingDeviceTelemetryEvents.pop());for(;this.pendingVideoEffectsTelemetryEvents.length>0;)c.registerVideoEffectsTelemetryEvent(this.pendingVideoEffectsTelemetryEvents.pop());for(;this.pendingAudioEffectsTelemetryEvents.length>0;)c.registerAudioEffectsTelemetryEvent(this.pendingAudioEffectsTelemetryEvents.pop());return c}getDeviceManager(){return this.deviceManager}getCapabilities(){return this.capabilities}getScreenSharingManager(){return new QM(this.deviceManager)}updateConfig(e,t,i,n){this.configProvider.updateConfig(e,t,i,n)}getConfig(){return this.configProvider.config}getConfigProvider(){return this.configProvider}setMediaConfig(e){(0,qM.merge)(this.mediaConfig,e),this.diagnostics.mediaConfig=this.mediaConfig}getMediaLogs(){return this.webRtcInternalsCollector?this.webRtcInternalsCollector.collect():Promise.resolve("")}dispose(e){return Promise.all([this.deviceManager.dispose(),this.capabilities.dispose(),...this.activeSessions.map((async t=>{await t.terminate(e,{}).catch((()=>{})),t.dispose()}))]).then((()=>{}),(()=>{}))}handleSendMidCallTelemetry(e){this.midCallTelemetry?.on("sendMidCallTelemetry",e)}configApplied(){window&&(this.configProvider.config.enableDevtoolsAPI?window.webMA||this.injectDevtoolsAPI():window.webMA&&delete window.webMA)}injectDevtoolsAPI(){const e={config:{addOverride:(e,t)=>this.configProvider.setConsoleOverride(e,t),setOverrides:e=>this.configProvider.setConsoleOverrides(e),clearOverride:e=>this.configProvider.clearConsoleOverride(e),clearAllOverrides:()=>this.configProvider.clearAllConsoleOverrides(),setConstraints:e=>this.configProvider.setCallConstraints(e),setRelayConfigOverride:e=>this.context.getRelayManager().setRelayOverride(e)},diagnosticsReport:this.diagnostics.reportGenerator,deviceManager:{setAudioProcessingFlags:e=>this.deviceManager.setAudioProcessingFlags(e)}};window.webMA=e}onDeviceTelemetryEvent(e){this.activeSessions.length>0?this.activeSessions.forEach((t=>t.registerDeviceTelemetryEvent(e))):this.pendingDeviceTelemetryEvents.push(e)}onVideoEffectsTelemetryEvent(e){this.activeSessions.length>0?this.activeSessions.forEach((t=>t.registerVideoEffectsTelemetryEvent(e))):this.pendingVideoEffectsTelemetryEvents.push(e)}onAudioEffectsTelemetryEvent(e){this.activeSessions.length>0?this.activeSessions.forEach((t=>t.registerAudioEffectsTelemetryEvent(e))):this.pendingAudioEffectsTelemetryEvents.push(e)}onSessionTerminated(e){ot(this.activeSessions,(t=>t===e)),this.configProvider.updateSessionCount(this.activeSessions.length),this.webRtcInternalsCollector.updateSessionCount(this.activeSessions.length),0===this.activeSessions.length&&this.ufdManager.reset()}},yx=class{static build(e,t,i,n,r,s,a,o){return new vx(e,t,i,n,r,s,a,o)}};yx.constants=tt,yx.helper=hg;var Cx=class{constructor(e,t){this.getWorker=e,this.logger=t,this.createWasmCVWorker=()=>(this.logger.info("Creating wasmcv worker"),this.create({msg:"wasmcv"})),this.createEncodedStreamsWorker=()=>(this.logger.info("Creating encoded-stream worker"),this.create({msg:"encoded-stream"}))}get audioWorklet(){return null}create(e){const t=this.getWorker();return t.onerror=t=>{this.logger.error(`Worker ${JSON.stringify(e)} error: ${t.message}`)},t.onmessage=t=>{this.logger.info(`Worker ${JSON.stringify(e)} event: ${JSON.stringify(t.data)}`)},t.postMessage(e),t}},Tx=class{constructor(e,t,i){e.logger??(e.logger=new Hm),e.domOverrides??(e.domOverrides={}),this.config=e;const n=e.mediaSettings;fg(e.clientInformation),this.logger=new WM(e.safeLogger?.createChild("MA",n.debug),e.logger.createChild("MA",n.debug)),this.configProvider=new yI(this.logger.createChild("configProvider"),i,n);const r=new tR(this.configProvider);this.mediaAgentDiagnostics=new GM(this.configProvider,r),this.ufdManager=new jm(this.logger.createChild("UFD"),this.configProvider),this.configProvider.config.useGenericWorkerLoader&&e.createWasmWorkerCbs.createGenericWebRTCWorker&&(this.wasmLoader=new Cx(e.createWasmWorkerCbs.createGenericWebRTCWorker,this.logger.createChild("WasmLoader"))),this.deviceManager=new eR(this.logger.createChild("DeviceManager"),this.configProvider,r,e.domOverrides,this.ufdManager,e.webcvProvider,e.wasmdnsProvider,e.wasmaecProvider,e.wasmVqeProvider,this.wasmLoader||e.createWasmWorkerCbs),this.capabilities=new Bm(this.configProvider),NI.initialize(this.configProvider),t.on("OnECSChanged",(()=>{const e=t.getEcsConfig("SkypeWebMedia","mediaAgent");e?this.configProvider.updateConfig(e,t.ETag,t.getEcsConfig("ConfigIDs","SkypeWebMedia"),t.getEcsConfig("Headers","CountryCode")):this.logger.warn("No SkypeWebMedia.mediaAgent config.")}))}getDeviceManager(){return this.deviceManager}async buildAgent(e,t,i){if(!Cg.hasMediaApi())throw[new Ex(`${e} not supported by media agent provider`,"not_supported")];if(this.config?.detectH264Support&&!await Cg.hasH264CodecSupport(this.config.logger))throw[new Ex("H264 is not supported","not_supported")];const n=await async function(e,t){if(e?.createEncodedStreamsWorker)return{getWorker:()=>e.createEncodedStreamsWorker()};if(t){const e=await t.getWorkerUrl();return{getWorker:()=>new Worker(e)}}return null}(this.config.createWasmWorkerCbs,this.config.encodedStreamsWorkerProvider),r={getRelayManager:()=>t.getOrCreateRelayManager(),getWebCVProvider:()=>this.config.webcvProvider,getWasmDnsProvider:()=>this.config.wasmdnsProvider,getWasmAecProvider:()=>this.config.wasmaecProvider,getWasmVqeProvider:()=>this.config.wasmVqeProvider,getEncodedStreamsWorkerProvider:()=>n,domOverrides:this.config.domOverrides,configProvider:this.configProvider};t.setConfigProvider(this.configProvider);const s=yx.build(this.logger,r,this.configProvider,this.mediaAgentDiagnostics,this.ufdManager,this.deviceManager,this.capabilities,i);return s.constants=yx.constants,s}},Ex=class extends Error{constructor(e,t="failure"){super(e),this.reason=t}},_x=class{constructor(){this.supportedPlatforms=new Map([["Chrome","59.0"],["EdgeAnaheim","79.0"],["Safari","13.1"],["Electron","3.0"],["Firefox","96.0"],["WebView2","1.0"]]),this.experimentalPlatforms=new Map}getPlatformSupportLevel(e){const t=li(),i=this.supportedPlatforms.get(t.name);if(e&&i&&em(t.version,i))return 1;if(e&&!i){if("Chromium"===t.engine||"ChromiumAVD"===t.engine)return 2;const e=this.experimentalPlatforms.get(t.name);if(e&&em(t.version,e))return 2}return 0}},bx=class extends Ye{constructor(e){super(),this.ecsFilters=e,this.config=null}get ETag(){return this.etag}async setEcsConfig(e){this.config=JSON.parse(e.ecsBlob),this.etag=e.etag,this.event("OnECSChanged").raise()}async setUserEcsServerUrl(e,t){throw new Error("Not implemented")}async getUserEcsServerUrl(e){throw new Error("Not implemented")}async setActiveUserForEcs(e){throw new Error("Not implemented")}async getEcsQueryParameters(){const e={CLRelease:"2024.13.01.19"},t="_TS_BUILC_VERSION_".replace("C","D"),i=this.ecsFilters?.["UserInfo.Ring"]?.value,n=this.getTeamsExperience();e.CLRelease===t&&(e.CLRelease="9999.99"),i&&(e.audienceGroup=i,e.teamsRing=i),n&&(e.Experience=n);const r=li();return e.BrowserName=r.name,e.BrowserEngine=r.engine,e.BrowserVersion=r.version,e.FormFactor=r.formFactor,Cg.hardwareConcurrency&&(e.CPUCount=Cg.hardwareConcurrency),JSON.stringify(e)}async ecsGetUserQueryParameters(e){return this.getEcsQueryParameters()}async shouldTriggerCQF(e,t,i){throw new Error("Not implemented")}getEcsConfig(e,t){const i=this.config&&this.config[e];return t?i&&i[t]:i}createEcsConfiguration(){return new class{constructor(e){this.provider=e}getBoolean(e,t){return this.provider.getEcsConfig(e,t)}getNumber(e,t){return this.provider.getEcsConfig(e,t)}getString(e,t){const i=this.provider.getEcsConfig(e,t);return JSON.stringify(i)}}(this)}getTeamsExperience(){return!0===this.ecsFilters?.isTeams2?.value?"teams2":!1===this.ecsFilters?.isTeams2?.value?"teams1":void 0}},Px=class{constructor(e){this._sharingSource=e}getId(){return this._sharingSource.getId()}getDeviceId(){return this._sharingSource.getDeviceId()}getType(){return this.mapSharingSourceType(this._sharingSource.getType())}getPreview(e,t,i){return Promise.reject("not implemented")}getPreviewAsync(e,t){return this._sharingSource.getPreviewAsync(e,t)}getDescription(){return this._sharingSource.getDescription()}getIcon(e,t){return this._sharingSource.getIcon(e,t)}getBounds(){}mapSharingSourceType(e){switch(e){case 1:return 1;case 2:return 2;case 3:return 3;default:throw new Error("Invalid sharing source type")}}},Ix=class extends Ye{constructor(e){super(),this._screenSharingManager=e,this._screenSharingManager.onScreensChanged((()=>{this.event("screensChanged").raise()}))}enumerateScreensAsync(){return this._screenSharingManager.enumerateScreensAsync().then((e=>e.map((e=>new Px(e)))))}enumerateWindowsAsync(){return this._screenSharingManager.enumerateWindowsAsync().then((e=>e.map((e=>new Px(e)))))}enumerateCamerasAsync(){return this._screenSharingManager.enumerateCamerasAsync().then((e=>e.map((e=>new Px(e)))))}},Ax=i(174958);function Rx(e,t){return null==e?t:e}function wx(e,t){return e||t}var Mx,Ox,Dx=class{constructor(e,t,i,n){this.signalingAgentConfig=e,this.ecsProvider=t,this.logger=i,this.telemetryLogger=n,this.ecsProvider.on("OnECSChanged",(()=>this.onEcsUpdate())),this.signalingAgentConfig.clientInformation+="/TsCallingVersion=2024.13.01.19/Ovb=5d60bfcfbf65862f074bd44f3beb1676fd6f338a",this.signalingAgentConfig.piiScrubber={omit:Ax.pii.Omit,mri:Ax.pii.Mri},this.signalingAgent=new Hh(this.getSignalingAgentConfig())}getSignalingAgent(){return this.signalingAgent}onEcsUpdate(){const e=this.ecsProvider.getEcsConfig("SkypeCalling");this.logger.info(`onEcsUpdate, ecsTag=${this.ecsProvider.ETag||""}, ecsConfig=${JSON.stringify(e)}`),this.signalingAgentConfig=((e,t)=>{if(!t)return e;const i={...e};if(t.ngIncoming&&t.ngOutgoing){const s=(n=t.ngIncoming.isVBSSEnabled,(r=t.ngOutgoing.isVBSSEnabled)&&n?"enabled":n?"recvOnly":!1===n&&!1===r?"disabled":void 0);i.cloudScreenSharingFlag=Rx(s,e.cloudScreenSharingFlag)}var n,r,s,a;return t.ngOutgoing&&(i.emergencyCallCountry=(s=t.ngOutgoing.isEmergencyCallingEnabled,a=e.emergencyCallCountry,!1===s?"":a),i.isGVCOutgoingEnabled=Rx(t.ngOutgoing.isGVCEnabled,e.isGVCOutgoingEnabled),i.brokerEnabledOutgoing=Rx(t.ngOutgoing.isBrokerEnabled,e.brokerEnabledOutgoing)),t.ngIncoming&&(i.isGVCJoiningEnabled=Rx(t.ngIncoming.isGVCEnabled,e.isGVCJoiningEnabled),i.brokerEnabledIncoming=Rx(t.ngIncoming.isBrokerEnabled,e.brokerEnabledIncoming)),i.conversationServiceUrl=wx(t.conversationServiceUrl,e.conversationServiceUrl),i.uploadLogRequestUrl=wx(t.uploadLogRequestUrl,e.uploadLogRequestUrl),i.isConversationServiceUrlFromEcs=!!t.conversationServiceUrl,i.isUploadLogRequestUrlFromEcs=!!t.uploadLogRequestUrl,i.callingTokenLogicalUrl=wx(t.callingTokenLogicalUrl,e.callingTokenLogicalUrl),i.doHostlessCalling=Rx(t.allowHostlessCalls,e.doHostlessCalling),i.supportsCompressedServicePayload=Rx(t.supportCompressedTrouterPayload,e.supportsCompressedServicePayload),i.brokerRequestBatching=Rx(t.allowBrokerSubscribeBatching,e.brokerRequestBatching),i.brokerExclusively=Rx(t.brokerExclusively,e.brokerExclusively),i.handleMediaOfferFromPushNotification=Rx(t.handleMediaOfferFromPushNotification,e.handleMediaOfferFromPushNotification),i.handleNewOfferRequest=Rx(t.handleNewOfferRequest,e.handleNewOfferRequest),i.sendProgressFromCC=Rx(t.sendProgressFromCC,e.sendProgressFromCC),i.useInternalHttpDispatcher=Rx(t.webInternalHttpDispatcher,e.useInternalHttpDispatcher),(t.webInternalHttpDispatcherConfigNetworkRequest||e.requestTypeHttpDispatcherConfigMap)&&(t.webInternalHttpDispatcherConfigNetworkRequest=t.webInternalHttpDispatcherConfigNetworkRequest||{},e.requestTypeHttpDispatcherConfigMap=e.requestTypeHttpDispatcherConfigMap||{},i.requestTypeHttpDispatcherConfigMap={...e.requestTypeHttpDispatcherConfigMap,...t.webInternalHttpDispatcherConfigNetworkRequest}),(t.operationTypeHttpDispatcherConfigMap||e.operationTypeHttpDispatcherConfigMap)&&(t.operationTypeHttpDispatcherConfigMap=t.operationTypeHttpDispatcherConfigMap||{},e.operationTypeHttpDispatcherConfigMap=e.operationTypeHttpDispatcherConfigMap||{},i.operationTypeHttpDispatcherConfigMap={...e.operationTypeHttpDispatcherConfigMap,...t.operationTypeHttpDispatcherConfigMap}),(t.csaTimeoutConfiguration||e.csaTimeoutConfiguration)&&(t.csaTimeoutConfiguration=t.csaTimeoutConfiguration||{},e.csaTimeoutConfiguration=e.csaTimeoutConfiguration||{},i.csaTimeoutConfiguration={...e.csaTimeoutConfiguration,...t.csaTimeoutConfiguration}),i.autoJoinOnConflict=Rx(t.autoJoinOnConflict,e.autoJoinOnConflict),i.enableQuickSendAcceptanceAck=Rx(t.enableQuickSendAcceptanceAck,e.enableQuickSendAcceptanceAck),i.supportMediaRetargetWhileIncomingRenegotiation=Rx(t.supportMediaRetargetWhileIncomingRenegotiation,e.supportMediaRetargetWhileIncomingRenegotiation),i.enableCallEstablishmentTimeoutsForStartJoinCall=Rx(t.enableCallEstablishmentTimeoutsForStartJoinCall,e.enableCallEstablishmentTimeoutsForStartJoinCall),i.callingServiceSupportsCAETokens=Rx(t.callingServiceSupportsCAETokens,e.callingServiceSupportsCAETokens),i.callingServiceSupportsAADTokens=Rx(t.callingServiceSupportsAADTokens,e.callingServiceSupportsAADTokens),i.aadTokenExpirationTimeInSeconds=Rx(t.aadTokenExpirationTimeInSeconds,e.aadTokenExpirationTimeInSeconds),i.caeTokenExpirationTimeInSeconds=Rx(t.caeTokenExpirationTimeInSeconds,e.caeTokenExpirationTimeInSeconds),i.disableTokenMigrationHeader=Rx(t.disableTokenMigrationHeader,e.disableTokenMigrationHeader),i.enablePublishTokenTelemetry=Rx(t.enablePublishTokenTelemetry,e.enablePublishTokenTelemetry),i.refreshTimeBeforeTokenTimeoutInSeconds=Rx(t.refreshTimeBeforeTokenTimeoutInSeconds,e.refreshTimeBeforeTokenTimeoutInSeconds),i.forceClearExpiredTokens=Rx(t.forceClearExpiredTokens,e.forceClearExpiredTokens),i.enableRefreshToken=Rx(t.enableRefreshToken,e.enableRefreshToken),i.enableAsyncDisablePreheat=Rx(t.enableAsyncDisablePreheat,e.enableAsyncDisablePreheat),i.forceLowercaseHttpHeaders=Rx(t.forceLowercaseHttpHeaders,e.forceLowercaseHttpHeaders),i.enableResolveScreenSharingWhenNegotiationComplete=Rx(t.enableResolveScreenSharingWhenNegotiationComplete,e.enableResolveScreenSharingWhenNegotiationComplete),i.maxReinvitelessMediaForVideoForWeb=Rx(t.maxReinvitelessMediaForVideoForWeb,e.maxReinvitelessMediaForVideoForWeb),i.maxReinvitelessMediaForVBSSForWeb=Rx(t.maxReinvitelessMediaForVBSSForWeb,e.maxReinvitelessMediaForVBSSForWeb),i.enableRefreshTokenRetry=Rx(t.enableRefreshTokenRetry,e.enableRefreshTokenRetry),i.enableRefreshTokenRetryInSeconds=Rx(t.enableRefreshTokenRetryInSeconds,e.enableRefreshTokenRetryInSeconds),i.enableConversationTypeUpdateOnCallEnd=Rx(t.enableConversationTypeUpdateOnCallEnd,e.enableConversationTypeUpdateOnCallEnd),i.supportMissingTokenTypesInResponse=Rx(t.supportMissingTokenTypesInResponse,e.supportMissingTokenTypesInResponse),i.useSkypeTokenWhenNoAuthenticateHeader=Rx(t.useSkypeTokenWhenNoAuthenticateHeader,e.useSkypeTokenWhenNoAuthenticateHeader),i.enableAutoPromotion=Rx(t.enableAutoPromotion,e.enableAutoPromotion),i.enableTokenCache=Rx(t.enableTokenCache,e.enableTokenCache),i.enableBatchedSendMessageStatus=Rx(t.enableBatchedSendMessageStatus,e.enableBatchedSendMessageStatus),i.enableBatchedReceiveMessage=Rx(t.enableBatchedReceiveMessage,e.enableBatchedReceiveMessage),i.enableTokenCacheForGenericTokenAPI=Rx(t.enableTokenCacheForGenericTokenAPI,e.enableTokenCacheForGenericTokenAPI),i.disableRealTimeModeFromRoster=Rx(t.disableRealTimeModeFromRoster,e.disableRealTimeModeFromRoster),i.enableLongOutgoing1To1SetupTimeoutForWeb=Rx(t.enableLongOutgoing1To1SetupTimeoutForWeb,e.enableLongOutgoing1To1SetupTimeoutForWeb),i})(this.signalingAgentConfig,e),this.signalingAgentConfig.ecsEtag=this.ecsProvider.ETag,this.signalingAgent.updateSignalingAgentConfig(this.getSignalingAgentConfig())}getSignalingAgentConfig(){return this.signalingAgentConfig.oneDsTelemetryLogger=this.telemetryLogger,this.signalingAgentConfig}},kx={build:(e,t,i,n)=>new Dx(e,t,i,n)};function Nx(e){return ay(e)&&e>=1&&e<=2}(Ox=Mx||(Mx={}))[Ox.LocalStorage=1]="LocalStorage",Ox[Ox.SessionStorage=2]="SessionStorage",Ox[Ox.IndexedDb=3]="IndexedDb";var Lx="result",xx="DBError: Unable to open database",Fx="Database is not open",Ux="DBError: Failed to delete the database",Vx=["indexedDB"],Hx=Xv,Bx=sy;function $x(e,t){Qy("QUnit")&&console&&console.log("IndexedDbHelper ["+e+"] "+t)}function jx(e,t,i){e&&e.warnToConsole("IndexedDbHelper ["+t+"] "+i)}function Gx(e,t,i,n){return function(r){i(new Error(t)),$x(e,"["+n+"] event rejected")}}var Wx=[];function qx(e,t){for(var i=null,n=0;n<Wx.length;n++)if((i=Wx[n]).name===e)return i;return i={name:e,sch:new P_("IndexedDbHelper["+e+"]",t),dbHdl:[],add:function(t){i.dbHdl.push(t),$x(e,"- dbOpened (add) -- hdls ["+i.dbHdl.length+"]")},remove:function(t){for(var n=i.dbHdl,r=0;r<n.length;r++)if(n[r]===t){n.splice(r,1);break}$x(e,"- dbClosed (remove) -- hdls ["+i.dbHdl.length+"]")},isOpen:function(){return i.dbHdl.length>0},openHdl:function(){return i.dbHdl.length>0?i.dbHdl[0]:null}},Wx.push(i),i}var zx=function(){function e(t){oS(e,this,(function(e){var i=function(){var e=Cf()||{},t=null;if(e)try{for(var i=0;i<Vx.length;i++)if((t=e[Vx[i]])&&Hx(t.open))return t}catch(e){t=null}return t||null}()||null;function n(e,i){var n=e.db.transaction(i,"readwrite");return n.onabort=function(){jx(t,e.dbName,"txn.onabort")},n.onerror=function(){jx(t,e.dbName,"txn.onerror")},n.oncomplete=function(){$x(e.dbName,"txn.oncomplete")},{db:e,store:n.objectStore(i),tx:n,tbl:i,openCursor:function(t,n){return s(e,i,t,n)},newTransaction:function(t){return r(e,i,t)}}}function r(e,t,i){if(!e||!e.db)return v_.reject(new Error(Fx));try{var r=i(n(e,t));return r instanceof v_?r:v_.resolve(r)}catch(e){return v_.reject(e)}}function s(e,t,i,r){if(!e||!e.db)return v_.reject(new Error(Fx));var s=null;return i&&Bx(i)?s=new Kx(i):i&&i.isMatch&&(s=i),new v_((function(i,a){var o=[],l=null,d=null;s&&s.keyRange&&(d=s.keyRange());var c=n(e,t);(l=d?c.store.openCursor(d):c.store.openCursor()).onerror=Gx(c.db.dbName,"DBError: Failed to Open Cursor",a,"openCursor"),l.onsuccess=function(e){var t=e.target[Lx];if(t){var n={store:c,cursor:t,continue:function(){t.continue()},done:function(){i(o)}},l=t.value;if(!s||s.isMatch(l))if(r)try{switch(r(n,l,o)){case 2:i(o);break;case 1:break;default:n.continue()}}catch(e){a(e)}else o.push(l),n.continue();else n.continue()}else i(o)}}))}function a(e,t,i,n){return qx(e).sch.scheduleEvent(i,t,n)}e.isAvailable=function(){return!!i},e.openDb=function(e,n,o,l){return a(e,"openDb",(function(a){return new v_((function(d,c){var h=!1;function u(t,i,a,o,l){var d={db:i,dbName:e,dbVersion:n,ctx:null,isNew:o,txn:a?a.transaction:null};return l||(d.openStore=function(e,t){return r(d,e,t)},d.openCursor=function(e,t,i){return s(d,e,t,i)}),d}var p=qx(e);if(null==i)c(new Error("No available storage factory"));else if(p.isOpen()){var g=u(0,p.openHdl(),null,!1);o(g).then(d,c)}else{var m=i.open(e,n);m.onblocked=function(i){jx(t,e,"Db Open Blocked event ["+a+"] - "+(m.error||"")),c(new Error(xx))},m.onerror=function(i){jx(t,e,"Db Open Error event ["+a+"] - "+(m.error||"")),c(new Error(xx))},m.onupgradeneeded=function(t){$x(e,"Db Open Create/Upgrade needed event ["+a+"]");try{var i=t.target[Lx];if(!i)return void c(new Error(xx));!function(e,t){var i=u(0,e,t,!0,!0);if(l)h=!0,l(i).then((function(){i.txn||(i.txn=t.transaction)}),(function(e){try{t.transaction&&t.transaction.abort()}finally{c(e)}}));else try{t.transaction&&t.transaction.abort()}finally{c(new Error("DBError: Database upgrade required"))}}(i,m)}catch(t){Gx(e,xx,c,a)(t)}},m.onsuccess=function(i){var n=i.target[Lx];n?function(i,n){var r=qx(e);r.add(i),i.onabort=function(n){jx(t,e,"onabort -- closing the Db"),r.remove(i)},i.onerror=function(n){jx(t,e,"onerror -- closing the Db"),r.remove(i)},i.onclose=function(n){jx(t,e,"onclose -- closing the Db"),r.remove(i)},i.onversionchange=function(n){jx(t,e,"onversionchange -- force closing the Db"),i.close(),r.remove(i)};var s,a=null;r.dbHdl.length>0&&(a=r.dbHdl[0]),s=u(0,a,n,h);try{o(s).then((function(e){d(e)}),c)}catch(e){c(e)}}(n,m):c(new Error(xx))}}}))}))},e.closeDb=function(e){a(e,"closeDb",(function(t){var i=qx(e),n=i.dbHdl,r=n.length;if(r>0){for(var s=0;s<r;s++)n[s].close();i.dbHdl=[]}return v_.resolve(1)}))},e.deleteDb=function(e){return null==i?v_.resolve(!1):a(e,"deleteDb",(function(n){var r=qx(e),s=r.dbHdl,a=s.length;if(a>0){jx(t,e,"Db is open ["+a+"] force closing");for(var o=0;o<a;o++)s[o].close();r.dbHdl=[]}return new v_((function(r,s){setTimeout((function(){try{$x(e,"["+n+"] starting");var a=i.deleteDatabase(e);a.onerror=function(i){jx(t,e,"["+n+"] error!!"),s(new Error(Ux))},a.onblocked=function(i){jx(t,e,"["+n+"] blocked!!"),s(new Error(Ux))},a.onupgradeneeded=function(i){jx(t,e,"["+n+"] upgrade needed!!"),s(new Error(Ux))},a.onsuccess=function(t){$x(e,"["+n+"] complete"),r(!0)},$x(e,"["+n+"] started")}catch(i){jx(t,e,"["+n+"] threw - "+i),s(new Error(Ux+" - "+i))}}),0)}))}))},e.getDbDetails=function(e){return a(e,"getDbDetails",(function(t){return null!=i&&i.databases?new v_((function(t,n){i.databases().then((function(i){for(var r=0;r<i.length;r++)if(i[r].name===e)return void t(i[r]);n(new Error("DBError: Database does not exist"))}),n)})):v_.reject(new Error("DBError: Feature not supported"))}),2e3)}}))}return e.__ieDyn=1,e}(),Kx=function(){function e(t){var i=[],n=null;oS(e,this,(function(e){e.keyRange=function(){return n},e.parseQuery=function(t){if(i=[],t)for(var r=t.split(";"),s=0;s<r.length;s++){var a=r[s],o=a.indexOf("=");if(-1!==o){var l=a.substring(0,o),d=a.substring(o+1);0===l.indexOf("#")&&(l=l.substring(1),n||(n=IDBKeyRange.bound(d,d+""))),e.startsWith(l,d)}}},e.startsWith=function(e,t){i.push({name:e,value:t,type:0})},e.contains=function(e,t){i.push({name:e,value:t,type:1})},e.isMatch=function(e){if(!i||0===i.length)return!0;if(!e)return!1;for(var t=0;t<i.length;t++){var n=i[t],r=e[n.name];if(r)if(0===n.type){if(0!==r.indexOf(n.value))return!1}else if(1===n.type&&-1===r.indexOf(n.value))return!1}return!0},t&&e.parseQuery(t)}))}return e.__ieDyn=1,e}(),Jx=6e5,Yx=1008e4,Qx="DBError: Unable to add event",Xx="Evts",Zx="iKey",eF=Nx;function tF(){return(new Date).getTime()}function iF(e){return e.openStore(Zx,(function(t){return new v_((function(i,n){var r,s,a={iKey:e.ctx.iKey,tm:tF()},o=t.store.put(a);o.onsuccess=function(e){i(o.result.toString())},o.onerror=function(e){n(new Error(Qx))},o.onerror=(r="DBError: Unable to update iKey",s=n,function(e){return s(new Error(r))})}))}))}function nF(e){for(var t=[],i=2;i>=1;i--)for(var n=0;n<e.length;n++){var r=e[n];r&&r.evt.persistence===i&&t.push(r.evt)}return t}function rF(e){return function(t){return e.continue()}}function sF(e){var t=e.cursor.delete();return t.onerror=rF(e),t.onsuccess=rF(e),1}function aF(e,t,i){return e.openCursor(Xx,t,(function(e,t,n){return i(t)?(n.push(t),sF(e)):0}))}function oF(e){return e.openCursor(Xx,"#key="+e.ctx.iKeyPrefix(),(function(t,i){var n,r,s=i.key;if(0===s.indexOf(e.ctx.iKeyPrefix())&&-1===s.indexOf(e.ctx.evtKeyPrefix())&&(n=Jx,r=i.tm,tF()-r>n)){i.key=e.ctx.evtKeyPrefix()+i.id;var a=t.store.store.put(i);return a.onerror=rF(t),a.onsuccess=function(e){try{sF(t)}catch(e){t.continue()}},1}return 0}))}function lF(e){return new v_((function(t,i){(function(e){return new v_((function(t,i){var n=!1;e.openCursor(Zx,null,(function(e,t,i){var r=t.tm;return tF()-r<Yx?0:(n=!0,2)})).then((function(){if(n){var r={};aF(e,null,(function(e){if(!e||!e.evt||!e.evt.iKey)return!0;var t=e.tm;return tF()-t>Yx||(r[e.evt.iKey]=1,!1)})).then((function(){var n=[];e.openCursor(Zx,null,(function(e,t,i){var s=t.tm;return tF()-s<Yx||r[t.iKey]?0:(n.push(t),sF(e))})).then((function(){t(n)}),i)}),i)}else t([])}),i)}))})(e).then((function(){oF(e).then(t,t)}),i)}))}var dF=function(){function e(t){oS(e,this,(function(e){var i=null,n=null,r="Unknown",s=null,a=null,o=null,l=-1,d=0;function c(e){return i.openDb(n,1,(function(t){return new v_((function(i,n){var l={iKey:r,storageId:s,iKeyPrefix:function(){return a},evtKeyPrefix:function(){return o}};t.ctx=l,iF(t).then((function(){e(t).then(i,n)}),n)}))}),(function(e){return new v_((function(t,i){var n;(n=e.db).objectStoreNames.contains(Xx)||n.createObjectStore(Xx,{keyPath:"key"}).createIndex("EvntId","key",{unique:!1}),n.objectStoreNames.contains(Zx)||n.createObjectStore(Zx,{keyPath:"iKey"}).createIndex("iKey","iKey",{unique:!0}),t()}))}))}function h(e,t,i){return new v_((function(n,r){function s(t,i){(function(e,t){return new v_((function(i,n){var r=0,s=e.ctx.evtKeyPrefix();function a(){i(r)}function o(e,t){return new v_((function(i){var n=e.store.delete(t.key);n.onsuccess=function(e){r++,i()},n.onerror=function(e){i()}}))}e.openCursor(Xx,"#key="+s,(function(e,i,n){return i.evt.persistence<=t&&0===i.key.indexOf(s)&&(function(e,t){for(var i=0;i<e.length;i++)if(t.tm<e[i].tm)return void e.splice(i,0,t);e.push(t)}(n,i),n.length>10&&n.splice(n.length-1,1)),0})).then((function(t){0!==t.length?e.openStore(Xx,(function(e){for(var i=[],n=0;n<t.length;n++)i.push(o(e,t[n]));return v_.all(i).then(a,a)})):a()}),(function(){i(0)}))}))})(e,t).then((function(e){e>0&&(d-=e),i(e)}),(function(e){i(0)}))}function a(e){n(t.evt)}function o(){e.openStore(Xx,(function(o){var l=o.store.put(t);l.onsuccess=function(r){i&&iF(e).then(a,a),d++,n(t.evt)},l.onerror=function(a){function o(i){0===i&&r(new Error(Qx)),h(e,t,!1).then((function(e){n(t.evt)}),(function(){r(new Error(Qx))}))}i?s(1,(function(e){e>0?o(e):t.evt.persistence>=2?s(2,(function(e){o(e)})):r(new Error(Qx))})):r(new Error(Qx))}}))}l>0&&d>=l?s(1,(function(e){0===e?t.evt.persistence>=2?s(2,(function(e){o()})):r(new Error(Qx)):o()})):o()}))}e.id=t,e.initialize=function(t){var d=t.itemCtx.diagLog();if(!(i=new zx(d)).isAvailable())return i=null,!1;var h=t.itemCtx.getCfg(),u=t.storageConfig||{};return n=u.indexedDbName||"AppInsightEvents.1",r=h.instrumentationKey||r,s=e.id||t.id||YT(),o=(a=r+"::")+s+"::",l=u.maxStorageItems>0?u.maxStorageItems:l,c((function(e){return e.isNew?v_.resolve(!0):lF(e)})).then((function(e){}),(function(e){d.warnToConsole("IndexedDbProvider failed to initialize - "+(e||"<unknown>")),i=null})),!0},e.supportsSyncRequests=function(){return!1},e.getAllEvents=function(){return null!=i&&i.isAvailable()?c((function(e){return new v_((function(t,i){(function(e,t){return e.openCursor(Xx,t,(function(e,t,i){return i.push(t),0}))})(e,"#key="+e.ctx.evtKeyPrefix()).then((function(e){d=e.length,t(nF(e))}),i)}))})):v_.resolve([])},e.addEvent=function(e,t,n){return null!=i&&i.isAvailable()?(t.id=t.id||YT(),eF(t.persistence)||(t.persistence=1),c((function(i){var n=e||t.id,r={key:i.ctx.evtKeyPrefix()+n,id:n,evt:t,tm:tF(),v:1};return h(i,r,!0)}))):v_.resolve(t)},e.removeEvents=function(e){if(null==i||!i.isAvailable())return v_.resolve([]);var t=[];return new v_((function(i,n){c((function(i){return i.openCursor(Xx,"#key="+i.ctx.iKey,(function(i,n,r){if(-1!==function(e,t){for(var i=t.length,n=0;n<i;n++)if(e===t[n].id)return n;return-1}(n.id,e)){var s=i.cursor.delete();return s.onerror=rF(i),s.onsuccess=function(){t.push(n.evt),i.continue()},1}return 0}))})).then((function(e){d-=t.length,i(t)}),(function(e){d-=t.length,i(t)}))}))},e.clear=function(){return null!=i&&i.isAvailable()?new v_((function(e,t){c((function(e){return aF(e,"#key="+e.ctx.evtKeyPrefix(),(function(t){return 0===t.key.indexOf(e.ctx.evtKeyPrefix())}))})).then((function(t){d=0,e(nF(t))}),t)})):v_.resolve([])},e.teardown=function(){i&&i.closeDb(n)}}))}return e.__ieDyn=1,e}(),cF=6e5,hF="AWTEvents";function uF(e){var t=Cf()||{},i=null;try{if(i=t[e]){var n="__storage_test__";i.setItem(n,n),i.removeItem(n)}}catch(e){(function(e,t){var i=!1;return t instanceof DOMException&&(22!==t.code&&"QuotaExceededError"!==t.name&&1014!==t.code&&"NS_ERROR_DOM_QUOTA_REACHED"!==t.name||e&&0!==e.length&&(i=!0)),i})(i,e)||(i=null)}return i}function pF(e,t){if(e)for(var i=my(e),n=0;n<i.length;n++){var r=i[n];if(!t(e[r],r))break}}function gF(e){var t=!0;return pF(e,(function(e,i){return e&&(t=!1),t})),t}function mF(e,t){for(var i=1,n=0,r=function(){var e=[],r=t[i];if(pF(r,(function(t,i){return e.push(i),++n<10})),n>0){for(var s=0;s<e.length;s++)delete r[e[s]];return{value:!0}}i++};i<=e&&n<10;){var s=r();if("object"==typeof s)return s.value}return n>0}var fF=Nx,SF=function(){function e(t,i){oS(e,this,(function(e){var n=null,r=hF,s=null,a=null,o=null,l=5e6,d=null,c=null;function h(e,t){return{key:e,db:t}}function u(e,t){void 0===t&&(t=!0);var i=null;if(n){var r=n.getItem(e);if(r)try{i=JSON.parse(r)}catch(t){n.removeItem(e)}}return t&&!i&&(i={events:{1:{},2:{},3:{}},lastAccessTime:0}),h(e,i)}function p(e,t){void 0===t&&(t=!0);var i=!0,r=e.db;if(r){t&&(r.lastAccessTime=(new Date).getTime());for(var s=1;s<=2;s++)if(!gF(r.events[s])){i=!1;break}}try{if(i)n&&n.removeItem(e.key);else{var a=JSON.stringify(r);if(a.length>l)return!1;n&&n.setItem(e.key,a)}}catch(e){return!1}return!0}e.id=i,n=uF(t)||null,e.initialize=function(t){if(!n)return!1;var i=t.storageConfig||{};return l=i.maxStorageSizeInBytes>0?i.maxStorageSizeInBytes:l,r=i.storageKey||hF,s=e.id||t.id||YT(),c=r+"."+s,d=r+"Version",a=t.itemCtx.getCfg().instrumentationKey,o=o_(a)||a,function(){if(n){for(var e=n.getItem(d),t=[],i=u(c),s=!1,a=0;a<n.length;a++){var l=n.key(a);if(0===l.indexOf(r)&&l!==d){if("3"!==e){t.push(h(l,null));continue}var g=u(l,!1),m=g.db;if(m){if((new Date).getTime()-m.lastAccessTime>cF){for(var f=1,S=function(){var e=m.events[f],t=i.db.events[f];pF(e,(function(i,n){return(o_(i.iKey)||i.iKey)===o&&(t[n]=i,delete e[n]),!0})),f++};f<=2;)S();s=!0,t.push(g)}}else t.push(h(l,null))}}for(a=0;a<t.length;a++)p(t[a],!1);s&&p(i),n.setItem(d,"3")}}(),!0},e.supportsSyncRequests=function(){return!0},e.getAllEvents=function(){try{var e=[],t=u(c,!1).db;if(t)for(var i=t.events,n=2;n>=1;n--)pF(i[n],(function(t){return t&&(o_(t.iKey)||t.iKey)===o&&e.push(t),!0}));return v_.resolve(e)}catch(e){return v_.reject(e)}},e.addEvent=function(e,t,i){try{var n=u(c);t.id=t.id||YT(),fF(t.persistence)||(t.persistence=1);for(var r=t.persistence,s=t.id,a=n.db.events;;){if(a[r][s]=t,p(n))return v_.resolve(t);if(delete a[r][s],!mF(r,a))return v_.reject(new Error("Unable to free up event space"))}}catch(e){return v_.reject(e)}},e.removeEvents=function(e){try{var t=u(c,!1),i=t.db;if(i){var r=i.events;try{for(var s=0;s<e.length;++s){var a=e[s];delete r[a.persistence][a.id]}if(p(t))return v_.resolve(e)}catch(e){}e=function(e){var t=[],i=u(e,!1),r=i.db;if(r){var s=r.events;try{for(var a=1;a<=2;a++)pF(s[a],(function(e,i){return e&&t.push(e),!0}))}catch(e){}n&&n.removeItem(i.key)}return t}(t.key)}return v_.resolve(e)}catch(e){return v_.reject(e)}},e.clear=function(){try{var e=[],t=u(c,!1),i=t.db;if(i){for(var n=i.events,r=function(t){var i=n[t];pF(i,(function(t){return t&&(o_(t.iKey)||t.iKey)===o&&(delete i[t.id],e.push(t)),!0}))},s=2;s>=1;s--)r(s);p(t)}return v_.resolve(e)}catch(e){return v_.reject(e)}},e.teardown=function(){try{var e=u(c,!1),t=e.db;t&&(t.lastAccessTime=0,p(e,!1))}catch(e){}}}))}return e.__ieDyn=1,e}(),vF=Nx,yF=function(e){function t(){var i=e.call(this)||this;return i.identifier="LocalStorage",i.priority=1009,i.version="3.2.9",oS(t,i,(function(e,t){var i,n,r,s;function a(){i=!1,n=!1,r=null,s=[]}function o(e,t){r||(r=new P_("LocalStorage")),r.scheduleEvent((function(e){return t(e)}),e)}function l(t){DC(e.core,(function(){return"LocalStorageChannel:_sendStoredEventsToNextPlugin"}),(function(){o("sendToNext",(function(i){return t.provider.getAllEvents().then((function(i){for(var n=0;n<i.length;n++)try{var r=i[n];(o_(r.iKey)||r.iKey)===t.tenantId&&e.processNext(r,t.coreRootCtx.createNew())}catch(e){}}))}))}),(function(){return{iKeyConfig:t}}))}function d(t,i){DC(e.core,(function(){return"LocalStorageChannel:_removeEvents"}),(function(){o("removeEvents",(function(e){var n=[];return cy(i,(function(e){(o_(e.iKey)||e.iKey)===t.tenantId&&n.push(e)})),n.length>0?t.provider.removeEvents(n).then((function(e){})).catch((function(e){})):v_.resolve()}))}),(function(){return{iKeyConfig:t,events:i}}))}function c(e){var t=new dF;return t.initialize(e)||(t=null),t}function h(e,t){var i=new SF(e);return i.initialize(t)||(i=null),i}a(),e.initialize=function(n,a,o,u){DC(a,(function(){return"LocalStorageChannel.initialize"}),(function(){i||(t.initialize(n,a,o),t.setInitialized(!1),i=!0,r=new P_("LocalStorage",a.logger)),function(t,i,n,r){var a=e.identifier,o=t.extensionConfig=t.extensionConfig||[],u=o[a]=o[a]||{};u.providers||(u.providers=[Mx.LocalStorage,Mx.IndexedDb]);var p=function(t,i,n,r){t&&(t.extensionConfig=t.extensionConfig||[]),!r&&i&&(r=i.getProcessTelContext().getNext());var s=null,a=e._getTelCtx().getNext();return a&&(s=a.getPlugin()),new fE(r,t,i,s)}(t,i,0,r),g={itemCtx:p,storageConfig:u,id:e.id},m=function(e){for(var t=e.storageConfig.providers,i=null,n=0;!i&&n<t.length&&n<5;)switch(t[n++]){case Mx.LocalStorage:i=h("localStorage",e);break;case Mx.SessionStorage:i=h("sessionStorage",e);break;case Mx.IndexedDb:i=c(e)}return i}(g);if(m){var f={iKey:t.instrumentationKey,tenantId:o_(t.instrumentationKey)||t.instrumentationKey,minPersistenceCacheLevel:1,coreRootCtx:p,providerContext:g,provider:m};vF(u.minPersistenceLevel||-1)&&(f.minPersistenceCacheLevel=u.minPersistenceLevel),s.push(f),i.addNotificationListener({eventsSent:function(e){d(f,e)},eventsDiscarded:function(e,t){d(f,e)}}),l(f)}}(n,a,0,u)}),(function(){return{coreConfig:n,core:a,extensions:o,pluginChain:u}}))},e.processTelemetry=function(t,r){var a,l,d=t;if(i&&!n){r=e._getTelCtx(r),p_(t,e.identifier);var c=null;cy(s,(function(e){e.iKey===t.iKey&&(c=e)}));var h=c?c.provider:null;if(d.sync||!h)return void e.processNext(d,r);d.id=d.id||YT(),Nx(d.persistence)||(d.persistence=1),a=c,!((l=d).sync||l.persistence<a.minPersistenceCacheLevel)&&o("processTelemetry",(function(e){return h.addEvent(d.id,d,r)}))}e.processNext(d,r)},e.pause=function(){n=!0},e.resume=function(){DC(e.core,(function(){return"LocalStorageChannel:resume"}),(function(){n=!1,cy(s,(function(e){e.provider&&l(e)}))}))},e._doTeardown=function(e,t){cy(s,(function(e){var t=e.provider;t&&t.teardown()})),a()},e.flush=function(e,t){void 0===e&&(e=!0)}})),i}return If(t,e),t.__ieDyn=1,t}(EE),CF=class{constructor(e,t,i,n,r,s,a){this.logger=e,this.configProvider=t,this.clientInfo=i,this.eventLatency=n,this.contextProvider=r,this.accountCollectorURL=s,this.envOverride=a,this.manager=new lI,this.managerConfig=this.createConfigForManager(),this.currentTransmitProfile=tt.REPORTING_PROFILE.RT_PROFILE,this.initManager(),this.uiVersion=this.getUiVersion(),this.configProvider.on("configUpdated",(()=>this.updateChannelConfig()))}createLogger(e){return new TF(e,this.manager,this.logger,this.configProvider,this.uiVersion,this.eventLatency,this.contextProvider,this.envOverride)}createConfigForManager(){const e={extensionConfig:{LocalStorage:{storageKey:"TsCalling"}},propertyConfiguration:{populateBrowserInfo:!0,populateOperatingSystemInfo:!0},channelConfiguration:{eventsLimitInMem:this.configProvider.config.eventsLimitInMem},endpointUrl:this.accountCollectorURL,enableCompoundKey:this.configProvider.config.enableCompoundKey};if(this.configProvider.config.useLocalStorageForOneDs){const t=new yF;e.channels=[[t]]}return e}getUiVersion(){const e=this.clientInfo.match(/^.*?\/(\d+\/)(.*?)\/.*$/);return e?e[1]+e[2]:this.clientInfo}updateChannelConfig(){this.configProvider.config.eventsLimitInMem!==this.managerConfig.channelConfiguration.eventsLimitInMem&&this.manager.getPostChannel().setEventQueueLimits(this.configProvider.config.eventsLimitInMem),this.setTransmitProfile()}initManager(){this.manager.create(this.managerConfig,[]),this.manager.getPostChannel()._notificationManager.addNotificationListener({eventsDiscarded:(e,t)=>this.logDiscardedEvents(e,t),eventsSent:e=>this.logSentEvents(e)}),this.setTransmitProfile()}logDiscardedEvents(e,t){let i="discarded events:";e.forEach((e=>i=`${i+e.name};`)),this.logger.info(`${i} reason:${t}`)}logSentEvents(e){let t=`sent events: ${e[0]?.data?.CorrelationId&&Ct("value",e[0].data.CorrelationId)}:`;e.forEach((e=>{t=`${t+e.name};`})),this.logger.info(`${t}`)}setTransmitProfile(){this.configProvider.config.transmitProfileTimings.length&&this.manager.getPostChannel()._loadTransmitProfiles({[this.configProvider.config.transmitProfileName]:this.configProvider.config.transmitProfileTimings}),this.configProvider.config.transmitProfileName!==this.currentTransmitProfile&&this.manager.getPostChannel()._setTransmitProfile(this.configProvider.config.transmitProfileName),this.currentTransmitProfile=this.configProvider.config.transmitProfileName}},TF=class{constructor(e,t,i,n,r,s,a,o){this.tenant=e,this.manager=t,this.logger=i,this.configProvider=n,this.uiVersion=r,this.eventLatency=s,this.contextProvider=a,this.envOverride=o,this.instanceConfig={extensions:[],extensionConfig:[]}}sendEvent(e){this.setEnvPropertiesToEveryEvent();const t=this.configProvider.config.telemetryTenants[this.tenant],i=this.manager.getInst(t)??this.manager.newInst(t,this.instanceConfig,[]),n=e.props,r={};switch(this.logger.info(`preparing event for delievery: ${e.props?.CorrelationId??""}/${e.eventName}`),this.tenant){case"signaling":n.SkypeId&&(r.user_id={value:n.SkypeId,kind:10},r.Skype_InitiatingUser_Username={value:n.SkypeId,kind:10},r.SkypeId={value:n.SkypeId,kind:10},delete n.SkypeId),this.uiVersion&&(r.ui_version={value:this.uiVersion,kind:0});break;case"media":case"tlePlayer":this.uiVersion&&(r.uiVersion={value:this.uiVersion,kind:0});break;case"realtimeMedia":this.uiVersion&&(r["AppInfo.Version"]={value:this.uiVersion,kind:0})}for(const e of Object.keys(n)){const t=n[e];r[e]={value:t?.value??t,kind:t?.piiKind??0}}const s={name:e.eventName,data:r,latency:this.eventLatency,persistence:ZE.Normal};this.configProvider.config.useSendBeaconSync&&(s.sync=2),this.logger.info(`about to send event ${JSON.stringify(s)}`),i.track(s)}setEnvPropertiesToEveryEvent(){const e=this.contextProvider?.();if(!mt(this.ctx,e)&&(this.ctx=e,this.ctx))if(this.envOverride){for(const e of Object.keys(this.envOverride||{}))if(this.ctx[e]){const t=this.ctx[e].piiKind??0,i=Ht(this.ctx[e].value);this.manager.getPropertyManager().setProperty(this.envOverride[e],{value:i,kind:t})}}else for(const e of Object.keys(this.ctx)){const t=this.ctx[e].piiKind??0,i=Ht(this.ctx[e].value);this.manager.getPropertyManager().setProperty(e,{value:i,kind:t})}}},EF=class extends Ye{constructor(e,t,i){super(),this.relayManagerProvider=e,this.configProvider=t,this.logger=i,this.currentInfo={},this.currentAreaContent={},this.isEnabled=!1,this.isEnabled=this.configProvider.config.enableE911,t.on("configUpdated",(()=>{const e=this.isEnabled;this.isEnabled=this.configProvider.config.enableE911,!this.isEnabled||e===this.isEnabled&&this.prober||(this.prober?.dispose(),this.prober=void 0,this.configProvider.config.probeE911OnInit&&this.probeForIP("config"))}))}get info(){return this.currentInfo}get areaContent(){return this.currentAreaContent}async getInfo(){return this.isEnabled&&!this.prober&&await this.probeForIP("publicGetInfo"),this.currentInfo}setClientInfo(e,t){if(this.isEnabled)switch(this.logger.info(`Client info for ${e} set`),e){case 3:this.mergeClientAreaInfo(JSON.parse(t));break;case 1:case 0:default:break;case 2:this.mergeClientNetworkInfo(JSON.parse(t))}}mergeClientAreaInfo(e){const t=JSON.stringify(this.currentAreaContent);this.currentAreaContent.geoCoordinates=e.geoCoordinates,pt(this.currentAreaContent),JSON.stringify(this.currentAreaContent)!==t&&this.raiseChanged()}mergeClientNetworkInfo(e){if(0===Object.keys(e).length){const e=Object.keys(this.currentInfo).length+Object.keys(this.currentAreaContent).length;return this.currentInfo={},this.currentAreaContent={},void(e>0&&this.raiseChanged())}const t=this.currentInfo.bssid!==e.bssid||this.currentInfo.bssidv6!==e.bssidv6||this.currentInfo.mac!==e.mac||this.currentInfo.macv6!==e.macv6||this.currentInfo.subnetLengthIpv4!==e.subnetLengthIpv4||this.currentInfo.subnetLengthIpv6!==e.subnetLengthIpv6,i=this.currentInfo.e911;this.currentInfo.bssid=e.bssid,this.currentInfo.bssidv6=e.bssidv6,this.currentInfo.e911=e.e911,this.currentInfo.mac=e.mac,this.currentInfo.macv6=e.macv6,this.currentInfo.subnetLengthIpv4=e.subnetLengthIpv4,this.currentInfo.subnetLengthIpv6=e.subnetLengthIpv6,pt(this.currentInfo),t?this.probeForIP("clientNetworkInfoChanged").then((e=>{e||this.raiseChanged()})):JSON.stringify(i)!==JSON.stringify(e.e911)&&this.raiseChanged()}async probeForIP(e){return this.probingPromise?(this.logger.info(`Probing already in progress, tried to start for: ${e}`),this.probingPromise):(this.probingPromise=this.probeForIPInternal(e),this.probingPromise.then((e=>(this.probingPromise=void 0,e))).catch((e=>(this.probingPromise=void 0,this.logger.error(`E911 probing failed: ${Ge(e)}`),!1))))}async probeForIPInternal(e){this.logger.info(`Probing for public IP address: ${e}`);const t=await this.ensureProber();if(await t.ensureOnline(),t.ipFromRelay){if((this.currentInfo.ipv4||this.currentInfo.ipv6)!==t.ipFromRelay)return delete this.currentInfo.ipv4,delete this.currentInfo.ipv6,this.currentInfo[Tg.test(t.ipFromRelay)?"ipv4":"ipv6"]=t.ipFromRelay,this.raiseChanged(),!0}else if(0!==Object.keys(this.currentInfo).length)return this.currentInfo={},this.raiseChanged(),!0;return!1}async ensureProber(){if(this.prober)return this.prober;const e=sO(await this.relayManagerProvider.getOrCreateRelayManager().queryRelaysAsync({relayType:"turn"}),this.configProvider.config);return this.prober=new nO(e,new WM(this.logger.createChild("Prober"),this.logger.createChild("ProberUnsafe"))),this.prober}},_F=class{constructor(){this.reports={}}watch(e){const t={time:Date.now(),duration:-1,version:1};return this.reports[e]&&(e=`${e}_last`),this.reports[e]=t,{end:e=>{e?t.error=e:t.duration=Date.now()-t.time}}}getReports(){return this.reports}},bF="trapTokenFetch",PF=class{constructor(e){this.updateRelaysPromise=null,this.trapTokens={},this.relaysOverride=[],this.timers=new _F,this.context=e,this.logger=e.logger.createChild("RM"),this.request=e.request,this.updateRelaysPromise||(this.updateRelaysPromise=this.updateRelaysFromConfigAsync(!0))}setRelayOverride(e){this.relaysOverride=e}setDefaultRelayConfig(e){this.config??(this.config=e)}async queryRelaysAsync(e={}){if(this.logger.info("query relays"),this.relaysOverride.length>0)return this.relaysOverride;this.updateRelaysPromise||(this.updateRelaysPromise=this.updateRelaysFromConfigAsync());const t=await this.updateRelaysPromise;return t?"turn"===e.relayType?t.Turn:e.isRemoteClientLync?t.Lync:t.Skype:[]}getAuthTokenStats(){}getStats(){return this.timers.getReports()}updateRelaysFromConfigAsync(e=!1){const t=this.getConfigAsync().then((()=>this.updateRelaysAsync())).then((e=>(this.updateRelaysPromise=t,e))).catch((t=>(this.updateRelaysPromise=null,e?this.logger.warn("failed to retrieve relays",Ge(t)):this.logger.error("failed to retrieve relays",Ge(t)),null)));return t}refreshRelaysFromConfig(){this.request.isOnline()?this.updateRelaysFromConfigAsync():(this.updateRelaysPromise=null,this.logger.warn("not refreshing relays due to no network connection"))}updateRelaysAsync(){const e=this.config.Service.tokenUrl;let t;const i=this.context.trapTokenCredentialsProvider?async()=>(t=this.timers.watch(bF),this.context.trapTokenCredentialsProvider()):async()=>{const i=this.timers.watch("skypeTokenFetch");let n="";try{n=await this.context.tokenProvider(),this.logger.info("fetching skypeToken")}catch(e){throw i.end(Ge(e)),e}return i.end(),t=this.timers.watch(bF),(await this.request.get(e,{headers:{"X-Skypetoken":n,"api-version":2}})).response};return this.logger.info("Fetch TRAP token "+(this.context.trapTokenCredentialsProvider?"with provider":"directly")),i().then((e=>{t.end();let i=0;const n=this.config.Token.earlyRefreshMinutes,r=this.config.Token.earlyRefreshPercentage;this.storeTrapTokens(e),i=Math.max(e.expires-60*n,e.expires*r/100),setTimeout(this.refreshRelaysFromConfig.bind(this),1e3*i);const s=this.config.Relay.Turn.realm?this.config.Relay.Turn.realm:'"rtcmedia"',a={expires:(o=this.getTrapToken(s)).expires,username:o.username,password:o.password,realm:o.realm};var o;const l={Skype:[{addresses:this.config.Relay.Skype.addresses,fqdns:this.config.Relay.Skype.fqdns,tcpPort:this.config.Relay.Skype.tcpPort,udpPort:this.config.Relay.Skype.udpPort,type:"msturn",...a}],Lync:[{addresses:this.config.Relay.Lync.addresses,fqdns:this.config.Relay.Lync.fqdns,tcpPort:this.config.Relay.Lync.tcpPort,udpPort:this.config.Relay.Lync.udpPort,type:"msturn",...a}],Turn:[{addresses:this.config.Relay.Turn.addresses,fqdns:this.config.Relay.Turn.fqdns,tcpPort:this.config.Relay.Turn.tcpPort,udpPort:this.config.Relay.Turn.udpPort,tlsPort:this.config.Relay.Turn.tlsPort,type:"turn",...a}]};return this.logger.info("relays from trap",l),l})).catch((e=>{throw t&&t.end(Ge(e)),e}))}storeTrapTokens(e){if(!e?.tokens)return void this.logger.error("failed to get tokens from trap response");const t={};e.tokens.forEach((i=>{t[i.realm]={expires:e.expires,username:i.username,password:i.password,realm:i.realm}})),this.trapTokens=t}getTrapToken(e){if("string"==typeof e){const t=e.replace(/^"|"$/g,""),i=`"${t}"`,n=this.trapTokens[i]||this.trapTokens[t];if(n)return n}throw new Error(`token for relay not found, realm: ${e}`)}async getConfigAsync(){this.logger.info("retrieving configuration");const e=this.timers.watch("configFetch");try{const t=await this.context.configProvider();e.end(),this.logger.info("retrieved configuration:",t),t&&(this.config=t),this.logger.info("applied configuration:",this.config)}catch(t){this.logger.warn("failed to retrieve configuration",Ge(t)),e.end(Ge(t))}}},IF=class{constructor(){this.reports={}}watch(e){const t={time:Date.now(),duration:-1,version:2};return this.reports[e]&&(e=`${e}_last`),this.reports[e]=t,{end:e=>{e?t.error=e:t.duration=Date.now()-t.time}}}getReports(){return this.reports}},AF=class{constructor(e){this.updateRelaysPromise=null,this.trapTokens={},this.relaysOverride=[],this.timers=new IF,this.context=e,this.authTokenFetcher=this.context.authTokenFetcher,this.logger=e.logger.createChild("RM2")}setRelayOverride(e){this.relaysOverride=e}setDefaultRelayConfig(e){this.config??(this.config=e),this.updateRelaysPromise||(this.updateRelaysPromise=this.updateRelaysFromConfigAsync(!0))}setClientSupportsGenericTokenApi(e){this.authTokenFetcher.supportsGenericTokenApi=e}async queryRelaysAsync(e={}){if(this.logger.info("query relays"),this.relaysOverride.length>0)return this.relaysOverride;this.updateRelaysPromise||(this.updateRelaysPromise=this.updateRelaysFromConfigAsync());const t=await this.updateRelaysPromise;return t?"turn"===e.relayType?t.Turn:e.isRemoteClientLync?t.Lync:t.Skype:[]}getStats(){return this.timers.getReports()}getAuthTokenStats(){return this.context.authTokenFetcher.getStats()}updateRelaysFromConfigAsync(e=!1){const t=this.getConfigAsync().then((()=>this.updateRelaysAsync())).then((e=>(this.updateRelaysPromise=t,e))).catch((t=>(this.updateRelaysPromise=null,e?this.logger.warn("failed to retrieve relays",Ge(t)):this.logger.error("failed to retrieve relays",Ge(t)),null)));return t}refreshRelaysFromConfig(){this.context.isOnline()?this.updateRelaysFromConfigAsync():(this.updateRelaysPromise=null,this.logger.warn("not refreshing relays due to no network connection"))}async updateRelaysAsync(){const e=this.context.configProvider?.useNewTokenApi?"aadTokenFetch":"skypeTokenFetch",t=this.timers.watch(e),i=Re();this.logger.info(`${i}[RM2] Fetch TRAP token`);try{const e=await this.context.authTokenFetcher.fetchTrapToken(i,this.config);t.end();let r=0;const s=this.config.Token.earlyRefreshMinutes,a=this.config.Token.earlyRefreshPercentage;this.storeTrapTokens(e),r=Math.max(e.expires-60*s,e.expires*a/100),setTimeout(this.refreshRelaysFromConfig.bind(this),1e3*r);const o=this.config.Relay.Turn.realm?this.config.Relay.Turn.realm:'"rtcmedia"',l={expires:(n=this.getTrapToken(o)).expires,username:n.username,password:n.password,realm:n.realm},d={addresses:this.config.Relay.Skype.addresses,fqdns:this.config.Relay.Skype.fqdns,tcpPort:this.config.Relay.Skype.tcpPort,udpPort:this.config.Relay.Skype.udpPort,type:"msturn",...l},c={addresses:this.config.Relay.Lync.addresses,fqdns:this.config.Relay.Lync.fqdns,tcpPort:this.config.Relay.Lync.tcpPort,udpPort:this.config.Relay.Lync.udpPort,type:"msturn",...l},h={Skype:[d],Lync:[c],Turn:[{addresses:this.config.Relay.Turn.addresses,fqdns:this.config.Relay.Turn.fqdns,tcpPort:this.config.Relay.Turn.tcpPort,udpPort:this.config.Relay.Turn.udpPort,tlsPort:this.config.Relay.Turn.tlsPort,type:"turn",...l}]};return this.logger.info("relays from trap",h),h}catch(e){throw this.logger.info(`Fetch TRAP token failed with error ${e}`),t&&t.end(Ge(e)),e}var n}storeTrapTokens(e){const t={};if(e?.tokens)e.tokens.forEach((i=>{t[i.realm]={expires:e.expires,username:i.username,password:i.password,realm:i.realm}}));else{if(!e.realm)return void this.logger.error("failed to get tokens from trap response");t[e.realm]=e}this.trapTokens=t}getTrapToken(e){if("string"==typeof e){const t=e.replace(/^"|"$/g,""),i=`"${t}"`,n=this.trapTokens[i]||this.trapTokens[t];if(n)return n}throw new Error(`token for relay not found, realm: ${e}`)}async getConfigAsync(){this.logger.info("retrieving configuration");const e=this.timers.watch("configFetch");try{const t=await this.context.relayConfigProvider();e.end(),this.logger.info("retrieved configuration:",t),t&&(this.config=t),this.logger.info("applied configuration:",this.config)}catch(t){this.logger.warn("failed to retrieve configuration",Ge(t)),e.end(Ge(t))}}},RF=class{constructor(e,t,i,n,r){this.signalingAgentProvider=t,this.request=i,this.tokenProviders=n,this.configProvider=r,this.errors=[],this.clientSupportsGenericTokenAPI=!1,this.logger=e.createChild("AuthTokenFetcher")}set supportsGenericTokenApi(e){this.clientSupportsGenericTokenAPI=e}buildHeaders(e,t){const i={"api-version":2};switch(this.configProvider?.useTokenMigrationHeader&&(i["X-MS-Migration"]="True"),e){case 4:case 8:return i.Authorization=`Bearer ${t}`,i;case 1:return i["X-Skypetoken"]=t,i;default:throw new Error(`TokenType ${e} is not supported`)}}serviceSupportedTokenTypes(e){let t=null;if(void 0===e)t=this.clientSupportedTokenTypes();else{const i=e?.toLowerCase();t=this.constructTokenType(i)}return null===t&&this.configProvider?.useSkypeTokenWhenNoAuthenticateHeader&&(t|=1),t}extractWwwauthenticateHeaders(e){let t={};if(e){const i=$t(e,"www-authenticate");i&&(t={authenticationHeaders:[i]})}return t}convertStringToTokenType(e){switch(e){case"cae":return 8;case"aad":return 4;case"skype":return 1;default:return this.logger.info("[authTokenFetcher][convertStringToTokenType]unexpected: unrecognized token type ${tokenType}"),null}}getTokenTypeFromHeaders(e,t){if(!this.clientSupportsGenericTokenAPI)return 1;let i=null;const n=t?.authenticationHeaders;if(!n&&e)this.configProvider?.useSkypeTokenWehnNoAuthHeader?(this.logger.info("[authTokenFetcher][getAuthHeadersTokenTypes] no www-authenticate header received, fallback to skype token"),i=1):(this.logger.info("[authTokenFetcher][getAuthHeadersTokenTypes] Service has not provided www-authenticate headers. use client supported tokens"),i=this.clientSupportedTokenTypes());else if(n||e){if(n&&e)for(const e of n){const t=jt(e);if(this.configProvider?.supportMissingTokenTypesInResponse&&0===t.length)this.logger.info("[authTokenFetcher][getAuthHeadersTokenTypes] Service has www-authenticate header, but no token types. Use client supported tokens"),i=this.clientSupportedTokenTypes();else for(const e of t){const t=this.convertStringToTokenType(e.toLowerCase());this.configProvider?.clientSupportsCaeToken&&8===t&&(i|=8),this.configProvider?.clientSupportsAadToken&&4===t&&(i|=4),this.configProvider?.clientSupportsSkypeToken&&1===t&&(i|=1)}}}else this.logger.info("[authTokenFetcher][getTokenTypeFromHeaders] retrying to fetch token woth client supported tokens"),i=this.clientSupportedTokenTypes();return i}constructTokenType(e){let t=null;return e.includes("aad")&&this.configProvider?.clientSupportsAadToken&&(t|=4),e.includes("cae")&&this.configProvider?.clientSupportsCaeToken&&(t|=8),e.includes("skype")&&this.configProvider?.clientSupportsSkypeToken&&(t|=1),t}getTokenMetadataForTrapService(e,t,i){const n={verb:"POST",path:e},r=JSON.stringify(n);let s=null;const a=this.extractWwwauthenticateHeaders(i),o=!!a?.authenticationHeaders;return s=i?this.getTokenTypeFromHeaders(o,a):this.serviceSupportedTokenTypes(t),this.logger.info(`[authTokenFetcher][getTokenMetadata] return token type=${s}, factoJson=${r}`),{tokenType:s,factorsJson:r,requestMetadataJson:a,isUnauthorized:o}}clientSupportedTokenTypes(){let e=null;return this.configProvider?.clientSupportsAadToken&&(e|=4),this.configProvider?.clientSupportsCaeToken&&(e|=8),this.configProvider?.clientSupportsSkypeToken&&(e|=1),e}async handleAuthTokenFailure(e,t,i,n){this.logger.info("[authTokenFetcher][handleAuthTokenFailure] failed to fetch token, retrying");try{const r=this.getTokenMetadataForTrapService(t,void 0,i);return this.logger.info(`[authTokenFetcher][handleAuthTokenFailure] token request options=${r}`),r.invalidToken=n,await this.signalingAgentProvider.getSignalingAgent().authTokenManager.getToken(e,!1,r)}catch(e){this.errors.push(Ge(e)),this.logger.error(`[authTokenFetcher] failed to fetch token trough new api with error: ${Ge(e)}, quiting`)}}getRequestToken(e){const t=$t(e,"X-Skypetoken");if(t)return t;const i=$t(e,"Authorization");if(i){const e=i.split(" ");if(2===e.length)return e[1]}}async fetchTrapCredentials(e,t,i){const n=this.buildHeaders(t,e),r=await this.request.get(i,{headers:n});return r?.response}async fetchTrapTokenWithNewTokenApi(e,t,i){let n;this.logger.info(`${i}[authTokenFetcher] fetching token through fetchTrapTokenWithNewTokenApi`);const r=this.getTokenMetadataForTrapService(e,t);try{return n=await this.signalingAgentProvider.getSignalingAgent().authTokenManager.getToken(i,!1,r),this.tokenTypeFetched=this.signalingAgentProvider.getSignalingAgent().authTokenManager.getLastTokenType(i),await this.fetchTrapCredentials(n,this.tokenTypeFetched,e)}catch(t){this.errors.push(Ge(t)),this.logger.error(`${i}[authTokenFetcher] fetchTrapTokenWithNewTokenApi failed with ${Ge(t)}, retrying...`);const r=t?.response?.headers;if(r){const t=this.getRequestToken(r);return n=await this.handleAuthTokenFailure(i,e,r,t),this.tokenTypeFetched=this.signalingAgentProvider.getSignalingAgent().authTokenManager.getLastTokenType(i),await this.fetchTrapCredentials(n,this.tokenTypeFetched,e)}throw t}}async fetchTrapTokenThroughProvider(){return this.logger.info("[authTokenFetcher][authTokenFetcher] fetching token through fetchTrapTokenThroughProvider"),this.tokenProviders.trapTokenCredentialsProvider()}async fetchTrapTokensWithLegacyTokenFetcher(e,t){this.logger.info(`${t}[authTokenFetcher][authTokenFetcher] fetching token through fetchTrapTokensWithLegacyTokenFetcher`);try{this.tokenTypeFetched=1;const t=await this.tokenProviders.skypeTokenProvider();return(await this.request.get(e,{headers:{"X-Skypetoken":t,"api-version":2}})).response}catch(e){throw this.errors.push(Ge(e)),this.logger.error(`${t}[authTokenFetcher] fetchTrapTokensWithLegacyTokenFetcher failed with ${Ge(e)}`),e}}getStats(){return{tokenType:this.tokenTypeFetched,errors:this.errors}}async fetchTrapToken(e,t){let i;this.logger.info(`${e}[AuthTokenFetcher] Start fetching token`);const n=t.Service.tokenUrl,r=t.Service.supportedTokenTypes;return i=this.configProvider?.useNewTokenApi?this.fetchTrapTokenWithNewTokenApi(n,r,e):this.tokenProviders.trapTokenCredentialsProvider?this.fetchTrapTokenThroughProvider():this.fetchTrapTokensWithLegacyTokenFetcher(n,e),i}},wF=class{constructor(e,t,i){this.config=e,this.signalingAgentProvider=t,this.logger=i}getOrCreateRelayManager(){return this.relayManager||this.createRelayManager()}setConfigProvider(e){this.configProvider=e}createRelayManager(){return this.relayManager??(this.relayManager=this.buildRelayManager(this.config.httpRequestDispatcher,this.config.tokenProvider,this.config.configProvider,this.config.appStateProvider,this.config.trapTokenCredentialsProvider,this.configProvider))}buildRelayManager(e,t,i,n,r,s){const a=e||new We(this.logger),o={get:(e,t)=>a.getAsync(e,a.getRequestOptions("GET",t?.headers,null,t?.timeout)),isOnline:n.isOnline};if(this.configProvider.config.useNewTokenApi){const e=new RF(this.logger,this.signalingAgentProvider,o,{skypeTokenProvider:t,trapTokenCredentialsProvider:r},s?.config);return new AF({logger:this.logger,relayConfigProvider:()=>i.getRelayConfig(),isOnline:n.isOnline,authTokenFetcher:e,configProvider:this.configProvider?.config})}return l={logger:this.logger,tokenProvider:t,trapTokenCredentialsProvider:r,configProvider:()=>i.getRelayConfig(),request:{get:(e,t)=>a.getAsync(e,a.getRequestOptions("GET",t?.headers,null,t?.timeout)),isOnline:n.isOnline}},new PF(l);var l}},MF=class extends Error{constructor(e,t=1){super(e),this.callSupport=t}};function OF(e){let t={};return e.telemetryLoggers?t=e.telemetryLoggers:e.telemetryService?.getGenericTelemetryLogger&&e.telemetryTenants?Object.keys(e.telemetryTenants).forEach((i=>t[i]=e.telemetryService.getGenericTelemetryLogger(e.telemetryTenants[i]))):e.telemetryService&&(e.telemetryService.sendEvents||e.telemetryService.getCallingAdapter)&&(e.telemetryService.sendEvents&&(t.media={sendEvent(t){t.eventName&&(t.eventName=t.eventName.replace(/^(mdsc_)/,"")),e.telemetryService.sendEvents([t])}},t.tlePlayer={sendEvent(t){t.eventName&&(t.eventName=t.eventName.replace(/^(mdsc_)/,"")),e.telemetryService.sendEvents([t])}}),e.telemetryService?.sendRealTimeEvents&&(t.realtimeMedia={sendEvent(t){t.eventName&&(t.eventName=t.eventName.replace(/^(mdsc_)/,"")),e.telemetryService.sendRealTimeEvents([t])}}),e.telemetryService.getCallingAdapter&&(t.signaling={sendEvent(t){e.telemetryService.getCallingAdapter().sendEvent(t.eventName,t.props)}})),t}var DF=class e extends Ye{constructor(e,t){super(),this._config=e,this._ecsProvider=t,this.callRegistries=[],this._logger=new ti(this._config.logger).createChild("PluginlessStack"),this._platformManager=new _x,this._waitForAccountConfiguration=new Mu,this.platformCallConstraintsProvider=new ei(this._logger.createChild("PlatformConstraintsProvider"))}async initializeMediaAgent(e){let t,i=null;if(!this._mediaAgentProvider)throw new MF("PluginlessStack initialize MediaAgent error, Media Stack not initialized",i);try{this._relayManagerProvider=new wF(e,this._signalingAgentProvider,this._logger),t=await this._mediaAgentProvider.buildAgent(this._config.platformType,this._relayManagerProvider,this._midCallTelemetry)}catch(e){i=e.some((e=>"incompatible_version"===e.reason))?2:1}if(!this._config.usePlatformSupportApi&&!this._config.callSettings?.useLwjForAllCalls){if(i)throw new MF("PluginlessStack initialization failed",i);{const e=(new _x).getPlatformSupportLevel(!0);if(1!==e&&2!==e)throw new MF("PluginlessStack initialization failed",1)}}t?(this._screenSharingManager=new Ix(t.getScreenSharingManager()),this._waitForAccountConfigurationTimeout=window.setTimeout((()=>{this._waitForAccountConfiguration.resolve(void 0),this._waitForAccountConfigurationTimeout=void 0}),3e4),this._oneDsTelemetryLoggers=function(e,t,i,n,r,s){const a={signaling:[],media:[],tlePlayer:[],realtimeMedia:[]};let o={signaling:{sendEvent:e=>a.signaling.push(e)},media:{sendEvent:e=>a.media.push(e)},tlePlayer:{sendEvent:e=>a.tlePlayer.push(e)},realtimeMedia:{sendEvent:e=>a.realtimeMedia.push(e)}};return t.getConfigReceivedOrTimeout().then((async()=>{let l=(await r)?.serviceUrls?.OneDsCollectorUrl;if(l=l??t.config.collectorUrl,l){const r=new CF(e,t,i,t.config.eventLatency,n,l);o.signaling=r.createLogger("signaling"),o.media=r.createLogger("media"),o.tlePlayer=r.createLogger("tlePlayer");const s=new CF(e,t,i,t.config.eventLatencyRealTime,n,l,{"UserInfo.Ring":"Ring","UserInfo.TenantId":"TenantId","AppInfo.ClientType":"client_type","UserInfo.ETag":"AppInfo.EcsEtag",appversion:"First/Second Client VDI Desktop Version",vdiMode:"First/Second Client VDI Mode",vdiConnectedState:"First/Second Client VDI Connected State",vdiShimVersion:"First/Second Client VDI Shim Version",vdiProvider:"First/Second Client VDI Provider Version"});o.realtimeMedia=s.createLogger("realtimeMedia")}else o=OF(s);for(const[e,t]of Object.entries(a))for(const i of t)o[e].sendEvent(i)})),o}(this._logger.createChild("OneDsLogger"),t.getConfigProvider(),e.clientInformation,this._config.telemetryContextProvider,this._waitForAccountConfiguration.promise,this._config),t.getConfigProvider().config.useOneDsLogger&&(this.signalingLoggerAdapter={sendEvent:(e,t)=>{const i={eventName:e,props:t};this._oneDsTelemetryLoggers.signaling.sendEvent(i)}}),this._mediaAgent=t,this._e911=new EF(this._relayManagerProvider,this._mediaAgent.getConfigProvider(),this._logger.createChild("E911")),this._e911?.changed((()=>{this.event("e911InfoChanged").raise(this._e911?.info,this._e911?.areaContent)}))):this._deviceManager=new rn}async initializeSignalingAgentProvider(e){this._trouterService=e.trouterService,this._signalingAgentProvider=kx.build(e.signalingAgentConfig,this._ecsProvider,this._config.logger,this.signalingLoggerAdapter)}static async build(t,i,n){try{const r=new e({detectH264Support:t.mediaAgentFactoryConfig.detectH264Support,domOverrides:t.mediaAgentFactoryConfig.domOverrides,mediaSettings:t.mediaAgentFactoryConfig.settings,logger:t.logger,telemetryLoggers:t.telemetryLoggers,telemetryService:t.telemetryService,telemetryTenants:t.telemetryTenants,telemetryContextProvider:t.telemetryContextProvider,platformType:t.platformType,callSettings:t.callSettings,usePlatformSupportApi:t.usePlatformSupportApi,clientInformation:t.signalingAgentConfig.clientInformation},i);return r.initializeMediaProvider({detectH264Support:t.mediaAgentFactoryConfig.detectH264Support,domOverrides:t.mediaAgentFactoryConfig.domOverrides,mediaSettings:t.mediaAgentFactoryConfig.settings,logger:t.mediaAgentFactoryConfig.logger,safeLogger:t.mediaAgentFactoryConfig.safeLogger,webcvProvider:t.mediaAgentFactoryConfig.webcvProvider,wasmdnsProvider:t.mediaAgentFactoryConfig.wasmdnsProvider,wasmaecProvider:t.mediaAgentFactoryConfig.wasmaecProvider,wasmVqeProvider:t.mediaAgentFactoryConfig.wasmVqeProvider,createWasmWorkerCbs:t.mediaAgentFactoryConfig.createWasmWorkerCbs,encodedStreamsWorkerProvider:t.mediaAgentFactoryConfig.encodedStreamsWorkerProvider,clientInformation:t.signalingAgentConfig.clientInformation}),r.setMidCallTelemetry(n),r.initializeSignalingAgentProvider({signalingAgentConfig:t.signalingAgentConfig,trouterService:t.trouterService}),await r.initializeMediaAgent({httpRequestDispatcher:t.mediaAgentFactoryConfig.httpRequestDispatcher,tokenProvider:t.mediaAgentFactoryConfig.tokenProvider,configProvider:t.mediaAgentFactoryConfig.configProvider,appStateProvider:t.mediaAgentFactoryConfig.appStateProvider,clientInformation:t.signalingAgentConfig.clientInformation,trapTokenCredentialsProvider:t.mediaAgentFactoryConfig.trapTokenCredentialsProvider,relayManager:t.mediaAgentFactoryConfig.relayManager}),r}catch(e){throw e instanceof MF?e:new MF(`${e}`)}}static async buildBaseStack(t,i){const n=new e(t,i);return n.initializeMediaProvider({detectH264Support:t.detectH264Support,domOverrides:t.domOverrides,mediaSettings:t.mediaSettings,logger:t.logger,safeLogger:t.safeLogger,webcvProvider:t.webcvProvider,wasmdnsProvider:t.wasmdnsProvider,wasmaecProvider:t.wasmaecProvider,wasmVqeProvider:t.wasmVqeProvider,createWasmWorkerCbs:t.createWasmWorkerCbs,encodedStreamsWorkerProvider:t.encodedStreamsWorkerProvider,clientInformation:t.clientInformation}),n}async init(){}async dispose(e=Re()){const t=this._logger.createFnLogger("dispose",e);t.info("Dispose"),this._ecsProvider.dispose(),this._e911?.dispose();const i=e=>{t.warn("Failed:",e)},n=this.callRegistries.map((t=>t.dispose(e).catch(i)));await Promise.all(n),await this._mediaAgent.dispose(e).catch(i),t.info("media agent is disposed"),this.callRegistries=[],t.info("call registries are disposed"),this._screenSharingManager&&(this._screenSharingManager.dispose(e),this._screenSharingManager=void 0,t.info("screensharing manager is disposed")),this._deviceManager=void 0,super.dispose()}getCallRegistry(){return this._logger.info("returning default callRegistry"),this.callRegistries[0]?this.callRegistries[0]:this._createCallRegistry()}async createCallRegistry(e,t=Re()){const i=e?Ne(e.id):void 0,n=this._logger.createFnLogger(`createCallRegistry[identity=${i}]`,t),r=this.callRegistries.find((t=>t.identity===e.id));return r&&!r.isDisposing?(n.info(`callRegistry already exists for ${Ne(e.id)}`),r):(r?.isDisposing&&await r.disposePromise,this._createCallRegistry(e))}createCompositor(e){throw new Error("Method not implemented.")}_createCallRegistry(e){if(!this._trouterService)throw new MF("Unable to create call registry, trouter service undefined");if(!this._mediaAgent)throw new MF("Unable to create call registry, media agent undefined");if(!this._signalingAgentProvider)throw new MF("Unable to create call registry, signaling agent undefined");const t=new Pm(this._trouterService,this._signalingAgentProvider,this._mediaAgent,this._logger,OF(this._config),this._ecsProvider,e,this._oneDsTelemetryLoggers);return t.on("disposed",(()=>{this.callRegistries.splice(this.callRegistries.indexOf(t),1)})),t.on("accountConfigurationReceived",(e=>{0===this._waitForAccountConfiguration.state&&(this._waitForAccountConfiguration.resolve(e),window.clearTimeout(this._waitForAccountConfigurationTimeout)),this._relayManagerProvider.getOrCreateRelayManager().setDefaultRelayConfig(e.relayConfig),this._relayManagerProvider.getOrCreateRelayManager().setClientSupportsGenericTokenApi(e.clientSupportsGenericTokenAPI)})),t.on("locationInfoSet",((e,t)=>{this._e911?.setClientInfo(e,t)})),this._relayManagerProvider.getOrCreateRelayManager(),this.callRegistries.push(t),t}initializeMediaProvider(e){const t=(0,qe.assign)({},e);this._mediaAgentProvider=new Tx(t,this._ecsProvider,this.platformCallConstraintsProvider),this._deviceManager=new wm(this._mediaAgentProvider.getDeviceManager())}setMidCallTelemetry(e){this._midCallTelemetry=e}getDeviceManager(){return this._deviceManager}async getDeviceManagerAsync(){return this._deviceManager}createDeviceManager(e){return this._deviceManager}getScreenSharingManager(){return this._screenSharingManager}getSetup(){}getEcsProvider(){return this._ecsProvider}async getEcsProviderAsync(){return this._ecsProvider}getCallFeedback(){return null}getAiMdp(){return null}fireIntent(e,t){}getVersion(){return{build:"2024.13.01.19",ovb:"5d60bfcfbf65862f074bd44f3beb1676fd6f338a"}}getMediaStatus(){return null}getVideoCapabilityLimits(){return null}async setMediaConfig(e){this._mediaAgent.setMediaConfig(e)}async getE911Info(){return this._e911?.getInfo()}setPlatformCallConstraints(e){this.platformCallConstraintsProvider.setConstraints(e)}getPlatformSupportLevel(){return this._platformManager.getPlatformSupportLevel(!!this._mediaAgent)}getLiveStreamClient(){return new nn(this._ecsProvider.createEcsConfiguration(),this._logger.createChild("LiveStreamClient"),(()=>OF(this._config).tlePlayer))}createVoipCallCoordinator(){}async setLogFileName(e,t,i){throw new Error("not supported")}aggregateDiagnosticLogs(e){return Promise.reject("not supported")}extendBrbFeedback(e,t){return Promise.reject("not supported")}async addOcclusion(e,t,i,n,r,s){}async removeOcclusion(e,t,i,n){}async flushLogs(){throw new Error("not supported")}async getStageCapability(){throw new Error("not supported")}},kF={build(e){const t=e.telemetryContextProvider?.(),i=new bx(t),n=new Fm;return function(e,t,i){if(!Mm.RootToolsManager.isDelegateSet()){const n=new Um(e.telemetryService,t);if(Mm.RootToolsManager.setDelegate(n),n.on("onMidCallTelemetry",(e=>i.send(e))),e.logger){const t=new Dm(e.logger);Mm.LogFactory.instance().addAppender(t)}}e.logger=new Oe("JS.TsCalling.Pluginless",!0),e.mediaAgentFactoryConfig.logger=new Oe("JS.TsCalling.MediaAgentUnsafe",!1),e.mediaAgentFactoryConfig.safeLogger=new Oe("JS.TsCalling.MediaAgent",!0),e.signalingAgentConfig.logger=new Oe("JS.TsCalling.SignalingAgent",!0)}(e,i,n),DF.build(e,i,n)},buildBaseStack(e){const t=e.telemetryContextProvider?.(),i=new bx(t);return DF.buildBaseStack(e,i)},getVersion:()=>({build:"2024.13.01.19",ovb:"5d60bfcfbf65862f074bd44f3beb1676fd6f338a"})};return"object"==typeof h.exports&&"object"==typeof c&&(h.exports=((e,t,i,n)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let r of Object.getOwnPropertyNames(t))Object.prototype.hasOwnProperty.call(e,r)||r===i||Object.defineProperty(e,r,{get:()=>t[r],enumerable:!(n=Object.getOwnPropertyDescriptor(t,r))||n.enumerable});return e})(h.exports,c)),h.exports},e.exports=a(i(174958),i(496486))},287633:function(module,__unused_webpack_exports,__webpack_require__){var process=__webpack_require__(734155),Buffer=__webpack_require__(348764).Buffer,Module;Module||(Module=(void 0!==Module?Module:null)||{});var moduleOverrides={};for(var key in Module)Module.hasOwnProperty(key)&&(moduleOverrides[key]=Module[key]);var ENVIRONMENT_IS_NODE="object"==typeof process&&!0,ENVIRONMENT_IS_WEB="object"==typeof window,ENVIRONMENT_IS_WORKER="function"==typeof importScripts,ENVIRONMENT_IS_SHELL=!ENVIRONMENT_IS_WEB&&!ENVIRONMENT_IS_NODE&&!ENVIRONMENT_IS_WORKER;if(ENVIRONMENT_IS_SHELL)Module.print||(Module.print=print),"undefined"!=typeof printErr&&(Module.printErr=printErr),"undefined"!=typeof read?Module.read=read:Module.read=function(){throw"no read() available (jsc?)"},Module.readBinary=function(e){return"function"==typeof readbuffer?new Uint8Array(readbuffer(e)):read(e,"binary")},"undefined"!=typeof scriptArgs?Module.arguments=scriptArgs:void 0!==arguments&&(Module.arguments=arguments),this.Module=Module;else{if(!ENVIRONMENT_IS_WEB&&!ENVIRONMENT_IS_WORKER)throw"Unknown runtime environment. Where are we?";if(Module.read=function(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.send(null),t.responseText},void 0!==arguments&&(Module.arguments=arguments),"undefined"!=typeof console)Module.print||(Module.print=function(e){console.log(e)}),Module.printErr||(Module.printErr=function(e){console.log(e)});else{var TRY_USE_DUMP=!1;Module.print||(Module.print=TRY_USE_DUMP&&"undefined"!=typeof dump?function(e){dump(e)}:function(e){})}ENVIRONMENT_IS_WEB?window.Module=Module:Module.load=importScripts}function globalEval(e){eval.call(null,e)}for(var key in!Module.load&&Module.read&&(Module.load=function(e){globalEval(Module.read(e))}),Module.print||(Module.print=function(){}),Module.printErr||(Module.printErr=Module.print),Module.arguments||(Module.arguments=[]),Module.thisProgram||(Module.thisProgram="./this.program"),Module.print=Module.print,Module.printErr=Module.printErr,Module.preRun=[],Module.postRun=[],moduleOverrides)moduleOverrides.hasOwnProperty(key)&&(Module[key]=moduleOverrides[key]);var Runtime={setTempRet0:function(e){tempRet0=e},getTempRet0:function(){return tempRet0},stackSave:function(){return STACKTOP},stackRestore:function(e){STACKTOP=e},getNativeTypeSize:function(e){switch(e){case"i1":case"i8":return 1;case"i16":return 2;case"i32":case"float":return 4;case"i64":case"double":return 8;default:return"*"===e[e.length-1]?Runtime.QUANTUM_SIZE:"i"===e[0]?parseInt(e.substr(1))/8:0}},getNativeFieldSize:function(e){return Math.max(Runtime.getNativeTypeSize(e),Runtime.QUANTUM_SIZE)},STACK_ALIGN:16,getAlignSize:function(e,t,i){return i||"i64"!=e&&"double"!=e?e?Math.min(t||(e?Runtime.getNativeFieldSize(e):0),Runtime.QUANTUM_SIZE):Math.min(t,8):8},dynCall:function(e,t,i){return i&&i.length?(i.splice||(i=Array.prototype.slice.call(i)),i.splice(0,0,t),Module["dynCall_"+e].apply(null,i)):Module["dynCall_"+e].call(null,t)},functionPointers:[],addFunction:function(e){for(var t=0;t<Runtime.functionPointers.length;t++)if(!Runtime.functionPointers[t])return Runtime.functionPointers[t]=e,2*(1+t);throw"Finished up all reserved function pointers. Use a higher value for RESERVED_FUNCTION_POINTERS."},removeFunction:function(e){Runtime.functionPointers[(e-2)/2]=null},getAsmConst:function(code,numArgs){Runtime.asmConstCache||(Runtime.asmConstCache={});var func=Runtime.asmConstCache[code];if(func)return func;for(var args=[],i=0;i<numArgs;i++)args.push(String.fromCharCode(36)+i);var source=Pointer_stringify(code);'"'===source[0]&&(source.indexOf('"',1)===source.length-1?source=source.substr(1,source.length-2):abort("invalid EM_ASM input |"+source+"|. Please use EM_ASM(..code..) (no quotes) or EM_ASM({ ..code($0).. }, input) (to input values)"));try{var evalled=eval("(function(Module, FS) { return function("+args.join(",")+"){ "+source+" } })")(Module,void 0!==FS?FS:null)}catch(e){throw Module.printErr("error in executing inline EM_ASM code: "+e+" on: \n\n"+source+"\n\nwith args |"+args+"| (make sure to use the right one out of EM_ASM, EM_ASM_ARGS, etc.)"),e}return Runtime.asmConstCache[code]=evalled},warnOnce:function(e){Runtime.warnOnce.shown||(Runtime.warnOnce.shown={}),Runtime.warnOnce.shown[e]||(Runtime.warnOnce.shown[e]=1,Module.printErr(e))},funcWrappers:{},getFuncWrapper:function(e,t){Runtime.funcWrappers[t]||(Runtime.funcWrappers[t]={});var i=Runtime.funcWrappers[t];return i[e]||(i[e]=function(){return Runtime.dynCall(t,e,arguments)}),i[e]},UTF8Processor:function(){var e=[],t=0;this.processCChar=function(i){if(i&=255,0==e.length)return 0==(128&i)?String.fromCharCode(i):(e.push(i),t=192==(224&i)?1:224==(240&i)?2:3,"");if(t&&(e.push(i),--t>0))return"";var n,r=e[0],s=e[1],a=e[2],o=e[3];if(2==e.length)n=String.fromCharCode((31&r)<<6|63&s);else if(3==e.length)n=String.fromCharCode((15&r)<<12|(63&s)<<6|63&a);else{var l=(7&r)<<18|(63&s)<<12|(63&a)<<6|63&o;n=String.fromCharCode(55296+((l-65536)/1024|0),(l-65536)%1024+56320)}return e.length=0,n},this.processJSString=function(e){e=unescape(encodeURIComponent(e));for(var t=[],i=0;i<e.length;i++)t.push(e.charCodeAt(i));return t}},getCompilerSetting:function(e){throw"You must build with -s RETAIN_COMPILER_SETTINGS=1 for Runtime.getCompilerSetting or emscripten_get_compiler_setting to work"},stackAlloc:function(e){var t=STACKTOP;return STACKTOP=(STACKTOP=STACKTOP+e|0)+15&-16,t},staticAlloc:function(e){var t=STATICTOP;return STATICTOP=(STATICTOP=STATICTOP+e|0)+15&-16,t},dynamicAlloc:function(e){var t=DYNAMICTOP;return(DYNAMICTOP=(DYNAMICTOP=DYNAMICTOP+e|0)+15&-16)>=TOTAL_MEMORY&&enlargeMemory(),t},alignMemory:function(e,t){return e=Math.ceil(e/(t||16))*(t||16)},makeBigInt:function(e,t,i){return i?+(e>>>0)+4294967296*+(t>>>0):+(e>>>0)+4294967296*+(0|t)},GLOBAL_BASE:8,QUANTUM_SIZE:4,__dummy__:0};Module.Runtime=Runtime;var __THREW__=0,ABORT=!1,EXITSTATUS=0,undef=0,tempValue,tempInt,tempBigInt,tempInt2,tempBigInt2,tempPair,tempBigIntI,tempBigIntR,tempBigIntS,tempBigIntP,tempBigIntD,tempDouble,tempFloat,tempI64,tempI64b,tempRet0,tempRet1,tempRet2,tempRet3,tempRet4,tempRet5,tempRet6,tempRet7,tempRet8,tempRet9;function assert(e,t){e||abort("Assertion failed: "+t)}var globalScope=this,cwrap,ccall;function getCFunc(ident){var func=Module["_"+ident];if(!func)try{func=eval("_"+ident)}catch(e){}return func}function setValue(e,t,i,n){switch("*"===(i=i||"i8").charAt(i.length-1)&&(i="i32"),i){case"i1":case"i8":HEAP8[e>>0]=t;break;case"i16":HEAP16[e>>1]=t;break;case"i32":HEAP32[e>>2]=t;break;case"i64":tempI64=[t>>>0,(tempDouble=t,+Math_abs(tempDouble)>=1?tempDouble>0?(0|Math_min(+Math_floor(tempDouble/4294967296),4294967295))>>>0:~~+Math_ceil((tempDouble-+(~~tempDouble>>>0))/4294967296)>>>0:0)],HEAP32[e>>2]=tempI64[0],HEAP32[e+4>>2]=tempI64[1];break;case"float":HEAPF32[e>>2]=t;break;case"double":HEAPF64[e>>3]=t;break;default:abort("invalid type for setValue: "+i)}}function getValue(e,t,i){switch("*"===(t=t||"i8").charAt(t.length-1)&&(t="i32"),t){case"i1":case"i8":return HEAP8[e>>0];case"i16":return HEAP16[e>>1];case"i32":case"i64":return HEAP32[e>>2];case"float":return HEAPF32[e>>2];case"double":return HEAPF64[e>>3];default:abort("invalid type for setValue: "+t)}return null}(function(){var JSfuncs={stackSave:function(){Runtime.stackSave()},stackRestore:function(){Runtime.stackRestore()},arrayToC:function(e){var t=Runtime.stackAlloc(e.length);return writeArrayToMemory(e,t),t},stringToC:function(e){var t=0;return null!=e&&0!==e&&writeStringToMemory(e,t=Runtime.stackAlloc(1+(e.length<<2))),t}},toC={string:JSfuncs.stringToC,array:JSfuncs.arrayToC};ccall=function(e,t,i,n){var r=getCFunc(e),s=[],a=0;if(n)for(var o=0;o<n.length;o++){var l=toC[i[o]];l?(0===a&&(a=Runtime.stackSave()),s[o]=l(n[o])):s[o]=n[o]}var d=r.apply(null,s);return"string"===t&&(d=Pointer_stringify(d)),0!==a&&Runtime.stackRestore(a),d};var sourceRegex=/^function\s*\(([^)]*)\)\s*{\s*([^*]*?)[\s;]*(?:return\s*(.*?)[;\s]*)?}$/;function parseJSFunc(e){var t=e.toString().match(sourceRegex).slice(1);return{arguments:t[0],body:t[1],returnValue:t[2]}}var JSsource={};for(var fun in JSfuncs)JSfuncs.hasOwnProperty(fun)&&(JSsource[fun]=parseJSFunc(JSfuncs[fun]));cwrap=function cwrap(ident,returnType,argTypes){argTypes=argTypes||[];var cfunc=getCFunc(ident),numericArgs=argTypes.every((function(e){return"number"===e})),numericRet="string"!==returnType;if(numericRet&&numericArgs)return cfunc;var argNames=argTypes.map((function(e,t){return"$"+t})),funcstr="(function("+argNames.join(",")+") {",nargs=argTypes.length;if(!numericArgs){funcstr+="var stack = "+JSsource.stackSave.body+";";for(var i=0;i<nargs;i++){var arg=argNames[i],type=argTypes[i];if("number"!==type){var convertCode=JSsource[type+"ToC"];funcstr+="var "+convertCode.arguments+" = "+arg+";",funcstr+=convertCode.body+";",funcstr+=arg+"="+convertCode.returnValue+";"}}}var cfuncname=parseJSFunc((function(){return cfunc})).returnValue;if(funcstr+="var ret = "+cfuncname+"("+argNames.join(",")+");",!numericRet){var strgfy=parseJSFunc((function(){return Pointer_stringify})).returnValue;funcstr+="ret = "+strgfy+"(ret);"}return numericArgs||(funcstr+=JSsource.stackRestore.body.replace("()","(stack)")+";"),funcstr+="return ret})",eval(funcstr)}})(),Module.cwrap=cwrap,Module.ccall=ccall,Module.setValue=setValue,Module.getValue=getValue;var ALLOC_NORMAL=0,ALLOC_STACK=1,ALLOC_STATIC=2,ALLOC_DYNAMIC=3,ALLOC_NONE=4;function allocate(e,t,i,n){var r,s;"number"==typeof e?(r=!0,s=e):(r=!1,s=e.length);var a,o="string"==typeof t?t:null;if(a=i==ALLOC_NONE?n:[_malloc,Runtime.stackAlloc,Runtime.staticAlloc,Runtime.dynamicAlloc][void 0===i?ALLOC_STATIC:i](Math.max(s,o?1:t.length)),r){var l;n=a;for(l=a+(-4&s);n<l;n+=4)HEAP32[n>>2]=0;for(l=a+s;n<l;)HEAP8[n++>>0]=0;return a}if("i8"===o)return e.subarray||e.slice?HEAPU8.set(e,a):HEAPU8.set(new Uint8Array(e),a),a;for(var d,c,h,u=0;u<s;){var p=e[u];"function"==typeof p&&(p=Runtime.getFunctionIndex(p)),0!==(d=o||t[u])?("i64"==d&&(d="i32"),setValue(a+u,p,d),h!==d&&(c=Runtime.getNativeTypeSize(d),h=d),u+=c):u++}return a}function Pointer_stringify(e,t){if(0===t||!e)return"";for(var i,n=!1,r=0;;){if((i=HEAPU8[e+r>>0])>=128)n=!0;else if(0==i&&!t)break;if(r++,t&&r==t)break}t||(t=r);var s="";if(!n){for(var a,o=1024;t>0;)a=String.fromCharCode.apply(String,HEAPU8.subarray(e,e+Math.min(t,o))),s=s?s+a:a,e+=o,t-=o;return s}var l=new Runtime.UTF8Processor;for(r=0;r<t;r++)i=HEAPU8[e+r>>0],s+=l.processCChar(i);return s}function UTF16ToString(e){for(var t=0,i="";;){var n=HEAP16[e+2*t>>1];if(0==n)return i;++t,i+=String.fromCharCode(n)}}function stringToUTF16(e,t){for(var i=0;i<e.length;++i){var n=e.charCodeAt(i);HEAP16[t+2*i>>1]=n}HEAP16[t+2*e.length>>1]=0}function UTF32ToString(e){for(var t=0,i="";;){var n=HEAP32[e+4*t>>2];if(0==n)return i;if(++t,n>=65536){var r=n-65536;i+=String.fromCharCode(55296|r>>10,56320|1023&r)}else i+=String.fromCharCode(n)}}function stringToUTF32(e,t){for(var i=0,n=0;n<e.length;++n){var r=e.charCodeAt(n);if(r>=55296&&r<=57343)r=65536+((1023&r)<<10)|1023&e.charCodeAt(++n);HEAP32[t+4*i>>2]=r,++i}HEAP32[t+4*i>>2]=0}function demangle(e){var t=!!Module.___cxa_demangle;if(t)try{var i=_malloc(e.length);writeStringToMemory(e.substr(1),i);var n=_malloc(4),r=Module.___cxa_demangle(i,0,0,n);if(0===getValue(n,"i32")&&r)return Pointer_stringify(r)}catch(e){}finally{i&&_free(i),n&&_free(n),r&&_free(r)}var s=3,a={v:"void",b:"bool",c:"char",s:"short",i:"int",l:"long",f:"float",d:"double",w:"wchar_t",a:"signed char",h:"unsigned char",t:"unsigned short",j:"unsigned int",m:"unsigned long",x:"long long",y:"unsigned long long",z:"..."},o=[],l=!0;var d=e;try{if("Object._main"==e||"_main"==e)return"main()";if("number"==typeof e&&(e=Pointer_stringify(e)),"_"!==e[0])return e;if("_"!==e[1])return e;if("Z"!==e[2])return e;switch(e[3]){case"n":return"operator new()";case"d":return"operator delete()"}d=function t(i,n,r){n=n||1/0;var d,c="",h=[];if("N"===e[s]){if(d=function(){s++,"K"===e[s]&&s++;for(var t=[];"E"!==e[s];)if("S"!==e[s])if("C"!==e[s]){var i=parseInt(e.substr(s)),n=i.toString().length;if(!i||!n){s--;break}var r=e.substr(s+n,i);t.push(r),o.push(r),s+=n+i}else t.push(t[t.length-1]),s+=2;else{s++;var a=e.indexOf("_",s),l=e.substring(s,a)||0;t.push(o[l]||"?"),s=a+1}return s++,t}().join("::"),0==--n)return i?[d]:d}else if(("K"===e[s]||l&&"L"===e[s])&&s++,m=parseInt(e.substr(s))){var u=m.toString().length;d=e.substr(s+u,m),s+=u+m}if(l=!1,"I"===e[s]){s++;var p=t(!0);c+=t(!0,1,!0)[0]+" "+d+"<"+p.join(", ")+">"}else c=d;e:for(;s<e.length&&n-- >0;){var g=e[s++];if(g in a)h.push(a[g]);else switch(g){case"P":h.push(t(!0,1,!0)[0]+"*");break;case"R":h.push(t(!0,1,!0)[0]+"&");break;case"L":s++;var m=e.indexOf("E",s)-s;h.push(e.substr(s,m)),s+=m+2;break;case"A":if(m=parseInt(e.substr(s)),s+=m.toString().length,"_"!==e[s])throw"?";s++,h.push(t(!0,1,!0)[0]+" ["+m+"]");break;case"E":break e;default:c+="?"+g;break e}}return r||1!==h.length||"void"!==h[0]||(h=[]),i?(c&&h.push(c+"?"),h):c+"("+h.join(", ")+")"}()}catch(e){d+="?"}return d.indexOf("?")>=0&&!t&&Runtime.warnOnce("warning: a problem occurred in builtin C++ name demangling; build with  -s DEMANGLE_SUPPORT=1  to link in libcxxabi demangling"),d}function demangleAll(e){return e.replace(/__Z[\w\d_]+/g,(function(e){var t=demangle(e);return e===t?e:e+" ["+t+"]"}))}function jsStackTrace(){var e=new Error;if(!e.stack){try{throw new Error(0)}catch(t){e=t}if(!e.stack)return"(no stack trace available)"}return e.stack.toString()}function stackTrace(){return demangleAll(jsStackTrace())}Module.ALLOC_NORMAL=ALLOC_NORMAL,Module.ALLOC_STACK=ALLOC_STACK,Module.ALLOC_STATIC=ALLOC_STATIC,Module.ALLOC_DYNAMIC=ALLOC_DYNAMIC,Module.ALLOC_NONE=ALLOC_NONE,Module.allocate=allocate,Module.Pointer_stringify=Pointer_stringify,Module.UTF16ToString=UTF16ToString,Module.stringToUTF16=stringToUTF16,Module.UTF32ToString=UTF32ToString,Module.stringToUTF32=stringToUTF32,Module.stackTrace=stackTrace;var PAGE_SIZE=4096,HEAP,HEAP8,HEAPU8,HEAP16,HEAPU16,HEAP32,HEAPU32,HEAPF32,HEAPF64;function alignMemoryPage(e){return e+4095&-4096}var STATIC_BASE=0,STATICTOP=0,staticSealed=!1,STACK_BASE=0,STACKTOP=0,STACK_MAX=0,DYNAMIC_BASE=0,DYNAMICTOP=0;function enlargeMemory(){abort("Cannot enlarge memory arrays. Either (1) compile with -s TOTAL_MEMORY=X with X higher than the current value "+TOTAL_MEMORY+", (2) compile with ALLOW_MEMORY_GROWTH which adjusts the size at runtime but prevents some optimizations, or (3) set Module.TOTAL_MEMORY before the program runs.")}for(var TOTAL_STACK=Module.TOTAL_STACK||5242880,TOTAL_MEMORY=Module.TOTAL_MEMORY||16777216,FAST_MEMORY=Module.FAST_MEMORY||2097152,totalMemory=65536;totalMemory<TOTAL_MEMORY||totalMemory<2*TOTAL_STACK;)totalMemory<16777216?totalMemory*=2:totalMemory+=16777216;totalMemory!==TOTAL_MEMORY&&(Module.printErr("increasing TOTAL_MEMORY to "+totalMemory+" to be compliant with the asm.js spec"),TOTAL_MEMORY=totalMemory);var buffer=new ArrayBuffer(TOTAL_MEMORY);function callRuntimeCallbacks(e){for(;e.length>0;){var t=e.shift();if("function"!=typeof t){var i=t.func;"number"==typeof i?void 0===t.arg?Runtime.dynCall("v",i):Runtime.dynCall("vi",i,[t.arg]):i(void 0===t.arg?null:t.arg)}else t()}}HEAP8=new Int8Array(buffer),HEAP16=new Int16Array(buffer),HEAP32=new Int32Array(buffer),HEAPU8=new Uint8Array(buffer),HEAPU16=new Uint16Array(buffer),HEAPU32=new Uint32Array(buffer),HEAPF32=new Float32Array(buffer),HEAPF64=new Float64Array(buffer),HEAP32[0]=255,Module.HEAP=HEAP,Module.buffer=buffer,Module.HEAP8=HEAP8,Module.HEAP16=HEAP16,Module.HEAP32=HEAP32,Module.HEAPU8=HEAPU8,Module.HEAPU16=HEAPU16,Module.HEAPU32=HEAPU32,Module.HEAPF32=HEAPF32,Module.HEAPF64=HEAPF64;var __ATPRERUN__=[],__ATINIT__=[],__ATMAIN__=[],__ATEXIT__=[],__ATPOSTRUN__=[],runtimeInitialized=!1,runtimeExited=!1;function preRun(){if(Module.preRun)for("function"==typeof Module.preRun&&(Module.preRun=[Module.preRun]);Module.preRun.length;)addOnPreRun(Module.preRun.shift());callRuntimeCallbacks(__ATPRERUN__)}function ensureInitRuntime(){runtimeInitialized||(runtimeInitialized=!0,callRuntimeCallbacks(__ATINIT__))}function preMain(){callRuntimeCallbacks(__ATMAIN__)}function exitRuntime(){callRuntimeCallbacks(__ATEXIT__),runtimeExited=!0}function postRun(){if(Module.postRun)for("function"==typeof Module.postRun&&(Module.postRun=[Module.postRun]);Module.postRun.length;)addOnPostRun(Module.postRun.shift());callRuntimeCallbacks(__ATPOSTRUN__)}function addOnPreRun(e){__ATPRERUN__.unshift(e)}function addOnInit(e){__ATINIT__.unshift(e)}function addOnPreMain(e){__ATMAIN__.unshift(e)}function addOnExit(e){__ATEXIT__.unshift(e)}function addOnPostRun(e){__ATPOSTRUN__.unshift(e)}function intArrayFromString(e,t,i){var n=(new Runtime.UTF8Processor).processJSString(e);return i&&(n.length=i),t||n.push(0),n}function intArrayToString(e){for(var t=[],i=0;i<e.length;i++){var n=e[i];n>255&&(n&=255),t.push(String.fromCharCode(n))}return t.join("")}function writeStringToMemory(e,t,i){for(var n=intArrayFromString(e,i),r=0;r<n.length;){var s=n[r];HEAP8[t+r>>0]=s,r+=1}}function writeArrayToMemory(e,t){for(var i=0;i<e.length;i++)HEAP8[t+i>>0]=e[i]}function writeAsciiToMemory(e,t,i){for(var n=0;n<e.length;n++)HEAP8[t+n>>0]=e.charCodeAt(n);i||(HEAP8[t+e.length>>0]=0)}function unSign(e,t,i){return e>=0?e:t<=32?2*Math.abs(1<<t-1)+e:Math.pow(2,t)+e}function reSign(e,t,i){if(e<=0)return e;var n=t<=32?Math.abs(1<<t-1):Math.pow(2,t-1);return e>=n&&(t<=32||e>n)&&(e=-2*n+e),e}Module.addOnPreRun=Module.addOnPreRun=addOnPreRun,Module.addOnInit=Module.addOnInit=addOnInit,Module.addOnPreMain=Module.addOnPreMain=addOnPreMain,Module.addOnExit=Module.addOnExit=addOnExit,Module.addOnPostRun=Module.addOnPostRun=addOnPostRun,Module.intArrayFromString=intArrayFromString,Module.intArrayToString=intArrayToString,Module.writeStringToMemory=writeStringToMemory,Module.writeArrayToMemory=writeArrayToMemory,Module.writeAsciiToMemory=writeAsciiToMemory,Math.imul&&-5===Math.imul(4294967295,5)||(Math.imul=function(e,t){var i=65535&e,n=65535&t;return i*n+((e>>>16)*n+i*(t>>>16)<<16)|0}),Math.imul=Math.imul;var Math_abs=Math.abs,Math_cos=Math.cos,Math_sin=Math.sin,Math_tan=Math.tan,Math_acos=Math.acos,Math_asin=Math.asin,Math_atan=Math.atan,Math_atan2=Math.atan2,Math_exp=Math.exp,Math_log=Math.log,Math_sqrt=Math.sqrt,Math_ceil=Math.ceil,Math_floor=Math.floor,Math_pow=Math.pow,Math_imul=Math.imul,Math_fround=Math.fround,Math_min=Math.min,runDependencies=0,runDependencyWatcher=null,dependenciesFulfilled=null;function addRunDependency(e){runDependencies++,Module.monitorRunDependencies&&Module.monitorRunDependencies(runDependencies)}function removeRunDependency(e){if(runDependencies--,Module.monitorRunDependencies&&Module.monitorRunDependencies(runDependencies),0==runDependencies&&(null!==runDependencyWatcher&&(clearInterval(runDependencyWatcher),runDependencyWatcher=null),dependenciesFulfilled)){var t=dependenciesFulfilled;dependenciesFulfilled=null,t()}}Module.addRunDependency=addRunDependency,Module.removeRunDependency=removeRunDependency,Module.preloadedImages={},Module.preloadedAudios={};var memoryInitializer=null;STATIC_BASE=8,STATICTOP=STATIC_BASE+33040,__ATINIT__.push(),allocate([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,133,59,140,1,189,241,36,255,248,37,195,1,96,220,55,0,183,76,62,255,195,66,61,0,50,76,164,1,225,164,76,255,76,61,163,255,117,62,31,0,81,145,64,255,118,65,14,0,162,115,214,255,6,138,46,0,124,230,244,255,10,138,143,0,52,26,194,0,184,244,76,0,129,143,41,1,190,244,19,255,123,170,122,255,98,129,68,0,121,213,147,0,86,101,30,255,161,103,155,0,140,89,67,255,239,229,190,1,67,11,181,0,198,240,137,254,238,69,188,255,67,151,238,0,19,42,108,255,229,85,113,1,50,68,135,255,17,106,9,0,50,103,1,255,80,1,168,1,35,152,30,255,16,168,185,1,56,89,232,255,101,210,252,0,41,250,71,0,204,170,79,255,14,46,239,255,80,77,239,0,189,214,75,255,17,141,249,0,38,80,76,255,190,85,117,0,86,228,170,0,156,216,208,1,195,207,164,255,150,66,76,255,175,225,16,255,141,80,98,1,76,219,242,0,198,162,114,0,46,218,152,0,155,43,241,254,155,160,104,255,51,187,165,0,2,17,175,0,66,84,160,1,247,58,30,0,35,65,53,254,69,236,191,0,45,134,245,1,163,123,221,0,32,110,20,255,52,23,165,0,186,214,71,0,233,176,96,0,242,239,54,1,57,89,138,0,83,0,84,255,136,160,100,0,92,142,120,254,104,124,190,0,181,177,62,255,250,41,85,0,152,130,42,1,96,252,246,0,151,151,63,254,239,133,62,0,32,56,156,0,45,167,189,255,142,133,179,1,131,86,211,0,187,179,150,254,250,170,14,255,210,163,78,0,37,52,151,0,99,77,26,0,238,156,213,255,213,192,209,1,73,46,84,0,20,65,41,1,54,206,79,0,201,131,146,254,170,111,24,255,177,33,50,254,171,38,203,255,78,247,116,0,209,221,153,0,133,128,178,1,58,44,25,0,201,39,59,1,189,19,252,0,49,229,210,1,117,187,117,0,181,179,184,1,0,114,219,0,48,94,147,0,245,41,56,0,125,13,204,254,244,173,119,0,44,221,32,254,84,234,20,0,249,160,198,1,236,126,234,255,47,99,168,254,170,226,153,255,102,179,216,0,226,141,122,255,122,66,153,254,182,245,134,0,227,228,25,1,214,57,235,255,216,173,56,255,181,231,210,0,119,128,157,255,129,95,136,255,110,126,51,0,2,169,183,255,7,130,98,254,69,176,94,255,116,4,227,1,217,242,145,255,202,173,31,1,105,1,39,255,46,175,69,0,228,47,58,255,215,224,69,254,207,56,69,255,16,254,139,255,23,207,212,255,202,20,126,255,95,213,96,255,9,176,33,0,200,5,207,255,241,42,128,254,35,33,192,255,248,229,196,1,129,17,120,0,251,103,151,255,7,52,112,255,140,56,66,255,40,226,245,255,217,70,37,254,172,214,9,255,72,67,134,1,146,192,214,255,44,38,112,0,68,184,75,255,206,90,251,0,149,235,141,0,181,170,58,0,116,244,239,0,92,157,2,0,102,173,98,0,233,137,96,1,127,49,203,0,5,155,148,0,23,148,9,255,211,122,12,0,34,134,26,255,219,204,136,0,134,8,41,255,224,83,43,254,85,25,247,0,109,127,0,254,169,136,48,0,238,119,219,255,231,173,213,0,206,18,254,254,8,186,7,255,126,9,7,1,111,42,72,0,111,52,236,254,96,63,141,0,147,191,127,254,205,78,192,255,14,106,237,1,187,219,76,0,175,243,187,254,105,89,173,0,85,25,89,1,162,243,148,0,2,118,209,254,33,158,9,0,139,163,46,255,93,70,40,0,108,42,142,254,111,252,142,255,155,223,144,0,51,229,167,255,73,252,155,255,94,116,12,255,152,160,218,255,156,238,37,255,179,234,207,255,197,0,179,255,154,164,141,0,225,196,104,0,10,35,25,254,209,212,242,255,97,253,222,254,184,101,229,0,222,18,127,1,164,136,135,255,30,207,140,254,146,97,243,0,129,192,26,254,201,84,33,255,111,10,78,255,147,81,178,255,4,4,24,0,161,238,215,255,6,141,33,0,53,215,14,255,41,181,208,255,231,139,157,0,179,203,221,255,255,185,113,0,189,226,172,255,113,66,214,255,202,62,45,255,102,64,8,255,78,174,16,254,133,117,68,255,182,120,89,255,133,114,211,0,189,110,21,255,15,10,106,0,41,192,1,0,152,232,121,255,188,60,160,255,153,113,206,255,0,183,226,254,180,13,72,255,176,160,14,254,211,201,134,255,158,24,143,0,127,105,53,0,96,12,189,0,167,215,251,255,159,76,128,254,106,101,225,255,30,252,4,0,146,12,174,0,89,241,178,254,10,229,166,255,123,221,42,254,30,20,212,0,82,128,3,0,48,209,243,0,119,121,64,255,50,227,156,255,0,110,197,1,103,27,144,0,133,59,140,1,189,241,36,255,248,37,195,1,96,220,55,0,183,76,62,255,195,66,61,0,50,76,164,1,225,164,76,255,76,61,163,255,117,62,31,0,81,145,64,255,118,65,14,0,162,115,214,255,6,138,46,0,124,230,244,255,10,138,143,0,52,26,194,0,184,244,76,0,129,143,41,1,190,244,19,255,123,170,122,255,98,129,68,0,121,213,147,0,86,101,30,255,161,103,155,0,140,89,67,255,239,229,190,1,67,11,181,0,198,240,137,254,238,69,188,255,234,113,60,255,37,255,57,255,69,178,182,254,128,208,179,0,118,26,125,254,3,7,214,255,241,50,77,255,85,203,197,255,211,135,250,255,25,48,100,255,187,213,180,254,17,88,105,0,83,209,158,1,5,115,98,0,4,174,60,254,171,55,110,255,217,181,17,255,20,188,170,0,146,156,102,254,87,214,174,255,114,122,155,1,233,44,170,0,127,8,239,1,214,236,234,0,175,5,219,0,49,106,61,255,6,66,208,255,2,106,110,255,81,234,19,255,215,107,192,255,67,151,238,0,19,42,108,255,229,85,113,1,50,68,135,255,17,106,9,0,50,103,1,255,80,1,168,1,35,152,30,255,16,168,185,1,56,89,232,255,101,210,252,0,41,250,71,0,204,170,79,255,14,46,239,255,80,77,239,0,189,214,75,255,17,141,249,0,38,80,76,255,190,85,117,0,86,228,170,0,156,216,208,1,195,207,164,255,150,66,76,255,175,225,16,255,141,80,98,1,76,219,242,0,198,162,114,0,46,218,152,0,155,43,241,254,155,160,104,255,178,9,252,254,100,110,212,0,14,5,167,0,233,239,163,255,28,151,157,1,101,146,10,255,254,158,70,254,71,249,228,0,88,30,50,0,68,58,160,255,191,24,104,1,129,66,129,255,192,50,85,255,8,179,138,255,38,250,201,0,115,80,160,0,131,230,113,0,125,88,147,0,90,68,199,0,253,76,158,0,28,255,118,0,113,250,254,0,66,75,46,0,230,218,43,0,229,120,186,1,148,68,43,0,136,124,238,1,187,107,197,255,84,53,246,255,51,116,254,255,51,187,165,0,2,17,175,0,66,84,160,1,247,58,30,0,35,65,53,254,69,236,191,0,45,134,245,1,163,123,221,0,32,110,20,255,52,23,165,0,186,214,71,0,233,176,96,0,242,239,54,1,57,89,138,0,83,0,84,255,136,160,100,0,92,142,120,254,104,124,190,0,181,177,62,255,250,41,85,0,152,130,42,1,96,252,246,0,151,151,63,254,239,133,62,0,32,56,156,0,45,167,189,255,142,133,179,1,131,86,211,0,187,179,150,254,250,170,14,255,68,113,21,255,222,186,59,255,66,7,241,1,69,6,72,0,86,156,108,254,55,167,89,0,109,52,219,254,13,176,23,255,196,44,106,255,239,149,71,255,164,140,125,255,159,173,1,0,51,41,231,0,145,62,33,0,138,111,93,1,185,83,69,0,144,115,46,0,97,151,16,255,24,228,26,0,49,217,226,0,113,75,234,254,193,153,12,255,182,48,96,255,14,13,26,0,128,195,249,254,69,193,59,0,132,37,81,254,125,106,60,0,214,240,169,1,164,227,66,0,210,163,78,0,37,52,151,0,99,77,26,0,238,156,213,255,213,192,209,1,73,46,84,0,20,65,41,1,54,206,79,0,201,131,146,254,170,111,24,255,177,33,50,254,171,38,203,255,78,247,116,0,209,221,153,0,133,128,178,1,58,44,25,0,201,39,59,1,189,19,252,0,49,229,210,1,117,187,117,0,181,179,184,1,0,114,219,0,48,94,147,0,245,41,56,0,125,13,204,254,244,173,119,0,44,221,32,254,84,234,20,0,249,160,198,1,236,126,234,255,143,62,221,0,129,89,214,255,55,139,5,254,68,20,191,255,14,204,178,1,35,195,217,0,47,51,206,1,38,246,165,0,206,27,6,254,158,87,36,0,217,52,146,255,125,123,215,255,85,60,31,255,171,13,7,0,218,245,88,254,252,35,60,0,55,214,160,255,133,101,56,0,224,32,19,254,147,64,234,0,26,145,162,1,114,118,125,0,248,252,250,0,101,94,196,255,198,141,226,254,51,42,182,0,135,12,9,254,109,172,210,255,197,236,194,1,241,65,154,0,48,156,47,255,153,67,55,255,218,165,34,254,74,180,179,0,218,66,71,1,88,122,99,0,212,181,219,255,92,42,231,255,239,0,154,0,245,77,183,255,94,81,170,1,18,213,216,0,171,93,71,0,52,94,248,0,18,151,161,254,197,209,66,255,174,244,15,254,162,48,183,0,49,61,240,254,182,93,195,0,199,228,6,1,200,5,17,255,137,45,237,255,108,148,4,0,90,79,237,255,39,63,77,255,53,82,207,1,142,22,118,255,101,232,18,1,92,26,67,0,5,200,88,255,33,168,138,255,149,225,72,0,2,209,27,255,44,245,168,1,220,237,17,255,30,211,105,254,141,238,221,0,128,80,245,254,111,254,14,0,222,95,190,1,223,9,241,0,146,76,212,255,108,205,104,255,63,117,153,0,144,69,48,0,35,228,111,0,192,33,193,255,112,214,190,254,115,152,151,0,23,102,88,0,51,74,248,0,226,199,143,254,204,162,101,255,208,97,189,1,245,104,18,0,230,246,30,255,23,148,69,0,110,88,52,254,226,181,89,255,208,47,90,254,114,161,80,255,33,116,248,0,179,152,87,255,69,144,177,1,88,238,26,255,58,32,113,1,1,77,69,0,59,121,52,255,152,238,83,0,52,8,193,0,231,39,233,255,199,34,138,0,222,68,173,0,91,57,242,254,220,210,127,255,192,7,246,254,151,35,187,0,195,236,165,0,111,93,206,0,212,247,133,1,154,133,209,255,155,231,10,0,64,78,38,0,122,249,100,1,30,19,97,255,62,91,249,1,248,133,77,0,197,63,168,254,116,10,82,0,184,236,113,254,212,203,194,255,61,100,252,254,36,5,202,255,119,91,153,255,129,79,29,0,103,103,171,254,237,215,111,255,216,53,69,0,239,240,23,0,194,149,221,255,38,225,222,0,232,255,180,254,118,82,133,255,57,209,177,1,139,232,133,0,158,176,46,254,194,115,46,0,88,247,229,1,28,103,191,0,221,222,175,254,149,235,44,0,151,228,25,254,218,105,103,0,142,85,210,0,149,129,190,255,213,65,94,254,117,134,224,255,82,198,117,0,157,221,220,0,163,101,36,0,197,114,37,0,104,172,166,254,11,182,0,0,81,72,188,255,97,188,16,255,69,6,10,0,199,147,145,255,8,9,115,1,65,214,175,255,217,173,209,0,80,127,166,0,247,229,4,254,167,183,124,255,90,28,204,254,175,59,240,255,11,41,248,1,108,40,51,255,144,177,195,254,150,250,126,0,138,91,65,1,120,60,222,255,245,193,239,0,29,214,189,255,128,2,25,0,80,154,162,0,77,220,107,1,234,205,74,255,54,166,103,255,116,72,9,0,228,94,47,255,30,200,25,255,35,214,89,255,61,176,140,255,83,226,163,255,75,130,172,0,128,38,17,0,95,137,152,255,215,124,159,1,79,93,0,0,148,82,157,254,195,130,251,255,40,202,76,255,251,126,224,0,157,99,62,254,207,7,225,255,96,68,195,0,140,186,157,255,131,19,231,255,42,128,254,0,52,219,61,254,102,203,72,0,141,7,11,255,186,164,213,0,31,122,119,0,133,242,145,0,208,252,232,255,91,213,182,255,143,4,250,254,249,215,74,0,165,30,111,1,171,9,223,0,229,123,34,1,92,130,26,255,77,155,45,1,195,139,28,255,59,224,78,0,136,17,247,0,108,121,32,0,79,250,189,255,96,227,252,254,38,241,62,0,62,174,125,255,155,111,93,255,10,230,206,1,97,197,40,255,0,49,57,254,65,250,13,0,18,251,150,255,220,109,210,255,5,174,166,254,44,129,189,0,235,35,147,255,37,247,141,255,72,141,4,255,103,107,255,0,247,90,4,0,53,44,42,0,2,30,240,0,4,59,63,0,88,78,36,0,113,167,180,0,190,71,193,255,199,158,164,255,58,8,172,0,77,33,12,0,65,63,3,0,153,77,33,255,172,254,102,1,228,221,4,255,87,30,254,1,146,41,86,255,138,204,239,254,108,141,17,255,187,242,135,0,210,208,127,0,68,45,14,254,73,96,62,0,81,60,24,255,170,6,36,255,3,249,26,0,35,213,109,0,22,129,54,255,21,35,225,255,234,61,56,255,58,217,6,0,143,124,88,0,236,126,66,0,209,38,183,255,34,238,6,255,174,145,102,0,95,22,211,0,196,15,153,254,46,84,232,255,117,34,146,1,231,250,74,255,27,134,100,1,92,187,195,255,170,198,112,0,120,28,42,0,209,70,67,0,29,81,31,0,29,168,100,1,169,173,160,0,107,35,117,0,62,96,59,255,81,12,69,1,135,239,190,255,220,252,18,0,163,220,58,255,137,137,188,255,83,102,109,0,96,6,76,0,234,222,210,255,185,174,205,1,60,158,213,255,13,241,214,0,172,129,140,0,93,104,242,0,192,156,251,0,43,117,30,0,225,81,158,0,127,232,218,0,226,28,203,0,233,27,151,255,117,43,5,255,242,14,47,255,33,20,6,0,137,251,44,254,27,31,245,255,183,214,125,254,40,121,149,0,186,158,213,255,89,8,227,0,69,88,0,254,203,135,225,0,201,174,203,0,147,71,184,0,18,121,41,254,94,5,78,0,224,214,240,254,36,5,180,0,251,135,231,1,163,138,212,0,210,249,116,254,88,129,187,0,19,8,49,254,62,14,144,255,159,76,211,0,214,51,82,0,109,117,228,254,103,223,203,255,75,252,15,1,154,71,220,255,23,13,91,1,141,168,96,255,181,182,133,0,250,51,55,0,234,234,212,254,175,63,158,0,39,240,52,1,158,189,36,255,213,40,85,1,32,180,247,255,19,102,26,1,84,24,97,255,69,21,222,0,148,139,122,255,220,213,235,1,232,203,255,0,121,57,147,0,227,7,154,0,53,22,147,1,72,1,225,0,82,134,48,254,83,60,157,255,145,72,169,0,34,103,239,0,198,233,47,0,116,19,4,255,184,106,9,255,183,129,83,0,36,176,230,1,34,103,72,0,219,162,134,0,245,42,158,0,32,149,96,254,165,44,144,0,202,239,72,254,215,150,5,0,42,66,36,1,132,215,175,0,86,174,86,255,26,197,156,255,49,232,135,254,103,182,82,0,253,128,176,1,153,178,122,0,245,250,10,0,236,24,178,0,137,106,132,0,40,29,41,0,50,30,152,255,124,105,38,0,230,191,75,0,143,43,170,0,44,131,20,255,44,13,23,255,237,255,155,1,159,109,100,255,112,181,24,255,104,220,108,0,55,211,131,0,99,12,213,255,152,151,145,255,238,5,159,0,97,155,8,0,33,108,81,0,1,3,103,0,62,109,34,255,250,155,180,0,32,71,195,255,38,70,145,1,159,95,245,0,69,229,101,1,136,28,240,0,79,224,25,0,78,110,121,255,248,168,124,0,187,128,247,0,2,147,235,254,79,11,132,0,70,58,12,1,181,8,163,255,79,137,133,255,37,170,11,255,141,243,85,255,176,231,215,255,204,150,164,255,239,215,39,255,46,87,156,254,8,163,88,255,172,34,232,0,66,44,102,255,27,54,41,254,236,99,87,255,41,123,169,1,52,114,43,0,117,134,40,0,155,134,26,0,231,207,91,254,35,132,38,255,19,102,125,254,36,227,133,255,118,3,113,255,29,13,124,0,152,96,74,1,88,146,206,255,167,191,220,254,162,18,88,255,182,100,23,0,31,117,52,0,81,46,106,1,12,2,7,0,69,80,201,1,209,246,172,0,12,48,141,1,224,211,88,0,116,226,159,0,122,98,130,0,65,236,234,1,225,226,9,255,207,226,123,1,89,214,59,0,112,135,88,1,90,244,203,255,49,11,38,1,129,108,186,0,89,112,15,1,101,46,204,255,127,204,45,254,79,255,221,255,51,73,18,255,127,42,101,255,241,21,202,0,160,227,7,0,105,50,236,0,79,52,197,255,104,202,208,1,180,15,16,0,101,197,78,255,98,77,203,0,41,185,241,1,35,193,124,0,35,155,23,255,207,53,192,0,11,125,163,1,249,158,185,255,4,131,48,0,21,93,111,255,61,121,231,1,69,200,36,255,185,48,185,255,111,238,21,255,39,50,25,255,99,215,163,255,87,212,30,255,164,147,5,255,128,6,35,1,108,223,110,255,194,76,178,0,74,101,180,0,243,47,48,0,174,25,43,255,82,173,253,1,54,114,192,255,40,55,91,0,215,108,176,255,11,56,7,0,224,233,76,0,209,98,202,254,242,25,125,0,44,193,93,254,203,8,177,0,135,176,19,0,112,71,213,255,206,59,176,1,4,67,26,0,14,143,213,254,42,55,208,255,60,67,120,0,193,21,163,0,99,164,115,0,10,20,118,0,156,212,222,254,160,7,217,255,114,245,76,1,117,59,123,0,176,194,86,254,213,15,176,0,78,206,207,254,213,129,59,0,233,251,22,1,96,55,152,255,236,255,15,255,197,89,84,255,93,149,133,0,174,160,113,0,234,99,169,255,152,116,88,0,144,164,83,255,95,29,198,255,34,47,15,255,99,120,134,255,5,236,193,0,249,247,126,255,147,187,30,0,50,230,117,255,108,217,219,255,163,81,166,255,72,25,169,254,155,121,79,255,28,155,89,254,7,126,17,0,147,65,33,1,47,234,253,0,26,51,18,0,105,83,199,255,163,196,230,0,113,248,164,0,226,254,218,0,189,209,203,255,164,247,222,254,255,35,165,0,4,188,243,1,127,179,71,0,37,237,254,255,100,186,240,0,5,57,71,254,103,72,73,255,244,18,81,254,229,210,132,255,238,6,180,255,11,229,174,255,227,221,192,1,17,49,28,0,163,215,196,254,9,118,4,255,51,240,71,0,113,129,109,255,76,240,231,0,188,177,127,0,125,71,44,1,26,175,243,0,94,169,25,254,27,230,29,0,15,139,119,1,168,170,186,255,172,197,76,255,252,75,188,0,137,124,196,0,72,22,96,255,45,151,249,1,220,145,100,0,64,192,159,255,120,239,226,0,129,178,146,0,0,192,125,0,235,138,234,0,183,157,146,0,83,199,192,255,184,172,72,255,73,225,128,0,77,6,250,255,186,65,67,0,104,246,207,0,188,32,138,255,218,24,242,0,67,138,81,254,237,129,121,255,20,207,150,1,41,199,16,255,6,20,128,0,159,118,5,0,181,16,143,255,220,38,15,0,23,64,147,254,73,26,13,0,87,228,57,1,204,124,128,0,43,24,223,0,219,99,199,0,22,75,20,255,19,27,126,0,157,62,215,0,110,29,230,0,179,167,255,1,54,252,190,0,221,204,182,254,179,158,65,255,81,157,3,0,194,218,159,0,170,223,0,0,224,11,32,255,38,197,98,0,168,164,37,0,23,88,7,1,164,186,110,0,96,36,134,0,234,242,229,0,250,121,19,0,242,254,112,255,3,47,94,1,9,239,6,255,81,134,153,254,214,253,168,255,67,124,224,0,245,95,74,0,28,30,44,254,1,109,220,255,178,89,89,0,252,36,76,0,24,198,46,255,76,77,111,0,134,234,136,255,39,94,29,0,185,72,234,255,70,68,135,255,231,102,7,254,77,231,140,0,167,47,58,1,148,97,118,255,16,27,225,1,166,206,143,255,110,178,214,255,180,131,162,0,143,141,225,1,13,218,78,255,114,153,33,1,98,104,204,0,175,114,117,1,167,206,75,0,202,196,83,1,58,64,67,0,138,47,111,1,196,247,128,255,137,224,224,254,158,112,207,0,154,100,255,1,134,37,107,0,198,128,79,255,127,209,155,255,163,254,185,254,60,14,243,0,31,219,112,254,29,217,65,0,200,13,116,254,123,60,196,255,224,59,184,254,242,89,196,0,123,16,75,254,149,16,206,0,69,254,48,1,231,116,223,255,209,160,65,1,200,80,98,0,37,194,184,254,148,63,34,0,139,240,65,255,217,144,132,255,56,38,45,254,199,120,210,0,108,177,166,255,160,222,4,0,220,126,119,254,165,107,160,255,82,220,248,1,241,175,136,0,144,141,23,255,169,138,84,0,160,137,78,255,226,118,80,255,52,27,132,255,63,96,139,255,152,250,39,0,188,155,15,0,232,51,150,254,40,15,232,255,240,229,9,255,137,175,27,255,75,73,97,1,218,212,11,0,135,5,162,1,107,185,213,0,2,249,107,255,40,242,70,0,219,200,25,0,25,157,13,0,67,82,80,255,196,249,23,255,145,20,149,0,50,72,146,0,94,76,148,1,24,251,65,0,31,192,23,0,184,212,201,255,123,233,162,1,247,173,72,0,162,87,219,254,126,134,89,0,159,11,12,254,166,105,29,0,73,27,228,1,113,120,183,255,66,163,109,1,212,143,11,255,159,231,168,1,255,128,90,0,57,14,58,254,89,52,10,255,253,8,163,1,0,145,210,255,10,129,85,1,46,181,27,0,103,136,160,254,126,188,209,255,34,35,111,0,215,219,24,255,212,11,214,254,101,5,118,0,232,197,133,255,223,167,109,255,237,80,86,255,70,139,94,0,158,193,191,1,155,15,51,255,15,190,115,0,78,135,207,255,249,10,27,1,181,125,233,0,95,172,13,254,170,213,161,255,39,236,138,255,95,93,87,255,190,128,95,0,125,15,206,0,166,150,159,0,227,15,158,255,206,158,120,255,42,141,128,0,101,178,120,1,156,109,131,0,218,14,44,254,247,168,206,255,212,112,28,0,112,17,228,255,90,16,37,1,197,222,108,0,254,207,83,255,9,90,243,255,243,244,172,0,26,88,115,255,205,116,122,0,191,230,193,0,180,100,11,1,217,37,96,255,154,78,156,0,235,234,31,255,206,178,178,255,149,192,251,0,182,250,135,0,246,22,105,0,124,193,109,255,2,210,149,255,169,17,170,0,0,96,110,255,117,9,8,1,50,123,40,255,193,189,99,0,34,227,160,0,48,80,70,254,211,51,236,0,45,122,245,254,44,174,8,0,173,37,233,255,158,65,171,0,122,69,215,255,90,80,2,255,131,106,96,254,227,114,135,0,205,49,119,254,176,62,64,255,82,51,17,255,241,20,243,255,130,13,8,254,128,217,243,255,162,27,1,254,90,118,241,0,246,198,246,255,55,16,118,255,200,159,157,0,163,17,1,0,140,107,121,0,85,161,118,255,38,0,149,0,156,47,238,0,9,166,166,1,75,98,181,255,50,74,25,0,66,15,47,0,139,225,159,0,76,3,142,255,14,238,184,0,11,207,53,255,183,192,186,1,171,32,174,255,191,76,221,1,247,170,219,0,25,172,50,254,217,9,233,0,203,126,68,255,183,92,48,0,127,167,183,1,65,49,254,0,16,63,127,1,254,21,170,255,59,224,127,254,22,48,63,255,27,78,130,254,40,195,29,0,250,132,112,254,35,203,144,0,104,169,168,0,207,253,30,255,104,40,38,254,94,228,88,0,206,16,128,255,212,55,122,255,223,22,234,0,223,197,127,0,253,181,181,1,145,102,118,0,236,153,36,255,212,217,72,255,20,38,24,254,138,62,62,0,152,140,4,0,230,220,99,255,1,21,212,255,148,201,231,0,244,123,9,254,0,171,210,0,51,58,37,255,1,255,14,255,244,183,145,254,0,242,166,0,22,74,132,0,121,216,41,0,95,195,114,254,133,24,151,255,156,226,231,255,247,5,77,255,246,148,115,254,225,92,81,255,222,80,246,254,170,123,89,255,74,199,141,0,29,20,8,255,138,136,70,255,93,75,92,0,221,147,49,254,52,126,226,0,229,124,23,0,46,9,181,0,205,64,52,1,131,254,28,0,151,158,212,0,131,64,78,0,206,25,171,0,0,230,139,0,191,253,110,254,103,247,167,0,64,40,40,1,42,165,241,255,59,75,228,254,124,243,189,255,196,92,178,255,130,140,86,255,141,89,56,1,147,198,5,255,203,248,158,254,144,162,141,0,11,172,226,0,130,42,21,255,1,167,143,255,144,36,36,255,48,88,164,254,168,170,220,0,98,71,214,0,91,208,79,0,159,76,201,1,166,42,214,255,69,255,0,255,6,128,125,255,190,1,140,0,146,83,218,255,215,238,72,1,122,127,53,0,189,116,165,255,84,8,66,255,214,3,208,255,213,110,133,0,195,168,44,1,158,231,69,0,162,64,200,254,91,58,104,0,182,58,187,254,249,228,136,0,203,134,76,254,99,221,233,0,75,254,214,254,80,69,154,0,64,152,248,254,236,136,202,255,157,105,153,254,149,175,20,0,22,35,19,255,124,121,233,0,186,250,198,254,132,229,139,0,137,80,174,255,165,125,68,0,144,202,148,254,235,239,248,0,135,184,118,0,101,94,17,255,122,72,70,254,69,130,146,0,127,222,248,1,69,127,118,255,30,82,215,254,188,74,19,255,229,167,194,254,117,25,66,255,65,234,56,254,213,22,156,0,151,59,93,254,45,28,27,255,186,126,164,255,32,6,239,0,127,114,99,1,219,52,2,255,99,96,166,254,62,190,126,255,108,222,168,1,75,226,174,0,230,226,199,0,60,117,218,255,252,248,20,1,214,188,204,0,31,194,134,254,123,69,192,255,169,173,36,254,55,98,91,0,223,42,102,254,137,1,102,0,157,90,25,0,239,122,64,255,252,6,233,0,7,54,20,255,82,116,174,0,135,37,54,255,15,186,125,0,227,112,175,255,100,180,225,255,42,237,244,255,244,173,226,254,248,18,33,0,171,99,150,255,74,235,50,255,117,82,32,254,106,168,237,0,207,109,208,1,228,9,186,0,135,60,169,254,179,92,143,0,244,170,104,255,235,45,124,255,70,99,186,0,117,137,183,0,224,31,215,0,40,9,100,0,26,16,95,1,68,217,87,0,8,151,20,255,26,100,58,255,176,165,203,1,52,118,70,0,7,32,254,254,244,254,245,255,167,144,194,255,125,113,23,255,176,121,181,0,136,84,209,0,138,6,30,255,89,48,28,0,33,155,14,255,25,240,154,0,141,205,109,1,70,115,62,255,20,40,107,254,138,154,199,255,94,223,226,255,157,171,38,0,163,177,25,254,45,118,3,255,14,222,23,1,209,190,81,255,118,123,232,1,13,213,101,255,123,55,123,254,27,246,165,0,50,99,76,255,140,214,32,255,97,65,67,255,24,12,28,0,174,86,78,1,64,247,96,0,160,135,67,0,66,55,243,255,147,204,96,255,26,6,33,255,98,51,83,1,153,213,208,255,2,184,54,255,25,218,11,0,49,67,246,254,18,149,72,255,13,25,72,0,42,79,214,0,42,4,38,1,27,139,144,255,149,187,23,0,18,164,132,0,245,84,184,254,120,198,104,255,126,218,96,0,56,117,234,255,13,29,214,254,68,47,10,255,167,154,132,254,152,38,198,0,66,178,89,255,200,46,171,255,13,99,83,255,210,187,253,255,170,45,42,1,138,209,124,0,214,162,141,0,12,230,156,0,102,36,112,254,3,147,67,0,52,215,123,255,233,171,54,255,98,137,62,0,247,218,39,255,231,218,236,0,247,191,127,0,195,146,84,0,165,176,92,255,19,212,94,255,17,74,227,0,88,40,153,1,198,147,1,255,206,67,245,254,240,3,218,255,61,141,213,255,97,183,106,0,195,232,235,254,95,86,154,0,209,48,205,254,118,209,241,255,240,120,223,1,213,29,159,0,163,127,147,255,13,218,93,0,85,24,68,254,70,20,80,255,189,5,140,1,82,97,254,255,99,99,191,255,132,84,133,255,107,218,116,255,112,122,46,0,105,17,32,0,194,160,63,255,68,222,39,1,216,253,92,0,177,105,205,255,149,201,195,0,42,225,11,255,40,162,115,0,9,7,81,0,165,218,219,0,180,22,0,254,29,146,252,255,146,207,225,1,180,135,96,0,31,163,112,0,177,11,219,255,133,12,193,254,43,78,50,0,65,113,121,1,59,217,6,255,110,94,24,1,112,172,111,0,7,15,96,0,36,85,123,0,71,150,21,255,208,73,188,0,192,11,167,1,213,245,34,0,9,230,92,0,162,142,39,255,215,90,27,0,98,97,89,0,94,79,211,0,90,157,240,0,95,220,126,1,102,176,226,0,36,30,224,254,35,31,127,0,231,232,115,1,85,83,130,0,210,73,245,255,47,143,114,255,68,65,197,0,59,72,62,255,183,133,173,254,93,121,118,255,59,177,81,255,234,69,173,255,205,128,177,0,220,244,51,0,26,244,209,1,73,222,77,255,163,8,96,254,150,149,211,0,158,254,203,1,54,127,139,0,161,224,59,0,4,109,22,255,222,42,45,255,208,146,102,255,236,142,187,0,50,205,245,255,10,74,89,254,48,79,142,0,222,76,130,255,30,166,63,0,236,12,13,255,49,184,244,0,187,113,102,0,218,101,253,0,153,57,182,254,32,150,42,0,25,198,146,1,237,241,56,0,140,68,5,0,91,164,172,255,78,145,186,254,67,52,205,0,219,207,129,1,109,115,17,0,54,143,58,1,21,248,120,255,179,255,30,0,193,236,66,255,1,255,7,255,253,192,48,255,19,69,217,1,3,214,0,255,64,101,146,1,223,125,35,255,235,73,179,255,249,167,226,0,225,175,10,1,97,162,58,0,106,112,171,1,84,172,5,255,133,140,178,255,134,245,142,0,97,90,125,255,186,203,185,255,223,77,23,255,192,92,106,0,15,198,115,255,217,152,248,0,171,178,120,255,228,134,53,0,176,54,193,1,250,251,53,0,213,10,100,1,34,199,106,0,151,31,244,254,172,224,87,255,14,237,23,255,253,85,26,255,127,39,116,255,172,104,100,0,251,14,70,255,212,208,138,255,253,211,250,0,176,49,165,0,15,76,123,255,37,218,160,255,92,135,16,1,10,126,114,255,70,5,224,255,247,249,141,0,68,20,60,1,241,210,189,255,195,217,187,1,151,3,113,0,151,92,174,0,231,62,178,255,219,183,225,0,23,23,33,255,205,181,80,0,57,184,248,255,67,180,1,255,90,123,93,255,39,0,162,255,96,248,52,255,84,66,140,0,34,127,228,255,194,138,7,1,166,110,188,0,21,17,155,1,154,190,198,255,214,80,59,255,18,7,143,0,72,29,226,1,199,217,249,0,232,161,71,1,149,190,201,0,217,175,95,254,113,147,67,255,138,143,199,255,127,204,1,0,29,182,83,1,206,230,155,255,186,204,60,0,10,125,85,255,232,96,25,255,255,89,247,255,213,254,175,1,232,193,81,0,28,43,156,254,12,69,8,0,147,24,248,0,18,198,49,0,134,60,35,0,118,246,18,255,49,88,254,254,228,21,186,255,182,65,112,1,219,22,1,255,22,126,52,255,189,53,49,255,112,25,143,0,38,127,55,255,226,101,163,254,208,133,61,255,137,69,174,1,190,118,145,255,60,98,219,255,217,13,245,255,250,136,10,0,84,254,226,0,201,31,125,1,240,51,251,255,31,131,130,255,2,138,50,255,215,215,177,1,223,12,238,255,252,149,56,255,124,91,68,255,72,126,170,254,119,255,100,0,130,135,232,255,14,79,178,0,250,131,197,0,138,198,208,0,121,216,139,254,119,18,36,255,29,193,122,0,16,42,45,255,213,240,235,1,230,190,169,255,198,35,228,254,110,173,72,0,214,221,241,255,56,148,135,0,192,117,78,254,141,93,207,255,143,65,149,0,21,18,98,255,95,44,244,1,106,191,77,0,254,85,8,254,214,110,176,255,73,173,19,254,160,196,199,255,237,90,144,0,193,172,113,255,200,155,136,254,228,90,221,0,137,49,74,1,164,221,215,255,209,189,5,255,105,236,55,255,42,31,129,1,193,255,236,0,46,217,60,0,138,88,187,255,226,82,236,255,81,69,151,255,142,190,16,1,13,134,8,0,127,122,48,255,81,64,156,0,171,243,139,0,237,35,246,0,122,143,193,254,212,122,146,0,95,41,255,1,87,132,77,0,4,212,31,0,17,31,78,0,39,45,173,254,24,142,217,255,95,9,6,255,227,83,6,0,98,59,130,254,62,30,33,0,8,115,211,1,162,97,128,255,7,184,23,254,116,28,168,255,248,138,151,255,98,244,240,0,186,118,130,0,114,248,235,255,105,173,200,1,160,124,71,255,94,36,164,1,175,65,146,255,238,241,170,254,202,198,197,0,228,71,138,254,45,246,109,255,194,52,158,0,133,187,176,0,83,252,154,254,89,189,221,255,170,73,252,0,148,58,125,0,36,68,51,254,42,69,177,255,168,76,86,255,38,100,204,255,38,53,35,0,175,19,97,0,225,238,253,255,81,81,135,0,210,27,255,254,235,73,107,0,8,207,115,0,82,127,136,0,84,99,21,254,207,19,136,0,100,164,101,0,80,208,77,255,132,207,237,255,15,3,15,255,33,166,110,0,156,95,85,255,37,185,111,1,150,106,35,255,166,151,76,0,114,87,135,255,159,194,64,0,12,122,31,255,232,7,101,254,173,119,98,0,154,71,220,254,191,57,53,255,168,232,160,255,224,32,99,255,218,156,165,0,151,153,163,0,217,13,148,1,197,113,89,0,149,28,161,254,207,23,30,0,105,132,227,255,54,230,94,255,133,173,204,255,92,183,157,255,88,144,252,254,102,33,90,0,159,97,3,0,181,218,155,255,240,114,119,0,106,214,53,255,165,190,115,1,152,91,225,255,88,106,44,255,208,61,113,0,151,52,124,0,191,27,156,255,110,54,236,1,14,30,166,255,39,127,207,1,229,199,28,0,188,228,188,254,100,157,235,0,246,218,183,1,107,22,193,255,206,160,95,0,76,239,147,0,207,161,117,0,51,166,2,255,52,117,10,254,73,56,227,255,152,193,225,0,132,94,136,255,101,191,209,0,32,107,229,255,198,43,180,1,100,210,118,0,114,67,153,255,23,88,26,255,89,154,92,1,220,120,140,255,144,114,207,255,252,115,250,255,34,206,72,0,138,133,127,255,8,178,124,1,87,75,97,0,15,229,92,254,240,67,131,255,118,123,227,254,146,120,104,255,145,213,255,1,129,187,70,255,219,119,54,0,1,19,173,0,45,150,148,1,248,83,72,0,203,233,169,1,142,107,56,0,247,249,38,1,45,242,80,255,30,233,103,0,96,82,70,0,23,201,111,0,81,39,30,255,161,183,78,255,194,234,33,255,68,227,140,254,216,206,116,0,70,27,235,255,104,144,79,0,164,230,93,254,214,135,156,0,154,187,242,254,188,20,131,255,36,109,174,0,159,112,241,0,5,110,149,1,36,165,218,0,166,29,19,1,178,46,73,0,93,43,32,254,248,189,237,0,102,155,141,0,201,93,195,255,241,139,253,255,15,111,98,255,108,65,163,254,155,79,190,255,73,174,193,254,246,40,48,255,107,88,11,254,202,97,85,255,253,204,18,255,113,242,66,0,110,160,194,254,208,18,186,0,81,21,60,0,188,104,167,255,124,166,97,254,210,133,142,0,56,242,137,254,41,111,130,0,111,151,58,1,111,213,141,255,183,172,241,255,38,6,196,255,185,7,123,255,46,11,246,0,245,105,119,1,15,2,161,255,8,206,45,255,18,202,74,255,83,124,115,1,212,141,157,0,83,8,209,254,139,15,232,255,172,54,173,254,50,247,132,0,214,189,213,0,144,184,105,0,223,254,248,0,255,147,240,255,23,188,72,0,7,51,54,0,188,25,180,254,220,180,0,255,83,160,20,0,163,189,243,255,58,209,194,255,87,73,60,0,106,24,49,0,245,249,220,0,22,173,167,0,118,11,195,255,19,126,237,0,110,159,37,255,59,82,47,0,180,187,86,0,188,148,208,1,100,37,133,255,7,112,193,0,129,188,156,255,84,106,129,255,133,225,202,0,14,236,111,255,40,20,101,0,172,172,49,254,51,54,74,255,251,185,184,255,93,155,224,255,180,249,224,1,230,178,146,0,72,57,54,254,178,62,184,0,119,205,72,0,185,239,253,255,61,15,218,0,196,67,56,255,234,32,171,1,46,219,228,0,208,108,234,255,20,63,232,255,165,53,199,1,133,228,5,255,52,205,107,0,74,238,140,255,150,156,219,254,239,172,178,255,251,189,223,254,32,142,211,255,218,15,138,1,241,196,80,0,28,36,98,254,22,234,199,0,61,237,220,255,246,57,37,0,142,17,142,255,157,62,26,0,43,238,95,254,3,217,6,255,213,25,240,1,39,220,174,255,154,205,48,254,19,13,192,255,244,34,54,254,140,16,155,0,240,181,5,254,155,193,60,0,166,128,4,255,36,145,56,255,150,240,219,0,120,51,145,0,82,153,42,1,140,236,146,0,107,92,248,1,189,10,3,0,63,136,242,0,211,39,24,0,19,202,161,1,173,27,186,255,210,204,239,254,41,209,162,255,182,254,159,255,172,116,52,0,195,103,222,254,205,69,59,0,53,22,41,1,218,48,194,0,80,210,242,0,210,188,207,0,187,161,161,254,216,17,1,0,136,225,113,0,250,184,63,0,223,30,98,254,77,168,162,0,59,53,175,0,19,201,10,255,139,224,194,0,147,193,154,255,212,189,12,254,1,200,174,255,50,133,113,1,94,179,90,0,173,182,135,0,94,177,113,0,43,89,215,255,136,252,106,255,123,134,83,254,5,245,66,255,82,49,39,1,220,2,224,0,97,129,177,0,77,59,89,0,61,29,155,1,203,171,220,255,92,78,139,0,145,33,181,255,169,24,141,1,55,150,179,0,139,60,80,255,218,39,97,0,2,147,107,255,60,248,72,0,173,230,47,1,6,83,182,255,16,105,162,254,137,212,81,255,180,184,134,1,39,222,164,255,221,105,251,1,239,112,125,0,63,7,97,0,63,104,227,255,148,58,12,0,90,60,224,255,84,212,252,0,79,215,168,0,248,221,199,1,115,121,1,0,36,172,120,0,32,162,187,255,57,107,49,255,147,42,21,0,106,198,43,1,57,74,87,0,126,203,81,255,129,135,195,0,140,31,177,0,221,139,194,0,3,222,215,0,131,68,231,0,177,86,178,254,124,151,180,0,184,124,38,1,70,163,17,0,249,251,181,1,42,55,227,0,226,161,44,0,23,236,110,0,51,149,142,1,93,5,236,0,218,183,106,254,67,24,77,0,40,245,209,255,222,121,153,0,165,57,30,0,83,125,60,0,70,38,82,1,229,6,188,0,109,222,157,255,55,118,63,255,205,151,186,0,227,33,149,255,254,176,246,1,227,177,227,0,34,106,163,254,176,43,79,0,106,95,78,1,185,241,122,255,185,14,61,0,36,1,202,0,13,178,162,255,247,11,132,0,161,230,92,1,65,1,185,255,212,50,165,1,141,146,64,255,158,242,218,0,21,164,125,0,213,139,122,1,67,71,87,0,203,158,178,1,151,92,43,0,152,111,5,255,39,3,239,255,217,255,250,255,176,63,71,255,74,245,77,1,250,174,18,255,34,49,227,255,246,46,251,255,154,35,48,1,125,157,61,255,106,36,78,255,97,236,153,0,136,187,120,255,113,134,171,255,19,213,217,254,216,94,209,255,252,5,61,0,94,3,202,0,3,26,183,255,64,191,43,255,30,23,21,0,129,141,77,255,102,120,7,1,194,76,140,0,188,175,52,255,17,81,148,0,232,86,55,1,225,48,172,0,134,42,42,255,238,50,47,0,169,18,254,0,20,147,87,255,14,195,239,255,69,247,23,0,238,229,128,255,177,49,112,0,168,98,251,255,121,71,248,0,243,8,145,254,246,227,153,255,219,169,177,254,251,139,165,255,12,163,185,255,164,40,171,255,153,159,27,254,243,109,91,255,222,24,112,1,18,214,231,0,107,157,181,254,195,147,0,255,194,99,104,255,89,140,190,255,177,66,126,254,106,185,66,0,49,218,31,0,252,174,158,0,188,79,230,1,238,41,224,0,212,234,8,1,136,11,181,0,166,117,83,255,68,195,94,0,46,132,201,0,240,152,88,0,164,57,69,254,160,224,42,255,59,215,67,255,119,195,141,255,36,180,121,254,207,47,8,255,174,210,223,0,101,197,68,255,255,82,141,1,250,137,233,0,97,86,133,1,16,80,69,0,132,131,159,0,116,93,100,0,45,141,139,0,152,172,157,255,90,43,91,0,71,153,46,0,39,16,112,255,217,136,97,255,220,198,25,254,177,53,49,0,222,88,134,255,128,15,60,0,207,192,169,255,192,116,209,255,106,78,211,1,200,213,183,255,7,12,122,254,222,203,60,255,33,110,199,254,251,106,117,0,228,225,4,1,120,58,7,255,221,193,84,254,112,133,27,0,189,200,201,255,139,135,150,0,234,55,176,255,61,50,65,0,152,108,169,255,220,85,1,255,112,135,227,0,162,26,186,0,207,96,185,254,244,136,107,0,93,153,50,1,198,97,151,0,110,11,86,255,143,117,174,255,115,212,200,0,5,202,183,0,237,164,10,254,185,239,62,0,236,120,18,254,98,123,99,255,168,201,194,254,46,234,214,0,191,133,49,255,99,169,119,0,190,187,35,1,115,21,45,255,249,131,72,0,112,6,123,255,214,49,181,254,166,233,34,0,92,197,102,254,253,228,205,255,3,59,201,1,42,98,46,0,219,37,35,255,169,195,38,0,94,124,193,1,156,43,223,0,95,72,133,254,120,206,191,0,122,197,239,255,177,187,79,255,254,46,2,1,250,167,190,0,84,129,19,0,203,113,166,255,249,31,189,254,72,157,202,255,208,71,73,255,207,24,72,0,10,16,18,1,210,81,76,255,88,208,192,255,126,243,107,255,238,141,120,255,199,121,234,255,137,12,59,255,36,220,123,255,148,179,60,254,240,12,29,0,66,0,97,1,36,30,38,255,115,1,93,255,96,103,231,255,197,158,59,1,192,164,240,0,202,202,57,255,24,174,48,0,89,77,155,1,42,76,215,0,244,151,233,0,23,48,81,0,239,127,52,254,227,130,37,255,248,116,93,1,124,132,118,0,173,254,192,1,6,235,83,255,110,175,231,1,251,28,182,0,129,249,93,254,84,184,128,0,76,181,62,0,175,128,186,0,100,53,136,254,109,29,226,0,221,233,58,1,20,99,74,0,0,22,160,0,134,13,21,0,9,52,55,255,17,89,140,0,175,34,59,0,84,165,119,255,224,226,234,255,7,72,166,255,123,115,255,1,18,214,246,0,250,7,71,1,217,220,185,0,212,35,76,255,38,125,175,0,189,97,210,0,114,238,44,255,41,188,169,254,45,186,154,0,81,92,22,0,132,160,193,0,121,208,98,255,13,81,44,255,203,156,82,0,71,58,21,255,208,114,191,254,50,38,147,0,154,216,195,0,101,25,18,0,60,250,215,255,233,132,235,255,103,175,142,1,16,14,92,0,141,31,110,254,238,241,45,255,153,217,239,1,97,168,47,255,249,85,16,1,28,175,62,255,57,254,54,0,222,231,126,0,166,45,117,254,18,189,96,255,228,76,50,0,200,244,94,0,198,152,120,1,68,34,69,255,12,65,160,254,101,19,90,0,167,197,120,255,68,54,185,255,41,218,188,0,113,168,48,0,88,105,189,1,26,82,32,255,185,93,164,1,228,240,237,255,66,182,53,0,171,197,92,255,107,9,233,1,199,120,144,255,78,49,10,255,109,170,105,255,90,4,31,255,28,244,113,255,74,58,11,0,62,220,246,255,121,154,200,254,144,210,178,255,126,57,129,1,43,250,14,255,101,111,28,1,47,86,241,255,61,70,150,255,53,73,5,255,30,26,158,0,209,26,86,0,138,237,74,0,164,95,188,0,142,60,29,254,162,116,248,255,187,175,160,0,151,18,16,0,209,111,65,254,203,134,39,255,88,108,49,255,131,26,71,255,221,27,215,254,104,105,93,255,31,236,31,254,135,0,211,255,143,127,110,1,212,73,229,0,233,67,167,254,195,1,208,255,132,17,221,255,51,217,90,0,67,235,50,255,223,210,143,0,179,53,130,1,233,106,198,0,217,173,220,255,112,229,24,255,175,154,93,254,71,203,246,255,48,66,133,255,3,136,230,255,23,221,113,254,235,111,213,0,170,120,95,254,251,221,2,0,45,130,158,254,105,94,217,255,242,52,180,254,213,68,45,255,104,38,28,0,244,158,76,0,161,200,96,255,207,53,13,255,187,67,148,0,170,54,248,0,119,162,178,255,83,20,11,0,42,42,192,1,146,159,163,255,183,232,111,0,77,229,21,255,71,53,143,0,27,76,34,0,246,136,47,255,219,39,182,255,92,224,201,1,19,142,14,255,69,182,241,255,163,118,245,0,9,109,106,1,170,181,247,255,78,47,238,255,84,210,176,255,213,107,139,0,39,38,11,0,72,21,150,0,72,130,69,0,205,77,155,254,142,133,21],"i8",ALLOC_NONE,Runtime.GLOBAL_BASE),allocate([71,111,172,254,226,42,59,255,179,0,215,1,33,128,241,0,234,252,13,1,184,79,8,0,110,30,73,255,246,141,189,0,170,207,218,1,74,154,69,255,138,246,49,255,155,32,100,0,125,74,105,255,90,85,61,255,35,229,177,255,62,125,193,255,153,86,188,1,73,120,212,0,209,123,246,254,135,209,38,255,151,58,44,1,92,69,214,255,14,12,88,255,252,153,166,255,253,207,112,255,60,78,83,255,227,124,110,0,180,96,252,255,53,117,33,254,164,220,82,255,41,1,27,255,38,164,166,255,164,99,169,254,61,144,70,255,192,166,18,0,107,250,66,0,197,65,50,0,1,179,18,255,255,104,1,255,43,153,35,255,80,111,168,0,110,175,168,0,41,105,45,255,219,14,205,255,164,233,140,254,43,1,118,0,233,67,195,0,178,82,159,255,138,87,122,255,212,238,90,255,144,35,124,254,25,140,164,0,251,215,44,254,133,70,107,255,101,227,80,254,92,169,55,0,215,42,49,0,114,180,85,255,33,232,27,1,172,213,25,0,62,176,123,254,32,133,24,255,225,191,62,0,93,70,153,0,181,42,104,1,22,191,224,255,200,200,140,255,249,234,37,0,149,57,141,0,195,56,208,255,254,130,70,255,32,173,240,255,29,220,199,0,110,100,115,255,132,229,249,0,228,233,223,255,37,216,209,254,178,177,209,255,183,45,165,254,224,97,114,0,137,97,168,255,225,222,172,0,165,13,49,1,210,235,204,255,252,4,28,254,70,160,151,0,232,190,52,254,83,248,93,255,62,215,77,1,175,175,179,255,160,50,66,0,121,48,208,0,63,169,209,255,0,210,200,0,224,187,44,1,73,162,82,0,9,176,143,255,19,76,193,255,29,59,167,1,24,43,154,0,28,190,190,0,141,188,129,0,232,235,203,255,234,0,109,255,54,65,159,0,60,88,232,255,121,253,150,254,252,233,131,255,198,110,41,1,83,77,71,255,200,22,59,254,106,253,242,255,21,12,207,255,237,66,189,0,90,198,202,1,225,172,127,0,53,22,202,0,56,230,132,0,1,86,183,0,109,190,42,0,243,68,174,1,109,228,154,0,200,177,122,1,35,160,183,255,177,48,85,255,90,218,169,255,248,152,78,0,202,254,110,0,6,52,43,0,142,98,65,255,63,145,22,0,70,106,93,0,232,138,107,1,110,179,61,255,211,129,218,1,242,209,92,0,35,90,217,1,182,143,106,255,116,101,217,255,114,250,221,255,173,204,6,0,60,150,163,0,73,172,44,255,239,110,80,255,237,76,153,254,161,140,249,0,149,232,229,0,133,31,40,255,174,164,119,0,113,51,214,0,129,228,2,254,64,34,243,0,107,227,244,255,174,106,200,255,84,153,70,1,50,35,16,0,250,74,216,254,236,189,66,255,153,249,13,0,230,178,4,255,221,41,238,0,118,227,121,255,94,87,140,254,254,119,92,0,73,239,246,254,117,87,128,0,19,211,145,255,177,46,252,0,229,91,246,1,69,128,247,255,202,77,54,1,8,11,9,255,153,96,166,0,217,214,173,255,134,192,2,1,0,207,0,0,189,174,107,1,140,134,100,0,158,193,243,1,182,102,171,0,235,154,51,0,142,5,123,255,60,168,89,1,217,14,92,255,19,214,5,1,211,167,254,0,44,6,202,254,120,18,236,255,15,113,184,255,184,223,139,0,40,177,119,254,182,123,90,255,176,165,176,0,247,77,194,0,27,234,120,0,231,0,214,255,59,39,30,0,125,99,145,255,150,68,68,1,141,222,248,0,153,123,210,255,110,127,152,255,229,33,214,1,135,221,197,0,137,97,2,0,12,143,204,255,81,41,188,0,115,79,130,255,94,3,132,0,152,175,187,255,124,141,10,255,126,192,179,255,11,103,198,0,149,6,45,0,219,85,187,1,230,18,178,255,72,182,152,0,3,198,184,255,128,112,224,1,97,161,230,0,254,99,38,255,58,159,197,0,151,66,219,0,59,69,143,255,185,112,249,0,119,136,47,255,123,130,132,0,168,71,95,255,113,176,40,1,232,185,173,0,207,93,117,1,68,157,108,255,102,5,147,254,49,97,33,0,89,65,111,254,247,30,163,255,124,217,221,1,102,250,216,0,198,174,75,254,57,55,18,0,227,5,236,1,229,213,173,0,201,109,218,1,49,233,239,0,30,55,158,1,25,178,106,0,155,111,188,1,94,126,140,0,215,31,238,1,77,240,16,0,213,242,25,1,38,71,168,0,205,186,93,254,49,211,140,255,219,0,180,255,134,118,165,0,160,147,134,255,110,186,35,255,198,243,42,0,243,146,119,0,134,235,163,1,4,241,135,255,193,46,193,254,103,180,79,255,225,4,184,254,242,118,130,0,146,135,176,1,234,111,30,0,69,66,213,254,41,96,123,0,121,94,42,255,178,191,195,255,46,130,42,0,117,84,8,255,233,49,214,254,238,122,109,0,6,71,89,1,236,211,123,0,244,13,48,254,119,148,14,0,114,28,86,255,75,237,25,255,145,229,16,254,129,100,53,255,134,150,120,254,168,157,50,0,23,72,104,255,224,49,14,0,255,123,22,255,151,185,151,255,170,80,184,1,134,182,20,0,41,100,101,1,153,33,16,0,76,154,111,1,86,206,234,255,192,160,164,254,165,123,93,255,1,216,164,254,67,17,175,255,169,11,59,255,158,41,61,255,73,188,14,255,195,6,137,255,22,147,29,255,20,103,3,255,246,130,227,255,122,40,128,0,226,47,24,254,35,36,32,0,152,186,183,255,69,202,20,0,195,133,195,0,222,51,247,0,169,171,94,1,183,0,160,255,64,205,18,1,156,83,15,255,197,58,249,254,251,89,110,255,50,10,88,254,51,43,216,0,98,242,198,1,245,151,113,0,171,236,194,1,197,31,199,255,229,81,38,1,41,59,20,0,253,104,230,0,152,93,14,255,246,242,146,254,214,169,240,255,240,102,108,254,160,167,236,0,154,218,188,0,150,233,202,255,27,19,250,1,2,71,133,255,175,12,63,1,145,183,198,0,104,120,115,255,130,251,247,0,17,212,167,255,62,123,132,255,247,100,189,0,155,223,152,0,143,197,33,0,155,59,44,255,150,93,240,1,127,3,87,255,95,71,207,1,167,85,1,255,188,152,116,255,10,23,23,0,137,195,93,1,54,98,97,0,240,0,168,255,148,188,127,0,134,107,151,0,76,253,171,0,90,132,192,0,146,22,54,0,224,66,54,254,230,186,229,255,39,182,196,0,148,251,130,255,65,131,108,254,128,1,160,0,169,49,167,254,199,254,148,255,251,6,131,0,187,254,129,255,85,82,62,0,178,23,58,255,254,132,5,0,164,213,39,0,134,252,146,254,37,53,81,255,155,134,82,0,205,167,238,255,94,45,180,255,132,40,161,0,254,111,112,1,54,75,217,0,179,230,221,1,235,94,191,255,23,243,48,1,202,145,203,255,39,118,42,255,117,141,253,0,254,0,222,0,43,251,50,0,54,169,234,1,80,68,208,0,148,203,243,254,145,7,135,0,6,254,0,0,252,185,127,0,98,8,129,255,38,35,72,255,211,36,220,1,40,26,89,0,168,64,197,254,3,222,239,255,2,83,215,254,180,159,105,0,58,115,194,0,186,116,106,255,229,247,219,255,129,118,193,0,202,174,183,1,166,161,72,0,201,107,147,254,237,136,74,0,233,230,106,1,105,111,168,0,64,224,30,1,1,229,3,0,102,151,175,255,194,238,228,255,254,250,212,0,187,237,121,0,67,251,96,1,197,30,11,0,183,95,204,0,205,89,138,0,64,221,37,1,255,223,30,255,178,48,211,255,241,200,90,255,167,209,96,255,57,130,221,0,46,114,200,255,61,184,66,0,55,182,24,254,110,182,33,0,171,190,232,255,114,94,31,0,18,221,8,0,47,231,254,0,255,112,83,0,118,15,215,255,173,25,40,254,192,193,31,255,238,21,146,255,171,193,118,255,101,234,53,254,131,212,112,0,89,192,107,1,8,208,27,0,181,217,15,255,231,149,232,0,140,236,126,0,144,9,199,255,12,79,181,254,147,182,202,255,19,109,182,255,49,212,225,0,74,163,203,0,175,233,148,0,26,112,51,0,193,193,9,255,15,135,249,0,150,227,130,0,204,0,219,1,24,242,205,0,238,208,117,255,22,244,112,0,26,229,34,0,37,80,188,255,38,45,206,254,240,90,225,255,29,3,47,255,42,224,76,0,186,243,167,0,32,132,15,255,5,51,125,0,139,135,24,0,6,241,219,0,172,229,133,255,246,214,50,0,231,11,207,255,191,126,83,1,180,163,170,255,245,56,24,1,178,164,211,255,3,16,202,1,98,57,118,255,141,131,89,254,33,51,24,0,243,149,91,255,253,52,14,0,35,169,67,254,49,30,88,255,179,27,36,255,165,140,183,0,58,189,151,0,88,31,0,0,75,169,66,0,66,101,199,255,24,216,199,1,121,196,26,255,14,79,203,254,240,226,81,255,94,28,10,255,83,193,240,255,204,193,131,255,94,15,86,0,218,40,157,0,51,193,209,0,0,242,177,0,102,185,247,0,158,109,116,0,38,135,91,0,223,175,149,0,220,66,1,255,86,60,232,0,25,96,37,255,225,122,162,1,215,187,168,255,158,157,46,0,56,171,162,0,232,240,101,1,122,22,9,0,51,9,21,255,53,25,238,255,217,30,232,254,125,169,148,0,13,232,102,0,148,9,37,0,165,97,141,1,228,131,41,0,222,15,243,255,254,18,17,0,6,60,237,1,106,3,113,0,59,132,189,0,92,112,30,0,105,208,213,0,48,84,179,255,187,121,231,254,27,216,109,255,162,221,107,254,73,239,195,255,250,31,57,255,149,135,89,255,185,23,115,1,3,163,157,255,18,112,250,0,25,57,187,255,161,96,164,0,47,16,243,0,12,141,251,254,67,234,184,255,41,18,161,0,175,6,96,255,160,172,52,254,24,176,183,255,198,193,85,1,124,121,137,255,151,50,114,255,220,203,60,255,207,239,5,1,0,38,107,255,55,238,94,254,70,152,94,0,213,220,77,1,120,17,69,255,85,164,190,255,203,234,81,0,38,49,37,254,61,144,124,0,137,78,49,254,168,247,48,0,95,164,252,0,105,169,135,0,253,228,134,0,64,166,75,0,81,73,20,255,207,210,10,0,234,106,150,255,94,34,90,255,254,159,57,254,220,133,99,0,139,147,180,254,24,23,185,0,41,57,30,255,189,97,76,0,65,187,223,255,224,172,37,255,34,62,95,1,231,144,240,0,77,106,126,254,64,152,91,0,29,98,155,0,226,251,53,255,234,211,5,255,144,203,222,255,164,176,221,254,5,231,24,0,179,122,205,0,36,1,134,255,125,70,151,254,97,228,252,0,172,129,23,254,48,90,209,255,150,224,82,1,84,134,30,0,241,196,46,0,103,113,234,255,46,101,121,254,40,124,250,255,135,45,242,254,9,249,168,255,140,108,131,255,143,163,171,0,50,173,199,255,88,222,142,255,200,95,158,0,142,192,163,255,7,117,135,0,111,124,22,0,236,12,65,254,68,38,65,255,227,174,254,0,244,245,38,0,240,50,208,255,161,63,250,0,60,209,239,0,122,35,19,0,14,33,230,254,2,159,113,0,106,20,127,255,228,205,96,0,137,210,174,254,180,212,144,255,89,98,154,1,34,88,139,0,167,162,112,1,65,110,197,0,241,37,169,0,66,56,131,255,10,201,83,254,133,253,187,255,177,112,45,254,196,251,0,0,196,250,151,255,238,232,214,255,150,209,205,0,28,240,118,0,71,76,83,1,236,99,91,0,42,250,131,1,96,18,64,255,118,222,35,0,113,214,203,255,122,119,184,255,66,19,36,0,204,64,249,0,146,89,139,0,134,62,135,1,104,233,101,0,188,84,26,0,49,249,129,0,208,214,75,255,207,130,77,255,115,175,235,0,171,2,137,255,175,145,186,1,55,245,135,255,154,86,181,1,100,58,246,255,109,199,60,255,82,204,134,255,215,49,230,1,140,229,192,255,222,193,251,255,81,136,15,255,179,149,162,255,23,39,29,255,7,95,75,254,191,81,222,0,241,81,90,255,107,49,201,255,244,211,157,0,222,140,149,255,65,219,56,254,189,246,90,255,178,59,157,1,48,219,52,0,98,34,215,0,28,17,187,255,175,169,24,0,92,79,161,255,236,200,194,1,147,143,234,0,229,225,7,1,197,168,14,0,235,51,53,1,253,120,174,0,197,6,168,255,202,117,171,0,163,21,206,0,114,85,90,255,15,41,10,255,194,19,99,0,65,55,216,254,162,146,116,0,50,206,212,255,64,146,29,255,158,158,131,1,100,165,130,255,172,23,129,255,125,53,9,255,15,193,18,1,26,49,11,255,181,174,201,1,135,201,14,255,100,19,149,0,219,98,79,0,42,99,143,254,96,0,48,255,197,249,83,254,104,149,79,255,235,110,136,254,82,128,44,255,65,41,36,254,88,211,10,0,187,121,187,0,98,134,199,0,171,188,179,254,210,11,238,255,66,123,130,254,52,234,61,0,48,113,23,254,6,86,120,255,119,178,245,0,87,129,201,0,242,141,209,0,202,114,85,0,148,22,161,0,103,195,48,0,25,49,171,255,138,67,130,0,182,73,122,254,148,24,130,0,211,229,154,0,32,155,158,0,84,105,61,0,177,194,9,255,166,89,86,1,54,83,187,0,249,40,117,255,109,3,215,255,53,146,44,1,63,47,179,0,194,216,3,254,14,84,136,0,136,177,13,255,72,243,186,255,117,17,125,255,211,58,211,255,93,79,223,0,90,88,245,255,139,209,111,255,70,222,47,0,10,246,79,255,198,217,178,0,227,225,11,1,78,126,179,255,62,43,126,0,103,148,35,0,129,8,165,254,245,240,148,0,61,51,142,0,81,208,134,0,15,137,115,255,211,119,236,255,159,245,248,255,2,134,136,255,230,139,58,1,160,164,254,0,114,85,141,255,49,166,182,255,144,70,84,1,85,182,7,0,46,53,93,0,9,166,161,255,55,162,178,255,45,184,188,0,146,28,44,254,169,90,49,0,120,178,241,1,14,123,127,255,7,241,199,1,189,66,50,255,198,143,101,254,189,243,135,255,141,24,24,254,75,97,87,0,118,251,154,1,237,54,156,0,171,146,207,255,131,196,246,255,136,64,113,1,151,232,57,0,240,218,115,0,49,61,27,255,64,129,73,1,252,169,27,255,40,132,10,1,90,201,193,255,252,121,240,1,186,206,41,0,43,198,97,0,145,100,183,0,204,216,80,254,172,150,65,0,249,229,196,254,104,123,73,255,77,104,96,254,130,180,8,0,104,123,57,0,220,202,229,255,102,249,211,0,86,14,232,255,182,78,209,0,239,225,164,0,106,13,32,255,120,73,17,255,134,67,233,0,83,254,181,0,183,236,112,1,48,64,131,255,241,216,243,255,65,193,226,0,206,241,100,254,100,134,166,255,237,202,197,0,55,13,81,0,32,124,102,255,40,228,177,0,118,181,31,1,231,160,134,255,119,187,202,0,0,142,60,255,128,38,189,255,166,201,150,0,207,120,26,1,54,184,172,0,12,242,204,254,133,66,230,0,34,38,31,1,184,112,80,0,32,51,165,254,191,243,55,0,58,73,146,254,155,167,205,255,100,104,152,255,197,254,207,255,173,19,247,0,238,10,202,0,239,151,242,0,94,59,39,255,240,29,102,255,10,92,154,255,229,84,219,255,161,129,80,0,208,90,204,1,240,219,174,255,158,102,145,1,53,178,76,255,52,108,168,1,83,222,107,0,211,36,109,0,118,58,56,0,8,29,22,0,237,160,199,0,170,209,157,0,137,71,47,0,143,86,32,0,198,242,2,0,212,48,136,1,92,172,186,0,230,151,105,1,96,191,229,0,138,80,191,254,240,216,130,255,98,43,6,254,168,196,49,0,253,18,91,1,144,73,121,0,61,146,39,1,63,104,24,255,184,165,112,254,126,235,98,0,80,213,98,255,123,60,87,255,82,140,245,1,223,120,173,255,15,198,134,1,206,60,239,0,231,234,92,255,33,238,19,255,165,113,142,1,176,119,38,0,160,43,166,254,239,91,105,0,107,61,194,1,25,4,68,0,15,139,51,0,164,132,106,255,34,116,46,254,168,95,197,0,137,212,23,0,72,156,58,0,137,112,69,254,150,105,154,255,236,201,157,0,23,212,154,255,136,82,227,254,226,59,221,255,95,149,192,0,81,118,52,255,33,43,215,1,14,147,75,255,89,156,121,254,14,18,79,0,147,208,139,1,151,218,62,255,156,88,8,1,210,184,98,255,20,175,123,255,102,83,229,0,220,65,116,1,150,250,4,255,92,142,220,255,34,247,66,255,204,225,179,254,151,81,151,0,71,40,236,255,138,63,62,0,6,79,240,255,183,185,181,0,118,50,27,0,63,227,192,0,123,99,58,1,50,224,155,255,17,225,223,254,220,224,77,255,14,44,123,1,141,128,175,0,248,212,200,0,150,59,183,255,147,97,29,0,150,204,181,0,253,37,71,0,145,85,119,0,154,200,186,0,2,128,249,255,83,24,124,0,14,87,143,0,168,51,245,1,124,151,231,255,208,240,197,1,124,190,185,0,48,58,246,0,20,233,232,0,125,18,98,255,13,254,31,255,245,177,130,255,108,142,35,0,171,125,242,254,140,12,34,255,165,161,162,0,206,205,101,0,247,25,34,1,100,145,57,0,39,70,57,0,118,204,203,255,242,0,162,0,165,244,30,0,198,116,226,0,128,111,153,255,140,54,182,1,60,122,15,255,155,58,57,1,54,50,198,0,171,211,29,255,107,138,167,255,173,107,199,255,109,161,193,0,89,72,242,255,206,115,89,255,250,254,142,254,177,202,94,255,81,89,50,0,7,105,66,255,25,254,255,254,203,64,23,255,79,222,108,255,39,249,75,0,241,124,50,0,239,152,133,0,221,241,105,0,147,151,98,0,213,161,121,254,242,49,137,0,233,37,249,254,42,183,27,0,184,119,230,255,217,32,163,255,208,251,228,1,137,62,131,255,79,64,9,254,94,48,113,0,17,138,50,254,193,255,22,0,247,18,197,1,67,55,104,0,16,205,95,255,48,37,66,0,55,156,63,1,64,82,74,255,200,53,71,254,239,67,125,0,26,224,222,0,223,137,93,255,30,224,202,255,9,220,132,0,198,38,235,1,102,141,86,0,60,43,81,1,136,28,26,0,233,36,8,254,207,242,148,0,164,162,63,0,51,46,224,255,114,48,79,255,9,175,226,0,222,3,193,255,47,160,232,255,255,93,105,254,14,42,230,0,26,138,82,1,208,43,244,0,27,39,38,255,98,208,127,255,64,149,182,255,5,250,209,0,187,60,28,254,49,25,218,255,169,116,205,255,119,18,120,0,156,116,147,255,132,53,109,255,13,10,202,0,110,83,167,0,157,219,137,255,6,3,130,255,50,167,30,255,60,159,47,255,129,128,157,254,94,3,189,0,3,166,68,0,83,223,215,0,150,90,194,1,15,168,65,0,227,83,51,255,205,171,66,255,54,187,60,1,152,102,45,255,119,154,225,0,240,247,136,0,100,197,178,255,139,71,223,255,204,82,16,1,41,206,42,255,156,192,221,255,216,123,244,255,218,218,185,255,187,186,239,255,252,172,160,255,195,52,22,0,144,174,181,254,187,100,115,255,211,78,176,255,27,7,193,0,147,213,104,255,90,201,10,255,80,123,66,1,22,33,186,0,1,7,99,254,30,206,10,0,229,234,5,0,53,30,210,0,138,8,220,254,71,55,167,0,72,225,86,1,118,190,188,0,254,193,101,1,171,249,172,255,94,158,183,254,93,2,108,255,176,93,76,255,73,99,79,255,74,64,129,254,246,46,65,0,99,241,127,254,246,151,102,255,44,53,208,254,59,102,234,0,154,175,164,255,88,242,32,0,111,38,1,0,255,182,190,255,115,176,15,254,169,60,129,0,122,237,241,0,90,76,63,0,62,74,120,255,122,195,110,0,119,4,178,0,222,242,210,0,130,33,46,254,156,40,41,0,167,146,112,1,49,163,111,255,121,176,235,0,76,207,14,255,3,25,198,1,41,235,213,0,85,36,214,1,49,92,109,255,200,24,30,254,168,236,195,0,145,39,124,1,236,195,149,0,90,36,184,255,67,85,170,255,38,35,26,254,131,124,68,255,239,155,35,255,54,201,164,0,196,22,117,255,49,15,205,0,24,224,29,1,126,113,144,0,117,21,182,0,203,159,141,0,223,135,77,0,176,230,176,255,190,229,215,255,99,37,181,255,51,21,138,255,25,189,89,255,49,48,165,254,152,45,247,0,170,108,222,0,80,202,5,0,27,69,103,254,204,22,129,255,180,252,62,254,210,1,91,255,146,110,254,255,219,162,28,0,223,252,213,1,59,8,33,0,206,16,244,0,129,211,48,0,107,160,208,0,112,59,209,0,109,77,216,254,34,21,185,255,246,99,56,255,179,139,19,255,185,29,50,255,84,89,19,0,74,250,98,255,225,42,200,255,192,217,205,255,210,16,167,0,99,132,95,1,43,230,57,0,254,11,203,255,99,188,63,255,119,193,251,254,80,105,54,0,232,181,189,1,183,69,112,255,208,171,165,255,47,109,180,255,123,83,165,0,146,162,52,255,154,11,4,255,151,227,90,255,146,137,97,254,61,233,41,255,94,42,55,255,108,164,236,0,152,68,254,0,10,140,131,255,10,106,79,254,243,158,137,0,67,178,66,254,177,123,198,255,15,62,34,0,197,88,42,255,149,95,177,255,152,0,198,255,149,254,113,255,225,90,163,255,125,217,247,0,18,17,224,0,128,66,120,254,192,25,9,255,50,221,205,0,49,212,70,0,233,255,164,0,2,209,9,0,221,52,219,254,172,224,244,255,94,56,206,1,242,179,2,255,31,91,164,1,230,46,138,255,189,230,220,0,57,47,61,255,111,11,157,0,177,91,152,0,28,230,98,0,97,87,126,0,198,89,145,255,167,79,107,0,249,77,160,1,29,233,230,255,150,21,86,254,60,11,193,0,151,37,36,254,185,150,243,255,228,212,83,1,172,151,180,0,201,169,155,0,244,60,234,0,142,235,4,1,67,218,60,0,192,113,75,1,116,243,207,255,65,172,155,0,81,30,156,255,80,72,33,254,18,231,109,255,142,107,21,254,125,26,132,255,176,16,59,255,150,201,58,0,206,169,201,0,208,121,226,0,40,172,14,255,150,61,94,255,56,57,156,255,141,60,145,255,45,108,149,255,238,145,155,255,209,85,31,254,192,12,210,0,99,98,93,254,152,16,151,0,225,185,220,0,141,235,44,255,160,172,21,254,71,26,31,255,13,64,93,254,28,56,198,0,177,62,248,1,182,8,241,0,166,101,148,255,78,81,133,255,129,222,215,1,188,169,129,255,232,7,97,0,49,112,60,255,217,229,251,0,119,108,138,0,39,19,123,254,131,49,235,0,132,84,145,0,130,230,148,255,25,74,187,0,5,245,54,255,185,219,241,1,18,194,228,255,241,202,102,0,105,113,202,0,155,235,79,0,21,9,178,255,156,1,239,0,200,148,61,0,115,247,210,255,49,221,135,0,58,189,8,1,35,46,9,0,81,65,5,255,52,158,185,255,125,116,46,255,74,140,13,255,210,92,172,254,147,23,71,0,217,224,253,254,115,108,180,255,145,58,48,254,219,177,24,255,156,255,60,1,154,147,242,0,253,134,87,0,53,75,229,0,48,195,222,255,31,175,50,255,156,210,120,255,208,35,222,255,18,248,179,1,2,10,101,255,157,194,248,255,158,204,101,255,104,254,197,255,79,62,4,0,178,172,101,1,96,146,251,255,65,10,156,0,2,137,165,255,116,4,231,0,242,215,1,0,19,35,29,255,43,161,79,0,59,149,246,1,251,66,176,0,200,33,3,255,80,110,142,255,195,161,17,1,228,56,66,255,123,47,145,254,132,4,164,0,67,174,172,0,25,253,114,0,87,97,87,1,250,220,84,0,96,91,200,255,37,125,59,0,19,65,118,0,161,52,241,255,237,172,6,255,176,191,255,255,1,65,130,254,223,190,230,0,101,253,231,255,146,35,109,0,250,29,77,1,49,0,19,0,123,90,155,1,22,86,32,255,218,213,65,0,111,93,127,0,60,93,169,255,8,127,182,0,17,186,14,254,253,137,246,255,213,25,48,254,76,238,0,255,248,92,70,255,99,224,139,0,184,9,255,1,7,164,208,0,205,131,198,1,87,214,199,0,130,214,95,0,221,149,222,0,23,38,171,254,197,110,213,0,43,115,140,254,215,177,118,0,96,52,66,1,117,158,237,0,14,64,182,255,46,63,174,255,158,95,190,255,225,205,177,255,43,5,142,255,172,99,212,255,244,187,147,0,29,51,153,255,228,116,24,254,30,101,207,0,19,246,150,255,134,231,5,0,125,134,226,1,77,65,98,0,236,130,33,255,5,110,62,0,69,108,127,255,7,113,22,0,145,20,83,254,194,161,231,255,131,181,60,0,217,209,177,255,229,148,212,254,3,131,184,0,117,177,187,1,28,14,31,255,176,102,80,0,50,84,151,255,125,31,54,255,21,157,133,255,19,179,139,1,224,232,26,0,34,117,170,255,167,252,171,255,73,141,206,254,129,250,35,0,72,79,236,1,220,229,20,255,41,202,173,255,99,76,238,255,198,22,224,255,108,198,195,255,36,141,96,1,236,158,59,255,106,100,87,0,110,226,2,0,227,234,222,0,154,93,119,255,74,112,164,255,67,91,2,255,21,145,33,255,102,214,137,255,175,230,103,254,163,246,166,0,93,247,116,254,167,224,28,255,220,2,57,1,171,206,84,0,123,228,17,255,27,120,119,0,119,11,147,1,180,47,225,255,104,200,185,254,165,2,114,0,77,78,212,0,45,154,177,255,24,196,121,254,82,157,182,0,90,16,190,1,12,147,197,0,95,239,152,255,11,235,71,0,86,146,119,255,172,134,214,0,60,131,196,0,161,225,129,0,31,130,120,254,95,200,51,0,105,231,210,255,58,9,148,255,43,168,221,255,124,237,142,0,198,211,50,254,46,245,103,0,164,248,84,0,152,70,208,255,180,117,177,0,70,79,185,0,243,74,32,0,149,156,207,0,197,196,161,1,245,53,239,0,15,93,246,254,139,240,49,255,196,88,36,255,162,38,123,0,128,200,157,1,174,76,103,255,173,169,34,254,216,1,171,255,114,51,17,0,136,228,194,0,110,150,56,254,106,246,159,0,19,184,79,255,150,77,240,255,155,80,162,0,0,53,169,255,29,151,86,0,68,94,16,0,92,7,110,254,98,117,149,255,249,77,230,255,253,10,140,0,214,124,92,254,35,118,235,0,89,48,57,1,22,53,166,0,184,144,61,255,179,255,194,0,214,248,61,254,59,110,246,0,121,21,81,254,166,3,228,0,106,64,26,255,69,232,134,255,242,220,53,254,46,220,85,0,113,149,247,255,97,179,103,255,190,127,11,0,135,209,182,0,95,52,129,1,170,144,206,255,122,200,204,255,168,100,146,0,60,144,149,254,70,60,40,0,122,52,177,255,246,211,101,255,174,237,8,0,7,51,120,0,19,31,173,0,126,239,156,255,143,189,203,0,196,128,88,255,233,133,226,255,30,125,173,255,201,108,50,0,123,100,59,255,254,163,3,1,221,148,181,255,214,136,57,254,222,180,137,255,207,88,54,255,28,33,251,255,67,214,52,1,210,208,100,0,81,170,94,0,145,40,53,0,224,111,231,254,35,28,244,255,226,199,195,254,238,17,230,0,217,217,164,254,169,157,221,0,218,46,162,1,199,207,163,255,108,115,162,1,14,96,187,255,118,60,76,0,184,159,152,0,209,231,71,254,42,164,186,255,186,153,51,254,221,171,182,255,162,142,173,0,235,47,193,0,7,139,16,1,95,164,64,255,16,221,166,0,219,197,16,0,132,29,44,255,100,69,117,255,60,235,88,254,40,81,173,0,71,190,61,255,187,88,157,0,231,11,23,0,237,117,164,0,225,168,223,255,154,114,116,255,163,152,242,1,24,32,170,0,125,98,113,254,168,19,76,0,17,157,220,254,155,52,5,0,19,111,161,255,71,90,252,255,173,110,240,0,10,198,121,255,253,255,240,255,66,123,210,0,221,194,215,254,121,163,17,255,225,7,99,0,190,49,182,0,115,9,133,1,232,26,138,255,213,68,132,0,44,119,122,255,179,98,51,0,149,90,106,0,71,50,230,255,10,153,118,255,177,70,25,0,165,87,205,0,55,138,234,0,238,30,97,0,113,155,207,0,98,153,127,0,34,107,219,254,117,114,172,255,76,180,255,254,242,57,179,255,221,34,172,254,56,162,49,255,83,3,255,255,113,221,189,255,188,25,228,254,16,88,89,255,71,28,198,254,22,17,149,255,243,121,254,255,107,202,99,255,9,206,14,1,220,47,153,0,107,137,39,1,97,49,194,255,149,51,197,254,186,58,11,255,107,43,232,1,200,6,14,255,181,133,65,254,221,228,171,255,123,62,231,1,227,234,179,255,34,189,212,254,244,187,249,0,190,13,80,1,130,89,1,0,223,133,173,0,9,222,198,255,66,127,74,0,167,216,93,255,155,168,198,1,66,145,0,0,68,102,46,1,172,90,154,0,216,128,75,255,160,40,51,0,158,17,27,1,124,240,49,0,236,202,176,255,151,124,192,255,38,193,190,0,95,182,61,0,163,147,124,255,255,165,51,255,28,40,17,254,215,96,78,0,86,145,218,254,31,36,202,255,86,9,5,0,111,41,200,255,237,108,97,0,57,62,44,0,117,184,15,1,45,241,116,0,152,1,220,255,157,165,188,0,250,15,131,1,60,44,125,255,65,220,251,255,75,50,184,0,53,90,128,255,231,80,194,255,136,129,127,1,21,18,187,255,45,58,161,255,71,147,34,0,174,249,11,254,35,141,29,0,239,68,177,255,115,110,58,0,238,190,177,1,87,245,166,255,190,49,247,255,146,83,184,255,173,14,39,255,146,215,104,0,142,223,120,0,149,200,155,255,212,207,145,1,16,181,217,0,173,32,87,255,255,35,181,0,119,223,161,1,200,223,94,255,70,6,186,255,192,67,85,255,50,169,152,0,144,26,123,255,56,243,179,254,20,68,136,0,39,140,188,254,253,208,5,255,200,115,135,1,43,172,229,255,156,104,187,0,151,251,167,0,52,135,23,0,151,153,72,0,147,197,107,254,148,158,5,255,238,143,206,0,126,153,137,255,88,152,197,254,7,68,167,0,252,159,165,255,239,78,54,255,24,63,55,255,38,222,94,0,237,183,12,255,206,204,210,0,19,39,246,254,30,74,231,0,135,108,29,1,179,115,0,0,117,118,116,1,132,6,252,255,145,129,161,1,105,67,141,0,82,37,226,255,238,226,228,255,204,214,129,254,162,123,100,255,185,121,234,0,45,108,231,0,66,8,56,255,132,136,128,0,172,224,66,254,175,157,188,0,230,223,226,254,242,219,69,0,184,14,119,1,82,162,56,0,114,123,20,0,162,103,85,255,49,239,99,254,156,135,215,0,111,255,167,254,39,196,214,0,144,38,79,1,249,168,125,0,155,97,156,255,23,52,219,255,150,22,144,0,44,149,165,255,40,127,183,0,196,77,233,255,118,129,210,255,170,135,230,255,214,119,198,0,233,240,35,0,253,52,7,255,117,102,48,255,21,204,154,255,179,136,177,255,23,2,3,1,149,130,89,255,252,17,159,1,70,60,26,0,144,107,17,0,180,190,60,255,56,182,59,255,110,71,54,255,198,18,129,255,149,224,87,255,223,21,152,255,138,22,182,255,250,156,205,0,236,45,208,255,79,148,242,1,101,70,209,0,103,78,174,0,101,144,172,255,152,136,237,1,191,194,136,0,113,80,125,1,152,4,141,0,155,150,53,255,196,116,245,0,239,114,73,254,19,82,17,255,124,125,234,255,40,52,191,0,42,210,158,255,155,132,165,0,178,5,42,1,64,92,40,255,36,85,77,255,178,228,118,0,137,66,96,254,115,226,66,0,110,240,69,254,151,111,80,0,167,174,236,255,227,108,107,255,188,242,65,255,183,81,255,0,57,206,181,255,47,34,181,255,213,240,158,1,71,75,95,0,156,40,24,255,102,210,81,0,171,199,228,255,154,34,41,0,227,175,75,0,21,239,195,0,138,229,95,1,76,192,49,0,117,123,87,1,227,225,130,0,125,62,63,255,2,198,171,0,254,36,13,254,145,186,206,0,148,255,244,255,35,0,166,0,30,150,219,1,92,228,212,0,92,198,60,254,62,133,200,255,201,41,59,0,125,238,109,255,180,163,238,1,140,122,82,0,9,22,88,255,197,157,47,255,153,94,57,0,88,30,182,0,84,161,85,0,178,146,124,0,166,166,7,255,21,208,223,0,156,182,242,0,155,121,185,0,83,156,174,254,154,16,118,255,186,83,232,1,223,58,121,255,29,23,88,0,35,125,127,255,170,5,149,254,164,12,130,255,155,196,29,0,161,96,136,0,7,35,29,1,162,37,251,0,3,46,242,255,0,217,188,0,57,174,226,1,206,233,2,0,57,187,136,254,123,189,9,255,201,117,127,255,186,36,204,0,231,25,216,0,80,78,105,0,19,134,129,255,148,203,68,0,141,81,125,254,248,165,200,255,214,144,135,0,151,55,166,255,38,235,91,0,21,46,154,0,223,254,150,255,35,153,180,255,125,176,29,1,43,98,30,255,216,122,230,255,233,160,12,0,57,185,12,254,240,113,7,255,5,9,16,254,26,91,108,0,109,198,203,0,8,147,40,0,129,134,228,255,124,186,40,255,114,98,132,254,166,132,23,0,99,69,44,0,9,242,238,255,184,53,59,0,132,129,102,255,52,32,243,254,147,223,200,255,123,83,179,254,135,144,201,255,141,37,56,1,151,60,227,255,90,73,156,1,203,172,187,0,80,151,47,255,94,137,231,255,36,191,59,255,225,209,181,255,74,215,213,254,6,118,179,255,153,54,193,1,50,0,231,0,104,157,72,1,140,227,154,255,182,226,16,254,96,225,92,255,115,20,170,254,6,250,78,0,248,75,173,255,53,89,6,255,0,180,118,0,72,173,1,0,64,8,206,1,174,133,223,0,185,62,133,255,214,11,98,0,197,31,208,0,171,167,244,255,22,231,181,1,150,218,185,0,247,169,97,1,165,139,247,255,47,120,149,1,103,248,51,0,60,69,28,254,25,179,196,0,124,7,218,254,58,107,81,0,184,233,156,255,252,74,36,0,118,188,67,0,141,95,53,255,222,94,165,254,46,61,53,0,206,59,115,255,47,236,250,255,74,5,32,1,129,154,238,255,106,32,226,0,121,187,61,255,3,166,241,254,67,170,172,255,29,216,178,255,23,201,252,0,253,110,243,0,200,125,57,0,109,192,96,255,52,115,238,0,38,121,243,255,201,56,33,0,194,118,130,0,75,96,25,255,170,30,230,254,39,63,253,0,36,45,250,255,251,1,239,0,160,212,92,1,45,209,237,0,243,33,87,254,237,84,201,255,212,18,157,254,212,99,127,255,217,98,16,254,139,172,239,0,168,201,130,255,143,193,169,255,238,151,193,1,215,104,41,0,239,61,165,254,2,3,242,0,22,203,177,254,177,204,22,0,149,129,213,254,31,11,41,255,0,159,121,254,160,25,114,255,162,80,200,0,157,151,11,0,154,134,78,1,216,54,252,0,48,103,133,0,105,220,197,0,253,168,77,254,53,179,23,0,24,121,240,1,255,46,96,255,107,60,135,254,98,205,249,255,63,249,119,255,120,59,211,255,114,180,55,254,91,85,237,0,149,212,77,1,56,73,49,0,86,198,150,0,93,209,160,0,69,205,182,255,244,90,43,0,20,36,176,0,122,116,221,0,51,167,39,1,231,1,63,255,13,197,134,0,3,209,34,255,135,59,202,0,167,100,78,0,47,223,76,0,185,60,62,0,178,166,123,1,132,12,161,255,61,174,43,0,195,69,144,0,127,47,191,1,34,44,78,0,57,234,52,1,255,22,40,255,246,94,146,0,83,228,128,0,60,78,224,255,0,96,210,255,153,175,236,0,159,21,73,0,180,115,196,254,131,225,106,0,255,167,134,0,159,8,112,255,120,68,194,255,176,196,198,255,118,48,168,255,93,169,1,0,112,200,102,1,74,24,254,0,19,141,4,254,142,62,63,0,131,179,187,255,77,156,155,255,119,86,164,0,170,208,146,255,208,133,154,255,148,155,58,255,162,120,232,254,252,213,155,0,241,13,42,0,94,50,131,0,179,170,112,0,140,83,151,255,55,119,84,1,140,35,239,255,153,45,67,1,236,175,39,0,54,151,103,255,158,42,65,255,196,239,135,254,86,53,203,0,149,97,47,254,216,35,17,255,70,3,70,1,103,36,90,255,40,26,173,0,184,48,13,0,163,219,217,255,81,6,1,255,221,170,108,254,233,208,93,0,100,201,249,254,86,36,35,255,209,154,30,1,227,201,251,255,2,189,167,254,100,57,3,0,13,128,41,0,197,100,75,0,150,204,235,255,145,174,59,0,120,248,149,255,85,55,225,0,114,210,53,254,199,204,119,0,14,247,74,1,63,251,129,0,67,104,151,1,135,130,80,0,79,89,55,255,117,230,157,255,25,96,143,0,213,145,5,0,69,241,120,1,149,243,95,255,114,42,20,0,131,72,2,0,154,53,20,255,73,62,109,0,196,102,152,0,41,12,204,255,122,38,11,1,250,10,145,0,207,125,148,0,246,244,222,255,41,32,85,1,112,213,126,0,162,249,86,1,71,198,127,255,81,9,21,1,98,39,4,255,204,71,45,1,75,111,137,0,234,59,231,0,32,48,95,255,204,31,114,1,29,196,181,255,51,241,167,254,93,109,142,0,104,144,45,0,235,12,181,255,52,112,164,0,76,254,202,255,174,14,162,0,61,235,147,255,43,64,185,254,233,125,217,0,243,88,167,254,74,49,8,0,156,204,66,0,124,214,123,0,38,221,118,1,146,112,236,0,114,98,177,0,151,89,199,0,87,197,112,0,185,149,161,0,44,96,165,0,248,179,20,255,188,219,216,254,40,62,13,0,243,142,141,0,229,227,206,255,172,202,35,255,117,176,225,255,82,110,38,1,42,245,14,255,20,83,97,0,49,171,10,0,242,119,120,0,25,232,61,0,212,240,147,255,4,115,56,255,145,17,239,254,202,17,251,255,249,18,245,255,99,117,239,0,184,4,179,255,246,237,51,255,37,239,137,255,166,112,166,255,81,188,33,255,185,250,142,255,54,187,173,0,208,112,201,0,246,43,228,1,104,184,88,255,212,52,196,255,51,117,108,255,254,117,155,0,46,91,15,255,87,14,144,255,87,227,204,0,83,26,83,1,159,76,227,0,159,27,213,1,24,151,108,0,117,144,179,254,137,209,82,0,38,159,10,0,115,133,201,0,223,182,156,1,110,196,93,255,57,60,233,0,5,167,105,255,154,197,164,0,96,34,186,255,147,133,37,1,220,99,190,0,1,167,84,255,20,145,171,0,194,197,251,254,95,78,133,255,252,248,243,255,225,93,131,255,187,134,196,255,216,153,170,0,20,118,158,254,140,1,118,0,86,158,15,1,45,211,41,255,147,1,100,254,113,116,76,255,211,127,108,1,103,15,48,0,193,16,102,1,69,51,95,255,107,128,157,0,137,171,233,0,90,124,144,1,106,161,182,0,175,76,236,1,200,141,172,255,163,58,104,0,233,180,52,255,240,253,14,255,162,113,254,255,38,239,138,254,52,46,166,0,241,101,33,254,131,186,156,0,111,208,62,255,124,94,160,255,31,172,254,0,112,174,56,255,188,99,27,255,67,138,251,0,125,58,128,1,156,152,174,255,178,12,247,255,252,84,158,0,82,197,14,254,172,200,83,255,37,39,46,1,106,207,167,0,24,189,34,0,131,178,144,0,206,213,4,0,161,226,210,0,72,51,105,255,97,45,187,255,78,184,223,255,176,29,251,0,79,160,86,255,116,37,178,0,82,77,213,1,82,84,141,255,226,101,212,1,175,88,199,255,245,94,247,1,172,118,109,255,166,185,190,0,131,181,120,0,87,254,93,255,134,240,73,255,32,245,143,255,139,162,103,255,179,98,18,254,217,204,112,0,147,223,120,255,53,10,243,0,166,140,150,0,125,80,200,255,14,109,219,255,91,218,1,255,252,252,47,254,109,156,116,255,115,49,127,1,204,87,211,255,148,202,217,255,26,85,249,255,14,245,134,1,76,89,169,255,242,45,230,0,59,98,172,255,114,73,132,254,78,155,49,255,158,126,84,0,49,175,43,255,16,182,84,255,157,103,35,0,104,193,109,255,67,221,154,0,201,172,1,254,8,162,88,0,165,1,29,255,125,155,229,255,30,154,220,1,103,239,92,0,220,1,109,255,202,198,1,0,94,2,142,1,36,54,44,0,235,226,158,255,170,251,214,255,185,77,9,0,97,74,242,0,219,163,149,255,240,35,118,255,223,114,88,254,192,199,3,0,106,37,24,255,201,161,118,255,97,89,99,1,224,58,103,255,101,199,147,254,222,60,99,0,234,25,59,1,52,135,27,0,102,3,91,254,168,216,235,0,229,232,136,0,104,60,129,0,46,168,238,0,39,191,67,0,75,163,47,0,143,97,98,255,56,216,168,1,168,233,252,255,35,111,22,255,92,84,43,0,26,200,87,1,91,253,152,0,202,56,70,0,142,8,77,0,80,10,175,1,252,199,76,0,22,110,82,255,129,1,194,0,11,128,61,1,87,14,145,255,253,222,190,1,15,72,174,0,85,163,86,254,58,99,44,255,45,24,188,254,26,205,15,0,19,229,210,254,248,67,195,0,99,71,184,0,154,199,37,255,151,243,121,255,38,51,75,255,201,85,130,254,44,65,250,0,57,147,243,254,146,43,59,255,89,28,53,0,33,84,24,255,179,51,18,254,189,70,83,0,11,156,179,1,98,134,119,0,158,111,111,0,119,154,73,255,200,63,140,254,45,13,13,255,154,192,2,254,81,72,42,0,46,160,185,254,44,112,6,0,146,215,149,1,26,176,104,0,68,28,87,1,236,50,153,255,179,128,250,254,206,193,191,255,166,92,137,254,53,40,239,0,210,1,204,254,168,173,35,0,141,243,45,1,36,50,109,255,15,242,194,255,227,159,122,255,176,175,202,254,70,57,72,0,40,223,56,0,208,162,58,255,183,98,93,0,15,111,12,0,30,8,76,255,132,127,246,255,45,242,103,0,69,181,15,255,10,209,30,0,3,179,121,0,241,232,218,1,123,199,88,255,2,210,202,1,188,130,81,255,94,101,208,1,103,36,45,0,76,193,24,1,95,26,241,255,165,162,187,0,36,114,140,0,202,66,5,255,37,56,147,0,152,11,243,1,127,85,232,255,250,135,212,1,185,177,113,0,90,220,75,255,69,248,146,0,50,111,50,0,92,22,80,0,244,36,115,254,163,100,82,255,25,193,6,1,127,61,36,0,253,67,30,254,65,236,170,255,161,17,215,254,63,175,140,0,55,127,4,0,79,112,233,0,109,160,40,0,143,83,7,255,65,26,238,255,217,169,140,255,78,94,189,255,0,147,190,255,147,71,186,254,106,77,127,255,233,157,233,1,135,87,237,255,208,13,236,1,155,109,36,255,180,100,218,0,180,163,18,0,190,110,9,1,17,63,123,255,179,136,180,255,165,123,123,255,144,188,81,254,71,240,108,255,25,112,11,255,227,218,51,255,167,50,234,255,114,79,108,255,31,19,115,255,183,240,99,0,227,87,143,255,72,217,248,255,102,169,95,1,129,149,149,0,238,133,12,1,227,204,35,0,208,115,26,1,102,8,234,0,112,88,143,1,144,249,14,0,240,158,172,254,100,112,119,0,194,141,153,254,40,56,83,255,121,176,46,0,42,53,76,255,158,191,154,0,91,209,92,0,173,13,16,1,5,72,226,255,204,254,149,0,80,184,207,0,100,9,122,254,118,101,171,255,252,203,0,254,160,207,54,0,56,72,249,1,56,140,13,255,10,64,107,254,91,101,52,255,225,181,248,1,139,255,132,0,230,145,17,0,233,56,23,0,119,1,241,255,213,169,151,255,99,99,9,254,185,15,191,255,173,103,109,1,174,13,251,255,178,88,7,254,27,59,68,255,10,33,2,255,248,97,59,0,26,30,146,1,176,147,10,0,95,121,207,1,188,88,24,0,185,94,254,254,115,55,201,0,24,50,70,0,120,53,6,0,142,66,146,0,228,226,249,255,104,192,222,1,173,68,219,0,162,184,36,255,143,102,137,255,157,11,23,0,125,45,98,0,235,93,225,254,56,112,160,255,70,116,243,1,153,249,55,255,129,39,17,1,241,80,244,0,87,69,21,1,94,228,73,255,78,66,65,255,194,227,231,0,61,146,87,255,173,155,23,255,112,116,219,254,216,38,11,255,131,186,133,0,94,212,187,0,100,47,91,0,204,254,175,255,222,18,215,254,173,68,108,255,227,228,79,255,38,221,213,0,163,227,150,254,31,190,18,0,160,179,11,1,10,90,94,255,220,174,88,0,163,211,229,255,199,136,52,0,130,95,221,255,140,188,231,254,139,113,128,255,117,171,236,254,49,220,20,255,59,20,171,255,228,109,188,0,20,225,32,254,195,16,174,0,227,254,136,1,135,39,105,0,150,77,206,255,210,238,226,0,55,212,132,254,239,57,124,0,170,194,93,255,249,16,247,255,24,151,62,255,10,151,10,0,79,139,178,255,120,242,202,0,26,219,213,0,62,125,35,255,144,2,108,255,230,33,83,255,81,45,216,1,224,62,17,0,214,217,125,0,98,153,153,255],"i8",ALLOC_NONE,Runtime.GLOBAL_BASE+10240),allocate([179,176,106,254,131,93,138,255,109,62,36,255,178,121,32,255,120,252,70,0,220,248,37,0,204,88,103,1,128,220,251,255,236,227,7,1,106,49,198,255,60,56,107,0,99,114,238,0,220,204,94,1,73,187,1,0,89,154,34,0,78,217,165,255,14,195,249,255,9,230,253,255,205,135,245,0,26,252,7,255,84,205,27,1,134,2,112,0,37,158,32,0,231,91,237,255,191,170,204,255,152,7,222,0,109,192,49,0,193,166,146,255,232,19,181,255,105,142,52,255,103,16,27,1,253,200,165,0,195,217,4,255,52,189,144,255,123,155,160,254,87,130,54,255,78,120,61,255,14,56,41,0,25,41,125,255,87,168,245,0,214,165,70,0,212,169,6,255,219,211,194,254,72,93,164,255,197,33,103,255,43,142,141,0,131,225,172,0,244,105,28,0,68,68,225,0,136,84,13,255,130,57,40,254,139,77,56,0,84,150,53,0,54,95,157,0,144,13,177,254,95,115,186,0,117,23,118,255,244,166,241,255,11,186,135,0,178,106,203,255,97,218,93,0,43,253,45,0,164,152,4,0,139,118,239,0,96,1,24,254,235,153,211,255,168,110,20,255,50,239,176,0,114,41,232,0,193,250,53,0,254,160,111,254,136,122,41,255,97,108,67,0,215,152,23,255,140,209,212,0,42,189,163,0,202,42,50,255,106,106,189,255,190,68,217,255,233,58,117,0,229,220,243,1,197,3,4,0,37,120,54,254,4,156,134,255,36,61,171,254,165,136,100,255,212,232,14,0,90,174,10,0,216,198,65,255,12,3,64,0,116,113,115,255,248,103,8,0,231,125,18,255,160,28,197,0,30,184,35,1,223,73,249,255,123,20,46,254,135,56,37,255,173,13,229,1,119,161,34,255,245,61,73,0,205,125,112,0,137,104,134,0,217,246,30,255,237,142,143,0,65,159,102,255,108,164,190,0,219,117,173,255,34,37,120,254,200,69,80,0,31,124,218,254,74,27,160,255,186,154,199,255,71,199,252,0,104,81,159,1,17,200,39,0,211,61,192,1,26,238,91,0,148,217,12,0,59,91,213,255,11,81,183,255,129,230,122,255,114,203,145,1,119,180,66,255,72,138,180,0,224,149,106,0,119,82,104,255,208,140,43,0,98,9,182,255,205,101,134,255,18,101,38,0,95,197,166,255,203,241,147,0,62,208,145,255,133,246,251,0,2,169,14,0,13,247,184,0,142,7,254,0,36,200,23,255,88,205,223,0,91,129,52,255,21,186,30,0,143,228,210,1,247,234,248,255,230,69,31,254,176,186,135,255,238,205,52,1,139,79,43,0,17,176,217,254,32,243,67,0,242,111,233,0,44,35,9,255,227,114,81,1,4,71,12,255,38,105,191,0,7,117,50,255,81,79,16,0,63,68,65,255,157,36,110,255,77,241,3,255,226,45,251,1,142,25,206,0,120,123,209,1,28,254,238,255,5,128,126,255,91,222,215,255,162,15,191,0,86,240,73,0,135,185,81,254,44,241,163,0,212,219,210,255,112,162,155,0,207,101,118,0,168,72,56,255,196,5,52,0,72,172,242,255,126,22,157,255,146,96,59,255,162,121,152,254,140,16,95,0,195,254,200,254,82,150,162,0,119,43,145,254,204,172,78,255,166,224,159,0,104,19,237,255,245,126,208,255,226,59,213,0,117,217,197,0,152,72,237,0,220,31,23,254,14,90,231,255,188,212,64,1,60,101,246,255,85,24,86,0,1,177,109,0,146,83,32,1,75,182,192,0,119,241,224,0,185,237,27,255,184,101,82,1,235,37,77,255,253,134,19,0,232,246,122,0,60,106,179,0,195,11,12,0,109,66,235,1,125,113,59,0,61,40,164,0,175,104,240,0,2,47,187,255,50,12,141,0,194,139,181,255,135,250,104,0,97,92,222,255,217,149,201,255,203,241,118,255,79,151,67,0,122,142,218,255,149,245,239,0,138,42,200,254,80,37,97,255,124,112,167,255,36,138,87,255,130,29,147,255,241,87,78,255,204,97,19,1,177,209,22,255,247,227,127,254,99,119,83,255,212,25,198,1,16,179,179,0,145,77,172,254,89,153,14,255,218,189,167,0,107,233,59,255,35,33,243,254,44,112,112,255,161,127,79,1,204,175,10,0,40,21,138,254,104,116,228,0,199,95,137,255,133,190,168,255,146,165,234,1,183,99,39,0,183,220,54,254,255,222,133,0,162,219,121,254,63,239,6,0,225,102,54,255,251,18,246,0,4,34,129,1,135,36,131,0,206,50,59,1,15,97,183,0,171,216,135,255,101,152,43,255,150,251,91,0,38,145,95,0,34,204,38,254,178,140,83,255,25,129,243,255,76,144,37,0,106,36,26,254,118,144,172,255,68,186,229,255,107,161,213,255,46,163,68,255,149,170,253,0,187,17,15,0,218,160,165,255,171,35,246,1,96,13,19,0,165,203,117,0,214,107,192,255,244,123,177,1,100,3,104,0,178,242,97,255,251,76,130,255,211,77,42,1,250,79,70,255,63,244,80,1,105,101,246,0,61,136,58,1,238,91,213,0,14,59,98,255,167,84,77,0,17,132,46,254,57,175,197,255,185,62,184,0,76,64,207,0,172,175,208,254,175,74,37,0,138,27,211,254,148,125,194,0,10,89,81,0,168,203,101,255,43,213,209,1,235,245,54,0,30,35,226,255,9,126,70,0,226,125,94,254,156,117,20,255,57,248,112,1,230,48,64,255,164,92,166,1,224,214,230,255,36,120,143,0,55,8,43,255,251,1,245,1,106,98,165,0,74,107,106,254,53,4,54,255,90,178,150,1,3,120,123,255,244,5,89,1,114,250,61,255,254,153,82,1,77,15,17,0,57,238,90,1,95,223,230,0,236,52,47,254,103,148,164,255,121,207,36,1,18,16,185,255,75,20,74,0,187,11,101,0,46,48,129,255,22,239,210,255,77,236,129,255,111,77,204,255,61,72,97,255,199,217,251,255,42,215,204,0,133,145,201,255,57,230,146,1,235,100,198,0,146,73,35,254,108,198,20,255,182,79,210,255,82,103,136,0,246,108,176,0,34,17,60,255,19,74,114,254,168,170,78,255,157,239,20,255,149,41,168,0,58,121,28,0,79,179,134,255,231,121,135,255,174,209,98,255,243,122,190,0,171,166,205,0,212,116,48,0,29,108,66,255,162,222,182,1,14,119,21,0,213,39,249,255,254,223,228,255,183,165,198,0,133,190,48,0,124,208,109,255,119,175,85,255,9,209,121,1,48,171,189,255,195,71,134,1,136,219,51,255,182,91,141,254,49,159,72,0,35,118,245,255,112,186,227,255,59,137,31,0,137,44,163,0,114,103,60,254,8,213,150,0,162,10,113,255,194,104,72,0,220,131,116,255,178,79,92,0,203,250,213,254,93,193,189,255,130,255,34,254,212,188,151,0,136,17,20,255,20,101,83,255,212,206,166,0,229,238,73,255,151,74,3,255,168,87,215,0,155,188,133,255,166,129,73,0,240,79,133,255,178,211,81,255,203,72,163,254,193,168,165,0,14,164,199,254,30,255,204,0,65,72,91,1,166,74,102,255,200,42,0,255,194,113,227,255,66,23,208,0,229,216,100,255,24,239,26,0,10,233,62,255,123,10,178,1,26,36,174,255,119,219,199,1,45,163,190,0,16,168,42,0,166,57,198,255,28,26,26,0,126,165,231,0,251,108,100,255,61,229,121,255,58,118,138,0,76,207,17,0,13,34,112,254,89,16,168,0,37,208,105,255,35,201,215,255,40,106,101,254,6,239,114,0,40,103,226,254,246,127,110,255,63,167,58,0,132,240,142,0,5,158,88,255,129,73,158,255,94,89,146,0,230,54,146,0,8,45,173,0,79,169,1,0,115,186,247,0,84,64,131,0,67,224,253,255,207,189,64,0,154,28,81,1,45,184,54,255,87,212,224,255,0,96,73,255,129,33,235,1,52,66,80,255,251,174,155,255,4,179,37,0,234,164,93,254,93,175,253,0,198,69,87,255,224,106,46,0,99,29,210,0,62,188,114,255,44,234,8,0,169,175,247,255,23,109,137,255,229,182,39,0,192,165,94,254,245,101,217,0,191,88,96,0,196,94,99,255,106,238,11,254,53,126,243,0,94,1,101,255,46,147,2,0,201,124,124,255,141,12,218,0,13,166,157,1,48,251,237,255,155,250,124,255,106,148,146,255,182,13,202,0,28,61,167,0,217,152,8,254,220,130,45,255,200,230,255,1,55,65,87,255,93,191,97,254,114,251,14,0,32,105,92,1,26,207,141,0,24,207,13,254,21,50,48,255,186,148,116,255,211,43,225,0,37,34,162,254,164,210,42,255,68,23,96,255,182,214,8,255,245,117,137,255,66,195,50,0,75,12,83,254,80,140,164,0,9,165,36,1,228,110,227,0,241,17,90,1,25,52,212,0,6,223,12,255,139,243,57,0,12,113,75,1,246,183,191,255,213,191,69,255,230,15,142,0,1,195,196,255,138,171,47,255,64,63,106,1,16,169,214,255,207,174,56,1,88,73,133,255,182,133,140,0,177,14,25,255,147,184,53,255,10,227,161,255,120,216,244,255,73,77,233,0,157,238,139,1,59,65,233,0,70,251,216,1,41,184,153,255,32,203,112,0,146,147,253,0,87,101,109,1,44,82,133,255,244,150,53,255,94,152,232,255,59,93,39,255,88,147,220,255,78,81,13,1,32,47,252,255,160,19,114,255,93,107,39,255,118,16,211,1,185,119,209,255,227,219,127,254,88,105,236,255,162,110,23,255,36,166,110,255,91,236,221,255,66,234,116,0,111,19,244,254,10,233,26,0,32,183,6,254,2,191,242,0,218,156,53,254,41,60,70,255,168,236,111,0,121,185,126,255,238,142,207,255,55,126,52,0,220,129,208,254,80,204,164,255,67,23,144,254,218,40,108,255,127,202,164,0,203,33,3,255,2,158,0,0,37,96,188,255,192,49,74,0,109,4,0,0,111,167,10,254,91,218,135,255,203,66,173,255,150,194,226,0,201,253,6,255,174,102,121,0,205,191,110,0,53,194,4,0,81,40,45,254,35,102,143,255,12,108,198,255,16,27,232,255,252,71,186,1,176,110,114,0,142,3,117,1,113,77,142,0,19,156,197,1,92,47,252,0,53,232,22,1,54,18,235,0,46,35,189,255,236,212,129,0,2,96,208,254,200,238,199,255,59,175,164,255,146,43,231,0,194,217,52,255,3,223,12,0,138,54,178,254,85,235,207,0,232,207,34,0,49,52,50,255,166,113,89,255,10,45,216,255,62,173,28,0,111,165,246,0,118,115,91,255,128,84,60,0,167,144,203,0,87,13,243,0,22,30,228,1,177,113,146,255,129,170,230,254,252,153,129,255,145,225,43,0,70,231,5,255,122,105,126,254,86,246,148,255,110,37,154,254,209,3,91,0,68,145,62,0,228,16,165,255,55,221,249,254,178,210,91,0,83,146,226,254,69,146,186,0,93,210,104,254,16,25,173,0,231,186,38,0,189,122,140,255,251,13,112,255,105,110,93,0,251,72,170,0,192,23,223,255,24,3,202,1,225,93,228,0,153,147,199,254,109,170,22,0,248,101,246,255,178,124,12,255,178,254,102,254,55,4,65,0,125,214,180,0,183,96,147,0,45,117,23,254,132,191,249,0,143,176,203,254,136,183,54,255,146,234,177,0,146,101,86,255,44,123,143,1,33,209,152,0,192,90,41,254,83,15,125,255,213,172,82,0,215,169,144,0,16,13,34,0,32,209,100,255,84,18,249,1,197,17,236,255,217,186,230,0,49,160,176,255,111,118,97,255,237,104,235,0,79,59,92,254,69,249,11,255,35,172,74,1,19,118,68,0,222,124,165,255,180,66,35,255,86,174,246,0,43,74,111,255,126,144,86,255,228,234,91,0,242,213,24,254,69,44,235,255,220,180,35,0,8,248,7,255,102,47,92,255,240,205,102,255,113,230,171,1,31,185,201,255,194,246,70,255,122,17,187,0,134,70,199,255,149,3,150,255,117,63,103,0,65,104,123,255,212,54,19,1,6,141,88,0,83,134,243,255,136,53,103,0,169,27,180,0,177,49,24,0,111,54,167,0,195,61,215,255,31,1,108,1,60,42,70,0,185,3,162,255,194,149,40,255,246,127,38,254,190,119,38,255,61,119,8,1,96,161,219,255,42,203,221,1,177,242,164,255,245,159,10,0,116,196,0,0,5,93,205,254,128,127,179,0,125,237,246,255,149,162,217,255,87,37,20,254,140,238,192,0,9,9,193,0,97,1,226,0,29,38,10,0,0,136,63,255,229,72,210,254,38,134,92,255,78,218,208,1,104,36,84,255,12,5,193,255,242,175,61,255,191,169,46,1,179,147,147,255,113,190,139,254,125,172,31,0,3,75,252,254,215,36,15,0,193,27,24,1,255,69,149,255,110,129,118,0,203,93,249,0,138,137,64,254,38,70,6,0,153,116,222,0,161,74,123,0,193,99,79,255,118,59,94,255,61,12,43,1,146,177,157,0,46,147,191,0,16,255,38,0,11,51,31,1,60,58,98,255,111,194,77,1,154,91,244,0,140,40,144,1,173,10,251,0,203,209,50,254,108,130,78,0,228,180,90,0,174,7,250,0,31,174,60,0,41,171,30,0,116,99,82,255,118,193,139,255,187,173,198,254,218,111,56,0,185,123,216,0,249,158,52,0,52,180,93,255,201,9,91,255,56,45,166,254,132,155,203,255,58,232,110,0,52,211,89,255,253,0,162,1,9,87,183,0,145,136,44,1,94,122,245,0,85,188,171,1,147,92,198,0,0,8,104,0,30,95,174,0,221,230,52,1,247,247,235,255,137,174,53,255,35,21,204,255,71,227,214,1,232,82,194,0,11,48,227,255,170,73,184,255,198,251,252,254,44,112,34,0,131,101,131,255,72,168,187,0,132,135,125,255,138,104,97,255,238,184,168,255,243,104,84,255,135,216,226,255,139,144,237,0,188,137,150,1,80,56,140,255,86,169,167,255,194,78,25,255,220,17,180,255,17,13,193,0,117,137,212,255,141,224,151,0,49,244,175,0,193,99,175,255,19,99,154,1,255,65,62,255,156,210,55,255,242,244,3,255,250,14,149,0,158,88,217,255,157,207,134,254,251,232,28,0,46,156,251,255,171,56,184,255,239,51,234,0,142,138,131,255,25,254,243,1,10,201,194,0,63,97,75,0,210,239,162,0,192,200,31,1,117,214,243,0,24,71,222,254,54,40,232,255,76,183,111,254,144,14,87,255,214,79,136,255,216,196,212,0,132,27,140,254,131,5,253,0,124,108,19,255,28,215,75,0,76,222,55,254,233,182,63,0,68,171,191,254,52,111,222,255,10,105,77,255,80,170,235,0,143,24,88,255,45,231,121,0,148,129,224,1,61,246,84,0,253,46,219,255,239,76,33,0,49,148,18,254,230,37,69,0,67,134,22,254,142,155,94,0,31,157,211,254,213,42,30,255,4,228,247,254,252,176,13,255,39,0,31,254,241,244,255,255,170,45,10,254,253,222,249,0,222,114,132,0,255,47,6,255,180,163,179,1,84,94,151,255,89,209,82,254,229,52,169,255,213,236,0,1,214,56,228,255,135,119,151,255,112,201,193,0,83,160,53,254,6,151,66,0,18,162,17,0,233,97,91,0,131,5,78,1,181,120,53,255,117,95,63,255,237,117,185,0,191,126,136,255,144,119,233,0,183,57,97,1,47,201,187,255,167,165,119,1,45,100,126,0,21,98,6,254,145,150,95,255,120,54,152,0,209,98,104,0,143,111,30,254,184,148,249,0,235,216,46,0,248,202,148,255,57,95,22,0,242,225,163,0,233,247,232,255,71,171,19,255,103,244,49,255,84,103,93,255,68,121,244,1,82,224,13,0,41,79,43,255,249,206,167,255,215,52,21,254,192,32,22,255,247,111,60,0,101,74,38,255,22,91,84,254,29,28,13,255,198,231,215,254,244,154,200,0,223,137,237,0,211,132,14,0,95,64,206,255,17,62,247,255,233,131,121,1,93,23,77,0,205,204,52,254,81,189,136,0,180,219,138,1,143,18,94,0,204,43,140,254,188,175,219,0,111,98,143,255,151,63,162,255,211,50,71,254,19,146,53,0,146,45,83,254,178,82,238,255,16,133,84,255,226,198,93,255,201,97,20,255,120,118,35,255,114,50,231,255,162,229,156,255,211,26,12,0,114,39,115,255,206,212,134,0,197,217,160,255,116,129,94,254,199,215,219,255,75,223,249,1,253,116,181,255,232,215,104,255,228,130,246,255,185,117,86,0,14,5,8,0,239,29,61,1,237,87,133,255,125,146,137,254,204,168,223,0,46,168,245,0,154,105,22,0,220,212,161,255,107,69,24,255,137,218,181,255,241,84,198,255,130,122,211,255,141,8,153,255,190,177,118,0,96,89,178,0,255,16,48,254,122,96,105,255,117,54,232,255,34,126,105,255,204,67,166,0,232,52,138,255,211,147,12,0,25,54,7,0,44,15,215,254,51,236,45,0,190,68,129,1,106,147,225,0,28,93,45,254,236,141,15,255,17,61,161,0,220,115,192,0,236,145,24,254,111,168,169,0,224,58,63,255,127,164,188,0,82,234,75,1,224,158,134,0,209,68,110,1,217,166,217,0,70,225,166,1,187,193,143,255,16,7,88,255,10,205,140,0,117,192,156,1,17,56,38,0,27,124,108,1,171,215,55,255,95,253,212,0,155,135,168,255,246,178,153,254,154,68,74,0,232,61,96,254,105,132,59,0,33,76,199,1,189,176,130,255,9,104,25,254,75,198,102,255,233,1,112,0,108,220,20,255,114,230,70,0,140,194,133,255,57,158,164,254,146,6,80,255,169,196,97,1,85,183,130,0,70,158,222,1,59,237,234,255,96,25,26,255,232,175,97,255,11,121,248,254,88,35,194,0,219,180,252,254,74,8,227,0,195,227,73,1,184,110,161,255,49,233,164,1,128,53,47,0,82,14,121,255,193,190,58,0,48,174,117,255,132,23,32,0,40,10,134,1,22,51,25,255,240,11,176,255,110,57,146,0,117,143,239,1,157,101,118,255,54,84,76,0,205,184,18,255,47,4,72,255,78,112,85,255,193,50,66,1,93,16,52,255,8,105,134,0,12,109,72,255,58,156,251,0,144,35,204,0,44,160,117,254,50,107,194,0,1,68,165,255,111,110,162,0,158,83,40,254,76,214,234,0,58,216,205,255,171,96,147,255,40,227,114,1,176,227,241,0,70,249,183,1,136,84,139,255,60,122,247,254,143,9,117,255,177,174,137,254,73,247,143,0,236,185,126,255,62,25,247,255,45,64,56,255,161,244,6,0,34,57,56,1,105,202,83,0,128,147,208,0,6,103,10,255,74,138,65,255,97,80,100,255,214,174,33,255,50,134,74,255,110,151,130,254,111,84,172,0,84,199,75,254,248,59,112,255,8,216,178,1,9,183,95,0,238,27,8,254,170,205,220,0,195,229,135,0,98,76,237,255,226,91,26,1,82,219,39,255,225,190,199,1,217,200,121,255,81,179,8,255,140,65,206,0,178,207,87,254,250,252,46,255,104,89,110,1,253,189,158,255,144,214,158,255,160,245,54,255,53,183,92,1,21,200,194,255,146,33,113,1,209,1,255,0,235,106,43,255,167,52,232,0,157,229,221,0,51,30,25,0,250,221,27,1,65,147,87,255,79,123,196,0,65,196,223,255,76,44,17,1,85,241,68,0,202,183,249,255,65,212,212,255,9,33,154,1,71,59,80,0,175,194,59,255,141,72,9,0,100,160,244,0,230,208,56,0,59,25,75,254,80,194,194,0,18,3,200,254,160,159,115,0,132,143,247,1,111,93,57,255,58,237,11,1,134,222,135,255,122,163,108,1,123,43,190,255,251,189,206,254,80,182,72,255,208,246,224,1,17,60,9,0,161,207,38,0,141,109,91,0,216,15,211,255,136,78,110,0,98,163,104,255,21,80,121,255,173,178,183,1,127,143,4,0,104,60,82,254,214,16,13,255,96,238,33,1,158,148,230,255,127,129,62,255,51,255,210,255,62,141,236,254,157,55,224,255,114,39,244,0,192,188,250,255,228,76,53,0,98,84,81,255,173,203,61,254,147,50,55,255,204,235,191,0,52,197,244,0,88,43,211,254,27,191,119,0,188,231,154,0,66,81,161,0,92,193,160,1,250,227,120,0,123,55,226,0,184,17,72,0,133,168,10,254,22,135,156,255,41,25,103,255,48,202,58,0,186,149,81,255,188,134,239,0,235,181,189,254,217,139,188,255,74,48,82,0,46,218,229,0,189,253,251,0,50,229,12,255,211,141,191,1,128,244,25,255,169,231,122,254,86,47,189,255,132,183,23,255,37,178,150,255,51,137,253,0,200,78,31,0,22,105,50,0,130,60,0,0,132,163,91,254,23,231,187,0,192,79,239,0,157,102,164,255,192,82,20,1,24,181,103,255,240,9,234,0,1,123,164,255,133,233,0,255,202,242,242,0,60,186,245,0,241,16,199,255,224,116,158,254,191,125,91,255,224,86,207,0,121,37,231,255,227,9,198,255,15,153,239,255,121,232,217,254,75,112,82,0,95,12,57,254,51,214,105,255,148,220,97,1,199,98,36,0,156,209,12,254,10,212,52,0,217,180,55,254,212,170,232,255,216,20,84,255,157,250,135,0,157,99,127,254,1,206,41,0,149,36,70,1,54,196,201,255,87,116,0,254,235,171,150,0,27,163,234,0,202,135,180,0,208,95,0,254,123,156,93,0,183,62,75,0,137,235,182,0,204,225,255,255,214,139,210,255,2,115,8,255,29,12,111,0,52,156,1,0,253,21,251,255,37,165,31,254,12,130,211,0,106,18,53,254,42,99,154,0,14,217,61,254,216,11,92,255,200,197,112,254,147,38,199,0,36,252,120,254,107,169,77,0,1,123,159,255,207,75,102,0,163,175,196,0,44,1,240,0,120,186,176,254,13,98,76,255,237,124,241,255,232,146,188,255,200,96,224,0,204,31,41,0,208,200,13,0,21,225,96,255,175,156,196,0,247,208,126,0,62,184,244,254,2,171,81,0,85,115,158,0,54,64,45,255,19,138,114,0,135,71,205,0,227,47,147,1,218,231,66,0,253,209,28,0,244,15,173,255,6,15,118,254,16,150,208,255,185,22,50,255,86,112,207,255,75,113,215,1,63,146,43,255,4,225,19,254,227,23,62,255,14,255,214,254,45,8,205,255,87,197,151,254,210,82,215,255,245,248,247,255,128,248,70,0,225,247,87,0,90,120,70,0,213,245,92,0,13,133,226,0,47,181,5,1,92,163,105,255,6,30,133,254,232,178,61,255,230,149,24,255,18,49,158,0,228,100,61,254,116,243,251,255,77,75,92,1,81,219,147,255,76,163,254,254,141,213,246,0,232,37,152,254,97,44,100,0,201,37,50,1,212,244,57,0,174,171,183,255,249,74,112,0,166,156,30,0,222,221,97,255,243,93,73,254,251,101,100,255,216,217,93,255,254,138,187,255,142,190,52,255,59,203,177,255,200,94,52,0,115,114,158,255,165,152,104,1,126,99,226,255,118,157,244,1,107,200,16,0,193,90,229,0,121,6,88,0,156,32,93,254,125,241,211,255,14,237,157,255,165,154,21,255,184,224,22,255,250,24,152,255,113,77,31,0,247,171,23,255,237,177,204,255,52,137,145,255,194,182,114,0,224,234,149,0,10,111,103,1,201,129,4,0,238,142,78,0,52,6,40,255,110,213,165,254,60,207,253,0,62,215,69,0,96,97,0,255,49,45,202,0,120,121,22,255,235,139,48,1,198,45,34,255,182,50,27,1,131,210,91,255,46,54,128,0,175,123,105,255,198,141,78,254,67,244,239,255,245,54,103,254,78,38,242,255,2,92,249,254,251,174,87,255,139,63,144,0,24,108,27,255,34,102,18,1,34,22,152,0,66,229,118,254,50,143,99,0,144,169,149,1,118,30,152,0,178,8,121,1,8,159,18,0,90,101,230,255,129,29,119,0,68,36,11,1,232,183,55,0,23,255,96,255,161,41,193,255,63,139,222,0,15,179,243,0,255,100,15,255,82,53,135,0,137,57,149,1,99,240,170,255,22,230,228,254,49,180,82,255,61,82,43,0,110,245,217,0,199,125,61,0,46,253,52,0,141,197,219,0,211,159,193,0,55,121,105,254,183,20,129,0,169,119,170,255,203,178,139,255,135,40,182,255,172,13,202,255,65,178,148,0,8,207,43,0,122,53,127,1,74,161,48,0,227,214,128,254,86,11,243,255,100,86,7,1,245,68,134,255,61,43,21,1,152,84,94,255,190,60,250,254,239,118,232,255,214,136,37,1,113,76,107,255,93,104,100,1,144,206,23,255,110,150,154,1,228,103,185,0,218,49,50,254,135,77,139,255,185,1,78,0,0,161,148,255,97,29,233,255,207,148,149,255,160,168,0,0,91,128,171,255,6,28,19,254,11,111,247,0,39,187,150,255,138,232,149,0,117,62,68,255,63,216,188,255,235,234,32,254,29,57,160,255,25,12,241,1,169,60,191,0,32,131,141,255,237,159,123,255,94,197,94,254,116,254,3,255,92,179,97,254,121,97,92,255,170,112,14,0,21,149,248,0,248,227,3,0,80,96,109,0,75,192,74,1,12,90,226,255,161,106,68,1,208,114,127,255,114,42,255,254,74,26,74,255,247,179,150,254,121,140,60,0,147,70,200,255,214,40,161,255,161,188,201,255,141,65,135,255,242,115,252,0,62,47,202,0,180,149,255,254,130,55,237,0,165,17,186,255,10,169,194,0,156,109,218,255,112,140,123,255,104,128,223,254,177,142,108,255,121,37,219,255,128,77,18,255,111,108,23,1,91,192,75,0,174,245,22,255,4,236,62,255,43,64,153,1,227,173,254,0,237,122,132,1,127,89,186,255,142,82,128,254,252,84,174,0,90,179,177,1,243,214,87,255,103,60,162,255,208,130,14,255,11,130,139,0,206,129,219,255,94,217,157,255,239,230,230,255,116,115,159,254,164,107,95,0,51,218,2,1,216,125,198,255,140,202,128,254,11,95,68,255,55,9,93,254,174,153,6,255,204,172,96,0,69,160,110,0,213,38,49,254,27,80,213,0,118,125,114,0,70,70,67,255,15,142,73,255,131,122,185,255,243,20,50,254,130,237,40,0,210,159,140,1,197,151,65,255,84,153,66,0,195,126,90,0,16,238,236,1,118,187,102,255,3,24,133,255,187,69,230,0,56,197,92,1,213,69,94,255,80,138,229,1,206,7,230,0,222,111,230,1,91,233,119,255,9,89,7,1,2,98,1,0,148,74,133,255,51,246,180,255,228,177,112,1,58,189,108,255,194,203,237,254,21,209,195,0,147,10,35,1,86,157,226,0,31,163,139,254,56,7,75,255,62,90,116,0,181,60,169,0,138,162,212,254,81,167,31,0,205,90,112,255,33,112,227,0,83,151,117,1,177,224,73,255,174,144,217,255,230,204,79,255,22,77,232,255,114,78,234,0,224,57,126,254,9,49,141,0,242,147,165,1,104,182,140,255,167,132,12,1,123,68,127,0,225,87,39,1,251,108,8,0,198,193,143,1,121,135,207,255,172,22,70,0,50,68,116,255,101,175,40,255,248,105,233,0,166,203,7,0,110,197,218,0,215,254,26,254,168,226,253,0,31,143,96,0,11,103,41,0,183,129,203,254,100,247,74,255,213,126,132,0,210,147,44,0,199,234,27,1,148,47,181,0,155,91,158,1,54,105,175,255,2,78,145,254,102,154,95,0,128,207,127,254,52,124,236,255,130,84,71,0,221,243,211,0,152,170,207,0,222,106,199,0,183,84,94,254,92,200,56,255,138,182,115,1,142,96,146,0,133,136,228,0,97,18,150,0,55,251,66,0,140,102,4,0,202,103,151,0,30,19,248,255,51,184,207,0,202,198,89,0,55,197,225,254,169,95,249,255,66,65,68,255,188,234,126,0,166,223,100,1,112,239,244,0,144,23,194,0,58,39,182,0,244,44,24,254,175,68,179,255,152,118,154,1,176,162,130,0,217,114,204,254,173,126,78,255,33,222,30,255,36,2,91,255,2,143,243,0,9,235,215,0,3,171,151,1,24,215,245,255,168,47,164,254,241,146,207,0,69,129,180,0,68,243,113,0,144,53,72,254,251,45,14,0,23,110,168,0,68,68,79,255,110,70,95,254,174,91,144,255,33,206,95,255,137,41,7,255,19,187,153,254,35,255,112,255,9,145,185,254,50,157,37,0,11,112,49,1,102,8,190,255,234,243,169,1,60,85,23,0,74,39,189,0,116,49,239,0,173,213,210,0,46,161,108,255,159,150,37,0,196,120,185,255,34,98,6,255,153,195,62,255,97,230,71,255,102,61,76,0,26,212,236,255,164,97,16,0,198,59,146,0,163,23,196,0,56,24,61,0,181,98,193,0,251,147,229,255,98,189,24,255,46,54,206,255,234,82,246,0,183,103,38,1,109,62,204,0,10,240,224,0,146,22,117,255,142,154,120,0,69,212,35,0,208,99,118,1,121,255,3,255,72,6,194,0,117,17,197,255,125,15,23,0,154,79,153,0,214,94,197,255,185,55,147,255,62,254,78,254,127,82,153,0,110,102,63,255,108,82,161,255,105,187,212,1,80,138,39,0,60,255,93,255,72,12,186,0,210,251,31,1,190,167,144,255,228,44,19,254,128,67,232,0,214,249,107,254,136,145,86,255,132,46,176,0,189,187,227,255,208,22,140,0,217,211,116,0,50,81,186,254,139,250,31,0,30,64,198,1,135,155,100,0,160,206,23,254,187,162,211,255,16,188,63,0,254,208,49,0,85,84,191,0,241,192,242,255,153,126,145,1,234,162,162,255,230,97,216,1,64,135,126,0,190,148,223,1,52,0,43,255,28,39,189,1,64,136,238,0,175,196,185,0,98,226,213,255,127,159,244,1,226,175,60,0,160,233,142,1,180,243,207,255,69,152,89,1,31,101,21,0,144,25,164,254,139,191,209,0,91,25,121,0,32,147,5,0,39,186,123,255,63,115,230,255,93,167,198,255,143,213,220,255,179,156,19,255,25,66,122,0,214,160,217,255,2,45,62,255,106,79,146,254,51,137,99,255,87,100,231,255,175,145,232,255,101,184,1,255,174,9,125,0,82,37,161,1,36,114,141,255,48,222,142,255,245,186,154,0,5,174,221,254,63,114,155,255,135,55,160,1,80,31,135,0,126,250,179,1,236,218,45,0,20,28,145,1,16,147,73,0,249,189,132,1,17,189,192,255,223,142,198,255,72,20,15,255,250,53,237,254,15,11,18,0,27,211,113,254,213,107,56,255,174,147,146,255,96,126,48,0,23,193,109,1,37,162,94,0,199,157,249,254,24,128,187,255,205,49,178,254,93,164,42,255,43,119,235,1,88,183,237,255,218,210,1,255,107,254,42,0,230,10,99,255,162,0,226,0,219,237,91,0,129,178,203,0,208,50,95,254,206,208,95,255,247,191,89,254,110,234,79,255,165,61,243,0,20,122,112,255,246,246,185,254,103,4,123,0,233,99,230,1,219,91,252,255,199,222,22,255,179,245,233,255,211,241,234,0,111,250,192,255,85,84,136,0,101,58,50,255,131,173,156,254,119,45,51,255,118,233,16,254,242,90,214,0,94,159,219,1,3,3,234,255,98,76,92,254,80,54,230,0,5,228,231,254,53,24,223,255,113,56,118,1,20,132,1,255,171,210,236,0,56,241,158,255,186,115,19,255,8,229,174,0,48,44,0,1,114,114,166,255,6,73,226,255,205,89,244,0,137,227,75,1,248,173,56,0,74,120,246,254,119,3,11,255,81,120,198,255,136,122,98,255,146,241,221,1,109,194,78,255,223,241,70,1,214,200,169,255,97,190,47,255,47,103,174,255,99,92,72,254,118,233,180,255,193,35,233,254,26,229,32,255,222,252,198,0,204,43,71,255,199,84,172,0,134,102,190,0,111,238,97,254,230,40,230,0,227,205,64,254,200,12,225,0,166,25,222,0,113,69,51,255,143,159,24,0,167,184,74,0,29,224,116,254,158,208,233,0,193,116,126,255,212,11,133,255,22,58,140,1,204,36,51,255,232,30,43,0,235,70,181,255,64,56,146,254,169,18,84,255,226,1,13,255,200,50,176,255,52,213,245,254,168,209,97,0,191,71,55,0,34,78,156,0,232,144,58,1,185,74,189,0,186,142,149,254,64,69,127,255,161,203,147,255,176,151,191,0,136,231,203,254,163,182,137,0,161,126,251,254,233,32,66,0,68,207,66,0,30,28,37,0,93,114,96,1,254,92,247,255,44,171,69,0,202,119,11,255,188,118,50,1,255,83,136,255,71,82,26,0,70,227,2,0,32,235,121,1,181,41,154,0,71,134,229,254,202,255,36,0,41,152,5,0,154,63,73,255,34,182,124,0,121,221,150,255,26,204,213,1,41,172,87,0,90,157,146,255,109,130,20,0,71,107,200,255,243,102,189,0,1,195,145,254,46,88,117,0,8,206,227,0,191,110,253,255,109,128,20,254,134,85,51,255,137,177,112,1,216,34,22,255,131,16,208,255,121,149,170,0,114,19,23,1,166,80,31,255,113,240,122,0,232,179,250,0,68,110,180,254,210,170,119,0,223,108,164,255,207,79,233,255,27,229,226,254,209,98,81,255,79,68,7,0,131,185,100,0,170,29,162,255,17,162,107,255,57,21,11,1,100,200,181,255,127,65,166,1,165,134,204,0,104,167,168,0,1,164,79,0,146,135,59,1,70,50,128,255,102,119,13,254,227,6,135,0,162,142,179,255,160,100,222,0,27,224,219,1,158,93,195,255,234,141,137,0,16,24,125,255,238,206,47,255,97,17,98,255,116,110,12,255,96,115,77,0,91,227,232,255,248,254,79,255,92,229,6,254,88,198,139,0,206,75,129,0,250,77,206,255,141,244,123,1,138,69,220,0,32,151,6,1,131,167,22,255,237,68,167,254,199,189,150,0,163,171,138,255,51,188,6,255,95,29,137,254,148,226,179,0,181,107,208,255,134,31,82,255,151,101,45,255,129,202,225,0,224,72,147,0,48,138,151,255,195,64,206,254,237,218,158,0,106,29,137,254,253,189,233,255,103,15,17,255,194,97,255,0,178,45,169,254,198,225,155,0,39,48,117,255,135,106,115,0,97,38,181,0,150,47,65,255,83,130,229,254,246,38,129,0,92,239,154,254,91,99,127,0,161,111,33,255,238,217,242,255,131,185,195,255,213,191,158,255,41,150,218,0,132,169,131,0,89,84,252,1,171,70,128,255,163,248,203,254,1,50,180,255,124,76,85,1,251,111,80,0,99,66,239,255,154,237,182,255,221,126,133,254,74,204,99,255,65,147,119,255,99,56,167,255,79,248,149,255,116,155,228,255,237,43,14,254,69,137,11,255,22,250,241,1,91,122,143,255,205,249,243,0,212,26,60,255,48,182,176,1,48,23,191,255,203,121,152,254,45,74,213,255,62,90,18,254,245,163,230,255,185,106,116,255,83,35,159,0,12,33,2,255,80,34,62,0,16,87,174,255,173,101,85,0,202,36,81,254,160,69,204,255,64,225,187,0,58,206,94,0,86,144,47,0,229,86,245,0,63,145,190,1,37,5,39,0,109,251,26,0,137,147,234,0,162,121,145,255,144,116,206,255,197,232,185,255,183,190,140,255,73,12,254,255,139,20,242,255,170,90,239,255,97,66,187,255,245,181,135,254,222,136,52,0,245,5,51,254,203,47,78,0,152,101,216,0,73,23,125,0,254,96,33,1,235,210,73,255,43,209,88,1,7,129,109,0,122,104,228,254,170,242,203,0,242,204,135,255,202,28,233,255,65,6,127,0,159,144,71,0,100,140,95,0,78,150,13,0,251,107,118,1,182,58,125,255,1,38,108,255,141,189,209,255,8,155,125,1,113,163,91,255,121,79,190,255,134,239,108,255,76,47,248,0,163,228,239,0,17,111,10,0,88,149,75,255,215,235,239,0,167,159,24,255,47,151,108,255,107,209,188,0,233,231,99,254,28,202,148,255,174,35,138,255,110,24,68,255,2,69,181,0,107,102,82,0,102,237,7,0,92,36,237,255,221,162,83,1,55,202,6,255,135,234,135,255,24,250,222,0,65,94,168,254,245,248,210,255,167,108,201,254,255,161,111,0,205,8,254,0,136,13,116,0,100,176,132,255,43,215,126,255,177,133,130,255,158,79,148,0,67,224,37,1,12,206,21,255,62,34,110,1,237,104,175,255,80,132,111,255,142,174,72,0,84,229,180,254,105,179,140,0,64,248,15,255,233,138,16,0,245,67,123,254,218,121,212,255,63,95,218,1,213,133,137,255,143,182,82,255,48,28,11,0,244,114,141,1,209,175,76,255,157,181,150,255,186,229,3,255,164,157,111,1,231,189,139,0,119,202,190,255,218,106,64,255,68,235,63,254,96,26,172,255,187,47,11,1,215,18,251,255,81,84,89,0,68,58,128,0,94,113,5,1,92,129,208,255,97,15,83,254,9,28,188,0,239,9,164,0,60,205,152,0,192,163,98,255,184,18,60,0,217,182,139,0,109,59,120,255,4,192,251,0,169,210,240,255,37,172,92,254,148,211,245,255,179,65,52,0,253,13,115,0,185,174,206,1,114,188,149,255,237,90,173,0,43,199,192,255,88,108,113,0,52,35,76,0,66,25,148,255,221,4,7,255,151,241,114,255,190,209,232,0,98,50,199,0,151,150,213,255,18,74,36,1,53,40,7,0,19,135,65,255,26,172,69,0,174,237,85,0,99,95,41,0,3,56,16,0,39,160,177,255,200,106,218,254,185,68,84,255,91,186,61,254,67,143,141,255,13,244,166,255,99,114,198,0,199,110,163,255,193,18,186,0,124,239,246,1,110,68,22,0,2,235,46,1,212,60,107,0,105,42,105,1,14,230,152,0,7,5,131,0,141,104,154,255,213,3,6,0,131,228,162,255,179,100,28,1,231,123,85,255,206,14,223,1,253,96,230,0,38,152,149,1,98,137,122,0,214,205,3,255,226,152,179,255,6,133,137,0,158,69,140,255,113,162,154,255,180,243,172,255,27,189,115,255,143,46,220,255,213,134,225,255,126,29,69,0,188,43,137,1,242,70,9,0,90,204,255,255,231,170,147,0,23,56,19,254,56,125,157,255,48,179,218,255,79,182,253,255,38,212,191,1,41,235,124,0,96,151,28,0,135,148,190,0,205,249,39,254,52,96,136,255,212,44,136,255,67,209,131,255,252,130,23,255,219,128,20,255,198,129,118,0,108,101,11,0,178,5,146,1,62,7,100,255,181,236,94,254,28,26,164,0,76,22,112,255,120,102,79,0,202,192,229,1,200,176,215,0,41,64,244,255,206,184,78,0,167,45,63,1,160,35,0,255,59,12,142,255,204,9,144,255,219,94,229,1,122,27,112,0,189,105,109,255,64,208,74,255,251,127,55,1,2,226,198,0,44,76,209,0,151,152,77,255,210,23,46,1,201,171,69,255,44,211,231,0,190,37,224,255,245,196,62,255,169,181,222,255,34,211,17,0,119,241,197,255,229,35,152,1,21,69,40,255,178,226,161,0,148,179,193,0,219,194,254,1,40,206,51,255,231,92,250,1,67,153,170,0,21,148,241,0,170,69,82,255,121,18,231,255,92,114,3,0,184,62,230,0,225,201,87,255,146,96,162,255,181,242,220,0,173,187,221,1,226,62,170,255,56,126,217,1,117,13,227,255,179,44,239,0,157,141,155,255,144,221,83,0,235,209,208,0,42,17,165,1,251,81,133,0,124,245,201,254,97,211,24,255,83,214,166,0,154,36,9,255,248,47,127,0,90,219,140,255,161,217,38,254,212,147,63,255,66,84,148,1,207,3,1,0,230,134,89,1,127,78,122,255,224,155,1,255,82,136,74,0,178,156,208,255,186,25,49,255,222,3,210,1,229,150,190,255,85,162,52,255,41,84,141,255,73,123,84,254,93,17,150,0,119,19,28,1,32,22,215,255,28,23,204,255,142,241,52,255,228,52,125,0,29,76,207,0,215,167,250,254,175,164,230,0,55,207,105,1,109,187,245,255,161,44,220,1,41,101,128,255,167,16,94,0,93,214,107,255,118,72,0,254,80,61,234,255,121,175,125,0,139,169,251,0,97,39,147,254,250,196,49,255,165,179,110,254,223,70,187,255,22,142,125,1,154,179,138,255,118,176,42,1,10,174,153,0,156,92,102,0,168,13,161,255,143,16,32,0,250,197,180,255,203,163,44,1,87,32,36,0,161,153,20,255,123,252,15,0,25,227,80,0,60,88,142,0,17,22,201,1,154,205,77,255,39,63,47,0,8,122,141,0,128,23,182,254,204,39,19,255,4,112,29,255,23,36,140,255,210,234,116,254,53,50,63,255,121,171,104,255,160,219,94,0,87,82,14,254,231,42,5,0,165,139,127,254,86,78,38,0,130,60,66,254,203,30,45,255,46,196,122,1,249,53,162,255,136,143,103,254,215,210,114,0,231,7,160,254,169,152,42,255,111,45,246,0,142,131,135,255,131,71,204,255,36,226,11,0,0,28,242,255,225,138,213,255,247,46,216,254,245,3,183,0,108,252,74,1,206,26,48,255,205,54,246,255,211,198,36,255,121,35,50,0,52,216,202,255,38,139,129,254,242,73,148,0,67,231,141,255,42,47,204,0,78,116,25,1,4,225,191,255,6,147,228,0,58,88,177,0,122,165,229,255,252,83,201,255,224,167,96,1,177,184,158,255,242,105,179,1,248,198,240,0,133,66,203,1,254,36,47,0,45,24,115,255,119,62,254,0,196,225,186,254,123,141,172,0,26,85,41,255,226,111,183,0,213,231,151,0,4,59,7,255,238,138,148,0,66,147,33,255,31,246,141,255,209,141,116,255,104,112,31,0,88,161,172,0,83,215,230,254,47,111,151,0,45,38,52,1,132,45,204,0,138,128,109,254,233,117,134,255,243,190,173,254,241,236,240,0,82,127,236,254,40,223,161,255,110,182,225,255,123,174,239,0,135,242,145,1,51,209,154,0,150,3,115,254,217,164,252,255,55,156,69,1,84,94,255,255,232,73,45,1,20,19,212,255,96,197,59,254,96,251,33,0,38,199,73,1,64,172,247,255,117,116,56,255,228,17,18,0,62,138,103,1,246,229,164,255,244,118,201,254,86,32,159,255,109,34,137,1,85,211,186,0,10,193,193,254,122,194,177,0,122,238,102,255,162,218,171,0,108,217,161,1,158,170,34,0,176,47,155,1,181,228,11,255,8,156,0,0,16,75,93,0,206,98,255,1,58,154,35,0,12,243,184,254,67,117,66,255,230,229,123,0,201,42,110,0,134,228,178,254,186,108,118,255,58,19,154,255,82,169,62,255,114,143,115,1,239,196,50,255,173,48,193,255,147,2,84,255,150,134,147,254,95,232,73,0,109,227,52,254,191,137,10,0,40,204,30,254,76,52,97,255,164,235,126,0,254,124,188,0,74,182,21,1,121,29,35,255,241,30,7,254,85,218,214,255,7,84,150,254,81,27,117,255,160,159,152,254,66,24,221,255,227,10,60,1,141,135,102,0,208,189,150,1,117,179,92,0,132,22,136,255,120,199,28,0,21,129,79,254,182,9,65,0,218,163,169,0,246,147,198,255,107,38,144,1,78,175,205,255,214,5,250,254,47,88,29,255,164,47,204,255,43,55,6,255,131,134,207,254,116,100,214,0,96,140,75,1,106,220,144,0,195,32,28,1,172,81,5,255,199,179,52,255,37,84,203,0,170,112,174,0,11,4,91,0,69,244,27,1,117,131,92,0,33,152,175,255,140,153,107,255,251,135,43,254,87,138,4,255,198,234,147,254,121,152,84,255,205,101,155,1,157,9,25,0,72,106,17,254,108,153,0,255,189,229,186,0,193,8,176,255,174,149,209,0,238,130,29,0,233,214,126,1,61,226,102,0,57,163,4,1,198,111,51,255,45,79,78,1,115,210,10,255,218,9,25,255,158,139,198,255,211,82,187,254,80,133,83,0,157,129,230,1,243,133,134,255,40,136,16,0,77,107,79,255,183,85,92,1,177,204,202,0,163,71,147,255,152,69,190,0,172,51,188,1,250,210,172,255,211,242,113,1,89,89,26,255,64,66,111,254,116,152,42,0,161,39,27,255,54,80,254,0,106,209,115,1,103,124,97,0,221,230,98,255,31,231,6,0,178,192,120,254,15,217,203,255,124,158,79,0,112,145,247,0,92,250,48,1,163,181,193,255,37,47,142,254,144,189,165,255,46,146,240,0,6,75,128,0,41,157,200,254,87,121,213,0,1,113,236,0,5,45,250,0,144,12,82,0,31,108,231,0,225,239,119,255,167,7,189,255,187,228,132,255,110,189,34,0,94,44,204,1,162,52,197,0,78,188,241,254,57,20,141,0,244,146,47,1,206,100,51,0,125,107,148,254,27,195,77,0,152,253,90,1,7,143,144,255,51,37,31,0,34,119,38,255,7,197,118,0,153,188,211,0,151,20,116,254,245,65,52,255,180,253,110,1,47,177,209,0,161,99,17,255,118,222,202,0,125,179,252,1,123,54,126,255,145,57,191,0,55,186,121,0,10,243,138,0,205,211,229,255,125,156,241,254,148,156,185,255,227,19,188,255,124,41,32,255,31,34,206,254,17,57,83,0,204,22,37,255,42,96,98,0,119,102,184,1,3,190,28,0,110,82,218,255,200,204,192,255,201,145,118,0,117,204,146,0,132,32,98,1,192,194,121,0,106,161,248,1,237,88,124,0,23,212,26,0,205,171,90,255,248,48,216,1,141,37,230,255,124,203,0,254,158,168,30,255,214,248,21,0,112,187,7,255],"i8",ALLOC_NONE,Runtime.GLOBAL_BASE+20480),allocate([75,133,239,255,74,227,243,255,250,147,70,0,214,120,162,0,167,9,179,255,22,158,18,0,218,77,209,1,97,109,81,255,244,33,179,255,57,52,57,255,65,172,210,255,249,71,209,255,142,169,238,0,158,189,153,255,174,254,103,254,98,33,14,0,141,76,230,255,113,139,52,255,15,58,212,0,168,215,201,255,248,204,215,1,223,68,160,255,57,154,183,254,47,231,121,0,106,166,137,0,81,136,138,0,165,43,51,0,231,139,61,0,57,95,59,254,118,98,25,255,151,63,236,1,94,190,250,255,169,185,114,1,5,250,58,255,75,105,97,1,215,223,134,0,113,99,163,1,128,62,112,0,99,106,147,0,163,195,10,0,33,205,182,0,214,14,174,255,129,38,231,255,53,182,223,0,98,42,159,255,247,13,40,0,188,210,177,1,6,21,0,255,255,61,148,254,137,45,129,255,89,26,116,254,126,38,114,0,251,50,242,254,121,134,128,255,204,249,167,254,165,235,215,0,202,177,243,0,133,141,62,0,240,130,190,1,110,175,255,0,0,20,146,1,37,210,121,255,7,39,130,0,142,250,84,255,141,200,207,0,9,95,104,255,11,244,174,0,134,232,126,0,167,1,123,254,16,193,149,255,232,233,239,1,213,70,112,255,252,116,160,254,242,222,220,255,205,85,227,0,7,185,58,0,118,247,63,1,116,77,177,255,62,245,200,254,63,18,37,255,107,53,232,254,50,221,211,0,162,219,7,254,2,94,43,0,182,62,182,254,160,78,200,255,135,140,170,0,235,184,228,0,175,53,138,254,80,58,77,255,152,201,2,1,63,196,34,0,5,30,184,0,171,176,154,0,121,59,206,0,38,99,39,0,172,80,77,254,0,134,151,0,186,33,241,254,94,253,223,255,44,114,252,0,108,126,57,255,201,40,13,255,39,229,27,255,39,239,23,1,151,121,51,255,153,150,248,0,10,234,174,255,118,246,4,254,200,245,38,0,69,161,242,1,16,178,150,0,113,56,130,0,171,31,105,0,26,88,108,255,49,42,106,0,251,169,66,0,69,93,149,0,20,57,254,0,164,25,111,0,90,188,90,255,204,4,197,0,40,213,50,1,212,96,132,255,88,138,180,254,228,146,124,255,184,246,247,0,65,117,86,255,253,102,210,254,254,121,36,0,137,115,3,255,60,24,216,0,134,18,29,0,59,226,97,0,176,142,71,0,7,209,161,0,189,84,51,254,155,250,72,0,213,84,235,255,45,222,224,0,238,148,143,255,170,42,53,255,78,167,117,0,186,0,40,255,125,177,103,255,69,225,66,0,227,7,88,1,75,172,6,0,169,45,227,1,16,36,70,255,50,2,9,255,139,193,22,0,143,183,231,254,218,69,50,0,236,56,161,1,213,131,42,0,138,145,44,254,136,229,40,255,49,63,35,255,61,145,245,255,101,192,2,254,232,167,113,0,152,104,38,1,121,185,218,0,121,139,211,254,119,240,35,0,65,189,217,254,187,179,162,255,160,187,230,0,62,248,14,255,60,78,97,0,255,247,163,255,225,59,91,255,107,71,58,255,241,47,33,1,50,117,236,0,219,177,63,254,244,90,179,0,35,194,215,255,189,67,50,255,23,135,129,0,104,189,37,255,185,57,194,0,35,62,231,255,220,248,108,0,12,231,178,0,143,80,91,1,131,93,101,255,144,39,2,1,255,250,178,0,5,17,236,254,139,32,46,0,204,188,38,254,245,115,52,255,191,113,73,254,191,108,69,255,22,69,245,1,23,203,178,0,170,99,170,0,65,248,111,0,37,108,153,255,64,37,69,0,0,88,62,254,89,148,144,255,191,68,224,1,241,39,53,0,41,203,237,255,145,126,194,255,221,42,253,255,25,99,151,0,97,253,223,1,74,115,49,255,6,175,72,255,59,176,203,0,124,183,249,1,228,228,99,0,129,12,207,254,168,192,195,255,204,176,16,254,152,234,171,0,77,37,85,255,33,120,135,255,142,194,227,1,31,214,58,0,213,187,125,255,232,46,60,255,190,116,42,254,151,178,19,255,51,62,237,254,204,236,193,0,194,232,60,0,172,34,157,255,189,16,184,254,103,3,95,255,141,233,36,254,41,25,11,255,21,195,166,0,118,245,45,0,67,213,149,255,159,12,18,255,187,164,227,1,160,25,5,0,12,78,195,1,43,197,225,0,48,142,41,254,196,155,60,255,223,199,18,1,145,136,156,0,252,117,169,254,145,226,238,0,239,23,107,0,109,181,188,255,230,112,49,254,73,170,237,255,231,183,227,255,80,220,20,0,194,107,127,1,127,205,101,0,46,52,197,1,210,171,36,255,88,3,90,255,56,151,141,0,96,187,255,255,42,78,200,0,254,70,70,1,244,125,168,0,204,68,138,1,124,215,70,0,102,66,200,254,17,52,228,0,117,220,143,254,203,248,123,0,56,18,174,255,186,151,164,255,51,232,208,1,160,228,43,255,249,29,25,1,68,190,63,0,8,201,188,243,103,230,9,106,59,167,202,132,133,174,103,187,43,248,148,254,114,243,110,60,241,54,29,95,58,245,79,165,209,130,230,173,127,82,14,81,31,108,62,43,140,104,5,155,107,189,65,251,171,217,131,31,121,33,126,19,25,205,224,91,34,174,40,215,152,47,138,66,205,101,239,35,145,68,55,113,47,59,77,236,207,251,192,181,188,219,137,129,165,219,181,233,56,181,72,243,91,194,86,57,25,208,5,182,241,17,241,89,155,79,25,175,164,130,63,146,24,129,109,218,213,94,28,171,66,2,3,163,152,170,7,216,190,111,112,69,1,91,131,18,140,178,228,78,190,133,49,36,226,180,255,213,195,125,12,85,111,137,123,242,116,93,190,114,177,150,22,59,254,177,222,128,53,18,199,37,167,6,220,155,148,38,105,207,116,241,155,193,210,74,241,158,193,105,155,228,227,37,79,56,134,71,190,239,181,213,140,139,198,157,193,15,101,156,172,119,204,161,12,36,117,2,43,89,111,44,233,45,131,228,166,110,170,132,116,74,212,251,65,189,220,169,176,92,181,83,17,131,218,136,249,118,171,223,102,238,82,81,62,152,16,50,180,45,109,198,49,168,63,33,251,152,200,39,3,176,228,14,239,190,199,127,89,191,194,143,168,61,243,11,224,198,37,167,10,147,71,145,167,213,111,130,3,224,81,99,202,6,112,110,14,10,103,41,41,20,252,47,210,70,133,10,183,39,38,201,38,92,56,33,27,46,237,42,196,90,252,109,44,77,223,179,149,157,19,13,56,83,222,99,175,139,84,115,10,101,168,178,119,60,187,10,106,118,230,174,237,71,46,201,194,129,59,53,130,20,133,44,114,146,100,3,241,76,161,232,191,162,1,48,66,188,75,102,26,168,145,151,248,208,112,139,75,194,48,190,84,6,163,81,108,199,24,82,239,214,25,232,146,209,16,169,101,85,36,6,153,214,42,32,113,87,133,53,14,244,184,209,187,50,112,160,106,16,200,208,210,184,22,193,164,25,83,171,65,81,8,108,55,30,153,235,142,223,76,119,72,39,168,72,155,225,181,188,176,52,99,90,201,197,179,12,28,57,203,138,65,227,74,170,216,78,115,227,99,119,79,202,156,91,163,184,178,214,243,111,46,104,252,178,239,93,238,130,143,116,96,47,23,67,111,99,165,120,114,171,240,161,20,120,200,132,236,57,100,26,8,2,199,140,40,30,99,35,250,255,190,144,233,189,130,222,235,108,80,164,21,121,198,178,247,163,249,190,43,83,114,227,242,120,113,198,156,97,38,234,206,62,39,202,7,194,192,33,199,184,134,209,30,235,224,205,214,125,218,234,120,209,110,238,127,79,125,245,186,111,23,114,170,103,240,6,166,152,200,162,197,125,99,10,174,13,249,190,4,152,63,17,27,71,28,19,53,11,113,27,132,125,4,35,245,119,219,40,147,36,199,64,123,171,202,50,188,190,201,21,10,190,158,60,76,13,16,156,196,103,29,67,182,66,62,203,190,212,197,76,42,126,101,252,156,41,127,89,236,250,214,58,171,111,203,95,23,88,71,74,140,25,68,108,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"i8",ALLOC_NONE,Runtime.GLOBAL_BASE+30720);var tempDoublePtr=Runtime.alignMemory(allocate(12,"i8",ALLOC_STATIC),8);function copyTempFloat(e){HEAP8[tempDoublePtr]=HEAP8[e],HEAP8[tempDoublePtr+1]=HEAP8[e+1],HEAP8[tempDoublePtr+2]=HEAP8[e+2],HEAP8[tempDoublePtr+3]=HEAP8[e+3]}function copyTempDouble(e){HEAP8[tempDoublePtr]=HEAP8[e],HEAP8[tempDoublePtr+1]=HEAP8[e+1],HEAP8[tempDoublePtr+2]=HEAP8[e+2],HEAP8[tempDoublePtr+3]=HEAP8[e+3],HEAP8[tempDoublePtr+4]=HEAP8[e+4],HEAP8[tempDoublePtr+5]=HEAP8[e+5],HEAP8[tempDoublePtr+6]=HEAP8[e+6],HEAP8[tempDoublePtr+7]=HEAP8[e+7]}function _abort(){Module.abort()}function _emscripten_memcpy_big(e,t,i){return HEAPU8.set(HEAPU8.subarray(t,t+i),e),e}Module._bitshift64Ashr=_bitshift64Ashr,Module._i64Subtract=_i64Subtract,Module._i64Add=_i64Add,Module._memset=_memset,Module._bitshift64Lshr=_bitshift64Lshr,Module._bitshift64Shl=_bitshift64Shl,Module._strlen=_strlen,Module._memcpy=_memcpy;var ___errno_state=0;function ___setErrNo(e){return HEAP32[___errno_state>>2]=e,e}var ERRNO_CODES={EPERM:1,ENOENT:2,ESRCH:3,EINTR:4,EIO:5,ENXIO:6,E2BIG:7,ENOEXEC:8,EBADF:9,ECHILD:10,EAGAIN:11,EWOULDBLOCK:11,ENOMEM:12,EACCES:13,EFAULT:14,ENOTBLK:15,EBUSY:16,EEXIST:17,EXDEV:18,ENODEV:19,ENOTDIR:20,EISDIR:21,EINVAL:22,ENFILE:23,EMFILE:24,ENOTTY:25,ETXTBSY:26,EFBIG:27,ENOSPC:28,ESPIPE:29,EROFS:30,EMLINK:31,EPIPE:32,EDOM:33,ERANGE:34,ENOMSG:42,EIDRM:43,ECHRNG:44,EL2NSYNC:45,EL3HLT:46,EL3RST:47,ELNRNG:48,EUNATCH:49,ENOCSI:50,EL2HLT:51,EDEADLK:35,ENOLCK:37,EBADE:52,EBADR:53,EXFULL:54,ENOANO:55,EBADRQC:56,EBADSLT:57,EDEADLOCK:35,EBFONT:59,ENOSTR:60,ENODATA:61,ETIME:62,ENOSR:63,ENONET:64,ENOPKG:65,EREMOTE:66,ENOLINK:67,EADV:68,ESRMNT:69,ECOMM:70,EPROTO:71,EMULTIHOP:72,EDOTDOT:73,EBADMSG:74,ENOTUNIQ:76,EBADFD:77,EREMCHG:78,ELIBACC:79,ELIBBAD:80,ELIBSCN:81,ELIBMAX:82,ELIBEXEC:83,ENOSYS:38,ENOTEMPTY:39,ENAMETOOLONG:36,ELOOP:40,EOPNOTSUPP:95,EPFNOSUPPORT:96,ECONNRESET:104,ENOBUFS:105,EAFNOSUPPORT:97,EPROTOTYPE:91,ENOTSOCK:88,ENOPROTOOPT:92,ESHUTDOWN:108,ECONNREFUSED:111,EADDRINUSE:98,ECONNABORTED:103,ENETUNREACH:101,ENETDOWN:100,ETIMEDOUT:110,EHOSTDOWN:112,EHOSTUNREACH:113,EINPROGRESS:115,EALREADY:114,EDESTADDRREQ:89,EMSGSIZE:90,EPROTONOSUPPORT:93,ESOCKTNOSUPPORT:94,EADDRNOTAVAIL:99,ENETRESET:102,EISCONN:106,ENOTCONN:107,ETOOMANYREFS:109,EUSERS:87,EDQUOT:122,ESTALE:116,ENOTSUP:95,ENOMEDIUM:123,EILSEQ:84,EOVERFLOW:75,ECANCELED:125,ENOTRECOVERABLE:131,EOWNERDEAD:130,ESTRPIPE:86};function _sysconf(e){switch(e){case 30:return PAGE_SIZE;case 132:case 133:case 12:case 137:case 138:case 15:case 235:case 16:case 17:case 18:case 19:case 20:case 149:case 13:case 10:case 236:case 153:case 9:case 21:case 22:case 159:case 154:case 14:case 77:case 78:case 139:case 80:case 81:case 79:case 82:case 68:case 67:case 164:case 11:case 29:case 47:case 48:case 95:case 52:case 51:case 46:return 200809;case 27:case 246:case 127:case 128:case 23:case 24:case 160:case 161:case 181:case 182:case 242:case 183:case 184:case 243:case 244:case 245:case 165:case 178:case 179:case 49:case 50:case 168:case 169:case 175:case 170:case 171:case 172:case 97:case 76:case 32:case 173:case 35:return-1;case 176:case 177:case 7:case 155:case 8:case 157:case 125:case 126:case 92:case 93:case 129:case 130:case 131:case 94:case 91:return 1;case 74:case 60:case 69:case 70:case 4:return 1024;case 31:case 42:case 72:return 32;case 87:case 26:case 33:return 2147483647;case 34:case 1:return 47839;case 38:case 36:return 99;case 43:case 37:return 2048;case 0:return 2097152;case 3:return 65536;case 28:return 32768;case 44:return 32767;case 75:return 16384;case 39:return 1e3;case 89:return 700;case 71:return 256;case 40:return 255;case 2:return 100;case 180:return 64;case 25:return 20;case 5:return 16;case 6:return 6;case 73:return 4;case 84:return"object"==typeof navigator&&navigator.hardwareConcurrency||1}return ___setErrNo(ERRNO_CODES.EINVAL),-1}function _sbrk(e){var t=_sbrk;t.called||(DYNAMICTOP=alignMemoryPage(DYNAMICTOP),t.called=!0,t.alloc=Runtime.dynamicAlloc,Runtime.dynamicAlloc=function(){abort("cannot dynamically allocate, sbrk now has control")});var i=DYNAMICTOP;return 0!=e&&t.alloc(e),i}function ___errno_location(){return ___errno_state}Module._memmove=_memmove;var ERRNO_MESSAGES={0:"Success",1:"Not super-user",2:"No such file or directory",3:"No such process",4:"Interrupted system call",5:"I/O error",6:"No such device or address",7:"Arg list too long",8:"Exec format error",9:"Bad file number",10:"No children",11:"No more processes",12:"Not enough core",13:"Permission denied",14:"Bad address",15:"Block device required",16:"Mount device busy",17:"File exists",18:"Cross-device link",19:"No such device",20:"Not a directory",21:"Is a directory",22:"Invalid argument",23:"Too many open files in system",24:"Too many open files",25:"Not a typewriter",26:"Text file busy",27:"File too large",28:"No space left on device",29:"Illegal seek",30:"Read only file system",31:"Too many links",32:"Broken pipe",33:"Math arg out of domain of func",34:"Math result not representable",35:"File locking deadlock error",36:"File or path name too long",37:"No record locks available",38:"Function not implemented",39:"Directory not empty",40:"Too many symbolic links",42:"No message of desired type",43:"Identifier removed",44:"Channel number out of range",45:"Level 2 not synchronized",46:"Level 3 halted",47:"Level 3 reset",48:"Link number out of range",49:"Protocol driver not attached",50:"No CSI structure available",51:"Level 2 halted",52:"Invalid exchange",53:"Invalid request descriptor",54:"Exchange full",55:"No anode",56:"Invalid request code",57:"Invalid slot",59:"Bad font file fmt",60:"Device not a stream",61:"No data (for no delay io)",62:"Timer expired",63:"Out of streams resources",64:"Machine is not on the network",65:"Package not installed",66:"The object is remote",67:"The link has been severed",68:"Advertise error",69:"Srmount error",70:"Communication error on send",71:"Protocol error",72:"Multihop attempted",73:"Cross mount point (not really error)",74:"Trying to read unreadable message",75:"Value too large for defined data type",76:"Given log. name not unique",77:"f.d. invalid for this operation",78:"Remote address changed",79:"Can   access a needed shared lib",80:"Accessing a corrupted shared lib",81:".lib section in a.out corrupted",82:"Attempting to link in too many libs",83:"Attempting to exec a shared library",84:"Illegal byte sequence",86:"Streams pipe error",87:"Too many users",88:"Socket operation on non-socket",89:"Destination address required",90:"Message too long",91:"Protocol wrong type for socket",92:"Protocol not available",93:"Unknown protocol",94:"Socket type not supported",95:"Not supported",96:"Protocol family not supported",97:"Address family not supported by protocol family",98:"Address already in use",99:"Address not available",100:"Network interface is not configured",101:"Network is unreachable",102:"Connection reset by network",103:"Connection aborted",104:"Connection reset by peer",105:"No buffer space available",106:"Socket is already connected",107:"Socket is not connected",108:"Can't send after socket shutdown",109:"Too many references",110:"Connection timed out",111:"Connection refused",112:"Host is down",113:"Host is unreachable",114:"Socket already connected",115:"Connection already in progress",116:"Stale file handle",122:"Quota exceeded",123:"No medium (in tape drive)",125:"Operation canceled",130:"Previous owner died",131:"State not recoverable"},TTY={ttys:[],init:function(){},shutdown:function(){},register:function(e,t){TTY.ttys[e]={input:[],output:[],ops:t},FS.registerDevice(e,TTY.stream_ops)},stream_ops:{open:function(e){var t=TTY.ttys[e.node.rdev];if(!t)throw new FS.ErrnoError(ERRNO_CODES.ENODEV);e.tty=t,e.seekable=!1},close:function(e){e.tty.ops.flush(e.tty)},flush:function(e){e.tty.ops.flush(e.tty)},read:function(e,t,i,n,r){if(!e.tty||!e.tty.ops.get_char)throw new FS.ErrnoError(ERRNO_CODES.ENXIO);for(var s=0,a=0;a<n;a++){var o;try{o=e.tty.ops.get_char(e.tty)}catch(e){throw new FS.ErrnoError(ERRNO_CODES.EIO)}if(void 0===o&&0===s)throw new FS.ErrnoError(ERRNO_CODES.EAGAIN);if(null==o)break;s++,t[i+a]=o}return s&&(e.node.timestamp=Date.now()),s},write:function(e,t,i,n,r){if(!e.tty||!e.tty.ops.put_char)throw new FS.ErrnoError(ERRNO_CODES.ENXIO);for(var s=0;s<n;s++)try{e.tty.ops.put_char(e.tty,t[i+s])}catch(e){throw new FS.ErrnoError(ERRNO_CODES.EIO)}return n&&(e.node.timestamp=Date.now()),s}},default_tty_ops:{get_char:function(e){if(!e.input.length){var t=null;if(ENVIRONMENT_IS_NODE){if(!(t=process.stdin.read()))return process.stdin._readableState&&process.stdin._readableState.ended?null:void 0}else"undefined"!=typeof window&&"function"==typeof window.prompt?null!==(t=window.prompt("Input: "))&&(t+="\n"):"function"==typeof readline&&null!==(t=readline())&&(t+="\n");if(!t)return null;e.input=intArrayFromString(t,!0)}return e.input.shift()},flush:function(e){e.output&&e.output.length>0&&(Module.print(e.output.join("")),e.output=[])},put_char:function(e,t){null===t||10===t?(Module.print(e.output.join("")),e.output=[]):e.output.push(TTY.utf8.processCChar(t))}},default_tty1_ops:{put_char:function(e,t){null===t||10===t?(Module.printErr(e.output.join("")),e.output=[]):e.output.push(TTY.utf8.processCChar(t))},flush:function(e){e.output&&e.output.length>0&&(Module.printErr(e.output.join("")),e.output=[])}}},MEMFS={ops_table:null,mount:function(e){return MEMFS.createNode(null,"/",16895,0)},createNode:function(e,t,i,n){if(FS.isBlkdev(i)||FS.isFIFO(i))throw new FS.ErrnoError(ERRNO_CODES.EPERM);MEMFS.ops_table||(MEMFS.ops_table={dir:{node:{getattr:MEMFS.node_ops.getattr,setattr:MEMFS.node_ops.setattr,lookup:MEMFS.node_ops.lookup,mknod:MEMFS.node_ops.mknod,rename:MEMFS.node_ops.rename,unlink:MEMFS.node_ops.unlink,rmdir:MEMFS.node_ops.rmdir,readdir:MEMFS.node_ops.readdir,symlink:MEMFS.node_ops.symlink},stream:{llseek:MEMFS.stream_ops.llseek}},file:{node:{getattr:MEMFS.node_ops.getattr,setattr:MEMFS.node_ops.setattr},stream:{llseek:MEMFS.stream_ops.llseek,read:MEMFS.stream_ops.read,write:MEMFS.stream_ops.write,allocate:MEMFS.stream_ops.allocate,mmap:MEMFS.stream_ops.mmap}},link:{node:{getattr:MEMFS.node_ops.getattr,setattr:MEMFS.node_ops.setattr,readlink:MEMFS.node_ops.readlink},stream:{}},chrdev:{node:{getattr:MEMFS.node_ops.getattr,setattr:MEMFS.node_ops.setattr},stream:FS.chrdev_stream_ops}});var r=FS.createNode(e,t,i,n);return FS.isDir(r.mode)?(r.node_ops=MEMFS.ops_table.dir.node,r.stream_ops=MEMFS.ops_table.dir.stream,r.contents={}):FS.isFile(r.mode)?(r.node_ops=MEMFS.ops_table.file.node,r.stream_ops=MEMFS.ops_table.file.stream,r.usedBytes=0,r.contents=null):FS.isLink(r.mode)?(r.node_ops=MEMFS.ops_table.link.node,r.stream_ops=MEMFS.ops_table.link.stream):FS.isChrdev(r.mode)&&(r.node_ops=MEMFS.ops_table.chrdev.node,r.stream_ops=MEMFS.ops_table.chrdev.stream),r.timestamp=Date.now(),e&&(e.contents[t]=r),r},getFileDataAsRegularArray:function(e){if(e.contents&&e.contents.subarray){for(var t=[],i=0;i<e.usedBytes;++i)t.push(e.contents[i]);return t}return e.contents},getFileDataAsTypedArray:function(e){return e.contents?e.contents.subarray?e.contents.subarray(0,e.usedBytes):new Uint8Array(e.contents):new Uint8Array},expandFileStorage:function(e,t){if(e.contents&&e.contents.subarray&&t>e.contents.length&&(e.contents=MEMFS.getFileDataAsRegularArray(e),e.usedBytes=e.contents.length),!e.contents||e.contents.subarray){var i=e.contents?e.contents.buffer.byteLength:0;if(i>=t)return;t=Math.max(t,i*(i<1048576?2:1.125)|0),0!=i&&(t=Math.max(t,256));var n=e.contents;return e.contents=new Uint8Array(t),void(e.usedBytes>0&&e.contents.set(n.subarray(0,e.usedBytes),0))}for(!e.contents&&t>0&&(e.contents=[]);e.contents.length<t;)e.contents.push(0)},resizeFileStorage:function(e,t){if(e.usedBytes!=t){if(0==t)return e.contents=null,void(e.usedBytes=0);if(!e.contents||e.contents.subarray){var i=e.contents;return e.contents=new Uint8Array(new ArrayBuffer(t)),i&&e.contents.set(i.subarray(0,Math.min(t,e.usedBytes))),void(e.usedBytes=t)}if(e.contents||(e.contents=[]),e.contents.length>t)e.contents.length=t;else for(;e.contents.length<t;)e.contents.push(0);e.usedBytes=t}},node_ops:{getattr:function(e){var t={};return t.dev=FS.isChrdev(e.mode)?e.id:1,t.ino=e.id,t.mode=e.mode,t.nlink=1,t.uid=0,t.gid=0,t.rdev=e.rdev,FS.isDir(e.mode)?t.size=4096:FS.isFile(e.mode)?t.size=e.usedBytes:FS.isLink(e.mode)?t.size=e.link.length:t.size=0,t.atime=new Date(e.timestamp),t.mtime=new Date(e.timestamp),t.ctime=new Date(e.timestamp),t.blksize=4096,t.blocks=Math.ceil(t.size/t.blksize),t},setattr:function(e,t){void 0!==t.mode&&(e.mode=t.mode),void 0!==t.timestamp&&(e.timestamp=t.timestamp),void 0!==t.size&&MEMFS.resizeFileStorage(e,t.size)},lookup:function(e,t){throw FS.genericErrors[ERRNO_CODES.ENOENT]},mknod:function(e,t,i,n){return MEMFS.createNode(e,t,i,n)},rename:function(e,t,i){if(FS.isDir(e.mode)){var n;try{n=FS.lookupNode(t,i)}catch(e){}if(n)for(var r in n.contents)throw new FS.ErrnoError(ERRNO_CODES.ENOTEMPTY)}delete e.parent.contents[e.name],e.name=i,t.contents[i]=e,e.parent=t},unlink:function(e,t){delete e.contents[t]},rmdir:function(e,t){var i=FS.lookupNode(e,t);for(var n in i.contents)throw new FS.ErrnoError(ERRNO_CODES.ENOTEMPTY);delete e.contents[t]},readdir:function(e){var t=[".",".."];for(var i in e.contents)e.contents.hasOwnProperty(i)&&t.push(i);return t},symlink:function(e,t,i){var n=MEMFS.createNode(e,t,41471,0);return n.link=i,n},readlink:function(e){if(!FS.isLink(e.mode))throw new FS.ErrnoError(ERRNO_CODES.EINVAL);return e.link}},stream_ops:{read:function(e,t,i,n,r){var s=e.node.contents;if(r>=e.node.usedBytes)return 0;var a=Math.min(e.node.usedBytes-r,n);if(a>8&&s.subarray)t.set(s.subarray(r,r+a),i);else for(var o=0;o<a;o++)t[i+o]=s[r+o];return a},write:function(e,t,i,n,r,s){if(!n)return 0;var a=e.node;if(a.timestamp=Date.now(),t.subarray&&(!a.contents||a.contents.subarray)){if(s)return a.contents=t.subarray(i,i+n),a.usedBytes=n,n;if(0===a.usedBytes&&0===r)return a.contents=new Uint8Array(t.subarray(i,i+n)),a.usedBytes=n,n;if(r+n<=a.usedBytes)return a.contents.set(t.subarray(i,i+n),r),n}if(MEMFS.expandFileStorage(a,r+n),a.contents.subarray&&t.subarray)a.contents.set(t.subarray(i,i+n),r);else for(var o=0;o<n;o++)a.contents[r+o]=t[i+o];return a.usedBytes=Math.max(a.usedBytes,r+n),n},llseek:function(e,t,i){var n=t;if(1===i?n+=e.position:2===i&&FS.isFile(e.node.mode)&&(n+=e.node.usedBytes),n<0)throw new FS.ErrnoError(ERRNO_CODES.EINVAL);return n},allocate:function(e,t,i){MEMFS.expandFileStorage(e.node,t+i),e.node.usedBytes=Math.max(e.node.usedBytes,t+i)},mmap:function(e,t,i,n,r,s,a){if(!FS.isFile(e.node.mode))throw new FS.ErrnoError(ERRNO_CODES.ENODEV);var o,l,d=e.node.contents;if(2&a||d.buffer!==t&&d.buffer!==t.buffer){if((r>0||r+n<e.node.usedBytes)&&(d=d.subarray?d.subarray(r,r+n):Array.prototype.slice.call(d,r,r+n)),l=!0,!(o=_malloc(n)))throw new FS.ErrnoError(ERRNO_CODES.ENOMEM);t.set(d,o)}else l=!1,o=d.byteOffset;return{ptr:o,allocated:l}}}},IDBFS={dbs:{},indexedDB:function(){if("undefined"!=typeof indexedDB)return indexedDB;var e=null;return"object"==typeof window&&(e=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB),e},DB_VERSION:21,DB_STORE_NAME:"FILE_DATA",mount:function(e){return MEMFS.mount.apply(null,arguments)},syncfs:function(e,t,i){IDBFS.getLocalSet(e,(function(n,r){if(n)return i(n);IDBFS.getRemoteSet(e,(function(e,n){if(e)return i(e);var s=t?n:r,a=t?r:n;IDBFS.reconcile(s,a,i)}))}))},getDB:function(e,t){var i,n=IDBFS.dbs[e];if(n)return t(null,n);try{i=IDBFS.indexedDB().open(e,IDBFS.DB_VERSION)}catch(e){return t(e)}i.onupgradeneeded=function(e){var t=e.target.result,i=e.target.transaction;(t.objectStoreNames.contains(IDBFS.DB_STORE_NAME)?i.objectStore(IDBFS.DB_STORE_NAME):t.createObjectStore(IDBFS.DB_STORE_NAME)).createIndex("timestamp","timestamp",{unique:!1})},i.onsuccess=function(){n=i.result,IDBFS.dbs[e]=n,t(null,n)},i.onerror=function(){t(this.error)}},getLocalSet:function(e,t){var i={};function n(e){return"."!==e&&".."!==e}function r(e){return function(t){return PATH.join2(e,t)}}for(var s=FS.readdir(e.mountpoint).filter(n).map(r(e.mountpoint));s.length;){var a,o=s.pop();try{a=FS.stat(o)}catch(e){return t(e)}FS.isDir(a.mode)&&s.push.apply(s,FS.readdir(o).filter(n).map(r(o))),i[o]={timestamp:a.mtime}}return t(null,{type:"local",entries:i})},getRemoteSet:function(e,t){var i={};IDBFS.getDB(e.mountpoint,(function(e,n){if(e)return t(e);var r=n.transaction([IDBFS.DB_STORE_NAME],"readonly");r.onerror=function(){t(this.error)},r.objectStore(IDBFS.DB_STORE_NAME).index("timestamp").openKeyCursor().onsuccess=function(e){var r=e.target.result;if(!r)return t(null,{type:"remote",db:n,entries:i});i[r.primaryKey]={timestamp:r.key},r.continue()}}))},loadLocalEntry:function(e,t){var i,n;try{n=FS.lookupPath(e).node,i=FS.stat(e)}catch(e){return t(e)}return FS.isDir(i.mode)?t(null,{timestamp:i.mtime,mode:i.mode}):FS.isFile(i.mode)?(n.contents=MEMFS.getFileDataAsTypedArray(n),t(null,{timestamp:i.mtime,mode:i.mode,contents:n.contents})):t(new Error("node type not supported"))},storeLocalEntry:function(e,t,i){try{if(FS.isDir(t.mode))FS.mkdir(e,t.mode);else{if(!FS.isFile(t.mode))return i(new Error("node type not supported"));FS.writeFile(e,t.contents,{encoding:"binary",canOwn:!0})}FS.chmod(e,t.mode),FS.utime(e,t.timestamp,t.timestamp)}catch(e){return i(e)}i(null)},removeLocalEntry:function(e,t){try{FS.lookupPath(e);var i=FS.stat(e);FS.isDir(i.mode)?FS.rmdir(e):FS.isFile(i.mode)&&FS.unlink(e)}catch(e){return t(e)}t(null)},loadRemoteEntry:function(e,t,i){var n=e.get(t);n.onsuccess=function(e){i(null,e.target.result)},n.onerror=function(){i(this.error)}},storeRemoteEntry:function(e,t,i,n){var r=e.put(i,t);r.onsuccess=function(){n(null)},r.onerror=function(){n(this.error)}},removeRemoteEntry:function(e,t,i){var n=e.delete(t);n.onsuccess=function(){i(null)},n.onerror=function(){i(this.error)}},reconcile:function(e,t,i){var n=0,r=[];Object.keys(e.entries).forEach((function(i){var s=e.entries[i],a=t.entries[i];(!a||s.timestamp>a.timestamp)&&(r.push(i),n++)}));var s=[];if(Object.keys(t.entries).forEach((function(i){t.entries[i];e.entries[i]||(s.push(i),n++)})),!n)return i(null);var a=0,o=("remote"===e.type?e.db:t.db).transaction([IDBFS.DB_STORE_NAME],"readwrite"),l=o.objectStore(IDBFS.DB_STORE_NAME);function d(e){return e?d.errored?void 0:(d.errored=!0,i(e)):++a>=n?i(null):void 0}o.onerror=function(){d(this.error)},r.sort().forEach((function(e){"local"===t.type?IDBFS.loadRemoteEntry(l,e,(function(t,i){if(t)return d(t);IDBFS.storeLocalEntry(e,i,d)})):IDBFS.loadLocalEntry(e,(function(t,i){if(t)return d(t);IDBFS.storeRemoteEntry(l,e,i,d)}))})),s.sort().reverse().forEach((function(e){"local"===t.type?IDBFS.removeLocalEntry(e,d):IDBFS.removeRemoteEntry(l,e,d)}))}},NODEFS={isWindows:!1,staticInit:function(){NODEFS.isWindows=!!process.platform.match(/^win/)},mount:function(e){return NODEFS.createNode(null,"/",NODEFS.getMode(e.opts.root),0)},createNode:function(e,t,i,n){if(!FS.isDir(i)&&!FS.isFile(i)&&!FS.isLink(i))throw new FS.ErrnoError(ERRNO_CODES.EINVAL);var r=FS.createNode(e,t,i);return r.node_ops=NODEFS.node_ops,r.stream_ops=NODEFS.stream_ops,r},getMode:function(e){var t;try{t=fs.lstatSync(e),NODEFS.isWindows&&(t.mode=t.mode|(146&t.mode)>>1)}catch(e){if(!e.code)throw e;throw new FS.ErrnoError(ERRNO_CODES[e.code])}return t.mode},realPath:function(e){for(var t=[];e.parent!==e;)t.push(e.name),e=e.parent;return t.push(e.mount.opts.root),t.reverse(),PATH.join.apply(null,t)},flagsToPermissionStringMap:{0:"r",1:"r+",2:"r+",64:"r",65:"r+",66:"r+",129:"rx+",193:"rx+",514:"w+",577:"w",578:"w+",705:"wx",706:"wx+",1024:"a",1025:"a",1026:"a+",1089:"a",1090:"a+",1153:"ax",1154:"ax+",1217:"ax",1218:"ax+",4096:"rs",4098:"rs+"},flagsToPermissionString:function(e){return e in NODEFS.flagsToPermissionStringMap?NODEFS.flagsToPermissionStringMap[e]:e},node_ops:{getattr:function(e){var t,i=NODEFS.realPath(e);try{t=fs.lstatSync(i)}catch(e){if(!e.code)throw e;throw new FS.ErrnoError(ERRNO_CODES[e.code])}return NODEFS.isWindows&&!t.blksize&&(t.blksize=4096),NODEFS.isWindows&&!t.blocks&&(t.blocks=(t.size+t.blksize-1)/t.blksize|0),{dev:t.dev,ino:t.ino,mode:t.mode,nlink:t.nlink,uid:t.uid,gid:t.gid,rdev:t.rdev,size:t.size,atime:t.atime,mtime:t.mtime,ctime:t.ctime,blksize:t.blksize,blocks:t.blocks}},setattr:function(e,t){var i=NODEFS.realPath(e);try{if(void 0!==t.mode&&(fs.chmodSync(i,t.mode),e.mode=t.mode),void 0!==t.timestamp){var n=new Date(t.timestamp);fs.utimesSync(i,n,n)}void 0!==t.size&&fs.truncateSync(i,t.size)}catch(e){if(!e.code)throw e;throw new FS.ErrnoError(ERRNO_CODES[e.code])}},lookup:function(e,t){var i=PATH.join2(NODEFS.realPath(e),t),n=NODEFS.getMode(i);return NODEFS.createNode(e,t,n)},mknod:function(e,t,i,n){var r=NODEFS.createNode(e,t,i,n),s=NODEFS.realPath(r);try{FS.isDir(r.mode)?fs.mkdirSync(s,r.mode):fs.writeFileSync(s,"",{mode:r.mode})}catch(e){if(!e.code)throw e;throw new FS.ErrnoError(ERRNO_CODES[e.code])}return r},rename:function(e,t,i){var n=NODEFS.realPath(e),r=PATH.join2(NODEFS.realPath(t),i);try{fs.renameSync(n,r)}catch(e){if(!e.code)throw e;throw new FS.ErrnoError(ERRNO_CODES[e.code])}},unlink:function(e,t){var i=PATH.join2(NODEFS.realPath(e),t);try{fs.unlinkSync(i)}catch(e){if(!e.code)throw e;throw new FS.ErrnoError(ERRNO_CODES[e.code])}},rmdir:function(e,t){var i=PATH.join2(NODEFS.realPath(e),t);try{fs.rmdirSync(i)}catch(e){if(!e.code)throw e;throw new FS.ErrnoError(ERRNO_CODES[e.code])}},readdir:function(e){var t=NODEFS.realPath(e);try{return fs.readdirSync(t)}catch(e){if(!e.code)throw e;throw new FS.ErrnoError(ERRNO_CODES[e.code])}},symlink:function(e,t,i){var n=PATH.join2(NODEFS.realPath(e),t);try{fs.symlinkSync(i,n)}catch(e){if(!e.code)throw e;throw new FS.ErrnoError(ERRNO_CODES[e.code])}},readlink:function(e){var t=NODEFS.realPath(e);try{return fs.readlinkSync(t)}catch(e){if(!e.code)throw e;throw new FS.ErrnoError(ERRNO_CODES[e.code])}}},stream_ops:{open:function(e){var t=NODEFS.realPath(e.node);try{FS.isFile(e.node.mode)&&(e.nfd=fs.openSync(t,NODEFS.flagsToPermissionString(e.flags)))}catch(e){if(!e.code)throw e;throw new FS.ErrnoError(ERRNO_CODES[e.code])}},close:function(e){try{FS.isFile(e.node.mode)&&e.nfd&&fs.closeSync(e.nfd)}catch(e){if(!e.code)throw e;throw new FS.ErrnoError(ERRNO_CODES[e.code])}},read:function(e,t,i,n,r){if(0===n)return 0;var s,a=new Buffer(n);try{s=fs.readSync(e.nfd,a,0,n,r)}catch(e){throw new FS.ErrnoError(ERRNO_CODES[e.code])}if(s>0)for(var o=0;o<s;o++)t[i+o]=a[o];return s},write:function(e,t,i,n,r){var s,a=new Buffer(t.subarray(i,i+n));try{s=fs.writeSync(e.nfd,a,0,n,r)}catch(e){throw new FS.ErrnoError(ERRNO_CODES[e.code])}return s},llseek:function(e,t,i){var n=t;if(1===i)n+=e.position;else if(2===i&&FS.isFile(e.node.mode))try{n+=fs.fstatSync(e.nfd).size}catch(e){throw new FS.ErrnoError(ERRNO_CODES[e.code])}if(n<0)throw new FS.ErrnoError(ERRNO_CODES.EINVAL);return n}}},_stdin=allocate(1,"i32*",ALLOC_STATIC),_stdout=allocate(1,"i32*",ALLOC_STATIC),_stderr=allocate(1,"i32*",ALLOC_STATIC);function _fflush(e){}var FS={root:null,mounts:[],devices:[null],streams:[],nextInode:1,nameTable:null,currentPath:"/",initialized:!1,ignorePermissions:!0,trackingDelegate:{},tracking:{openFlags:{READ:1,WRITE:2}},ErrnoError:null,genericErrors:{},handleFSError:function(e){if(!(e instanceof FS.ErrnoError))throw e+" : "+stackTrace();return ___setErrNo(e.errno)},lookupPath:function(e,t){if(t=t||{},!(e=PATH.resolve(FS.cwd(),e)))return{path:"",node:null};var i={follow_mount:!0,recurse_count:0};for(var n in i)void 0===t[n]&&(t[n]=i[n]);if(t.recurse_count>8)throw new FS.ErrnoError(ERRNO_CODES.ELOOP);for(var r=PATH.normalizeArray(e.split("/").filter((function(e){return!!e})),!1),s=FS.root,a="/",o=0;o<r.length;o++){var l=o===r.length-1;if(l&&t.parent)break;if(s=FS.lookupNode(s,r[o]),a=PATH.join2(a,r[o]),FS.isMountpoint(s)&&(!l||l&&t.follow_mount)&&(s=s.mounted.root),!l||t.follow)for(var d=0;FS.isLink(s.mode);){var c=FS.readlink(a);if(a=PATH.resolve(PATH.dirname(a),c),s=FS.lookupPath(a,{recurse_count:t.recurse_count}).node,d++>40)throw new FS.ErrnoError(ERRNO_CODES.ELOOP)}}return{path:a,node:s}},getPath:function(e){for(var t;;){if(FS.isRoot(e)){var i=e.mount.mountpoint;return t?"/"!==i[i.length-1]?i+"/"+t:i+t:i}t=t?e.name+"/"+t:e.name,e=e.parent}},hashName:function(e,t){for(var i=0,n=0;n<t.length;n++)i=(i<<5)-i+t.charCodeAt(n)|0;return(e+i>>>0)%FS.nameTable.length},hashAddNode:function(e){var t=FS.hashName(e.parent.id,e.name);e.name_next=FS.nameTable[t],FS.nameTable[t]=e},hashRemoveNode:function(e){var t=FS.hashName(e.parent.id,e.name);if(FS.nameTable[t]===e)FS.nameTable[t]=e.name_next;else for(var i=FS.nameTable[t];i;){if(i.name_next===e){i.name_next=e.name_next;break}i=i.name_next}},lookupNode:function(e,t){var i=FS.mayLookup(e);if(i)throw new FS.ErrnoError(i,e);for(var n=FS.hashName(e.id,t),r=FS.nameTable[n];r;r=r.name_next){var s=r.name;if(r.parent.id===e.id&&s===t)return r}return FS.lookup(e,t)},createNode:function(e,t,i,n){if(!FS.FSNode){FS.FSNode=function(e,t,i,n){e||(e=this),this.parent=e,this.mount=e.mount,this.mounted=null,this.id=FS.nextInode++,this.name=t,this.mode=i,this.node_ops={},this.stream_ops={},this.rdev=n},FS.FSNode.prototype={};var r=365,s=146;Object.defineProperties(FS.FSNode.prototype,{read:{get:function(){return(this.mode&r)===r},set:function(e){e?this.mode|=r:this.mode&=-366}},write:{get:function(){return(this.mode&s)===s},set:function(e){e?this.mode|=s:this.mode&=-147}},isFolder:{get:function(){return FS.isDir(this.mode)}},isDevice:{get:function(){return FS.isChrdev(this.mode)}}})}var a=new FS.FSNode(e,t,i,n);return FS.hashAddNode(a),a},destroyNode:function(e){FS.hashRemoveNode(e)},isRoot:function(e){return e===e.parent},isMountpoint:function(e){return!!e.mounted},isFile:function(e){return 32768==(61440&e)},isDir:function(e){return 16384==(61440&e)},isLink:function(e){return 40960==(61440&e)},isChrdev:function(e){return 8192==(61440&e)},isBlkdev:function(e){return 24576==(61440&e)},isFIFO:function(e){return 4096==(61440&e)},isSocket:function(e){return 49152==(49152&e)},flagModes:{r:0,rs:1052672,"r+":2,w:577,wx:705,xw:705,"w+":578,"wx+":706,"xw+":706,a:1089,ax:1217,xa:1217,"a+":1090,"ax+":1218,"xa+":1218},modeStringToFlags:function(e){var t=FS.flagModes[e];if(void 0===t)throw new Error("Unknown file open mode: "+e);return t},flagsToPermissionString:function(e){var t=["r","w","rw"][2097155&e];return 512&e&&(t+="w"),t},nodePermissions:function(e,t){return FS.ignorePermissions||(-1===t.indexOf("r")||292&e.mode)&&(-1===t.indexOf("w")||146&e.mode)&&(-1===t.indexOf("x")||73&e.mode)?0:ERRNO_CODES.EACCES},mayLookup:function(e){var t=FS.nodePermissions(e,"x");return t||(e.node_ops.lookup?0:ERRNO_CODES.EACCES)},mayCreate:function(e,t){try{FS.lookupNode(e,t);return ERRNO_CODES.EEXIST}catch(e){}return FS.nodePermissions(e,"wx")},mayDelete:function(e,t,i){var n;try{n=FS.lookupNode(e,t)}catch(e){return e.errno}var r=FS.nodePermissions(e,"wx");if(r)return r;if(i){if(!FS.isDir(n.mode))return ERRNO_CODES.ENOTDIR;if(FS.isRoot(n)||FS.getPath(n)===FS.cwd())return ERRNO_CODES.EBUSY}else if(FS.isDir(n.mode))return ERRNO_CODES.EISDIR;return 0},mayOpen:function(e,t){return e?FS.isLink(e.mode)?ERRNO_CODES.ELOOP:FS.isDir(e.mode)&&(0!=(2097155&t)||512&t)?ERRNO_CODES.EISDIR:FS.nodePermissions(e,FS.flagsToPermissionString(t)):ERRNO_CODES.ENOENT},MAX_OPEN_FDS:4096,nextfd:function(e,t){e=e||0,t=t||FS.MAX_OPEN_FDS;for(var i=e;i<=t;i++)if(!FS.streams[i])return i;throw new FS.ErrnoError(ERRNO_CODES.EMFILE)},getStream:function(e){return FS.streams[e]},createStream:function(e,t,i){FS.FSStream||(FS.FSStream=function(){},FS.FSStream.prototype={},Object.defineProperties(FS.FSStream.prototype,{object:{get:function(){return this.node},set:function(e){this.node=e}},isRead:{get:function(){return 1!=(2097155&this.flags)}},isWrite:{get:function(){return 0!=(2097155&this.flags)}},isAppend:{get:function(){return 1024&this.flags}}}));var n=new FS.FSStream;for(var r in e)n[r]=e[r];e=n;var s=FS.nextfd(t,i);return e.fd=s,FS.streams[s]=e,e},closeStream:function(e){FS.streams[e]=null},getStreamFromPtr:function(e){return FS.streams[e-1]},getPtrForStream:function(e){return e?e.fd+1:0},chrdev_stream_ops:{open:function(e){var t=FS.getDevice(e.node.rdev);e.stream_ops=t.stream_ops,e.stream_ops.open&&e.stream_ops.open(e)},llseek:function(){throw new FS.ErrnoError(ERRNO_CODES.ESPIPE)}},major:function(e){return e>>8},minor:function(e){return 255&e},makedev:function(e,t){return e<<8|t},registerDevice:function(e,t){FS.devices[e]={stream_ops:t}},getDevice:function(e){return FS.devices[e]},getMounts:function(e){for(var t=[],i=[e];i.length;){var n=i.pop();t.push(n),i.push.apply(i,n.mounts)}return t},syncfs:function(e,t){"function"==typeof e&&(t=e,e=!1);var i=FS.getMounts(FS.root.mount),n=0;function r(e){if(e)return r.errored?void 0:(r.errored=!0,t(e));++n>=i.length&&t(null)}i.forEach((function(t){if(!t.type.syncfs)return r(null);t.type.syncfs(t,e,r)}))},mount:function(e,t,i){var n,r="/"===i,s=!i;if(r&&FS.root)throw new FS.ErrnoError(ERRNO_CODES.EBUSY);if(!r&&!s){var a=FS.lookupPath(i,{follow_mount:!1});if(i=a.path,n=a.node,FS.isMountpoint(n))throw new FS.ErrnoError(ERRNO_CODES.EBUSY);if(!FS.isDir(n.mode))throw new FS.ErrnoError(ERRNO_CODES.ENOTDIR)}var o={type:e,opts:t,mountpoint:i,mounts:[]},l=e.mount(o);return l.mount=o,o.root=l,r?FS.root=l:n&&(n.mounted=o,n.mount&&n.mount.mounts.push(o)),l},unmount:function(e){var t=FS.lookupPath(e,{follow_mount:!1});if(!FS.isMountpoint(t.node))throw new FS.ErrnoError(ERRNO_CODES.EINVAL);var i=t.node,n=i.mounted,r=FS.getMounts(n);Object.keys(FS.nameTable).forEach((function(e){for(var t=FS.nameTable[e];t;){var i=t.name_next;-1!==r.indexOf(t.mount)&&FS.destroyNode(t),t=i}})),i.mounted=null;var s=i.mount.mounts.indexOf(n);i.mount.mounts.splice(s,1)},lookup:function(e,t){return e.node_ops.lookup(e,t)},mknod:function(e,t,i){var n=FS.lookupPath(e,{parent:!0}).node,r=PATH.basename(e);if(!r||"."===r||".."===r)throw new FS.ErrnoError(ERRNO_CODES.EINVAL);var s=FS.mayCreate(n,r);if(s)throw new FS.ErrnoError(s);if(!n.node_ops.mknod)throw new FS.ErrnoError(ERRNO_CODES.EPERM);return n.node_ops.mknod(n,r,t,i)},create:function(e,t){return t=void 0!==t?t:438,t&=4095,t|=32768,FS.mknod(e,t,0)},mkdir:function(e,t){return t=void 0!==t?t:511,t&=1023,t|=16384,FS.mknod(e,t,0)},mkdev:function(e,t,i){return void 0===i&&(i=t,t=438),t|=8192,FS.mknod(e,t,i)},symlink:function(e,t){if(!PATH.resolve(e))throw new FS.ErrnoError(ERRNO_CODES.ENOENT);var i=FS.lookupPath(t,{parent:!0}).node;if(!i)throw new FS.ErrnoError(ERRNO_CODES.ENOENT);var n=PATH.basename(t),r=FS.mayCreate(i,n);if(r)throw new FS.ErrnoError(r);if(!i.node_ops.symlink)throw new FS.ErrnoError(ERRNO_CODES.EPERM);return i.node_ops.symlink(i,n,e)},rename:function(e,t){var i,n,r=PATH.dirname(e),s=PATH.dirname(t),a=PATH.basename(e),o=PATH.basename(t);try{i=FS.lookupPath(e,{parent:!0}).node,n=FS.lookupPath(t,{parent:!0}).node}catch(e){throw new FS.ErrnoError(ERRNO_CODES.EBUSY)}if(!i||!n)throw new FS.ErrnoError(ERRNO_CODES.ENOENT);if(i.mount!==n.mount)throw new FS.ErrnoError(ERRNO_CODES.EXDEV);var l,d=FS.lookupNode(i,a),c=PATH.relative(e,s);if("."!==c.charAt(0))throw new FS.ErrnoError(ERRNO_CODES.EINVAL);if("."!==(c=PATH.relative(t,r)).charAt(0))throw new FS.ErrnoError(ERRNO_CODES.ENOTEMPTY);try{l=FS.lookupNode(n,o)}catch(e){}if(d!==l){var h=FS.isDir(d.mode),u=FS.mayDelete(i,a,h);if(u)throw new FS.ErrnoError(u);if(u=l?FS.mayDelete(n,o,h):FS.mayCreate(n,o))throw new FS.ErrnoError(u);if(!i.node_ops.rename)throw new FS.ErrnoError(ERRNO_CODES.EPERM);if(FS.isMountpoint(d)||l&&FS.isMountpoint(l))throw new FS.ErrnoError(ERRNO_CODES.EBUSY);if(n!==i&&(u=FS.nodePermissions(i,"w")))throw new FS.ErrnoError(u);try{FS.trackingDelegate.willMovePath&&FS.trackingDelegate.willMovePath(e,t)}catch(i){console.log("FS.trackingDelegate['willMovePath']('"+e+"', '"+t+"') threw an exception: "+i.message)}FS.hashRemoveNode(d);try{i.node_ops.rename(d,n,o)}catch(e){throw e}finally{FS.hashAddNode(d)}try{FS.trackingDelegate.onMovePath&&FS.trackingDelegate.onMovePath(e,t)}catch(i){console.log("FS.trackingDelegate['onMovePath']('"+e+"', '"+t+"') threw an exception: "+i.message)}}},rmdir:function(e){var t=FS.lookupPath(e,{parent:!0}).node,i=PATH.basename(e),n=FS.lookupNode(t,i),r=FS.mayDelete(t,i,!0);if(r)throw new FS.ErrnoError(r);if(!t.node_ops.rmdir)throw new FS.ErrnoError(ERRNO_CODES.EPERM);if(FS.isMountpoint(n))throw new FS.ErrnoError(ERRNO_CODES.EBUSY);try{FS.trackingDelegate.willDeletePath&&FS.trackingDelegate.willDeletePath(e)}catch(t){console.log("FS.trackingDelegate['willDeletePath']('"+e+"') threw an exception: "+t.message)}t.node_ops.rmdir(t,i),FS.destroyNode(n);try{FS.trackingDelegate.onDeletePath&&FS.trackingDelegate.onDeletePath(e)}catch(t){console.log("FS.trackingDelegate['onDeletePath']('"+e+"') threw an exception: "+t.message)}},readdir:function(e){var t=FS.lookupPath(e,{follow:!0}).node;if(!t.node_ops.readdir)throw new FS.ErrnoError(ERRNO_CODES.ENOTDIR);return t.node_ops.readdir(t)},unlink:function(e){var t=FS.lookupPath(e,{parent:!0}).node,i=PATH.basename(e),n=FS.lookupNode(t,i),r=FS.mayDelete(t,i,!1);if(r)throw r===ERRNO_CODES.EISDIR&&(r=ERRNO_CODES.EPERM),new FS.ErrnoError(r);if(!t.node_ops.unlink)throw new FS.ErrnoError(ERRNO_CODES.EPERM);if(FS.isMountpoint(n))throw new FS.ErrnoError(ERRNO_CODES.EBUSY);try{FS.trackingDelegate.willDeletePath&&FS.trackingDelegate.willDeletePath(e)}catch(t){console.log("FS.trackingDelegate['willDeletePath']('"+e+"') threw an exception: "+t.message)}t.node_ops.unlink(t,i),FS.destroyNode(n);try{FS.trackingDelegate.onDeletePath&&FS.trackingDelegate.onDeletePath(e)}catch(t){console.log("FS.trackingDelegate['onDeletePath']('"+e+"') threw an exception: "+t.message)}},readlink:function(e){var t=FS.lookupPath(e).node;if(!t)throw new FS.ErrnoError(ERRNO_CODES.ENOENT);if(!t.node_ops.readlink)throw new FS.ErrnoError(ERRNO_CODES.EINVAL);return t.node_ops.readlink(t)},stat:function(e,t){var i=FS.lookupPath(e,{follow:!t}).node;if(!i)throw new FS.ErrnoError(ERRNO_CODES.ENOENT);if(!i.node_ops.getattr)throw new FS.ErrnoError(ERRNO_CODES.EPERM);return i.node_ops.getattr(i)},lstat:function(e){return FS.stat(e,!0)},chmod:function(e,t,i){var n;"string"==typeof e?n=FS.lookupPath(e,{follow:!i}).node:n=e;if(!n.node_ops.setattr)throw new FS.ErrnoError(ERRNO_CODES.EPERM);n.node_ops.setattr(n,{mode:4095&t|-4096&n.mode,timestamp:Date.now()})},lchmod:function(e,t){FS.chmod(e,t,!0)},fchmod:function(e,t){var i=FS.getStream(e);if(!i)throw new FS.ErrnoError(ERRNO_CODES.EBADF);FS.chmod(i.node,t)},chown:function(e,t,i,n){var r;"string"==typeof e?r=FS.lookupPath(e,{follow:!n}).node:r=e;if(!r.node_ops.setattr)throw new FS.ErrnoError(ERRNO_CODES.EPERM);r.node_ops.setattr(r,{timestamp:Date.now()})},lchown:function(e,t,i){FS.chown(e,t,i,!0)},fchown:function(e,t,i){var n=FS.getStream(e);if(!n)throw new FS.ErrnoError(ERRNO_CODES.EBADF);FS.chown(n.node,t,i)},truncate:function(e,t){if(t<0)throw new FS.ErrnoError(ERRNO_CODES.EINVAL);var i;"string"==typeof e?i=FS.lookupPath(e,{follow:!0}).node:i=e;if(!i.node_ops.setattr)throw new FS.ErrnoError(ERRNO_CODES.EPERM);if(FS.isDir(i.mode))throw new FS.ErrnoError(ERRNO_CODES.EISDIR);if(!FS.isFile(i.mode))throw new FS.ErrnoError(ERRNO_CODES.EINVAL);var n=FS.nodePermissions(i,"w");if(n)throw new FS.ErrnoError(n);i.node_ops.setattr(i,{size:t,timestamp:Date.now()})},ftruncate:function(e,t){var i=FS.getStream(e);if(!i)throw new FS.ErrnoError(ERRNO_CODES.EBADF);if(0==(2097155&i.flags))throw new FS.ErrnoError(ERRNO_CODES.EINVAL);FS.truncate(i.node,t)},utime:function(e,t,i){var n=FS.lookupPath(e,{follow:!0}).node;n.node_ops.setattr(n,{timestamp:Math.max(t,i)})},open:function(e,t,i,n,r){if(""===e)throw new FS.ErrnoError(ERRNO_CODES.ENOENT);var s;if(i=void 0===i?438:i,i=64&(t="string"==typeof t?FS.modeStringToFlags(t):t)?4095&i|32768:0,"object"==typeof e)s=e;else{e=PATH.normalize(e);try{s=FS.lookupPath(e,{follow:!(131072&t)}).node}catch(e){}}var a=!1;if(64&t)if(s){if(128&t)throw new FS.ErrnoError(ERRNO_CODES.EEXIST)}else s=FS.mknod(e,i,0),a=!0;if(!s)throw new FS.ErrnoError(ERRNO_CODES.ENOENT);if(FS.isChrdev(s.mode)&&(t&=-513),!a){var o=FS.mayOpen(s,t);if(o)throw new FS.ErrnoError(o)}512&t&&FS.truncate(s,0),t&=-641;var l=FS.createStream({node:s,path:FS.getPath(s),flags:t,seekable:!0,position:0,stream_ops:s.stream_ops,ungotten:[],error:!1},n,r);l.stream_ops.open&&l.stream_ops.open(l),!Module.logReadFiles||1&t||(FS.readFiles||(FS.readFiles={}),e in FS.readFiles||(FS.readFiles[e]=1,Module.printErr("read file: "+e)));try{if(FS.trackingDelegate.onOpenFile){var d=0;1!=(2097155&t)&&(d|=FS.tracking.openFlags.READ),0!=(2097155&t)&&(d|=FS.tracking.openFlags.WRITE),FS.trackingDelegate.onOpenFile(e,d)}}catch(t){console.log("FS.trackingDelegate['onOpenFile']('"+e+"', flags) threw an exception: "+t.message)}return l},close:function(e){try{e.stream_ops.close&&e.stream_ops.close(e)}catch(e){throw e}finally{FS.closeStream(e.fd)}},llseek:function(e,t,i){if(!e.seekable||!e.stream_ops.llseek)throw new FS.ErrnoError(ERRNO_CODES.ESPIPE);return e.position=e.stream_ops.llseek(e,t,i),e.ungotten=[],e.position},read:function(e,t,i,n,r){if(n<0||r<0)throw new FS.ErrnoError(ERRNO_CODES.EINVAL);if(1==(2097155&e.flags))throw new FS.ErrnoError(ERRNO_CODES.EBADF);if(FS.isDir(e.node.mode))throw new FS.ErrnoError(ERRNO_CODES.EISDIR);if(!e.stream_ops.read)throw new FS.ErrnoError(ERRNO_CODES.EINVAL);var s=!0;if(void 0===r)r=e.position,s=!1;else if(!e.seekable)throw new FS.ErrnoError(ERRNO_CODES.ESPIPE);var a=e.stream_ops.read(e,t,i,n,r);return s||(e.position+=a),a},write:function(e,t,i,n,r,s){if(n<0||r<0)throw new FS.ErrnoError(ERRNO_CODES.EINVAL);if(0==(2097155&e.flags))throw new FS.ErrnoError(ERRNO_CODES.EBADF);if(FS.isDir(e.node.mode))throw new FS.ErrnoError(ERRNO_CODES.EISDIR);if(!e.stream_ops.write)throw new FS.ErrnoError(ERRNO_CODES.EINVAL);1024&e.flags&&FS.llseek(e,0,2);var a=!0;if(void 0===r)r=e.position,a=!1;else if(!e.seekable)throw new FS.ErrnoError(ERRNO_CODES.ESPIPE);var o=e.stream_ops.write(e,t,i,n,r,s);a||(e.position+=o);try{e.path&&FS.trackingDelegate.onWriteToFile&&FS.trackingDelegate.onWriteToFile(e.path)}catch(e){console.log("FS.trackingDelegate['onWriteToFile']('"+path+"') threw an exception: "+e.message)}return o},allocate:function(e,t,i){if(t<0||i<=0)throw new FS.ErrnoError(ERRNO_CODES.EINVAL);if(0==(2097155&e.flags))throw new FS.ErrnoError(ERRNO_CODES.EBADF);if(!FS.isFile(e.node.mode)&&!FS.isDir(node.mode))throw new FS.ErrnoError(ERRNO_CODES.ENODEV);if(!e.stream_ops.allocate)throw new FS.ErrnoError(ERRNO_CODES.EOPNOTSUPP);e.stream_ops.allocate(e,t,i)},mmap:function(e,t,i,n,r,s,a){if(1==(2097155&e.flags))throw new FS.ErrnoError(ERRNO_CODES.EACCES);if(!e.stream_ops.mmap)throw new FS.ErrnoError(ERRNO_CODES.ENODEV);return e.stream_ops.mmap(e,t,i,n,r,s,a)},ioctl:function(e,t,i){if(!e.stream_ops.ioctl)throw new FS.ErrnoError(ERRNO_CODES.ENOTTY);return e.stream_ops.ioctl(e,t,i)},readFile:function(e,t){if((t=t||{}).flags=t.flags||"r",t.encoding=t.encoding||"binary","utf8"!==t.encoding&&"binary"!==t.encoding)throw new Error('Invalid encoding type "'+t.encoding+'"');var i,n=FS.open(e,t.flags),r=FS.stat(e).size,s=new Uint8Array(r);if(FS.read(n,s,0,r,0),"utf8"===t.encoding){i="";for(var a=new Runtime.UTF8Processor,o=0;o<r;o++)i+=a.processCChar(s[o])}else"binary"===t.encoding&&(i=s);return FS.close(n),i},writeFile:function(e,t,i){if((i=i||{}).flags=i.flags||"w",i.encoding=i.encoding||"utf8","utf8"!==i.encoding&&"binary"!==i.encoding)throw new Error('Invalid encoding type "'+i.encoding+'"');var n=FS.open(e,i.flags,i.mode);if("utf8"===i.encoding){var r=new Runtime.UTF8Processor,s=new Uint8Array(r.processJSString(t));FS.write(n,s,0,s.length,0,i.canOwn)}else"binary"===i.encoding&&FS.write(n,t,0,t.length,0,i.canOwn);FS.close(n)},cwd:function(){return FS.currentPath},chdir:function(e){var t=FS.lookupPath(e,{follow:!0});if(!FS.isDir(t.node.mode))throw new FS.ErrnoError(ERRNO_CODES.ENOTDIR);var i=FS.nodePermissions(t.node,"x");if(i)throw new FS.ErrnoError(i);FS.currentPath=t.path},createDefaultDirectories:function(){FS.mkdir("/tmp"),FS.mkdir("/home"),FS.mkdir("/home/web_user")},createDefaultDevices:function(){var e;if(FS.mkdir("/dev"),FS.registerDevice(FS.makedev(1,3),{read:function(){return 0},write:function(){return 0}}),FS.mkdev("/dev/null",FS.makedev(1,3)),TTY.register(FS.makedev(5,0),TTY.default_tty_ops),TTY.register(FS.makedev(6,0),TTY.default_tty1_ops),FS.mkdev("/dev/tty",FS.makedev(5,0)),FS.mkdev("/dev/tty1",FS.makedev(6,0)),void 0!==i){var t=new Uint8Array(1);e=function(){return i.getRandomValues(t),t[0]}}else if(ENVIRONMENT_IS_NODE){var i=__webpack_require__(775463);e=function(){return i.randomBytes(1)[0]}}else e=function(){return 256*Math.random()|0};FS.createDevice("/dev","random",e),FS.createDevice("/dev","urandom",e),FS.mkdir("/dev/shm"),FS.mkdir("/dev/shm/tmp")},createStandardStreams:function(){Module.stdin?FS.createDevice("/dev","stdin",Module.stdin):FS.symlink("/dev/tty","/dev/stdin"),Module.stdout?FS.createDevice("/dev","stdout",null,Module.stdout):FS.symlink("/dev/tty","/dev/stdout"),Module.stderr?FS.createDevice("/dev","stderr",null,Module.stderr):FS.symlink("/dev/tty1","/dev/stderr");var e=FS.open("/dev/stdin","r");HEAP32[_stdin>>2]=FS.getPtrForStream(e);var t=FS.open("/dev/stdout","w");HEAP32[_stdout>>2]=FS.getPtrForStream(t);var i=FS.open("/dev/stderr","w");HEAP32[_stderr>>2]=FS.getPtrForStream(i)},ensureErrnoError:function(){FS.ErrnoError||(FS.ErrnoError=function(e,t){this.node=t,this.setErrno=function(e){for(var t in this.errno=e,ERRNO_CODES)if(ERRNO_CODES[t]===e){this.code=t;break}},this.setErrno(e),this.message=ERRNO_MESSAGES[e]},FS.ErrnoError.prototype=new Error,FS.ErrnoError.prototype.constructor=FS.ErrnoError,[ERRNO_CODES.ENOENT].forEach((function(e){FS.genericErrors[e]=new FS.ErrnoError(e),FS.genericErrors[e].stack="<generic error, no stack>"})))},staticInit:function(){FS.ensureErrnoError(),FS.nameTable=new Array(4096),FS.mount(MEMFS,{},"/"),FS.createDefaultDirectories(),FS.createDefaultDevices()},init:function(e,t,i){FS.init.initialized=!0,FS.ensureErrnoError(),Module.stdin=e||Module.stdin,Module.stdout=t||Module.stdout,Module.stderr=i||Module.stderr,FS.createStandardStreams()},quit:function(){FS.init.initialized=!1;for(var e=0;e<FS.streams.length;e++){var t=FS.streams[e];t&&FS.close(t)}},getMode:function(e,t){var i=0;return e&&(i|=365),t&&(i|=146),i},joinPath:function(e,t){var i=PATH.join.apply(null,e);return t&&"/"==i[0]&&(i=i.substr(1)),i},absolutePath:function(e,t){return PATH.resolve(t,e)},standardizePath:function(e){return PATH.normalize(e)},findObject:function(e,t){var i=FS.analyzePath(e,t);return i.exists?i.object:(___setErrNo(i.error),null)},analyzePath:function(e,t){try{e=(n=FS.lookupPath(e,{follow:!t})).path}catch(e){}var i={isRoot:!1,exists:!1,error:0,name:null,path:null,object:null,parentExists:!1,parentPath:null,parentObject:null};try{var n=FS.lookupPath(e,{parent:!0});i.parentExists=!0,i.parentPath=n.path,i.parentObject=n.node,i.name=PATH.basename(e),n=FS.lookupPath(e,{follow:!t}),i.exists=!0,i.path=n.path,i.object=n.node,i.name=n.node.name,i.isRoot="/"===n.path}catch(e){i.error=e.errno}return i},createFolder:function(e,t,i,n){var r=PATH.join2("string"==typeof e?e:FS.getPath(e),t),s=FS.getMode(i,n);return FS.mkdir(r,s)},createPath:function(e,t,i,n){e="string"==typeof e?e:FS.getPath(e);for(var r=t.split("/").reverse();r.length;){var s=r.pop();if(s){var a=PATH.join2(e,s);try{FS.mkdir(a)}catch(e){}e=a}}return a},createFile:function(e,t,i,n,r){var s=PATH.join2("string"==typeof e?e:FS.getPath(e),t),a=FS.getMode(n,r);return FS.create(s,a)},createDataFile:function(e,t,i,n,r,s){var a=t?PATH.join2("string"==typeof e?e:FS.getPath(e),t):e,o=FS.getMode(n,r),l=FS.create(a,o);if(i){if("string"==typeof i){for(var d=new Array(i.length),c=0,h=i.length;c<h;++c)d[c]=i.charCodeAt(c);i=d}FS.chmod(l,146|o);var u=FS.open(l,"w");FS.write(u,i,0,i.length,0,s),FS.close(u),FS.chmod(l,o)}return l},createDevice:function(e,t,i,n){var r=PATH.join2("string"==typeof e?e:FS.getPath(e),t),s=FS.getMode(!!i,!!n);FS.createDevice.major||(FS.createDevice.major=64);var a=FS.makedev(FS.createDevice.major++,0);return FS.registerDevice(a,{open:function(e){e.seekable=!1},close:function(e){n&&n.buffer&&n.buffer.length&&n(10)},read:function(e,t,n,r,s){for(var a=0,o=0;o<r;o++){var l;try{l=i()}catch(e){throw new FS.ErrnoError(ERRNO_CODES.EIO)}if(void 0===l&&0===a)throw new FS.ErrnoError(ERRNO_CODES.EAGAIN);if(null==l)break;a++,t[n+o]=l}return a&&(e.node.timestamp=Date.now()),a},write:function(e,t,i,r,s){for(var a=0;a<r;a++)try{n(t[i+a])}catch(e){throw new FS.ErrnoError(ERRNO_CODES.EIO)}return r&&(e.node.timestamp=Date.now()),a}}),FS.mkdev(r,s,a)},createLink:function(e,t,i,n,r){var s=PATH.join2("string"==typeof e?e:FS.getPath(e),t);return FS.symlink(i,s)},forceLoadFile:function(e){if(e.isDevice||e.isFolder||e.link||e.contents)return!0;var t=!0;if("undefined"!=typeof XMLHttpRequest)throw new Error("Lazy loading should have been performed (contents set) in createLazyFile, but it was not. Lazy loading only works in web workers. Use --embed-file or --preload-file in emcc on the main thread.");if(!Module.read)throw new Error("Cannot load without read() or XMLHttpRequest.");try{e.contents=intArrayFromString(Module.read(e.url),!0),e.usedBytes=e.contents.length}catch(e){t=!1}return t||___setErrNo(ERRNO_CODES.EIO),t},createLazyFile:function(e,t,i,n,r){function s(){this.lengthKnown=!1,this.chunks=[]}if(s.prototype.get=function(e){if(!(e>this.length-1||e<0)){var t=e%this.chunkSize,i=e/this.chunkSize|0;return this.getter(i)[t]}},s.prototype.setDataGetter=function(e){this.getter=e},s.prototype.cacheLength=function(){var e=new XMLHttpRequest;if(e.open("HEAD",i,!1),e.send(null),!(e.status>=200&&e.status<300||304===e.status))throw new Error("Couldn't load "+i+". Status: "+e.status);var t,n=Number(e.getResponseHeader("Content-length")),r=(t=e.getResponseHeader("Accept-Ranges"))&&"bytes"===t,s=1048576;r||(s=n);var a=this;a.setDataGetter((function(e){var t=e*s,r=(e+1)*s-1;if(r=Math.min(r,n-1),void 0===a.chunks[e]&&(a.chunks[e]=function(e,t){if(e>t)throw new Error("invalid range ("+e+", "+t+") or no bytes requested!");if(t>n-1)throw new Error("only "+n+" bytes available! programmer error!");var r=new XMLHttpRequest;if(r.open("GET",i,!1),n!==s&&r.setRequestHeader("Range","bytes="+e+"-"+t),"undefined"!=typeof Uint8Array&&(r.responseType="arraybuffer"),r.overrideMimeType&&r.overrideMimeType("text/plain; charset=x-user-defined"),r.send(null),!(r.status>=200&&r.status<300||304===r.status))throw new Error("Couldn't load "+i+". Status: "+r.status);return void 0!==r.response?new Uint8Array(r.response||[]):intArrayFromString(r.responseText||"",!0)}(t,r)),void 0===a.chunks[e])throw new Error("doXHR failed!");return a.chunks[e]})),this._length=n,this._chunkSize=s,this.lengthKnown=!0},"undefined"!=typeof XMLHttpRequest){if(!ENVIRONMENT_IS_WORKER)throw"Cannot do synchronous binary XHRs outside webworkers in modern browsers. Use --embed-file or --preload-file in emcc";var a=new s;Object.defineProperty(a,"length",{get:function(){return this.lengthKnown||this.cacheLength(),this._length}}),Object.defineProperty(a,"chunkSize",{get:function(){return this.lengthKnown||this.cacheLength(),this._chunkSize}});var o={isDevice:!1,contents:a}}else o={isDevice:!1,url:i};var l=FS.createFile(e,t,o,n,r);o.contents?l.contents=o.contents:o.url&&(l.contents=null,l.url=o.url),Object.defineProperty(l,"usedBytes",{get:function(){return this.contents.length}});var d={};return Object.keys(l.stream_ops).forEach((function(e){var t=l.stream_ops[e];d[e]=function(){if(!FS.forceLoadFile(l))throw new FS.ErrnoError(ERRNO_CODES.EIO);return t.apply(null,arguments)}})),d.read=function(e,t,i,n,r){if(!FS.forceLoadFile(l))throw new FS.ErrnoError(ERRNO_CODES.EIO);var s=e.node.contents;if(r>=s.length)return 0;var a=Math.min(s.length-r,n);if(s.slice)for(var o=0;o<a;o++)t[i+o]=s[r+o];else for(o=0;o<a;o++)t[i+o]=s.get(r+o);return a},l.stream_ops=d,l},createPreloadedFile:function(e,t,i,n,r,s,a,o,l){Browser.init();var d=t?PATH.resolve(PATH.join2(e,t)):e;function c(i){function c(i){o||FS.createDataFile(e,t,i,n,r,l),s&&s(),removeRunDependency("cp "+d)}var h=!1;Module.preloadPlugins.forEach((function(e){h||e.canHandle(d)&&(e.handle(i,d,c,(function(){a&&a(),removeRunDependency("cp "+d)})),h=!0)})),h||c(i)}addRunDependency("cp "+d),"string"==typeof i?Browser.asyncLoad(i,(function(e){c(e)}),a):c(i)},indexedDB:function(){return window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB},DB_NAME:function(){return"EM_FS_"+window.location.pathname},DB_VERSION:20,DB_STORE_NAME:"FILE_DATA",saveFilesToDB:function(e,t,i){t=t||function(){},i=i||function(){};var n=FS.indexedDB();try{var r=n.open(FS.DB_NAME(),FS.DB_VERSION)}catch(e){return i(e)}r.onupgradeneeded=function(){console.log("creating db"),r.result.createObjectStore(FS.DB_STORE_NAME)},r.onsuccess=function(){var n=r.result.transaction([FS.DB_STORE_NAME],"readwrite"),s=n.objectStore(FS.DB_STORE_NAME),a=0,o=0,l=e.length;function d(){0==o?t():i()}e.forEach((function(e){var t=s.put(FS.analyzePath(e).object.contents,e);t.onsuccess=function(){++a+o==l&&d()},t.onerror=function(){o++,a+o==l&&d()}})),n.onerror=i},r.onerror=i},loadFilesFromDB:function(e,t,i){t=t||function(){},i=i||function(){};var n=FS.indexedDB();try{var r=n.open(FS.DB_NAME(),FS.DB_VERSION)}catch(e){return i(e)}r.onupgradeneeded=i,r.onsuccess=function(){var n=r.result;try{var s=n.transaction([FS.DB_STORE_NAME],"readonly")}catch(e){return void i(e)}var a=s.objectStore(FS.DB_STORE_NAME),o=0,l=0,d=e.length;function c(){0==l?t():i()}e.forEach((function(e){var t=a.get(e);t.onsuccess=function(){FS.analyzePath(e).exists&&FS.unlink(e),FS.createDataFile(PATH.dirname(e),PATH.basename(e),t.result,!0,!0,!0),++o+l==d&&c()},t.onerror=function(){l++,o+l==d&&c()}})),s.onerror=i},r.onerror=i}},PATH={splitPath:function(e){return/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/.exec(e).slice(1)},normalizeArray:function(e,t){for(var i=0,n=e.length-1;n>=0;n--){var r=e[n];"."===r?e.splice(n,1):".."===r?(e.splice(n,1),i++):i&&(e.splice(n,1),i--)}if(t)for(;i--;i)e.unshift("..");return e},normalize:function(e){var t="/"===e.charAt(0),i="/"===e.substr(-1);return(e=PATH.normalizeArray(e.split("/").filter((function(e){return!!e})),!t).join("/"))||t||(e="."),e&&i&&(e+="/"),(t?"/":"")+e},dirname:function(e){var t=PATH.splitPath(e),i=t[0],n=t[1];return i||n?(n&&(n=n.substr(0,n.length-1)),i+n):"."},basename:function(e){if("/"===e)return"/";var t=e.lastIndexOf("/");return-1===t?e:e.substr(t+1)},extname:function(e){return PATH.splitPath(e)[3]},join:function(){var e=Array.prototype.slice.call(arguments,0);return PATH.normalize(e.join("/"))},join2:function(e,t){return PATH.normalize(e+"/"+t)},resolve:function(){for(var e="",t=!1,i=arguments.length-1;i>=-1&&!t;i--){var n=i>=0?arguments[i]:FS.cwd();if("string"!=typeof n)throw new TypeError("Arguments to path.resolve must be strings");if(!n)return"";e=n+"/"+e,t="/"===n.charAt(0)}return(t?"/":"")+(e=PATH.normalizeArray(e.split("/").filter((function(e){return!!e})),!t).join("/"))||"."},relative:function(e,t){function i(e){for(var t=0;t<e.length&&""===e[t];t++);for(var i=e.length-1;i>=0&&""===e[i];i--);return t>i?[]:e.slice(t,i-t+1)}e=PATH.resolve(e).substr(1),t=PATH.resolve(t).substr(1);for(var n=i(e.split("/")),r=i(t.split("/")),s=Math.min(n.length,r.length),a=s,o=0;o<s;o++)if(n[o]!==r[o]){a=o;break}var l=[];for(o=a;o<n.length;o++)l.push("..");return(l=l.concat(r.slice(a))).join("/")}};function _emscripten_set_main_loop_timing(e,t){return Browser.mainLoop.timingMode=e,Browser.mainLoop.timingValue=t,Browser.mainLoop.func?(0==e?(Browser.mainLoop.scheduler=function(){setTimeout(Browser.mainLoop.runner,t)},Browser.mainLoop.method="timeout"):1==e&&(Browser.mainLoop.scheduler=function(){Browser.requestAnimationFrame(Browser.mainLoop.runner)},Browser.mainLoop.method="rAF"),0):1}function _emscripten_set_main_loop(e,t,i,n){Module.noExitRuntime=!0,Browser.mainLoop.func=e,Browser.mainLoop.arg=n;var r=Browser.mainLoop.currentlyRunningMainloop;if(Browser.mainLoop.runner=function(){if(!ABORT){if(Browser.mainLoop.queue.length>0){var t=Date.now(),i=Browser.mainLoop.queue.shift();if(i.func(i.arg),Browser.mainLoop.remainingBlockers){var s=Browser.mainLoop.remainingBlockers,a=s%1==0?s-1:Math.floor(s);i.counted?Browser.mainLoop.remainingBlockers=a:(a+=.5,Browser.mainLoop.remainingBlockers=(8*s+a)/9)}return console.log('main loop blocker "'+i.name+'" took '+(Date.now()-t)+" ms"),Browser.mainLoop.updateStatus(),void setTimeout(Browser.mainLoop.runner,0)}r<Browser.mainLoop.currentlyRunningMainloop||(Browser.mainLoop.currentFrameNumber=Browser.mainLoop.currentFrameNumber+1|0,1==Browser.mainLoop.timingMode&&Browser.mainLoop.timingValue>1&&Browser.mainLoop.currentFrameNumber%Browser.mainLoop.timingValue!=0?Browser.mainLoop.scheduler():("timeout"===Browser.mainLoop.method&&Module.ctx&&(Module.printErr("Looks like you are rendering without using requestAnimationFrame for the main loop. You should use 0 for the frame rate in emscripten_set_main_loop in order to use requestAnimationFrame, as that can greatly improve your frame rates!"),Browser.mainLoop.method=""),Browser.mainLoop.runIter((function(){void 0!==n?Runtime.dynCall("vi",e,[n]):Runtime.dynCall("v",e)})),r<Browser.mainLoop.currentlyRunningMainloop||("object"==typeof SDL&&SDL.audio&&SDL.audio.queueNewAudioData&&SDL.audio.queueNewAudioData(),Browser.mainLoop.scheduler())))}},t&&t>0?_emscripten_set_main_loop_timing(0,1e3/t):_emscripten_set_main_loop_timing(1,1),Browser.mainLoop.scheduler(),i)throw"SimulateInfiniteLoop"}var Browser={mainLoop:{scheduler:null,method:"",currentlyRunningMainloop:0,func:null,arg:0,timingMode:0,timingValue:0,currentFrameNumber:0,queue:[],pause:function(){Browser.mainLoop.scheduler=null,Browser.mainLoop.currentlyRunningMainloop++},resume:function(){Browser.mainLoop.currentlyRunningMainloop++;var e=Browser.mainLoop.timingMode,t=Browser.mainLoop.timingValue,i=Browser.mainLoop.func;Browser.mainLoop.func=null,_emscripten_set_main_loop(i,0,!1,Browser.mainLoop.arg),_emscripten_set_main_loop_timing(e,t)},updateStatus:function(){if(Module.setStatus){var e=Module.statusMessage||"Please wait...",t=Browser.mainLoop.remainingBlockers,i=Browser.mainLoop.expectedBlockers;t?t<i?Module.setStatus(e+" ("+(i-t)+"/"+i+")"):Module.setStatus(e):Module.setStatus("")}},runIter:function(e){if(!ABORT){if(Module.preMainLoop)if(!1===Module.preMainLoop())return;try{e()}catch(e){if(e instanceof ExitStatus)return;throw e&&"object"==typeof e&&e.stack&&Module.printErr("exception thrown: "+[e,e.stack]),e}Module.postMainLoop&&Module.postMainLoop()}}},isFullScreen:!1,pointerLock:!1,moduleContextCreatedCallbacks:[],workers:[],init:function(){if(Module.preloadPlugins||(Module.preloadPlugins=[]),!Browser.initted){Browser.initted=!0;try{new Blob,Browser.hasBlobConstructor=!0}catch(e){Browser.hasBlobConstructor=!1,console.log("warning: no blob constructor, cannot create blobs with mimetypes")}Browser.BlobBuilder="undefined"!=typeof MozBlobBuilder?MozBlobBuilder:"undefined"!=typeof WebKitBlobBuilder?WebKitBlobBuilder:Browser.hasBlobConstructor?null:console.log("warning: no BlobBuilder"),Browser.URLObject="undefined"!=typeof window?window.URL?window.URL:window.webkitURL:void 0,Module.noImageDecoding||void 0!==Browser.URLObject||(console.log("warning: Browser does not support creating object URLs. Built-in browser image decoding will not be available."),Module.noImageDecoding=!0);var e={canHandle:function(e){return!Module.noImageDecoding&&/\.(jpg|jpeg|png|bmp)$/i.test(e)},handle:function(e,t,i,n){var r=null;if(Browser.hasBlobConstructor)try{(r=new Blob([e],{type:Browser.getMimetype(t)})).size!==e.length&&(r=new Blob([new Uint8Array(e).buffer],{type:Browser.getMimetype(t)}))}catch(e){Runtime.warnOnce("Blob constructor present but fails: "+e+"; falling back to blob builder")}if(!r){var s=new Browser.BlobBuilder;s.append(new Uint8Array(e).buffer),r=s.getBlob()}var a=Browser.URLObject.createObjectURL(r),o=new Image;o.onload=function(){var n=document.createElement("canvas");n.width=o.width,n.height=o.height,n.getContext("2d").drawImage(o,0,0),Module.preloadedImages[t]=n,Browser.URLObject.revokeObjectURL(a),i&&i(e)},o.onerror=function(e){console.log("Image "+a+" could not be decoded"),n&&n()},o.src=a}};Module.preloadPlugins.push(e);var t={canHandle:function(e){return!Module.noAudioDecoding&&e.substr(-4)in{".ogg":1,".wav":1,".mp3":1}},handle:function(e,t,i,n){var r=!1;function s(n){r||(r=!0,Module.preloadedAudios[t]=n,i&&i(e))}function a(){r||(r=!0,Module.preloadedAudios[t]=new Audio,n&&n())}if(!Browser.hasBlobConstructor)return a();try{var o=new Blob([e],{type:Browser.getMimetype(t)})}catch(e){return a()}var l=Browser.URLObject.createObjectURL(o),d=new Audio;d.addEventListener("canplaythrough",(function(){s(d)}),!1),d.onerror=function(i){r||(console.log("warning: browser could not fully decode audio "+t+", trying slower base64 approach"),d.src="data:audio/x-"+t.substr(-3)+";base64,"+function(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i="",n=0,r=0,s=0;s<e.length;s++)for(n=n<<8|e[s],r+=8;r>=6;){var a=n>>r-6&63;r-=6,i+=t[a]}return 2==r?(i+=t[(3&n)<<4],i+="=="):4==r&&(i+=t[(15&n)<<2],i+="="),i}(e),s(d))},d.src=l,Browser.safeSetTimeout((function(){s(d)}),1e4)}};Module.preloadPlugins.push(t);var i=Module.canvas;i&&(i.requestPointerLock=i.requestPointerLock||i.mozRequestPointerLock||i.webkitRequestPointerLock||i.msRequestPointerLock||function(){},i.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock||document.msExitPointerLock||function(){},i.exitPointerLock=i.exitPointerLock.bind(document),document.addEventListener("pointerlockchange",n,!1),document.addEventListener("mozpointerlockchange",n,!1),document.addEventListener("webkitpointerlockchange",n,!1),document.addEventListener("mspointerlockchange",n,!1),Module.elementPointerLock&&i.addEventListener("click",(function(e){!Browser.pointerLock&&i.requestPointerLock&&(i.requestPointerLock(),e.preventDefault())}),!1))}function n(){Browser.pointerLock=document.pointerLockElement===i||document.mozPointerLockElement===i||document.webkitPointerLockElement===i||document.msPointerLockElement===i}},createContext:function(e,t,i,n){if(t&&Module.ctx&&e==Module.canvas)return Module.ctx;var r,s;if(t){var a={antialias:!1,alpha:!1};if(n)for(var o in n)a[o]=n[o];(s=GL.createContext(e,a))&&(r=GL.getContext(s).GLctx),e.style.backgroundColor="black"}else r=e.getContext("2d");return r?(i&&(Module.ctx=r,t&&GL.makeContextCurrent(s),Module.useWebGL=t,Browser.moduleContextCreatedCallbacks.forEach((function(e){e()})),Browser.init()),r):null},destroyContext:function(e,t,i){},fullScreenHandlersInstalled:!1,lockPointer:void 0,resizeCanvas:void 0,requestFullScreen:function(e,t){Browser.lockPointer=e,Browser.resizeCanvas=t,void 0===Browser.lockPointer&&(Browser.lockPointer=!0),void 0===Browser.resizeCanvas&&(Browser.resizeCanvas=!1);var i=Module.canvas;function n(){Browser.isFullScreen=!1;var e=i.parentNode;(document.webkitFullScreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.mozFullscreenElement||document.fullScreenElement||document.fullscreenElement||document.msFullScreenElement||document.msFullscreenElement||document.webkitCurrentFullScreenElement)===e?(i.cancelFullScreen=document.cancelFullScreen||document.mozCancelFullScreen||document.webkitCancelFullScreen||document.msExitFullscreen||document.exitFullscreen||function(){},i.cancelFullScreen=i.cancelFullScreen.bind(document),Browser.lockPointer&&i.requestPointerLock(),Browser.isFullScreen=!0,Browser.resizeCanvas&&Browser.setFullScreenCanvasSize()):(e.parentNode.insertBefore(i,e),e.parentNode.removeChild(e),Browser.resizeCanvas&&Browser.setWindowedCanvasSize()),Module.onFullScreen&&Module.onFullScreen(Browser.isFullScreen),Browser.updateCanvasDimensions(i)}Browser.fullScreenHandlersInstalled||(Browser.fullScreenHandlersInstalled=!0,document.addEventListener("fullscreenchange",n,!1),document.addEventListener("mozfullscreenchange",n,!1),document.addEventListener("webkitfullscreenchange",n,!1),document.addEventListener("MSFullscreenChange",n,!1));var r=document.createElement("div");i.parentNode.insertBefore(r,i),r.appendChild(i),r.requestFullScreen=r.requestFullScreen||r.mozRequestFullScreen||r.msRequestFullscreen||(r.webkitRequestFullScreen?function(){r.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT)}:null),r.requestFullScreen()},nextRAF:0,fakeRequestAnimationFrame:function(e){var t=Date.now();if(0===Browser.nextRAF)Browser.nextRAF=t+1e3/60;else for(;t+2>=Browser.nextRAF;)Browser.nextRAF+=1e3/60;var i=Math.max(Browser.nextRAF-t,0);setTimeout(e,i)},requestAnimationFrame:function(e){"undefined"==typeof window?Browser.fakeRequestAnimationFrame(e):(window.requestAnimationFrame||(window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame||Browser.fakeRequestAnimationFrame),window.requestAnimationFrame(e))},safeCallback:function(e){return function(){if(!ABORT)return e.apply(null,arguments)}},safeRequestAnimationFrame:function(e){return Browser.requestAnimationFrame((function(){ABORT||e()}))},safeSetTimeout:function(e,t){return Module.noExitRuntime=!0,setTimeout((function(){ABORT||e()}),t)},safeSetInterval:function(e,t){return Module.noExitRuntime=!0,setInterval((function(){ABORT||e()}),t)},getMimetype:function(e){return{jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",bmp:"image/bmp",ogg:"audio/ogg",wav:"audio/wav",mp3:"audio/mpeg"}[e.substr(e.lastIndexOf(".")+1)]},getUserMedia:function(e){window.getUserMedia||(window.getUserMedia=navigator.getUserMedia||navigator.mozGetUserMedia),window.getUserMedia(e)},getMovementX:function(e){return e.movementX||e.mozMovementX||e.webkitMovementX||0},getMovementY:function(e){return e.movementY||e.mozMovementY||e.webkitMovementY||0},getMouseWheelDelta:function(e){var t=0;switch(e.type){case"DOMMouseScroll":t=e.detail;break;case"mousewheel":t=e.wheelDelta;break;case"wheel":t=e.deltaY;break;default:throw"unrecognized mouse wheel event: "+e.type}return t},mouseX:0,mouseY:0,mouseMovementX:0,mouseMovementY:0,touches:{},lastTouches:{},calculateMouseEvent:function(e){if(Browser.pointerLock)"mousemove"!=e.type&&"mozMovementX"in e?Browser.mouseMovementX=Browser.mouseMovementY=0:(Browser.mouseMovementX=Browser.getMovementX(e),Browser.mouseMovementY=Browser.getMovementY(e)),"undefined"!=typeof SDL?(Browser.mouseX=SDL.mouseX+Browser.mouseMovementX,Browser.mouseY=SDL.mouseY+Browser.mouseMovementY):(Browser.mouseX+=Browser.mouseMovementX,Browser.mouseY+=Browser.mouseMovementY);else{var t=Module.canvas.getBoundingClientRect(),i=Module.canvas.width,n=Module.canvas.height,r=void 0!==window.scrollX?window.scrollX:window.pageXOffset,s=void 0!==window.scrollY?window.scrollY:window.pageYOffset;if("touchstart"===e.type||"touchend"===e.type||"touchmove"===e.type){var a=e.touch;if(void 0===a)return;var o=a.pageX-(r+t.left),l=a.pageY-(s+t.top),d={x:o*=i/t.width,y:l*=n/t.height};return void("touchstart"===e.type?(Browser.lastTouches[a.identifier]=d,Browser.touches[a.identifier]=d):"touchend"!==e.type&&"touchmove"!==e.type||(Browser.lastTouches[a.identifier]=Browser.touches[a.identifier],Browser.touches[a.identifier]={x:o,y:l}))}var c=e.pageX-(r+t.left),h=e.pageY-(s+t.top);c*=i/t.width,h*=n/t.height,Browser.mouseMovementX=c-Browser.mouseX,Browser.mouseMovementY=h-Browser.mouseY,Browser.mouseX=c,Browser.mouseY=h}},xhrLoad:function(e,t,i){var n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="arraybuffer",n.onload=function(){200==n.status||0==n.status&&n.response?t(n.response):i()},n.onerror=i,n.send(null)},asyncLoad:function(e,t,i,n){Browser.xhrLoad(e,(function(i){t(new Uint8Array(i)),n||removeRunDependency("al "+e)}),(function(t){if(!i)throw'Loading data file "'+e+'" failed.';i()})),n||addRunDependency("al "+e)},resizeListeners:[],updateResizeListeners:function(){var e=Module.canvas;Browser.resizeListeners.forEach((function(t){t(e.width,e.height)}))},setCanvasSize:function(e,t,i){var n=Module.canvas;Browser.updateCanvasDimensions(n,e,t),i||Browser.updateResizeListeners()},windowedWidth:0,windowedHeight:0,setFullScreenCanvasSize:function(){if("undefined"!=typeof SDL){var e=HEAPU32[SDL.screen+0*Runtime.QUANTUM_SIZE>>2];e|=8388608,HEAP32[SDL.screen+0*Runtime.QUANTUM_SIZE>>2]=e}Browser.updateResizeListeners()},setWindowedCanvasSize:function(){if("undefined"!=typeof SDL){var e=HEAPU32[SDL.screen+0*Runtime.QUANTUM_SIZE>>2];e&=-8388609,HEAP32[SDL.screen+0*Runtime.QUANTUM_SIZE>>2]=e}Browser.updateResizeListeners()},updateCanvasDimensions:function(e,t,i){t&&i?(e.widthNative=t,e.heightNative=i):(t=e.widthNative,i=e.heightNative);var n=t,r=i;if(Module.forcedAspectRatio&&Module.forcedAspectRatio>0&&(n/r<Module.forcedAspectRatio?n=Math.round(r*Module.forcedAspectRatio):r=Math.round(n/Module.forcedAspectRatio)),(document.webkitFullScreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.mozFullscreenElement||document.fullScreenElement||document.fullscreenElement||document.msFullScreenElement||document.msFullscreenElement||document.webkitCurrentFullScreenElement)===e.parentNode&&"undefined"!=typeof screen){var s=Math.min(screen.width/n,screen.height/r);n=Math.round(n*s),r=Math.round(r*s)}Browser.resizeCanvas?(e.width!=n&&(e.width=n),e.height!=r&&(e.height=r),void 0!==e.style&&(e.style.removeProperty("width"),e.style.removeProperty("height"))):(e.width!=t&&(e.width=t),e.height!=i&&(e.height=i),void 0!==e.style&&(n!=t||r!=i?(e.style.setProperty("width",n+"px","important"),e.style.setProperty("height",r+"px","important")):(e.style.removeProperty("width"),e.style.removeProperty("height"))))},wgetRequests:{},nextWgetRequestHandle:0,getNextWgetRequestHandle:function(){var e=Browser.nextWgetRequestHandle;return Browser.nextWgetRequestHandle++,e}};function _time(e){var t=Date.now()/1e3|0;return e&&(HEAP32[e>>2]=t),t}___errno_state=Runtime.staticAlloc(4),HEAP32[___errno_state>>2]=0,Module.requestFullScreen=function(e,t){Browser.requestFullScreen(e,t)},Module.requestAnimationFrame=function(e){Browser.requestAnimationFrame(e)},Module.setCanvasSize=function(e,t,i){Browser.setCanvasSize(e,t,i)},Module.pauseMainLoop=function(){Browser.mainLoop.pause()},Module.resumeMainLoop=function(){Browser.mainLoop.resume()},Module.getUserMedia=function(){Browser.getUserMedia()},FS.staticInit(),__ATINIT__.unshift({func:function(){Module.noFSInit||FS.init.initialized||FS.init()}}),__ATMAIN__.push({func:function(){FS.ignorePermissions=!1}}),__ATEXIT__.push({func:function(){FS.quit()}}),Module.FS_createFolder=FS.createFolder,Module.FS_createPath=FS.createPath,Module.FS_createDataFile=FS.createDataFile,Module.FS_createPreloadedFile=FS.createPreloadedFile,Module.FS_createLazyFile=FS.createLazyFile,Module.FS_createLink=FS.createLink,Module.FS_createDevice=FS.createDevice,__ATINIT__.unshift({func:function(){TTY.init()}}),__ATEXIT__.push({func:function(){TTY.shutdown()}}),TTY.utf8=new Runtime.UTF8Processor,STACK_BASE=STACKTOP=Runtime.alignMemory(STATICTOP),staticSealed=!0,STACK_MAX=STACK_BASE+TOTAL_STACK,DYNAMIC_BASE=DYNAMICTOP=Runtime.alignMemory(STACK_MAX);var ctlz_i8=allocate([8,7,6,6,5,5,5,5,4,4,4,4,4,4,4,4,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"i8",ALLOC_DYNAMIC),cttz_i8=allocate([8,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,4,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,5,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,4,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,6,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,4,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,5,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,4,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,7,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,4,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,5,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,4,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,6,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,4,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,5,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,4,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0],"i8",ALLOC_DYNAMIC);Module.asmGlobalArg={Math,Int8Array,Int16Array,Int32Array,Uint8Array,Uint16Array,Uint32Array,Float32Array,Float64Array},Module.asmLibraryArg={abort,assert,min:Math_min,_fflush,_sysconf,_abort,___setErrNo,_sbrk,_time,_emscripten_set_main_loop_timing,_emscripten_memcpy_big,_emscripten_set_main_loop,___errno_location,STACKTOP,STACK_MAX,tempDoublePtr,ABORT,cttz_i8,ctlz_i8,NaN:NaN,Infinity:1/0};var asm=function(e,t,i){"use asm";var n=new e.Int8Array(i);var r=new e.Int16Array(i);var s=new e.Int32Array(i);var a=new e.Uint8Array(i);var o=new e.Uint16Array(i);var l=new e.Uint32Array(i);var d=new e.Float32Array(i);var c=new e.Float64Array(i);var h=t.STACKTOP|0;var u=t.STACK_MAX|0;var p=t.tempDoublePtr|0;var g=t.ABORT|0;var m=t.cttz_i8|0;var f=t.ctlz_i8|0;var S=0;var v=0;var y=0;var C=0;var T=+t.NaN,E=+t.Infinity;var _=0,b=0,P=0,I=0,A=0,R=0,w=0,M=0,O=0;var D=0;var k=0;var N=0;var L=0;var x=0;var F=0;var U=0;var V=0;var H=0;var B=0;var $=e.Math.floor;var j=e.Math.abs;var G=e.Math.sqrt;var W=e.Math.pow;var q=e.Math.cos;var z=e.Math.sin;var K=e.Math.tan;var J=e.Math.acos;var Y=e.Math.asin;var Q=e.Math.atan;var X=e.Math.atan2;var Z=e.Math.exp;var ee=e.Math.log;var te=e.Math.ceil;var ie=e.Math.imul;var ne=t.abort;var re=t.assert;var se=t.min;var ae=t._fflush;var oe=t._sysconf;var le=t._abort;var de=t.___setErrNo;var ce=t._sbrk;var he=t._time;var ue=t._emscripten_set_main_loop_timing;var pe=t._emscripten_memcpy_big;var ge=t._emscripten_set_main_loop;var me=t.___errno_location;var fe=0;function Se(e){e=e|0;var t=0;t=h;h=h+e|0;h=h+15&-16;return t|0}function ve(){return h|0}function ye(e){e=e|0;h=e}function Ce(e,t){e=e|0;t=t|0;if((S|0)==0){S=e;v=t}}function Te(e){e=e|0;n[p>>0]=n[e>>0];n[p+1>>0]=n[e+1>>0];n[p+2>>0]=n[e+2>>0];n[p+3>>0]=n[e+3>>0]}function Ee(e){e=e|0;n[p>>0]=n[e>>0];n[p+1>>0]=n[e+1>>0];n[p+2>>0]=n[e+2>>0];n[p+3>>0]=n[e+3>>0];n[p+4>>0]=n[e+4>>0];n[p+5>>0]=n[e+5>>0];n[p+6>>0]=n[e+6>>0];n[p+7>>0]=n[e+7>>0]}function _e(e){e=e|0;D=e}function be(){return D|0}function Pe(e,t){e=e|0;t=t|0;var i=0,r=0,s=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0;var b=0,P=0,I=0,A=0,R=0,w=0,M=0,O=0,D=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0,j=0;var G=0,W=0,q=0,z=0,K=0,J=0,Y=0,Q=0,X=0,Z=0,ee=0,te=0,ie=0,ne=0,re=0,se=0,ae=0,oe=0,le=0,de=0;var ce=0,he=0,ue=0,pe=0,ge=0,me=0,fe=0,Se=0,ve=0,ye=0,Ce=0,Te=0,Ee=0,_e=0,be=0,Pe=0,Ie=0,Ae=0,Re=0,we=0;var Me=0,Oe=0,De=0,ke=0,Ne=0,Le=0,xe=0,Fe=0,Ue=0,Ve=0,He=0,Be=0,$e=0,je=0,Ge=0,We=0,qe=0,ze=0,Ke=0,Je=0;var Ye=0,Qe=0,Xe=0,Ze=0,et=0,tt=0,it=0,nt=0,rt=0,st=0,at=0,ot=0,lt=0,dt=0,ct=0,ht=0,ut=0,pt=0,gt=0,mt=0;var ft=0,St=0,vt=0,yt=0,Ct=0,Tt=0,Et=0,_t=0,bt=0,Pt=0,It=0,At=0,Rt=0,wt=0,Mt=0,Ot=0,Dt=0,kt=0,Nt=0,Lt=0;var xt=0,Ft=0,Ut=0,Vt=0,Ht=0,Bt=0,$t=0,jt=0,Gt=0,Wt=0,qt=0,zt=0,Kt=0,Jt=0,Yt=0,Qt=0,Xt=0,Zt=0,ei=0,ti=0;var ii=0,ni=0,ri=0,si=0,ai=0,oi=0,li=0,di=0,ci=0,hi=0,ui=0,pi=0,gi=0,mi=0,fi=0,Si=0,vi=0,yi=0,Ci=0,Ti=0;var Ei=0,_i=0,bi=0,Pi=0,Ii=0,Ai=0,Ri=0,wi=0,Mi=0,Oi=0,Di=0,ki=0,Ni=0,Li=0,xi=0,Fi=0;Fi=h;i=n[e>>0]|0;r=n[t>>0]|0;it=r^i;pt=e+1|0;bt=n[pt>>0]|0;Lt=t+1|0;qt=n[Lt>>0]|0;ni=qt^bt;gi=ni|it;Pi=e+2|0;s=n[Pi>>0]|0;S=t+2|0;R=n[S>>0]|0;V=R^s;Y=gi|V;oe=e+3|0;ve=n[oe>>0]|0;we=t+3|0;He=n[we>>0]|0;Qe=He^ve;nt=Y|Qe;rt=e+4|0;st=n[rt>>0]|0;at=t+4|0;ot=n[at>>0]|0;lt=ot^st;dt=nt|lt;ct=e+5|0;ht=n[ct>>0]|0;ut=t+5|0;gt=n[ut>>0]|0;mt=gt^ht;ft=dt|mt;St=e+6|0;vt=n[St>>0]|0;yt=t+6|0;Ct=n[yt>>0]|0;Tt=Ct^vt;Et=ft|Tt;_t=e+7|0;Pt=n[_t>>0]|0;It=t+7|0;At=n[It>>0]|0;Rt=At^Pt;wt=Et|Rt;Mt=e+8|0;Ot=n[Mt>>0]|0;Dt=t+8|0;kt=n[Dt>>0]|0;Nt=kt^Ot;xt=wt|Nt;Ft=e+9|0;Ut=n[Ft>>0]|0;Vt=t+9|0;Ht=n[Vt>>0]|0;Bt=Ht^Ut;$t=xt|Bt;jt=e+10|0;Gt=n[jt>>0]|0;Wt=t+10|0;zt=n[Wt>>0]|0;Kt=zt^Gt;Jt=$t|Kt;Yt=e+11|0;Qt=n[Yt>>0]|0;Xt=t+11|0;Zt=n[Xt>>0]|0;ei=Zt^Qt;ti=Jt|ei;ii=e+12|0;ri=n[ii>>0]|0;si=t+12|0;ai=n[si>>0]|0;oi=ai^ri;li=ti|oi;di=e+13|0;ci=n[di>>0]|0;hi=t+13|0;ui=n[hi>>0]|0;pi=ui^ci;mi=li|pi;fi=e+14|0;Si=n[fi>>0]|0;vi=t+14|0;yi=n[vi>>0]|0;Ci=yi^Si;Ti=mi|Ci;Ei=e+15|0;_i=n[Ei>>0]|0;bi=t+15|0;Ii=n[bi>>0]|0;Ai=Ii^_i;Ri=Ti|Ai;wi=e+16|0;Mi=n[wi>>0]|0;Oi=t+16|0;Di=n[Oi>>0]|0;ki=Di^Mi;Ni=Ri|ki;Li=e+17|0;a=n[Li>>0]|0;o=t+17|0;l=n[o>>0]|0;d=l^a;c=Ni|d;u=e+18|0;p=n[u>>0]|0;g=t+18|0;m=n[g>>0]|0;f=m^p;v=c|f;y=e+19|0;C=n[y>>0]|0;T=t+19|0;E=n[T>>0]|0;_=E^C;b=v|_;P=e+20|0;I=n[P>>0]|0;A=t+20|0;w=n[A>>0]|0;M=w^I;O=b|M;D=e+21|0;k=n[D>>0]|0;N=t+21|0;L=n[N>>0]|0;x=L^k;F=O|x;U=e+22|0;H=n[U>>0]|0;B=t+22|0;$=n[B>>0]|0;j=$^H;G=F|j;W=e+23|0;q=n[W>>0]|0;z=t+23|0;K=n[z>>0]|0;J=K^q;Q=G|J;X=e+24|0;Z=n[X>>0]|0;ee=t+24|0;te=n[ee>>0]|0;ie=te^Z;ne=Q|ie;re=e+25|0;se=n[re>>0]|0;ae=t+25|0;le=n[ae>>0]|0;de=le^se;ce=ne|de;he=e+26|0;ue=n[he>>0]|0;pe=t+26|0;ge=n[pe>>0]|0;me=ge^ue;fe=ce|me;Se=e+27|0;ye=n[Se>>0]|0;Ce=t+27|0;Te=n[Ce>>0]|0;Ee=Te^ye;_e=fe|Ee;be=e+28|0;Pe=n[be>>0]|0;Ie=t+28|0;Ae=n[Ie>>0]|0;Re=Ae^Pe;Me=_e|Re;Oe=e+29|0;De=n[Oe>>0]|0;ke=t+29|0;Ne=n[ke>>0]|0;Le=Ne^De;xe=Me|Le;Fe=e+30|0;Ue=n[Fe>>0]|0;Ve=t+30|0;Be=n[Ve>>0]|0;$e=Be^Ue;je=xe|$e;Ge=e+31|0;We=n[Ge>>0]|0;qe=t+31|0;ze=n[qe>>0]|0;Ke=ze^We;Je=je|Ke;Ye=Je&255;Xe=Ye+511|0;Ze=Xe>>>8;et=Ze&1;tt=et+-1|0;h=Fi;return tt|0}function Ie(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;var a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0,b=0,P=0,I=0;var A=0,R=0,w=0,M=0;R=h;h=h+240|0;b=R+8|0;_=R+168|0;P=R;a=r+64|0;o=h;h=h+((1*a|0)+15&-16)|0;m=P;f=m;s[f>>2]=0;S=m+4|0;v=S;s[v>>2]=0;I=_+0|0;w=t+0|0;M=I+32|0;do{n[I>>0]=n[w>>0]|0;I=I+1|0;w=w+1|0}while((I|0)<(M|0));Mt(b,t);y=_+32|0;Rt(y,b);C=_+63|0;T=n[C>>0]|0;E=T&255;l=E&128;we(o,P,i,r,0,_)|0;I=e+0|0;w=o+0|0;M=I+64|0;do{n[I>>0]=n[w>>0]|0;I=I+1|0;w=w+1|0}while((I|0)<(M|0));d=e+63|0;c=n[d>>0]|0;u=c&255;p=u|l;g=p&255;n[d>>0]=g;h=R;return}function Ae(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;var s=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0,b=0,P=0;var I=0,A=0,R=0,w=0,M=0,O=0,D=0,k=0,N=0,L=0,x=0;N=h;h=h+288|0;A=N+208|0;R=N+168|0;w=N+128|0;I=N+88|0;M=N+48|0;P=N+8|0;b=N+248|0;O=N;s=r+64|0;a=h;h=h+((1*s|0)+15&-16)|0;f=h;h=h+((1*s|0)+15&-16)|0;tt(A,t);Qe(M);ut(R,A,M);Xe(w,A,M);rt(I,w);ot(P,R,I);pt(b,P);S=e+63|0;v=n[S>>0]|0;y=v&255;C=y&128;T=b+31|0;E=n[T>>0]|0;_=E&255;o=_|C;l=o&255;n[T>>0]=l;d=n[S>>0]|0;c=d&255;u=c&127;p=u&255;n[S>>0]=p;D=a+0|0;L=e+0|0;x=D+64|0;do{n[D>>0]=n[L>>0]|0;D=D+1|0;L=L+1|0}while((D|0)<(x|0));g=a+64|0;di(g|0,i|0,r|0)|0;m=Ft(f,O,a,s,0,b)|0;h=N;return m|0}function Re(e,t,i,n){e=e|0;t=t|0;i=i|0;n=n|0;var r=0,s=0,a=0;a=h;h=h+208|0;r=a;Gt(r);Wt(r,t,i);qt(r,e);h=a;return 0}function we(e,t,i,r,a,o){e=e|0;t=t|0;i=i|0;r=r|0;a=a|0;o=o|0;var l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0,b=0,P=0,I=0,A=0,R=0;I=h;h=h+320|0;_=I+288|0;E=I+224|0;T=I+160|0;C=I;u=o+32|0;b=_+0|0;A=u+0|0;R=b+32|0;do{n[b>>0]=n[A>>0]|0;b=b+1|0;A=A+1|0}while((b|0)<(R|0));p=ri(r|0,a|0,64,0)|0;g=D;m=t;f=m;s[f>>2]=p;S=m+4|0;v=S;s[v>>2]=g;y=e+64|0;ci(y|0,i|0,r|0)|0;l=e+32|0;ci(l|0,o|0,32)|0;d=ri(r|0,a|0,32,0)|0;c=D;Re(E,l,d,c)|0;b=l+0|0;A=_+0|0;R=b+32|0;do{n[b>>0]=n[A>>0]|0;b=b+1|0;A=A+1|0}while((b|0)<(R|0));Bt(E);Mt(C,E);Rt(e,C);Re(T,e,p,g)|0;Bt(T);Ut(l,T,o,E);h=I;return 0}function Me(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,s=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0;u=h;h=h+368|0;r=u+248|0;a=u+168|0;o=u+80|0;l=u;s=u+328|0;d=s+0|0;p=t+0|0;g=d+32|0;do{n[d>>0]=n[p>>0]|0;d=d+1|0;p=p+1|0}while((d|0)<(g|0));Oe(r,i);De(a,o,s,r);ke(l,o);Ne(o,a,l);Le(e,o);h=u;return 0}function Oe(e,t){e=e|0;t=t|0;var i=0,r=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0,b=0;var P=0,I=0,A=0,R=0,w=0,M=0,O=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0,j=0,G=0,W=0;var q=0,z=0,K=0,J=0,Y=0,Q=0,X=0,Z=0,ee=0,te=0,ie=0,ne=0,re=0,se=0,ae=0,oe=0,le=0,de=0,ce=0,he=0;var ue=0,pe=0,ge=0,me=0,fe=0,Se=0,ve=0,ye=0,Ce=0,Te=0,Ee=0,_e=0,be=0,Pe=0,Ie=0,Ae=0,Re=0,we=0,Me=0,Oe=0;var De=0,ke=0,Ne=0,Le=0,xe=0,Fe=0,Ue=0,Ve=0,He=0,Be=0,$e=0,je=0,Ge=0,We=0,qe=0,ze=0,Ke=0,Je=0,Ye=0,Qe=0;var Xe=0,Ze=0,et=0,tt=0,it=0,nt=0,rt=0,st=0,at=0,ot=0,lt=0,dt=0,ct=0,ht=0,ut=0,pt=0,gt=0,mt=0,ft=0,St=0;var vt=0,yt=0,Ct=0,Tt=0,Et=0,_t=0,bt=0,Pt=0,It=0,At=0,Rt=0,wt=0,Mt=0,Ot=0,Dt=0,kt=0,Nt=0,Lt=0,xt=0,Ft=0;var Ut=0,Vt=0,Ht=0,Bt=0,$t=0,jt=0,Gt=0,Wt=0,qt=0,zt=0,Kt=0,Jt=0,Yt=0,Qt=0,Xt=0,Zt=0,ei=0,ti=0,ii=0,ni=0;var ri=0,si=0,li=0,di=0,ci=0,hi=0,ui=0,pi=0,gi=0,mi=0,fi=0,Si=0,vi=0,yi=0,Ci=0,Ti=0,Ei=0,_i=0,bi=0,Pi=0;var Ii=0,Ai=0,Ri=0,wi=0,Mi=0,Oi=0,Di=0,ki=0,Ni=0,Li=0,xi=0,Fi=0,Ui=0,Vi=0,Hi=0,Bi=0,$i=0,ji=0,Gi=0,Wi=0;var qi=0,zi=0,Ki=0,Ji=0,Yi=0,Qi=0,Xi=0,Zi=0,en=0,tn=0,nn=0,rn=0,sn=0,an=0,on=0,ln=0,dn=0,cn=0,hn=0,un=0;var pn=0,gn=0,mn=0,fn=0,Sn=0,vn=0,yn=0,Cn=0,Tn=0,En=0,_n=0,bn=0,Pn=0,In=0,An=0,Rn=0,wn=0,Mn=0,On=0,Dn=0;var kn=0,Nn=0,Ln=0,xn=0,Fn=0,Un=0,Vn=0,Hn=0,Bn=0,$n=0,jn=0,Gn=0,Wn=0,qn=0,zn=0,Kn=0,Jn=0,Yn=0,Qn=0,Xn=0;var Zn=0,er=0,tr=0,ir=0,nr=0,rr=0,sr=0,ar=0,or=0,lr=0,dr=0,cr=0,hr=0,ur=0,pr=0,gr=0,mr=0,fr=0,Sr=0,vr=0;var yr=0,Cr=0,Tr=0,Er=0,_r=0,br=0,Pr=0,Ir=0,Ar=0,Rr=0,wr=0,Mr=0,Or=0,Dr=0,kr=0,Nr=0;Nr=h;i=n[t>>0]|0;r=i&255;ct=t+1|0;cn=n[ct>>0]|0;Tn=cn&255;Dn=oi(Tn|0,0,8)|0;jn=D;er=Dn|r;hr=t+2|0;Er=n[hr>>0]|0;a=Er&255;v=oi(a|0,0,16)|0;w=D;B=er|v;X=jn|w;de=t+3|0;Ce=n[de>>0]|0;Oe=Ce&255;$e=oi(Oe|0,0,24)|0;Ze=D;ht=$e&50331648;Et=B|ht;kt=e;Gt=kt;s[Gt>>2]=Et;ti=kt+4|0;gi=ti;s[gi>>2]=X;Pi=n[de>>0]|0;xi=Pi&255;zi=t+4|0;sn=n[zi>>0]|0;hn=sn&255;un=oi(hn|0,0,8)|0;pn=D;gn=un|xi;mn=t+5|0;fn=n[mn>>0]|0;Sn=fn&255;vn=oi(Sn|0,0,16)|0;yn=D;Cn=gn|vn;En=pn|yn;_n=t+6|0;bn=n[_n>>0]|0;Pn=bn&255;In=oi(Pn|0,0,24)|0;An=D;Rn=Cn|In;wn=En|An;Mn=ai(Rn|0,wn|0,2)|0;On=D;kn=Mn&33554431;Nn=e+8|0;Ln=Nn;xn=Ln;s[xn>>2]=kn;Fn=Ln+4|0;Un=Fn;s[Un>>2]=0;Vn=n[_n>>0]|0;Hn=Vn&255;Bn=t+7|0;$n=n[Bn>>0]|0;Gn=$n&255;Wn=oi(Gn|0,0,8)|0;qn=D;zn=Wn|Hn;Kn=t+8|0;Jn=n[Kn>>0]|0;Yn=Jn&255;Qn=oi(Yn|0,0,16)|0;Xn=D;Zn=zn|Qn;tr=qn|Xn;ir=t+9|0;nr=n[ir>>0]|0;rr=nr&255;sr=oi(rr|0,0,24)|0;ar=D;or=Zn|sr;lr=tr|ar;dr=ai(or|0,lr|0,3)|0;cr=D;ur=dr&67108863;pr=e+16|0;gr=pr;mr=gr;s[mr>>2]=ur;fr=gr+4|0;Sr=fr;s[Sr>>2]=0;vr=n[ir>>0]|0;yr=vr&255;Cr=t+10|0;Tr=n[Cr>>0]|0;_r=Tr&255;br=oi(_r|0,0,8)|0;Pr=D;Ir=br|yr;Ar=t+11|0;Rr=n[Ar>>0]|0;wr=Rr&255;Mr=oi(wr|0,0,16)|0;Or=D;Dr=Ir|Mr;o=Pr|Or;l=t+12|0;d=n[l>>0]|0;c=d&255;u=oi(c|0,0,24)|0;p=D;g=Dr|u;m=o|p;f=ai(g|0,m|0,5)|0;S=D;y=f&33554431;C=e+24|0;T=C;E=T;s[E>>2]=y;_=T+4|0;b=_;s[b>>2]=0;P=n[l>>0]|0;I=P&255;A=t+13|0;R=n[A>>0]|0;M=R&255;O=oi(M|0,0,8)|0;k=D;N=O|I;L=t+14|0;x=n[L>>0]|0;F=x&255;U=oi(F|0,0,16)|0;V=D;H=N|U;$=k|V;j=t+15|0;G=n[j>>0]|0;W=G&255;q=oi(W|0,0,24)|0;z=D;K=H|q;J=$|z;Y=ai(K|0,J|0,6)|0;Q=D;Z=Y&67108863;ee=e+32|0;te=ee;ie=te;s[ie>>2]=Z;ne=te+4|0;re=ne;s[re>>2]=0;se=t+16|0;ae=n[se>>0]|0;oe=ae&255;le=t+17|0;ce=n[le>>0]|0;he=ce&255;ue=oi(he|0,0,8)|0;pe=D;ge=ue|oe;me=t+18|0;fe=n[me>>0]|0;Se=fe&255;ve=oi(Se|0,0,16)|0;ye=D;Te=ge|ve;Ee=pe|ye;_e=t+19|0;be=n[_e>>0]|0;Pe=be&255;Ie=oi(Pe|0,0,24)|0;Ae=D;Re=Ie&16777216;we=Te|Re;Me=e+40|0;De=Me;ke=De;s[ke>>2]=we;Ne=De+4|0;Le=Ne;s[Le>>2]=Ee;xe=n[_e>>0]|0;Fe=xe&255;Ue=t+20|0;Ve=n[Ue>>0]|0;He=Ve&255;Be=oi(He|0,0,8)|0;je=D;Ge=Be|Fe;We=t+21|0;qe=n[We>>0]|0;ze=qe&255;Ke=oi(ze|0,0,16)|0;Je=D;Ye=Ge|Ke;Qe=je|Je;Xe=t+22|0;et=n[Xe>>0]|0;tt=et&255;it=oi(tt|0,0,24)|0;nt=D;rt=Ye|it;st=Qe|nt;at=ai(rt|0,st|0,1)|0;ot=D;lt=at&67108863;dt=e+48|0;ut=dt;pt=ut;s[pt>>2]=lt;gt=ut+4|0;mt=gt;s[mt>>2]=0;ft=n[Xe>>0]|0;St=ft&255;vt=t+23|0;yt=n[vt>>0]|0;Ct=yt&255;Tt=oi(Ct|0,0,8)|0;_t=D;bt=Tt|St;Pt=t+24|0;It=n[Pt>>0]|0;At=It&255;Rt=oi(At|0,0,16)|0;wt=D;Mt=bt|Rt;Ot=_t|wt;Dt=t+25|0;Nt=n[Dt>>0]|0;Lt=Nt&255;xt=oi(Lt|0,0,24)|0;Ft=D;Ut=Mt|xt;Vt=Ot|Ft;Ht=ai(Ut|0,Vt|0,3)|0;Bt=D;$t=Ht&33554431;jt=e+56|0;Wt=jt;qt=Wt;s[qt>>2]=$t;zt=Wt+4|0;Kt=zt;s[Kt>>2]=0;Jt=n[Dt>>0]|0;Yt=Jt&255;Qt=t+26|0;Xt=n[Qt>>0]|0;Zt=Xt&255;ei=oi(Zt|0,0,8)|0;ii=D;ni=ei|Yt;ri=t+27|0;si=n[ri>>0]|0;li=si&255;di=oi(li|0,0,16)|0;ci=D;hi=ni|di;ui=ii|ci;pi=t+28|0;mi=n[pi>>0]|0;fi=mi&255;Si=oi(fi|0,0,24)|0;vi=D;yi=hi|Si;Ci=ui|vi;Ti=ai(yi|0,Ci|0,4)|0;Ei=D;_i=Ti&67108863;bi=e+64|0;Ii=bi;Ai=Ii;s[Ai>>2]=_i;Ri=Ii+4|0;wi=Ri;s[wi>>2]=0;Mi=n[pi>>0]|0;Oi=Mi&255;Di=t+29|0;ki=n[Di>>0]|0;Ni=ki&255;Li=oi(Ni|0,0,8)|0;Fi=D;Ui=Li|Oi;Vi=t+30|0;Hi=n[Vi>>0]|0;Bi=Hi&255;$i=oi(Bi|0,0,16)|0;ji=D;Gi=Ui|$i;Wi=Fi|ji;qi=t+31|0;Ki=n[qi>>0]|0;Ji=Ki&255;Yi=oi(Ji|0,0,24)|0;Qi=D;Xi=Gi|Yi;Zi=Wi|Qi;en=ai(Xi|0,Zi|0,6)|0;tn=D;nn=en&33554431;rn=e+72|0;an=rn;on=an;s[on>>2]=nn;ln=an+4|0;dn=ln;s[dn>>2]=0;h=Nr;return}function De(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;var a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0,b=0,P=0,I=0;var A=0,R=0,w=0,M=0,O=0,D=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0,j=0,G=0,W=0,q=0;var z=0,K=0,J=0,Y=0,Q=0,X=0,Z=0,ee=0,te=0,ie=0,ne=0,re=0,se=0,ae=0,oe=0,le=0,de=0,ce=0,he=0,ue=0;var pe=0,ge=0,me=0,fe=0,Se=0,ve=0,ye=0;Se=h;h=h+1216|0;D=Se+1064|0;k=Se+912|0;L=Se+760|0;x=Se+608|0;F=Se+456|0;H=Se+304|0;B=Se+152|0;$=Se;si(D|0,0,152)|0;si(k|0,0,152)|0;a=k;o=a;s[o>>2]=1;y=a+4|0;P=y;s[P>>2]=0;si(L|0,0,152)|0;I=L;A=I;s[A>>2]=1;R=I+4|0;w=R;s[w>>2]=0;si(x|0,0,152)|0;si(F|0,0,152)|0;si(H|0,0,152)|0;M=H;O=M;s[O>>2]=1;l=M+4|0;d=l;s[d>>2]=0;si(B|0,0,152)|0;si($|0,0,152)|0;c=$;u=c;s[u>>2]=1;p=c+4|0;g=p;s[g>>2]=0;me=D+0|0;ve=r+0|0;ye=me+80|0;do{s[me>>2]=s[ve>>2]|0;me=me+4|0;ve=ve+4|0}while((me|0)<(ye|0));j=0;W=D;K=F;Q=k;ee=H;ne=L;ae=B;de=x;ue=$;while(1){m=31-j|0;f=i+m|0;S=n[f>>0]|0;N=S;G=0;q=W;J=K;X=Q;te=ee;re=ne;oe=ae;ce=de;pe=ue;while(1){v=N&255;C=v>>>7;xe(re,q,C,0);xe(ce,X,C,0);Fe(oe,pe,J,te,re,ce,q,X,r);xe(oe,J,C,0);xe(pe,te,C,0);T=v<<1;E=T&255;_=G+1|0;U=(_|0)==8;if(U){break}else{ge=ce;he=pe;le=re;se=oe;ie=X;Z=te;Y=q;z=J;N=E;G=_;pe=ge;ce=he;oe=le;re=se;te=ie;X=Z;J=Y;q=z}}b=j+1|0;V=(b|0)==32;if(V){break}else{j=b;W=J;K=q;Q=te;ee=X;ne=oe;ae=re;de=pe;ue=ce}}me=e+0|0;ve=oe+0|0;ye=me+80|0;do{s[me>>2]=s[ve>>2]|0;me=me+4|0;ve=ve+4|0}while((me|0)<(ye|0));me=t+0|0;ve=pe+0|0;ye=me+80|0;do{s[me>>2]=s[ve>>2]|0;me=me+4|0;ve=ve+4|0}while((me|0)<(ye|0));h=Se;return}function ke(e,t){e=e|0;t=t|0;var i=0,n=0,r=0,s=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0;var _=0;_=h;h=h+800|0;m=_+720|0;T=_+640|0;g=_+560|0;C=_+480|0;S=_+400|0;v=_+320|0;y=_+240|0;f=_+160|0;u=_+80|0;p=_;Ue(m,t);Ue(p,m);Ue(u,p);Ne(T,u,t);Ne(g,T,m);Ue(u,g);Ne(C,u,T);Ue(u,C);Ue(p,u);Ue(u,p);Ue(p,u);Ue(u,p);Ne(S,u,C);Ue(u,S);Ue(p,u);Ue(u,p);Ue(p,u);Ue(u,p);Ue(p,u);Ue(u,p);Ue(p,u);Ue(u,p);Ue(p,u);Ne(v,p,S);Ue(u,v);Ue(p,u);Ue(u,p);Ue(p,u);Ue(u,p);Ue(p,u);Ue(u,p);Ue(p,u);Ue(u,p);Ue(p,u);Ue(u,p);Ue(p,u);Ue(u,p);Ue(p,u);Ue(u,p);Ue(p,u);Ue(u,p);Ue(p,u);Ue(u,p);Ue(p,u);Ne(u,p,v);Ue(p,u);Ue(u,p);Ue(p,u);Ue(u,p);Ue(p,u);Ue(u,p);Ue(p,u);Ue(u,p);Ue(p,u);Ue(u,p);Ne(y,u,S);Ue(u,y);Ue(p,u);l=2;while(1){Ue(u,p);Ue(p,u);i=l+2|0;n=(i|0)<50;if(n){l=i}else{break}}Ne(f,p,y);Ue(p,f);Ue(u,p);d=2;while(1){Ue(p,u);Ue(u,p);r=d+2|0;s=(r|0)<100;if(s){d=r}else{break}}Ne(p,u,f);Ue(u,p);Ue(p,u);c=2;while(1){Ue(u,p);Ue(p,u);a=c+2|0;o=(a|0)<50;if(o){c=a}else{break}}Ne(u,p,y);Ue(p,u);Ue(u,p);Ue(p,u);Ue(u,p);Ue(p,u);Ne(e,p,g);h=_;return}function Ne(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,r=0,a=0,o=0,l=0,d=0;o=h;h=h+160|0;n=o;Ve(n,t,i);He(n);Be(n);r=e+0|0;l=n+0|0;d=r+80|0;do{s[r>>2]=s[l>>2]|0;r=r+4|0;l=l+4|0}while((r|0)<(d|0));h=o;return}function Le(e,t){e=e|0;t=t|0;var i=0,r=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0,b=0;var P=0,I=0,A=0,R=0,w=0,M=0,O=0,D=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0,j=0,G=0;var W=0,q=0,z=0,K=0,J=0,Y=0,Q=0,X=0,Z=0,ee=0,te=0,ne=0,re=0,se=0,ae=0,oe=0,le=0,de=0,ce=0,he=0;var ue=0,pe=0,ge=0,me=0,fe=0,Se=0,ve=0,ye=0,Ce=0,Te=0,Ee=0,_e=0,be=0,Pe=0,Ie=0,Ae=0,Re=0,we=0,Me=0,Oe=0;var De=0,ke=0,Ne=0,Le=0,xe=0,Fe=0,Ue=0,Ve=0,He=0,Be=0,Ge=0,We=0,qe=0,ze=0,Ke=0,Je=0,Ye=0,Qe=0,Xe=0,Ze=0;var et=0,tt=0,it=0,nt=0,rt=0,st=0,at=0,ot=0,lt=0,dt=0,ct=0,ht=0,ut=0,pt=0,gt=0,mt=0,ft=0,St=0,vt=0,yt=0;var Ct=0,Tt=0,Et=0,_t=0,bt=0,Pt=0,It=0,At=0,Rt=0,wt=0,Mt=0,Ot=0,Dt=0,kt=0,Nt=0,Lt=0,xt=0,Ft=0,Ut=0,Vt=0;var Ht=0,Bt=0,$t=0,jt=0,Gt=0,Wt=0,qt=0,zt=0,Kt=0,Jt=0,Yt=0,Qt=0,Xt=0,Zt=0,ei=0,ti=0,ii=0,ni=0,ri=0,si=0;var ai=0,oi=0,li=0,di=0,ci=0,hi=0,ui=0,pi=0,gi=0,mi=0,fi=0,Si=0,vi=0,yi=0,Ci=0,Ti=0,Ei=0,_i=0,bi=0,Pi=0;var Ii=0,Ai=0,Ri=0,wi=0,Mi=0,Oi=0,Di=0,ki=0,Ni=0,Li=0,xi=0,Fi=0,Ui=0,Vi=0,Hi=0,Bi=0,$i=0,ji=0,Gi=0,Wi=0;var qi=0,zi=0,Ki=0,Ji=0,Yi=0,Qi=0,Xi=0,Zi=0,en=0,tn=0,nn=0,rn=0,sn=0,an=0,on=0,ln=0,dn=0,cn=0,hn=0,un=0;var pn=0,gn=0,mn=0,fn=0,Sn=0,vn=0,yn=0,Cn=0,Tn=0,En=0,_n=0,bn=0,Pn=0,In=0,An=0,Rn=0,wn=0,Mn=0,On=0,Dn=0;var kn=0,Nn=0,Ln=0,xn=0,Fn=0,Un=0,Vn=0,Hn=0,Bn=0,$n=0,jn=0,Gn=0,Wn=0,qn=0,zn=0,Kn=0,Jn=0,Yn=0,Qn=0,Xn=0;var Zn=0,er=0,tr=0,ir=0,nr=0,rr=0,sr=0,ar=0,or=0,lr=0,dr=0,cr=0,hr=0,ur=0,pr=0,gr=0,mr=0,fr=0,Sr=0,vr=0;var yr=0,Cr=0,Tr=0,Er=0,_r=0,br=0,Pr=0,Ir=0,Ar=0,Rr=0,wr=0,Mr=0,Or=0,Dr=0,kr=0,Nr=0,Lr=0,xr=0,Fr=0,Ur=0;var Vr=0,Hr=0,Br=0,$r=0,jr=0,Gr=0,Wr=0,qr=0,zr=0,Kr=0,Jr=0,Yr=0,Qr=0,Xr=0,Zr=0,es=0,ts=0,is=0,ns=0,rs=0;var ss=0,as=0,os=0,ls=0,ds=0,cs=0,hs=0,us=0,ps=0,gs=0,ms=0,fs=0,Ss=0,vs=0,ys=0,Cs=0,Ts=0,Es=0,_s=0,bs=0;var Ps=0,Is=0,As=0,Rs=0,ws=0,Ms=0,Os=0,Ds=0,ks=0,Ns=0,Ls=0,xs=0,Fs=0,Us=0,Vs=0,Hs=0,Bs=0,$s=0,js=0,Gs=0;var Ws=0,qs=0,zs=0,Ks=0,Js=0,Ys=0,Qs=0,Xs=0,Zs=0,ea=0,ta=0,ia=0,na=0,ra=0,sa=0,aa=0,oa=0,la=0,da=0,ca=0;var ha=0,ua=0,pa=0,ga=0,ma=0,fa=0,Sa=0,va=0,ya=0,Ca=0,Ta=0,Ea=0,_a=0,ba=0,Pa=0,Ia=0,Aa=0,Ra=0,wa=0,Ma=0;var Oa=0,Da=0,ka=0,Na=0,La=0,xa=0,Fa=0,Ua=0,Va=0,Ha=0,Ba=0,$a=0,ja=0,Ga=0,Wa=0,qa=0,za=0,Ka=0,Ja=0,Ya=0;var Qa=0;Qa=h;h=h+48|0;za=Qa;r=t;a=r;pt=s[a>>2]|0;Sn=r+4|0;Cs=Sn;xs=s[Cs>>2]|0;s[za>>2]=pt;zs=t+8|0;ra=zs;ma=ra;Ia=s[ma>>2]|0;o=ra+4|0;y=o;M=s[y>>2]|0;B=za+4|0;s[B>>2]=Ia;X=t+16|0;ce=X;Te=ce;De=s[Te>>2]|0;We=ce+4|0;it=We;gt=s[it>>2]|0;Pt=za+8|0;s[Pt>>2]=De;xt=t+24|0;zt=xt;ri=zt;mi=s[ri>>2]|0;Ii=zt+4|0;Fi=Ii;Ki=s[Fi>>2]|0;an=za+12|0;s[an>>2]=mi;vn=t+32|0;wn=vn;Hn=wn;Qn=s[Hn>>2]|0;lr=wn+4|0;yr=lr;Mr=s[yr>>2]|0;Br=za+16|0;s[Br>>2]=Qn;Xr=t+40|0;ds=Xr;Ts=ds;As=s[Ts>>2]|0;Rs=ds+4|0;ws=Rs;Ms=s[ws>>2]|0;Os=za+20|0;s[Os>>2]=As;Ds=t+48|0;ks=Ds;Ns=ks;Ls=s[Ns>>2]|0;Fs=ks+4|0;Us=Fs;Vs=s[Us>>2]|0;Hs=za+24|0;s[Hs>>2]=Ls;Bs=t+56|0;$s=Bs;js=$s;Gs=s[js>>2]|0;Ws=$s+4|0;qs=Ws;Ks=s[qs>>2]|0;Js=za+28|0;s[Js>>2]=Gs;Ys=t+64|0;Qs=Ys;Xs=Qs;Zs=s[Xs>>2]|0;ea=Qs+4|0;ta=ea;ia=s[ta>>2]|0;na=za+32|0;s[na>>2]=Zs;sa=t+72|0;aa=sa;oa=aa;la=s[oa>>2]|0;da=aa+4|0;ca=da;ha=s[ca>>2]|0;ua=za+36|0;s[ua>>2]=la;pa=za+36|0;$a=0;while(1){ga=$a&1;fa=(ga|0)==0;Sa=za+($a<<2)|0;va=s[Sa>>2]|0;ya=va>>31;Ca=ya&va;if(fa){wa=Ca>>26;Ma=ie(wa,-67108864)|0;Oa=Ma+va|0;s[Sa>>2]=Oa;Da=$a+1|0;ka=za+(Da<<2)|0;Na=s[ka>>2]|0;La=Na+wa|0;s[ka>>2]=La}else{Ta=Ca>>25;Ea=ie(Ta,-33554432)|0;_a=Ea+va|0;s[Sa>>2]=_a;ba=$a+1|0;Pa=za+(ba<<2)|0;Aa=s[Pa>>2]|0;Ra=Aa+Ta|0;s[Pa>>2]=Ra}xa=$a+1|0;Ha=(xa|0)==9;if(Ha){break}else{$a=xa}}l=s[pa>>2]|0;d=l>>31;c=d&l;u=c>>25;p=ie(u,-33554432)|0;g=p+l|0;s[pa>>2]=g;m=s[za>>2]|0;f=u*19|0;S=f+m|0;s[za>>2]=S;ja=0;while(1){ns=ja&1;rs=(ns|0)==0;ss=za+(ja<<2)|0;as=s[ss>>2]|0;os=as>>31;ls=os&as;if(rs){Ss=ls>>26;vs=ie(Ss,-67108864)|0;ys=vs+as|0;s[ss>>2]=ys;Es=ja+1|0;_s=za+(Es<<2)|0;bs=s[_s>>2]|0;Ps=bs+Ss|0;s[_s>>2]=Ps}else{cs=ls>>25;hs=ie(cs,-33554432)|0;us=hs+as|0;s[ss>>2]=us;ps=ja+1|0;gs=za+(ps<<2)|0;ms=s[gs>>2]|0;fs=ms+cs|0;s[gs>>2]=fs}Is=ja+1|0;Ba=(Is|0)==9;if(Ba){break}else{ja=Is}}v=s[pa>>2]|0;C=v>>31;T=C&v;E=T>>25;_=ie(E,-33554432)|0;b=_+v|0;s[pa>>2]=b;P=s[za>>2]|0;I=E*19|0;A=I+P|0;R=A>>31;w=R&A;O=w>>26;D=ie(O,-67108864)|0;k=D+A|0;s[za>>2]=k;N=za+4|0;L=s[N>>2]|0;x=O+L|0;s[N>>2]=x;F=za+36|0;Ga=0;while(1){U=Ga&1;V=(U|0)==0;H=za+(Ga<<2)|0;$=s[H>>2]|0;if(V){J=$>>26;Y=$&67108863;s[H>>2]=Y;Q=Ga+1|0;Z=za+(Q<<2)|0;ee=s[Z>>2]|0;te=ee+J|0;s[Z>>2]=te}else{j=$>>25;G=$&33554431;s[H>>2]=G;W=Ga+1|0;q=za+(W<<2)|0;z=s[q>>2]|0;K=z+j|0;s[q>>2]=K}ne=Ga+1|0;Ua=(ne|0)==9;if(Ua){break}else{Ga=ne}}re=s[F>>2]|0;se=re>>25;ae=re&33554431;s[F>>2]=ae;oe=se*19|0;le=s[za>>2]|0;de=oe+le|0;s[za>>2]=de;Wa=0;while(1){Or=Wa&1;Dr=(Or|0)==0;kr=za+(Wa<<2)|0;Nr=s[kr>>2]|0;if(Dr){$r=Nr>>26;jr=Nr&67108863;s[kr>>2]=jr;Gr=Wa+1|0;Wr=za+(Gr<<2)|0;qr=s[Wr>>2]|0;zr=qr+$r|0;s[Wr>>2]=zr}else{Lr=Nr>>25;xr=Nr&33554431;s[kr>>2]=xr;Fr=Wa+1|0;Ur=za+(Fr<<2)|0;Vr=s[Ur>>2]|0;Hr=Vr+Lr|0;s[Ur>>2]=Hr}Kr=Wa+1|0;Va=(Kr|0)==9;if(Va){break}else{Wa=Kr}}Jr=s[F>>2]|0;Yr=Jr>>25;Qr=Jr&33554431;s[F>>2]=Qr;Zr=Yr*19|0;es=s[za>>2]|0;ts=Zr+es|0;s[za>>2]=ts;is=je(ts)|0;qa=1;Ka=is;while(1){he=qa&1;ue=(he|0)==0;pe=za+(qa<<2)|0;ge=s[pe>>2]|0;if(ue){fe=$e(ge,67108863)|0;i=fe}else{me=$e(ge,33554431)|0;i=me}Ja=i&Ka;Se=qa+1|0;Fa=(Se|0)==10;if(Fa){break}else{qa=Se;Ka=Ja}}ve=Ja&67108845;ye=s[za>>2]|0;Ce=ye-ve|0;s[za>>2]=Ce;Ee=Ja&67108863;_e=Ja&33554431;be=za+4|0;Pe=s[be>>2]|0;Ie=Pe-_e|0;s[be>>2]=Ie;Ae=za+8|0;Re=s[Ae>>2]|0;we=Re-Ee|0;s[Ae>>2]=we;Me=za+12|0;Oe=s[Me>>2]|0;ke=Oe-_e|0;s[Me>>2]=ke;Ne=za+16|0;Le=s[Ne>>2]|0;xe=Le-Ee|0;s[Ne>>2]=xe;Fe=za+20|0;Ue=s[Fe>>2]|0;Ve=Ue-_e|0;s[Fe>>2]=Ve;He=za+24|0;Be=s[He>>2]|0;Ge=Be-Ee|0;s[He>>2]=Ge;qe=za+28|0;ze=s[qe>>2]|0;Ke=ze-_e|0;s[qe>>2]=Ke;Je=za+32|0;Ye=s[Je>>2]|0;Qe=Ye-Ee|0;s[Je>>2]=Qe;Xe=za+36|0;Ze=s[Xe>>2]|0;et=Ze-_e|0;s[Xe>>2]=et;tt=s[N>>2]|0;nt=tt<<2;s[N>>2]=nt;rt=za+8|0;st=s[rt>>2]|0;at=st<<3;s[rt>>2]=at;ot=za+12|0;lt=s[ot>>2]|0;dt=lt<<5;s[ot>>2]=dt;ct=za+16|0;ht=s[ct>>2]|0;ut=ht<<6;s[ct>>2]=ut;mt=za+24|0;ft=s[mt>>2]|0;St=ft<<1;s[mt>>2]=St;vt=za+28|0;yt=s[vt>>2]|0;Ct=yt<<3;s[vt>>2]=Ct;Tt=za+32|0;Et=s[Tt>>2]|0;_t=Et<<4;s[Tt>>2]=_t;bt=za+36|0;It=s[bt>>2]|0;At=It<<6;s[bt>>2]=At;n[e>>0]=0;Rt=e+16|0;n[Rt>>0]=0;wt=s[za>>2]|0;Mt=n[e>>0]|0;Ot=Mt&255;Dt=Ot|wt;kt=Dt&255;n[e>>0]=kt;Nt=s[za>>2]|0;Lt=Nt>>>8;Ft=Lt&255;Ut=e+1|0;n[Ut>>0]=Ft;Vt=s[za>>2]|0;Ht=Vt>>>16;Bt=Ht&255;$t=e+2|0;n[$t>>0]=Bt;jt=s[za>>2]|0;Gt=jt>>>24;Wt=e+3|0;qt=s[N>>2]|0;Kt=Gt|qt;Jt=Kt&255;n[Wt>>0]=Jt;Yt=s[N>>2]|0;Qt=Yt>>>8;Xt=Qt&255;Zt=e+4|0;n[Zt>>0]=Xt;ei=s[N>>2]|0;ti=ei>>>16;ii=ti&255;ni=e+5|0;n[ni>>0]=ii;si=s[N>>2]|0;ai=si>>>24;oi=e+6|0;li=s[rt>>2]|0;di=ai|li;ci=di&255;n[oi>>0]=ci;hi=s[rt>>2]|0;ui=hi>>>8;pi=ui&255;gi=e+7|0;n[gi>>0]=pi;fi=s[rt>>2]|0;Si=fi>>>16;vi=Si&255;yi=e+8|0;n[yi>>0]=vi;Ci=s[rt>>2]|0;Ti=Ci>>>24;Ei=e+9|0;_i=s[ot>>2]|0;bi=Ti|_i;Pi=bi&255;n[Ei>>0]=Pi;Ai=s[ot>>2]|0;Ri=Ai>>>8;wi=Ri&255;Mi=e+10|0;n[Mi>>0]=wi;Oi=s[ot>>2]|0;Di=Oi>>>16;ki=Di&255;Ni=e+11|0;n[Ni>>0]=ki;Li=s[ot>>2]|0;xi=Li>>>24;Ui=e+12|0;Vi=s[ct>>2]|0;Hi=xi|Vi;Bi=Hi&255;n[Ui>>0]=Bi;$i=s[ct>>2]|0;ji=$i>>>8;Gi=ji&255;Wi=e+13|0;n[Wi>>0]=Gi;qi=s[ct>>2]|0;zi=qi>>>16;Ji=zi&255;Yi=e+14|0;n[Yi>>0]=Ji;Qi=s[ct>>2]|0;Xi=Qi>>>24;Zi=Xi&255;en=e+15|0;n[en>>0]=Zi;tn=za+20|0;nn=s[tn>>2]|0;rn=n[Rt>>0]|0;sn=rn&255;on=sn|nn;ln=on&255;n[Rt>>0]=ln;dn=s[tn>>2]|0;cn=dn>>>8;hn=cn&255;un=e+17|0;n[un>>0]=hn;pn=s[tn>>2]|0;gn=pn>>>16;mn=gn&255;fn=e+18|0;n[fn>>0]=mn;yn=s[tn>>2]|0;Cn=yn>>>24;Tn=e+19|0;En=s[mt>>2]|0;_n=Cn|En;bn=_n&255;n[Tn>>0]=bn;Pn=s[mt>>2]|0;In=Pn>>>8;An=In&255;Rn=e+20|0;n[Rn>>0]=An;Mn=s[mt>>2]|0;On=Mn>>>16;Dn=On&255;kn=e+21|0;n[kn>>0]=Dn;Nn=s[mt>>2]|0;Ln=Nn>>>24;xn=e+22|0;Fn=s[vt>>2]|0;Un=Ln|Fn;Vn=Un&255;n[xn>>0]=Vn;Bn=s[vt>>2]|0;$n=Bn>>>8;jn=$n&255;Gn=e+23|0;n[Gn>>0]=jn;Wn=s[vt>>2]|0;qn=Wn>>>16;zn=qn&255;Kn=e+24|0;n[Kn>>0]=zn;Jn=s[vt>>2]|0;Yn=Jn>>>24;Xn=e+25|0;Zn=s[Tt>>2]|0;er=Yn|Zn;tr=er&255;n[Xn>>0]=tr;ir=s[Tt>>2]|0;nr=ir>>>8;rr=nr&255;sr=e+26|0;n[sr>>0]=rr;ar=s[Tt>>2]|0;or=ar>>>16;dr=or&255;cr=e+27|0;n[cr>>0]=dr;hr=s[Tt>>2]|0;ur=hr>>>24;pr=e+28|0;gr=s[bt>>2]|0;mr=ur|gr;fr=mr&255;n[pr>>0]=fr;Sr=s[bt>>2]|0;vr=Sr>>>8;Cr=vr&255;Tr=e+29|0;n[Tr>>0]=Cr;Er=s[bt>>2]|0;_r=Er>>>16;br=_r&255;Pr=e+30|0;n[Pr>>0]=br;Ir=s[bt>>2]|0;Ar=Ir>>>24;Rr=Ar&255;wr=e+31|0;n[wr>>0]=Rr;h=Qa;return}function xe(e,t,i,n){e=e|0;t=t|0;i=i|0;n=n|0;var r=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0,b=0,P=0;var I=0,A=0,R=0,w=0,M=0,O=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0,j=0,G=0,W=0,q=0;var z=0,K=0,J=0,Y=0,Q=0;Q=h;f=ni(0,0,i|0,n|0)|0;A=D;J=0;while(1){V=e+(J<<3)|0;j=V;G=j;W=s[G>>2]|0;q=j+4|0;z=q;r=s[z>>2]|0;a=t+(J<<3)|0;o=a;l=o;d=s[l>>2]|0;c=o+4|0;u=c;p=s[u>>2]|0;g=d^W;m=p^r;S=g&f;v=m&A;y=S^W;v^r;C=ii(0,y|0,32)|0;T=D;E=V;_=E;s[_>>2]=C;b=E+4|0;P=b;s[P>>2]=T;I=a;R=I;w=s[R>>2]|0;M=I+4|0;O=M;k=s[O>>2]|0;N=S^w;v^k;L=ii(0,N|0,32)|0;x=D;F=a;U=F;s[U>>2]=L;H=F+4|0;B=H;s[B>>2]=x;$=J+1|0;K=($|0)==10;if(K){break}else{J=$}}h=Q;return}function Fe(e,t,i,n,r,a,o,l,d){e=e|0;t=t|0;i=i|0;n=n|0;r=r|0;a=a|0;o=o|0;l=l|0;d=d|0;var c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0,b=0,P=0;_=h;h=h+1232|0;u=_+1144|0;p=_+1064|0;y=_+912|0;g=_+760|0;S=_+608|0;m=_+456|0;v=_+304|0;C=_+152|0;f=_;T=u+0|0;b=r+0|0;P=T+80|0;do{s[T>>2]=s[b>>2]|0;T=T+4|0;b=b+4|0}while((T|0)<(P|0));Ge(r,a);We(a,u);T=p+0|0;b=o+0|0;P=T+80|0;do{s[T>>2]=s[b>>2]|0;T=T+4|0;b=b+4|0}while((T|0)<(P|0));Ge(o,l);We(l,p);Ve(m,o,a);Ve(v,r,l);He(m);Be(m);He(v);Be(v);T=p+0|0;b=m+0|0;P=T+80|0;do{s[T>>2]=s[b>>2]|0;T=T+4|0;b=b+4|0}while((T|0)<(P|0));Ge(m,v);We(v,p);Ue(f,m);Ue(C,v);Ve(v,C,d);He(v);Be(v);T=i+0|0;b=f+0|0;P=T+80|0;do{s[T>>2]=s[b>>2]|0;T=T+4|0;b=b+4|0}while((T|0)<(P|0));T=n+0|0;b=v+0|0;P=T+80|0;do{s[T>>2]=s[b>>2]|0;T=T+4|0;b=b+4|0}while((T|0)<(P|0));Ue(g,r);Ue(S,a);Ve(e,g,S);He(e);Be(e);We(S,g);c=y+80|0;T=c+0|0;P=T+72|0;do{s[T>>2]=0|0;T=T+4|0}while((T|0)<(P|0));qe(y,S);Be(y);Ge(y,g);Ve(t,S,y);He(t);Be(t);h=_;return}function Ue(e,t){e=e|0;t=t|0;var i=0,n=0,r=0,a=0,o=0,l=0;a=h;h=h+160|0;i=a;ze(i,t);He(i);Be(i);n=e+0|0;o=i+0|0;l=n+80|0;do{s[n>>2]=s[o>>2]|0;n=n+4|0;o=o+4|0}while((n|0)<(l|0));h=a;return}function Ve(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,r=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0,b=0;var P=0,I=0,A=0,R=0,w=0,M=0,O=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0,j=0,G=0,W=0;var q=0,z=0,K=0,J=0,Y=0,Q=0,X=0,Z=0,ee=0,te=0,ie=0,ne=0,re=0,se=0,ae=0,oe=0,le=0,de=0,ce=0,he=0;var ue=0,pe=0,ge=0,me=0,fe=0,Se=0,ve=0,ye=0,Ce=0,Te=0,Ee=0,_e=0,be=0,Pe=0,Ie=0,Ae=0,Re=0,we=0,Me=0,Oe=0;var De=0,ke=0,Ne=0,Le=0,xe=0,Fe=0,Ue=0,Ve=0,He=0,Be=0,$e=0,je=0,Ge=0,We=0,qe=0,ze=0,Ke=0,Je=0,Ye=0,Qe=0;var Xe=0,Ze=0,et=0,tt=0,it=0,nt=0,rt=0,st=0,at=0,ot=0,lt=0,dt=0,ct=0,ht=0,ut=0,pt=0,gt=0,mt=0,ft=0,St=0;var vt=0,yt=0,Ct=0,Tt=0,Et=0,_t=0,bt=0,Pt=0,It=0,At=0,Rt=0,wt=0,Mt=0,Ot=0,Dt=0,kt=0,Nt=0,Lt=0,xt=0,Ft=0;var Ut=0,Vt=0,Ht=0,Bt=0,$t=0,jt=0,Gt=0,Wt=0,qt=0,zt=0,Kt=0,Jt=0,Yt=0,Qt=0,Xt=0,Zt=0,ei=0,ti=0,ni=0,si=0;var ai=0,li=0,di=0,ci=0,hi=0,ui=0,pi=0,gi=0,mi=0,Si=0,vi=0,yi=0,Ci=0,Ti=0,Ei=0,_i=0,bi=0,Pi=0,Ii=0,Ai=0;var Ri=0,wi=0,Mi=0,Oi=0,Di=0,ki=0,Ni=0,Li=0,xi=0,Fi=0,Ui=0,Vi=0,Hi=0,Bi=0,$i=0,ji=0,Gi=0,Wi=0,qi=0,zi=0;var Ki=0,Ji=0,Yi=0,Qi=0,Xi=0,Zi=0,en=0,tn=0,nn=0,rn=0,sn=0,an=0,on=0,ln=0,dn=0,cn=0,hn=0,un=0,pn=0,gn=0;var mn=0,fn=0,Sn=0,vn=0,yn=0,Cn=0,Tn=0,En=0,_n=0,bn=0,Pn=0,In=0,An=0,Rn=0,wn=0,Mn=0,On=0,Dn=0,kn=0,Nn=0;var Ln=0,xn=0,Fn=0,Un=0,Vn=0,Hn=0,Bn=0,$n=0,jn=0,Gn=0,Wn=0,qn=0,zn=0,Kn=0,Jn=0,Yn=0,Qn=0,Xn=0,Zn=0,er=0;var tr=0,ir=0,nr=0,rr=0,sr=0,ar=0,or=0,lr=0,dr=0,cr=0,hr=0,ur=0,pr=0,gr=0,mr=0,fr=0,Sr=0,vr=0,yr=0,Cr=0;var Tr=0,Er=0,_r=0,br=0,Pr=0,Ir=0,Ar=0,Rr=0,wr=0,Mr=0,Or=0,Dr=0,kr=0,Nr=0,Lr=0,xr=0,Fr=0,Ur=0,Vr=0,Hr=0;var Br=0,$r=0,jr=0,Gr=0,Wr=0,qr=0,zr=0,Kr=0,Jr=0,Yr=0,Qr=0,Xr=0,Zr=0,es=0,ts=0,is=0,ns=0,rs=0,ss=0,as=0;var os=0,ls=0,ds=0,cs=0,hs=0,us=0,ps=0,gs=0,ms=0,fs=0,Ss=0,vs=0,ys=0,Cs=0,Ts=0,Es=0,_s=0,bs=0,Ps=0,Is=0;var As=0,Rs=0,ws=0,Ms=0,Os=0,Ds=0,ks=0,Ns=0,Ls=0,xs=0,Fs=0,Us=0,Vs=0,Hs=0,Bs=0,$s=0,js=0,Gs=0,Ws=0,qs=0;var zs=0,Ks=0,Js=0,Ys=0,Qs=0,Xs=0,Zs=0,ea=0,ta=0,ia=0,na=0,ra=0,sa=0,aa=0,oa=0,la=0,da=0,ca=0,ha=0,ua=0;var pa=0,ga=0,ma=0,fa=0,Sa=0,va=0,ya=0,Ca=0,Ta=0,Ea=0,_a=0,ba=0,Pa=0,Ia=0,Aa=0,Ra=0,wa=0,Ma=0,Oa=0,Da=0;var ka=0,Na=0,La=0,xa=0,Fa=0,Ua=0,Va=0,Ha=0,Ba=0,$a=0,ja=0,Ga=0,Wa=0,qa=0,za=0,Ka=0,Ja=0,Ya=0,Qa=0,Xa=0;var Za=0,eo=0,to=0,io=0,no=0,ro=0,so=0,ao=0,oo=0,lo=0,co=0,ho=0,uo=0,po=0,go=0,mo=0,fo=0,So=0,vo=0,yo=0;var Co=0,To=0,Eo=0,_o=0,bo=0,Po=0,Io=0,Ao=0,Ro=0,wo=0,Mo=0,Oo=0,Do=0,ko=0,No=0,Lo=0,xo=0,Fo=0,Uo=0,Vo=0;var Ho=0,Bo=0,$o=0,jo=0,Go=0,Wo=0,qo=0,zo=0,Ko=0,Jo=0,Yo=0,Qo=0,Xo=0,Zo=0,el=0,tl=0,il=0,nl=0,rl=0,sl=0;var al=0,ol=0,ll=0,dl=0,cl=0,hl=0,ul=0,pl=0,gl=0,ml=0,fl=0,Sl=0,vl=0,yl=0,Cl=0,Tl=0,El=0,_l=0,bl=0,Pl=0;var Il=0,Al=0,Rl=0,wl=0,Ml=0,Ol=0,Dl=0,kl=0,Nl=0,Ll=0,xl=0,Fl=0,Ul=0,Vl=0,Hl=0,Bl=0,$l=0,jl=0,Gl=0,Wl=0;var ql=0,zl=0,Kl=0,Jl=0,Yl=0,Ql=0,Xl=0,Zl=0,ed=0,td=0,id=0,nd=0,rd=0,sd=0,ad=0,od=0,ld=0,dd=0,cd=0,hd=0;var ud=0,pd=0,gd=0,md=0,fd=0,Sd=0,vd=0,yd=0,Cd=0,Td=0,Ed=0,_d=0,bd=0,Pd=0,Id=0,Ad=0,Rd=0,wd=0,Md=0,Od=0;var Dd=0,kd=0,Nd=0,Ld=0,xd=0,Fd=0,Ud=0,Vd=0,Hd=0,Bd=0,$d=0,jd=0,Gd=0,Wd=0,qd=0,zd=0,Kd=0,Jd=0,Yd=0,Qd=0;var Xd=0,Zd=0,ec=0,tc=0,ic=0,nc=0,rc=0,sc=0,ac=0,oc=0,lc=0,dc=0,cc=0,hc=0,uc=0,pc=0,gc=0,mc=0,fc=0,Sc=0;var vc=0,yc=0,Cc=0,Tc=0,Ec=0,_c=0,bc=0,Pc=0,Ic=0,Ac=0,Rc=0,wc=0,Mc=0,Oc=0,Dc=0,kc=0,Nc=0,Lc=0,xc=0,Fc=0;var Uc=0,Vc=0,Hc=0,Bc=0,$c=0,jc=0,Gc=0,Wc=0,qc=0,zc=0,Kc=0,Jc=0,Yc=0,Qc=0,Xc=0,Zc=0,eh=0,th=0,ih=0,nh=0;var rh=0,sh=0,ah=0,oh=0,lh=0,dh=0,ch=0,hh=0,uh=0,ph=0,gh=0,mh=0,fh=0,Sh=0,vh=0,yh=0,Ch=0,Th=0,Eh=0,_h=0;var bh=0,Ph=0,Ih=0,Ah=0,Rh=0,wh=0,Mh=0,Oh=0,Dh=0,kh=0,Nh=0,Lh=0,xh=0,Fh=0,Uh=0,Vh=0,Hh=0,Bh=0,$h=0,jh=0;var Gh=0,Wh=0,qh=0,zh=0,Kh=0,Jh=0,Yh=0,Qh=0,Xh=0,Zh=0,eu=0,tu=0,iu=0,nu=0,ru=0,su=0,au=0,ou=0,lu=0,du=0;var cu=0,hu=0,uu=0,pu=0,gu=0,mu=0,fu=0,Su=0,vu=0,yu=0,Cu=0,Tu=0,Eu=0,_u=0,bu=0,Pu=0,Iu=0,Au=0,Ru=0,wu=0;var Mu=0,Ou=0,Du=0,ku=0,Nu=0,Lu=0,xu=0,Fu=0,Uu=0,Vu=0,Hu=0,Bu=0,$u=0,ju=0,Gu=0,Wu=0,qu=0,zu=0,Ku=0,Ju=0;var Yu=0,Qu=0,Xu=0,Zu=0,ep=0,tp=0,ip=0,np=0,rp=0,sp=0,ap=0,op=0,lp=0,dp=0,cp=0,hp=0,up=0,pp=0,gp=0,mp=0;var fp=0,Sp=0,vp=0,yp=0,Cp=0,Tp=0,Ep=0,_p=0,bp=0,Pp=0,Ip=0,Ap=0,Rp=0,wp=0,Mp=0,Op=0,Dp=0,kp=0,Np=0,Lp=0;var xp=0,Fp=0,Up=0,Vp=0,Hp=0,Bp=0,$p=0,jp=0,Gp=0,Wp=0,qp=0,zp=0,Kp=0,Jp=0,Yp=0,Qp=0,Xp=0,Zp=0,eg=0,tg=0;var ig=0,ng=0,rg=0,sg=0,ag=0,og=0,lg=0,dg=0,cg=0,hg=0,ug=0,pg=0,gg=0,mg=0,fg=0,Sg=0,vg=0,yg=0,Cg=0,Tg=0;var Eg=0,_g=0,bg=0,Pg=0,Ig=0,Ag=0,Rg=0,wg=0,Mg=0,Og=0,Dg=0,kg=0,Ng=0,Lg=0,xg=0,Fg=0,Ug=0,Vg=0,Hg=0,Bg=0;var $g=0,jg=0,Gg=0,Wg=0,qg=0,zg=0,Kg=0,Jg=0,Yg=0,Qg=0,Xg=0,Zg=0,em=0,tm=0,im=0,nm=0,rm=0,sm=0,am=0,om=0;var lm=0,dm=0,cm=0,hm=0,um=0,pm=0,gm=0,mm=0,fm=0,Sm=0,vm=0,ym=0,Cm=0,Tm=0,Em=0,_m=0,bm=0,Pm=0,Im=0,Am=0;var Rm=0,wm=0,Mm=0,Om=0,Dm=0,km=0,Nm=0,Lm=0,xm=0,Fm=0,Um=0,Vm=0,Hm=0,Bm=0,$m=0,jm=0,Gm=0,Wm=0,qm=0,zm=0;var Km=0,Jm=0,Ym=0,Qm=0,Xm=0,Zm=0,ef=0,tf=0,nf=0,rf=0,sf=0,af=0,of=0,lf=0,df=0,cf=0,hf=0,uf=0,pf=0,gf=0;var mf=0,ff=0,Sf=0,vf=0,yf=0,Cf=0,Tf=0,Ef=0,_f=0,bf=0,Pf=0,If=0,Af=0,Rf=0,wf=0,Mf=0,Of=0,Df=0,kf=0,Nf=0;var Lf=0,xf=0,Ff=0,Uf=0,Vf=0,Hf=0,Bf=0,$f=0,jf=0,Gf=0,Wf=0,qf=0,zf=0,Kf=0,Jf=0,Yf=0,Qf=0,Xf=0,Zf=0,eS=0;var tS=0,iS=0,nS=0,rS=0,sS=0,aS=0,oS=0,lS=0,dS=0,cS=0,hS=0,uS=0,pS=0,gS=0,mS=0,fS=0,SS=0,vS=0,yS=0,CS=0;var TS=0,ES=0,_S=0,bS=0,PS=0,IS=0,AS=0,RS=0,wS=0,MS=0,OS=0,DS=0,kS=0,NS=0,LS=0,xS=0,FS=0,US=0,VS=0,HS=0;var BS=0,$S=0,jS=0,GS=0,WS=0,qS=0,zS=0,KS=0,JS=0,YS=0,QS=0,XS=0,ZS=0,ev=0,tv=0,iv=0,nv=0,rv=0,sv=0,av=0;var ov=0,lv=0,dv=0,cv=0,hv=0,uv=0,pv=0,gv=0,mv=0,fv=0,Sv=0,vv=0,yv=0,Cv=0,Tv=0,Ev=0,_v=0,bv=0,Pv=0,Iv=0;var Av=0,Rv=0,wv=0,Mv=0,Ov=0,Dv=0,kv=0,Nv=0,Lv=0,xv=0,Fv=0,Uv=0,Vv=0,Hv=0,Bv=0,$v=0,jv=0,Gv=0,Wv=0,qv=0;var zv=0,Kv=0,Jv=0,Yv=0,Qv=0,Xv=0,Zv=0,ey=0,ty=0,iy=0,ny=0,ry=0,sy=0,ay=0,oy=0,ly=0,dy=0,cy=0,hy=0,uy=0;var py=0,gy=0,my=0,fy=0,Sy=0,vy=0,yy=0,Cy=0,Ty=0,Ey=0,_y=0,by=0,Py=0,Iy=0,Ay=0,Ry=0,wy=0,My=0,Oy=0,Dy=0;var ky=0,Ny=0,Ly=0,xy=0,Fy=0,Uy=0,Vy=0,Hy=0,By=0,$y=0,jy=0,Gy=0,Wy=0,qy=0,zy=0,Ky=0,Jy=0,Yy=0,Qy=0,Xy=0;var Zy=0,eC=0,tC=0,iC=0,nC=0,rC=0,sC=0,aC=0,oC=0,lC=0,dC=0,cC=0,hC=0,uC=0,pC=0,gC=0,mC=0,fC=0,SC=0,vC=0;var yC=0,CC=0,TC=0,EC=0,_C=0,bC=0,PC=0,IC=0,AC=0,RC=0,wC=0,MC=0,OC=0,DC=0,kC=0,NC=0,LC=0,xC=0,FC=0,UC=0;var VC=0,HC=0,BC=0,$C=0,jC=0,GC=0,WC=0,qC=0,zC=0,KC=0,JC=0,YC=0,QC=0,XC=0,ZC=0,eT=0,tT=0,iT=0,nT=0,rT=0;var sT=0,aT=0,oT=0,lT=0,dT=0,cT=0,hT=0,uT=0,pT=0,gT=0,mT=0,fT=0,ST=0,vT=0,yT=0,CT=0,TT=0,ET=0,_T=0,bT=0;var PT=0,IT=0,AT=0,RT=0,wT=0,MT=0,OT=0,DT=0,kT=0,NT=0,LT=0,xT=0,FT=0,UT=0,VT=0,HT=0,BT=0,$T=0,jT=0,GT=0;var WT=0,qT=0,zT=0,KT=0,JT=0,YT=0,QT=0,XT=0,ZT=0,eE=0,tE=0,iE=0,nE=0,rE=0,sE=0,aE=0,oE=0,lE=0,dE=0,cE=0;var hE=0,uE=0,pE=0,gE=0,mE=0,fE=0,SE=0,vE=0,yE=0,CE=0,TE=0,EE=0,_E=0,bE=0,PE=0,IE=0,AE=0,RE=0,wE=0,ME=0;var OE=0,DE=0,kE=0,NE=0,LE=0,xE=0,FE=0,UE=0,VE=0,HE=0,BE=0,$E=0,jE=0,GE=0,WE=0,qE=0,zE=0,KE=0,JE=0,YE=0;var QE=0,XE=0,ZE=0,e_=0,t_=0,i_=0,n_=0,r_=0,s_=0,a_=0,o_=0,l_=0,d_=0,c_=0,h_=0,u_=0,p_=0,g_=0,m_=0,f_=0;var S_=0,v_=0,y_=0,C_=0,T_=0,E_=0,__=0,b_=0,P_=0,I_=0,A_=0,R_=0,w_=0,M_=0,O_=0,D_=0,k_=0,N_=0,L_=0,x_=0;var F_=0,U_=0,V_=0,H_=0,B_=0,$_=0,j_=0,G_=0,W_=0,q_=0,z_=0,K_=0,J_=0,Y_=0,Q_=0,X_=0,Z_=0,eb=0,tb=0,ib=0;var nb=0,rb=0,sb=0,ab=0,ob=0,lb=0,db=0,cb=0,hb=0,ub=0,pb=0,gb=0,mb=0,fb=0,Sb=0,vb=0,yb=0,Cb=0,Tb=0,Eb=0;var _b=0,bb=0,Pb=0,Ib=0,Ab=0,Rb=0,wb=0,Mb=0,Ob=0,Db=0,kb=0,Nb=0,Lb=0,xb=0,Fb=0,Ub=0,Vb=0,Hb=0,Bb=0,$b=0;var jb=0,Gb=0,Wb=0,qb=0,zb=0,Kb=0,Jb=0,Yb=0,Qb=0,Xb=0,Zb=0,eP=0,tP=0,iP=0,nP=0,rP=0,sP=0,aP=0,oP=0,lP=0;var dP=0,cP=0,hP=0,uP=0,pP=0,gP=0,mP=0,fP=0,SP=0,vP=0,yP=0,CP=0,TP=0,EP=0,_P=0,bP=0,PP=0,IP=0,AP=0,RP=0;var wP=0,MP=0,OP=0,DP=0,kP=0,NP=0,LP=0,xP=0,FP=0,UP=0,VP=0,HP=0,BP=0,$P=0,jP=0,GP=0,WP=0,qP=0,zP=0,KP=0;var JP=0,YP=0,QP=0,XP=0,ZP=0,eI=0,tI=0,iI=0,nI=0,rI=0,sI=0,aI=0,oI=0,lI=0,dI=0,cI=0,hI=0,uI=0,pI=0,gI=0;var mI=0,fI=0,SI=0,vI=0,yI=0,CI=0,TI=0,EI=0,_I=0,bI=0,PI=0,II=0,AI=0,RI=0,wI=0,MI=0,OI=0,DI=0,kI=0,NI=0;var LI=0,xI=0,FI=0,UI=0,VI=0,HI=0,BI=0,$I=0,jI=0,GI=0,WI=0,qI=0,zI=0,KI=0,JI=0,YI=0,QI=0,XI=0,ZI=0,eA=0;var tA=0,iA=0,nA=0,rA=0,sA=0,aA=0,oA=0,lA=0,dA=0,cA=0,hA=0,uA=0,pA=0,gA=0,mA=0,fA=0,SA=0,vA=0,yA=0,CA=0;var TA=0,EA=0,_A=0,bA=0,PA=0,IA=0,AA=0,RA=0,wA=0,MA=0,OA=0,DA=0,kA=0,NA=0,LA=0,xA=0,FA=0,UA=0,VA=0,HA=0;var BA=0,$A=0,jA=0,GA=0,WA=0,qA=0,zA=0,KA=0,JA=0,YA=0,QA=0,XA=0,ZA=0,eR=0,tR=0,iR=0,nR=0,rR=0,sR=0,aR=0;var oR=0,lR=0,dR=0,cR=0,hR=0,uR=0,pR=0,gR=0,mR=0,fR=0,SR=0,vR=0,yR=0,CR=0,TR=0,ER=0,_R=0,bR=0,PR=0,IR=0;var AR=0,RR=0,wR=0,MR=0,OR=0,DR=0,kR=0,NR=0,LR=0,xR=0,FR=0,UR=0,VR=0,HR=0,BR=0,$R=0,jR=0,GR=0,WR=0,qR=0;var zR=0,KR=0,JR=0,YR=0,QR=0,XR=0,ZR=0,ew=0,tw=0,iw=0,nw=0,rw=0,sw=0,aw=0,ow=0,lw=0,dw=0,cw=0,hw=0,uw=0;var pw=0,gw=0,mw=0,fw=0,Sw=0,vw=0,yw=0,Cw=0,Tw=0,Ew=0,_w=0,bw=0,Pw=0,Iw=0,Aw=0,Rw=0,ww=0,Mw=0,Ow=0,Dw=0;var kw=0,Nw=0,Lw=0,xw=0,Fw=0,Uw=0,Vw=0,Hw=0,Bw=0,$w=0,jw=0,Gw=0,Ww=0,qw=0,zw=0,Kw=0,Jw=0,Yw=0,Qw=0,Xw=0;var Zw=0,eM=0,tM=0,iM=0,nM=0,rM=0,sM=0,aM=0,oM=0,lM=0,dM=0,cM=0,hM=0,uM=0,pM=0,gM=0,mM=0,fM=0,SM=0,vM=0;var yM=0,CM=0,TM=0,EM=0,_M=0,bM=0,PM=0,IM=0,AM=0,RM=0,wM=0,MM=0,OM=0,DM=0,kM=0,NM=0,LM=0,xM=0,FM=0,UM=0;var VM=0,HM=0,BM=0,$M=0,jM=0,GM=0,WM=0,qM=0,zM=0,KM=0,JM=0,YM=0,QM=0,XM=0,ZM=0,eO=0,tO=0,iO=0,nO=0,rO=0;var sO=0,aO=0,oO=0,lO=0,dO=0,cO=0,hO=0,uO=0,pO=0,gO=0,mO=0,fO=0,SO=0,vO=0,yO=0,CO=0,TO=0,EO=0,_O=0,bO=0;var PO=0,IO=0,AO=0,RO=0,wO=0,MO=0,OO=0,DO=0,kO=0,NO=0,LO=0,xO=0,FO=0,UO=0,VO=0,HO=0,BO=0,$O=0,jO=0,GO=0;var WO=0,qO=0,zO=0,KO=0,JO=0,YO=0,QO=0,XO=0,ZO=0,eD=0,tD=0,iD=0,nD=0,rD=0,sD=0,aD=0,oD=0,lD=0,dD=0,cD=0;var hD=0,uD=0,pD=0,gD=0,mD=0,fD=0,SD=0,vD=0,yD=0,CD=0,TD=0,ED=0,_D=0,bD=0,PD=0,ID=0,AD=0,RD=0,wD=0,MD=0;var OD=0,DD=0,kD=0,ND=0,LD=0,xD=0,FD=0,UD=0,VD=0,HD=0,BD=0,$D=0,jD=0,GD=0,WD=0,qD=0,zD=0,KD=0,JD=0,YD=0;var QD=0,XD=0,ZD=0,ek=0,tk=0,ik=0,nk=0,rk=0,sk=0,ak=0,ok=0,lk=0,dk=0,ck=0,hk=0,uk=0,pk=0,gk=0,mk=0,fk=0;var Sk=0,vk=0,yk=0,Ck=0,Tk=0,Ek=0,_k=0,bk=0,Pk=0,Ik=0,Ak=0,Rk=0,wk=0,Mk=0,Ok=0,Dk=0,kk=0,Nk=0,Lk=0,xk=0;var Fk=0,Uk=0,Vk=0,Hk=0,Bk=0,$k=0,jk=0,Gk=0,Wk=0,qk=0,zk=0,Kk=0,Jk=0,Yk=0,Qk=0,Xk=0,Zk=0,eN=0,tN=0,iN=0;var nN=0,rN=0,sN=0,aN=0,oN=0,lN=0,dN=0,cN=0,hN=0,uN=0,pN=0,gN=0,mN=0,fN=0,SN=0,vN=0,yN=0,CN=0,TN=0,EN=0;var _N=0,bN=0,PN=0,IN=0,AN=0,RN=0,wN=0,MN=0,ON=0,DN=0,kN=0,NN=0,LN=0,xN=0,FN=0,UN=0,VN=0,HN=0,BN=0,$N=0;var jN=0,GN=0,WN=0,qN=0,zN=0,KN=0,JN=0,YN=0,QN=0,XN=0,ZN=0,eL=0,tL=0,iL=0,nL=0,rL=0,sL=0,aL=0,oL=0,lL=0;var dL=0,cL=0,hL=0,uL=0,pL=0,gL=0,mL=0,fL=0,SL=0,vL=0,yL=0,CL=0,TL=0,EL=0,_L=0,bL=0,PL=0,IL=0,AL=0,RL=0;var wL=0,ML=0,OL=0,DL=0,kL=0,NL=0,LL=0,xL=0,FL=0,UL=0,VL=0,HL=0,BL=0,$L=0,jL=0,GL=0,WL=0,qL=0,zL=0,KL=0;var JL=0,YL=0,QL=0,XL=0,ZL=0,ex=0,tx=0,ix=0,nx=0,rx=0,sx=0,ax=0,ox=0,lx=0,dx=0,cx=0,hx=0,ux=0,px=0,gx=0;var mx=0,fx=0,Sx=0,vx=0,yx=0,Cx=0,Tx=0,Ex=0,_x=0,bx=0,Px=0,Ix=0,Ax=0,Rx=0,wx=0,Mx=0,Ox=0,Dx=0,kx=0,Nx=0;var Lx=0,xx=0,Fx=0,Ux=0,Vx=0,Hx=0,Bx=0,$x=0,jx=0,Gx=0,Wx=0,qx=0,zx=0,Kx=0,Jx=0,Yx=0,Qx=0,Xx=0,Zx=0,eF=0;var tF=0,iF=0,nF=0,rF=0,sF=0,aF=0,oF=0,lF=0,dF=0,cF=0,hF=0,uF=0,pF=0,gF=0,mF=0,fF=0,SF=0,vF=0,yF=0,CF=0;var TF=0,EF=0,_F=0,bF=0,PF=0,IF=0,AF=0,RF=0,wF=0,MF=0,OF=0,DF=0,kF=0,NF=0,LF=0,xF=0,FF=0,UF=0,VF=0,HF=0;var BF=0,$F=0,jF=0,GF=0,WF=0,qF=0,zF=0,KF=0,JF=0,YF=0;YF=h;n=t;r=n;Wy=s[r>>2]|0;R_=n+4|0;OP=R_;NA=s[OP>>2]|0;Fw=ii(0,Wy|0,32)|0;HO=D;jk=i;qL=jk;a=s[qL>>2]|0;ht=jk+4|0;yn=ht;Es=s[yn>>2]|0;Io=ii(0,a|0,32)|0;wd=D;Dh=fi(Io|0,wd|0,Fw|0,HO|0)|0;Lp=D;Um=e;$S=Um;s[$S>>2]=Dh;qy=Um+4|0;FT=qy;s[FT>>2]=Lp;KT=t;sE=KT;fE=s[sE>>2]|0;AE=KT+4|0;UE=AE;JE=s[UE>>2]|0;a_=ii(0,fE|0,32)|0;S_=D;w_=i+8|0;H_=w_;Q_=H_;lb=s[Q_>>2]|0;yb=H_+4|0;Mb=yb;Bb=s[Mb>>2]|0;Xb=ii(0,lb|0,32)|0;dP=D;CP=fi(Xb|0,dP|0,a_|0,S_|0)|0;DP=D;jP=t+8|0;eI=jP;hI=eI;EI=s[hI>>2]|0;kI=eI+4|0;GI=kI;tA=s[GI>>2]|0;uA=ii(0,EI|0,32)|0;_A=D;LA=i;qA=LA;nR=s[qA>>2]|0;gR=LA+4|0;PR=gR;xR=s[PR>>2]|0;zR=ii(0,nR|0,32)|0;rw=D;mw=fi(zR|0,rw|0,uA|0,_A|0)|0;Iw=D;Uw=ri(mw|0,Iw|0,CP|0,DP|0)|0;Jw=D;aM=e+8|0;SM=aM;RM=SM;s[RM>>2]=Uw;VM=SM+4|0;YM=VM;s[YM>>2]=Jw;oO=jP;vO=oO;wO=s[vO>>2]|0;BO=oO+4|0;XO=BO;dD=s[XO>>2]|0;CD=ii(0,wO|0,31)|0;OD=D;$D=w_;ZD=$D;ck=s[ZD>>2]|0;Tk=$D+4|0;Dk=Tk;Gk=s[Dk>>2]|0;tN=ii(0,ck|0,32)|0;uN=D;_N=fi(tN|0,uN|0,CD|0,OD|0)|0;NN=D;WN=t;iL=WN;pL=s[iL>>2]|0;bL=WN+4|0;LL=bL;zL=s[LL>>2]|0;rx=ii(0,pL|0,32)|0;mx=D;Ix=i+16|0;Fx=Ix;Kx=Fx;sF=s[Kx>>2]|0;fF=Fx+4|0;AF=fF;UF=s[AF>>2]|0;o=ii(0,sF|0,32)|0;y=D;M=fi(o|0,y|0,rx|0,mx|0)|0;$=D;Z=ri(M|0,$|0,_N|0,NN|0)|0;ce=D;Te=t+16|0;De=Te;je=De;et=s[je>>2]|0;ut=De+4|0;_t=ut;Nt=s[_t>>2]|0;Wt=ii(0,et|0,32)|0;ni=D;Si=i;Ri=Si;Vi=s[Ri>>2]|0;Yi=Si+4|0;ln=Yi;Cn=s[ln>>2]|0;On=ii(0,Vi|0,32)|0;$n=D;Zn=fi(On|0,$n|0,Wt|0,ni|0)|0;cr=D;Tr=ri(Z|0,ce|0,Zn|0,cr|0)|0;Dr=D;jr=e+16|0;es=jr;hs=es;s[hs>>2]=Tr;_s=es+4|0;Ns=_s;s[Ns>>2]=Dr;Ws=jP;ia=Ws;pa=s[ia>>2]|0;ba=Ws+4|0;La=ba;qa=s[La>>2]|0;no=ii(0,pa|0,32)|0;mo=D;Ao=Ix;Uo=Ao;Jo=s[Uo>>2]|0;al=Ao+4|0;Sl=al;Rl=s[Sl>>2]|0;Vl=ii(0,Jo|0,32)|0;Yl=D;od=fi(Vl|0,Yl|0,no|0,mo|0)|0;vd=D;Md=Te;Bd=Md;Xd=s[Bd>>2]|0;dc=Md+4|0;Cc=dc;Oc=s[Cc>>2]|0;$c=ii(0,Xd|0,32)|0;Zc=D;ch=w_;Th=ch;kh=s[Th>>2]|0;Gh=ch+4|0;tu=Gh;uu=s[tu>>2]|0;_u=ii(0,kh|0,32)|0;Nu=D;Wu=fi(_u|0,Nu|0,$c|0,Zc|0)|0;ip=D;pp=ri(Wu|0,ip|0,od|0,vd|0)|0;bp=D;xp=t;zp=xp;rg=s[zp>>2]|0;mg=xp+4|0;Ig=mg;Fg=s[Ig>>2]|0;Kg=ii(0,rg|0,32)|0;sm=D;fm=i+24|0;Am=fm;Vm=Am;Ym=s[Vm>>2]|0;lf=Am+4|0;yf=lf;Mf=s[yf>>2]|0;Bf=ii(0,Ym|0,32)|0;Xf=D;dS=fi(Bf|0,Xf|0,Kg|0,sm|0)|0;CS=D;OS=ri(pp|0,bp|0,dS|0,CS|0)|0;jS=D;ev=t+24|0;hv=ev;Ev=hv;kv=s[Ev>>2]|0;Gv=hv+4|0;ty=Gv;uy=s[ty>>2]|0;_y=ii(0,kv|0,32)|0;Ny=D;zy=i;rC=zy;mC=s[rC>>2]|0;IC=zy+4|0;FC=IC;KC=s[FC>>2]|0;sT=ii(0,mC|0,32)|0;fT=D;AT=fi(sT|0,fT|0,_y|0,Ny|0)|0;xT=D;UT=ri(OS|0,jS|0,AT|0,xT|0)|0;VT=D;HT=e+24|0;BT=HT;$T=BT;s[$T>>2]=UT;jT=BT+4|0;GT=jT;s[GT>>2]=VT;WT=Te;qT=WT;zT=s[qT>>2]|0;JT=WT+4|0;YT=JT;QT=s[YT>>2]|0;XT=ii(0,zT|0,32)|0;ZT=D;eE=Ix;tE=eE;iE=s[tE>>2]|0;nE=eE+4|0;rE=nE;aE=s[rE>>2]|0;oE=ii(0,iE|0,32)|0;lE=D;dE=fi(oE|0,lE|0,XT|0,ZT|0)|0;cE=D;hE=jP;uE=hE;pE=s[uE>>2]|0;gE=hE+4|0;mE=gE;SE=s[mE>>2]|0;vE=ii(0,pE|0,32)|0;yE=D;CE=fm;TE=CE;EE=s[TE>>2]|0;_E=CE+4|0;bE=_E;PE=s[bE>>2]|0;IE=ii(0,EE|0,32)|0;RE=D;wE=fi(IE|0,RE|0,vE|0,yE|0)|0;ME=D;OE=ev;DE=OE;kE=s[DE>>2]|0;NE=OE+4|0;LE=NE;xE=s[LE>>2]|0;FE=ii(0,kE|0,32)|0;VE=D;HE=w_;BE=HE;$E=s[BE>>2]|0;jE=HE+4|0;GE=jE;WE=s[GE>>2]|0;qE=ii(0,$E|0,32)|0;zE=D;KE=fi(qE|0,zE|0,FE|0,VE|0)|0;YE=D;QE=ri(KE|0,YE|0,wE|0,ME|0)|0;XE=D;ZE=oi(QE|0,XE|0,1)|0;e_=D;t_=ri(ZE|0,e_|0,dE|0,cE|0)|0;i_=D;n_=t;r_=n_;s_=s[r_>>2]|0;o_=n_+4|0;l_=o_;d_=s[l_>>2]|0;c_=ii(0,s_|0,32)|0;h_=D;u_=i+32|0;p_=u_;g_=p_;m_=s[g_>>2]|0;f_=p_+4|0;v_=f_;y_=s[v_>>2]|0;C_=ii(0,m_|0,32)|0;T_=D;E_=fi(C_|0,T_|0,c_|0,h_|0)|0;__=D;b_=ri(t_|0,i_|0,E_|0,__|0)|0;P_=D;I_=t+32|0;A_=I_;M_=A_;O_=s[M_>>2]|0;D_=A_+4|0;k_=D_;N_=s[k_>>2]|0;L_=ii(0,O_|0,32)|0;x_=D;F_=i;U_=F_;V_=s[U_>>2]|0;B_=F_+4|0;$_=B_;j_=s[$_>>2]|0;G_=ii(0,V_|0,32)|0;W_=D;q_=fi(G_|0,W_|0,L_|0,x_|0)|0;z_=D;K_=ri(b_|0,P_|0,q_|0,z_|0)|0;J_=D;Y_=e+32|0;X_=Y_;Z_=X_;s[Z_>>2]=K_;eb=X_+4|0;tb=eb;s[tb>>2]=J_;ib=Te;nb=ib;rb=s[nb>>2]|0;sb=ib+4|0;ab=sb;ob=s[ab>>2]|0;db=ii(0,rb|0,32)|0;cb=D;hb=fm;ub=hb;pb=s[ub>>2]|0;gb=hb+4|0;mb=gb;fb=s[mb>>2]|0;Sb=ii(0,pb|0,32)|0;vb=D;Cb=fi(Sb|0,vb|0,db|0,cb|0)|0;Tb=D;Eb=ev;_b=Eb;bb=s[_b>>2]|0;Pb=Eb+4|0;Ib=Pb;Ab=s[Ib>>2]|0;Rb=ii(0,bb|0,32)|0;wb=D;Ob=Ix;Db=Ob;kb=s[Db>>2]|0;Nb=Ob+4|0;Lb=Nb;xb=s[Lb>>2]|0;Fb=ii(0,kb|0,32)|0;Ub=D;Vb=fi(Fb|0,Ub|0,Rb|0,wb|0)|0;Hb=D;$b=ri(Vb|0,Hb|0,Cb|0,Tb|0)|0;jb=D;Gb=jP;Wb=Gb;qb=s[Wb>>2]|0;zb=Gb+4|0;Kb=zb;Jb=s[Kb>>2]|0;Yb=ii(0,qb|0,32)|0;Qb=D;Zb=u_;eP=Zb;tP=s[eP>>2]|0;iP=Zb+4|0;nP=iP;rP=s[nP>>2]|0;sP=ii(0,tP|0,32)|0;aP=D;oP=fi(sP|0,aP|0,Yb|0,Qb|0)|0;lP=D;cP=ri($b|0,jb|0,oP|0,lP|0)|0;hP=D;uP=I_;pP=uP;gP=s[pP>>2]|0;mP=uP+4|0;fP=mP;SP=s[fP>>2]|0;vP=ii(0,gP|0,32)|0;yP=D;TP=w_;EP=TP;_P=s[EP>>2]|0;bP=TP+4|0;PP=bP;IP=s[PP>>2]|0;AP=ii(0,_P|0,32)|0;RP=D;wP=fi(AP|0,RP|0,vP|0,yP|0)|0;MP=D;kP=ri(cP|0,hP|0,wP|0,MP|0)|0;NP=D;LP=t;xP=LP;FP=s[xP>>2]|0;UP=LP+4|0;VP=UP;HP=s[VP>>2]|0;BP=ii(0,FP|0,32)|0;$P=D;GP=i+40|0;WP=GP;qP=WP;zP=s[qP>>2]|0;KP=WP+4|0;JP=KP;YP=s[JP>>2]|0;QP=ii(0,zP|0,32)|0;XP=D;ZP=fi(QP|0,XP|0,BP|0,$P|0)|0;tI=D;iI=ri(kP|0,NP|0,ZP|0,tI|0)|0;nI=D;rI=t+40|0;sI=rI;aI=sI;oI=s[aI>>2]|0;lI=sI+4|0;dI=lI;cI=s[dI>>2]|0;uI=ii(0,oI|0,32)|0;pI=D;gI=i;mI=gI;fI=s[mI>>2]|0;SI=gI+4|0;vI=SI;yI=s[vI>>2]|0;CI=ii(0,fI|0,32)|0;TI=D;_I=fi(CI|0,TI|0,uI|0,pI|0)|0;bI=D;PI=ri(iI|0,nI|0,_I|0,bI|0)|0;II=D;AI=e+40|0;RI=AI;wI=RI;s[wI>>2]=PI;MI=RI+4|0;OI=MI;s[OI>>2]=II;DI=ev;NI=DI;LI=s[NI>>2]|0;xI=DI+4|0;FI=xI;UI=s[FI>>2]|0;VI=ii(0,LI|0,32)|0;HI=D;BI=fm;$I=BI;jI=s[$I>>2]|0;WI=BI+4|0;qI=WI;zI=s[qI>>2]|0;KI=ii(0,jI|0,32)|0;JI=D;YI=fi(KI|0,JI|0,VI|0,HI|0)|0;QI=D;XI=jP;ZI=XI;eA=s[ZI>>2]|0;iA=XI+4|0;nA=iA;rA=s[nA>>2]|0;sA=ii(0,eA|0,32)|0;aA=D;oA=GP;lA=oA;dA=s[lA>>2]|0;cA=oA+4|0;hA=cA;pA=s[hA>>2]|0;gA=ii(0,dA|0,32)|0;mA=D;fA=fi(gA|0,mA|0,sA|0,aA|0)|0;SA=D;vA=ri(fA|0,SA|0,YI|0,QI|0)|0;yA=D;CA=rI;TA=CA;EA=s[TA>>2]|0;bA=CA+4|0;PA=bA;IA=s[PA>>2]|0;AA=ii(0,EA|0,32)|0;RA=D;wA=w_;MA=wA;OA=s[MA>>2]|0;DA=wA+4|0;kA=DA;xA=s[kA>>2]|0;FA=ii(0,OA|0,32)|0;UA=D;VA=fi(FA|0,UA|0,AA|0,RA|0)|0;HA=D;BA=ri(vA|0,yA|0,VA|0,HA|0)|0;$A=D;jA=oi(BA|0,$A|0,1)|0;GA=D;WA=Te;zA=WA;KA=s[zA>>2]|0;JA=WA+4|0;YA=JA;QA=s[YA>>2]|0;XA=ii(0,KA|0,32)|0;ZA=D;eR=u_;tR=eR;iR=s[tR>>2]|0;rR=eR+4|0;sR=rR;aR=s[sR>>2]|0;oR=ii(0,iR|0,32)|0;lR=D;dR=fi(oR|0,lR|0,XA|0,ZA|0)|0;cR=D;hR=ri(jA|0,GA|0,dR|0,cR|0)|0;uR=D;pR=I_;mR=pR;fR=s[mR>>2]|0;SR=pR+4|0;vR=SR;yR=s[vR>>2]|0;CR=ii(0,fR|0,32)|0;TR=D;ER=Ix;_R=ER;bR=s[_R>>2]|0;IR=ER+4|0;AR=IR;RR=s[AR>>2]|0;wR=ii(0,bR|0,32)|0;MR=D;OR=fi(wR|0,MR|0,CR|0,TR|0)|0;DR=D;kR=ri(hR|0,uR|0,OR|0,DR|0)|0;NR=D;LR=t;FR=LR;UR=s[FR>>2]|0;VR=LR+4|0;HR=VR;BR=s[HR>>2]|0;$R=ii(0,UR|0,32)|0;jR=D;GR=i+48|0;WR=GR;qR=WR;KR=s[qR>>2]|0;JR=WR+4|0;YR=JR;QR=s[YR>>2]|0;XR=ii(0,KR|0,32)|0;ZR=D;ew=fi(XR|0,ZR|0,$R|0,jR|0)|0;tw=D;iw=ri(kR|0,NR|0,ew|0,tw|0)|0;nw=D;sw=t+48|0;aw=sw;ow=aw;lw=s[ow>>2]|0;dw=aw+4|0;cw=dw;hw=s[cw>>2]|0;uw=ii(0,lw|0,32)|0;pw=D;gw=i;fw=gw;Sw=s[fw>>2]|0;vw=gw+4|0;yw=vw;Cw=s[yw>>2]|0;Tw=ii(0,Sw|0,32)|0;Ew=D;_w=fi(Tw|0,Ew|0,uw|0,pw|0)|0;bw=D;Pw=ri(iw|0,nw|0,_w|0,bw|0)|0;Aw=D;Rw=e+48|0;ww=Rw;Mw=ww;s[Mw>>2]=Pw;Ow=ww+4|0;Dw=Ow;s[Dw>>2]=Aw;kw=ev;Nw=kw;Lw=s[Nw>>2]|0;xw=kw+4|0;Vw=xw;Hw=s[Vw>>2]|0;Bw=ii(0,Lw|0,32)|0;$w=D;jw=u_;Gw=jw;Ww=s[Gw>>2]|0;qw=jw+4|0;zw=qw;Kw=s[zw>>2]|0;Yw=ii(0,Ww|0,32)|0;Qw=D;Xw=fi(Yw|0,Qw|0,Bw|0,$w|0)|0;Zw=D;eM=I_;tM=eM;iM=s[tM>>2]|0;nM=eM+4|0;rM=nM;sM=s[rM>>2]|0;oM=ii(0,iM|0,32)|0;lM=D;dM=fm;cM=dM;hM=s[cM>>2]|0;uM=dM+4|0;pM=uM;gM=s[pM>>2]|0;mM=ii(0,hM|0,32)|0;fM=D;vM=fi(mM|0,fM|0,oM|0,lM|0)|0;yM=D;CM=ri(vM|0,yM|0,Xw|0,Zw|0)|0;TM=D;EM=Te;_M=EM;bM=s[_M>>2]|0;PM=EM+4|0;IM=PM;AM=s[IM>>2]|0;wM=ii(0,bM|0,32)|0;MM=D;OM=GP;DM=OM;kM=s[DM>>2]|0;NM=OM+4|0;LM=NM;xM=s[LM>>2]|0;FM=ii(0,kM|0,32)|0;UM=D;HM=fi(FM|0,UM|0,wM|0,MM|0)|0;BM=D;$M=ri(CM|0,TM|0,HM|0,BM|0)|0;jM=D;GM=rI;WM=GM;qM=s[WM>>2]|0;zM=GM+4|0;KM=zM;JM=s[KM>>2]|0;QM=ii(0,qM|0,32)|0;XM=D;ZM=Ix;eO=ZM;tO=s[eO>>2]|0;iO=ZM+4|0;nO=iO;rO=s[nO>>2]|0;sO=ii(0,tO|0,32)|0;aO=D;lO=fi(sO|0,aO|0,QM|0,XM|0)|0;dO=D;cO=ri($M|0,jM|0,lO|0,dO|0)|0;hO=D;uO=jP;pO=uO;gO=s[pO>>2]|0;mO=uO+4|0;fO=mO;SO=s[fO>>2]|0;yO=ii(0,gO|0,32)|0;CO=D;TO=GR;EO=TO;_O=s[EO>>2]|0;bO=TO+4|0;PO=bO;IO=s[PO>>2]|0;AO=ii(0,_O|0,32)|0;RO=D;MO=fi(AO|0,RO|0,yO|0,CO|0)|0;OO=D;DO=ri(cO|0,hO|0,MO|0,OO|0)|0;kO=D;NO=sw;LO=NO;xO=s[LO>>2]|0;FO=NO+4|0;UO=FO;VO=s[UO>>2]|0;$O=ii(0,xO|0,32)|0;jO=D;GO=w_;WO=GO;qO=s[WO>>2]|0;zO=GO+4|0;KO=zO;JO=s[KO>>2]|0;YO=ii(0,qO|0,32)|0;QO=D;ZO=fi(YO|0,QO|0,$O|0,jO|0)|0;eD=D;tD=ri(DO|0,kO|0,ZO|0,eD|0)|0;iD=D;nD=t;rD=nD;sD=s[rD>>2]|0;aD=nD+4|0;oD=aD;lD=s[oD>>2]|0;cD=ii(0,sD|0,32)|0;hD=D;uD=i+56|0;pD=uD;gD=pD;mD=s[gD>>2]|0;fD=pD+4|0;SD=fD;vD=s[SD>>2]|0;yD=ii(0,mD|0,32)|0;TD=D;ED=fi(yD|0,TD|0,cD|0,hD|0)|0;_D=D;bD=ri(tD|0,iD|0,ED|0,_D|0)|0;PD=D;ID=t+56|0;AD=ID;RD=AD;wD=s[RD>>2]|0;MD=AD+4|0;DD=MD;kD=s[DD>>2]|0;ND=ii(0,wD|0,32)|0;LD=D;xD=i;FD=xD;UD=s[FD>>2]|0;VD=xD+4|0;HD=VD;BD=s[HD>>2]|0;jD=ii(0,UD|0,32)|0;GD=D;WD=fi(jD|0,GD|0,ND|0,LD|0)|0;qD=D;zD=ri(bD|0,PD|0,WD|0,qD|0)|0;KD=D;JD=e+56|0;YD=JD;QD=YD;s[QD>>2]=zD;XD=YD+4|0;ek=XD;s[ek>>2]=KD;tk=I_;ik=tk;nk=s[ik>>2]|0;rk=tk+4|0;sk=rk;ak=s[sk>>2]|0;ok=ii(0,nk|0,32)|0;lk=D;dk=u_;hk=dk;uk=s[hk>>2]|0;pk=dk+4|0;gk=pk;mk=s[gk>>2]|0;fk=ii(0,uk|0,32)|0;Sk=D;vk=fi(fk|0,Sk|0,ok|0,lk|0)|0;yk=D;Ck=ev;Ek=Ck;_k=s[Ek>>2]|0;bk=Ck+4|0;Pk=bk;Ik=s[Pk>>2]|0;Ak=ii(0,_k|0,32)|0;Rk=D;wk=GP;Mk=wk;Ok=s[Mk>>2]|0;kk=wk+4|0;Nk=kk;Lk=s[Nk>>2]|0;xk=ii(0,Ok|0,32)|0;Fk=D;Uk=fi(xk|0,Fk|0,Ak|0,Rk|0)|0;Vk=D;Hk=rI;Bk=Hk;$k=s[Bk>>2]|0;Wk=Hk+4|0;qk=Wk;zk=s[qk>>2]|0;Kk=ii(0,$k|0,32)|0;Jk=D;Yk=fm;Qk=Yk;Xk=s[Qk>>2]|0;Zk=Yk+4|0;eN=Zk;iN=s[eN>>2]|0;nN=ii(0,Xk|0,32)|0;rN=D;sN=fi(nN|0,rN|0,Kk|0,Jk|0)|0;aN=D;oN=ri(sN|0,aN|0,Uk|0,Vk|0)|0;lN=D;dN=jP;cN=dN;hN=s[cN>>2]|0;pN=dN+4|0;gN=pN;mN=s[gN>>2]|0;fN=ii(0,hN|0,32)|0;SN=D;vN=uD;yN=vN;CN=s[yN>>2]|0;TN=vN+4|0;EN=TN;bN=s[EN>>2]|0;PN=ii(0,CN|0,32)|0;IN=D;AN=fi(PN|0,IN|0,fN|0,SN|0)|0;RN=D;wN=ri(oN|0,lN|0,AN|0,RN|0)|0;MN=D;ON=ID;DN=ON;kN=s[DN>>2]|0;LN=ON+4|0;xN=LN;FN=s[xN>>2]|0;UN=ii(0,kN|0,32)|0;VN=D;HN=w_;BN=HN;$N=s[BN>>2]|0;jN=HN+4|0;GN=jN;qN=s[GN>>2]|0;zN=ii(0,$N|0,32)|0;KN=D;JN=fi(zN|0,KN|0,UN|0,VN|0)|0;YN=D;QN=ri(wN|0,MN|0,JN|0,YN|0)|0;XN=D;ZN=oi(QN|0,XN|0,1)|0;eL=D;tL=ri(ZN|0,eL|0,vk|0,yk|0)|0;nL=D;rL=Te;sL=rL;aL=s[sL>>2]|0;oL=rL+4|0;lL=oL;dL=s[lL>>2]|0;cL=ii(0,aL|0,32)|0;hL=D;uL=GR;gL=uL;mL=s[gL>>2]|0;fL=uL+4|0;SL=fL;vL=s[SL>>2]|0;yL=ii(0,mL|0,32)|0;CL=D;TL=fi(yL|0,CL|0,cL|0,hL|0)|0;EL=D;_L=ri(tL|0,nL|0,TL|0,EL|0)|0;PL=D;IL=sw;AL=IL;RL=s[AL>>2]|0;wL=IL+4|0;ML=wL;OL=s[ML>>2]|0;DL=ii(0,RL|0,32)|0;kL=D;NL=Ix;xL=NL;FL=s[xL>>2]|0;UL=NL+4|0;VL=UL;HL=s[VL>>2]|0;BL=ii(0,FL|0,32)|0;$L=D;jL=fi(BL|0,$L|0,DL|0,kL|0)|0;GL=D;WL=ri(_L|0,PL|0,jL|0,GL|0)|0;KL=D;JL=t;YL=JL;QL=s[YL>>2]|0;XL=JL+4|0;ZL=XL;ex=s[ZL>>2]|0;tx=ii(0,QL|0,32)|0;ix=D;nx=i+64|0;sx=nx;ax=sx;ox=s[ax>>2]|0;lx=sx+4|0;dx=lx;cx=s[dx>>2]|0;hx=ii(0,ox|0,32)|0;ux=D;px=fi(hx|0,ux|0,tx|0,ix|0)|0;gx=D;fx=ri(WL|0,KL|0,px|0,gx|0)|0;Sx=D;vx=t+64|0;yx=vx;Cx=yx;Tx=s[Cx>>2]|0;Ex=yx+4|0;_x=Ex;bx=s[_x>>2]|0;Px=ii(0,Tx|0,32)|0;Ax=D;Rx=i;wx=Rx;Mx=s[wx>>2]|0;Ox=Rx+4|0;Dx=Ox;kx=s[Dx>>2]|0;Nx=ii(0,Mx|0,32)|0;Lx=D;xx=fi(Nx|0,Lx|0,Px|0,Ax|0)|0;Ux=D;Vx=ri(fx|0,Sx|0,xx|0,Ux|0)|0;Hx=D;Bx=e+64|0;$x=Bx;jx=$x;s[jx>>2]=Vx;Gx=$x+4|0;Wx=Gx;s[Wx>>2]=Hx;qx=I_;zx=qx;Jx=s[zx>>2]|0;Yx=qx+4|0;Qx=Yx;Xx=s[Qx>>2]|0;Zx=ii(0,Jx|0,32)|0;eF=D;tF=GP;iF=tF;nF=s[iF>>2]|0;rF=tF+4|0;aF=rF;oF=s[aF>>2]|0;lF=ii(0,nF|0,32)|0;dF=D;cF=fi(lF|0,dF|0,Zx|0,eF|0)|0;hF=D;uF=rI;pF=uF;gF=s[pF>>2]|0;mF=uF+4|0;SF=mF;vF=s[SF>>2]|0;yF=ii(0,gF|0,32)|0;CF=D;TF=u_;EF=TF;_F=s[EF>>2]|0;bF=TF+4|0;PF=bF;IF=s[PF>>2]|0;RF=ii(0,_F|0,32)|0;wF=D;MF=fi(RF|0,wF|0,yF|0,CF|0)|0;OF=D;DF=ri(MF|0,OF|0,cF|0,hF|0)|0;kF=D;NF=ev;LF=NF;xF=s[LF>>2]|0;FF=NF+4|0;VF=FF;HF=s[VF>>2]|0;BF=ii(0,xF|0,32)|0;$F=D;jF=GR;GF=jF;WF=s[GF>>2]|0;qF=jF+4|0;zF=qF;KF=s[zF>>2]|0;l=ii(0,WF|0,32)|0;d=D;c=fi(l|0,d|0,BF|0,$F|0)|0;u=D;p=ri(DF|0,kF|0,c|0,u|0)|0;g=D;m=sw;f=m;S=s[f>>2]|0;v=m+4|0;C=v;T=s[C>>2]|0;E=ii(0,S|0,32)|0;_=D;b=fm;P=b;I=s[P>>2]|0;A=b+4|0;R=A;w=s[R>>2]|0;O=ii(0,I|0,32)|0;k=D;N=fi(O|0,k|0,E|0,_|0)|0;L=D;x=ri(p|0,g|0,N|0,L|0)|0;F=D;U=Te;V=U;H=s[V>>2]|0;B=U+4|0;j=B;G=s[j>>2]|0;W=ii(0,H|0,32)|0;q=D;z=uD;K=z;J=s[K>>2]|0;Y=z+4|0;Q=Y;X=s[Q>>2]|0;ee=ii(0,J|0,32)|0;te=D;ie=fi(ee|0,te|0,W|0,q|0)|0;ne=D;re=ri(x|0,F|0,ie|0,ne|0)|0;se=D;ae=ID;oe=ae;le=s[oe>>2]|0;de=ae+4|0;he=de;ue=s[he>>2]|0;pe=ii(0,le|0,32)|0;ge=D;me=Ix;fe=me;Se=s[fe>>2]|0;ve=me+4|0;ye=ve;Ce=s[ye>>2]|0;Ee=ii(0,Se|0,32)|0;_e=D;be=fi(Ee|0,_e|0,pe|0,ge|0)|0;Pe=D;Ie=ri(re|0,se|0,be|0,Pe|0)|0;Ae=D;Re=jP;we=Re;Me=s[we>>2]|0;Oe=Re+4|0;ke=Oe;Ne=s[ke>>2]|0;Le=ii(0,Me|0,32)|0;xe=D;Fe=nx;Ue=Fe;Ve=s[Ue>>2]|0;He=Fe+4|0;Be=He;$e=s[Be>>2]|0;Ge=ii(0,Ve|0,32)|0;We=D;qe=fi(Ge|0,We|0,Le|0,xe|0)|0;ze=D;Ke=ri(Ie|0,Ae|0,qe|0,ze|0)|0;Je=D;Ye=vx;Qe=Ye;Xe=s[Qe>>2]|0;Ze=Ye+4|0;tt=Ze;it=s[tt>>2]|0;nt=ii(0,Xe|0,32)|0;rt=D;st=w_;at=st;ot=s[at>>2]|0;lt=st+4|0;dt=lt;ct=s[dt>>2]|0;pt=ii(0,ot|0,32)|0;gt=D;mt=fi(pt|0,gt|0,nt|0,rt|0)|0;ft=D;St=ri(Ke|0,Je|0,mt|0,ft|0)|0;vt=D;yt=t;Ct=yt;Tt=s[Ct>>2]|0;Et=yt+4|0;bt=Et;Pt=s[bt>>2]|0;It=ii(0,Tt|0,32)|0;At=D;Rt=i+72|0;wt=Rt;Mt=wt;Ot=s[Mt>>2]|0;Dt=wt+4|0;kt=Dt;Lt=s[kt>>2]|0;xt=ii(0,Ot|0,32)|0;Ft=D;Ut=fi(xt|0,Ft|0,It|0,At|0)|0;Vt=D;Ht=ri(St|0,vt|0,Ut|0,Vt|0)|0;Bt=D;$t=t+72|0;jt=$t;Gt=jt;qt=s[Gt>>2]|0;zt=jt+4|0;Kt=zt;Jt=s[Kt>>2]|0;Yt=ii(0,qt|0,32)|0;Qt=D;Xt=i;Zt=Xt;ei=s[Zt>>2]|0;ti=Xt+4|0;si=ti;ai=s[si>>2]|0;li=ii(0,ei|0,32)|0;di=D;ci=fi(li|0,di|0,Yt|0,Qt|0)|0;hi=D;ui=ri(Ht|0,Bt|0,ci|0,hi|0)|0;pi=D;gi=e+72|0;mi=gi;vi=mi;s[vi>>2]=ui;yi=mi+4|0;Ci=yi;s[Ci>>2]=pi;Ti=rI;Ei=Ti;_i=s[Ei>>2]|0;bi=Ti+4|0;Pi=bi;Ii=s[Pi>>2]|0;Ai=ii(0,_i|0,32)|0;wi=D;Mi=GP;Oi=Mi;Di=s[Oi>>2]|0;ki=Mi+4|0;Ni=ki;Li=s[Ni>>2]|0;xi=ii(0,Di|0,32)|0;Fi=D;Ui=fi(xi|0,Fi|0,Ai|0,wi|0)|0;Hi=D;Bi=ev;$i=Bi;ji=s[$i>>2]|0;Gi=Bi+4|0;Wi=Gi;qi=s[Wi>>2]|0;zi=ii(0,ji|0,32)|0;Ki=D;Ji=uD;Qi=Ji;Xi=s[Qi>>2]|0;Zi=Ji+4|0;en=Zi;tn=s[en>>2]|0;nn=ii(0,Xi|0,32)|0;rn=D;sn=fi(nn|0,rn|0,zi|0,Ki|0)|0;an=D;on=ri(sn|0,an|0,Ui|0,Hi|0)|0;dn=D;cn=ID;hn=cn;un=s[hn>>2]|0;pn=cn+4|0;gn=pn;mn=s[gn>>2]|0;fn=ii(0,un|0,32)|0;Sn=D;vn=fm;Tn=vn;En=s[Tn>>2]|0;_n=vn+4|0;bn=_n;Pn=s[bn>>2]|0;In=ii(0,En|0,32)|0;An=D;Rn=fi(In|0,An|0,fn|0,Sn|0)|0;wn=D;Mn=ri(on|0,dn|0,Rn|0,wn|0)|0;Dn=D;kn=jP;Nn=kn;Ln=s[Nn>>2]|0;xn=kn+4|0;Fn=xn;Un=s[Fn>>2]|0;Vn=ii(0,Ln|0,32)|0;Hn=D;Bn=Rt;jn=Bn;Gn=s[jn>>2]|0;Wn=Bn+4|0;qn=Wn;zn=s[qn>>2]|0;Kn=ii(0,Gn|0,32)|0;Jn=D;Yn=fi(Kn|0,Jn|0,Vn|0,Hn|0)|0;Qn=D;Xn=ri(Mn|0,Dn|0,Yn|0,Qn|0)|0;er=D;tr=$t;ir=tr;nr=s[ir>>2]|0;rr=tr+4|0;sr=rr;ar=s[sr>>2]|0;or=ii(0,nr|0,32)|0;lr=D;dr=w_;hr=dr;ur=s[hr>>2]|0;pr=dr+4|0;gr=pr;mr=s[gr>>2]|0;fr=ii(0,ur|0,32)|0;Sr=D;vr=fi(fr|0,Sr|0,or|0,lr|0)|0;yr=D;Cr=ri(Xn|0,er|0,vr|0,yr|0)|0;Er=D;_r=oi(Cr|0,Er|0,1)|0;br=D;Pr=I_;Ir=Pr;Ar=s[Ir>>2]|0;Rr=Pr+4|0;wr=Rr;Mr=s[wr>>2]|0;Or=ii(0,Ar|0,32)|0;kr=D;Nr=GR;Lr=Nr;xr=s[Lr>>2]|0;Fr=Nr+4|0;Ur=Fr;Vr=s[Ur>>2]|0;Hr=ii(0,xr|0,32)|0;Br=D;$r=fi(Hr|0,Br|0,Or|0,kr|0)|0;Gr=D;Wr=ri(_r|0,br|0,$r|0,Gr|0)|0;qr=D;zr=sw;Kr=zr;Jr=s[Kr>>2]|0;Yr=zr+4|0;Qr=Yr;Xr=s[Qr>>2]|0;Zr=ii(0,Jr|0,32)|0;ts=D;is=u_;ns=is;rs=s[ns>>2]|0;ss=is+4|0;as=ss;os=s[as>>2]|0;ls=ii(0,rs|0,32)|0;ds=D;cs=fi(ls|0,ds|0,Zr|0,ts|0)|0;us=D;ps=ri(Wr|0,qr|0,cs|0,us|0)|0;gs=D;ms=Te;fs=ms;Ss=s[fs>>2]|0;vs=ms+4|0;ys=vs;Cs=s[ys>>2]|0;Ts=ii(0,Ss|0,32)|0;bs=D;Ps=nx;Is=Ps;As=s[Is>>2]|0;Rs=Ps+4|0;ws=Rs;Ms=s[ws>>2]|0;Os=ii(0,As|0,32)|0;Ds=D;ks=fi(Os|0,Ds|0,Ts|0,bs|0)|0;Ls=D;xs=ri(ps|0,gs|0,ks|0,Ls|0)|0;Fs=D;Us=vx;Vs=Us;Hs=s[Vs>>2]|0;Bs=Us+4|0;$s=Bs;js=s[$s>>2]|0;Gs=ii(0,Hs|0,32)|0;qs=D;zs=Ix;Ks=zs;Js=s[Ks>>2]|0;Ys=zs+4|0;Qs=Ys;Xs=s[Qs>>2]|0;Zs=ii(0,Js|0,32)|0;ea=D;ta=fi(Zs|0,ea|0,Gs|0,qs|0)|0;na=D;ra=ri(xs|0,Fs|0,ta|0,na|0)|0;sa=D;aa=e+80|0;oa=aa;la=oa;s[la>>2]=ra;da=oa+4|0;ca=da;s[ca>>2]=sa;ha=rI;ua=ha;ga=s[ua>>2]|0;ma=ha+4|0;fa=ma;Sa=s[fa>>2]|0;va=ii(0,ga|0,32)|0;ya=D;Ca=GR;Ta=Ca;Ea=s[Ta>>2]|0;_a=Ca+4|0;Pa=_a;Ia=s[Pa>>2]|0;Aa=ii(0,Ea|0,32)|0;Ra=D;wa=fi(Aa|0,Ra|0,va|0,ya|0)|0;Ma=D;Oa=sw;Da=Oa;ka=s[Da>>2]|0;Na=Oa+4|0;xa=Na;Fa=s[xa>>2]|0;Ua=ii(0,ka|0,32)|0;Va=D;Ha=GP;Ba=Ha;$a=s[Ba>>2]|0;ja=Ha+4|0;Ga=ja;Wa=s[Ga>>2]|0;za=ii(0,$a|0,32)|0;Ka=D;Ja=fi(za|0,Ka|0,Ua|0,Va|0)|0;Ya=D;Qa=ri(Ja|0,Ya|0,wa|0,Ma|0)|0;Xa=D;Za=I_;eo=Za;to=s[eo>>2]|0;io=Za+4|0;ro=io;so=s[ro>>2]|0;ao=ii(0,to|0,32)|0;oo=D;lo=uD;co=lo;ho=s[co>>2]|0;uo=lo+4|0;po=uo;go=s[po>>2]|0;fo=ii(0,ho|0,32)|0;So=D;vo=fi(fo|0,So|0,ao|0,oo|0)|0;yo=D;Co=ri(Qa|0,Xa|0,vo|0,yo|0)|0;To=D;Eo=ID;_o=Eo;bo=s[_o>>2]|0;Po=Eo+4|0;Ro=Po;wo=s[Ro>>2]|0;Mo=ii(0,bo|0,32)|0;Oo=D;Do=u_;ko=Do;No=s[ko>>2]|0;Lo=Do+4|0;xo=Lo;Fo=s[xo>>2]|0;Vo=ii(0,No|0,32)|0;Ho=D;Bo=fi(Vo|0,Ho|0,Mo|0,Oo|0)|0;$o=D;jo=ri(Co|0,To|0,Bo|0,$o|0)|0;Go=D;Wo=ev;qo=Wo;zo=s[qo>>2]|0;Ko=Wo+4|0;Yo=Ko;Qo=s[Yo>>2]|0;Xo=ii(0,zo|0,32)|0;Zo=D;el=nx;tl=el;il=s[tl>>2]|0;nl=el+4|0;rl=nl;sl=s[rl>>2]|0;ol=ii(0,il|0,32)|0;ll=D;dl=fi(ol|0,ll|0,Xo|0,Zo|0)|0;cl=D;hl=ri(jo|0,Go|0,dl|0,cl|0)|0;ul=D;pl=vx;gl=pl;ml=s[gl>>2]|0;fl=pl+4|0;vl=fl;yl=s[vl>>2]|0;Cl=ii(0,ml|0,32)|0;Tl=D;El=fm;_l=El;bl=s[_l>>2]|0;Pl=El+4|0;Il=Pl;Al=s[Il>>2]|0;wl=ii(0,bl|0,32)|0;Ml=D;Ol=fi(wl|0,Ml|0,Cl|0,Tl|0)|0;Dl=D;kl=ri(hl|0,ul|0,Ol|0,Dl|0)|0;Nl=D;Ll=Te;xl=Ll;Fl=s[xl>>2]|0;Ul=Ll+4|0;Hl=Ul;Bl=s[Hl>>2]|0;$l=ii(0,Fl|0,32)|0;jl=D;Gl=Rt;Wl=Gl;ql=s[Wl>>2]|0;zl=Gl+4|0;Kl=zl;Jl=s[Kl>>2]|0;Ql=ii(0,ql|0,32)|0;Xl=D;Zl=fi(Ql|0,Xl|0,$l|0,jl|0)|0;ed=D;td=ri(kl|0,Nl|0,Zl|0,ed|0)|0;id=D;nd=$t;rd=nd;sd=s[rd>>2]|0;ad=nd+4|0;ld=ad;dd=s[ld>>2]|0;cd=ii(0,sd|0,32)|0;hd=D;ud=Ix;pd=ud;gd=s[pd>>2]|0;md=ud+4|0;fd=md;Sd=s[fd>>2]|0;yd=ii(0,gd|0,32)|0;Cd=D;Td=fi(yd|0,Cd|0,cd|0,hd|0)|0;Ed=D;_d=ri(td|0,id|0,Td|0,Ed|0)|0;bd=D;Pd=e+88|0;Id=Pd;Ad=Id;s[Ad>>2]=_d;Rd=Id+4|0;Od=Rd;s[Od>>2]=bd;Dd=sw;kd=Dd;Nd=s[kd>>2]|0;Ld=Dd+4|0;xd=Ld;Fd=s[xd>>2]|0;Ud=ii(0,Nd|0,32)|0;Vd=D;Hd=GR;$d=Hd;jd=s[$d>>2]|0;Gd=Hd+4|0;Wd=Gd;qd=s[Wd>>2]|0;zd=ii(0,jd|0,32)|0;Kd=D;Jd=fi(zd|0,Kd|0,Ud|0,Vd|0)|0;Yd=D;Qd=rI;Zd=Qd;ec=s[Zd>>2]|0;tc=Qd+4|0;ic=tc;nc=s[ic>>2]|0;rc=ii(0,ec|0,32)|0;sc=D;ac=uD;oc=ac;lc=s[oc>>2]|0;cc=ac+4|0;hc=cc;uc=s[hc>>2]|0;pc=ii(0,lc|0,32)|0;gc=D;mc=fi(pc|0,gc|0,rc|0,sc|0)|0;fc=D;Sc=ID;vc=Sc;yc=s[vc>>2]|0;Tc=Sc+4|0;Ec=Tc;_c=s[Ec>>2]|0;bc=ii(0,yc|0,32)|0;Pc=D;Ic=GP;Ac=Ic;Rc=s[Ac>>2]|0;wc=Ic+4|0;Mc=wc;Dc=s[Mc>>2]|0;kc=ii(0,Rc|0,32)|0;Nc=D;Lc=fi(kc|0,Nc|0,bc|0,Pc|0)|0;xc=D;Fc=ri(Lc|0,xc|0,mc|0,fc|0)|0;Uc=D;Vc=ev;Hc=Vc;Bc=s[Hc>>2]|0;jc=Vc+4|0;Gc=jc;Wc=s[Gc>>2]|0;qc=ii(0,Bc|0,32)|0;zc=D;Kc=Rt;Jc=Kc;Yc=s[Jc>>2]|0;Qc=Kc+4|0;Xc=Qc;eh=s[Xc>>2]|0;th=ii(0,Yc|0,32)|0;ih=D;nh=fi(th|0,ih|0,qc|0,zc|0)|0;rh=D;sh=ri(Fc|0,Uc|0,nh|0,rh|0)|0;ah=D;oh=$t;lh=oh;dh=s[lh>>2]|0;hh=oh+4|0;uh=hh;ph=s[uh>>2]|0;gh=ii(0,dh|0,32)|0;mh=D;fh=fm;Sh=fh;vh=s[Sh>>2]|0;yh=fh+4|0;Ch=yh;Eh=s[Ch>>2]|0;_h=ii(0,vh|0,32)|0;bh=D;Ph=fi(_h|0,bh|0,gh|0,mh|0)|0;Ih=D;Ah=ri(sh|0,ah|0,Ph|0,Ih|0)|0;Rh=D;wh=oi(Ah|0,Rh|0,1)|0;Mh=D;Oh=ri(wh|0,Mh|0,Jd|0,Yd|0)|0;Nh=D;Lh=I_;xh=Lh;Fh=s[xh>>2]|0;Uh=Lh+4|0;Vh=Uh;Hh=s[Vh>>2]|0;Bh=ii(0,Fh|0,32)|0;$h=D;jh=nx;Wh=jh;qh=s[Wh>>2]|0;zh=jh+4|0;Kh=zh;Jh=s[Kh>>2]|0;Yh=ii(0,qh|0,32)|0;Qh=D;Xh=fi(Yh|0,Qh|0,Bh|0,$h|0)|0;Zh=D;eu=ri(Oh|0,Nh|0,Xh|0,Zh|0)|0;iu=D;nu=vx;ru=nu;su=s[ru>>2]|0;au=nu+4|0;ou=au;lu=s[ou>>2]|0;du=ii(0,su|0,32)|0;cu=D;hu=u_;pu=hu;gu=s[pu>>2]|0;mu=hu+4|0;fu=mu;Su=s[fu>>2]|0;vu=ii(0,gu|0,32)|0;yu=D;Cu=fi(vu|0,yu|0,du|0,cu|0)|0;Tu=D;Eu=ri(eu|0,iu|0,Cu|0,Tu|0)|0;bu=D;Pu=e+96|0;Iu=Pu;Au=Iu;s[Au>>2]=Eu;Ru=Iu+4|0;wu=Ru;s[wu>>2]=bu;Mu=sw;Ou=Mu;Du=s[Ou>>2]|0;ku=Mu+4|0;Lu=ku;xu=s[Lu>>2]|0;Fu=ii(0,Du|0,32)|0;Uu=D;Vu=uD;Hu=Vu;Bu=s[Hu>>2]|0;$u=Vu+4|0;ju=$u;Gu=s[ju>>2]|0;qu=ii(0,Bu|0,32)|0;zu=D;Ku=fi(qu|0,zu|0,Fu|0,Uu|0)|0;Ju=D;Yu=ID;Qu=Yu;Xu=s[Qu>>2]|0;Zu=Yu+4|0;ep=Zu;tp=s[ep>>2]|0;np=ii(0,Xu|0,32)|0;rp=D;sp=GR;ap=sp;op=s[ap>>2]|0;lp=sp+4|0;dp=lp;cp=s[dp>>2]|0;hp=ii(0,op|0,32)|0;up=D;gp=fi(hp|0,up|0,np|0,rp|0)|0;mp=D;fp=ri(gp|0,mp|0,Ku|0,Ju|0)|0;Sp=D;vp=rI;yp=vp;Cp=s[yp>>2]|0;Tp=vp+4|0;Ep=Tp;_p=s[Ep>>2]|0;Pp=ii(0,Cp|0,32)|0;Ip=D;Ap=nx;Rp=Ap;wp=s[Rp>>2]|0;Mp=Ap+4|0;Op=Mp;Dp=s[Op>>2]|0;kp=ii(0,wp|0,32)|0;Np=D;Fp=fi(kp|0,Np|0,Pp|0,Ip|0)|0;Up=D;Vp=ri(fp|0,Sp|0,Fp|0,Up|0)|0;Hp=D;Bp=vx;$p=Bp;jp=s[$p>>2]|0;Gp=Bp+4|0;Wp=Gp;qp=s[Wp>>2]|0;Kp=ii(0,jp|0,32)|0;Jp=D;Yp=GP;Qp=Yp;Xp=s[Qp>>2]|0;Zp=Yp+4|0;eg=Zp;tg=s[eg>>2]|0;ig=ii(0,Xp|0,32)|0;ng=D;sg=fi(ig|0,ng|0,Kp|0,Jp|0)|0;ag=D;og=ri(Vp|0,Hp|0,sg|0,ag|0)|0;lg=D;dg=I_;cg=dg;hg=s[cg>>2]|0;ug=dg+4|0;pg=ug;gg=s[pg>>2]|0;fg=ii(0,hg|0,32)|0;Sg=D;vg=Rt;yg=vg;Cg=s[yg>>2]|0;Tg=vg+4|0;Eg=Tg;_g=s[Eg>>2]|0;bg=ii(0,Cg|0,32)|0;Pg=D;Ag=fi(bg|0,Pg|0,fg|0,Sg|0)|0;Rg=D;wg=ri(og|0,lg|0,Ag|0,Rg|0)|0;Mg=D;Og=$t;Dg=Og;kg=s[Dg>>2]|0;Ng=Og+4|0;Lg=Ng;xg=s[Lg>>2]|0;Ug=ii(0,kg|0,32)|0;Vg=D;Hg=u_;Bg=Hg;$g=s[Bg>>2]|0;jg=Hg+4|0;Gg=jg;Wg=s[Gg>>2]|0;qg=ii(0,$g|0,32)|0;zg=D;Jg=fi(qg|0,zg|0,Ug|0,Vg|0)|0;Yg=D;Qg=ri(wg|0,Mg|0,Jg|0,Yg|0)|0;Xg=D;Zg=e+104|0;em=Zg;tm=em;s[tm>>2]=Qg;im=em+4|0;nm=im;s[nm>>2]=Xg;rm=ID;am=rm;om=s[am>>2]|0;lm=rm+4|0;dm=lm;cm=s[dm>>2]|0;hm=ii(0,om|0,32)|0;um=D;pm=uD;gm=pm;mm=s[gm>>2]|0;Sm=pm+4|0;vm=Sm;ym=s[vm>>2]|0;Cm=ii(0,mm|0,32)|0;Tm=D;Em=fi(Cm|0,Tm|0,hm|0,um|0)|0;_m=D;bm=rI;Pm=bm;Im=s[Pm>>2]|0;Rm=bm+4|0;wm=Rm;Mm=s[wm>>2]|0;Om=ii(0,Im|0,32)|0;Dm=D;km=Rt;Nm=km;Lm=s[Nm>>2]|0;xm=km+4|0;Fm=xm;Hm=s[Fm>>2]|0;Bm=ii(0,Lm|0,32)|0;$m=D;jm=fi(Bm|0,$m|0,Om|0,Dm|0)|0;Gm=D;Wm=ri(jm|0,Gm|0,Em|0,_m|0)|0;qm=D;zm=$t;Km=zm;Jm=s[Km>>2]|0;Qm=zm+4|0;Xm=Qm;Zm=s[Xm>>2]|0;ef=ii(0,Jm|0,32)|0;tf=D;nf=GP;rf=nf;sf=s[rf>>2]|0;af=nf+4|0;of=af;df=s[of>>2]|0;cf=ii(0,sf|0,32)|0;hf=D;uf=fi(cf|0,hf|0,ef|0,tf|0)|0;pf=D;gf=ri(Wm|0,qm|0,uf|0,pf|0)|0;mf=D;ff=oi(gf|0,mf|0,1)|0;Sf=D;vf=sw;Cf=vf;Tf=s[Cf>>2]|0;Ef=vf+4|0;_f=Ef;bf=s[_f>>2]|0;Pf=ii(0,Tf|0,32)|0;If=D;Af=nx;Rf=Af;wf=s[Rf>>2]|0;Of=Af+4|0;Df=Of;kf=s[Df>>2]|0;Nf=ii(0,wf|0,32)|0;Lf=D;xf=fi(Nf|0,Lf|0,Pf|0,If|0)|0;Ff=D;Uf=ri(ff|0,Sf|0,xf|0,Ff|0)|0;Vf=D;Hf=vx;$f=Hf;jf=s[$f>>2]|0;Gf=Hf+4|0;Wf=Gf;qf=s[Wf>>2]|0;zf=ii(0,jf|0,32)|0;Kf=D;Jf=GR;Yf=Jf;Qf=s[Yf>>2]|0;Zf=Jf+4|0;eS=Zf;tS=s[eS>>2]|0;iS=ii(0,Qf|0,32)|0;nS=D;rS=fi(iS|0,nS|0,zf|0,Kf|0)|0;sS=D;aS=ri(Uf|0,Vf|0,rS|0,sS|0)|0;oS=D;lS=e+112|0;cS=lS;hS=cS;s[hS>>2]=aS;uS=cS+4|0;pS=uS;s[pS>>2]=oS;gS=ID;mS=gS;fS=s[mS>>2]|0;SS=gS+4|0;vS=SS;yS=s[vS>>2]|0;TS=ii(0,fS|0,32)|0;ES=D;_S=nx;bS=_S;PS=s[bS>>2]|0;IS=_S+4|0;AS=IS;RS=s[AS>>2]|0;wS=ii(0,PS|0,32)|0;MS=D;DS=fi(wS|0,MS|0,TS|0,ES|0)|0;kS=D;NS=vx;LS=NS;xS=s[LS>>2]|0;FS=NS+4|0;US=FS;VS=s[US>>2]|0;HS=ii(0,xS|0,32)|0;BS=D;GS=uD;WS=GS;qS=s[WS>>2]|0;zS=GS+4|0;KS=zS;JS=s[KS>>2]|0;YS=ii(0,qS|0,32)|0;QS=D;XS=fi(YS|0,QS|0,HS|0,BS|0)|0;ZS=D;tv=ri(XS|0,ZS|0,DS|0,kS|0)|0;iv=D;nv=sw;rv=nv;sv=s[rv>>2]|0;av=nv+4|0;ov=av;lv=s[ov>>2]|0;dv=ii(0,sv|0,32)|0;cv=D;uv=Rt;pv=uv;gv=s[pv>>2]|0;mv=uv+4|0;fv=mv;Sv=s[fv>>2]|0;vv=ii(0,gv|0,32)|0;yv=D;Cv=fi(vv|0,yv|0,dv|0,cv|0)|0;Tv=D;_v=ri(tv|0,iv|0,Cv|0,Tv|0)|0;bv=D;Pv=$t;Iv=Pv;Av=s[Iv>>2]|0;Rv=Pv+4|0;wv=Rv;Mv=s[wv>>2]|0;Ov=ii(0,Av|0,32)|0;Dv=D;Nv=GR;Lv=Nv;xv=s[Lv>>2]|0;Fv=Nv+4|0;Uv=Fv;Vv=s[Uv>>2]|0;Hv=ii(0,xv|0,32)|0;Bv=D;$v=fi(Hv|0,Bv|0,Ov|0,Dv|0)|0;jv=D;Wv=ri(_v|0,bv|0,$v|0,jv|0)|0;qv=D;zv=e+120|0;Kv=zv;Jv=Kv;s[Jv>>2]=Wv;Yv=Kv+4|0;Qv=Yv;s[Qv>>2]=qv;Xv=vx;Zv=Xv;ey=s[Zv>>2]|0;iy=Xv+4|0;ny=iy;ry=s[ny>>2]|0;sy=ii(0,ey|0,32)|0;ay=D;oy=nx;ly=oy;dy=s[ly>>2]|0;cy=oy+4|0;hy=cy;py=s[hy>>2]|0;gy=ii(0,dy|0,32)|0;my=D;fy=fi(gy|0,my|0,sy|0,ay|0)|0;Sy=D;vy=ID;yy=vy;Cy=s[yy>>2]|0;Ty=vy+4|0;Ey=Ty;by=s[Ey>>2]|0;Py=ii(0,Cy|0,32)|0;Iy=D;Ay=Rt;Ry=Ay;wy=s[Ry>>2]|0;My=Ay+4|0;Oy=My;Dy=s[Oy>>2]|0;ky=ii(0,wy|0,32)|0;Ly=D;xy=fi(ky|0,Ly|0,Py|0,Iy|0)|0;Fy=D;Uy=$t;Vy=Uy;Hy=s[Vy>>2]|0;By=Uy+4|0;$y=By;jy=s[$y>>2]|0;Gy=ii(0,Hy|0,32)|0;Ky=D;Jy=uD;Yy=Jy;Qy=s[Yy>>2]|0;Xy=Jy+4|0;Zy=Xy;eC=s[Zy>>2]|0;tC=ii(0,Qy|0,32)|0;iC=D;nC=fi(tC|0,iC|0,Gy|0,Ky|0)|0;sC=D;aC=ri(nC|0,sC|0,xy|0,Fy|0)|0;oC=D;lC=oi(aC|0,oC|0,1)|0;dC=D;cC=ri(lC|0,dC|0,fy|0,Sy|0)|0;hC=D;uC=e+128|0;pC=uC;gC=pC;s[gC>>2]=cC;fC=pC+4|0;SC=fC;s[SC>>2]=hC;vC=vx;yC=vC;CC=s[yC>>2]|0;TC=vC+4|0;EC=TC;_C=s[EC>>2]|0;bC=ii(0,CC|0,32)|0;PC=D;AC=Rt;RC=AC;wC=s[RC>>2]|0;MC=AC+4|0;OC=MC;DC=s[OC>>2]|0;kC=ii(0,wC|0,32)|0;NC=D;LC=fi(kC|0,NC|0,bC|0,PC|0)|0;xC=D;UC=$t;VC=UC;HC=s[VC>>2]|0;BC=UC+4|0;$C=BC;jC=s[$C>>2]|0;GC=ii(0,HC|0,32)|0;WC=D;qC=nx;zC=qC;JC=s[zC>>2]|0;YC=qC+4|0;QC=YC;XC=s[QC>>2]|0;ZC=ii(0,JC|0,32)|0;eT=D;tT=fi(ZC|0,eT|0,GC|0,WC|0)|0;iT=D;nT=ri(tT|0,iT|0,LC|0,xC|0)|0;rT=D;aT=e+136|0;oT=aT;lT=oT;s[lT>>2]=nT;dT=oT+4|0;cT=dT;s[cT>>2]=rT;hT=$t;uT=hT;pT=s[uT>>2]|0;gT=hT+4|0;mT=gT;ST=s[mT>>2]|0;vT=ii(0,pT|0,31)|0;yT=D;CT=Rt;TT=CT;ET=s[TT>>2]|0;_T=CT+4|0;bT=_T;PT=s[bT>>2]|0;IT=ii(0,ET|0,32)|0;RT=D;wT=fi(IT|0,RT|0,vT|0,yT|0)|0;MT=D;OT=e+144|0;DT=OT;kT=DT;s[kT>>2]=wT;NT=DT+4|0;LT=NT;s[LT>>2]=MT;h=YF;return}function He(e){e=e|0;var t=0,i=0,n=0,r=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0;var _=0,b=0,P=0,I=0,A=0,R=0,w=0,M=0,O=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0,j=0;var G=0,W=0,q=0,z=0,K=0,J=0,Y=0,Q=0,X=0,Z=0,ee=0,te=0,ie=0,ne=0,re=0,se=0,ae=0,oe=0,le=0,de=0;var ce=0,he=0,ue=0,pe=0,ge=0,me=0,fe=0,Se=0,ve=0,ye=0,Ce=0,Te=0,Ee=0,_e=0,be=0,Pe=0,Ie=0,Ae=0,Re=0,we=0;var Me=0,Oe=0,De=0,ke=0,Ne=0,Le=0,xe=0,Fe=0,Ue=0,Ve=0,He=0,Be=0,$e=0,je=0,Ge=0,We=0,qe=0,ze=0,Ke=0,Je=0;var Ye=0,Qe=0,Xe=0,Ze=0,et=0,tt=0,it=0,nt=0,rt=0,st=0,at=0,ot=0,lt=0,dt=0,ct=0,ht=0,ut=0,pt=0,gt=0,mt=0;var ft=0,St=0,vt=0,yt=0,Ct=0,Tt=0,Et=0,_t=0,bt=0,Pt=0,It=0,At=0,Rt=0,wt=0,Mt=0,Ot=0,Dt=0,kt=0,Nt=0,Lt=0;var xt=0,Ft=0,Ut=0,Vt=0,Ht=0,Bt=0,$t=0,jt=0,Gt=0,Wt=0,qt=0,zt=0,Kt=0,Jt=0,Yt=0,Qt=0,Xt=0,Zt=0,ei=0,ti=0;var ii=0,ni=0,si=0,ai=0,li=0,di=0,ci=0,hi=0,ui=0,pi=0,gi=0,mi=0,fi=0,Si=0,vi=0,yi=0,Ci=0,Ti=0,Ei=0,_i=0;var bi=0,Pi=0,Ii=0,Ai=0,Ri=0,wi=0,Mi=0,Oi=0,Di=0,ki=0,Ni=0,Li=0,xi=0,Fi=0,Ui=0,Vi=0,Hi=0,Bi=0,$i=0,ji=0;var Gi=0,Wi=0,qi=0,zi=0,Ki=0,Ji=0,Yi=0,Qi=0,Xi=0,Zi=0,en=0,tn=0,nn=0,rn=0,sn=0,an=0,on=0,ln=0,dn=0,cn=0;var hn=0,un=0,pn=0,gn=0,mn=0,fn=0,Sn=0,vn=0,yn=0,Cn=0,Tn=0,En=0,_n=0,bn=0,Pn=0,In=0,An=0,Rn=0,wn=0,Mn=0;var On=0,Dn=0,kn=0,Nn=0,Ln=0,xn=0,Fn=0,Un=0,Vn=0,Hn=0,Bn=0,$n=0,jn=0,Gn=0,Wn=0,qn=0,zn=0,Kn=0,Jn=0,Yn=0;var Qn=0,Xn=0,Zn=0,er=0,tr=0,ir=0,nr=0,rr=0,sr=0,ar=0,or=0,lr=0,dr=0,cr=0,hr=0,ur=0,pr=0,gr=0,mr=0,fr=0;var Sr=0,vr=0,yr=0,Cr=0,Tr=0,Er=0,_r=0,br=0,Pr=0,Ir=0,Ar=0,Rr=0,wr=0,Mr=0,Or=0,Dr=0,kr=0,Nr=0,Lr=0,xr=0;var Fr=0;Fr=h;t=e+144|0;i=t;lt=i;pn=s[lt>>2]|0;bn=i+4|0;Ln=bn;qn=s[Ln>>2]|0;nr=oi(pn|0,qn|0,4)|0;gr=D;Pr=e+64|0;n=Pr;f=n;A=s[f>>2]|0;V=n+4|0;Y=V;oe=s[Y>>2]|0;ve=ri(A|0,oe|0,nr|0,gr|0)|0;we=D;He=oi(pn|0,qn|0,1)|0;Qe=D;dt=ri(He|0,Qe|0,ve|0,we|0)|0;Ct=D;Ot=t;$t=Ot;Zt=s[$t>>2]|0;ui=Ot+4|0;_i=ui;Ni=s[_i>>2]|0;Wi=ri(dt|0,Ct|0,Zt|0,Ni|0)|0;nn=D;gn=Pr;mn=gn;s[mn>>2]=Wi;fn=gn+4|0;Sn=fn;s[Sn>>2]=nn;vn=e+136|0;yn=vn;Cn=yn;Tn=s[Cn>>2]|0;En=yn+4|0;_n=En;Pn=s[_n>>2]|0;In=oi(Tn|0,Pn|0,4)|0;An=D;Rn=e+56|0;wn=Rn;Mn=wn;On=s[Mn>>2]|0;Dn=wn+4|0;kn=Dn;Nn=s[kn>>2]|0;xn=ri(On|0,Nn|0,In|0,An|0)|0;Fn=D;Un=oi(Tn|0,Pn|0,1)|0;Vn=D;Hn=ri(Un|0,Vn|0,xn|0,Fn|0)|0;Bn=D;$n=vn;jn=$n;Gn=s[jn>>2]|0;Wn=$n+4|0;zn=Wn;Kn=s[zn>>2]|0;Jn=ri(Hn|0,Bn|0,Gn|0,Kn|0)|0;Yn=D;Qn=Rn;Xn=Qn;s[Xn>>2]=Jn;Zn=Qn+4|0;er=Zn;s[er>>2]=Yn;tr=e+128|0;ir=tr;rr=ir;sr=s[rr>>2]|0;ar=ir+4|0;or=ar;lr=s[or>>2]|0;dr=oi(sr|0,lr|0,4)|0;cr=D;hr=e+48|0;ur=hr;pr=ur;mr=s[pr>>2]|0;fr=ur+4|0;Sr=fr;vr=s[Sr>>2]|0;yr=ri(mr|0,vr|0,dr|0,cr|0)|0;Cr=D;Tr=oi(sr|0,lr|0,1)|0;Er=D;_r=ri(Tr|0,Er|0,yr|0,Cr|0)|0;br=D;Ir=tr;Ar=Ir;Rr=s[Ar>>2]|0;wr=Ir+4|0;Mr=wr;Or=s[Mr>>2]|0;Dr=ri(_r|0,br|0,Rr|0,Or|0)|0;kr=D;Nr=hr;Lr=Nr;s[Lr>>2]=Dr;r=Nr+4|0;a=r;s[a>>2]=kr;o=e+120|0;l=o;d=l;c=s[d>>2]|0;u=l+4|0;p=u;g=s[p>>2]|0;m=oi(c|0,g|0,4)|0;S=D;v=e+40|0;y=v;C=y;T=s[C>>2]|0;E=y+4|0;_=E;b=s[_>>2]|0;P=ri(T|0,b|0,m|0,S|0)|0;I=D;R=oi(c|0,g|0,1)|0;w=D;M=ri(R|0,w|0,P|0,I|0)|0;O=D;k=o;N=k;L=s[N>>2]|0;x=k+4|0;F=x;U=s[F>>2]|0;H=ri(M|0,O|0,L|0,U|0)|0;B=D;$=v;j=$;s[j>>2]=H;G=$+4|0;W=G;s[W>>2]=B;q=e+112|0;z=q;K=z;J=s[K>>2]|0;Q=z+4|0;X=Q;Z=s[X>>2]|0;ee=oi(J|0,Z|0,4)|0;te=D;ie=e+32|0;ne=ie;re=ne;se=s[re>>2]|0;ae=ne+4|0;le=ae;de=s[le>>2]|0;ce=ri(se|0,de|0,ee|0,te|0)|0;he=D;ue=oi(J|0,Z|0,1)|0;pe=D;ge=ri(ue|0,pe|0,ce|0,he|0)|0;me=D;fe=q;Se=fe;ye=s[Se>>2]|0;Ce=fe+4|0;Te=Ce;Ee=s[Te>>2]|0;_e=ri(ge|0,me|0,ye|0,Ee|0)|0;be=D;Pe=ie;Ie=Pe;s[Ie>>2]=_e;Ae=Pe+4|0;Re=Ae;s[Re>>2]=be;Me=e+104|0;Oe=Me;De=Oe;ke=s[De>>2]|0;Ne=Oe+4|0;Le=Ne;xe=s[Le>>2]|0;Fe=oi(ke|0,xe|0,4)|0;Ue=D;Ve=e+24|0;Be=Ve;$e=Be;je=s[$e>>2]|0;Ge=Be+4|0;We=Ge;qe=s[We>>2]|0;ze=ri(je|0,qe|0,Fe|0,Ue|0)|0;Ke=D;Je=oi(ke|0,xe|0,1)|0;Ye=D;Xe=ri(Je|0,Ye|0,ze|0,Ke|0)|0;Ze=D;et=Me;tt=et;it=s[tt>>2]|0;nt=et+4|0;rt=nt;st=s[rt>>2]|0;at=ri(Xe|0,Ze|0,it|0,st|0)|0;ot=D;ct=Ve;ht=ct;s[ht>>2]=at;ut=ct+4|0;pt=ut;s[pt>>2]=ot;gt=e+96|0;mt=gt;ft=mt;St=s[ft>>2]|0;vt=mt+4|0;yt=vt;Tt=s[yt>>2]|0;Et=oi(St|0,Tt|0,4)|0;_t=D;bt=e+16|0;Pt=bt;It=Pt;At=s[It>>2]|0;Rt=Pt+4|0;wt=Rt;Mt=s[wt>>2]|0;Dt=ri(At|0,Mt|0,Et|0,_t|0)|0;kt=D;Nt=oi(St|0,Tt|0,1)|0;Lt=D;xt=ri(Nt|0,Lt|0,Dt|0,kt|0)|0;Ft=D;Ut=gt;Vt=Ut;Ht=s[Vt>>2]|0;Bt=Ut+4|0;jt=Bt;Gt=s[jt>>2]|0;Wt=ri(xt|0,Ft|0,Ht|0,Gt|0)|0;qt=D;zt=bt;Kt=zt;s[Kt>>2]=Wt;Jt=zt+4|0;Yt=Jt;s[Yt>>2]=qt;Qt=e+88|0;Xt=Qt;ei=Xt;ti=s[ei>>2]|0;ii=Xt+4|0;ni=ii;si=s[ni>>2]|0;ai=oi(ti|0,si|0,4)|0;li=D;di=e+8|0;ci=di;hi=ci;pi=s[hi>>2]|0;gi=ci+4|0;mi=gi;fi=s[mi>>2]|0;Si=ri(pi|0,fi|0,ai|0,li|0)|0;vi=D;yi=oi(ti|0,si|0,1)|0;Ci=D;Ti=ri(yi|0,Ci|0,Si|0,vi|0)|0;Ei=D;bi=Qt;Pi=bi;Ii=s[Pi>>2]|0;Ai=bi+4|0;Ri=Ai;wi=s[Ri>>2]|0;Mi=ri(Ti|0,Ei|0,Ii|0,wi|0)|0;Oi=D;Di=di;ki=Di;s[ki>>2]=Mi;Li=Di+4|0;xi=Li;s[xi>>2]=Oi;Fi=e+80|0;Ui=Fi;Vi=Ui;Hi=s[Vi>>2]|0;Bi=Ui+4|0;$i=Bi;ji=s[$i>>2]|0;Gi=oi(Hi|0,ji|0,4)|0;qi=D;zi=e;Ki=zi;Ji=s[Ki>>2]|0;Yi=zi+4|0;Qi=Yi;Xi=s[Qi>>2]|0;Zi=ri(Ji|0,Xi|0,Gi|0,qi|0)|0;en=D;tn=oi(Hi|0,ji|0,1)|0;rn=D;sn=ri(tn|0,rn|0,Zi|0,en|0)|0;an=D;on=ri(sn|0,an|0,Hi|0,ji|0)|0;ln=D;dn=e;cn=dn;s[cn>>2]=on;hn=dn+4|0;un=hn;s[un>>2]=ln;h=Fr;return}function Be(e){e=e|0;var t=0,i=0,n=0,r=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0;var _=0,b=0,P=0,I=0,A=0,R=0,w=0,M=0,O=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0,j=0;var G=0,W=0,q=0,z=0,K=0,J=0,Y=0,Q=0,X=0,Z=0,ee=0,te=0,ie=0,ne=0,re=0,se=0,ae=0,oe=0,le=0,de=0;var ce=0,he=0,ue=0,pe=0,ge=0,me=0,fe=0,Se=0,ve=0,ye=0,Ce=0,Te=0,Ee=0,_e=0,be=0,Pe=0,Ie=0,Ae=0,Re=0,we=0;var Me=0,Oe=0,De=0,ke=0,Ne=0,Le=0,xe=0,Fe=0,Ue=0,Ve=0,He=0,Be=0,$e=0,je=0,Ge=0,We=0,qe=0,ze=0,Ye=0,Qe=0;var Xe=0,Ze=0,et=0,tt=0,it=0,nt=0,rt=0,st=0,at=0,ot=0,lt=0,dt=0,ct=0,ht=0,ut=0,pt=0,gt=0,mt=0,ft=0;ft=h;t=e+80|0;i=t;O=i;s[O>>2]=0;j=i+4|0;ee=j;s[ee>>2]=0;gt=0;while(1){he=e+(gt<<3)|0;Ee=he;ke=Ee;Ge=s[ke>>2]|0;nt=Ee+4|0;n=nt;f=s[n>>2]|0;_=Ke(Ge,f)|0;b=D;P=oi(_|0,b|0,26)|0;I=D;A=ni(Ge|0,f|0,P|0,I|0)|0;R=D;w=he;M=w;s[M>>2]=A;k=w+4|0;N=k;s[N>>2]=R;L=gt|1;x=e+(L<<3)|0;F=x;U=F;V=s[U>>2]|0;H=F+4|0;B=H;$=s[B>>2]|0;G=ri(V|0,$|0,_|0,b|0)|0;W=D;q=Je(G,W)|0;z=D;K=oi(q|0,z|0,25)|0;J=D;Y=ni(G|0,W|0,K|0,J|0)|0;Q=D;X=x;Z=X;s[Z>>2]=Y;te=X+4|0;ie=te;s[ie>>2]=Q;ne=gt+2|0;re=e+(ne<<3)|0;se=re;ae=se;oe=s[ae>>2]|0;le=se+4|0;de=le;ce=s[de>>2]|0;ue=ri(oe|0,ce|0,q|0,z|0)|0;pe=D;ge=re;me=ge;s[me>>2]=ue;fe=ge+4|0;Se=fe;s[Se>>2]=pe;ve=ne>>>0<10;if(ve){gt=ne}else{break}}ye=t;Ce=ye;Te=s[Ce>>2]|0;_e=ye+4|0;be=_e;Pe=s[be>>2]|0;Ie=oi(Te|0,Pe|0,4)|0;Ae=D;Re=e;we=Re;Me=s[we>>2]|0;Oe=Re+4|0;De=Oe;Ne=s[De>>2]|0;Le=ri(Me|0,Ne|0,Ie|0,Ae|0)|0;xe=D;Fe=oi(Te|0,Pe|0,1)|0;Ue=D;Ve=ri(Fe|0,Ue|0,Le|0,xe|0)|0;He=D;Be=ri(Ve|0,He|0,Te|0,Pe|0)|0;$e=D;je=e;We=je;s[We>>2]=Be;qe=je+4|0;ze=qe;s[ze>>2]=$e;Ye=t;Qe=Ye;s[Qe>>2]=0;Xe=Ye+4|0;Ze=Xe;s[Ze>>2]=0;et=e;tt=et;it=s[tt>>2]|0;rt=et+4|0;st=rt;at=s[st>>2]|0;ot=Ke(it,at)|0;lt=D;dt=oi(ot|0,lt|0,26)|0;ct=D;ht=ni(it|0,at|0,dt|0,ct|0)|0;ut=D;pt=e;r=pt;s[r>>2]=ht;a=pt+4|0;o=a;s[o>>2]=ut;l=e+8|0;d=l;c=d;u=s[c>>2]|0;p=d+4|0;g=p;m=s[g>>2]|0;S=ri(u|0,m|0,ot|0,lt|0)|0;v=D;y=l;C=y;s[C>>2]=S;T=y+4|0;E=T;s[E>>2]=v;h=ft;return}function $e(e,t){e=e|0;t=t|0;var i=0,n=0,r=0,s=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0;S=h;i=e^-1;n=i^t;o=n<<16;l=o&n;d=l<<8;c=d&l;u=c<<4;p=u&c;g=p<<2;m=g&p;r=m<<1;s=r&m;a=s>>31;h=S;return a|0}function je(e){e=e|0;var t=0,i=0,n=0,r=0,s=0;s=h;t=e+-67108845|0;i=t>>31;n=i^-1;h=s;return n|0}function Ge(e,t){e=e|0;t=t|0;var i=0,n=0,r=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0;var b=0,P=0,I=0,A=0,R=0,w=0,M=0,O=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0,j=0,G=0;var W=0,q=0,z=0,K=0,J=0,Y=0,Q=0,X=0,Z=0,ee=0,te=0,ie=0,ne=0,re=0,se=0,ae=0,oe=0,le=0,de=0,ce=0;var he=0,ue=0,pe=0,ge=0,me=0,fe=0,Se=0,ve=0,ye=0,Ce=0,Te=0,Ee=0,_e=0,be=0,Pe=0,Ie=0,Ae=0,Re=0,we=0,Me=0;var Oe=0,De=0,ke=0,Ne=0,Le=0,xe=0,Fe=0,Ue=0,Ve=0,He=0,Be=0,$e=0,je=0,Ge=0,We=0,qe=0,ze=0,Ke=0,Je=0,Ye=0;var Qe=0,Xe=0,Ze=0,et=0,tt=0,it=0,nt=0,rt=0,st=0,at=0,ot=0,lt=0,dt=0,ct=0,ht=0,ut=0,pt=0,gt=0,mt=0,ft=0;var St=0,vt=0,yt=0,Ct=0,Tt=0,Et=0,_t=0,bt=0,Pt=0,It=0,At=0,Rt=0,wt=0,Mt=0,Ot=0,Dt=0,kt=0,Nt=0,Lt=0,xt=0;var Ft=0,Ut=0,Vt=0,Ht=0,Bt=0,$t=0,jt=0,Gt=0,Wt=0,qt=0,zt=0,Kt=0,Jt=0,Yt=0,Qt=0,Xt=0,Zt=0,ei=0,ti=0,ii=0;var ni=0,si=0,ai=0,oi=0,li=0,di=0,ci=0,hi=0,ui=0,pi=0,gi=0,mi=0,fi=0,Si=0,vi=0,yi=0,Ci=0,Ti=0,Ei=0,_i=0;var bi=0,Pi=0,Ii=0,Ai=0,Ri=0,wi=0,Mi=0,Oi=0,Di=0,ki=0,Ni=0,Li=0,xi=0,Fi=0,Ui=0,Vi=0,Hi=0,Bi=0,$i=0,ji=0;ji=h;i=e;n=i;ot=s[n>>2]|0;vt=i+4|0;wt=vt;Ht=s[wt>>2]|0;Qt=t;di=Qt;Ci=s[di>>2]|0;Oi=Qt+4|0;r=Oi;S=s[r>>2]|0;R=ri(Ci|0,S|0,ot|0,Ht|0)|0;H=D;Q=e;le=Q;s[le>>2]=R;ye=Q+4|0;Me=ye;s[Me>>2]=H;Be=e+8|0;Xe=Be;lt=Xe;dt=s[lt>>2]|0;ct=Xe+4|0;ht=ct;ut=s[ht>>2]|0;pt=t+8|0;gt=pt;mt=gt;ft=s[mt>>2]|0;St=gt+4|0;yt=St;Ct=s[yt>>2]|0;Tt=ri(ft|0,Ct|0,dt|0,ut|0)|0;Et=D;_t=Be;bt=_t;s[bt>>2]=Tt;Pt=_t+4|0;It=Pt;s[It>>2]=Et;At=e+16|0;Rt=At;Mt=Rt;Ot=s[Mt>>2]|0;Dt=Rt+4|0;kt=Dt;Nt=s[kt>>2]|0;Lt=t+16|0;xt=Lt;Ft=xt;Ut=s[Ft>>2]|0;Vt=xt+4|0;Bt=Vt;$t=s[Bt>>2]|0;jt=ri(Ut|0,$t|0,Ot|0,Nt|0)|0;Gt=D;Wt=At;qt=Wt;s[qt>>2]=jt;zt=Wt+4|0;Kt=zt;s[Kt>>2]=Gt;Jt=e+24|0;Yt=Jt;Xt=Yt;Zt=s[Xt>>2]|0;ei=Yt+4|0;ti=ei;ii=s[ti>>2]|0;ni=t+24|0;si=ni;ai=si;oi=s[ai>>2]|0;li=si+4|0;ci=li;hi=s[ci>>2]|0;ui=ri(oi|0,hi|0,Zt|0,ii|0)|0;pi=D;gi=Jt;mi=gi;s[mi>>2]=ui;fi=gi+4|0;Si=fi;s[Si>>2]=pi;vi=e+32|0;yi=vi;Ti=yi;Ei=s[Ti>>2]|0;_i=yi+4|0;bi=_i;Pi=s[bi>>2]|0;Ii=t+32|0;Ai=Ii;Ri=Ai;wi=s[Ri>>2]|0;Mi=Ai+4|0;Di=Mi;ki=s[Di>>2]|0;Ni=ri(wi|0,ki|0,Ei|0,Pi|0)|0;Li=D;xi=vi;Fi=xi;s[Fi>>2]=Ni;Ui=xi+4|0;Vi=Ui;s[Vi>>2]=Li;Hi=e+40|0;Bi=Hi;a=Bi;o=s[a>>2]|0;l=Bi+4|0;d=l;c=s[d>>2]|0;u=t+40|0;p=u;g=p;m=s[g>>2]|0;f=p+4|0;v=f;y=s[v>>2]|0;C=ri(m|0,y|0,o|0,c|0)|0;T=D;E=Hi;_=E;s[_>>2]=C;b=E+4|0;P=b;s[P>>2]=T;I=e+48|0;A=I;w=A;M=s[w>>2]|0;O=A+4|0;k=O;N=s[k>>2]|0;L=t+48|0;x=L;F=x;U=s[F>>2]|0;V=x+4|0;B=V;$=s[B>>2]|0;j=ri(U|0,$|0,M|0,N|0)|0;G=D;W=I;q=W;s[q>>2]=j;z=W+4|0;K=z;s[K>>2]=G;J=e+56|0;Y=J;X=Y;Z=s[X>>2]|0;ee=Y+4|0;te=ee;ie=s[te>>2]|0;ne=t+56|0;re=ne;se=re;ae=s[se>>2]|0;oe=re+4|0;de=oe;ce=s[de>>2]|0;he=ri(ae|0,ce|0,Z|0,ie|0)|0;ue=D;pe=J;ge=pe;s[ge>>2]=he;me=pe+4|0;fe=me;s[fe>>2]=ue;Se=e+64|0;ve=Se;Ce=ve;Te=s[Ce>>2]|0;Ee=ve+4|0;_e=Ee;be=s[_e>>2]|0;Pe=t+64|0;Ie=Pe;Ae=Ie;Re=s[Ae>>2]|0;we=Ie+4|0;Oe=we;De=s[Oe>>2]|0;ke=ri(Re|0,De|0,Te|0,be|0)|0;Ne=D;Le=Se;xe=Le;s[xe>>2]=ke;Fe=Le+4|0;Ue=Fe;s[Ue>>2]=Ne;Ve=e+72|0;He=Ve;$e=He;je=s[$e>>2]|0;Ge=He+4|0;We=Ge;qe=s[We>>2]|0;ze=t+72|0;Ke=ze;Je=Ke;Ye=s[Je>>2]|0;Qe=Ke+4|0;Ze=Qe;et=s[Ze>>2]|0;tt=ri(Ye|0,et|0,je|0,qe|0)|0;it=D;nt=Ve;rt=nt;s[rt>>2]=tt;st=nt+4|0;at=st;s[at>>2]=it;h=ji;return}function We(e,t){e=e|0;t=t|0;var i=0,n=0,r=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0;var b=0,P=0,I=0,A=0,R=0,w=0,M=0,O=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0,j=0,G=0;var W=0,q=0,z=0,K=0,J=0,Y=0,Q=0,X=0,Z=0,ee=0,te=0,ie=0,ne=0,re=0,se=0,ae=0,oe=0,le=0,de=0,ce=0;var he=0,ue=0,pe=0,ge=0,me=0,fe=0,Se=0,ve=0,ye=0,Ce=0,Te=0,Ee=0,_e=0,be=0,Pe=0,Ie=0,Ae=0,Re=0,we=0,Me=0;var Oe=0,De=0,ke=0,Ne=0,Le=0,xe=0,Fe=0,Ue=0,Ve=0,He=0,Be=0,$e=0,je=0,Ge=0,We=0,qe=0,ze=0,Ke=0,Je=0,Ye=0;var Qe=0,Xe=0,Ze=0,et=0,tt=0,it=0,nt=0,rt=0,st=0,at=0,ot=0,lt=0,dt=0,ct=0,ht=0,ut=0,pt=0,gt=0,mt=0,ft=0;var St=0,vt=0,yt=0,Ct=0,Tt=0,Et=0,_t=0,bt=0,Pt=0,It=0,At=0,Rt=0,wt=0,Mt=0,Ot=0,Dt=0,kt=0,Nt=0,Lt=0,xt=0;var Ft=0,Ut=0,Vt=0,Ht=0,Bt=0,$t=0,jt=0,Gt=0,Wt=0,qt=0,zt=0,Kt=0,Jt=0,Yt=0,Qt=0,Xt=0,Zt=0,ei=0,ti=0,ii=0;var ri=0,si=0,ai=0,oi=0,li=0,di=0,ci=0,hi=0,ui=0,pi=0,gi=0,mi=0,fi=0,Si=0,vi=0,yi=0,Ci=0,Ti=0,Ei=0,_i=0;var bi=0,Pi=0,Ii=0,Ai=0,Ri=0,wi=0,Mi=0,Oi=0,Di=0,ki=0,Ni=0,Li=0,xi=0,Fi=0,Ui=0,Vi=0,Hi=0,Bi=0,$i=0,ji=0;ji=h;i=t;n=i;ot=s[n>>2]|0;vt=i+4|0;wt=vt;Ht=s[wt>>2]|0;Qt=e;di=Qt;Ci=s[di>>2]|0;Oi=Qt+4|0;r=Oi;S=s[r>>2]|0;R=ni(ot|0,Ht|0,Ci|0,S|0)|0;H=D;Q=e;le=Q;s[le>>2]=R;ye=Q+4|0;Me=ye;s[Me>>2]=H;Be=t+8|0;Xe=Be;lt=Xe;dt=s[lt>>2]|0;ct=Xe+4|0;ht=ct;ut=s[ht>>2]|0;pt=e+8|0;gt=pt;mt=gt;ft=s[mt>>2]|0;St=gt+4|0;yt=St;Ct=s[yt>>2]|0;Tt=ni(dt|0,ut|0,ft|0,Ct|0)|0;Et=D;_t=pt;bt=_t;s[bt>>2]=Tt;Pt=_t+4|0;It=Pt;s[It>>2]=Et;At=t+16|0;Rt=At;Mt=Rt;Ot=s[Mt>>2]|0;Dt=Rt+4|0;kt=Dt;Nt=s[kt>>2]|0;Lt=e+16|0;xt=Lt;Ft=xt;Ut=s[Ft>>2]|0;Vt=xt+4|0;Bt=Vt;$t=s[Bt>>2]|0;jt=ni(Ot|0,Nt|0,Ut|0,$t|0)|0;Gt=D;Wt=Lt;qt=Wt;s[qt>>2]=jt;zt=Wt+4|0;Kt=zt;s[Kt>>2]=Gt;Jt=t+24|0;Yt=Jt;Xt=Yt;Zt=s[Xt>>2]|0;ei=Yt+4|0;ti=ei;ii=s[ti>>2]|0;ri=e+24|0;si=ri;ai=si;oi=s[ai>>2]|0;li=si+4|0;ci=li;hi=s[ci>>2]|0;ui=ni(Zt|0,ii|0,oi|0,hi|0)|0;pi=D;gi=ri;mi=gi;s[mi>>2]=ui;fi=gi+4|0;Si=fi;s[Si>>2]=pi;vi=t+32|0;yi=vi;Ti=yi;Ei=s[Ti>>2]|0;_i=yi+4|0;bi=_i;Pi=s[bi>>2]|0;Ii=e+32|0;Ai=Ii;Ri=Ai;wi=s[Ri>>2]|0;Mi=Ai+4|0;Di=Mi;ki=s[Di>>2]|0;Ni=ni(Ei|0,Pi|0,wi|0,ki|0)|0;Li=D;xi=Ii;Fi=xi;s[Fi>>2]=Ni;Ui=xi+4|0;Vi=Ui;s[Vi>>2]=Li;Hi=t+40|0;Bi=Hi;a=Bi;o=s[a>>2]|0;l=Bi+4|0;d=l;c=s[d>>2]|0;u=e+40|0;p=u;g=p;m=s[g>>2]|0;f=p+4|0;v=f;y=s[v>>2]|0;C=ni(o|0,c|0,m|0,y|0)|0;T=D;E=u;_=E;s[_>>2]=C;b=E+4|0;P=b;s[P>>2]=T;I=t+48|0;A=I;w=A;M=s[w>>2]|0;O=A+4|0;k=O;N=s[k>>2]|0;L=e+48|0;x=L;F=x;U=s[F>>2]|0;V=x+4|0;B=V;$=s[B>>2]|0;j=ni(M|0,N|0,U|0,$|0)|0;G=D;W=L;q=W;s[q>>2]=j;z=W+4|0;K=z;s[K>>2]=G;J=t+56|0;Y=J;X=Y;Z=s[X>>2]|0;ee=Y+4|0;te=ee;ie=s[te>>2]|0;ne=e+56|0;re=ne;se=re;ae=s[se>>2]|0;oe=re+4|0;de=oe;ce=s[de>>2]|0;he=ni(Z|0,ie|0,ae|0,ce|0)|0;ue=D;pe=ne;ge=pe;s[ge>>2]=he;me=pe+4|0;fe=me;s[fe>>2]=ue;Se=t+64|0;ve=Se;Ce=ve;Te=s[Ce>>2]|0;Ee=ve+4|0;_e=Ee;be=s[_e>>2]|0;Pe=e+64|0;Ie=Pe;Ae=Ie;Re=s[Ae>>2]|0;we=Ie+4|0;Oe=we;De=s[Oe>>2]|0;ke=ni(Te|0,be|0,Re|0,De|0)|0;Ne=D;Le=Pe;xe=Le;s[xe>>2]=ke;Fe=Le+4|0;Ue=Fe;s[Ue>>2]=Ne;Ve=t+72|0;He=Ve;$e=He;je=s[$e>>2]|0;Ge=He+4|0;We=Ge;qe=s[We>>2]|0;ze=e+72|0;Ke=ze;Je=Ke;Ye=s[Je>>2]|0;Qe=Ke+4|0;Ze=Qe;et=s[Ze>>2]|0;tt=ni(je|0,qe|0,Ye|0,et|0)|0;it=D;nt=ze;rt=nt;s[rt>>2]=tt;st=nt+4|0;at=st;s[at>>2]=it;h=ji;return}function qe(e,t){e=e|0;t=t|0;var i=0,n=0,r=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0;var b=0,P=0,I=0,A=0,R=0,w=0,M=0,O=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0,j=0,G=0;var W=0,q=0,z=0,K=0,J=0,Y=0,Q=0,X=0,Z=0,ee=0,te=0,ie=0,ne=0,re=0,se=0,ae=0,oe=0,le=0,de=0,ce=0;var he=0,ue=0,pe=0,ge=0,me=0,fe=0,Se=0,ve=0,ye=0,Ce=0,Te=0,Ee=0,_e=0,be=0,Pe=0,Ie=0,Ae=0,Re=0,we=0,Me=0;var Oe=0,De=0,ke=0,Ne=0,Le=0,xe=0,Fe=0,Ue=0,Ve=0,He=0,Be=0,$e=0,je=0,Ge=0,We=0,qe=0,ze=0,Ke=0,Je=0,Ye=0;var Qe=0,Xe=0,Ze=0,et=0,tt=0,it=0,nt=0,rt=0,st=0,at=0,ot=0,lt=0,dt=0,ct=0,ht=0,ut=0,pt=0,gt=0,mt=0,ft=0;var St=0,vt=0,yt=0,Ct=0,Tt=0,Et=0,_t=0,bt=0,Pt=0,It=0,At=0,Rt=0,wt=0,Mt=0,Ot=0,Dt=0,kt=0,Nt=0,Lt=0,xt=0;xt=h;i=t;n=i;te=s[n>>2]|0;ue=i+4|0;_e=ue;Ne=s[_e>>2]|0;We=fi(te|0,Ne|0,121665,0)|0;it=D;pt=e;bt=pt;s[bt>>2]=We;r=pt+4|0;S=r;s[S>>2]=it;R=t+8|0;H=R;J=H;Y=s[J>>2]|0;Q=H+4|0;X=Q;Z=s[X>>2]|0;ee=fi(Y|0,Z|0,121665,0)|0;ie=D;ne=e+8|0;re=ne;se=re;s[se>>2]=ee;ae=re+4|0;oe=ae;s[oe>>2]=ie;le=t+16|0;de=le;ce=de;he=s[ce>>2]|0;pe=de+4|0;ge=pe;me=s[ge>>2]|0;fe=fi(he|0,me|0,121665,0)|0;Se=D;ve=e+16|0;ye=ve;Ce=ye;s[Ce>>2]=fe;Te=ye+4|0;Ee=Te;s[Ee>>2]=Se;be=t+24|0;Pe=be;Ie=Pe;Ae=s[Ie>>2]|0;Re=Pe+4|0;we=Re;Me=s[we>>2]|0;Oe=fi(Ae|0,Me|0,121665,0)|0;De=D;ke=e+24|0;Le=ke;xe=Le;s[xe>>2]=Oe;Fe=Le+4|0;Ue=Fe;s[Ue>>2]=De;Ve=t+32|0;He=Ve;Be=He;$e=s[Be>>2]|0;je=He+4|0;Ge=je;qe=s[Ge>>2]|0;ze=fi($e|0,qe|0,121665,0)|0;Ke=D;Je=e+32|0;Ye=Je;Qe=Ye;s[Qe>>2]=ze;Xe=Ye+4|0;Ze=Xe;s[Ze>>2]=Ke;et=t+40|0;tt=et;nt=tt;rt=s[nt>>2]|0;st=tt+4|0;at=st;ot=s[at>>2]|0;lt=fi(rt|0,ot|0,121665,0)|0;dt=D;ct=e+40|0;ht=ct;ut=ht;s[ut>>2]=lt;gt=ht+4|0;mt=gt;s[mt>>2]=dt;ft=t+48|0;St=ft;vt=St;yt=s[vt>>2]|0;Ct=St+4|0;Tt=Ct;Et=s[Tt>>2]|0;_t=fi(yt|0,Et|0,121665,0)|0;Pt=D;It=e+48|0;At=It;Rt=At;s[Rt>>2]=_t;wt=At+4|0;Mt=wt;s[Mt>>2]=Pt;Ot=t+56|0;Dt=Ot;kt=Dt;Nt=s[kt>>2]|0;a=Dt+4|0;o=a;l=s[o>>2]|0;d=fi(Nt|0,l|0,121665,0)|0;c=D;u=e+56|0;p=u;g=p;s[g>>2]=d;m=p+4|0;f=m;s[f>>2]=c;v=t+64|0;y=v;C=y;T=s[C>>2]|0;E=y+4|0;_=E;b=s[_>>2]|0;P=fi(T|0,b|0,121665,0)|0;I=D;A=e+64|0;w=A;M=w;s[M>>2]=P;O=w+4|0;k=O;s[k>>2]=I;N=t+72|0;L=N;x=L;F=s[x>>2]|0;U=L+4|0;V=U;B=s[V>>2]|0;$=fi(F|0,B|0,121665,0)|0;j=D;G=e+72|0;W=G;q=W;s[q>>2]=$;z=W+4|0;K=z;s[K>>2]=j;h=xt;return}function ze(e,t){e=e|0;t=t|0;var i=0,n=0,r=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0;var b=0,P=0,I=0,A=0,R=0,w=0,M=0,O=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0,j=0,G=0;var W=0,q=0,z=0,K=0,J=0,Y=0,Q=0,X=0,Z=0,ee=0,te=0,ie=0,ne=0,re=0,se=0,ae=0,oe=0,le=0,de=0,ce=0;var he=0,ue=0,pe=0,ge=0,me=0,fe=0,Se=0,ve=0,ye=0,Ce=0,Te=0,Ee=0,_e=0,be=0,Pe=0,Ie=0,Ae=0,Re=0,we=0,Me=0;var Oe=0,De=0,ke=0,Ne=0,Le=0,xe=0,Fe=0,Ue=0,Ve=0,He=0,Be=0,$e=0,je=0,Ge=0,We=0,qe=0,ze=0,Ke=0,Je=0,Ye=0;var Qe=0,Xe=0,Ze=0,et=0,tt=0,it=0,nt=0,rt=0,st=0,at=0,ot=0,lt=0,dt=0,ct=0,ht=0,ut=0,pt=0,gt=0,mt=0,ft=0;var St=0,vt=0,yt=0,Ct=0,Tt=0,Et=0,_t=0,bt=0,Pt=0,It=0,At=0,Rt=0,wt=0,Mt=0,Ot=0,Dt=0,kt=0,Nt=0,Lt=0,xt=0;var Ft=0,Ut=0,Vt=0,Ht=0,Bt=0,$t=0,jt=0,Gt=0,Wt=0,qt=0,zt=0,Kt=0,Jt=0,Yt=0,Qt=0,Xt=0,Zt=0,ei=0,ti=0,ni=0;var si=0,ai=0,li=0,di=0,ci=0,hi=0,ui=0,pi=0,gi=0,mi=0,Si=0,vi=0,yi=0,Ci=0,Ti=0,Ei=0,_i=0,bi=0,Pi=0,Ii=0;var Ai=0,Ri=0,wi=0,Mi=0,Oi=0,Di=0,ki=0,Ni=0,Li=0,xi=0,Fi=0,Ui=0,Vi=0,Hi=0,Bi=0,$i=0,ji=0,Gi=0,Wi=0,qi=0;var zi=0,Ki=0,Ji=0,Yi=0,Qi=0,Xi=0,Zi=0,en=0,tn=0,nn=0,rn=0,sn=0,an=0,on=0,ln=0,dn=0,cn=0,hn=0,un=0,pn=0;var gn=0,mn=0,fn=0,Sn=0,vn=0,yn=0,Cn=0,Tn=0,En=0,_n=0,bn=0,Pn=0,In=0,An=0,Rn=0,wn=0,Mn=0,On=0,Dn=0,kn=0;var Nn=0,Ln=0,xn=0,Fn=0,Un=0,Vn=0,Hn=0,Bn=0,$n=0,jn=0,Gn=0,Wn=0,qn=0,zn=0,Kn=0,Jn=0,Yn=0,Qn=0,Xn=0,Zn=0;var er=0,tr=0,ir=0,nr=0,rr=0,sr=0,ar=0,or=0,lr=0,dr=0,cr=0,hr=0,ur=0,pr=0,gr=0,mr=0,fr=0,Sr=0,vr=0,yr=0;var Cr=0,Tr=0,Er=0,_r=0,br=0,Pr=0,Ir=0,Ar=0,Rr=0,wr=0,Mr=0,Or=0,Dr=0,kr=0,Nr=0,Lr=0,xr=0,Fr=0,Ur=0,Vr=0;var Hr=0,Br=0,$r=0,jr=0,Gr=0,Wr=0,qr=0,zr=0,Kr=0,Jr=0,Yr=0,Qr=0,Xr=0,Zr=0,es=0,ts=0,is=0,ns=0,rs=0,ss=0;var as=0,os=0,ls=0,ds=0,cs=0,hs=0,us=0,ps=0,gs=0,ms=0,fs=0,Ss=0,vs=0,ys=0,Cs=0,Ts=0,Es=0,_s=0,bs=0,Ps=0;var Is=0,As=0,Rs=0,ws=0,Ms=0,Os=0,Ds=0,ks=0,Ns=0,Ls=0,xs=0,Fs=0,Us=0,Vs=0,Hs=0,Bs=0,$s=0,js=0,Gs=0,Ws=0;var qs=0,zs=0,Ks=0,Js=0,Ys=0,Qs=0,Xs=0,Zs=0,ea=0,ta=0,ia=0,na=0,ra=0,sa=0,aa=0,oa=0,la=0,da=0,ca=0,ha=0;var ua=0,pa=0,ga=0,ma=0,fa=0,Sa=0,va=0,ya=0,Ca=0,Ta=0,Ea=0,_a=0,ba=0,Pa=0,Ia=0,Aa=0,Ra=0,wa=0,Ma=0,Oa=0;var Da=0,ka=0,Na=0,La=0,xa=0,Fa=0,Ua=0,Va=0,Ha=0,Ba=0,$a=0,ja=0,Ga=0,Wa=0,qa=0,za=0,Ka=0,Ja=0,Ya=0,Qa=0;var Xa=0,Za=0,eo=0,to=0,io=0,no=0,ro=0,so=0,ao=0,oo=0,lo=0,co=0,ho=0,uo=0,po=0,go=0,mo=0,fo=0,So=0,vo=0;var yo=0,Co=0,To=0,Eo=0,_o=0,bo=0,Po=0,Io=0,Ao=0,Ro=0,wo=0,Mo=0,Oo=0,Do=0,ko=0,No=0,Lo=0,xo=0,Fo=0,Uo=0;var Vo=0,Ho=0,Bo=0,$o=0,jo=0,Go=0,Wo=0,qo=0,zo=0,Ko=0,Jo=0,Yo=0,Qo=0,Xo=0,Zo=0,el=0,tl=0,il=0,nl=0,rl=0;var sl=0,al=0,ol=0,ll=0,dl=0,cl=0,hl=0,ul=0,pl=0,gl=0,ml=0,fl=0,Sl=0,vl=0,yl=0,Cl=0,Tl=0,El=0,_l=0,bl=0;var Pl=0,Il=0,Al=0,Rl=0,wl=0,Ml=0,Ol=0,Dl=0,kl=0,Nl=0,Ll=0,xl=0,Fl=0,Ul=0,Vl=0,Hl=0,Bl=0,$l=0,jl=0,Gl=0;var Wl=0,ql=0,zl=0,Kl=0,Jl=0,Yl=0,Ql=0,Xl=0,Zl=0,ed=0,td=0,id=0,nd=0,rd=0,sd=0,ad=0,od=0,ld=0,dd=0,cd=0;var hd=0,ud=0,pd=0,gd=0,md=0,fd=0,Sd=0,vd=0,yd=0,Cd=0,Td=0,Ed=0,_d=0,bd=0,Pd=0,Id=0,Ad=0,Rd=0,wd=0,Md=0;var Od=0,Dd=0,kd=0,Nd=0,Ld=0,xd=0,Fd=0,Ud=0,Vd=0,Hd=0,Bd=0,$d=0,jd=0,Gd=0,Wd=0,qd=0,zd=0,Kd=0,Jd=0,Yd=0;var Qd=0,Xd=0,Zd=0,ec=0,tc=0,ic=0,nc=0,rc=0,sc=0,ac=0,oc=0,lc=0,dc=0,cc=0,hc=0,uc=0,pc=0,gc=0,mc=0,fc=0;var Sc=0,vc=0,yc=0,Cc=0,Tc=0,Ec=0,_c=0,bc=0,Pc=0,Ic=0,Ac=0,Rc=0,wc=0,Mc=0,Oc=0,Dc=0,kc=0,Nc=0,Lc=0,xc=0;var Fc=0,Uc=0,Vc=0,Hc=0,Bc=0,$c=0,jc=0,Gc=0,Wc=0,qc=0,zc=0,Kc=0,Jc=0,Yc=0,Qc=0,Xc=0,Zc=0,eh=0,th=0,ih=0;var nh=0,rh=0,sh=0,ah=0,oh=0,lh=0,dh=0,ch=0,hh=0,uh=0,ph=0,gh=0,mh=0,fh=0,Sh=0,vh=0,yh=0,Ch=0,Th=0,Eh=0;var _h=0,bh=0,Ph=0,Ih=0,Ah=0,Rh=0,wh=0,Mh=0,Oh=0,Dh=0,kh=0,Nh=0,Lh=0,xh=0,Fh=0,Uh=0,Vh=0,Hh=0,Bh=0,$h=0;var jh=0,Gh=0,Wh=0,qh=0,zh=0,Kh=0,Jh=0,Yh=0,Qh=0,Xh=0,Zh=0,eu=0,tu=0,iu=0,nu=0,ru=0,su=0,au=0,ou=0,lu=0;var du=0,cu=0,hu=0,uu=0,pu=0,gu=0,mu=0,fu=0,Su=0,vu=0,yu=0,Cu=0,Tu=0,Eu=0,_u=0,bu=0,Pu=0,Iu=0,Au=0,Ru=0;var wu=0,Mu=0,Ou=0,Du=0,ku=0,Nu=0,Lu=0,xu=0,Fu=0,Uu=0,Vu=0,Hu=0,Bu=0,$u=0,ju=0,Gu=0,Wu=0,qu=0,zu=0,Ku=0;var Ju=0,Yu=0,Qu=0,Xu=0,Zu=0,ep=0,tp=0,ip=0,np=0,rp=0,sp=0,ap=0,op=0,lp=0,dp=0,cp=0,hp=0,up=0,pp=0,gp=0;var mp=0,fp=0,Sp=0,vp=0,yp=0,Cp=0,Tp=0,Ep=0,_p=0,bp=0,Pp=0,Ip=0,Ap=0,Rp=0,wp=0,Mp=0,Op=0,Dp=0,kp=0,Np=0;var Lp=0,xp=0,Fp=0,Up=0,Vp=0,Hp=0,Bp=0,$p=0,jp=0,Gp=0,Wp=0,qp=0,zp=0,Kp=0,Jp=0,Yp=0,Qp=0,Xp=0,Zp=0,eg=0;var tg=0,ig=0,ng=0,rg=0,sg=0,ag=0,og=0,lg=0,dg=0,cg=0,hg=0,ug=0,pg=0,gg=0,mg=0,fg=0,Sg=0,vg=0,yg=0,Cg=0;var Tg=0,Eg=0,_g=0,bg=0,Pg=0,Ig=0,Ag=0,Rg=0,wg=0,Mg=0,Og=0,Dg=0,kg=0,Ng=0,Lg=0,xg=0,Fg=0,Ug=0,Vg=0,Hg=0;var Bg=0,$g=0,jg=0,Gg=0,Wg=0,qg=0,zg=0,Kg=0,Jg=0,Yg=0,Qg=0,Xg=0,Zg=0,em=0,tm=0,im=0,nm=0,rm=0,sm=0,am=0;var om=0,lm=0,dm=0,cm=0,hm=0,um=0,pm=0,gm=0,mm=0,fm=0,Sm=0,vm=0,ym=0,Cm=0,Tm=0,Em=0,_m=0,bm=0,Pm=0,Im=0;var Am=0,Rm=0,wm=0,Mm=0,Om=0,Dm=0,km=0,Nm=0,Lm=0,xm=0,Fm=0,Um=0,Vm=0,Hm=0,Bm=0,$m=0,jm=0,Gm=0,Wm=0,qm=0;var zm=0,Km=0,Jm=0,Ym=0,Qm=0,Xm=0,Zm=0,ef=0,tf=0,nf=0,rf=0,sf=0,af=0,of=0,lf=0,df=0,cf=0,hf=0,uf=0,pf=0;var gf=0,mf=0,ff=0,Sf=0,vf=0,yf=0,Cf=0,Tf=0,Ef=0,_f=0,bf=0,Pf=0,If=0,Af=0,Rf=0,wf=0,Mf=0,Of=0,Df=0,kf=0;var Nf=0,Lf=0,xf=0,Ff=0,Uf=0,Vf=0,Hf=0,Bf=0,$f=0,jf=0,Gf=0,Wf=0,qf=0,zf=0,Kf=0,Jf=0,Yf=0,Qf=0,Xf=0,Zf=0;var eS=0,tS=0,iS=0,nS=0,rS=0,sS=0,aS=0,oS=0,lS=0,dS=0,cS=0,hS=0,uS=0,pS=0,gS=0,mS=0,fS=0,SS=0,vS=0,yS=0;var CS=0,TS=0,ES=0,_S=0,bS=0,PS=0,IS=0,AS=0,RS=0,wS=0,MS=0,OS=0,DS=0,kS=0,NS=0,LS=0,xS=0,FS=0,US=0,VS=0;var HS=0,BS=0,$S=0,jS=0,GS=0,WS=0,qS=0,zS=0,KS=0,JS=0,YS=0,QS=0,XS=0,ZS=0,ev=0,tv=0,iv=0,nv=0,rv=0,sv=0;var av=0,ov=0,lv=0,dv=0,cv=0,hv=0,uv=0,pv=0,gv=0,mv=0,fv=0,Sv=0,vv=0,yv=0,Cv=0,Tv=0,Ev=0,_v=0,bv=0,Pv=0;var Iv=0,Av=0,Rv=0,wv=0,Mv=0,Ov=0,Dv=0,kv=0,Nv=0,Lv=0,xv=0,Fv=0,Uv=0,Vv=0,Hv=0,Bv=0,$v=0,jv=0,Gv=0,Wv=0;var qv=0,zv=0,Kv=0,Jv=0,Yv=0,Qv=0,Xv=0,Zv=0,ey=0,ty=0,iy=0,ny=0,ry=0,sy=0,ay=0,oy=0,ly=0,dy=0,cy=0,hy=0;var uy=0,py=0,gy=0,my=0,fy=0,Sy=0,vy=0,yy=0,Cy=0,Ty=0,Ey=0,_y=0,by=0,Py=0,Iy=0,Ay=0,Ry=0,wy=0,My=0,Oy=0;var Dy=0,ky=0,Ny=0,Ly=0,xy=0,Fy=0,Uy=0,Vy=0,Hy=0,By=0,$y=0,jy=0,Gy=0,Wy=0,qy=0,zy=0,Ky=0,Jy=0,Yy=0,Qy=0;var Xy=0;Xy=h;i=t;n=i;Pn=s[n>>2]|0;Rs=i+4|0;Do=Rs;Ld=s[Do>>2]|0;Uh=ii(0,Pn|0,32)|0;Bp=D;Gm=fi(Uh|0,Bp|0,Uh|0,Bp|0)|0;KS=D;r=e;ct=r;s[ct>>2]=Gm;Ht=r+4|0;Qt=Ht;s[Qt>>2]=KS;hi=t;_i=hi;Ni=s[_i>>2]|0;Wi=hi+4|0;nn=Wi;gn=s[nn>>2]|0;In=ii(0,Ni|0,31)|0;Fn=D;Kn=t+8|0;sr=Kn;fr=sr;Ar=s[fr>>2]|0;Ur=sr+4|0;Jr=Ur;as=s[Jr>>2]|0;Ss=ii(0,Ar|0,32)|0;ws=D;Hs=fi(Ss|0,ws|0,In|0,Fn|0)|0;Qs=D;la=e+8|0;ya=la;Ma=ya;s[Ma>>2]=Hs;Ba=ya+4|0;Xa=Ba;s[Xa>>2]=Qs;co=Kn;To=co;ko=s[To>>2]|0;Go=co+4|0;tl=Go;ul=s[tl>>2]|0;_l=ii(0,ko|0,32)|0;Nl=D;Wl=fi(_l|0,Nl|0,_l|0,Nl|0)|0;id=D;pd=t;bd=pd;xd=s[bd>>2]|0;zd=pd+4|0;rc=zd;mc=s[rc>>2]|0;Ic=ii(0,xd|0,32)|0;Fc=D;Kc=t+16|0;sh=Kc;fh=sh;Ah=s[fh>>2]|0;Vh=sh+4|0;Yh=Vh;ou=s[Yh>>2]|0;vu=ii(0,Ah|0,32)|0;wu=D;Hu=fi(vu|0,wu|0,Ic|0,Fc|0)|0;Qu=D;lp=ri(Hu|0,Qu|0,Wl|0,id|0)|0;yp=D;Mp=oi(lp|0,yp|0,1)|0;$p=D;Zp=e+16|0;cg=Zp;Tg=cg;s[Tg>>2]=Mp;Dg=cg+4|0;jg=Dg;s[jg>>2]=$p;em=Kn;hm=em;Em=s[hm>>2]|0;km=em+4|0;Wm=km;nf=s[Wm>>2]|0;gf=ii(0,Em|0,32)|0;Pf=D;xf=Kc;zf=xf;rS=s[zf>>2]|0;mS=xf+4|0;IS=mS;FS=s[IS>>2]|0;JS=ii(0,rS|0,32)|0;av=D;Sv=fi(JS|0,av|0,gf|0,Pf|0)|0;Rv=D;Vv=t;Yv=Vv;oy=s[Yv>>2]|0;vy=Vv+4|0;wy=vy;Hy=s[wy>>2]|0;a=ii(0,oy|0,32)|0;v=D;w=t+24|0;B=w;X=B;de=s[X>>2]|0;Ce=B+4|0;Oe=Ce;$e=s[Oe>>2]|0;Ze=ii(0,de|0,32)|0;ht=D;Et=fi(Ze|0,ht|0,a|0,v|0)|0;Dt=D;kt=ri(Et|0,Dt|0,Sv|0,Rv|0)|0;Nt=D;Lt=oi(kt|0,Nt|0,1)|0;xt=D;Ft=e+24|0;Ut=Ft;Vt=Ut;s[Vt>>2]=Lt;Bt=Ut+4|0;$t=Bt;s[$t>>2]=xt;jt=Kc;Gt=jt;Wt=s[Gt>>2]|0;qt=jt+4|0;zt=qt;Kt=s[zt>>2]|0;Jt=ii(0,Wt|0,32)|0;Yt=D;Xt=fi(Jt|0,Yt|0,Jt|0,Yt|0)|0;Zt=D;ei=Kn;ti=ei;ni=s[ti>>2]|0;si=ei+4|0;ai=si;li=s[ai>>2]|0;di=ii(0,ni|0,30)|0;ci=D;ui=w;pi=ui;gi=s[pi>>2]|0;mi=ui+4|0;Si=mi;vi=s[Si>>2]|0;yi=ii(0,gi|0,32)|0;Ci=D;Ti=fi(yi|0,Ci|0,di|0,ci|0)|0;Ei=D;bi=ri(Ti|0,Ei|0,Xt|0,Zt|0)|0;Pi=D;Ii=t;Ai=Ii;Ri=s[Ai>>2]|0;wi=Ii+4|0;Mi=wi;Oi=s[Mi>>2]|0;Di=ii(0,Ri|0,31)|0;ki=D;Li=t+32|0;xi=Li;Fi=xi;Ui=s[Fi>>2]|0;Vi=xi+4|0;Hi=Vi;Bi=s[Hi>>2]|0;$i=ii(0,Ui|0,32)|0;ji=D;Gi=fi($i|0,ji|0,Di|0,ki|0)|0;qi=D;zi=ri(bi|0,Pi|0,Gi|0,qi|0)|0;Ki=D;Ji=e+32|0;Yi=Ji;Qi=Yi;s[Qi>>2]=zi;Xi=Yi+4|0;Zi=Xi;s[Zi>>2]=Ki;en=Kc;tn=en;rn=s[tn>>2]|0;sn=en+4|0;an=sn;on=s[an>>2]|0;ln=ii(0,rn|0,32)|0;dn=D;cn=w;hn=cn;un=s[hn>>2]|0;pn=cn+4|0;mn=pn;fn=s[mn>>2]|0;Sn=ii(0,un|0,32)|0;vn=D;yn=fi(Sn|0,vn|0,ln|0,dn|0)|0;Cn=D;Tn=Kn;En=Tn;_n=s[En>>2]|0;bn=Tn+4|0;An=bn;Rn=s[An>>2]|0;wn=ii(0,_n|0,32)|0;Mn=D;On=Li;Dn=On;kn=s[Dn>>2]|0;Nn=On+4|0;Ln=Nn;xn=s[Ln>>2]|0;Un=ii(0,kn|0,32)|0;Vn=D;Hn=fi(Un|0,Vn|0,wn|0,Mn|0)|0;Bn=D;$n=ri(Hn|0,Bn|0,yn|0,Cn|0)|0;jn=D;Gn=t;Wn=Gn;qn=s[Wn>>2]|0;zn=Gn+4|0;Jn=zn;Yn=s[Jn>>2]|0;Qn=ii(0,qn|0,32)|0;Xn=D;Zn=t+40|0;er=Zn;tr=er;ir=s[tr>>2]|0;nr=er+4|0;rr=nr;ar=s[rr>>2]|0;or=ii(0,ir|0,32)|0;lr=D;dr=fi(or|0,lr|0,Qn|0,Xn|0)|0;cr=D;hr=ri($n|0,jn|0,dr|0,cr|0)|0;ur=D;pr=oi(hr|0,ur|0,1)|0;gr=D;mr=e+40|0;Sr=mr;vr=Sr;s[vr>>2]=pr;yr=Sr+4|0;Cr=yr;s[Cr>>2]=gr;Tr=w;Er=Tr;_r=s[Er>>2]|0;br=Tr+4|0;Pr=br;Ir=s[Pr>>2]|0;Rr=ii(0,_r|0,32)|0;wr=D;Mr=fi(Rr|0,wr|0,Rr|0,wr|0)|0;Or=D;Dr=Kc;kr=Dr;Nr=s[kr>>2]|0;Lr=Dr+4|0;xr=Lr;Fr=s[xr>>2]|0;Vr=ii(0,Nr|0,32)|0;Hr=D;Br=Li;$r=Br;jr=s[$r>>2]|0;Gr=Br+4|0;Wr=Gr;qr=s[Wr>>2]|0;zr=ii(0,jr|0,32)|0;Kr=D;Yr=fi(zr|0,Kr|0,Vr|0,Hr|0)|0;Qr=D;Xr=ri(Yr|0,Qr|0,Mr|0,Or|0)|0;Zr=D;es=t;ts=es;is=s[ts>>2]|0;ns=es+4|0;rs=ns;ss=s[rs>>2]|0;os=ii(0,is|0,32)|0;ls=D;ds=t+48|0;cs=ds;hs=cs;us=s[hs>>2]|0;ps=cs+4|0;gs=ps;ms=s[gs>>2]|0;fs=ii(0,us|0,32)|0;vs=D;ys=fi(fs|0,vs|0,os|0,ls|0)|0;Cs=D;Ts=ri(Xr|0,Zr|0,ys|0,Cs|0)|0;Es=D;_s=Kn;bs=_s;Ps=s[bs>>2]|0;Is=_s+4|0;As=Is;Ms=s[As>>2]|0;Os=ii(0,Ps|0,31)|0;Ds=D;ks=Zn;Ns=ks;Ls=s[Ns>>2]|0;xs=ks+4|0;Fs=xs;Us=s[Fs>>2]|0;Vs=ii(0,Ls|0,32)|0;Bs=D;$s=fi(Vs|0,Bs|0,Os|0,Ds|0)|0;js=D;Gs=ri(Ts|0,Es|0,$s|0,js|0)|0;Ws=D;qs=oi(Gs|0,Ws|0,1)|0;zs=D;Ks=e+48|0;Js=Ks;Ys=Js;s[Ys>>2]=qs;Xs=Js+4|0;Zs=Xs;s[Zs>>2]=zs;ea=w;ta=ea;ia=s[ta>>2]|0;na=ea+4|0;ra=na;sa=s[ra>>2]|0;aa=ii(0,ia|0,32)|0;oa=D;da=Li;ca=da;ha=s[ca>>2]|0;ua=da+4|0;pa=ua;ga=s[pa>>2]|0;ma=ii(0,ha|0,32)|0;fa=D;Sa=fi(ma|0,fa|0,aa|0,oa|0)|0;va=D;Ca=Kc;Ta=Ca;Ea=s[Ta>>2]|0;_a=Ca+4|0;ba=_a;Pa=s[ba>>2]|0;Ia=ii(0,Ea|0,32)|0;Aa=D;Ra=Zn;wa=Ra;Oa=s[wa>>2]|0;Da=Ra+4|0;ka=Da;Na=s[ka>>2]|0;La=ii(0,Oa|0,32)|0;xa=D;Fa=fi(La|0,xa|0,Ia|0,Aa|0)|0;Ua=D;Va=ri(Fa|0,Ua|0,Sa|0,va|0)|0;Ha=D;$a=Kn;ja=$a;Ga=s[ja>>2]|0;Wa=$a+4|0;qa=Wa;za=s[qa>>2]|0;Ka=ii(0,Ga|0,32)|0;Ja=D;Ya=ds;Qa=Ya;Za=s[Qa>>2]|0;eo=Ya+4|0;to=eo;io=s[to>>2]|0;no=ii(0,Za|0,32)|0;ro=D;so=fi(no|0,ro|0,Ka|0,Ja|0)|0;ao=D;oo=ri(Va|0,Ha|0,so|0,ao|0)|0;lo=D;ho=t;uo=ho;po=s[uo>>2]|0;go=ho+4|0;mo=go;fo=s[mo>>2]|0;So=ii(0,po|0,32)|0;vo=D;yo=t+56|0;Co=yo;Eo=Co;_o=s[Eo>>2]|0;bo=Co+4|0;Po=bo;Io=s[Po>>2]|0;Ao=ii(0,_o|0,32)|0;Ro=D;wo=fi(Ao|0,Ro|0,So|0,vo|0)|0;Mo=D;Oo=ri(oo|0,lo|0,wo|0,Mo|0)|0;No=D;Lo=oi(Oo|0,No|0,1)|0;xo=D;Fo=e+56|0;Uo=Fo;Vo=Uo;s[Vo>>2]=Lo;Ho=Uo+4|0;Bo=Ho;s[Bo>>2]=xo;$o=Li;jo=$o;Wo=s[jo>>2]|0;qo=$o+4|0;zo=qo;Ko=s[zo>>2]|0;Jo=ii(0,Wo|0,32)|0;Yo=D;Qo=fi(Jo|0,Yo|0,Jo|0,Yo|0)|0;Xo=D;Zo=Kc;el=Zo;il=s[el>>2]|0;nl=Zo+4|0;rl=nl;sl=s[rl>>2]|0;al=ii(0,il|0,32)|0;ol=D;ll=ds;dl=ll;cl=s[dl>>2]|0;hl=ll+4|0;pl=hl;gl=s[pl>>2]|0;ml=ii(0,cl|0,32)|0;fl=D;Sl=fi(ml|0,fl|0,al|0,ol|0)|0;vl=D;yl=t;Cl=yl;Tl=s[Cl>>2]|0;El=yl+4|0;bl=El;Pl=s[bl>>2]|0;Il=ii(0,Tl|0,32)|0;Al=D;Rl=t+64|0;wl=Rl;Ml=wl;Ol=s[Ml>>2]|0;Dl=wl+4|0;kl=Dl;Ll=s[kl>>2]|0;xl=ii(0,Ol|0,32)|0;Fl=D;Ul=fi(xl|0,Fl|0,Il|0,Al|0)|0;Vl=D;Hl=ri(Ul|0,Vl|0,Sl|0,vl|0)|0;Bl=D;$l=Kn;jl=$l;Gl=s[jl>>2]|0;ql=$l+4|0;zl=ql;Kl=s[zl>>2]|0;Jl=ii(0,Gl|0,32)|0;Yl=D;Ql=yo;Xl=Ql;Zl=s[Xl>>2]|0;ed=Ql+4|0;td=ed;nd=s[td>>2]|0;rd=ii(0,Zl|0,32)|0;sd=D;ad=fi(rd|0,sd|0,Jl|0,Yl|0)|0;od=D;ld=w;dd=ld;cd=s[dd>>2]|0;hd=ld+4|0;ud=hd;gd=s[ud>>2]|0;md=ii(0,cd|0,32)|0;fd=D;Sd=Zn;vd=Sd;yd=s[vd>>2]|0;Cd=Sd+4|0;Td=Cd;Ed=s[Td>>2]|0;_d=ii(0,yd|0,32)|0;Pd=D;Id=fi(_d|0,Pd|0,md|0,fd|0)|0;Ad=D;Rd=ri(Id|0,Ad|0,ad|0,od|0)|0;wd=D;Md=oi(Rd|0,wd|0,1)|0;Od=D;Dd=ri(Hl|0,Bl|0,Md|0,Od|0)|0;kd=D;Nd=oi(Dd|0,kd|0,1)|0;Fd=D;Ud=ri(Nd|0,Fd|0,Qo|0,Xo|0)|0;Vd=D;Hd=e+64|0;Bd=Hd;$d=Bd;s[$d>>2]=Ud;jd=Bd+4|0;Gd=jd;s[Gd>>2]=Vd;Wd=Li;qd=Wd;Kd=s[qd>>2]|0;Jd=Wd+4|0;Yd=Jd;Qd=s[Yd>>2]|0;Xd=ii(0,Kd|0,32)|0;Zd=D;ec=Zn;tc=ec;ic=s[tc>>2]|0;nc=ec+4|0;sc=nc;ac=s[sc>>2]|0;oc=ii(0,ic|0,32)|0;lc=D;dc=fi(oc|0,lc|0,Xd|0,Zd|0)|0;cc=D;hc=w;uc=hc;pc=s[uc>>2]|0;gc=hc+4|0;fc=gc;Sc=s[fc>>2]|0;vc=ii(0,pc|0,32)|0;yc=D;Cc=ds;Tc=Cc;Ec=s[Tc>>2]|0;_c=Cc+4|0;bc=_c;Pc=s[bc>>2]|0;Ac=ii(0,Ec|0,32)|0;Rc=D;wc=fi(Ac|0,Rc|0,vc|0,yc|0)|0;Mc=D;Oc=ri(wc|0,Mc|0,dc|0,cc|0)|0;Dc=D;kc=Kc;Nc=kc;Lc=s[Nc>>2]|0;xc=kc+4|0;Uc=xc;Vc=s[Uc>>2]|0;Hc=ii(0,Lc|0,32)|0;Bc=D;$c=yo;jc=$c;Gc=s[jc>>2]|0;Wc=$c+4|0;qc=Wc;zc=s[qc>>2]|0;Jc=ii(0,Gc|0,32)|0;Yc=D;Qc=fi(Jc|0,Yc|0,Hc|0,Bc|0)|0;Xc=D;Zc=ri(Oc|0,Dc|0,Qc|0,Xc|0)|0;eh=D;th=Kn;ih=th;nh=s[ih>>2]|0;rh=th+4|0;ah=rh;oh=s[ah>>2]|0;lh=ii(0,nh|0,32)|0;dh=D;ch=Rl;hh=ch;uh=s[hh>>2]|0;ph=ch+4|0;gh=ph;mh=s[gh>>2]|0;Sh=ii(0,uh|0,32)|0;vh=D;yh=fi(Sh|0,vh|0,lh|0,dh|0)|0;Ch=D;Th=ri(Zc|0,eh|0,yh|0,Ch|0)|0;Eh=D;_h=t;bh=_h;Ph=s[bh>>2]|0;Ih=_h+4|0;Rh=Ih;wh=s[Rh>>2]|0;Mh=ii(0,Ph|0,32)|0;Oh=D;Dh=t+72|0;kh=Dh;Nh=kh;Lh=s[Nh>>2]|0;xh=kh+4|0;Fh=xh;Hh=s[Fh>>2]|0;Bh=ii(0,Lh|0,32)|0;$h=D;jh=fi(Bh|0,$h|0,Mh|0,Oh|0)|0;Gh=D;Wh=ri(Th|0,Eh|0,jh|0,Gh|0)|0;qh=D;zh=oi(Wh|0,qh|0,1)|0;Kh=D;Jh=e+72|0;Qh=Jh;Xh=Qh;s[Xh>>2]=zh;Zh=Qh+4|0;eu=Zh;s[eu>>2]=Kh;tu=Zn;iu=tu;nu=s[iu>>2]|0;ru=tu+4|0;su=ru;au=s[su>>2]|0;lu=ii(0,nu|0,32)|0;du=D;cu=fi(lu|0,du|0,lu|0,du|0)|0;hu=D;uu=Li;pu=uu;gu=s[pu>>2]|0;mu=uu+4|0;fu=mu;Su=s[fu>>2]|0;yu=ii(0,gu|0,32)|0;Cu=D;Tu=ds;Eu=Tu;_u=s[Eu>>2]|0;bu=Tu+4|0;Pu=bu;Iu=s[Pu>>2]|0;Au=ii(0,_u|0,32)|0;Ru=D;Mu=fi(Au|0,Ru|0,yu|0,Cu|0)|0;Ou=D;Du=ri(Mu|0,Ou|0,cu|0,hu|0)|0;ku=D;Nu=Kc;Lu=Nu;xu=s[Lu>>2]|0;Fu=Nu+4|0;Uu=Fu;Vu=s[Uu>>2]|0;Bu=ii(0,xu|0,32)|0;$u=D;ju=Rl;Gu=ju;Wu=s[Gu>>2]|0;qu=ju+4|0;zu=qu;Ku=s[zu>>2]|0;Ju=ii(0,Wu|0,32)|0;Yu=D;Xu=fi(Ju|0,Yu|0,Bu|0,$u|0)|0;Zu=D;ep=ri(Du|0,ku|0,Xu|0,Zu|0)|0;tp=D;ip=w;np=ip;rp=s[np>>2]|0;sp=ip+4|0;ap=sp;op=s[ap>>2]|0;dp=ii(0,rp|0,32)|0;cp=D;hp=yo;up=hp;pp=s[up>>2]|0;gp=hp+4|0;mp=gp;fp=s[mp>>2]|0;Sp=ii(0,pp|0,32)|0;vp=D;Cp=fi(Sp|0,vp|0,dp|0,cp|0)|0;Tp=D;Ep=Kn;_p=Ep;bp=s[_p>>2]|0;Pp=Ep+4|0;Ip=Pp;Ap=s[Ip>>2]|0;Rp=ii(0,bp|0,32)|0;wp=D;Op=Dh;Dp=Op;kp=s[Dp>>2]|0;Np=Op+4|0;Lp=Np;xp=s[Lp>>2]|0;Fp=ii(0,kp|0,32)|0;Up=D;Vp=fi(Fp|0,Up|0,Rp|0,wp|0)|0;Hp=D;jp=ri(Vp|0,Hp|0,Cp|0,Tp|0)|0;Gp=D;Wp=oi(jp|0,Gp|0,1)|0;qp=D;zp=ri(ep|0,tp|0,Wp|0,qp|0)|0;Kp=D;Jp=oi(zp|0,Kp|0,1)|0;Yp=D;Qp=e+80|0;Xp=Qp;eg=Xp;s[eg>>2]=Jp;tg=Xp+4|0;ig=tg;s[ig>>2]=Yp;ng=Zn;rg=ng;sg=s[rg>>2]|0;ag=ng+4|0;og=ag;lg=s[og>>2]|0;dg=ii(0,sg|0,32)|0;hg=D;ug=ds;pg=ug;gg=s[pg>>2]|0;mg=ug+4|0;fg=mg;Sg=s[fg>>2]|0;vg=ii(0,gg|0,32)|0;yg=D;Cg=fi(vg|0,yg|0,dg|0,hg|0)|0;Eg=D;_g=Li;bg=_g;Pg=s[bg>>2]|0;Ig=_g+4|0;Ag=Ig;Rg=s[Ag>>2]|0;wg=ii(0,Pg|0,32)|0;Mg=D;Og=yo;kg=Og;Ng=s[kg>>2]|0;Lg=Og+4|0;xg=Lg;Fg=s[xg>>2]|0;Ug=ii(0,Ng|0,32)|0;Vg=D;Hg=fi(Ug|0,Vg|0,wg|0,Mg|0)|0;Bg=D;$g=ri(Hg|0,Bg|0,Cg|0,Eg|0)|0;Gg=D;Wg=w;qg=Wg;zg=s[qg>>2]|0;Kg=Wg+4|0;Jg=Kg;Yg=s[Jg>>2]|0;Qg=ii(0,zg|0,32)|0;Xg=D;Zg=Rl;tm=Zg;im=s[tm>>2]|0;nm=Zg+4|0;rm=nm;sm=s[rm>>2]|0;am=ii(0,im|0,32)|0;om=D;lm=fi(am|0,om|0,Qg|0,Xg|0)|0;dm=D;cm=ri($g|0,Gg|0,lm|0,dm|0)|0;um=D;pm=Kc;gm=pm;mm=s[gm>>2]|0;fm=pm+4|0;Sm=fm;vm=s[Sm>>2]|0;ym=ii(0,mm|0,32)|0;Cm=D;Tm=Dh;_m=Tm;bm=s[_m>>2]|0;Pm=Tm+4|0;Im=Pm;Am=s[Im>>2]|0;Rm=ii(0,bm|0,32)|0;wm=D;Mm=fi(Rm|0,wm|0,ym|0,Cm|0)|0;Om=D;Dm=ri(cm|0,um|0,Mm|0,Om|0)|0;Nm=D;Lm=oi(Dm|0,Nm|0,1)|0;xm=D;Fm=e+88|0;Um=Fm;Vm=Um;s[Vm>>2]=Lm;Hm=Um+4|0;Bm=Hm;s[Bm>>2]=xm;$m=ds;jm=$m;qm=s[jm>>2]|0;zm=$m+4|0;Km=zm;Jm=s[Km>>2]|0;Ym=ii(0,qm|0,32)|0;Qm=D;Xm=fi(Ym|0,Qm|0,Ym|0,Qm|0)|0;Zm=D;ef=Li;tf=ef;rf=s[tf>>2]|0;sf=ef+4|0;af=sf;of=s[af>>2]|0;lf=ii(0,rf|0,32)|0;df=D;cf=Rl;hf=cf;uf=s[hf>>2]|0;pf=cf+4|0;mf=pf;ff=s[mf>>2]|0;Sf=ii(0,uf|0,32)|0;vf=D;yf=fi(Sf|0,vf|0,lf|0,df|0)|0;Cf=D;Tf=Zn;Ef=Tf;_f=s[Ef>>2]|0;bf=Tf+4|0;If=bf;Af=s[If>>2]|0;Rf=ii(0,_f|0,32)|0;wf=D;Mf=yo;Of=Mf;Df=s[Of>>2]|0;kf=Mf+4|0;Nf=kf;Lf=s[Nf>>2]|0;Ff=ii(0,Df|0,32)|0;Uf=D;Vf=fi(Ff|0,Uf|0,Rf|0,wf|0)|0;Hf=D;Bf=w;$f=Bf;jf=s[$f>>2]|0;Gf=Bf+4|0;Wf=Gf;qf=s[Wf>>2]|0;Kf=ii(0,jf|0,32)|0;Jf=D;Yf=Dh;Qf=Yf;Xf=s[Qf>>2]|0;Zf=Yf+4|0;eS=Zf;tS=s[eS>>2]|0;iS=ii(0,Xf|0,32)|0;nS=D;sS=fi(iS|0,nS|0,Kf|0,Jf|0)|0;aS=D;oS=ri(sS|0,aS|0,Vf|0,Hf|0)|0;lS=D;dS=oi(oS|0,lS|0,1)|0;cS=D;hS=ri(dS|0,cS|0,yf|0,Cf|0)|0;uS=D;pS=oi(hS|0,uS|0,1)|0;gS=D;fS=ri(pS|0,gS|0,Xm|0,Zm|0)|0;SS=D;vS=e+96|0;yS=vS;CS=yS;s[CS>>2]=fS;TS=yS+4|0;ES=TS;s[ES>>2]=SS;_S=ds;bS=_S;PS=s[bS>>2]|0;AS=_S+4|0;RS=AS;wS=s[RS>>2]|0;MS=ii(0,PS|0,32)|0;OS=D;DS=yo;kS=DS;NS=s[kS>>2]|0;LS=DS+4|0;xS=LS;US=s[xS>>2]|0;VS=ii(0,NS|0,32)|0;HS=D;BS=fi(VS|0,HS|0,MS|0,OS|0)|0;$S=D;jS=Zn;GS=jS;WS=s[GS>>2]|0;qS=jS+4|0;zS=qS;YS=s[zS>>2]|0;QS=ii(0,WS|0,32)|0;XS=D;ZS=Rl;ev=ZS;tv=s[ev>>2]|0;iv=ZS+4|0;nv=iv;rv=s[nv>>2]|0;sv=ii(0,tv|0,32)|0;ov=D;lv=fi(sv|0,ov|0,QS|0,XS|0)|0;dv=D;cv=ri(lv|0,dv|0,BS|0,$S|0)|0;hv=D;uv=Li;pv=uv;gv=s[pv>>2]|0;mv=uv+4|0;fv=mv;vv=s[fv>>2]|0;yv=ii(0,gv|0,32)|0;Cv=D;Tv=Dh;Ev=Tv;_v=s[Ev>>2]|0;bv=Tv+4|0;Pv=bv;Iv=s[Pv>>2]|0;Av=ii(0,_v|0,32)|0;wv=D;Mv=fi(Av|0,wv|0,yv|0,Cv|0)|0;Ov=D;Dv=ri(cv|0,hv|0,Mv|0,Ov|0)|0;kv=D;Nv=oi(Dv|0,kv|0,1)|0;Lv=D;xv=e+104|0;Fv=xv;Uv=Fv;s[Uv>>2]=Nv;Hv=Fv+4|0;Bv=Hv;s[Bv>>2]=Lv;$v=yo;jv=$v;Gv=s[jv>>2]|0;Wv=$v+4|0;qv=Wv;zv=s[qv>>2]|0;Kv=ii(0,Gv|0,32)|0;Jv=D;Qv=fi(Kv|0,Jv|0,Kv|0,Jv|0)|0;Xv=D;Zv=ds;ey=Zv;ty=s[ey>>2]|0;iy=Zv+4|0;ny=iy;ry=s[ny>>2]|0;sy=ii(0,ty|0,32)|0;ay=D;ly=Rl;dy=ly;cy=s[dy>>2]|0;hy=ly+4|0;uy=hy;py=s[uy>>2]|0;gy=ii(0,cy|0,32)|0;my=D;fy=fi(gy|0,my|0,sy|0,ay|0)|0;Sy=D;yy=ri(fy|0,Sy|0,Qv|0,Xv|0)|0;Cy=D;Ty=Zn;Ey=Ty;_y=s[Ey>>2]|0;by=Ty+4|0;Py=by;Iy=s[Py>>2]|0;Ay=ii(0,_y|0,31)|0;Ry=D;My=Dh;Oy=My;Dy=s[Oy>>2]|0;ky=My+4|0;Ny=ky;Ly=s[Ny>>2]|0;xy=ii(0,Dy|0,32)|0;Fy=D;Uy=fi(xy|0,Fy|0,Ay|0,Ry|0)|0;Vy=D;By=ri(yy|0,Cy|0,Uy|0,Vy|0)|0;$y=D;jy=oi(By|0,$y|0,1)|0;Gy=D;Wy=e+112|0;qy=Wy;zy=qy;s[zy>>2]=jy;Ky=qy+4|0;Jy=Ky;s[Jy>>2]=Gy;Yy=yo;o=Yy;l=s[o>>2]|0;d=Yy+4|0;c=d;u=s[c>>2]|0;p=ii(0,l|0,32)|0;g=D;m=Rl;f=m;S=s[f>>2]|0;y=m+4|0;C=y;T=s[C>>2]|0;E=ii(0,S|0,32)|0;_=D;b=fi(E|0,_|0,p|0,g|0)|0;P=D;I=ds;A=I;R=s[A>>2]|0;M=I+4|0;O=M;k=s[O>>2]|0;N=ii(0,R|0,32)|0;L=D;x=Dh;F=x;U=s[F>>2]|0;V=x+4|0;H=V;$=s[H>>2]|0;j=ii(0,U|0,32)|0;G=D;W=fi(j|0,G|0,N|0,L|0)|0;q=D;z=ri(W|0,q|0,b|0,P|0)|0;K=D;J=oi(z|0,K|0,1)|0;Y=D;Q=e+120|0;Z=Q;ee=Z;s[ee>>2]=J;te=Z+4|0;ie=te;s[ie>>2]=Y;ne=Rl;re=ne;se=s[re>>2]|0;ae=ne+4|0;oe=ae;le=s[oe>>2]|0;ce=ii(0,se|0,32)|0;he=D;ue=fi(ce|0,he|0,ce|0,he|0)|0;pe=D;ge=yo;me=ge;fe=s[me>>2]|0;Se=ge+4|0;ve=Se;ye=s[ve>>2]|0;Te=ii(0,fe|0,30)|0;Ee=D;_e=Dh;be=_e;Pe=s[be>>2]|0;Ie=_e+4|0;Ae=Ie;Re=s[Ae>>2]|0;we=ii(0,Pe|0,32)|0;Me=D;De=fi(we|0,Me|0,Te|0,Ee|0)|0;ke=D;Ne=ri(De|0,ke|0,ue|0,pe|0)|0;Le=D;xe=e+128|0;Fe=xe;Ue=Fe;s[Ue>>2]=Ne;Ve=Fe+4|0;He=Ve;s[He>>2]=Le;Be=Rl;je=Be;Ge=s[je>>2]|0;We=Be+4|0;qe=We;ze=s[qe>>2]|0;Ke=ii(0,Ge|0,31)|0;Je=D;Ye=Dh;Qe=Ye;Xe=s[Qe>>2]|0;et=Ye+4|0;tt=et;it=s[tt>>2]|0;nt=ii(0,Xe|0,32)|0;rt=D;st=fi(nt|0,rt|0,Ke|0,Je|0)|0;at=D;ot=e+136|0;lt=ot;dt=lt;s[dt>>2]=st;ut=lt+4|0;pt=ut;s[pt>>2]=at;gt=Dh;mt=gt;ft=s[mt>>2]|0;St=gt+4|0;vt=St;yt=s[vt>>2]|0;Ct=ii(0,ft|0,32)|0;Tt=D;_t=ii(0,ft|0,31)|0;bt=D;Pt=fi(_t|0,bt|0,Ct|0,Tt|0)|0;It=D;At=e+144|0;Rt=At;wt=Rt;s[wt>>2]=Pt;Mt=Rt+4|0;Ot=Mt;s[Ot>>2]=It;h=Xy;return}function Ke(e,t){e=e|0;t=t|0;var i=0,n=0,r=0,s=0,a=0,o=0,l=0,d=0;d=h;i=t>>31;n=i>>>6;r=ri(n|0,0,e|0,t|0)|0;s=D;a=ii(r|0,s|0,26)|0;o=D;D=o;h=d;return a|0}function Je(e,t){e=e|0;t=t|0;var i=0,n=0,r=0,s=0,a=0,o=0,l=0,d=0;d=h;i=t>>31;n=i>>>7;r=ri(n|0,0,e|0,t|0)|0;s=D;a=ii(r|0,s|0,25)|0;o=D;D=o;h=d;return a|0}function Ye(e){e=e|0;var t=0,i=0,n=0,r=0;n=h;t=e+0|0;r=t+40|0;do{s[t>>2]=0|0;t=t+4|0}while((t|0)<(r|0));h=n;return}function Qe(e){e=e|0;var t=0,i=0,n=0,r=0,a=0;r=h;s[e>>2]=1;t=e+4|0;i=t+0|0;a=i+36|0;do{s[i>>2]=0|0;i=i+4|0}while((i|0)<(a|0));h=r;return}function Xe(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,r=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0,b=0;var P=0,I=0,A=0,R=0,w=0,M=0,O=0,D=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0,j=0,G=0;var W=0,q=0,z=0,K=0,J=0,Y=0,Q=0,X=0,Z=0,ee=0,te=0,ie=0,ne=0,re=0,se=0,ae=0,oe=0,le=0,de=0;de=h;n=s[t>>2]|0;r=t+4|0;S=s[r>>2]|0;R=t+8|0;V=s[R>>2]|0;Y=t+12|0;re=s[Y>>2]|0;se=t+16|0;ae=s[se>>2]|0;oe=t+20|0;a=s[oe>>2]|0;o=t+24|0;l=s[o>>2]|0;d=t+28|0;c=s[d>>2]|0;u=t+32|0;p=s[u>>2]|0;g=t+36|0;m=s[g>>2]|0;f=s[i>>2]|0;v=i+4|0;y=s[v>>2]|0;C=i+8|0;T=s[C>>2]|0;E=i+12|0;_=s[E>>2]|0;b=i+16|0;P=s[b>>2]|0;I=i+20|0;A=s[I>>2]|0;w=i+24|0;M=s[w>>2]|0;O=i+28|0;D=s[O>>2]|0;k=i+32|0;N=s[k>>2]|0;L=i+36|0;x=s[L>>2]|0;F=f+n|0;U=y+S|0;H=T+V|0;B=_+re|0;$=P+ae|0;j=A+a|0;G=M+l|0;W=D+c|0;q=N+p|0;z=x+m|0;s[e>>2]=F;K=e+4|0;s[K>>2]=U;J=e+8|0;s[J>>2]=H;Q=e+12|0;s[Q>>2]=B;X=e+16|0;s[X>>2]=$;Z=e+20|0;s[Z>>2]=j;ee=e+24|0;s[ee>>2]=G;te=e+28|0;s[te>>2]=W;ie=e+32|0;s[ie>>2]=q;ne=e+36|0;s[ne>>2]=z;h=de;return}function Ze(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,r=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0,b=0;var P=0,I=0,A=0,R=0,w=0,M=0,O=0,D=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0,j=0,G=0;var W=0,q=0,z=0,K=0,J=0,Y=0,Q=0,X=0,Z=0,ee=0,te=0,ie=0,ne=0,re=0,se=0,ae=0,oe=0,le=0,de=0,ce=0;var he=0,ue=0,pe=0,ge=0,me=0,fe=0,Se=0,ve=0,ye=0,Ce=0,Te=0;Te=h;n=s[e>>2]|0;r=e+4|0;S=s[r>>2]|0;R=e+8|0;V=s[R>>2]|0;Y=e+12|0;oe=s[Y>>2]|0;Se=e+16|0;ve=s[Se>>2]|0;ye=e+20|0;a=s[ye>>2]|0;o=e+24|0;l=s[o>>2]|0;d=e+28|0;c=s[d>>2]|0;u=e+32|0;p=s[u>>2]|0;g=e+36|0;m=s[g>>2]|0;f=s[t>>2]|0;v=t+4|0;y=s[v>>2]|0;C=t+8|0;T=s[C>>2]|0;E=t+12|0;_=s[E>>2]|0;b=t+16|0;P=s[b>>2]|0;I=t+20|0;A=s[I>>2]|0;w=t+24|0;M=s[w>>2]|0;O=t+28|0;D=s[O>>2]|0;k=t+32|0;N=s[k>>2]|0;L=t+36|0;x=s[L>>2]|0;F=f^n;U=y^S;H=T^V;B=_^oe;$=P^ve;j=A^a;G=M^l;W=D^c;q=N^p;z=x^m;K=0-i|0;J=F&K;Q=U&K;X=H&K;Z=B&K;ee=$&K;te=j&K;ie=G&K;ne=W&K;re=q&K;se=z&K;ae=J^n;s[e>>2]=ae;le=Q^S;s[r>>2]=le;de=X^V;s[R>>2]=de;ce=Z^oe;s[Y>>2]=ce;he=ee^ve;s[Se>>2]=he;ue=te^a;s[ye>>2]=ue;pe=ie^l;s[o>>2]=pe;ge=ne^c;s[d>>2]=ge;me=re^p;s[u>>2]=me;fe=se^m;s[g>>2]=fe;h=Te;return}function et(e,t){e=e|0;t=t|0;var i=0,n=0,r=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0;var b=0,P=0,I=0,A=0,R=0,w=0,M=0,O=0,D=0,k=0;k=h;i=s[t>>2]|0;n=t+4|0;f=s[n>>2]|0;P=t+8|0;I=s[P>>2]|0;A=t+12|0;R=s[A>>2]|0;w=t+16|0;M=s[w>>2]|0;O=t+20|0;r=s[O>>2]|0;a=t+24|0;o=s[a>>2]|0;l=t+28|0;d=s[l>>2]|0;c=t+32|0;u=s[c>>2]|0;p=t+36|0;g=s[p>>2]|0;s[e>>2]=i;m=e+4|0;s[m>>2]=f;S=e+8|0;s[S>>2]=I;v=e+12|0;s[v>>2]=R;y=e+16|0;s[y>>2]=M;C=e+20|0;s[C>>2]=r;T=e+24|0;s[T>>2]=o;E=e+28|0;s[E>>2]=d;_=e+32|0;s[_>>2]=u;b=e+36|0;s[b>>2]=g;h=k;return}function tt(e,t){e=e|0;t=t|0;var i=0,n=0,r=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0;var b=0,P=0,I=0,A=0,R=0,w=0,M=0,O=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0,j=0,G=0;var W=0,q=0,z=0,K=0,J=0,Y=0,Q=0,X=0,Z=0,ee=0,te=0,ie=0,ne=0,re=0,se=0,ae=0,oe=0,le=0,de=0,ce=0;var he=0,ue=0,pe=0,ge=0,me=0,fe=0,Se=0,ve=0,ye=0,Ce=0,Te=0,Ee=0,_e=0,be=0,Pe=0,Ie=0,Ae=0,Re=0,we=0,Me=0;var Oe=0,De=0,ke=0,Ne=0,Le=0,xe=0,Fe=0,Ue=0,Ve=0,He=0,Be=0,$e=0,je=0,Ge=0,We=0,qe=0,ze=0,Ke=0,Je=0,Ye=0;var Qe=0,Xe=0,Ze=0,et=0,tt=0,rt=0,st=0,at=0,ot=0,lt=0,dt=0,ct=0,ht=0,ut=0,pt=0,gt=0,mt=0,ft=0,St=0,vt=0;var yt=0,Ct=0,Tt=0,Et=0,_t=0,bt=0,Pt=0,It=0,At=0,Rt=0,wt=0,Mt=0,Ot=0,Dt=0,kt=0,Nt=0,Lt=0,xt=0,Ft=0,Ut=0;var Vt=0,Ht=0,Bt=0,$t=0,jt=0,Gt=0,Wt=0,qt=0,zt=0,Kt=0,Jt=0,Yt=0,Qt=0,Xt=0,Zt=0,ei=0,ti=0,si=0,li=0;li=h;i=it(t)|0;n=D;Ce=t+4|0;Oe=nt(Ce)|0;$e=D;Ze=oi(Oe|0,$e|0,6)|0;ut=D;_t=t+7|0;Nt=nt(_t)|0;Wt=D;r=oi(Nt|0,Wt|0,5)|0;S=D;R=t+10|0;H=nt(R)|0;Q=D;le=oi(H|0,Q|0,3)|0;fe=D;Se=t+13|0;ve=nt(Se)|0;ye=D;Te=oi(ve|0,ye|0,2)|0;Ee=D;_e=t+16|0;be=it(_e)|0;Pe=D;Ie=t+20|0;Ae=nt(Ie)|0;Re=D;we=oi(Ae|0,Re|0,7)|0;Me=D;De=t+23|0;ke=nt(De)|0;Ne=D;Le=oi(ke|0,Ne|0,5)|0;xe=D;Fe=t+26|0;Ue=nt(Fe)|0;Ve=D;He=oi(Ue|0,Ve|0,4)|0;Be=D;je=t+29|0;Ge=nt(je)|0;We=D;qe=oi(Ge|0,We|0,2)|0;ze=D;Ke=qe&33554428;Je=ri(Ke|0,0,16777216,0)|0;Ye=D;Qe=ai(Je|0,Ye|0,25)|0;Xe=D;et=fi(Qe|0,Xe|0,19,0)|0;tt=D;rt=ri(et|0,tt|0,i|0,n|0)|0;st=D;at=oi(Qe|0,Xe|0,25)|0;ot=D;lt=ri(Ze|0,ut|0,16777216,0)|0;dt=D;ct=ii(lt|0,dt|0,25)|0;ht=D;pt=ri(ct|0,ht|0,r|0,S|0)|0;gt=D;mt=oi(ct|0,ht|0,25)|0;ft=D;St=ni(Ze|0,ut|0,mt|0,ft|0)|0;vt=D;yt=ri(le|0,fe|0,16777216,0)|0;Ct=D;Tt=ii(yt|0,Ct|0,25)|0;Et=D;bt=ri(Tt|0,Et|0,Te|0,Ee|0)|0;Pt=D;It=oi(Tt|0,Et|0,25)|0;At=D;Rt=ni(le|0,fe|0,It|0,At|0)|0;wt=D;Mt=ri(be|0,Pe|0,16777216,0)|0;Ot=D;Dt=ii(Mt|0,Ot|0,25)|0;kt=D;Lt=ri(we|0,Me|0,Dt|0,kt|0)|0;xt=D;Ft=oi(Dt|0,kt|0,25)|0;Ut=D;Vt=ni(be|0,Pe|0,Ft|0,Ut|0)|0;Ht=D;Bt=ri(Le|0,xe|0,16777216,0)|0;$t=D;jt=ii(Bt|0,$t|0,25)|0;Gt=D;qt=ri(jt|0,Gt|0,He|0,Be|0)|0;zt=D;Kt=oi(jt|0,Gt|0,25)|0;Jt=D;Yt=ri(rt|0,st|0,33554432,0)|0;Qt=D;Xt=ii(Yt|0,Qt|0,26)|0;Zt=D;ei=ri(St|0,vt|0,Xt|0,Zt|0)|0;ti=D;a=oi(Xt|0,Zt|0,26)|0;o=D;l=ni(rt|0,st|0,a|0,o|0)|0;d=D;c=ri(pt|0,gt|0,33554432,0)|0;u=D;p=ii(c|0,u|0,26)|0;g=D;m=ri(Rt|0,wt|0,p|0,g|0)|0;f=D;v=oi(p|0,g|0,26)|0;y=D;C=ni(pt|0,gt|0,v|0,y|0)|0;T=D;E=ri(bt|0,Pt|0,33554432,0)|0;_=D;b=ii(E|0,_|0,26)|0;P=D;I=ri(Vt|0,Ht|0,b|0,P|0)|0;A=D;w=oi(b|0,P|0,26)|0;M=D;O=ni(bt|0,Pt|0,w|0,M|0)|0;k=D;N=ri(Lt|0,xt|0,33554432,0)|0;L=D;x=ii(N|0,L|0,26)|0;F=D;U=ri(x|0,F|0,Le|0,xe|0)|0;V=D;B=ni(U|0,V|0,Kt|0,Jt|0)|0;$=D;j=oi(x|0,F|0,26)|0;G=D;W=ni(Lt|0,xt|0,j|0,G|0)|0;q=D;z=ri(qt|0,zt|0,33554432,0)|0;K=D;J=ii(z|0,K|0,26)|0;Y=D;X=ri(J|0,Y|0,Ke|0,0)|0;Z=D;ee=ni(X|0,Z|0,at|0,ot|0)|0;te=D;ie=oi(J|0,Y|0,26)|0;ne=D;re=ni(qt|0,zt|0,ie|0,ne|0)|0;se=D;s[e>>2]=l;ae=e+4|0;s[ae>>2]=ei;oe=e+8|0;s[oe>>2]=C;de=e+12|0;s[de>>2]=m;ce=e+16|0;s[ce>>2]=O;he=e+20|0;s[he>>2]=I;ue=e+24|0;s[ue>>2]=W;pe=e+28|0;s[pe>>2]=B;ge=e+32|0;s[ge>>2]=re;me=e+36|0;s[me>>2]=ee;h=li;return}function it(e){e=e|0;var t=0,i=0,r=0,s=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0;var _=0,b=0,P=0,I=0;I=h;t=n[e>>0]|0;i=t&255;m=e+1|0;v=n[m>>0]|0;y=v&255;C=oi(y|0,0,8)|0;T=D;E=C|i;_=e+2|0;b=n[_>>0]|0;r=b&255;s=oi(r|0,0,16)|0;a=D;o=E|s;l=T|a;d=e+3|0;c=n[d>>0]|0;u=c&255;p=oi(u|0,0,24)|0;g=D;f=o|p;S=l|g;D=S;h=I;return f|0}function nt(e){e=e|0;var t=0,i=0,r=0,s=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0;y=h;t=n[e>>0]|0;i=t&255;d=e+1|0;c=n[d>>0]|0;u=c&255;p=oi(u|0,0,8)|0;g=D;m=p|i;f=e+2|0;S=n[f>>0]|0;r=S&255;s=oi(r|0,0,16)|0;a=D;o=m|s;l=g|a;D=l;h=y;return o|0}function rt(e,t){e=e|0;t=t|0;var i=0,n=0,r=0,s=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0;S=h;h=h+160|0;u=S+120|0;p=S+80|0;g=S+40|0;m=S;ct(u,t);ct(p,u);ct(p,p);ot(p,t,p);ot(u,u,p);ct(g,u);ot(p,p,g);ct(g,p);ct(g,g);ct(g,g);ct(g,g);ct(g,g);ot(p,g,p);ct(g,p);ct(g,g);ct(g,g);ct(g,g);ct(g,g);ct(g,g);ct(g,g);ct(g,g);ct(g,g);ct(g,g);ot(g,g,p);ct(m,g);ct(m,m);ct(m,m);ct(m,m);ct(m,m);ct(m,m);ct(m,m);ct(m,m);ct(m,m);ct(m,m);ct(m,m);ct(m,m);ct(m,m);ct(m,m);ct(m,m);ct(m,m);ct(m,m);ct(m,m);ct(m,m);ct(m,m);ot(g,m,g);ct(g,g);ct(g,g);ct(g,g);ct(g,g);ct(g,g);ct(g,g);ct(g,g);ct(g,g);ct(g,g);ct(g,g);ot(p,g,p);ct(g,p);l=1;while(1){ct(g,g);i=l+1|0;o=(i|0)==50;if(o){break}else{l=i}}ot(g,g,p);ct(m,g);d=1;while(1){ct(m,m);n=d+1|0;a=(n|0)==100;if(a){break}else{d=n}}ot(g,m,g);ct(g,g);c=1;while(1){ct(g,g);r=c+1|0;s=(r|0)==50;if(s){break}else{c=r}}ot(p,g,p);ct(p,p);ct(p,p);ct(p,p);ct(p,p);ct(p,p);ot(e,p,u);h=S;return}function st(e){e=e|0;var t=0,i=0,r=0,s=0,a=0,o=0;o=h;h=h+32|0;s=o;pt(s,e);t=n[s>>0]|0;i=t&255;r=i&1;h=o;return r|0}function at(e){e=e|0;var t=0,i=0,n=0,r=0;r=h;h=h+32|0;i=r;pt(i,e);t=Pe(i,8)|0;h=r;return t|0}function ot(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,r=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0,b=0;var P=0,I=0,A=0,R=0,w=0,M=0,O=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0,j=0,G=0,W=0;var q=0,z=0,K=0,J=0,Y=0,Q=0,X=0,Z=0,ee=0,te=0,ie=0,ne=0,re=0,se=0,ae=0,oe=0,le=0,de=0,ce=0,he=0;var ue=0,pe=0,ge=0,me=0,fe=0,Se=0,ve=0,ye=0,Ce=0,Te=0,Ee=0,_e=0,be=0,Pe=0,Ie=0,Ae=0,Re=0,we=0,Me=0,Oe=0;var De=0,ke=0,Ne=0,Le=0,xe=0,Fe=0,Ue=0,Ve=0,He=0,Be=0,$e=0,je=0,Ge=0,We=0,qe=0,ze=0,Ke=0,Je=0,Ye=0,Qe=0;var Xe=0,Ze=0,et=0,tt=0,it=0,nt=0,rt=0,st=0,at=0,ot=0,lt=0,dt=0,ct=0,ht=0,ut=0,pt=0,gt=0,mt=0,ft=0,St=0;var vt=0,yt=0,Ct=0,Tt=0,Et=0,_t=0,bt=0,Pt=0,It=0,At=0,Rt=0,wt=0,Mt=0,Ot=0,Dt=0,kt=0,Nt=0,Lt=0,xt=0,Ft=0;var Ut=0,Vt=0,Ht=0,Bt=0,$t=0,jt=0,Gt=0,Wt=0,qt=0,zt=0,Kt=0,Jt=0,Yt=0,Qt=0,Xt=0,Zt=0,ei=0,ti=0,si=0,ai=0;var li=0,di=0,ci=0,hi=0,ui=0,pi=0,gi=0,mi=0,Si=0,vi=0,yi=0,Ci=0,Ti=0,Ei=0,_i=0,bi=0,Pi=0,Ii=0,Ai=0,Ri=0;var wi=0,Mi=0,Oi=0,Di=0,ki=0,Ni=0,Li=0,xi=0,Fi=0,Ui=0,Vi=0,Hi=0,Bi=0,$i=0,ji=0,Gi=0,Wi=0,qi=0,zi=0,Ki=0;var Ji=0,Yi=0,Qi=0,Xi=0,Zi=0,en=0,tn=0,nn=0,rn=0,sn=0,an=0,on=0,ln=0,dn=0,cn=0,hn=0,un=0,pn=0,gn=0,mn=0;var fn=0,Sn=0,vn=0,yn=0,Cn=0,Tn=0,En=0,_n=0,bn=0,Pn=0,In=0,An=0,Rn=0,wn=0,Mn=0,On=0,Dn=0,kn=0,Nn=0,Ln=0;var xn=0,Fn=0,Un=0,Vn=0,Hn=0,Bn=0,$n=0,jn=0,Gn=0,Wn=0,qn=0,zn=0,Kn=0,Jn=0,Yn=0,Qn=0,Xn=0,Zn=0,er=0,tr=0;var ir=0,nr=0,rr=0,sr=0,ar=0,or=0,lr=0,dr=0,cr=0,hr=0,ur=0,pr=0,gr=0,mr=0,fr=0,Sr=0,vr=0,yr=0,Cr=0,Tr=0;var Er=0,_r=0,br=0,Pr=0,Ir=0,Ar=0,Rr=0,wr=0,Mr=0,Or=0,Dr=0,kr=0,Nr=0,Lr=0,xr=0,Fr=0,Ur=0,Vr=0,Hr=0,Br=0;var $r=0,jr=0,Gr=0,Wr=0,qr=0,zr=0,Kr=0,Jr=0,Yr=0,Qr=0,Xr=0,Zr=0,es=0,ts=0,is=0,ns=0,rs=0,ss=0,as=0,os=0;var ls=0,ds=0,cs=0,hs=0,us=0,ps=0,gs=0,ms=0,fs=0,Ss=0,vs=0,ys=0,Cs=0,Ts=0,Es=0,_s=0,bs=0,Ps=0,Is=0,As=0;var Rs=0,ws=0,Ms=0,Os=0,Ds=0,ks=0,Ns=0,Ls=0,xs=0,Fs=0,Us=0,Vs=0,Hs=0,Bs=0,$s=0,js=0,Gs=0,Ws=0,qs=0,zs=0;var Ks=0,Js=0,Ys=0,Qs=0,Xs=0,Zs=0,ea=0,ta=0,ia=0,na=0,ra=0,sa=0,aa=0,oa=0,la=0,da=0,ca=0,ha=0,ua=0,pa=0;var ga=0,ma=0,fa=0,Sa=0,va=0,ya=0,Ca=0,Ta=0,Ea=0,_a=0,ba=0,Pa=0,Ia=0,Aa=0,Ra=0,wa=0,Ma=0,Oa=0,Da=0,ka=0;var Na=0,La=0,xa=0,Fa=0,Ua=0,Va=0,Ha=0,Ba=0,$a=0,ja=0,Ga=0,Wa=0,qa=0,za=0,Ka=0,Ja=0,Ya=0,Qa=0,Xa=0,Za=0;var eo=0,to=0,io=0,no=0,ro=0,so=0,ao=0,oo=0,lo=0,co=0,ho=0,uo=0,po=0,go=0,mo=0,fo=0,So=0,vo=0,yo=0,Co=0;var To=0,Eo=0,_o=0,bo=0,Po=0,Io=0,Ao=0,Ro=0,wo=0,Mo=0,Oo=0,Do=0,ko=0,No=0,Lo=0,xo=0,Fo=0,Uo=0,Vo=0,Ho=0;var Bo=0,$o=0,jo=0,Go=0,Wo=0,qo=0,zo=0,Ko=0,Jo=0,Yo=0,Qo=0,Xo=0,Zo=0,el=0,tl=0,il=0,nl=0,rl=0,sl=0,al=0;var ol=0,ll=0,dl=0,cl=0,hl=0,ul=0,pl=0,gl=0,ml=0,fl=0,Sl=0,vl=0,yl=0,Cl=0,Tl=0,El=0,_l=0,bl=0,Pl=0,Il=0;var Al=0,Rl=0,wl=0,Ml=0,Ol=0,Dl=0,kl=0,Nl=0,Ll=0,xl=0,Fl=0,Ul=0,Vl=0,Hl=0,Bl=0,$l=0,jl=0,Gl=0,Wl=0,ql=0;var zl=0,Kl=0,Jl=0,Yl=0,Ql=0,Xl=0,Zl=0,ed=0,td=0,id=0,nd=0,rd=0,sd=0,ad=0,od=0,ld=0,dd=0,cd=0,hd=0,ud=0;var pd=0,gd=0,md=0,fd=0,Sd=0,vd=0,yd=0,Cd=0,Td=0,Ed=0,_d=0,bd=0,Pd=0,Id=0,Ad=0,Rd=0,wd=0,Md=0,Od=0,Dd=0;var kd=0,Nd=0,Ld=0,xd=0,Fd=0,Ud=0,Vd=0,Hd=0,Bd=0,$d=0,jd=0,Gd=0,Wd=0,qd=0,zd=0,Kd=0,Jd=0,Yd=0,Qd=0,Xd=0;var Zd=0,ec=0,tc=0,ic=0,nc=0,rc=0,sc=0,ac=0,oc=0,lc=0,dc=0,cc=0,hc=0,uc=0,pc=0,gc=0,mc=0,fc=0,Sc=0,vc=0;var yc=0,Cc=0,Tc=0,Ec=0,_c=0,bc=0,Pc=0,Ic=0,Ac=0,Rc=0,wc=0,Mc=0,Oc=0,Dc=0,kc=0,Nc=0,Lc=0,xc=0,Fc=0,Uc=0;var Vc=0,Hc=0,Bc=0,$c=0,jc=0,Gc=0,Wc=0,qc=0,zc=0,Kc=0,Jc=0,Yc=0,Qc=0;Qc=h;n=s[t>>2]|0;r=t+4|0;ct=s[r>>2]|0;yn=t+8|0;Es=s[yn>>2]|0;Io=t+12|0;wd=s[Io>>2]|0;Sc=t+16|0;Rc=s[Sc>>2]|0;Vc=t+20|0;a=s[Vc>>2]|0;v=t+24|0;w=s[v>>2]|0;B=t+28|0;X=s[B>>2]|0;de=t+32|0;Ce=s[de>>2]|0;Oe=t+36|0;$e=s[Oe>>2]|0;Ze=s[i>>2]|0;ht=i+4|0;Et=s[ht>>2]|0;kt=i+8|0;Gt=s[kt>>2]|0;ti=i+12|0;Si=s[ti>>2]|0;Ri=i+16|0;Vi=s[Ri>>2]|0;Yi=i+20|0;ln=s[Yi>>2]|0;Cn=i+24|0;On=s[Cn>>2]|0;$n=i+28|0;Zn=s[$n>>2]|0;cr=i+32|0;Tr=s[cr>>2]|0;Dr=i+36|0;jr=s[Dr>>2]|0;es=Et*19|0;hs=Gt*19|0;_s=Si*19|0;Ns=Vi*19|0;Ws=ln*19|0;ia=On*19|0;pa=Zn*19|0;ba=Tr*19|0;La=jr*19|0;qa=ct<<1;no=wd<<1;mo=a<<1;Ao=X<<1;Uo=$e<<1;Jo=(n|0)<0;al=Jo<<31>>31;Sl=(Ze|0)<0;Rl=Sl<<31>>31;Vl=fi(Ze|0,Rl|0,n|0,al|0)|0;Yl=D;od=(Et|0)<0;vd=od<<31>>31;Md=fi(Et|0,vd|0,n|0,al|0)|0;Bd=D;Xd=(Gt|0)<0;dc=Xd<<31>>31;hc=fi(Gt|0,dc|0,n|0,al|0)|0;uc=D;pc=(Si|0)<0;gc=pc<<31>>31;mc=fi(Si|0,gc|0,n|0,al|0)|0;fc=D;vc=(Vi|0)<0;yc=vc<<31>>31;Cc=fi(Vi|0,yc|0,n|0,al|0)|0;Tc=D;Ec=(ln|0)<0;_c=Ec<<31>>31;bc=fi(ln|0,_c|0,n|0,al|0)|0;Pc=D;Ic=(On|0)<0;Ac=Ic<<31>>31;wc=fi(On|0,Ac|0,n|0,al|0)|0;Mc=D;Oc=(Zn|0)<0;Dc=Oc<<31>>31;kc=fi(Zn|0,Dc|0,n|0,al|0)|0;Nc=D;Lc=(Tr|0)<0;xc=Lc<<31>>31;Fc=fi(Tr|0,xc|0,n|0,al|0)|0;Uc=D;Hc=(jr|0)<0;Bc=Hc<<31>>31;$c=fi(jr|0,Bc|0,n|0,al|0)|0;jc=D;Gc=(ct|0)<0;Wc=Gc<<31>>31;qc=fi(Ze|0,Rl|0,ct|0,Wc|0)|0;zc=D;Kc=(qa|0)<0;Jc=Kc<<31>>31;o=fi(Et|0,vd|0,qa|0,Jc|0)|0;l=D;d=fi(Gt|0,dc|0,ct|0,Wc|0)|0;c=D;u=fi(Si|0,gc|0,qa|0,Jc|0)|0;p=D;g=fi(Vi|0,yc|0,ct|0,Wc|0)|0;m=D;f=fi(ln|0,_c|0,qa|0,Jc|0)|0;S=D;y=fi(On|0,Ac|0,ct|0,Wc|0)|0;C=D;T=fi(Zn|0,Dc|0,qa|0,Jc|0)|0;E=D;_=fi(Tr|0,xc|0,ct|0,Wc|0)|0;b=D;P=(La|0)<0;I=P<<31>>31;A=fi(La|0,I|0,qa|0,Jc|0)|0;R=D;M=(Es|0)<0;O=M<<31>>31;k=fi(Ze|0,Rl|0,Es|0,O|0)|0;N=D;L=fi(Et|0,vd|0,Es|0,O|0)|0;x=D;F=fi(Gt|0,dc|0,Es|0,O|0)|0;U=D;V=fi(Si|0,gc|0,Es|0,O|0)|0;H=D;$=fi(Vi|0,yc|0,Es|0,O|0)|0;j=D;G=fi(ln|0,_c|0,Es|0,O|0)|0;W=D;q=fi(On|0,Ac|0,Es|0,O|0)|0;z=D;K=fi(Zn|0,Dc|0,Es|0,O|0)|0;J=D;Y=(ba|0)<0;Q=Y<<31>>31;Z=fi(ba|0,Q|0,Es|0,O|0)|0;ee=D;te=fi(La|0,I|0,Es|0,O|0)|0;ie=D;ne=(wd|0)<0;re=ne<<31>>31;se=fi(Ze|0,Rl|0,wd|0,re|0)|0;ae=D;oe=(no|0)<0;le=oe<<31>>31;ce=fi(Et|0,vd|0,no|0,le|0)|0;he=D;ue=fi(Gt|0,dc|0,wd|0,re|0)|0;pe=D;ge=fi(Si|0,gc|0,no|0,le|0)|0;me=D;fe=fi(Vi|0,yc|0,wd|0,re|0)|0;Se=D;ve=fi(ln|0,_c|0,no|0,le|0)|0;ye=D;Te=fi(On|0,Ac|0,wd|0,re|0)|0;Ee=D;_e=(pa|0)<0;be=_e<<31>>31;Pe=fi(pa|0,be|0,no|0,le|0)|0;Ie=D;Ae=fi(ba|0,Q|0,wd|0,re|0)|0;Re=D;we=fi(La|0,I|0,no|0,le|0)|0;Me=D;De=(Rc|0)<0;ke=De<<31>>31;Ne=fi(Ze|0,Rl|0,Rc|0,ke|0)|0;Le=D;xe=fi(Et|0,vd|0,Rc|0,ke|0)|0;Fe=D;Ue=fi(Gt|0,dc|0,Rc|0,ke|0)|0;Ve=D;He=fi(Si|0,gc|0,Rc|0,ke|0)|0;Be=D;je=fi(Vi|0,yc|0,Rc|0,ke|0)|0;Ge=D;We=fi(ln|0,_c|0,Rc|0,ke|0)|0;qe=D;ze=(ia|0)<0;Ke=ze<<31>>31;Je=fi(ia|0,Ke|0,Rc|0,ke|0)|0;Ye=D;Qe=fi(pa|0,be|0,Rc|0,ke|0)|0;Xe=D;et=fi(ba|0,Q|0,Rc|0,ke|0)|0;tt=D;it=fi(La|0,I|0,Rc|0,ke|0)|0;nt=D;rt=(a|0)<0;st=rt<<31>>31;at=fi(Ze|0,Rl|0,a|0,st|0)|0;ot=D;lt=(mo|0)<0;dt=lt<<31>>31;ut=fi(Et|0,vd|0,mo|0,dt|0)|0;pt=D;gt=fi(Gt|0,dc|0,a|0,st|0)|0;mt=D;ft=fi(Si|0,gc|0,mo|0,dt|0)|0;St=D;vt=fi(Vi|0,yc|0,a|0,st|0)|0;yt=D;Ct=(Ws|0)<0;Tt=Ct<<31>>31;_t=fi(Ws|0,Tt|0,mo|0,dt|0)|0;bt=D;Pt=fi(ia|0,Ke|0,a|0,st|0)|0;It=D;At=fi(pa|0,be|0,mo|0,dt|0)|0;Rt=D;wt=fi(ba|0,Q|0,a|0,st|0)|0;Mt=D;Ot=fi(La|0,I|0,mo|0,dt|0)|0;Dt=D;Nt=(w|0)<0;Lt=Nt<<31>>31;xt=fi(Ze|0,Rl|0,w|0,Lt|0)|0;Ft=D;Ut=fi(Et|0,vd|0,w|0,Lt|0)|0;Vt=D;Ht=fi(Gt|0,dc|0,w|0,Lt|0)|0;Bt=D;$t=fi(Si|0,gc|0,w|0,Lt|0)|0;jt=D;Wt=(Ns|0)<0;qt=Wt<<31>>31;zt=fi(Ns|0,qt|0,w|0,Lt|0)|0;Kt=D;Jt=fi(Ws|0,Tt|0,w|0,Lt|0)|0;Yt=D;Qt=fi(ia|0,Ke|0,w|0,Lt|0)|0;Xt=D;Zt=fi(pa|0,be|0,w|0,Lt|0)|0;ei=D;si=fi(ba|0,Q|0,w|0,Lt|0)|0;ai=D;li=fi(La|0,I|0,w|0,Lt|0)|0;di=D;ci=(X|0)<0;hi=ci<<31>>31;ui=fi(Ze|0,Rl|0,X|0,hi|0)|0;pi=D;gi=(Ao|0)<0;mi=gi<<31>>31;vi=fi(Et|0,vd|0,Ao|0,mi|0)|0;yi=D;Ci=fi(Gt|0,dc|0,X|0,hi|0)|0;Ti=D;Ei=(_s|0)<0;_i=Ei<<31>>31;bi=fi(_s|0,_i|0,Ao|0,mi|0)|0;Pi=D;Ii=fi(Ns|0,qt|0,X|0,hi|0)|0;Ai=D;wi=fi(Ws|0,Tt|0,Ao|0,mi|0)|0;Mi=D;Oi=fi(ia|0,Ke|0,X|0,hi|0)|0;Di=D;ki=fi(pa|0,be|0,Ao|0,mi|0)|0;Ni=D;Li=fi(ba|0,Q|0,X|0,hi|0)|0;xi=D;Fi=fi(La|0,I|0,Ao|0,mi|0)|0;Ui=D;Hi=(Ce|0)<0;Bi=Hi<<31>>31;$i=fi(Ze|0,Rl|0,Ce|0,Bi|0)|0;ji=D;Gi=fi(Et|0,vd|0,Ce|0,Bi|0)|0;Wi=D;qi=(hs|0)<0;zi=qi<<31>>31;Ki=fi(hs|0,zi|0,Ce|0,Bi|0)|0;Ji=D;Qi=fi(_s|0,_i|0,Ce|0,Bi|0)|0;Xi=D;Zi=fi(Ns|0,qt|0,Ce|0,Bi|0)|0;en=D;tn=fi(Ws|0,Tt|0,Ce|0,Bi|0)|0;nn=D;rn=fi(ia|0,Ke|0,Ce|0,Bi|0)|0;sn=D;an=fi(pa|0,be|0,Ce|0,Bi|0)|0;on=D;dn=fi(ba|0,Q|0,Ce|0,Bi|0)|0;cn=D;hn=fi(La|0,I|0,Ce|0,Bi|0)|0;un=D;pn=($e|0)<0;gn=pn<<31>>31;mn=fi(Ze|0,Rl|0,$e|0,gn|0)|0;fn=D;Sn=(Uo|0)<0;vn=Sn<<31>>31;Tn=(es|0)<0;En=Tn<<31>>31;_n=fi(es|0,En|0,Uo|0,vn|0)|0;bn=D;Pn=fi(hs|0,zi|0,$e|0,gn|0)|0;In=D;An=fi(_s|0,_i|0,Uo|0,vn|0)|0;Rn=D;wn=fi(Ns|0,qt|0,$e|0,gn|0)|0;Mn=D;Dn=fi(Ws|0,Tt|0,Uo|0,vn|0)|0;kn=D;Nn=fi(ia|0,Ke|0,$e|0,gn|0)|0;Ln=D;xn=fi(pa|0,be|0,Uo|0,vn|0)|0;Fn=D;Un=fi(ba|0,Q|0,$e|0,gn|0)|0;Vn=D;Hn=fi(La|0,I|0,Uo|0,vn|0)|0;Bn=D;jn=ri(_n|0,bn|0,Vl|0,Yl|0)|0;Gn=D;Wn=ri(jn|0,Gn|0,Ki|0,Ji|0)|0;qn=D;zn=ri(Wn|0,qn|0,bi|0,Pi|0)|0;Kn=D;Jn=ri(zn|0,Kn|0,zt|0,Kt|0)|0;Yn=D;Qn=ri(Jn|0,Yn|0,_t|0,bt|0)|0;Xn=D;er=ri(Qn|0,Xn|0,Je|0,Ye|0)|0;tr=D;ir=ri(er|0,tr|0,Pe|0,Ie|0)|0;nr=D;rr=ri(ir|0,nr|0,Z|0,ee|0)|0;sr=D;ar=ri(rr|0,sr|0,A|0,R|0)|0;or=D;lr=ri(Md|0,Bd|0,qc|0,zc|0)|0;dr=D;hr=ri(ce|0,he|0,Ne|0,Le|0)|0;ur=D;pr=ri(hr|0,ur|0,F|0,U|0)|0;gr=D;mr=ri(pr|0,gr|0,u|0,p|0)|0;fr=D;Sr=ri(mr|0,fr|0,Cc|0,Tc|0)|0;vr=D;yr=ri(Sr|0,vr|0,Dn|0,kn|0)|0;Cr=D;Er=ri(yr|0,Cr|0,rn|0,sn|0)|0;_r=D;br=ri(Er|0,_r|0,ki|0,Ni|0)|0;Pr=D;Ir=ri(br|0,Pr|0,si|0,ai|0)|0;Ar=D;Rr=ri(Ir|0,Ar|0,Ot|0,Dt|0)|0;wr=D;Mr=ri(ar|0,or|0,33554432,0)|0;Or=D;kr=ii(Mr|0,Or|0,26)|0;Nr=D;Lr=ri(lr|0,dr|0,Pn|0,In|0)|0;xr=D;Fr=ri(Lr|0,xr|0,Qi|0,Xi|0)|0;Ur=D;Vr=ri(Fr|0,Ur|0,Ii|0,Ai|0)|0;Hr=D;Br=ri(Vr|0,Hr|0,Jt|0,Yt|0)|0;$r=D;Gr=ri(Br|0,$r|0,Pt|0,It|0)|0;Wr=D;qr=ri(Gr|0,Wr|0,Qe|0,Xe|0)|0;zr=D;Kr=ri(qr|0,zr|0,Ae|0,Re|0)|0;Jr=D;Yr=ri(Kr|0,Jr|0,te|0,ie|0)|0;Qr=D;Xr=ri(Yr|0,Qr|0,kr|0,Nr|0)|0;Zr=D;ts=oi(kr|0,Nr|0,26)|0;is=D;ns=ni(ar|0,or|0,ts|0,is|0)|0;rs=D;ss=ri(Rr|0,wr|0,33554432,0)|0;as=D;os=ii(ss|0,as|0,26)|0;ls=D;ds=ri(xe|0,Fe|0,at|0,ot|0)|0;cs=D;us=ri(ds|0,cs|0,ue|0,pe|0)|0;ps=D;gs=ri(us|0,ps|0,V|0,H|0)|0;ms=D;fs=ri(gs|0,ms|0,g|0,m|0)|0;Ss=D;vs=ri(fs|0,Ss|0,bc|0,Pc|0)|0;ys=D;Cs=ri(vs|0,ys|0,Nn|0,Ln|0)|0;Ts=D;bs=ri(Cs|0,Ts|0,an|0,on|0)|0;Ps=D;Is=ri(bs|0,Ps|0,Li|0,xi|0)|0;As=D;Rs=ri(Is|0,As|0,li|0,di|0)|0;ws=D;Ms=ri(Rs|0,ws|0,os|0,ls|0)|0;Os=D;Ds=oi(os|0,ls|0,26)|0;ks=D;Ls=ni(Rr|0,wr|0,Ds|0,ks|0)|0;xs=D;Fs=ri(Xr|0,Zr|0,16777216,0)|0;Us=D;Vs=ii(Fs|0,Us|0,25)|0;Hs=D;Bs=ri(o|0,l|0,k|0,N|0)|0;$s=D;js=ri(Bs|0,$s|0,hc|0,uc|0)|0;Gs=D;qs=ri(js|0,Gs|0,An|0,Rn|0)|0;zs=D;Ks=ri(qs|0,zs|0,Zi|0,en|0)|0;Js=D;Ys=ri(Ks|0,Js|0,wi|0,Mi|0)|0;Qs=D;Xs=ri(Ys|0,Qs|0,Qt|0,Xt|0)|0;Zs=D;ea=ri(Xs|0,Zs|0,At|0,Rt|0)|0;ta=D;na=ri(ea|0,ta|0,et|0,tt|0)|0;ra=D;sa=ri(na|0,ra|0,we|0,Me|0)|0;aa=D;oa=ri(sa|0,aa|0,Vs|0,Hs|0)|0;la=D;da=oi(Vs|0,Hs|0,25)|0;ca=D;ha=ni(Xr|0,Zr|0,da|0,ca|0)|0;ua=D;ga=ri(Ms|0,Os|0,16777216,0)|0;ma=D;fa=ii(ga|0,ma|0,25)|0;Sa=D;va=ri(ut|0,pt|0,xt|0,Ft|0)|0;ya=D;Ca=ri(va|0,ya|0,Ue|0,Ve|0)|0;Ta=D;Ea=ri(Ca|0,Ta|0,ge|0,me|0)|0;_a=D;Pa=ri(Ea|0,_a|0,$|0,j|0)|0;Ia=D;Aa=ri(Pa|0,Ia|0,f|0,S|0)|0;Ra=D;wa=ri(Aa|0,Ra|0,wc|0,Mc|0)|0;Ma=D;Oa=ri(wa|0,Ma|0,xn|0,Fn|0)|0;Da=D;ka=ri(Oa|0,Da|0,dn|0,cn|0)|0;Na=D;xa=ri(ka|0,Na|0,Fi|0,Ui|0)|0;Fa=D;Ua=ri(xa|0,Fa|0,fa|0,Sa|0)|0;Va=D;Ha=oi(fa|0,Sa|0,25)|0;Ba=D;$a=ni(Ms|0,Os|0,Ha|0,Ba|0)|0;ja=D;Ga=ri(oa|0,la|0,33554432,0)|0;Wa=D;za=ii(Ga|0,Wa|0,26)|0;Ka=D;Ja=ri(L|0,x|0,se|0,ae|0)|0;Ya=D;Qa=ri(Ja|0,Ya|0,d|0,c|0)|0;Xa=D;Za=ri(Qa|0,Xa|0,mc|0,fc|0)|0;eo=D;to=ri(Za|0,eo|0,wn|0,Mn|0)|0;io=D;ro=ri(to|0,io|0,tn|0,nn|0)|0;so=D;ao=ri(ro|0,so|0,Oi|0,Di|0)|0;oo=D;lo=ri(ao|0,oo|0,Zt|0,ei|0)|0;co=D;ho=ri(lo|0,co|0,wt|0,Mt|0)|0;uo=D;po=ri(ho|0,uo|0,it|0,nt|0)|0;go=D;fo=ri(po|0,go|0,za|0,Ka|0)|0;So=D;vo=oi(za|0,Ka|0,26)|0;yo=D;Co=ni(oa|0,la|0,vo|0,yo|0)|0;To=D;Eo=ri(Ua|0,Va|0,33554432,0)|0;_o=D;bo=ii(Eo|0,_o|0,26)|0;Po=D;Ro=ri(Ut|0,Vt|0,ui|0,pi|0)|0;wo=D;Mo=ri(Ro|0,wo|0,gt|0,mt|0)|0;Oo=D;Do=ri(Mo|0,Oo|0,He|0,Be|0)|0;ko=D;No=ri(Do|0,ko|0,fe|0,Se|0)|0;Lo=D;xo=ri(No|0,Lo|0,G|0,W|0)|0;Fo=D;Vo=ri(xo|0,Fo|0,y|0,C|0)|0;Ho=D;Bo=ri(Vo|0,Ho|0,kc|0,Nc|0)|0;$o=D;jo=ri(Bo|0,$o|0,Un|0,Vn|0)|0;Go=D;Wo=ri(jo|0,Go|0,hn|0,un|0)|0;qo=D;zo=ri(Wo|0,qo|0,bo|0,Po|0)|0;Ko=D;Yo=oi(bo|0,Po|0,26)|0;Qo=D;Xo=ni(Ua|0,Va|0,Yo|0,Qo|0)|0;Zo=D;el=ri(fo|0,So|0,16777216,0)|0;tl=D;il=ii(el|0,tl|0,25)|0;nl=D;rl=ri(il|0,nl|0,Ls|0,xs|0)|0;sl=D;ol=oi(il|0,nl|0,25)|0;ll=D;dl=ni(fo|0,So|0,ol|0,ll|0)|0;cl=D;hl=ri(zo|0,Ko|0,16777216,0)|0;ul=D;pl=ii(hl|0,ul|0,25)|0;gl=D;ml=ri(vi|0,yi|0,$i|0,ji|0)|0;fl=D;vl=ri(ml|0,fl|0,Ht|0,Bt|0)|0;yl=D;Cl=ri(vl|0,yl|0,ft|0,St|0)|0;Tl=D;El=ri(Cl|0,Tl|0,je|0,Ge|0)|0;_l=D;bl=ri(El|0,_l|0,ve|0,ye|0)|0;Pl=D;Il=ri(bl|0,Pl|0,q|0,z|0)|0;Al=D;wl=ri(Il|0,Al|0,T|0,E|0)|0;Ml=D;Ol=ri(wl|0,Ml|0,Fc|0,Uc|0)|0;Dl=D;kl=ri(Ol|0,Dl|0,Hn|0,Bn|0)|0;Nl=D;Ll=ri(kl|0,Nl|0,pl|0,gl|0)|0;xl=D;Fl=oi(pl|0,gl|0,25)|0;Ul=D;Hl=ni(zo|0,Ko|0,Fl|0,Ul|0)|0;Bl=D;$l=ri(rl|0,sl|0,33554432,0)|0;jl=D;Gl=ii($l|0,jl|0,26)|0;Wl=D;ql=ri($a|0,ja|0,Gl|0,Wl|0)|0;zl=D;Kl=oi(Gl|0,Wl|0,26)|0;Jl=D;Ql=ni(rl|0,sl|0,Kl|0,Jl|0)|0;Xl=D;Zl=ri(Ll|0,xl|0,33554432,0)|0;ed=D;td=ii(Zl|0,ed|0,26)|0;id=D;nd=ri(Gi|0,Wi|0,mn|0,fn|0)|0;rd=D;sd=ri(nd|0,rd|0,Ci|0,Ti|0)|0;ad=D;ld=ri(sd|0,ad|0,$t|0,jt|0)|0;dd=D;cd=ri(ld|0,dd|0,vt|0,yt|0)|0;hd=D;ud=ri(cd|0,hd|0,We|0,qe|0)|0;pd=D;gd=ri(ud|0,pd|0,Te|0,Ee|0)|0;md=D;fd=ri(gd|0,md|0,K|0,J|0)|0;Sd=D;yd=ri(fd|0,Sd|0,_|0,b|0)|0;Cd=D;Td=ri(yd|0,Cd|0,$c|0,jc|0)|0;Ed=D;_d=ri(Td|0,Ed|0,td|0,id|0)|0;bd=D;Pd=oi(td|0,id|0,26)|0;Id=D;Ad=ni(Ll|0,xl|0,Pd|0,Id|0)|0;Rd=D;Od=ri(_d|0,bd|0,16777216,0)|0;Dd=D;kd=ii(Od|0,Dd|0,25)|0;Nd=D;Ld=fi(kd|0,Nd|0,19,0)|0;xd=D;Fd=ri(Ld|0,xd|0,ns|0,rs|0)|0;Ud=D;Vd=oi(kd|0,Nd|0,25)|0;Hd=D;$d=ni(_d|0,bd|0,Vd|0,Hd|0)|0;jd=D;Gd=ri(Fd|0,Ud|0,33554432,0)|0;Wd=D;qd=ii(Gd|0,Wd|0,26)|0;zd=D;Kd=ri(ha|0,ua|0,qd|0,zd|0)|0;Jd=D;Yd=oi(qd|0,zd|0,26)|0;Qd=D;Zd=ni(Fd|0,Ud|0,Yd|0,Qd|0)|0;ec=D;s[e>>2]=Zd;tc=e+4|0;s[tc>>2]=Kd;ic=e+8|0;s[ic>>2]=Co;nc=e+12|0;s[nc>>2]=dl;rc=e+16|0;s[rc>>2]=Ql;sc=e+20|0;s[sc>>2]=ql;ac=e+24|0;s[ac>>2]=Xo;oc=e+28|0;s[oc>>2]=Hl;lc=e+32|0;s[lc>>2]=Ad;cc=e+36|0;s[cc>>2]=$d;h=Qc;return}function lt(e,t){e=e|0;t=t|0;var i=0,n=0,r=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0;var b=0,P=0,I=0,A=0,R=0,w=0,M=0,O=0,D=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0,j=0;j=h;i=s[t>>2]|0;n=t+4|0;f=s[n>>2]|0;A=t+8|0;x=s[A>>2]|0;F=t+12|0;U=s[F>>2]|0;V=t+16|0;H=s[V>>2]|0;B=t+20|0;r=s[B>>2]|0;a=t+24|0;o=s[a>>2]|0;l=t+28|0;d=s[l>>2]|0;c=t+32|0;u=s[c>>2]|0;p=t+36|0;g=s[p>>2]|0;m=0-i|0;S=0-f|0;v=0-x|0;y=0-U|0;C=0-H|0;T=0-r|0;E=0-o|0;_=0-d|0;b=0-u|0;P=0-g|0;s[e>>2]=m;I=e+4|0;s[I>>2]=S;R=e+8|0;s[R>>2]=v;w=e+12|0;s[w>>2]=y;M=e+16|0;s[M>>2]=C;O=e+20|0;s[O>>2]=T;D=e+24|0;s[D>>2]=E;k=e+28|0;s[k>>2]=_;N=e+32|0;s[N>>2]=b;L=e+36|0;s[L>>2]=P;h=j;return}function dt(e,t){e=e|0;t=t|0;var i=0,n=0,r=0,s=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0;f=h;h=h+128|0;u=f+80|0;p=f+40|0;g=f;ct(u,t);ct(p,u);ct(p,p);ot(p,t,p);ot(u,u,p);ct(u,u);ot(u,p,u);ct(p,u);ct(p,p);ct(p,p);ct(p,p);ct(p,p);ot(u,p,u);ct(p,u);ct(p,p);ct(p,p);ct(p,p);ct(p,p);ct(p,p);ct(p,p);ct(p,p);ct(p,p);ct(p,p);ot(p,p,u);ct(g,p);ct(g,g);ct(g,g);ct(g,g);ct(g,g);ct(g,g);ct(g,g);ct(g,g);ct(g,g);ct(g,g);ct(g,g);ct(g,g);ct(g,g);ct(g,g);ct(g,g);ct(g,g);ct(g,g);ct(g,g);ct(g,g);ct(g,g);ot(p,g,p);ct(p,p);ct(p,p);ct(p,p);ct(p,p);ct(p,p);ct(p,p);ct(p,p);ct(p,p);ct(p,p);ct(p,p);ot(u,p,u);ct(p,u);l=1;while(1){ct(p,p);i=l+1|0;o=(i|0)==50;if(o){break}else{l=i}}ot(p,p,u);ct(g,p);d=1;while(1){ct(g,g);n=d+1|0;a=(n|0)==100;if(a){break}else{d=n}}ot(p,g,p);ct(p,p);c=1;while(1){ct(p,p);r=c+1|0;s=(r|0)==50;if(s){break}else{c=r}}ot(u,p,u);ct(u,u);ct(u,u);ot(e,u,t);h=f;return}function ct(e,t){e=e|0;t=t|0;var i=0,n=0,r=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0;var b=0,P=0,I=0,A=0,R=0,w=0,M=0,O=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0,j=0,G=0;var W=0,q=0,z=0,K=0,J=0,Y=0,Q=0,X=0,Z=0,ee=0,te=0,ie=0,ne=0,re=0,se=0,ae=0,oe=0,le=0,de=0,ce=0;var he=0,ue=0,pe=0,ge=0,me=0,fe=0,Se=0,ve=0,ye=0,Ce=0,Te=0,Ee=0,_e=0,be=0,Pe=0,Ie=0,Ae=0,Re=0,we=0,Me=0;var Oe=0,De=0,ke=0,Ne=0,Le=0,xe=0,Fe=0,Ue=0,Ve=0,He=0,Be=0,$e=0,je=0,Ge=0,We=0,qe=0,ze=0,Ke=0,Je=0,Ye=0;var Qe=0,Xe=0,Ze=0,et=0,tt=0,it=0,nt=0,rt=0,st=0,at=0,ot=0,lt=0,dt=0,ct=0,ht=0,ut=0,pt=0,gt=0,mt=0,ft=0;var St=0,vt=0,yt=0,Ct=0,Tt=0,Et=0,_t=0,bt=0,Pt=0,It=0,At=0,Rt=0,wt=0,Mt=0,Ot=0,Dt=0,kt=0,Nt=0,Lt=0,xt=0;var Ft=0,Ut=0,Vt=0,Ht=0,Bt=0,$t=0,jt=0,Gt=0,Wt=0,qt=0,zt=0,Kt=0,Jt=0,Yt=0,Qt=0,Xt=0,Zt=0,ei=0,ti=0,si=0;var ai=0,li=0,di=0,ci=0,hi=0,ui=0,pi=0,gi=0,mi=0,Si=0,vi=0,yi=0,Ci=0,Ti=0,Ei=0,_i=0,bi=0,Pi=0,Ii=0,Ai=0;var Ri=0,wi=0,Mi=0,Oi=0,Di=0,ki=0,Ni=0,Li=0,xi=0,Fi=0,Ui=0,Vi=0,Hi=0,Bi=0,$i=0,ji=0,Gi=0,Wi=0,qi=0,zi=0;var Ki=0,Ji=0,Yi=0,Qi=0,Xi=0,Zi=0,en=0,tn=0,nn=0,rn=0,sn=0,an=0,on=0,ln=0,dn=0,cn=0,hn=0,un=0,pn=0,gn=0;var mn=0,fn=0,Sn=0,vn=0,yn=0,Cn=0,Tn=0,En=0,_n=0,bn=0,Pn=0,In=0,An=0,Rn=0,wn=0,Mn=0,On=0,Dn=0,kn=0,Nn=0;var Ln=0,xn=0,Fn=0,Un=0,Vn=0,Hn=0,Bn=0,$n=0,jn=0,Gn=0,Wn=0,qn=0,zn=0,Kn=0,Jn=0,Yn=0,Qn=0,Xn=0,Zn=0,er=0;var tr=0,ir=0,nr=0,rr=0,sr=0,ar=0,or=0,lr=0,dr=0,cr=0,hr=0,ur=0,pr=0,gr=0,mr=0,fr=0,Sr=0,vr=0,yr=0,Cr=0;var Tr=0,Er=0,_r=0,br=0,Pr=0,Ir=0,Ar=0,Rr=0,wr=0,Mr=0,Or=0,Dr=0,kr=0,Nr=0,Lr=0,xr=0,Fr=0,Ur=0,Vr=0,Hr=0;var Br=0,$r=0,jr=0,Gr=0,Wr=0,qr=0,zr=0,Kr=0,Jr=0,Yr=0,Qr=0,Xr=0,Zr=0,es=0,ts=0,is=0,ns=0,rs=0,ss=0,as=0;var os=0,ls=0,ds=0,cs=0,hs=0,us=0,ps=0,gs=0,ms=0,fs=0,Ss=0,vs=0,ys=0,Cs=0,Ts=0,Es=0,_s=0,bs=0,Ps=0,Is=0;var As=0,Rs=0,ws=0,Ms=0,Os=0,Ds=0,ks=0,Ns=0,Ls=0,xs=0,Fs=0,Us=0,Vs=0,Hs=0,Bs=0,$s=0,js=0,Gs=0,Ws=0,qs=0;var zs=0,Ks=0,Js=0,Ys=0,Qs=0,Xs=0,Zs=0,ea=0,ta=0,ia=0,na=0,ra=0,sa=0,aa=0,oa=0,la=0,da=0,ca=0,ha=0,ua=0;var pa=0,ga=0,ma=0,fa=0,Sa=0,va=0,ya=0,Ca=0,Ta=0,Ea=0,_a=0,ba=0,Pa=0,Ia=0,Aa=0,Ra=0,wa=0,Ma=0,Oa=0,Da=0;var ka=0,Na=0,La=0,xa=0,Fa=0,Ua=0,Va=0,Ha=0,Ba=0,$a=0,ja=0;ja=h;i=s[t>>2]|0;n=t+4|0;dt=s[n>>2]|0;vn=t+8|0;Ts=s[vn>>2]|0;Bs=t+12|0;Xs=s[Bs>>2]|0;da=t+16|0;Ca=s[da>>2]|0;Oa=t+20|0;r=s[Oa>>2]|0;S=t+24|0;R=s[S>>2]|0;H=t+28|0;Q=s[H>>2]|0;le=t+32|0;ye=s[le>>2]|0;Me=t+36|0;Be=s[Me>>2]|0;Xe=i<<1;ct=dt<<1;Tt=Ts<<1;Dt=Xs<<1;jt=Ca<<1;ei=r<<1;mi=R<<1;Ai=Q<<1;Ui=r*38|0;Ji=R*19|0;on=Q*38|0;yn=ye*19|0;Mn=Be*38|0;Bn=(i|0)<0;Xn=Bn<<31>>31;dr=fi(i|0,Xn|0,i|0,Xn|0)|0;Cr=D;Or=(Xe|0)<0;$r=Or<<31>>31;Zr=(dt|0)<0;cs=Zr<<31>>31;Es=fi(Xe|0,$r|0,dt|0,cs|0)|0;Ds=D;ks=(Ts|0)<0;Ns=ks<<31>>31;Ls=fi(Ts|0,Ns|0,Xe|0,$r|0)|0;xs=D;Fs=(Xs|0)<0;Us=Fs<<31>>31;Vs=fi(Xs|0,Us|0,Xe|0,$r|0)|0;Hs=D;$s=(Ca|0)<0;js=$s<<31>>31;Gs=fi(Ca|0,js|0,Xe|0,$r|0)|0;Ws=D;qs=(r|0)<0;zs=qs<<31>>31;Ks=fi(r|0,zs|0,Xe|0,$r|0)|0;Js=D;Ys=(R|0)<0;Qs=Ys<<31>>31;Zs=fi(R|0,Qs|0,Xe|0,$r|0)|0;ea=D;ta=(Q|0)<0;ia=ta<<31>>31;na=fi(Q|0,ia|0,Xe|0,$r|0)|0;ra=D;sa=(ye|0)<0;aa=sa<<31>>31;oa=fi(ye|0,aa|0,Xe|0,$r|0)|0;la=D;ca=(Be|0)<0;ha=ca<<31>>31;ua=fi(Be|0,ha|0,Xe|0,$r|0)|0;pa=D;ga=(ct|0)<0;ma=ga<<31>>31;fa=fi(ct|0,ma|0,dt|0,cs|0)|0;Sa=D;va=fi(ct|0,ma|0,Ts|0,Ns|0)|0;ya=D;Ta=(Dt|0)<0;Ea=Ta<<31>>31;_a=fi(Dt|0,Ea|0,ct|0,ma|0)|0;ba=D;Pa=fi(Ca|0,js|0,ct|0,ma|0)|0;Ia=D;Aa=(ei|0)<0;Ra=Aa<<31>>31;wa=fi(ei|0,Ra|0,ct|0,ma|0)|0;Ma=D;Da=fi(R|0,Qs|0,ct|0,ma|0)|0;ka=D;Na=(Ai|0)<0;La=Na<<31>>31;xa=fi(Ai|0,La|0,ct|0,ma|0)|0;Fa=D;Ua=fi(ye|0,aa|0,ct|0,ma|0)|0;Va=D;Ha=(Mn|0)<0;Ba=Ha<<31>>31;a=fi(Mn|0,Ba|0,ct|0,ma|0)|0;o=D;l=fi(Ts|0,Ns|0,Ts|0,Ns|0)|0;d=D;c=(Tt|0)<0;u=c<<31>>31;p=fi(Tt|0,u|0,Xs|0,Us|0)|0;g=D;m=fi(Ca|0,js|0,Tt|0,u|0)|0;f=D;v=fi(r|0,zs|0,Tt|0,u|0)|0;y=D;C=fi(R|0,Qs|0,Tt|0,u|0)|0;T=D;E=fi(Q|0,ia|0,Tt|0,u|0)|0;_=D;b=(yn|0)<0;P=b<<31>>31;I=fi(yn|0,P|0,Tt|0,u|0)|0;A=D;w=fi(Mn|0,Ba|0,Ts|0,Ns|0)|0;M=D;O=fi(Dt|0,Ea|0,Xs|0,Us|0)|0;k=D;N=fi(Dt|0,Ea|0,Ca|0,js|0)|0;L=D;x=fi(ei|0,Ra|0,Dt|0,Ea|0)|0;F=D;U=fi(R|0,Qs|0,Dt|0,Ea|0)|0;V=D;B=(on|0)<0;$=B<<31>>31;j=fi(on|0,$|0,Dt|0,Ea|0)|0;G=D;W=fi(yn|0,P|0,Dt|0,Ea|0)|0;q=D;z=fi(Mn|0,Ba|0,Dt|0,Ea|0)|0;K=D;J=fi(Ca|0,js|0,Ca|0,js|0)|0;Y=D;X=(jt|0)<0;Z=X<<31>>31;ee=fi(jt|0,Z|0,r|0,zs|0)|0;te=D;ie=(Ji|0)<0;ne=ie<<31>>31;re=fi(Ji|0,ne|0,jt|0,Z|0)|0;se=D;ae=fi(on|0,$|0,Ca|0,js|0)|0;oe=D;de=fi(yn|0,P|0,jt|0,Z|0)|0;ce=D;he=fi(Mn|0,Ba|0,Ca|0,js|0)|0;ue=D;pe=(Ui|0)<0;ge=pe<<31>>31;me=fi(Ui|0,ge|0,r|0,zs|0)|0;fe=D;Se=fi(Ji|0,ne|0,ei|0,Ra|0)|0;ve=D;Ce=fi(on|0,$|0,ei|0,Ra|0)|0;Te=D;Ee=fi(yn|0,P|0,ei|0,Ra|0)|0;_e=D;be=fi(Mn|0,Ba|0,ei|0,Ra|0)|0;Pe=D;Ie=fi(Ji|0,ne|0,R|0,Qs|0)|0;Ae=D;Re=fi(on|0,$|0,R|0,Qs|0)|0;we=D;Oe=(mi|0)<0;De=Oe<<31>>31;ke=fi(yn|0,P|0,mi|0,De|0)|0;Ne=D;Le=fi(Mn|0,Ba|0,R|0,Qs|0)|0;xe=D;Fe=fi(on|0,$|0,Q|0,ia|0)|0;Ue=D;Ve=fi(yn|0,P|0,Ai|0,La|0)|0;He=D;$e=fi(Mn|0,Ba|0,Ai|0,La|0)|0;je=D;Ge=fi(yn|0,P|0,ye|0,aa|0)|0;We=D;qe=fi(Mn|0,Ba|0,ye|0,aa|0)|0;ze=D;Ke=fi(Mn|0,Ba|0,Be|0,ha|0)|0;Je=D;Ye=ri(me|0,fe|0,dr|0,Cr|0)|0;Qe=D;Ze=ri(Ye|0,Qe|0,re|0,se|0)|0;et=D;tt=ri(Ze|0,et|0,j|0,G|0)|0;it=D;nt=ri(tt|0,it|0,I|0,A|0)|0;rt=D;st=ri(nt|0,rt|0,a|0,o|0)|0;at=D;ot=ri(Ls|0,xs|0,fa|0,Sa|0)|0;lt=D;ht=ri(Vs|0,Hs|0,va|0,ya|0)|0;ut=D;pt=ri(_a|0,ba|0,l|0,d|0)|0;gt=D;mt=ri(pt|0,gt|0,Gs|0,Ws|0)|0;ft=D;St=ri(mt|0,ft|0,Fe|0,Ue|0)|0;vt=D;yt=ri(St|0,vt|0,ke|0,Ne|0)|0;Ct=D;Et=ri(yt|0,Ct|0,be|0,Pe|0)|0;_t=D;bt=ri(st|0,at|0,33554432,0)|0;Pt=D;It=ii(bt|0,Pt|0,26)|0;At=D;Rt=ri(Se|0,ve|0,Es|0,Ds|0)|0;wt=D;Mt=ri(Rt|0,wt|0,ae|0,oe|0)|0;Ot=D;kt=ri(Mt|0,Ot|0,W|0,q|0)|0;Nt=D;Lt=ri(kt|0,Nt|0,w|0,M|0)|0;xt=D;Ft=ri(Lt|0,xt|0,It|0,At|0)|0;Ut=D;Vt=oi(It|0,At|0,26)|0;Ht=D;Bt=ni(st|0,at|0,Vt|0,Ht|0)|0;$t=D;Gt=ri(Et|0,_t|0,33554432,0)|0;Wt=D;qt=ii(Gt|0,Wt|0,26)|0;zt=D;Kt=ri(Pa|0,Ia|0,p|0,g|0)|0;Jt=D;Yt=ri(Kt|0,Jt|0,Ks|0,Js|0)|0;Qt=D;Xt=ri(Yt|0,Qt|0,Ve|0,He|0)|0;Zt=D;ti=ri(Xt|0,Zt|0,Le|0,xe|0)|0;si=D;ai=ri(ti|0,si|0,qt|0,zt|0)|0;li=D;di=oi(qt|0,zt|0,26)|0;ci=D;hi=ni(Et|0,_t|0,di|0,ci|0)|0;ui=D;pi=ri(Ft|0,Ut|0,16777216,0)|0;gi=D;Si=ii(pi|0,gi|0,25)|0;vi=D;yi=ri(ot|0,lt|0,Ie|0,Ae|0)|0;Ci=D;Ti=ri(yi|0,Ci|0,Ce|0,Te|0)|0;Ei=D;_i=ri(Ti|0,Ei|0,de|0,ce|0)|0;bi=D;Pi=ri(_i|0,bi|0,z|0,K|0)|0;Ii=D;Ri=ri(Pi|0,Ii|0,Si|0,vi|0)|0;wi=D;Mi=oi(Si|0,vi|0,25)|0;Oi=D;Di=ni(Ft|0,Ut|0,Mi|0,Oi|0)|0;ki=D;Ni=ri(ai|0,li|0,16777216,0)|0;Li=D;xi=ii(Ni|0,Li|0,25)|0;Fi=D;Vi=ri(O|0,k|0,m|0,f|0)|0;Hi=D;Bi=ri(Vi|0,Hi|0,wa|0,Ma|0)|0;$i=D;ji=ri(Bi|0,$i|0,Zs|0,ea|0)|0;Gi=D;Wi=ri(ji|0,Gi|0,Ge|0,We|0)|0;qi=D;zi=ri(Wi|0,qi|0,$e|0,je|0)|0;Ki=D;Yi=ri(zi|0,Ki|0,xi|0,Fi|0)|0;Qi=D;Xi=oi(xi|0,Fi|0,25)|0;Zi=D;en=ni(ai|0,li|0,Xi|0,Zi|0)|0;tn=D;nn=ri(Ri|0,wi|0,33554432,0)|0;rn=D;sn=ii(nn|0,rn|0,26)|0;an=D;ln=ri(ht|0,ut|0,Re|0,we|0)|0;dn=D;cn=ri(ln|0,dn|0,Ee|0,_e|0)|0;hn=D;un=ri(cn|0,hn|0,he|0,ue|0)|0;pn=D;gn=ri(un|0,pn|0,sn|0,an|0)|0;mn=D;fn=oi(sn|0,an|0,26)|0;Sn=D;Cn=ni(Ri|0,wi|0,fn|0,Sn|0)|0;Tn=D;En=ri(Yi|0,Qi|0,33554432,0)|0;_n=D;bn=ii(En|0,_n|0,26)|0;Pn=D;In=ri(v|0,y|0,N|0,L|0)|0;An=D;Rn=ri(In|0,An|0,Da|0,ka|0)|0;wn=D;On=ri(Rn|0,wn|0,na|0,ra|0)|0;Dn=D;kn=ri(On|0,Dn|0,qe|0,ze|0)|0;Nn=D;Ln=ri(kn|0,Nn|0,bn|0,Pn|0)|0;xn=D;Fn=oi(bn|0,Pn|0,26)|0;Un=D;Vn=ni(Yi|0,Qi|0,Fn|0,Un|0)|0;Hn=D;$n=ri(gn|0,mn|0,16777216,0)|0;jn=D;Gn=ii($n|0,jn|0,25)|0;Wn=D;qn=ri(Gn|0,Wn|0,hi|0,ui|0)|0;zn=D;Kn=oi(Gn|0,Wn|0,25)|0;Jn=D;Yn=ni(gn|0,mn|0,Kn|0,Jn|0)|0;Qn=D;Zn=ri(Ln|0,xn|0,16777216,0)|0;er=D;tr=ii(Zn|0,er|0,25)|0;ir=D;nr=ri(C|0,T|0,J|0,Y|0)|0;rr=D;sr=ri(nr|0,rr|0,x|0,F|0)|0;ar=D;or=ri(sr|0,ar|0,xa|0,Fa|0)|0;lr=D;cr=ri(or|0,lr|0,oa|0,la|0)|0;hr=D;ur=ri(cr|0,hr|0,Ke|0,Je|0)|0;pr=D;gr=ri(ur|0,pr|0,tr|0,ir|0)|0;mr=D;fr=oi(tr|0,ir|0,25)|0;Sr=D;vr=ni(Ln|0,xn|0,fr|0,Sr|0)|0;yr=D;Tr=ri(qn|0,zn|0,33554432,0)|0;Er=D;_r=ii(Tr|0,Er|0,26)|0;br=D;Pr=ri(en|0,tn|0,_r|0,br|0)|0;Ir=D;Ar=oi(_r|0,br|0,26)|0;Rr=D;wr=ni(qn|0,zn|0,Ar|0,Rr|0)|0;Mr=D;Dr=ri(gr|0,mr|0,33554432,0)|0;kr=D;Nr=ii(Dr|0,kr|0,26)|0;Lr=D;xr=ri(U|0,V|0,ee|0,te|0)|0;Fr=D;Ur=ri(xr|0,Fr|0,E|0,_|0)|0;Vr=D;Hr=ri(Ur|0,Vr|0,Ua|0,Va|0)|0;Br=D;jr=ri(Hr|0,Br|0,ua|0,pa|0)|0;Gr=D;Wr=ri(jr|0,Gr|0,Nr|0,Lr|0)|0;qr=D;zr=oi(Nr|0,Lr|0,26)|0;Kr=D;Jr=ni(gr|0,mr|0,zr|0,Kr|0)|0;Yr=D;Qr=ri(Wr|0,qr|0,16777216,0)|0;Xr=D;es=ii(Qr|0,Xr|0,25)|0;ts=D;is=fi(es|0,ts|0,19,0)|0;ns=D;rs=ri(is|0,ns|0,Bt|0,$t|0)|0;ss=D;as=oi(es|0,ts|0,25)|0;os=D;ls=ni(Wr|0,qr|0,as|0,os|0)|0;ds=D;hs=ri(rs|0,ss|0,33554432,0)|0;us=D;ps=ii(hs|0,us|0,26)|0;gs=D;ms=ri(Di|0,ki|0,ps|0,gs|0)|0;fs=D;Ss=oi(ps|0,gs|0,26)|0;vs=D;ys=ni(rs|0,ss|0,Ss|0,vs|0)|0;Cs=D;s[e>>2]=ys;_s=e+4|0;s[_s>>2]=ms;bs=e+8|0;s[bs>>2]=Cn;Ps=e+12|0;s[Ps>>2]=Yn;Is=e+16|0;s[Is>>2]=wr;As=e+20|0;s[As>>2]=Pr;Rs=e+24|0;s[Rs>>2]=Vn;ws=e+28|0;s[ws>>2]=vr;Ms=e+32|0;s[Ms>>2]=Jr;Os=e+36|0;s[Os>>2]=ls;h=ja;return}function ht(e,t){e=e|0;t=t|0;var i=0,n=0,r=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0;var b=0,P=0,I=0,A=0,R=0,w=0,M=0,O=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0,j=0,G=0;var W=0,q=0,z=0,K=0,J=0,Y=0,Q=0,X=0,Z=0,ee=0,te=0,ie=0,ne=0,re=0,se=0,ae=0,oe=0,le=0,de=0,ce=0;var he=0,ue=0,pe=0,ge=0,me=0,fe=0,Se=0,ve=0,ye=0,Ce=0,Te=0,Ee=0,_e=0,be=0,Pe=0,Ie=0,Ae=0,Re=0,we=0,Me=0;var Oe=0,De=0,ke=0,Ne=0,Le=0,xe=0,Fe=0,Ue=0,Ve=0,He=0,Be=0,$e=0,je=0,Ge=0,We=0,qe=0,ze=0,Ke=0,Je=0,Ye=0;var Qe=0,Xe=0,Ze=0,et=0,tt=0,it=0,nt=0,rt=0,st=0,at=0,ot=0,lt=0,dt=0,ct=0,ht=0,ut=0,pt=0,gt=0,mt=0,ft=0;var St=0,vt=0,yt=0,Ct=0,Tt=0,Et=0,_t=0,bt=0,Pt=0,It=0,At=0,Rt=0,wt=0,Mt=0,Ot=0,Dt=0,kt=0,Nt=0,Lt=0,xt=0;var Ft=0,Ut=0,Vt=0,Ht=0,Bt=0,$t=0,jt=0,Gt=0,Wt=0,qt=0,zt=0,Kt=0,Jt=0,Yt=0,Qt=0,Xt=0,Zt=0,ei=0,ti=0,si=0;var ai=0,li=0,di=0,ci=0,hi=0,ui=0,pi=0,gi=0,mi=0,Si=0,vi=0,yi=0,Ci=0,Ti=0,Ei=0,_i=0,bi=0,Pi=0,Ii=0,Ai=0;var Ri=0,wi=0,Mi=0,Oi=0,Di=0,ki=0,Ni=0,Li=0,xi=0,Fi=0,Ui=0,Vi=0,Hi=0,Bi=0,$i=0,ji=0,Gi=0,Wi=0,qi=0,zi=0;var Ki=0,Ji=0,Yi=0,Qi=0,Xi=0,Zi=0,en=0,tn=0,nn=0,rn=0,sn=0,an=0,on=0,ln=0,dn=0,cn=0,hn=0,un=0,pn=0,gn=0;var mn=0,fn=0,Sn=0,vn=0,yn=0,Cn=0,Tn=0,En=0,_n=0,bn=0,Pn=0,In=0,An=0,Rn=0,wn=0,Mn=0,On=0,Dn=0,kn=0,Nn=0;var Ln=0,xn=0,Fn=0,Un=0,Vn=0,Hn=0,Bn=0,$n=0,jn=0,Gn=0,Wn=0,qn=0,zn=0,Kn=0,Jn=0,Yn=0,Qn=0,Xn=0,Zn=0,er=0;var tr=0,ir=0,nr=0,rr=0,sr=0,ar=0,or=0,lr=0,dr=0,cr=0,hr=0,ur=0,pr=0,gr=0,mr=0,fr=0,Sr=0,vr=0,yr=0,Cr=0;var Tr=0,Er=0,_r=0,br=0,Pr=0,Ir=0,Ar=0,Rr=0,wr=0,Mr=0,Or=0,Dr=0,kr=0,Nr=0,Lr=0,xr=0,Fr=0,Ur=0,Vr=0,Hr=0;var Br=0,$r=0,jr=0,Gr=0,Wr=0,qr=0,zr=0,Kr=0,Jr=0,Yr=0,Qr=0,Xr=0,Zr=0,es=0,ts=0,is=0,ns=0,rs=0,ss=0,as=0;var os=0,ls=0,ds=0,cs=0,hs=0,us=0,ps=0,gs=0,ms=0,fs=0,Ss=0,vs=0,ys=0,Cs=0,Ts=0,Es=0,_s=0,bs=0,Ps=0,Is=0;var As=0,Rs=0,ws=0,Ms=0,Os=0,Ds=0,ks=0,Ns=0,Ls=0,xs=0,Fs=0,Us=0,Vs=0,Hs=0,Bs=0,$s=0,js=0,Gs=0,Ws=0,qs=0;var zs=0,Ks=0,Js=0,Ys=0,Qs=0,Xs=0,Zs=0,ea=0,ta=0,ia=0,na=0,ra=0,sa=0,aa=0,oa=0,la=0,da=0,ca=0,ha=0,ua=0;var pa=0,ga=0,ma=0,fa=0,Sa=0,va=0,ya=0,Ca=0,Ta=0,Ea=0,_a=0,ba=0,Pa=0,Ia=0,Aa=0,Ra=0,wa=0,Ma=0,Oa=0,Da=0;var ka=0,Na=0,La=0,xa=0,Fa=0,Ua=0,Va=0,Ha=0,Ba=0,$a=0,ja=0,Ga=0,Wa=0,qa=0,za=0,Ka=0,Ja=0,Ya=0,Qa=0,Xa=0;var Za=0,eo=0,to=0,io=0,no=0,ro=0,so=0,ao=0,oo=0,lo=0,co=0;co=h;i=s[t>>2]|0;n=t+4|0;dt=s[n>>2]|0;vn=t+8|0;Ts=s[vn>>2]|0;oa=t+12|0;va=s[oa>>2]|0;wa=t+16|0;Ha=s[wa>>2]|0;Qa=t+20|0;r=s[Qa>>2]|0;S=t+24|0;R=s[S>>2]|0;H=t+28|0;Q=s[H>>2]|0;le=t+32|0;ye=s[le>>2]|0;Me=t+36|0;Be=s[Me>>2]|0;Xe=i<<1;ct=dt<<1;Tt=Ts<<1;Dt=va<<1;jt=Ha<<1;ei=r<<1;mi=R<<1;Ai=Q<<1;Ui=r*38|0;Ji=R*19|0;on=Q*38|0;yn=ye*19|0;Mn=Be*38|0;Bn=(i|0)<0;Xn=Bn<<31>>31;dr=fi(i|0,Xn|0,i|0,Xn|0)|0;Cr=D;Or=(Xe|0)<0;$r=Or<<31>>31;Zr=(dt|0)<0;cs=Zr<<31>>31;Es=fi(Xe|0,$r|0,dt|0,cs|0)|0;ks=D;Gs=(Ts|0)<0;ea=Gs<<31>>31;ta=fi(Ts|0,ea|0,Xe|0,$r|0)|0;ia=D;na=(va|0)<0;ra=na<<31>>31;sa=fi(va|0,ra|0,Xe|0,$r|0)|0;aa=D;la=(Ha|0)<0;da=la<<31>>31;ca=fi(Ha|0,da|0,Xe|0,$r|0)|0;ha=D;ua=(r|0)<0;pa=ua<<31>>31;ga=fi(r|0,pa|0,Xe|0,$r|0)|0;ma=D;fa=(R|0)<0;Sa=fa<<31>>31;ya=fi(R|0,Sa|0,Xe|0,$r|0)|0;Ca=D;Ta=(Q|0)<0;Ea=Ta<<31>>31;_a=fi(Q|0,Ea|0,Xe|0,$r|0)|0;ba=D;Pa=(ye|0)<0;Ia=Pa<<31>>31;Aa=fi(ye|0,Ia|0,Xe|0,$r|0)|0;Ra=D;Ma=(Be|0)<0;Oa=Ma<<31>>31;Da=fi(Be|0,Oa|0,Xe|0,$r|0)|0;ka=D;Na=(ct|0)<0;La=Na<<31>>31;xa=fi(ct|0,La|0,dt|0,cs|0)|0;Fa=D;Ua=fi(ct|0,La|0,Ts|0,ea|0)|0;Va=D;Ba=(Dt|0)<0;$a=Ba<<31>>31;ja=fi(Dt|0,$a|0,ct|0,La|0)|0;Ga=D;Wa=fi(Ha|0,da|0,ct|0,La|0)|0;qa=D;za=(ei|0)<0;Ka=za<<31>>31;Ja=fi(ei|0,Ka|0,ct|0,La|0)|0;Ya=D;Xa=fi(R|0,Sa|0,ct|0,La|0)|0;Za=D;eo=(Ai|0)<0;to=eo<<31>>31;io=fi(Ai|0,to|0,ct|0,La|0)|0;no=D;ro=fi(ye|0,Ia|0,ct|0,La|0)|0;so=D;ao=(Mn|0)<0;oo=ao<<31>>31;a=fi(Mn|0,oo|0,ct|0,La|0)|0;o=D;l=fi(Ts|0,ea|0,Ts|0,ea|0)|0;d=D;c=(Tt|0)<0;u=c<<31>>31;p=fi(Tt|0,u|0,va|0,ra|0)|0;g=D;m=fi(Ha|0,da|0,Tt|0,u|0)|0;f=D;v=fi(r|0,pa|0,Tt|0,u|0)|0;y=D;C=fi(R|0,Sa|0,Tt|0,u|0)|0;T=D;E=fi(Q|0,Ea|0,Tt|0,u|0)|0;_=D;b=(yn|0)<0;P=b<<31>>31;I=fi(yn|0,P|0,Tt|0,u|0)|0;A=D;w=fi(Mn|0,oo|0,Ts|0,ea|0)|0;M=D;O=fi(Dt|0,$a|0,va|0,ra|0)|0;k=D;N=fi(Dt|0,$a|0,Ha|0,da|0)|0;L=D;x=fi(ei|0,Ka|0,Dt|0,$a|0)|0;F=D;U=fi(R|0,Sa|0,Dt|0,$a|0)|0;V=D;B=(on|0)<0;$=B<<31>>31;j=fi(on|0,$|0,Dt|0,$a|0)|0;G=D;W=fi(yn|0,P|0,Dt|0,$a|0)|0;q=D;z=fi(Mn|0,oo|0,Dt|0,$a|0)|0;K=D;J=fi(Ha|0,da|0,Ha|0,da|0)|0;Y=D;X=(jt|0)<0;Z=X<<31>>31;ee=fi(jt|0,Z|0,r|0,pa|0)|0;te=D;ie=(Ji|0)<0;ne=ie<<31>>31;re=fi(Ji|0,ne|0,jt|0,Z|0)|0;se=D;ae=fi(on|0,$|0,Ha|0,da|0)|0;oe=D;de=fi(yn|0,P|0,jt|0,Z|0)|0;ce=D;he=fi(Mn|0,oo|0,Ha|0,da|0)|0;ue=D;pe=(Ui|0)<0;ge=pe<<31>>31;me=fi(Ui|0,ge|0,r|0,pa|0)|0;fe=D;Se=fi(Ji|0,ne|0,ei|0,Ka|0)|0;ve=D;Ce=fi(on|0,$|0,ei|0,Ka|0)|0;Te=D;Ee=fi(yn|0,P|0,ei|0,Ka|0)|0;_e=D;be=fi(Mn|0,oo|0,ei|0,Ka|0)|0;Pe=D;Ie=fi(Ji|0,ne|0,R|0,Sa|0)|0;Ae=D;Re=fi(on|0,$|0,R|0,Sa|0)|0;we=D;Oe=(mi|0)<0;De=Oe<<31>>31;ke=fi(yn|0,P|0,mi|0,De|0)|0;Ne=D;Le=fi(Mn|0,oo|0,R|0,Sa|0)|0;xe=D;Fe=fi(on|0,$|0,Q|0,Ea|0)|0;Ue=D;Ve=fi(yn|0,P|0,Ai|0,to|0)|0;He=D;$e=fi(Mn|0,oo|0,Ai|0,to|0)|0;je=D;Ge=fi(yn|0,P|0,ye|0,Ia|0)|0;We=D;qe=fi(Mn|0,oo|0,ye|0,Ia|0)|0;ze=D;Ke=fi(Mn|0,oo|0,Be|0,Oa|0)|0;Je=D;Ye=ri(me|0,fe|0,dr|0,Cr|0)|0;Qe=D;Ze=ri(Ye|0,Qe|0,re|0,se|0)|0;et=D;tt=ri(Ze|0,et|0,j|0,G|0)|0;it=D;nt=ri(tt|0,it|0,I|0,A|0)|0;rt=D;st=ri(nt|0,rt|0,a|0,o|0)|0;at=D;ot=ri(Se|0,ve|0,Es|0,ks|0)|0;lt=D;ht=ri(ot|0,lt|0,ae|0,oe|0)|0;ut=D;pt=ri(ht|0,ut|0,W|0,q|0)|0;gt=D;mt=ri(pt|0,gt|0,w|0,M|0)|0;ft=D;St=ri(ta|0,ia|0,xa|0,Fa|0)|0;vt=D;yt=ri(St|0,vt|0,Ie|0,Ae|0)|0;Ct=D;Et=ri(yt|0,Ct|0,Ce|0,Te|0)|0;_t=D;bt=ri(Et|0,_t|0,de|0,ce|0)|0;Pt=D;It=ri(bt|0,Pt|0,z|0,K|0)|0;At=D;Rt=ri(sa|0,aa|0,Ua|0,Va|0)|0;wt=D;Mt=ri(Rt|0,wt|0,Re|0,we|0)|0;Ot=D;kt=ri(Mt|0,Ot|0,Ee|0,_e|0)|0;Nt=D;Lt=ri(kt|0,Nt|0,he|0,ue|0)|0;xt=D;Ft=ri(ja|0,Ga|0,l|0,d|0)|0;Ut=D;Vt=ri(Ft|0,Ut|0,ca|0,ha|0)|0;Ht=D;Bt=ri(Vt|0,Ht|0,Fe|0,Ue|0)|0;$t=D;Gt=ri(Bt|0,$t|0,ke|0,Ne|0)|0;Wt=D;qt=ri(Gt|0,Wt|0,be|0,Pe|0)|0;zt=D;Kt=ri(Wa|0,qa|0,p|0,g|0)|0;Jt=D;Yt=ri(Kt|0,Jt|0,ga|0,ma|0)|0;Qt=D;Xt=ri(Yt|0,Qt|0,Ve|0,He|0)|0;Zt=D;ti=ri(Xt|0,Zt|0,Le|0,xe|0)|0;si=D;ai=ri(O|0,k|0,m|0,f|0)|0;li=D;di=ri(ai|0,li|0,Ja|0,Ya|0)|0;ci=D;hi=ri(di|0,ci|0,ya|0,Ca|0)|0;ui=D;pi=ri(hi|0,ui|0,Ge|0,We|0)|0;gi=D;Si=ri(pi|0,gi|0,$e|0,je|0)|0;vi=D;yi=ri(v|0,y|0,N|0,L|0)|0;Ci=D;Ti=ri(yi|0,Ci|0,Xa|0,Za|0)|0;Ei=D;_i=ri(Ti|0,Ei|0,_a|0,ba|0)|0;bi=D;Pi=ri(_i|0,bi|0,qe|0,ze|0)|0;Ii=D;Ri=ri(C|0,T|0,J|0,Y|0)|0;wi=D;Mi=ri(Ri|0,wi|0,x|0,F|0)|0;Oi=D;Di=ri(Mi|0,Oi|0,io|0,no|0)|0;ki=D;Ni=ri(Di|0,ki|0,Aa|0,Ra|0)|0;Li=D;xi=ri(Ni|0,Li|0,Ke|0,Je|0)|0;Fi=D;Vi=ri(U|0,V|0,ee|0,te|0)|0;Hi=D;Bi=ri(Vi|0,Hi|0,E|0,_|0)|0;$i=D;ji=ri(Bi|0,$i|0,ro|0,so|0)|0;Gi=D;Wi=ri(ji|0,Gi|0,Da|0,ka|0)|0;qi=D;zi=oi(st|0,at|0,1)|0;Ki=D;Yi=oi(mt|0,ft|0,1)|0;Qi=D;Xi=oi(It|0,At|0,1)|0;Zi=D;en=oi(Lt|0,xt|0,1)|0;tn=D;nn=oi(qt|0,zt|0,1)|0;rn=D;sn=oi(ti|0,si|0,1)|0;an=D;ln=oi(Si|0,vi|0,1)|0;dn=D;cn=oi(Pi|0,Ii|0,1)|0;hn=D;un=oi(xi|0,Fi|0,1)|0;pn=D;gn=oi(Wi|0,qi|0,1)|0;mn=D;fn=ri(zi|0,Ki|0,33554432,0)|0;Sn=D;Cn=ii(fn|0,Sn|0,26)|0;Tn=D;En=ri(Cn|0,Tn|0,Yi|0,Qi|0)|0;_n=D;bn=oi(Cn|0,Tn|0,26)|0;Pn=D;In=ni(zi|0,Ki|0,bn|0,Pn|0)|0;An=D;Rn=ri(nn|0,rn|0,33554432,0)|0;wn=D;On=ii(Rn|0,wn|0,26)|0;Dn=D;kn=ri(On|0,Dn|0,sn|0,an|0)|0;Nn=D;Ln=oi(On|0,Dn|0,26)|0;xn=D;Fn=ni(nn|0,rn|0,Ln|0,xn|0)|0;Un=D;Vn=ri(En|0,_n|0,16777216,0)|0;Hn=D;$n=ii(Vn|0,Hn|0,25)|0;jn=D;Gn=ri($n|0,jn|0,Xi|0,Zi|0)|0;Wn=D;qn=oi($n|0,jn|0,25)|0;zn=D;Kn=ni(En|0,_n|0,qn|0,zn|0)|0;Jn=D;Yn=ri(kn|0,Nn|0,16777216,0)|0;Qn=D;Zn=ii(Yn|0,Qn|0,25)|0;er=D;tr=ri(Zn|0,er|0,ln|0,dn|0)|0;ir=D;nr=oi(Zn|0,er|0,25)|0;rr=D;sr=ni(kn|0,Nn|0,nr|0,rr|0)|0;ar=D;or=ri(Gn|0,Wn|0,33554432,0)|0;lr=D;cr=ii(or|0,lr|0,26)|0;hr=D;ur=ri(cr|0,hr|0,en|0,tn|0)|0;pr=D;gr=oi(cr|0,hr|0,26)|0;mr=D;fr=ni(Gn|0,Wn|0,gr|0,mr|0)|0;Sr=D;vr=ri(tr|0,ir|0,33554432,0)|0;yr=D;Tr=ii(vr|0,yr|0,26)|0;Er=D;_r=ri(Tr|0,Er|0,cn|0,hn|0)|0;br=D;Pr=oi(Tr|0,Er|0,26)|0;Ir=D;Ar=ni(tr|0,ir|0,Pr|0,Ir|0)|0;Rr=D;wr=ri(ur|0,pr|0,16777216,0)|0;Mr=D;Dr=ii(wr|0,Mr|0,25)|0;kr=D;Nr=ri(Dr|0,kr|0,Fn|0,Un|0)|0;Lr=D;xr=oi(Dr|0,kr|0,25)|0;Fr=D;Ur=ni(ur|0,pr|0,xr|0,Fr|0)|0;Vr=D;Hr=ri(_r|0,br|0,16777216,0)|0;Br=D;jr=ii(Hr|0,Br|0,25)|0;Gr=D;Wr=ri(jr|0,Gr|0,un|0,pn|0)|0;qr=D;zr=oi(jr|0,Gr|0,25)|0;Kr=D;Jr=ni(_r|0,br|0,zr|0,Kr|0)|0;Yr=D;Qr=ri(Nr|0,Lr|0,33554432,0)|0;Xr=D;es=ii(Qr|0,Xr|0,26)|0;ts=D;is=ri(sr|0,ar|0,es|0,ts|0)|0;ns=D;rs=oi(es|0,ts|0,26)|0;ss=D;as=ni(Nr|0,Lr|0,rs|0,ss|0)|0;os=D;ls=ri(Wr|0,qr|0,33554432,0)|0;ds=D;hs=ii(ls|0,ds|0,26)|0;us=D;ps=ri(hs|0,us|0,gn|0,mn|0)|0;gs=D;ms=oi(hs|0,us|0,26)|0;fs=D;Ss=ni(Wr|0,qr|0,ms|0,fs|0)|0;vs=D;ys=ri(ps|0,gs|0,16777216,0)|0;Cs=D;_s=ii(ys|0,Cs|0,25)|0;bs=D;Ps=fi(_s|0,bs|0,19,0)|0;Is=D;As=ri(Ps|0,Is|0,In|0,An|0)|0;Rs=D;ws=oi(_s|0,bs|0,25)|0;Ms=D;Os=ni(ps|0,gs|0,ws|0,Ms|0)|0;Ds=D;Ns=ri(As|0,Rs|0,33554432,0)|0;Ls=D;xs=ii(Ns|0,Ls|0,26)|0;Fs=D;Us=ri(Kn|0,Jn|0,xs|0,Fs|0)|0;Vs=D;Hs=oi(xs|0,Fs|0,26)|0;Bs=D;$s=ni(As|0,Rs|0,Hs|0,Bs|0)|0;js=D;s[e>>2]=$s;Ws=e+4|0;s[Ws>>2]=Us;qs=e+8|0;s[qs>>2]=fr;zs=e+12|0;s[zs>>2]=Ur;Ks=e+16|0;s[Ks>>2]=as;Js=e+20|0;s[Js>>2]=is;Ys=e+24|0;s[Ys>>2]=Ar;Qs=e+28|0;s[Qs>>2]=Jr;Xs=e+32|0;s[Xs>>2]=Ss;Zs=e+36|0;s[Zs>>2]=Os;h=co;return}function ut(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,r=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0,b=0;var P=0,I=0,A=0,R=0,w=0,M=0,O=0,D=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0,j=0,G=0;var W=0,q=0,z=0,K=0,J=0,Y=0,Q=0,X=0,Z=0,ee=0,te=0,ie=0,ne=0,re=0,se=0,ae=0,oe=0,le=0,de=0;de=h;n=s[t>>2]|0;r=t+4|0;S=s[r>>2]|0;R=t+8|0;V=s[R>>2]|0;Y=t+12|0;re=s[Y>>2]|0;se=t+16|0;ae=s[se>>2]|0;oe=t+20|0;a=s[oe>>2]|0;o=t+24|0;l=s[o>>2]|0;d=t+28|0;c=s[d>>2]|0;u=t+32|0;p=s[u>>2]|0;g=t+36|0;m=s[g>>2]|0;f=s[i>>2]|0;v=i+4|0;y=s[v>>2]|0;C=i+8|0;T=s[C>>2]|0;E=i+12|0;_=s[E>>2]|0;b=i+16|0;P=s[b>>2]|0;I=i+20|0;A=s[I>>2]|0;w=i+24|0;M=s[w>>2]|0;O=i+28|0;D=s[O>>2]|0;k=i+32|0;N=s[k>>2]|0;L=i+36|0;x=s[L>>2]|0;F=n-f|0;U=S-y|0;H=V-T|0;B=re-_|0;$=ae-P|0;j=a-A|0;G=l-M|0;W=c-D|0;q=p-N|0;z=m-x|0;s[e>>2]=F;K=e+4|0;s[K>>2]=U;J=e+8|0;s[J>>2]=H;Q=e+12|0;s[Q>>2]=B;X=e+16|0;s[X>>2]=$;Z=e+20|0;s[Z>>2]=j;ee=e+24|0;s[ee>>2]=G;te=e+28|0;s[te>>2]=W;ie=e+32|0;s[ie>>2]=q;ne=e+36|0;s[ne>>2]=z;h=de;return}function pt(e,t){e=e|0;t=t|0;var i=0,r=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0,b=0;var P=0,I=0,A=0,R=0,w=0,M=0,O=0,D=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0,j=0,G=0;var W=0,q=0,z=0,K=0,J=0,Y=0,Q=0,X=0,Z=0,ee=0,te=0,ie=0,ne=0,re=0,se=0,ae=0,oe=0,le=0,de=0,ce=0;var he=0,ue=0,pe=0,ge=0,me=0,fe=0,Se=0,ve=0,ye=0,Ce=0,Te=0,Ee=0,_e=0,be=0,Pe=0,Ie=0,Ae=0,Re=0,we=0,Me=0;var Oe=0,De=0,ke=0,Ne=0,Le=0,xe=0,Fe=0,Ue=0,Ve=0,He=0,Be=0,$e=0,je=0,Ge=0,We=0,qe=0,ze=0,Ke=0,Je=0,Ye=0;var Qe=0,Xe=0,Ze=0,et=0,tt=0,it=0,nt=0,rt=0,st=0,at=0,ot=0,lt=0,dt=0,ct=0,ht=0,ut=0,pt=0,gt=0,mt=0,ft=0;var St=0,vt=0,yt=0,Ct=0,Tt=0,Et=0,_t=0,bt=0,Pt=0,It=0,At=0,Rt=0,wt=0,Mt=0,Ot=0,Dt=0,kt=0,Nt=0,Lt=0,xt=0;var Ft=0,Ut=0,Vt=0,Ht=0,Bt=0,$t=0,jt=0,Gt=0,Wt=0,qt=0,zt=0,Kt=0,Jt=0,Yt=0,Qt=0,Xt=0,Zt=0,ei=0,ti=0,ii=0;var ni=0,ri=0,si=0,ai=0,oi=0,li=0,di=0,ci=0,hi=0,ui=0,pi=0,gi=0,mi=0,fi=0,Si=0,vi=0,yi=0,Ci=0,Ti=0,Ei=0;var _i=0,bi=0,Pi=0,Ii=0,Ai=0,Ri=0,wi=0,Mi=0,Oi=0,Di=0,ki=0,Ni=0;Ni=h;i=s[t>>2]|0;r=t+4|0;Ze=s[r>>2]|0;ct=t+8|0;Tt=s[ct>>2]|0;Dt=t+12|0;jt=s[Dt>>2]|0;ei=t+16|0;hi=s[ei>>2]|0;Ei=t+20|0;a=s[Ei>>2]|0;v=t+24|0;w=s[v>>2]|0;H=t+28|0;Q=s[H>>2]|0;le=t+32|0;ye=s[le>>2]|0;Me=t+36|0;Be=s[Me>>2]|0;Xe=Be*19|0;et=Xe+16777216|0;tt=et>>25;it=tt+i|0;nt=it>>26;rt=nt+Ze|0;st=rt>>25;at=st+Tt|0;ot=at>>26;lt=ot+jt|0;dt=lt>>25;ht=dt+hi|0;ut=ht>>26;pt=ut+a|0;gt=pt>>25;mt=gt+w|0;ft=mt>>26;St=ft+Q|0;vt=St>>25;yt=vt+ye|0;Ct=yt>>26;Et=Ct+Be|0;_t=Et>>25;bt=_t*19|0;Pt=bt+i|0;It=Pt>>26;At=It+Ze|0;Rt=It<<26;wt=Pt-Rt|0;Mt=At>>25;Ot=Mt+Tt|0;kt=Mt<<25;Nt=At-kt|0;Lt=Ot>>26;xt=Lt+jt|0;Ft=Lt<<26;Ut=Ot-Ft|0;Vt=xt>>25;Ht=Vt+hi|0;Bt=Vt<<25;$t=xt-Bt|0;Gt=Ht>>26;Wt=Gt+a|0;qt=Gt<<26;zt=Ht-qt|0;Kt=Wt>>25;Jt=Kt+w|0;Yt=Kt<<25;Qt=Wt-Yt|0;Xt=Jt>>26;Zt=Xt+Q|0;ti=Xt<<26;ii=Jt-ti|0;ni=Zt>>25;ri=ni+ye|0;si=ni<<25;ai=Zt-si|0;oi=ri>>26;li=oi+Be|0;di=oi<<26;ci=ri-di|0;ui=li&33554431;pi=wt&255;n[e>>0]=pi;gi=wt>>>8;mi=gi&255;fi=e+1|0;n[fi>>0]=mi;Si=wt>>>16;vi=Si&255;yi=e+2|0;n[yi>>0]=vi;Ci=wt>>>24;Ti=Nt<<2;_i=Ti|Ci;bi=_i&255;Pi=e+3|0;n[Pi>>0]=bi;Ii=Nt>>>6;Ai=Ii&255;Ri=e+4|0;n[Ri>>0]=Ai;wi=Nt>>>14;Mi=wi&255;Oi=e+5|0;n[Oi>>0]=Mi;Di=Nt>>>22;o=Ut<<3;l=o|Di;d=l&255;c=e+6|0;n[c>>0]=d;u=Ut>>>5;p=u&255;g=e+7|0;n[g>>0]=p;m=Ut>>>13;f=m&255;S=e+8|0;n[S>>0]=f;y=Ut>>>21;C=$t<<5;T=C|y;E=T&255;_=e+9|0;n[_>>0]=E;b=$t>>>3;P=b&255;I=e+10|0;n[I>>0]=P;A=$t>>>11;R=A&255;M=e+11|0;n[M>>0]=R;O=$t>>>19;D=zt<<6;k=D|O;N=k&255;L=e+12|0;n[L>>0]=N;x=zt>>>2;F=x&255;U=e+13|0;n[U>>0]=F;V=zt>>>10;B=V&255;$=e+14|0;n[$>>0]=B;j=zt>>>18;G=j&255;W=e+15|0;n[W>>0]=G;q=Qt&255;z=e+16|0;n[z>>0]=q;K=Qt>>>8;J=K&255;Y=e+17|0;n[Y>>0]=J;X=Qt>>>16;Z=X&255;ee=e+18|0;n[ee>>0]=Z;te=Qt>>>24;ie=ii<<1;ne=ie|te;re=ne&255;se=e+19|0;n[se>>0]=re;ae=ii>>>7;oe=ae&255;de=e+20|0;n[de>>0]=oe;ce=ii>>>15;he=ce&255;ue=e+21|0;n[ue>>0]=he;pe=ii>>>23;ge=ai<<3;me=ge|pe;fe=me&255;Se=e+22|0;n[Se>>0]=fe;ve=ai>>>5;Ce=ve&255;Te=e+23|0;n[Te>>0]=Ce;Ee=ai>>>13;_e=Ee&255;be=e+24|0;n[be>>0]=_e;Pe=ai>>>21;Ie=ci<<4;Ae=Ie|Pe;Re=Ae&255;we=e+25|0;n[we>>0]=Re;Oe=ci>>>4;De=Oe&255;ke=e+26|0;n[ke>>0]=De;Ne=ci>>>12;Le=Ne&255;xe=e+27|0;n[xe>>0]=Le;Fe=ci>>>20;Ue=ui<<6;Ve=Fe|Ue;He=Ve&255;$e=e+28|0;n[$e>>0]=He;je=li>>>2;Ge=je&255;We=e+29|0;n[We>>0]=Ge;qe=li>>>10;ze=qe&255;Ke=e+30|0;n[Ke>>0]=ze;Je=ui>>>18;Ye=Je&255;Qe=e+31|0;n[Qe>>0]=Ye;h=Ni;return}function gt(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,r=0,s=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0;m=h;h=h+48|0;p=m;n=t+40|0;Xe(e,n,t);r=e+40|0;ut(r,n,t);s=e+80|0;ot(s,e,i);a=i+40|0;ot(r,r,a);o=e+120|0;l=i+120|0;d=t+120|0;ot(o,l,d);c=t+80|0;u=i+80|0;ot(e,c,u);Xe(p,e,e);ut(e,s,r);Xe(r,s,r);Xe(s,p,o);ut(o,p,o);h=m;return}function mt(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;var s=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0,b=0,P=0;var I=0,A=0,R=0,w=0,M=0,O=0,D=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0,j=0,G=0,W=0;var q=0,z=0,K=0,J=0,Y=0,Q=0,X=0,Z=0,ee=0,te=0,ie=0,ne=0,re=0;re=h;h=h+2272|0;Y=re+2016|0;Q=re+1760|0;J=re+480|0;te=re+320|0;ie=re+160|0;K=re;ft(Y,t);ft(Q,r);It(J,i);Pt(te,i);Tt(K,te);gt(te,K,J);Tt(ie,te);s=J+160|0;It(s,ie);gt(te,K,s);Tt(ie,te);a=J+320|0;It(a,ie);gt(te,K,a);Tt(ie,te);v=J+480|0;It(v,ie);gt(te,K,v);Tt(ie,te);w=J+640|0;It(w,ie);gt(te,K,w);Tt(ie,te);H=J+800|0;It(H,ie);gt(te,K,H);Tt(ie,te);j=J+960|0;It(j,ie);gt(te,K,j);Tt(ie,te);G=J+1120|0;It(G,ie);Et(e);Z=255;while(1){q=Y+Z|0;z=n[q>>0]|0;o=z<<24>>24==0;if(!o){X=Z;break}l=Q+Z|0;d=n[l>>0]|0;c=d<<24>>24==0;u=Z+-1|0;if(!c){X=Z;break}W=(Z|0)>0;if(W){Z=u}else{X=u;break}}p=(X|0)>-1;if(p){ee=X}else{h=re;return}while(1){_t(te,e);g=Y+ee|0;m=n[g>>0]|0;f=m<<24>>24>0;if(f){Tt(ie,te);S=n[g>>0]|0;y=S<<24>>24;C=(y|0)/2&-1;T=J+(C*160|0)|0;gt(te,ie,T)}else{E=m<<24>>24<0;if(E){Tt(ie,te);_=n[g>>0]|0;b=_<<24>>24;P=(b|0)/-2&-1;I=J+(P*160|0)|0;Lt(te,ie,I)}}A=Q+ee|0;R=n[A>>0]|0;M=R<<24>>24>0;if(M){Tt(ie,te);O=n[A>>0]|0;D=O<<24>>24;k=(D|0)/2&-1;N=40+(k*120|0)|0;vt(te,ie,N)}else{L=R<<24>>24<0;if(L){Tt(ie,te);x=n[A>>0]|0;F=x<<24>>24;U=(F|0)/-2&-1;V=40+(U*120|0)|0;yt(te,ie,V)}}Ct(e,te);B=ee+-1|0;$=(ee|0)>0;if($){ee=B}else{break}}h=re;return}function ft(e,t){e=e|0;t=t|0;var i=0,r=0,s=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0;var b=0,P=0,I=0,A=0,R=0,w=0,M=0,O=0,D=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0,j=0;var G=0,W=0,q=0,z=0,K=0;K=h;G=0;while(1){i=G>>3;r=t+i|0;f=n[r>>0]|0;A=f&255;L=G&7;x=A>>>L;F=x&1;U=F&255;V=e+G|0;n[V>>0]=U;H=G+1|0;j=(H|0)==256;if(j){W=0;break}else{G=H}}while(1){s=e+W|0;a=n[s>>0]|0;o=a<<24>>24==0;e:do{if(!o){B=1;while(1){l=B+W|0;d=(l|0)<256;if(!d){break e}c=e+l|0;u=n[c>>0]|0;p=u<<24>>24==0;t:do{if(!p){g=n[s>>0]|0;m=g<<24>>24;S=u<<24>>24;v=S<<B;y=m+v|0;C=(y|0)<16;if(C){T=y&255;n[s>>0]=T;n[c>>0]=0;break}E=m-v|0;_=(E|0)>-16;if(!_){break e}b=E&255;n[s>>0]=b;P=(l|0)<256;if(P){q=l;while(1){I=e+q|0;R=n[I>>0]|0;w=R<<24>>24==0;if(w){break}n[I>>0]=0;M=q+1|0;O=(M|0)<256;if(O){q=M}else{break t}}n[I>>0]=1}}}while(0);D=B+1|0;k=(D|0)<7;if(k){B=D}else{break}}}}while(0);N=W+1|0;$=(N|0)==256;if($){break}else{W=N}}h=K;return}function St(e,t){e=e|0;t=t|0;var i=0,r=0,s=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0;var b=0;b=h;h=h+208|0;y=b+160|0;C=b+120|0;T=b+80|0;E=b+40|0;v=b;r=e+40|0;tt(r,t);s=e+80|0;Qe(s);ct(y,r);ot(C,y,1000);ut(y,y,s);Xe(C,C,s);ct(T,C);ot(T,T,C);ct(e,T);ot(e,e,C);ot(e,e,y);dt(e,e);ot(e,e,T);ot(e,e,y);ct(E,e);ot(E,E,C);ut(v,E,y);d=at(v)|0;c=(d|0)==0;do{if(!c){Xe(v,E,y);u=at(v)|0;p=(u|0)==0;if(p){ot(e,e,1040);break}else{i=-1;h=b;return i|0}}}while(0);g=st(e)|0;m=t+31|0;f=n[m>>0]|0;S=f&255;a=S>>>7;o=(g|0)==(a|0);if(o){lt(e,e)}l=e+120|0;ot(l,e,r);i=0;h=b;return i|0}function vt(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,r=0,s=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0;g=h;h=h+48|0;u=g;n=t+40|0;Xe(e,n,t);r=e+40|0;ut(r,n,t);s=e+80|0;ot(s,e,i);a=i+40|0;ot(r,r,a);o=e+120|0;l=i+80|0;d=t+120|0;ot(o,l,d);c=t+80|0;Xe(u,c,c);ut(e,s,r);Xe(r,s,r);Xe(s,u,o);ut(o,u,o);h=g;return}function yt(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,r=0,s=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0;g=h;h=h+48|0;u=g;n=t+40|0;Xe(e,n,t);r=e+40|0;ut(r,n,t);s=e+80|0;a=i+40|0;ot(s,e,a);ot(r,r,i);o=e+120|0;l=i+80|0;d=t+120|0;ot(o,l,d);c=t+80|0;Xe(u,c,c);ut(e,s,r);Xe(r,s,r);ut(s,u,o);Xe(o,u,o);h=g;return}function Ct(e,t){e=e|0;t=t|0;var i=0,n=0,r=0,s=0,a=0,o=0,l=0;l=h;i=t+120|0;ot(e,t,i);n=e+40|0;r=t+40|0;s=t+80|0;ot(n,r,s);a=e+80|0;ot(a,s,i);h=l;return}function Tt(e,t){e=e|0;t=t|0;var i=0,n=0,r=0,s=0,a=0,o=0,l=0,d=0;d=h;i=t+120|0;ot(e,t,i);n=e+40|0;r=t+40|0;s=t+80|0;ot(n,r,s);a=e+80|0;ot(a,s,i);o=e+120|0;ot(o,t,r);h=d;return}function Et(e){e=e|0;var t=0,i=0,n=0,r=0;r=h;Ye(e);t=e+40|0;Qe(t);i=e+80|0;Qe(i);h=r;return}function _t(e,t){e=e|0;t=t|0;var i=0,n=0,r=0,s=0,a=0,o=0,l=0,d=0;d=h;h=h+48|0;o=d;ct(e,t);i=e+80|0;n=t+40|0;ct(i,n);r=e+120|0;s=t+80|0;ht(r,s);a=e+40|0;Xe(a,t,n);ct(o,a);Xe(a,i,e);ut(i,i,e);ut(e,o,a);ut(r,r,i);h=d;return}function bt(e){e=e|0;var t=0,i=0,n=0,r=0,s=0;s=h;Ye(e);t=e+40|0;Qe(t);i=e+80|0;Qe(i);n=e+120|0;Ye(n);h=s;return}function Pt(e,t){e=e|0;t=t|0;var i=0,n=0,r=0;r=h;h=h+128|0;i=r;At(i,t);_t(e,i);h=r;return}function It(e,t){e=e|0;t=t|0;var i=0,n=0,r=0,s=0,a=0,o=0,l=0,d=0;d=h;i=t+40|0;Xe(e,i,t);n=e+40|0;ut(n,i,t);r=e+80|0;s=t+80|0;et(r,s);a=e+120|0;o=t+120|0;ot(a,o,1080);h=d;return}function At(e,t){e=e|0;t=t|0;var i=0,n=0,r=0,s=0,a=0,o=0;o=h;et(e,t);i=e+40|0;n=t+40|0;et(i,n);r=e+80|0;s=t+80|0;et(r,s);h=o;return}function Rt(e,t){e=e|0;t=t|0;var i=0,r=0,s=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0;S=h;h=h+128|0;p=S+80|0;g=S+40|0;m=S;i=t+80|0;rt(p,i);ot(g,t,p);r=t+40|0;ot(m,r,p);pt(e,m);s=st(g)|0;a=s<<7;o=e+31|0;l=n[o>>0]|0;d=l&255;c=d^a;u=c&255;n[o>>0]=u;h=S;return}function wt(e){e=e|0;var t=0,i=0,n=0,r=0;r=h;Qe(e);t=e+40|0;Qe(t);i=e+80|0;Ye(i);h=r;return}function Mt(e,t){e=e|0;t=t|0;var i=0,r=0,s=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0;var b=0,P=0,I=0,A=0,R=0,w=0,M=0,O=0,D=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0,j=0;var G=0,W=0,q=0,z=0,K=0,J=0,Y=0,Q=0,X=0,Z=0,ee=0;ee=h;h=h+464|0;B=ee+400|0;K=ee+240|0;J=ee+120|0;X=ee;G=0;while(1){i=t+G|0;r=n[i>>0]|0;f=r&255;A=f&15;N=A&255;L=G<<1;x=B+L|0;n[x>>0]=N;F=n[i>>0]|0;U=(F&255)>>>4;V=L|1;s=B+V|0;n[s>>0]=U;a=G+1|0;j=(a|0)==32;if(j){H=0;W=0;break}else{G=a}}while(1){o=B+W|0;l=n[o>>0]|0;d=l&255;c=d+H|0;Y=c<<24;Q=Y+134217728|0;u=Q>>28;p=u<<4;g=c-p|0;m=g&255;n[o>>0]=m;S=W+1|0;$=(S|0)==63;if($){break}else{H=u;W=S}}v=B+63|0;y=n[v>>0]|0;C=y&255;T=C+u|0;E=T&255;n[v>>0]=E;bt(e);q=1;while(1){_=(q|0)/2&-1;b=B+q|0;P=n[b>>0]|0;Ot(X,_,P);vt(K,e,X);Tt(e,K);I=q+2|0;R=(I|0)<64;if(R){q=I}else{break}}Pt(K,e);Ct(J,K);_t(K,J);Ct(J,K);_t(K,J);Ct(J,K);_t(K,J);Tt(e,K);z=0;while(1){w=(z|0)/2&-1;M=B+z|0;O=n[M>>0]|0;Ot(X,w,O);vt(K,e,X);Tt(e,K);D=z+2|0;k=(D|0)<64;if(k){z=D}else{break}}h=ee;return}function Ot(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,r=0,s=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0;var b=0,P=0,I=0,A=0,R=0,w=0,M=0,O=0,D=0,k=0,N=0;N=h;h=h+128|0;D=N;n=Dt(i)|0;r=i<<24>>24;f=n&255;P=0-f|0;I=r&P;A=I<<1;R=r-A|0;w=R&255;wt(e);M=1120+(t*960|0)|0;O=kt(w,1)|0;Nt(e,M,O);s=(1120+(t*960|0)|0)+120|0;a=kt(w,2)|0;Nt(e,s,a);o=(1120+(t*960|0)|0)+240|0;l=kt(w,3)|0;Nt(e,o,l);d=(1120+(t*960|0)|0)+360|0;c=kt(w,4)|0;Nt(e,d,c);u=(1120+(t*960|0)|0)+480|0;p=kt(w,5)|0;Nt(e,u,p);g=(1120+(t*960|0)|0)+600|0;m=kt(w,6)|0;Nt(e,g,m);S=(1120+(t*960|0)|0)+720|0;v=kt(w,7)|0;Nt(e,S,v);y=(1120+(t*960|0)|0)+840|0;C=kt(w,8)|0;Nt(e,y,C);T=e+40|0;et(D,T);E=D+40|0;et(E,e);_=D+80|0;b=e+80|0;lt(_,b);Nt(e,D,n);h=N;return}function Dt(e){e=e|0;var t=0,i=0,n=0,r=0,s=0,a=0,o=0,l=0;l=h;t=e<<24>>24;i=(t|0)<0;n=i<<31>>31;r=ai(t|0,n|0,63)|0;s=D;a=r&255;h=l;return a|0}function kt(e,t){e=e|0;t=t|0;var i=0,n=0,r=0,s=0,a=0,o=0,l=0;l=h;i=t^e;n=i&255;r=n+-1|0;s=r>>>31;a=s&255;h=l;return a|0}function Nt(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,r=0,s=0,a=0,o=0,l=0,d=0;d=h;n=i&255;Ze(e,t,n);r=e+40|0;s=t+40|0;Ze(r,s,n);a=e+80|0;o=t+80|0;Ze(a,o,n);h=d;return}function Lt(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,r=0,s=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0;m=h;h=h+48|0;p=m;n=t+40|0;Xe(e,n,t);r=e+40|0;ut(r,n,t);s=e+80|0;a=i+40|0;ot(s,e,a);ot(r,r,i);o=e+120|0;l=i+120|0;d=t+120|0;ot(o,l,d);c=t+80|0;u=i+80|0;ot(e,c,u);Xe(p,e,e);ut(e,s,r);Xe(r,s,r);ut(s,p,o);Xe(o,p,o);h=m;return}function xt(e,t){e=e|0;t=t|0;var i=0,r=0,s=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0;S=h;h=h+128|0;p=S+80|0;g=S+40|0;m=S;i=t+80|0;rt(p,i);ot(g,t,p);r=t+40|0;ot(m,r,p);pt(e,m);s=st(g)|0;a=s<<7;o=e+31|0;l=n[o>>0]|0;d=l&255;c=d^a;u=c&255;n[o>>0]=u;h=S;return}function Ft(e,t,i,r,a,o){e=e|0;t=t|0;i=i|0;r=r|0;a=a|0;o=o|0;var l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0,b=0,P=0,I=0,A=0,R=0;var w=0,M=0,O=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0,j=0,G=0,W=0,q=0,z=0,K=0,J=0;z=h;h=h+480|0;B=z+440|0;j=z+408|0;G=z+376|0;H=z+312|0;$=z+280|0;U=z+120|0;V=z;T=a>>>0<0;M=r>>>0<64;O=(a|0)==0;k=O&M;N=T|k;if(!N){L=i+63|0;x=n[L>>0]|0;F=(x&255)>31;if(!F){c=St(U,o)|0;u=(c|0)==0;if(u){W=B+0|0;K=o+0|0;J=W+32|0;do{n[W>>0]=n[K>>0]|0;W=W+1|0;K=K+1|0}while((W|0)<(J|0));W=j+0|0;K=i+0|0;J=W+32|0;do{n[W>>0]=n[K>>0]|0;W=W+1|0;K=K+1|0}while((W|0)<(J|0));p=i+32|0;W=G+0|0;K=p+0|0;J=W+32|0;do{n[W>>0]=n[K>>0]|0;W=W+1|0;K=K+1|0}while((W|0)<(J|0));ci(e|0,i|0,r|0)|0;g=e+32|0;W=g+0|0;K=B+0|0;J=W+32|0;do{n[W>>0]=n[K>>0]|0;W=W+1|0;K=K+1|0}while((W|0)<(J|0));Re(H,e,r,a)|0;Bt(H);mt(V,H,U,G);xt($,V);m=Pe($,j)|0;f=(m|0)==0;if(f){S=e+64|0;v=ri(r|0,a|0,-64,-1)|0;y=D;ci(e|0,S|0,v|0)|0;d=r+-64|0;C=e+d|0;W=C+0|0;J=W+64|0;do{n[W>>0]=0|0;W=W+1|0}while((W|0)<(J|0));E=t;_=E;s[_>>2]=v;b=E+4|0;P=b;s[P>>2]=y;l=0;h=z;return l|0}}}}I=t;A=I;s[A>>2]=-1;R=I+4|0;w=R;s[w>>2]=-1;si(e|0,0,r|0)|0;l=-1;h=z;return l|0}function Ut(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;var s=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0,b=0,P=0;var I=0,A=0,R=0,w=0,M=0,O=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0,j=0,G=0,W=0,q=0;var z=0,K=0,J=0,Y=0,Q=0,X=0,Z=0,ee=0,te=0,ie=0,ne=0,re=0,se=0,ae=0,oe=0,le=0,de=0,ce=0,he=0,ue=0;var pe=0,ge=0,me=0,fe=0,Se=0,ve=0,ye=0,Ce=0,Te=0,Ee=0,_e=0,be=0,Pe=0,Ie=0,Ae=0,Re=0,we=0,Me=0,Oe=0,De=0;var ke=0,Ne=0,Le=0,xe=0,Fe=0,Ue=0,Ve=0,He=0,Be=0,$e=0,je=0,Ge=0,We=0,qe=0,ze=0,Ke=0,Je=0,Ye=0,Qe=0,Xe=0;var Ze=0,et=0,tt=0,it=0,nt=0,rt=0,st=0,at=0,ot=0,lt=0,dt=0,ct=0,ht=0,ut=0,pt=0,gt=0,mt=0,ft=0,St=0,vt=0;var yt=0,Ct=0,Tt=0,Et=0,_t=0,bt=0,Pt=0,It=0,At=0,Rt=0,wt=0,Mt=0,Ot=0,Dt=0,kt=0,Nt=0,Lt=0,xt=0,Ft=0,Ut=0;var Bt=0,$t=0,jt=0,Gt=0,Wt=0,qt=0,zt=0,Kt=0,Jt=0,Yt=0,Qt=0,Xt=0,Zt=0,ei=0,ti=0,si=0,li=0,di=0,ci=0,hi=0;var ui=0,pi=0,gi=0,mi=0,Si=0,vi=0,yi=0,Ci=0,Ti=0,Ei=0,_i=0,bi=0,Pi=0,Ii=0,Ai=0,Ri=0,wi=0,Mi=0,Oi=0,Di=0;var ki=0,Ni=0,Li=0,xi=0,Fi=0,Ui=0,Vi=0,Hi=0,Bi=0,$i=0,ji=0,Gi=0,Wi=0,qi=0,zi=0,Ki=0,Ji=0,Yi=0,Qi=0,Xi=0;var Zi=0,en=0,tn=0,nn=0,rn=0,sn=0,an=0,on=0,ln=0,dn=0,cn=0,hn=0,un=0,pn=0,gn=0,mn=0,fn=0,Sn=0,vn=0,yn=0;var Cn=0,Tn=0,En=0,_n=0,bn=0,Pn=0,In=0,An=0,Rn=0,wn=0,Mn=0,On=0,Dn=0,kn=0,Nn=0,Ln=0,xn=0,Fn=0,Un=0,Vn=0;var Hn=0,Bn=0,$n=0,jn=0,Gn=0,Wn=0,qn=0,zn=0,Kn=0,Jn=0,Yn=0,Qn=0,Xn=0,Zn=0,er=0,tr=0,ir=0,nr=0,rr=0,sr=0;var ar=0,or=0,lr=0,dr=0,cr=0,hr=0,ur=0,pr=0,gr=0,mr=0,fr=0,Sr=0,vr=0,yr=0,Cr=0,Tr=0,Er=0,_r=0,br=0,Pr=0;var Ir=0,Ar=0,Rr=0,wr=0,Mr=0,Or=0,Dr=0,kr=0,Nr=0,Lr=0,xr=0,Fr=0,Ur=0,Vr=0,Hr=0,Br=0,$r=0,jr=0,Gr=0,Wr=0;var qr=0,zr=0,Kr=0,Jr=0,Yr=0,Qr=0,Xr=0,Zr=0,es=0,ts=0,is=0,ns=0,rs=0,ss=0,as=0,os=0,ls=0,ds=0,cs=0,hs=0;var us=0,ps=0,gs=0,ms=0,fs=0,Ss=0,vs=0,ys=0,Cs=0,Ts=0,Es=0,_s=0,bs=0,Ps=0,Is=0,As=0,Rs=0,ws=0,Ms=0,Os=0;var Ds=0,ks=0,Ns=0,Ls=0,xs=0,Fs=0,Us=0,Vs=0,Hs=0,Bs=0,$s=0,js=0,Gs=0,Ws=0,qs=0,zs=0,Ks=0,Js=0,Ys=0,Qs=0;var Xs=0,Zs=0,ea=0,ta=0,ia=0,na=0,ra=0,sa=0,aa=0,oa=0,la=0,da=0,ca=0,ha=0,ua=0,pa=0,ga=0,ma=0,fa=0,Sa=0;var va=0,ya=0,Ca=0,Ta=0,Ea=0,_a=0,ba=0,Pa=0,Ia=0,Aa=0,Ra=0,wa=0,Ma=0,Oa=0,Da=0,ka=0,Na=0,La=0,xa=0,Fa=0;var Ua=0,Va=0,Ha=0,Ba=0,$a=0,ja=0,Ga=0,Wa=0,qa=0,za=0,Ka=0,Ja=0,Ya=0,Qa=0,Xa=0,Za=0,eo=0,to=0,io=0,no=0;var ro=0,so=0,ao=0,oo=0,lo=0,co=0,ho=0,uo=0,po=0,go=0,mo=0,fo=0,So=0,vo=0,yo=0,Co=0,To=0,Eo=0,_o=0,bo=0;var Po=0,Io=0,Ao=0,Ro=0,wo=0,Mo=0,Oo=0,Do=0,ko=0,No=0,Lo=0,xo=0,Fo=0,Uo=0,Vo=0,Ho=0,Bo=0,$o=0,jo=0,Go=0;var Wo=0,qo=0,zo=0,Ko=0,Jo=0,Yo=0,Qo=0,Xo=0,Zo=0,el=0,tl=0,il=0,nl=0,rl=0,sl=0,al=0,ol=0,ll=0,dl=0,cl=0;var hl=0,ul=0,pl=0,gl=0,ml=0,fl=0,Sl=0,vl=0,yl=0,Cl=0,Tl=0,El=0,_l=0,bl=0,Pl=0,Il=0,Al=0,Rl=0,wl=0,Ml=0;var Ol=0,Dl=0,kl=0,Nl=0,Ll=0,xl=0,Fl=0,Ul=0,Vl=0,Hl=0,Bl=0,$l=0,jl=0,Gl=0,Wl=0,ql=0,zl=0,Kl=0,Jl=0,Yl=0;var Ql=0,Xl=0,Zl=0,ed=0,td=0,id=0,nd=0,rd=0,sd=0,ad=0,od=0,ld=0,dd=0,cd=0,hd=0,ud=0,pd=0,gd=0,md=0,fd=0;var Sd=0,vd=0,yd=0,Cd=0,Td=0,Ed=0,_d=0,bd=0,Pd=0,Id=0,Ad=0,Rd=0,wd=0,Md=0,Od=0,Dd=0,kd=0,Nd=0,Ld=0,xd=0;var Fd=0,Ud=0,Vd=0,Hd=0,Bd=0,$d=0,jd=0,Gd=0,Wd=0,qd=0,zd=0,Kd=0,Jd=0,Yd=0,Qd=0,Xd=0,Zd=0,ec=0,tc=0,ic=0;var nc=0,rc=0,sc=0,ac=0,oc=0,lc=0,dc=0,cc=0,hc=0,uc=0,pc=0,gc=0,mc=0,fc=0,Sc=0,vc=0,yc=0,Cc=0,Tc=0,Ec=0;var _c=0,bc=0,Pc=0,Ic=0,Ac=0,Rc=0,wc=0,Mc=0,Oc=0,Dc=0,kc=0,Nc=0,Lc=0,xc=0,Fc=0,Uc=0,Vc=0,Hc=0,Bc=0,$c=0;var jc=0,Gc=0,Wc=0,qc=0,zc=0,Kc=0,Jc=0,Yc=0,Qc=0,Xc=0,Zc=0,eh=0,th=0,ih=0,nh=0,rh=0,sh=0,ah=0,oh=0,lh=0;var dh=0,ch=0,hh=0,uh=0,ph=0,gh=0,mh=0,fh=0,Sh=0,vh=0,yh=0,Ch=0,Th=0,Eh=0,_h=0,bh=0,Ph=0,Ih=0,Ah=0,Rh=0;var wh=0,Mh=0,Oh=0,Dh=0,kh=0,Nh=0,Lh=0,xh=0,Fh=0,Uh=0,Vh=0,Hh=0,Bh=0,$h=0,jh=0,Gh=0,Wh=0,qh=0,zh=0,Kh=0;var Jh=0,Yh=0,Qh=0,Xh=0,Zh=0,eu=0,tu=0,iu=0,nu=0,ru=0,su=0,au=0,ou=0,lu=0,du=0,cu=0,hu=0,uu=0,pu=0,gu=0;var mu=0,fu=0,Su=0,vu=0,yu=0,Cu=0,Tu=0,Eu=0,_u=0,bu=0,Pu=0,Iu=0,Au=0,Ru=0,wu=0,Mu=0,Ou=0,Du=0,ku=0,Nu=0;var Lu=0,xu=0,Fu=0,Uu=0,Vu=0,Hu=0,Bu=0,$u=0,ju=0,Gu=0,Wu=0,qu=0,zu=0,Ku=0,Ju=0,Yu=0,Qu=0,Xu=0,Zu=0,ep=0;var tp=0,ip=0,np=0,rp=0,sp=0,ap=0,op=0,lp=0,dp=0,cp=0,hp=0,up=0,pp=0,gp=0,mp=0,fp=0,Sp=0,vp=0,yp=0,Cp=0;var Tp=0,Ep=0,_p=0,bp=0,Pp=0,Ip=0,Ap=0,Rp=0,wp=0,Mp=0,Op=0,Dp=0,kp=0,Np=0,Lp=0,xp=0,Fp=0,Up=0,Vp=0,Hp=0;var Bp=0,$p=0,jp=0,Gp=0,Wp=0,qp=0,zp=0,Kp=0,Jp=0,Yp=0,Qp=0,Xp=0,Zp=0,eg=0,tg=0,ig=0,ng=0,rg=0,sg=0,ag=0;var og=0,lg=0,dg=0,cg=0,hg=0,ug=0,pg=0,gg=0,mg=0,fg=0,Sg=0,vg=0,yg=0,Cg=0,Tg=0,Eg=0,_g=0,bg=0,Pg=0,Ig=0;var Ag=0,Rg=0,wg=0,Mg=0,Og=0,Dg=0,kg=0,Ng=0,Lg=0,xg=0,Fg=0,Ug=0,Vg=0,Hg=0,Bg=0,$g=0,jg=0,Gg=0,Wg=0,qg=0;var zg=0,Kg=0,Jg=0,Yg=0,Qg=0,Xg=0,Zg=0,em=0,tm=0,im=0,nm=0,rm=0,sm=0,am=0,om=0,lm=0,dm=0,cm=0,hm=0,um=0;var pm=0,gm=0,mm=0,fm=0,Sm=0,vm=0,ym=0,Cm=0,Tm=0,Em=0,_m=0,bm=0,Pm=0,Im=0,Am=0,Rm=0,wm=0,Mm=0,Om=0,Dm=0;var km=0,Nm=0,Lm=0,xm=0,Fm=0,Um=0,Vm=0,Hm=0,Bm=0,$m=0,jm=0,Gm=0,Wm=0,qm=0,zm=0,Km=0,Jm=0,Ym=0,Qm=0,Xm=0;var Zm=0,ef=0,tf=0,nf=0,rf=0,sf=0,af=0,of=0,lf=0,df=0,cf=0,hf=0,uf=0,pf=0,gf=0,mf=0,ff=0,Sf=0,vf=0,yf=0;var Cf=0,Tf=0,Ef=0,_f=0,bf=0,Pf=0,If=0,Af=0,Rf=0,wf=0,Mf=0,Of=0,Df=0,kf=0,Nf=0,Lf=0,xf=0,Ff=0,Uf=0,Vf=0;var Hf=0,Bf=0,$f=0,jf=0,Gf=0,Wf=0,qf=0,zf=0,Kf=0,Jf=0,Yf=0,Qf=0,Xf=0,Zf=0,eS=0,tS=0,iS=0,nS=0,rS=0,sS=0;var aS=0,oS=0,lS=0,dS=0,cS=0,hS=0,uS=0,pS=0,gS=0,mS=0,fS=0,SS=0,vS=0,yS=0,CS=0,TS=0,ES=0,_S=0,bS=0,PS=0;var IS=0,AS=0,RS=0,wS=0,MS=0,OS=0,DS=0,kS=0,NS=0,LS=0,xS=0,FS=0,US=0,VS=0,HS=0,BS=0,$S=0,jS=0,GS=0,WS=0;var qS=0,zS=0,KS=0,JS=0,YS=0,QS=0,XS=0,ZS=0,ev=0,tv=0,iv=0,nv=0,rv=0,sv=0,av=0,ov=0,lv=0,dv=0,cv=0,hv=0;var uv=0,pv=0,gv=0,mv=0,fv=0,Sv=0,vv=0,yv=0,Cv=0,Tv=0,Ev=0,_v=0,bv=0,Pv=0,Iv=0,Av=0,Rv=0,wv=0,Mv=0,Ov=0;var Dv=0,kv=0,Nv=0,Lv=0,xv=0,Fv=0,Uv=0,Vv=0,Hv=0,Bv=0,$v=0,jv=0,Gv=0,Wv=0,qv=0,zv=0,Kv=0,Jv=0,Yv=0,Qv=0;var Xv=0,Zv=0,ey=0,ty=0,iy=0,ny=0,ry=0,sy=0,ay=0,oy=0,ly=0,dy=0,cy=0,hy=0,uy=0,py=0,gy=0,my=0,fy=0,Sy=0;var vy=0,yy=0,Cy=0,Ty=0,Ey=0,_y=0,by=0,Py=0,Iy=0,Ay=0,Ry=0,wy=0,My=0,Oy=0,Dy=0,ky=0,Ny=0,Ly=0,xy=0,Fy=0;var Uy=0,Vy=0,Hy=0,By=0,$y=0,jy=0,Gy=0,Wy=0,qy=0,zy=0,Ky=0,Jy=0,Yy=0,Qy=0,Xy=0,Zy=0,eC=0,tC=0,iC=0,nC=0;var rC=0,sC=0,aC=0,oC=0,lC=0,dC=0,cC=0,hC=0,uC=0,pC=0,gC=0,mC=0,fC=0,SC=0,vC=0,yC=0,CC=0,TC=0,EC=0,_C=0;var bC=0,PC=0,IC=0,AC=0,RC=0,wC=0,MC=0,OC=0,DC=0,kC=0,NC=0,LC=0,xC=0,FC=0,UC=0,VC=0,HC=0,BC=0,$C=0,jC=0;var GC=0,WC=0,qC=0,zC=0,KC=0,JC=0,YC=0,QC=0,XC=0,ZC=0,eT=0,tT=0,iT=0,nT=0,rT=0,sT=0,aT=0,oT=0,lT=0,dT=0;var cT=0,hT=0,uT=0,pT=0,gT=0,mT=0,fT=0,ST=0,vT=0,yT=0,CT=0,TT=0,ET=0,_T=0,bT=0,PT=0,IT=0,AT=0,RT=0,wT=0;var MT=0,OT=0,DT=0,kT=0,NT=0,LT=0,xT=0,FT=0,UT=0,VT=0,HT=0,BT=0,$T=0,jT=0,GT=0,WT=0,qT=0,zT=0,KT=0,JT=0;var YT=0,QT=0,XT=0,ZT=0,eE=0,tE=0,iE=0,nE=0,rE=0,sE=0,aE=0,oE=0,lE=0,dE=0,cE=0,hE=0,uE=0,pE=0,gE=0,mE=0;var fE=0,SE=0,vE=0,yE=0,CE=0,TE=0,EE=0,_E=0,bE=0,PE=0,IE=0,AE=0,RE=0,wE=0,ME=0,OE=0,DE=0,kE=0,NE=0,LE=0;var xE=0,FE=0,UE=0,VE=0,HE=0,BE=0,$E=0,jE=0,GE=0,WE=0,qE=0,zE=0,KE=0,JE=0,YE=0,QE=0,XE=0,ZE=0,e_=0,t_=0;var i_=0,n_=0,r_=0,s_=0,a_=0,o_=0,l_=0,d_=0,c_=0,h_=0,u_=0,p_=0,g_=0,m_=0,f_=0,S_=0,v_=0,y_=0,C_=0,T_=0;var E_=0,__=0,b_=0,P_=0,I_=0,A_=0,R_=0,w_=0,M_=0,O_=0,D_=0,k_=0,N_=0,L_=0,x_=0,F_=0,U_=0,V_=0,H_=0,B_=0;var $_=0,j_=0,G_=0,W_=0,q_=0,z_=0,K_=0,J_=0,Y_=0,Q_=0,X_=0,Z_=0,eb=0,tb=0,ib=0,nb=0,rb=0,sb=0,ab=0,ob=0;var lb=0,db=0,cb=0,hb=0,ub=0,pb=0,gb=0,mb=0,fb=0,Sb=0,vb=0,yb=0,Cb=0,Tb=0,Eb=0,_b=0,bb=0,Pb=0,Ib=0,Ab=0;var Rb=0,wb=0,Mb=0,Ob=0,Db=0,kb=0,Nb=0,Lb=0,xb=0,Fb=0,Ub=0,Vb=0,Hb=0,Bb=0,$b=0,jb=0,Gb=0,Wb=0,qb=0,zb=0;var Kb=0,Jb=0,Yb=0,Qb=0,Xb=0,Zb=0,eP=0,tP=0,iP=0,nP=0,rP=0,sP=0,aP=0,oP=0,lP=0,dP=0,cP=0,hP=0,uP=0,pP=0;var gP=0,mP=0,fP=0,SP=0,vP=0,yP=0,CP=0,TP=0,EP=0,_P=0,bP=0,PP=0,IP=0,AP=0,RP=0,wP=0,MP=0,OP=0,DP=0,kP=0;var NP=0,LP=0,xP=0,FP=0,UP=0,VP=0,HP=0,BP=0,$P=0,jP=0,GP=0,WP=0,qP=0,zP=0,KP=0,JP=0,YP=0,QP=0,XP=0,ZP=0;var eI=0,tI=0,iI=0,nI=0,rI=0,sI=0,aI=0,oI=0,lI=0,dI=0,cI=0,hI=0,uI=0,pI=0,gI=0,mI=0,fI=0,SI=0,vI=0,yI=0;var CI=0,TI=0,EI=0,_I=0,bI=0,PI=0,II=0,AI=0,RI=0,wI=0,MI=0,OI=0,DI=0,kI=0,NI=0,LI=0,xI=0,FI=0,UI=0,VI=0;var HI=0,BI=0,$I=0,jI=0,GI=0,WI=0,qI=0,zI=0,KI=0,JI=0,YI=0,QI=0,XI=0,ZI=0,eA=0,tA=0,iA=0,nA=0,rA=0,sA=0;var aA=0,oA=0,lA=0,dA=0,cA=0,hA=0,uA=0,pA=0,gA=0,mA=0,fA=0,SA=0,vA=0,yA=0,CA=0,TA=0,EA=0,_A=0,bA=0,PA=0;var IA=0,AA=0,RA=0,wA=0,MA=0,OA=0,DA=0,kA=0,NA=0,LA=0,xA=0,FA=0,UA=0,VA=0,HA=0,BA=0,$A=0,jA=0,GA=0,WA=0;var qA=0,zA=0,KA=0,JA=0,YA=0,QA=0,XA=0,ZA=0,eR=0,tR=0,iR=0,nR=0,rR=0,sR=0,aR=0,oR=0,lR=0,dR=0,cR=0,hR=0;var uR=0,pR=0,gR=0,mR=0,fR=0,SR=0,vR=0,yR=0,CR=0,TR=0,ER=0,_R=0,bR=0,PR=0,IR=0,AR=0,RR=0,wR=0,MR=0,OR=0;var DR=0,kR=0,NR=0,LR=0,xR=0,FR=0,UR=0,VR=0,HR=0,BR=0,$R=0,jR=0,GR=0,WR=0,qR=0,zR=0,KR=0,JR=0,YR=0,QR=0;var XR=0,ZR=0,ew=0,tw=0,iw=0,nw=0,rw=0,sw=0,aw=0,ow=0,lw=0,dw=0,cw=0,hw=0,uw=0,pw=0,gw=0,mw=0,fw=0,Sw=0;var vw=0,yw=0,Cw=0,Tw=0,Ew=0,_w=0,bw=0,Pw=0,Iw=0,Aw=0,Rw=0,ww=0,Mw=0,Ow=0,Dw=0,kw=0,Nw=0,Lw=0,xw=0,Fw=0;var Uw=0,Vw=0,Hw=0,Bw=0,$w=0,jw=0,Gw=0,Ww=0,qw=0,zw=0,Kw=0,Jw=0,Yw=0,Qw=0,Xw=0,Zw=0,eM=0,tM=0,iM=0,nM=0;var rM=0,sM=0,aM=0,oM=0,lM=0,dM=0,cM=0,hM=0,uM=0,pM=0,gM=0,mM=0,fM=0,SM=0,vM=0,yM=0,CM=0,TM=0,EM=0,_M=0;var bM=0,PM=0,IM=0,AM=0,RM=0,wM=0,MM=0,OM=0,DM=0,kM=0,NM=0,LM=0,xM=0,FM=0,UM=0,VM=0,HM=0,BM=0,$M=0,jM=0;var GM=0,WM=0,qM=0,zM=0,KM=0,JM=0,YM=0,QM=0,XM=0,ZM=0,eO=0,tO=0,iO=0,nO=0,rO=0,sO=0,aO=0,oO=0,lO=0,dO=0;var cO=0,hO=0,uO=0,pO=0,gO=0,mO=0,fO=0,SO=0,vO=0,yO=0,CO=0,TO=0,EO=0,_O=0,bO=0,PO=0,IO=0,AO=0,RO=0,wO=0;var MO=0,OO=0,DO=0,kO=0,NO=0,LO=0,xO=0,FO=0,UO=0,VO=0,HO=0,BO=0,$O=0,jO=0,GO=0,WO=0,qO=0,zO=0,KO=0,JO=0;var YO=0,QO=0,XO=0,ZO=0,eD=0,tD=0,iD=0,nD=0,rD=0,sD=0,aD=0,oD=0,lD=0,dD=0,cD=0,hD=0,uD=0,pD=0,gD=0,mD=0;var fD=0,SD=0,vD=0,yD=0,CD=0,TD=0,ED=0,_D=0,bD=0,PD=0,ID=0,AD=0,RD=0,wD=0,MD=0,OD=0,DD=0,kD=0,ND=0,LD=0;var xD=0,FD=0,UD=0,VD=0,HD=0,BD=0,$D=0,jD=0,GD=0,WD=0,qD=0,zD=0,KD=0,JD=0,YD=0,QD=0,XD=0,ZD=0,ek=0,tk=0;var ik=0,nk=0,rk=0,sk=0,ak=0,ok=0,lk=0,dk=0,ck=0,hk=0,uk=0,pk=0,gk=0,mk=0,fk=0,Sk=0,vk=0,yk=0,Ck=0,Tk=0;var Ek=0,_k=0,bk=0,Pk=0,Ik=0,Ak=0,Rk=0,wk=0,Mk=0,Ok=0,Dk=0,kk=0,Nk=0,Lk=0,xk=0,Fk=0,Uk=0,Vk=0,Hk=0,Bk=0;var $k=0,jk=0,Gk=0,Wk=0,qk=0,zk=0,Kk=0,Jk=0,Yk=0,Qk=0,Xk=0,Zk=0,eN=0,tN=0,iN=0,nN=0,rN=0,sN=0,aN=0,oN=0;var lN=0;lN=h;s=Vt(t)|0;a=D;FS=s&2097151;Hy=t+2|0;jT=Ht(Hy)|0;q_=D;JP=ai(jT|0,q_|0,5)|0;XA=D;tM=JP&2097151;rD=t+5|0;o=Vt(rD)|0;ut=D;bn=ai(o|0,ut|0,2)|0;As=D;Oo=bn&2097151;Nd=t+7|0;Fh=Ht(Nd)|0;Hp=D;jm=ai(Fh|0,Hp|0,7)|0;IS=D;US=jm&2097151;JS=t+10|0;av=Ht(JS)|0;Sv=D;Rv=ai(av|0,Sv|0,4)|0;Vv=D;Yv=Rv&2097151;oy=t+13|0;vy=Vt(oy)|0;wy=D;By=ai(vy|0,wy|0,1)|0;Xy=D;dC=By&2097151;CC=t+15|0;OC=Ht(CC)|0;$C=D;ZC=ai(OC|0,$C|0,6)|0;cT=D;TT=ZC&2097151;DT=t+18|0;GT=Vt(DT)|0;tE=D;uE=ai(GT|0,tE|0,3)|0;_E=D;NE=uE&2097151;WE=t+21|0;i_=Vt(WE)|0;p_=D;b_=i_&2097151;L_=t+23|0;z_=Ht(L_)|0;rb=D;mb=ai(z_|0,rb|0,5)|0;Ib=D;Fb=mb&2097151;Kb=t+26|0;sP=Vt(Kb)|0;fP=D;AP=ai(sP|0,fP|0,2)|0;UP=D;YP=AP&2097151;oI=t+28|0;vI=Ht(oI)|0;wI=D;HI=ai(vI|0,wI|0,7)|0;QI=D;lA=Vt(i)|0;yA=D;MA=lA&2097151;BA=i+2|0;ZA=Ht(BA)|0;cR=D;TR=ai(ZA|0,cR|0,5)|0;DR=D;jR=TR&2097151;ew=i+5|0;hw=Vt(ew)|0;Ew=D;kw=ai(hw|0,Ew|0,2)|0;Gw=D;iM=kw&2097151;pM=i+7|0;bM=Ht(pM)|0;LM=D;qM=ai(bM|0,LM|0,7)|0;nO=D;gO=qM&2097151;PO=i+10|0;xO=Ht(PO)|0;zO=D;sD=ai(xO|0,zO|0,4)|0;fD=D;AD=sD&2097151;UD=i+13|0;JD=Vt(UD)|0;ak=D;Sk=ai(JD|0,ak|0,1)|0;Rk=D;Vk=Sk&2097151;Yk=i+15|0;l=Ht(Yk)|0;C=D;O=ai(l|0,C|0,6)|0;j=D;ee=O&2097151;he=i+18|0;Ee=Vt(he)|0;ke=D;Ge=ai(Ee|0,ke|0,3)|0;tt=D;pt=Ge&2097151;bt=i+21|0;Lt=Vt(bt)|0;Kt=D;ci=Lt&2097151;Ei=i+23|0;ki=Ht(Ei)|0;Gi=D;tn=ai(ki|0,Gi|0,5)|0;pn=D;Pn=tn&2097151;xn=i+26|0;zn=Vt(xn)|0;rr=D;mr=ai(zn|0,rr|0,2)|0;Ir=D;Fr=mr&2097151;Kr=i+28|0;ss=Ht(Kr)|0;fs=D;Rs=ai(ss|0,fs|0,7)|0;Vs=D;Ys=Vt(r)|0;oa=D;va=Ys&2097151;wa=r+2|0;Ha=Ht(wa)|0;Qa=D;lo=ai(Ha|0,Qa|0,5)|0;Co=D;Do=lo&2097151;jo=r+5|0;el=Vt(jo)|0;hl=D;El=ai(el|0,hl|0,2)|0;kl=D;Gl=El&2097151;td=r+7|0;ud=Ht(td)|0;_d=D;Ld=ai(ud|0,_d|0,7)|0;qd=D;nc=Ld&2097151;gc=r+10|0;Pc=Ht(gc)|0;xc=D;zc=ai(Pc|0,xc|0,4)|0;rh=D;mh=zc&2097151;Ih=r+13|0;Uh=Vt(Ih)|0;Jh=D;au=ai(Uh|0,Jh|0,1)|0;Su=D;Ru=au&2097151;Vu=r+15|0;Yu=Ht(Vu)|0;op=D;vp=ai(Yu|0,op|0,6)|0;wp=D;Bp=vp&2097151;Xp=r+18|0;dg=Vt(Xp)|0;Cg=D;Og=ai(dg|0,Cg|0,3)|0;$g=D;Zg=Og&2097151;cm=r+21|0;Tm=Vt(cm)|0;Dm=D;Gm=Tm&2097151;tf=r+23|0;pf=Ht(tf)|0;bf=D;Lf=ai(pf|0,bf|0,5)|0;qf=D;nS=Lf&2097151;gS=r+26|0;bS=Vt(gS)|0;PS=D;AS=ai(bS|0,PS|0,2)|0;RS=D;wS=AS&2097151;MS=r+28|0;OS=Ht(MS)|0;DS=D;kS=ai(OS|0,DS|0,7)|0;NS=D;LS=fi(MA|0,0,FS|0,0)|0;xS=D;VS=ri(va|0,0,LS|0,xS|0)|0;HS=D;BS=fi(jR|0,0,FS|0,0)|0;$S=D;jS=fi(MA|0,0,tM|0,0)|0;GS=D;WS=fi(iM|0,0,FS|0,0)|0;qS=D;zS=fi(jR|0,0,tM|0,0)|0;KS=D;YS=fi(MA|0,0,Oo|0,0)|0;QS=D;XS=ri(zS|0,KS|0,YS|0,QS|0)|0;ZS=D;ev=ri(XS|0,ZS|0,WS|0,qS|0)|0;tv=D;iv=ri(ev|0,tv|0,Gl|0,0)|0;nv=D;rv=fi(gO|0,0,FS|0,0)|0;sv=D;ov=fi(iM|0,0,tM|0,0)|0;lv=D;dv=fi(jR|0,0,Oo|0,0)|0;cv=D;hv=fi(MA|0,0,US|0,0)|0;uv=D;pv=fi(AD|0,0,FS|0,0)|0;gv=D;mv=fi(gO|0,0,tM|0,0)|0;fv=D;vv=fi(iM|0,0,Oo|0,0)|0;yv=D;Cv=fi(jR|0,0,US|0,0)|0;Tv=D;Ev=fi(MA|0,0,Yv|0,0)|0;_v=D;bv=ri(Cv|0,Tv|0,Ev|0,_v|0)|0;Pv=D;Iv=ri(bv|0,Pv|0,vv|0,yv|0)|0;Av=D;wv=ri(Iv|0,Av|0,mv|0,fv|0)|0;Mv=D;Ov=ri(wv|0,Mv|0,pv|0,gv|0)|0;Dv=D;kv=ri(Ov|0,Dv|0,mh|0,0)|0;Nv=D;Lv=fi(Vk|0,0,FS|0,0)|0;xv=D;Fv=fi(AD|0,0,tM|0,0)|0;Uv=D;Hv=fi(gO|0,0,Oo|0,0)|0;Bv=D;$v=fi(iM|0,0,US|0,0)|0;jv=D;Gv=fi(jR|0,0,Yv|0,0)|0;Wv=D;qv=fi(MA|0,0,dC|0,0)|0;zv=D;Kv=fi(ee|0,0,FS|0,0)|0;Jv=D;Qv=fi(Vk|0,0,tM|0,0)|0;Xv=D;Zv=fi(AD|0,0,Oo|0,0)|0;ey=D;ty=fi(gO|0,0,US|0,0)|0;iy=D;ny=fi(iM|0,0,Yv|0,0)|0;ry=D;sy=fi(jR|0,0,dC|0,0)|0;ay=D;ly=fi(MA|0,0,TT|0,0)|0;dy=D;cy=ri(sy|0,ay|0,ly|0,dy|0)|0;hy=D;uy=ri(cy|0,hy|0,ny|0,ry|0)|0;py=D;gy=ri(uy|0,py|0,ty|0,iy|0)|0;my=D;fy=ri(gy|0,my|0,Zv|0,ey|0)|0;Sy=D;yy=ri(fy|0,Sy|0,Qv|0,Xv|0)|0;Cy=D;Ty=ri(yy|0,Cy|0,Kv|0,Jv|0)|0;Ey=D;_y=ri(Ty|0,Ey|0,Bp|0,0)|0;by=D;Py=fi(pt|0,0,FS|0,0)|0;Iy=D;Ay=fi(ee|0,0,tM|0,0)|0;Ry=D;My=fi(Vk|0,0,Oo|0,0)|0;Oy=D;Dy=fi(AD|0,0,US|0,0)|0;ky=D;Ny=fi(gO|0,0,Yv|0,0)|0;Ly=D;xy=fi(iM|0,0,dC|0,0)|0;Fy=D;Uy=fi(jR|0,0,TT|0,0)|0;Vy=D;$y=fi(MA|0,0,NE|0,0)|0;jy=D;Gy=fi(ci|0,0,FS|0,0)|0;Wy=D;qy=fi(pt|0,0,tM|0,0)|0;zy=D;Ky=fi(ee|0,0,Oo|0,0)|0;Jy=D;Yy=fi(Vk|0,0,US|0,0)|0;Qy=D;Zy=fi(AD|0,0,Yv|0,0)|0;eC=D;tC=fi(gO|0,0,dC|0,0)|0;iC=D;nC=fi(iM|0,0,TT|0,0)|0;rC=D;sC=fi(jR|0,0,NE|0,0)|0;aC=D;oC=fi(MA|0,0,b_|0,0)|0;lC=D;cC=ri(sC|0,aC|0,oC|0,lC|0)|0;hC=D;uC=ri(cC|0,hC|0,nC|0,rC|0)|0;pC=D;gC=ri(uC|0,pC|0,tC|0,iC|0)|0;mC=D;fC=ri(gC|0,mC|0,Zy|0,eC|0)|0;SC=D;vC=ri(fC|0,SC|0,Yy|0,Qy|0)|0;yC=D;TC=ri(vC|0,yC|0,Ky|0,Jy|0)|0;EC=D;_C=ri(TC|0,EC|0,Gy|0,Wy|0)|0;bC=D;PC=ri(_C|0,bC|0,qy|0,zy|0)|0;IC=D;AC=ri(PC|0,IC|0,Gm|0,0)|0;RC=D;wC=fi(Pn|0,0,FS|0,0)|0;MC=D;DC=fi(ci|0,0,tM|0,0)|0;kC=D;NC=fi(pt|0,0,Oo|0,0)|0;LC=D;xC=fi(ee|0,0,US|0,0)|0;FC=D;UC=fi(Vk|0,0,Yv|0,0)|0;VC=D;HC=fi(AD|0,0,dC|0,0)|0;BC=D;jC=fi(gO|0,0,TT|0,0)|0;GC=D;WC=fi(iM|0,0,NE|0,0)|0;qC=D;zC=fi(jR|0,0,b_|0,0)|0;KC=D;JC=fi(MA|0,0,Fb|0,0)|0;YC=D;QC=fi(Fr|0,0,FS|0,0)|0;XC=D;eT=fi(Pn|0,0,tM|0,0)|0;tT=D;iT=fi(ci|0,0,Oo|0,0)|0;nT=D;rT=fi(pt|0,0,US|0,0)|0;sT=D;aT=fi(ee|0,0,Yv|0,0)|0;oT=D;lT=fi(Vk|0,0,dC|0,0)|0;dT=D;hT=fi(AD|0,0,TT|0,0)|0;uT=D;pT=fi(gO|0,0,NE|0,0)|0;gT=D;mT=fi(iM|0,0,b_|0,0)|0;fT=D;ST=fi(jR|0,0,Fb|0,0)|0;vT=D;yT=fi(MA|0,0,YP|0,0)|0;CT=D;ET=ri(ST|0,vT|0,yT|0,CT|0)|0;_T=D;bT=ri(ET|0,_T|0,mT|0,fT|0)|0;PT=D;IT=ri(bT|0,PT|0,pT|0,gT|0)|0;AT=D;RT=ri(IT|0,AT|0,hT|0,uT|0)|0;wT=D;MT=ri(RT|0,wT|0,lT|0,dT|0)|0;OT=D;kT=ri(MT|0,OT|0,aT|0,oT|0)|0;NT=D;LT=ri(kT|0,NT|0,iT|0,nT|0)|0;xT=D;FT=ri(LT|0,xT|0,rT|0,sT|0)|0;UT=D;VT=ri(FT|0,UT|0,eT|0,tT|0)|0;HT=D;BT=ri(VT|0,HT|0,QC|0,XC|0)|0;$T=D;WT=ri(BT|0,$T|0,wS|0,0)|0;qT=D;zT=fi(Rs|0,Vs|0,FS|0,0)|0;KT=D;JT=fi(Fr|0,0,tM|0,0)|0;YT=D;QT=fi(Pn|0,0,Oo|0,0)|0;XT=D;ZT=fi(ci|0,0,US|0,0)|0;eE=D;iE=fi(pt|0,0,Yv|0,0)|0;nE=D;rE=fi(ee|0,0,dC|0,0)|0;sE=D;aE=fi(Vk|0,0,TT|0,0)|0;oE=D;lE=fi(AD|0,0,NE|0,0)|0;dE=D;cE=fi(gO|0,0,b_|0,0)|0;hE=D;pE=fi(iM|0,0,Fb|0,0)|0;gE=D;mE=fi(jR|0,0,YP|0,0)|0;fE=D;SE=fi(MA|0,0,HI|0,QI|0)|0;vE=D;yE=fi(Rs|0,Vs|0,tM|0,0)|0;CE=D;TE=fi(Fr|0,0,Oo|0,0)|0;EE=D;bE=fi(Pn|0,0,US|0,0)|0;PE=D;IE=fi(ci|0,0,Yv|0,0)|0;AE=D;RE=fi(pt|0,0,dC|0,0)|0;wE=D;ME=fi(ee|0,0,TT|0,0)|0;OE=D;DE=fi(Vk|0,0,NE|0,0)|0;kE=D;LE=fi(AD|0,0,b_|0,0)|0;xE=D;FE=fi(gO|0,0,Fb|0,0)|0;UE=D;VE=fi(iM|0,0,YP|0,0)|0;HE=D;BE=fi(jR|0,0,HI|0,QI|0)|0;$E=D;jE=ri(VE|0,HE|0,BE|0,$E|0)|0;GE=D;qE=ri(jE|0,GE|0,FE|0,UE|0)|0;zE=D;KE=ri(qE|0,zE|0,LE|0,xE|0)|0;JE=D;YE=ri(KE|0,JE|0,DE|0,kE|0)|0;QE=D;XE=ri(YE|0,QE|0,ME|0,OE|0)|0;ZE=D;e_=ri(XE|0,ZE|0,IE|0,AE|0)|0;t_=D;n_=ri(e_|0,t_|0,RE|0,wE|0)|0;r_=D;s_=ri(n_|0,r_|0,bE|0,PE|0)|0;a_=D;o_=ri(s_|0,a_|0,TE|0,EE|0)|0;l_=D;d_=ri(o_|0,l_|0,yE|0,CE|0)|0;c_=D;h_=fi(Rs|0,Vs|0,Oo|0,0)|0;u_=D;g_=fi(Fr|0,0,US|0,0)|0;m_=D;f_=fi(Pn|0,0,Yv|0,0)|0;S_=D;v_=fi(ci|0,0,dC|0,0)|0;y_=D;C_=fi(pt|0,0,TT|0,0)|0;T_=D;E_=fi(ee|0,0,NE|0,0)|0;__=D;P_=fi(Vk|0,0,b_|0,0)|0;I_=D;A_=fi(AD|0,0,Fb|0,0)|0;R_=D;w_=fi(gO|0,0,YP|0,0)|0;M_=D;O_=fi(iM|0,0,HI|0,QI|0)|0;D_=D;k_=fi(Rs|0,Vs|0,US|0,0)|0;N_=D;x_=fi(Fr|0,0,Yv|0,0)|0;F_=D;U_=fi(Pn|0,0,dC|0,0)|0;V_=D;H_=fi(ci|0,0,TT|0,0)|0;B_=D;$_=fi(pt|0,0,NE|0,0)|0;j_=D;G_=fi(ee|0,0,b_|0,0)|0;W_=D;K_=fi(Vk|0,0,Fb|0,0)|0;J_=D;Y_=fi(AD|0,0,YP|0,0)|0;Q_=D;X_=fi(gO|0,0,HI|0,QI|0)|0;Z_=D;eb=ri(Y_|0,Q_|0,X_|0,Z_|0)|0;tb=D;ib=ri(eb|0,tb|0,K_|0,J_|0)|0;nb=D;sb=ri(ib|0,nb|0,G_|0,W_|0)|0;ab=D;ob=ri(sb|0,ab|0,H_|0,B_|0)|0;lb=D;db=ri(ob|0,lb|0,$_|0,j_|0)|0;cb=D;hb=ri(db|0,cb|0,U_|0,V_|0)|0;ub=D;pb=ri(hb|0,ub|0,x_|0,F_|0)|0;gb=D;fb=ri(pb|0,gb|0,k_|0,N_|0)|0;Sb=D;vb=fi(Rs|0,Vs|0,Yv|0,0)|0;yb=D;Cb=fi(Fr|0,0,dC|0,0)|0;Tb=D;Eb=fi(Pn|0,0,TT|0,0)|0;_b=D;bb=fi(ci|0,0,NE|0,0)|0;Pb=D;Ab=fi(pt|0,0,b_|0,0)|0;Rb=D;wb=fi(ee|0,0,Fb|0,0)|0;Mb=D;Ob=fi(Vk|0,0,YP|0,0)|0;Db=D;kb=fi(AD|0,0,HI|0,QI|0)|0;Nb=D;Lb=fi(Rs|0,Vs|0,dC|0,0)|0;xb=D;Ub=fi(Fr|0,0,TT|0,0)|0;Vb=D;Hb=fi(Pn|0,0,NE|0,0)|0;Bb=D;$b=fi(ci|0,0,b_|0,0)|0;jb=D;Gb=fi(pt|0,0,Fb|0,0)|0;Wb=D;qb=fi(ee|0,0,YP|0,0)|0;zb=D;Jb=fi(Vk|0,0,HI|0,QI|0)|0;Yb=D;Qb=ri(qb|0,zb|0,Jb|0,Yb|0)|0;Xb=D;Zb=ri(Qb|0,Xb|0,$b|0,jb|0)|0;eP=D;tP=ri(Zb|0,eP|0,Gb|0,Wb|0)|0;iP=D;nP=ri(tP|0,iP|0,Hb|0,Bb|0)|0;rP=D;aP=ri(nP|0,rP|0,Ub|0,Vb|0)|0;oP=D;lP=ri(aP|0,oP|0,Lb|0,xb|0)|0;dP=D;cP=fi(Rs|0,Vs|0,TT|0,0)|0;hP=D;uP=fi(Fr|0,0,NE|0,0)|0;pP=D;gP=fi(Pn|0,0,b_|0,0)|0;mP=D;SP=fi(ci|0,0,Fb|0,0)|0;vP=D;yP=fi(pt|0,0,YP|0,0)|0;CP=D;TP=fi(ee|0,0,HI|0,QI|0)|0;EP=D;_P=fi(Rs|0,Vs|0,NE|0,0)|0;bP=D;PP=fi(Fr|0,0,b_|0,0)|0;IP=D;RP=fi(Pn|0,0,Fb|0,0)|0;wP=D;MP=fi(ci|0,0,YP|0,0)|0;OP=D;DP=fi(pt|0,0,HI|0,QI|0)|0;kP=D;NP=ri(DP|0,kP|0,MP|0,OP|0)|0;LP=D;xP=ri(NP|0,LP|0,RP|0,wP|0)|0;FP=D;VP=ri(xP|0,FP|0,PP|0,IP|0)|0;HP=D;BP=ri(VP|0,HP|0,_P|0,bP|0)|0;$P=D;jP=fi(Rs|0,Vs|0,b_|0,0)|0;GP=D;WP=fi(Fr|0,0,Fb|0,0)|0;qP=D;zP=fi(Pn|0,0,YP|0,0)|0;KP=D;QP=fi(ci|0,0,HI|0,QI|0)|0;XP=D;ZP=fi(Rs|0,Vs|0,Fb|0,0)|0;eI=D;tI=fi(Fr|0,0,YP|0,0)|0;iI=D;nI=fi(Pn|0,0,HI|0,QI|0)|0;rI=D;sI=ri(tI|0,iI|0,nI|0,rI|0)|0;aI=D;lI=ri(sI|0,aI|0,ZP|0,eI|0)|0;dI=D;cI=fi(Rs|0,Vs|0,YP|0,0)|0;hI=D;uI=fi(Fr|0,0,HI|0,QI|0)|0;pI=D;gI=ri(cI|0,hI|0,uI|0,pI|0)|0;mI=D;fI=fi(Rs|0,Vs|0,HI|0,QI|0)|0;SI=D;yI=ri(VS|0,HS|0,1048576,0)|0;CI=D;TI=ai(yI|0,CI|0,21)|0;EI=D;_I=ri(BS|0,$S|0,jS|0,GS|0)|0;bI=D;PI=ri(_I|0,bI|0,Do|0,0)|0;II=D;AI=ri(PI|0,II|0,TI|0,EI|0)|0;RI=D;MI=oi(TI|0,EI|0,21)|0;OI=D;DI=ni(VS|0,HS|0,MI|0,OI|0)|0;kI=D;NI=ri(iv|0,nv|0,1048576,0)|0;LI=D;xI=ai(NI|0,LI|0,21)|0;FI=D;UI=ri(dv|0,cv|0,hv|0,uv|0)|0;VI=D;BI=ri(UI|0,VI|0,ov|0,lv|0)|0;$I=D;jI=ri(BI|0,$I|0,rv|0,sv|0)|0;GI=D;WI=ri(jI|0,GI|0,nc|0,0)|0;qI=D;zI=ri(WI|0,qI|0,xI|0,FI|0)|0;KI=D;JI=oi(xI|0,FI|0,21)|0;YI=D;XI=ri(kv|0,Nv|0,1048576,0)|0;ZI=D;eA=ii(XI|0,ZI|0,21)|0;tA=D;iA=ri(Gv|0,Wv|0,qv|0,zv|0)|0;nA=D;rA=ri(iA|0,nA|0,$v|0,jv|0)|0;sA=D;aA=ri(rA|0,sA|0,Hv|0,Bv|0)|0;oA=D;dA=ri(aA|0,oA|0,Fv|0,Uv|0)|0;cA=D;hA=ri(dA|0,cA|0,Lv|0,xv|0)|0;uA=D;pA=ri(hA|0,uA|0,Ru|0,0)|0;gA=D;mA=ri(pA|0,gA|0,eA|0,tA|0)|0;fA=D;SA=oi(eA|0,tA|0,21)|0;vA=D;CA=ni(kv|0,Nv|0,SA|0,vA|0)|0;TA=D;EA=ri(_y|0,by|0,1048576,0)|0;_A=D;bA=ii(EA|0,_A|0,21)|0;PA=D;IA=ri(Uy|0,Vy|0,$y|0,jy|0)|0;AA=D;RA=ri(IA|0,AA|0,xy|0,Fy|0)|0;wA=D;OA=ri(RA|0,wA|0,Ny|0,Ly|0)|0;DA=D;kA=ri(OA|0,DA|0,Dy|0,ky|0)|0;NA=D;LA=ri(kA|0,NA|0,My|0,Oy|0)|0;xA=D;FA=ri(LA|0,xA|0,Ay|0,Ry|0)|0;UA=D;VA=ri(FA|0,UA|0,Py|0,Iy|0)|0;HA=D;$A=ri(VA|0,HA|0,Zg|0,0)|0;jA=D;GA=ri($A|0,jA|0,bA|0,PA|0)|0;WA=D;qA=oi(bA|0,PA|0,21)|0;zA=D;KA=ri(AC|0,RC|0,1048576,0)|0;JA=D;YA=ii(KA|0,JA|0,21)|0;QA=D;eR=ri(zC|0,KC|0,JC|0,YC|0)|0;tR=D;iR=ri(eR|0,tR|0,WC|0,qC|0)|0;nR=D;rR=ri(iR|0,nR|0,jC|0,GC|0)|0;sR=D;aR=ri(rR|0,sR|0,HC|0,BC|0)|0;oR=D;lR=ri(aR|0,oR|0,UC|0,VC|0)|0;dR=D;hR=ri(lR|0,dR|0,xC|0,FC|0)|0;uR=D;pR=ri(hR|0,uR|0,DC|0,kC|0)|0;gR=D;mR=ri(pR|0,gR|0,NC|0,LC|0)|0;fR=D;SR=ri(mR|0,fR|0,wC|0,MC|0)|0;vR=D;yR=ri(SR|0,vR|0,nS|0,0)|0;CR=D;ER=ri(yR|0,CR|0,YA|0,QA|0)|0;_R=D;bR=oi(YA|0,QA|0,21)|0;PR=D;IR=ri(WT|0,qT|0,1048576,0)|0;AR=D;RR=ii(IR|0,AR|0,21)|0;wR=D;MR=ri(mE|0,fE|0,SE|0,vE|0)|0;OR=D;kR=ri(MR|0,OR|0,pE|0,gE|0)|0;NR=D;LR=ri(kR|0,NR|0,cE|0,hE|0)|0;xR=D;FR=ri(LR|0,xR|0,lE|0,dE|0)|0;UR=D;VR=ri(FR|0,UR|0,aE|0,oE|0)|0;HR=D;BR=ri(VR|0,HR|0,rE|0,sE|0)|0;$R=D;GR=ri(BR|0,$R|0,ZT|0,eE|0)|0;WR=D;qR=ri(GR|0,WR|0,iE|0,nE|0)|0;zR=D;KR=ri(qR|0,zR|0,QT|0,XT|0)|0;JR=D;YR=ri(KR|0,JR|0,zT|0,KT|0)|0;QR=D;XR=ri(YR|0,QR|0,JT|0,YT|0)|0;ZR=D;tw=ri(XR|0,ZR|0,kS|0,NS|0)|0;iw=D;nw=ri(tw|0,iw|0,RR|0,wR|0)|0;rw=D;sw=oi(RR|0,wR|0,21)|0;aw=D;ow=ri(d_|0,c_|0,1048576,0)|0;lw=D;dw=ii(ow|0,lw|0,21)|0;cw=D;uw=ri(w_|0,M_|0,O_|0,D_|0)|0;pw=D;gw=ri(uw|0,pw|0,A_|0,R_|0)|0;mw=D;fw=ri(gw|0,mw|0,P_|0,I_|0)|0;Sw=D;vw=ri(fw|0,Sw|0,E_|0,__|0)|0;yw=D;Cw=ri(vw|0,yw|0,v_|0,y_|0)|0;Tw=D;_w=ri(Cw|0,Tw|0,C_|0,T_|0)|0;bw=D;Pw=ri(_w|0,bw|0,f_|0,S_|0)|0;Iw=D;Aw=ri(Pw|0,Iw|0,g_|0,m_|0)|0;Rw=D;ww=ri(Aw|0,Rw|0,h_|0,u_|0)|0;Mw=D;Ow=ri(ww|0,Mw|0,dw|0,cw|0)|0;Dw=D;Nw=oi(dw|0,cw|0,21)|0;Lw=D;xw=ri(fb|0,Sb|0,1048576,0)|0;Fw=D;Uw=ii(xw|0,Fw|0,21)|0;Vw=D;Hw=ri(Ob|0,Db|0,kb|0,Nb|0)|0;Bw=D;$w=ri(Hw|0,Bw|0,wb|0,Mb|0)|0;jw=D;Ww=ri($w|0,jw|0,bb|0,Pb|0)|0;qw=D;zw=ri(Ww|0,qw|0,Ab|0,Rb|0)|0;Kw=D;Jw=ri(zw|0,Kw|0,Eb|0,_b|0)|0;Yw=D;Qw=ri(Jw|0,Yw|0,Cb|0,Tb|0)|0;Xw=D;Zw=ri(Qw|0,Xw|0,vb|0,yb|0)|0;eM=D;nM=ri(Zw|0,eM|0,Uw|0,Vw|0)|0;rM=D;sM=oi(Uw|0,Vw|0,21)|0;aM=D;oM=ri(lP|0,dP|0,1048576,0)|0;lM=D;dM=ii(oM|0,lM|0,21)|0;cM=D;hM=ri(SP|0,vP|0,TP|0,EP|0)|0;uM=D;gM=ri(hM|0,uM|0,yP|0,CP|0)|0;mM=D;fM=ri(gM|0,mM|0,gP|0,mP|0)|0;SM=D;vM=ri(fM|0,SM|0,uP|0,pP|0)|0;yM=D;CM=ri(vM|0,yM|0,cP|0,hP|0)|0;TM=D;EM=ri(CM|0,TM|0,dM|0,cM|0)|0;_M=D;PM=oi(dM|0,cM|0,21)|0;IM=D;AM=ri(BP|0,$P|0,1048576,0)|0;RM=D;wM=ii(AM|0,RM|0,21)|0;MM=D;OM=ri(zP|0,KP|0,QP|0,XP|0)|0;DM=D;kM=ri(OM|0,DM|0,WP|0,qP|0)|0;NM=D;xM=ri(kM|0,NM|0,jP|0,GP|0)|0;FM=D;UM=ri(xM|0,FM|0,wM|0,MM|0)|0;VM=D;HM=oi(wM|0,MM|0,21)|0;BM=D;$M=ni(BP|0,$P|0,HM|0,BM|0)|0;jM=D;GM=ri(lI|0,dI|0,1048576,0)|0;WM=D;zM=ai(GM|0,WM|0,21)|0;KM=D;JM=ri(gI|0,mI|0,zM|0,KM|0)|0;YM=D;QM=oi(zM|0,KM|0,21)|0;XM=D;ZM=ni(lI|0,dI|0,QM|0,XM|0)|0;eO=D;tO=ri(fI|0,SI|0,1048576,0)|0;iO=D;rO=ai(tO|0,iO|0,21)|0;sO=D;aO=oi(rO|0,sO|0,21)|0;oO=D;lO=ni(fI|0,SI|0,aO|0,oO|0)|0;dO=D;cO=ri(AI|0,RI|0,1048576,0)|0;hO=D;uO=ai(cO|0,hO|0,21)|0;pO=D;mO=oi(uO|0,pO|0,21)|0;fO=D;SO=ni(AI|0,RI|0,mO|0,fO|0)|0;vO=D;yO=ri(zI|0,KI|0,1048576,0)|0;CO=D;TO=ii(yO|0,CO|0,21)|0;EO=D;_O=ri(CA|0,TA|0,TO|0,EO|0)|0;bO=D;IO=oi(TO|0,EO|0,21)|0;AO=D;RO=ni(zI|0,KI|0,IO|0,AO|0)|0;wO=D;MO=ri(mA|0,fA|0,1048576,0)|0;OO=D;DO=ii(MO|0,OO|0,21)|0;kO=D;NO=oi(DO|0,kO|0,21)|0;LO=D;FO=ni(mA|0,fA|0,NO|0,LO|0)|0;UO=D;VO=ri(GA|0,WA|0,1048576,0)|0;HO=D;BO=ii(VO|0,HO|0,21)|0;$O=D;jO=oi(BO|0,$O|0,21)|0;GO=D;WO=ri(ER|0,_R|0,1048576,0)|0;qO=D;KO=ii(WO|0,qO|0,21)|0;JO=D;YO=oi(KO|0,JO|0,21)|0;QO=D;XO=ri(nw|0,rw|0,1048576,0)|0;ZO=D;eD=ii(XO|0,ZO|0,21)|0;tD=D;iD=oi(eD|0,tD|0,21)|0;nD=D;aD=ri(Ow|0,Dw|0,1048576,0)|0;oD=D;lD=ii(aD|0,oD|0,21)|0;dD=D;cD=oi(lD|0,dD|0,21)|0;hD=D;uD=ri(nM|0,rM|0,1048576,0)|0;pD=D;gD=ii(uD|0,pD|0,21)|0;mD=D;SD=oi(gD|0,mD|0,21)|0;vD=D;yD=ri(EM|0,_M|0,1048576,0)|0;CD=D;TD=ii(yD|0,CD|0,21)|0;ED=D;_D=ri(TD|0,ED|0,$M|0,jM|0)|0;bD=D;PD=oi(TD|0,ED|0,21)|0;ID=D;RD=ni(EM|0,_M|0,PD|0,ID|0)|0;wD=D;MD=ri(UM|0,VM|0,1048576,0)|0;OD=D;DD=ii(MD|0,OD|0,21)|0;kD=D;ND=ri(DD|0,kD|0,ZM|0,eO|0)|0;LD=D;xD=oi(DD|0,kD|0,21)|0;FD=D;VD=ni(UM|0,VM|0,xD|0,FD|0)|0;HD=D;BD=ri(JM|0,YM|0,1048576,0)|0;$D=D;jD=ai(BD|0,$D|0,21)|0;GD=D;WD=ri(jD|0,GD|0,lO|0,dO|0)|0;qD=D;zD=oi(jD|0,GD|0,21)|0;KD=D;YD=ni(JM|0,YM|0,zD|0,KD|0)|0;QD=D;XD=fi(rO|0,sO|0,666643,0)|0;ZD=D;ek=fi(rO|0,sO|0,470296,0)|0;tk=D;ik=fi(rO|0,sO|0,654183,0)|0;nk=D;rk=fi(rO|0,sO|0,-997805,-1)|0;sk=D;ok=fi(rO|0,sO|0,136657,0)|0;lk=D;dk=fi(rO|0,sO|0,-683901,-1)|0;ck=D;hk=ri(dk|0,ck|0,lP|0,dP|0)|0;uk=D;pk=ni(hk|0,uk|0,PM|0,IM|0)|0;gk=D;mk=ri(pk|0,gk|0,gD|0,mD|0)|0;fk=D;vk=fi(WD|0,qD|0,666643,0)|0;yk=D;Ck=fi(WD|0,qD|0,470296,0)|0;Tk=D;Ek=fi(WD|0,qD|0,654183,0)|0;_k=D;bk=fi(WD|0,qD|0,-997805,-1)|0;Pk=D;Ik=fi(WD|0,qD|0,136657,0)|0;Ak=D;wk=fi(WD|0,qD|0,-683901,-1)|0;Mk=D;Ok=fi(YD|0,QD|0,666643,0)|0;Dk=D;kk=fi(YD|0,QD|0,470296,0)|0;Nk=D;Lk=fi(YD|0,QD|0,654183,0)|0;xk=D;Fk=fi(YD|0,QD|0,-997805,-1)|0;Uk=D;Hk=fi(YD|0,QD|0,136657,0)|0;Bk=D;$k=fi(YD|0,QD|0,-683901,-1)|0;jk=D;Gk=ri(rk|0,sk|0,fb|0,Sb|0)|0;Wk=D;qk=ni(Gk|0,Wk|0,sM|0,aM|0)|0;zk=D;Kk=ri(qk|0,zk|0,lD|0,dD|0)|0;Jk=D;Qk=ri(Kk|0,Jk|0,Ik|0,Ak|0)|0;Xk=D;Zk=ri(Qk|0,Xk|0,$k|0,jk|0)|0;eN=D;tN=fi(ND|0,LD|0,666643,0)|0;iN=D;nN=fi(ND|0,LD|0,470296,0)|0;rN=D;sN=fi(ND|0,LD|0,654183,0)|0;aN=D;d=fi(ND|0,LD|0,-997805,-1)|0;c=D;u=fi(ND|0,LD|0,136657,0)|0;p=D;g=fi(ND|0,LD|0,-683901,-1)|0;m=D;f=fi(VD|0,HD|0,666643,0)|0;S=D;v=fi(VD|0,HD|0,470296,0)|0;y=D;T=fi(VD|0,HD|0,654183,0)|0;E=D;_=fi(VD|0,HD|0,-997805,-1)|0;b=D;P=fi(VD|0,HD|0,136657,0)|0;I=D;A=fi(VD|0,HD|0,-683901,-1)|0;R=D;w=ri(ek|0,tk|0,d_|0,c_|0)|0;M=D;k=ni(w|0,M|0,Nw|0,Lw|0)|0;N=D;L=ri(k|0,N|0,Ek|0,_k|0)|0;x=D;F=ri(L|0,x|0,u|0,p|0)|0;U=D;V=ri(F|0,U|0,Fk|0,Uk|0)|0;H=D;B=ri(V|0,H|0,A|0,R|0)|0;$=D;G=ri(B|0,$|0,eD|0,tD|0)|0;W=D;q=fi(_D|0,bD|0,666643,0)|0;z=D;K=ri(q|0,z|0,_y|0,by|0)|0;J=D;Y=ni(K|0,J|0,qA|0,zA|0)|0;Q=D;X=ri(Y|0,Q|0,DO|0,kO|0)|0;Z=D;te=fi(_D|0,bD|0,470296,0)|0;ie=D;ne=fi(_D|0,bD|0,654183,0)|0;re=D;se=ri(tN|0,iN|0,AC|0,RC|0)|0;ae=D;oe=ri(se|0,ae|0,ne|0,re|0)|0;le=D;de=ri(oe|0,le|0,v|0,y|0)|0;ce=D;ue=ni(de|0,ce|0,bR|0,PR|0)|0;pe=D;ge=ri(ue|0,pe|0,BO|0,$O|0)|0;me=D;fe=fi(_D|0,bD|0,-997805,-1)|0;Se=D;ve=fi(_D|0,bD|0,136657,0)|0;ye=D;Ce=ri(sN|0,aN|0,vk|0,yk|0)|0;Te=D;_e=ri(Ce|0,Te|0,ve|0,ye|0)|0;be=D;Pe=ri(_e|0,be|0,kk|0,Nk|0)|0;Ie=D;Ae=ri(Pe|0,Ie|0,_|0,b|0)|0;Re=D;we=ri(Ae|0,Re|0,WT|0,qT|0)|0;Me=D;Oe=ri(we|0,Me|0,KO|0,JO|0)|0;De=D;Ne=ni(Oe|0,De|0,sw|0,aw|0)|0;Le=D;xe=fi(_D|0,bD|0,-683901,-1)|0;Fe=D;Ue=ri(X|0,Z|0,1048576,0)|0;Ve=D;He=ii(Ue|0,Ve|0,21)|0;Be=D;$e=ri(f|0,S|0,te|0,ie|0)|0;je=D;We=ri($e|0,je|0,GA|0,WA|0)|0;qe=D;ze=ni(We|0,qe|0,jO|0,GO|0)|0;Ke=D;Je=ri(ze|0,Ke|0,He|0,Be|0)|0;Ye=D;Qe=oi(He|0,Be|0,21)|0;Xe=D;Ze=ri(ge|0,me|0,1048576,0)|0;et=D;it=ii(Ze|0,et|0,21)|0;nt=D;rt=ri(fe|0,Se|0,nN|0,rN|0)|0;st=D;at=ri(rt|0,st|0,Ok|0,Dk|0)|0;ot=D;lt=ri(at|0,ot|0,T|0,E|0)|0;dt=D;ct=ri(lt|0,dt|0,ER|0,_R|0)|0;ht=D;gt=ni(ct|0,ht|0,YO|0,QO|0)|0;mt=D;ft=ri(gt|0,mt|0,it|0,nt|0)|0;St=D;vt=oi(it|0,nt|0,21)|0;yt=D;Ct=ri(Ne|0,Le|0,1048576,0)|0;Tt=D;Et=ii(Ct|0,Tt|0,21)|0;_t=D;Pt=ri(Ck|0,Tk|0,XD|0,ZD|0)|0;It=D;At=ri(Pt|0,It|0,d|0,c|0)|0;Rt=D;wt=ri(At|0,Rt|0,xe|0,Fe|0)|0;Mt=D;Ot=ri(wt|0,Mt|0,Lk|0,xk|0)|0;Dt=D;kt=ri(Ot|0,Dt|0,P|0,I|0)|0;Nt=D;xt=ri(kt|0,Nt|0,nw|0,rw|0)|0;Ft=D;Ut=ni(xt|0,Ft|0,iD|0,nD|0)|0;Bt=D;$t=ri(Ut|0,Bt|0,Et|0,_t|0)|0;jt=D;Gt=oi(Et|0,_t|0,21)|0;Wt=D;qt=ri(G|0,W|0,1048576,0)|0;zt=D;Jt=ii(qt|0,zt|0,21)|0;Yt=D;Qt=ri(Ow|0,Dw|0,ik|0,nk|0)|0;Xt=D;Zt=ni(Qt|0,Xt|0,cD|0,hD|0)|0;ei=D;ti=ri(Zt|0,ei|0,bk|0,Pk|0)|0;si=D;li=ri(ti|0,si|0,g|0,m|0)|0;di=D;hi=ri(li|0,di|0,Hk|0,Bk|0)|0;ui=D;pi=ri(hi|0,ui|0,Jt|0,Yt|0)|0;gi=D;mi=oi(Jt|0,Yt|0,21)|0;Si=D;vi=ni(G|0,W|0,mi|0,Si|0)|0;yi=D;Ci=ri(Zk|0,eN|0,1048576,0)|0;Ti=D;_i=ii(Ci|0,Ti|0,21)|0;bi=D;Pi=ri(nM|0,rM|0,ok|0,lk|0)|0;Ii=D;Ai=ni(Pi|0,Ii|0,SD|0,vD|0)|0;Ri=D;wi=ri(Ai|0,Ri|0,wk|0,Mk|0)|0;Mi=D;Oi=ri(wi|0,Mi|0,_i|0,bi|0)|0;Di=D;Ni=oi(_i|0,bi|0,21)|0;Li=D;xi=ni(Zk|0,eN|0,Ni|0,Li|0)|0;Fi=D;Ui=ri(mk|0,fk|0,1048576,0)|0;Vi=D;Hi=ii(Ui|0,Vi|0,21)|0;Bi=D;$i=ri(Hi|0,Bi|0,RD|0,wD|0)|0;ji=D;Wi=oi(Hi|0,Bi|0,21)|0;qi=D;zi=ni(mk|0,fk|0,Wi|0,qi|0)|0;Ki=D;Ji=ri(Je|0,Ye|0,1048576,0)|0;Yi=D;Qi=ii(Ji|0,Yi|0,21)|0;Xi=D;Zi=oi(Qi|0,Xi|0,21)|0;en=D;nn=ri(ft|0,St|0,1048576,0)|0;rn=D;sn=ii(nn|0,rn|0,21)|0;an=D;on=oi(sn|0,an|0,21)|0;ln=D;dn=ri($t|0,jt|0,1048576,0)|0;cn=D;hn=ii(dn|0,cn|0,21)|0;un=D;gn=ri(vi|0,yi|0,hn|0,un|0)|0;mn=D;fn=oi(hn|0,un|0,21)|0;Sn=D;vn=ni($t|0,jt|0,fn|0,Sn|0)|0;yn=D;Cn=ri(pi|0,gi|0,1048576,0)|0;Tn=D;En=ii(Cn|0,Tn|0,21)|0;_n=D;In=ri(En|0,_n|0,xi|0,Fi|0)|0;An=D;Rn=oi(En|0,_n|0,21)|0;wn=D;Mn=ni(pi|0,gi|0,Rn|0,wn|0)|0;On=D;Dn=ri(Oi|0,Di|0,1048576,0)|0;kn=D;Nn=ii(Dn|0,kn|0,21)|0;Ln=D;Fn=ri(Nn|0,Ln|0,zi|0,Ki|0)|0;Un=D;Vn=oi(Nn|0,Ln|0,21)|0;Hn=D;Bn=ni(Oi|0,Di|0,Vn|0,Hn|0)|0;$n=D;jn=fi($i|0,ji|0,666643,0)|0;Gn=D;Wn=ri(FO|0,UO|0,jn|0,Gn|0)|0;qn=D;Kn=fi($i|0,ji|0,470296,0)|0;Jn=D;Yn=fi($i|0,ji|0,654183,0)|0;Qn=D;Xn=fi($i|0,ji|0,-997805,-1)|0;Zn=D;er=fi($i|0,ji|0,136657,0)|0;tr=D;ir=fi($i|0,ji|0,-683901,-1)|0;nr=D;sr=ri(Ne|0,Le|0,ir|0,nr|0)|0;ar=D;or=ni(sr|0,ar|0,Gt|0,Wt|0)|0;lr=D;dr=ri(or|0,lr|0,sn|0,an|0)|0;cr=D;hr=fi(Fn|0,Un|0,666643,0)|0;ur=D;pr=ri(_O|0,bO|0,hr|0,ur|0)|0;gr=D;fr=fi(Fn|0,Un|0,470296,0)|0;Sr=D;vr=ri(Wn|0,qn|0,fr|0,Sr|0)|0;yr=D;Cr=fi(Fn|0,Un|0,654183,0)|0;Tr=D;Er=fi(Fn|0,Un|0,-997805,-1)|0;_r=D;br=fi(Fn|0,Un|0,136657,0)|0;Pr=D;Ar=fi(Fn|0,Un|0,-683901,-1)|0;Rr=D;wr=fi(Bn|0,$n|0,666643,0)|0;Mr=D;Or=ri(RO|0,wO|0,wr|0,Mr|0)|0;Dr=D;kr=fi(Bn|0,$n|0,470296,0)|0;Nr=D;Lr=ri(pr|0,gr|0,kr|0,Nr|0)|0;xr=D;Ur=fi(Bn|0,$n|0,654183,0)|0;Vr=D;Hr=ri(vr|0,yr|0,Ur|0,Vr|0)|0;Br=D;$r=fi(Bn|0,$n|0,-997805,-1)|0;jr=D;Gr=fi(Bn|0,$n|0,136657,0)|0;Wr=D;qr=fi(Bn|0,$n|0,-683901,-1)|0;zr=D;Jr=ri(ge|0,me|0,Xn|0,Zn|0)|0;Yr=D;Qr=ni(Jr|0,Yr|0,vt|0,yt|0)|0;Xr=D;Zr=ri(Qr|0,Xr|0,Qi|0,Xi|0)|0;es=D;ts=ri(Zr|0,es|0,br|0,Pr|0)|0;is=D;ns=ri(ts|0,is|0,qr|0,zr|0)|0;rs=D;as=fi(In|0,An|0,666643,0)|0;os=D;ls=fi(In|0,An|0,470296,0)|0;ds=D;cs=fi(In|0,An|0,654183,0)|0;hs=D;us=fi(In|0,An|0,-997805,-1)|0;ps=D;gs=fi(In|0,An|0,136657,0)|0;ms=D;Ss=fi(In|0,An|0,-683901,-1)|0;vs=D;ys=fi(Mn|0,On|0,666643,0)|0;Cs=D;Ts=fi(Mn|0,On|0,470296,0)|0;Es=D;_s=fi(Mn|0,On|0,654183,0)|0;bs=D;Ps=fi(Mn|0,On|0,-997805,-1)|0;Is=D;ws=fi(Mn|0,On|0,136657,0)|0;Ms=D;Os=fi(Mn|0,On|0,-683901,-1)|0;Ds=D;ks=ri(X|0,Z|0,Kn|0,Jn|0)|0;Ns=D;Ls=ni(ks|0,Ns|0,Qe|0,Xe|0)|0;xs=D;Fs=ri(Ls|0,xs|0,Cr|0,Tr|0)|0;Us=D;Hs=ri(Fs|0,Us|0,$r|0,jr|0)|0;Bs=D;$s=ri(Hs|0,Bs|0,gs|0,ms|0)|0;js=D;Gs=ri($s|0,js|0,Os|0,Ds|0)|0;Ws=D;qs=fi(gn|0,mn|0,666643,0)|0;zs=D;Ks=ri(qs|0,zs|0,DI|0,kI|0)|0;Js=D;Qs=fi(gn|0,mn|0,470296,0)|0;Xs=D;Zs=fi(gn|0,mn|0,654183,0)|0;ea=D;ta=ri(uO|0,pO|0,iv|0,nv|0)|0;ia=D;na=ni(ta|0,ia|0,JI|0,YI|0)|0;ra=D;sa=ri(na|0,ra|0,Zs|0,ea|0)|0;aa=D;la=ri(sa|0,aa|0,as|0,os|0)|0;da=D;ca=ri(la|0,da|0,Ts|0,Es|0)|0;ha=D;ua=fi(gn|0,mn|0,-997805,-1)|0;pa=D;ga=fi(gn|0,mn|0,136657,0)|0;ma=D;fa=ri(Lr|0,xr|0,ga|0,ma|0)|0;Sa=D;ya=ri(fa|0,Sa|0,cs|0,hs|0)|0;Ca=D;Ta=ri(ya|0,Ca|0,Ps|0,Is|0)|0;Ea=D;_a=fi(gn|0,mn|0,-683901,-1)|0;ba=D;Pa=ri(Ks|0,Js|0,1048576,0)|0;Ia=D;Aa=ii(Pa|0,Ia|0,21)|0;Ra=D;Ma=ri(SO|0,vO|0,Qs|0,Xs|0)|0;Oa=D;Da=ri(Ma|0,Oa|0,ys|0,Cs|0)|0;ka=D;Na=ri(Da|0,ka|0,Aa|0,Ra|0)|0;La=D;xa=oi(Aa|0,Ra|0,21)|0;Fa=D;Ua=ni(Ks|0,Js|0,xa|0,Fa|0)|0;Va=D;Ba=ri(ca|0,ha|0,1048576,0)|0;$a=D;ja=ii(Ba|0,$a|0,21)|0;Ga=D;Wa=ri(Or|0,Dr|0,ua|0,pa|0)|0;qa=D;za=ri(Wa|0,qa|0,ls|0,ds|0)|0;Ka=D;Ja=ri(za|0,Ka|0,_s|0,bs|0)|0;Ya=D;Xa=ri(Ja|0,Ya|0,ja|0,Ga|0)|0;Za=D;eo=oi(ja|0,Ga|0,21)|0;to=D;io=ri(Ta|0,Ea|0,1048576,0)|0;no=D;ro=ii(io|0,no|0,21)|0;so=D;ao=ri(Hr|0,Br|0,_a|0,ba|0)|0;oo=D;co=ri(ao|0,oo|0,us|0,ps|0)|0;ho=D;uo=ri(co|0,ho|0,ws|0,Ms|0)|0;po=D;go=ri(uo|0,po|0,ro|0,so|0)|0;mo=D;fo=oi(ro|0,so|0,21)|0;So=D;vo=ri(Gs|0,Ws|0,1048576,0)|0;yo=D;To=ii(vo|0,yo|0,21)|0;Eo=D;_o=ri(Je|0,Ye|0,Yn|0,Qn|0)|0;bo=D;Po=ri(_o|0,bo|0,Er|0,_r|0)|0;Io=D;Ao=ni(Po|0,Io|0,Zi|0,en|0)|0;Ro=D;wo=ri(Ao|0,Ro|0,Gr|0,Wr|0)|0;Mo=D;ko=ri(wo|0,Mo|0,Ss|0,vs|0)|0;No=D;Lo=ri(ko|0,No|0,To|0,Eo|0)|0;xo=D;Fo=oi(To|0,Eo|0,21)|0;Uo=D;Vo=ni(Gs|0,Ws|0,Fo|0,Uo|0)|0;Ho=D;Bo=ri(ns|0,rs|0,1048576,0)|0;$o=D;Go=ii(Bo|0,$o|0,21)|0;Wo=D;qo=ri(ft|0,St|0,er|0,tr|0)|0;zo=D;Ko=ri(qo|0,zo|0,Ar|0,Rr|0)|0;Jo=D;Yo=ni(Ko|0,Jo|0,on|0,ln|0)|0;Qo=D;Xo=ri(Yo|0,Qo|0,Go|0,Wo|0)|0;Zo=D;tl=oi(Go|0,Wo|0,21)|0;il=D;nl=ni(ns|0,rs|0,tl|0,il|0)|0;rl=D;sl=ri(dr|0,cr|0,1048576,0)|0;al=D;ol=ii(sl|0,al|0,21)|0;ll=D;dl=ri(vn|0,yn|0,ol|0,ll|0)|0;cl=D;ul=oi(ol|0,ll|0,21)|0;pl=D;gl=ni(dr|0,cr|0,ul|0,pl|0)|0;ml=D;fl=ri(Na|0,La|0,1048576,0)|0;Sl=D;vl=ii(fl|0,Sl|0,21)|0;yl=D;Cl=oi(vl|0,yl|0,21)|0;Tl=D;_l=ri(Xa|0,Za|0,1048576,0)|0;bl=D;Pl=ii(_l|0,bl|0,21)|0;Il=D;Al=oi(Pl|0,Il|0,21)|0;Rl=D;wl=ri(go|0,mo|0,1048576,0)|0;Ml=D;Ol=ii(wl|0,Ml|0,21)|0;Dl=D;Nl=ri(Vo|0,Ho|0,Ol|0,Dl|0)|0;Ll=D;xl=oi(Ol|0,Dl|0,21)|0;Fl=D;Ul=ri(Lo|0,xo|0,1048576,0)|0;Vl=D;Hl=ii(Ul|0,Vl|0,21)|0;Bl=D;$l=ri(nl|0,rl|0,Hl|0,Bl|0)|0;jl=D;Wl=oi(Hl|0,Bl|0,21)|0;ql=D;zl=ni(Lo|0,xo|0,Wl|0,ql|0)|0;Kl=D;Jl=ri(Xo|0,Zo|0,1048576,0)|0;Yl=D;Ql=ii(Jl|0,Yl|0,21)|0;Xl=D;Zl=ri(gl|0,ml|0,Ql|0,Xl|0)|0;ed=D;id=oi(Ql|0,Xl|0,21)|0;nd=D;rd=ni(Xo|0,Zo|0,id|0,nd|0)|0;sd=D;ad=ri(dl|0,cl|0,1048576,0)|0;od=D;ld=ii(ad|0,od|0,21)|0;dd=D;cd=oi(ld|0,dd|0,21)|0;hd=D;pd=ni(dl|0,cl|0,cd|0,hd|0)|0;gd=D;md=fi(ld|0,dd|0,666643,0)|0;fd=D;Sd=ri(Ua|0,Va|0,md|0,fd|0)|0;vd=D;yd=fi(ld|0,dd|0,470296,0)|0;Cd=D;Td=fi(ld|0,dd|0,654183,0)|0;Ed=D;bd=fi(ld|0,dd|0,-997805,-1)|0;Pd=D;Id=fi(ld|0,dd|0,136657,0)|0;Ad=D;Rd=fi(ld|0,dd|0,-683901,-1)|0;wd=D;Md=ii(Sd|0,vd|0,21)|0;Od=D;Dd=ri(yd|0,Cd|0,Na|0,La|0)|0;kd=D;xd=ni(Dd|0,kd|0,Cl|0,Tl|0)|0;Fd=D;Ud=ri(xd|0,Fd|0,Md|0,Od|0)|0;Vd=D;Hd=oi(Md|0,Od|0,21)|0;Bd=D;$d=ni(Sd|0,vd|0,Hd|0,Bd|0)|0;jd=D;Gd=ii(Ud|0,Vd|0,21)|0;Wd=D;zd=ri(Td|0,Ed|0,ca|0,ha|0)|0;Kd=D;Jd=ni(zd|0,Kd|0,eo|0,to|0)|0;Yd=D;Qd=ri(Jd|0,Yd|0,vl|0,yl|0)|0;Xd=D;Zd=ri(Qd|0,Xd|0,Gd|0,Wd|0)|0;ec=D;tc=oi(Gd|0,Wd|0,21)|0;ic=D;rc=ni(Ud|0,Vd|0,tc|0,ic|0)|0;sc=D;ac=ii(Zd|0,ec|0,21)|0;oc=D;lc=ri(Xa|0,Za|0,bd|0,Pd|0)|0;dc=D;cc=ni(lc|0,dc|0,Al|0,Rl|0)|0;hc=D;uc=ri(cc|0,hc|0,ac|0,oc|0)|0;pc=D;mc=oi(ac|0,oc|0,21)|0;fc=D;Sc=ni(Zd|0,ec|0,mc|0,fc|0)|0;vc=D;yc=ii(uc|0,pc|0,21)|0;Cc=D;Tc=ri(Id|0,Ad|0,Ta|0,Ea|0)|0;Ec=D;_c=ni(Tc|0,Ec|0,fo|0,So|0)|0;bc=D;Ic=ri(_c|0,bc|0,Pl|0,Il|0)|0;Ac=D;Rc=ri(Ic|0,Ac|0,yc|0,Cc|0)|0;wc=D;Mc=oi(yc|0,Cc|0,21)|0;Oc=D;Dc=ni(uc|0,pc|0,Mc|0,Oc|0)|0;kc=D;Nc=ii(Rc|0,wc|0,21)|0;Lc=D;Fc=ri(go|0,mo|0,Rd|0,wd|0)|0;Uc=D;Vc=ni(Fc|0,Uc|0,xl|0,Fl|0)|0;Hc=D;Bc=ri(Vc|0,Hc|0,Nc|0,Lc|0)|0;$c=D;jc=oi(Nc|0,Lc|0,21)|0;Gc=D;Wc=ni(Rc|0,wc|0,jc|0,Gc|0)|0;qc=D;Kc=ii(Bc|0,$c|0,21)|0;Jc=D;Yc=ri(Nl|0,Ll|0,Kc|0,Jc|0)|0;Qc=D;Xc=oi(Kc|0,Jc|0,21)|0;Zc=D;eh=ni(Bc|0,$c|0,Xc|0,Zc|0)|0;th=D;ih=ii(Yc|0,Qc|0,21)|0;nh=D;sh=ri(ih|0,nh|0,zl|0,Kl|0)|0;ah=D;oh=oi(ih|0,nh|0,21)|0;lh=D;dh=ni(Yc|0,Qc|0,oh|0,lh|0)|0;ch=D;hh=ii(sh|0,ah|0,21)|0;uh=D;ph=ri($l|0,jl|0,hh|0,uh|0)|0;gh=D;fh=oi(hh|0,uh|0,21)|0;Sh=D;vh=ni(sh|0,ah|0,fh|0,Sh|0)|0;yh=D;Ch=ii(ph|0,gh|0,21)|0;Th=D;Eh=ri(Ch|0,Th|0,rd|0,sd|0)|0;_h=D;bh=oi(Ch|0,Th|0,21)|0;Ph=D;Ah=ni(ph|0,gh|0,bh|0,Ph|0)|0;Rh=D;wh=ii(Eh|0,_h|0,21)|0;Mh=D;Oh=ri(Zl|0,ed|0,wh|0,Mh|0)|0;Dh=D;kh=oi(wh|0,Mh|0,21)|0;Nh=D;Lh=ni(Eh|0,_h|0,kh|0,Nh|0)|0;xh=D;Vh=ii(Oh|0,Dh|0,21)|0;Hh=D;Bh=ri(Vh|0,Hh|0,pd|0,gd|0)|0;$h=D;jh=oi(Vh|0,Hh|0,21)|0;Gh=D;Wh=ni(Oh|0,Dh|0,jh|0,Gh|0)|0;qh=D;zh=ii(Bh|0,$h|0,21)|0;Kh=D;Yh=oi(zh|0,Kh|0,21)|0;Qh=D;Xh=ni(Bh|0,$h|0,Yh|0,Qh|0)|0;Zh=D;eu=fi(zh|0,Kh|0,666643,0)|0;tu=D;iu=ri(eu|0,tu|0,$d|0,jd|0)|0;nu=D;ru=fi(zh|0,Kh|0,470296,0)|0;su=D;ou=ri(rc|0,sc|0,ru|0,su|0)|0;lu=D;du=fi(zh|0,Kh|0,654183,0)|0;cu=D;hu=ri(Sc|0,vc|0,du|0,cu|0)|0;uu=D;pu=fi(zh|0,Kh|0,-997805,-1)|0;gu=D;mu=ri(Dc|0,kc|0,pu|0,gu|0)|0;fu=D;vu=fi(zh|0,Kh|0,136657,0)|0;yu=D;Cu=ri(Wc|0,qc|0,vu|0,yu|0)|0;Tu=D;Eu=fi(zh|0,Kh|0,-683901,-1)|0;_u=D;bu=ri(eh|0,th|0,Eu|0,_u|0)|0;Pu=D;Iu=ii(iu|0,nu|0,21)|0;Au=D;wu=ri(ou|0,lu|0,Iu|0,Au|0)|0;Mu=D;Ou=oi(Iu|0,Au|0,21)|0;Du=D;ku=ni(iu|0,nu|0,Ou|0,Du|0)|0;Nu=D;Lu=ii(wu|0,Mu|0,21)|0;xu=D;Fu=ri(hu|0,uu|0,Lu|0,xu|0)|0;Uu=D;Hu=oi(Lu|0,xu|0,21)|0;Bu=D;$u=ni(wu|0,Mu|0,Hu|0,Bu|0)|0;ju=D;Gu=ii(Fu|0,Uu|0,21)|0;Wu=D;qu=ri(mu|0,fu|0,Gu|0,Wu|0)|0;zu=D;Ku=oi(Gu|0,Wu|0,21)|0;Ju=D;Qu=ni(Fu|0,Uu|0,Ku|0,Ju|0)|0;Xu=D;Zu=ii(qu|0,zu|0,21)|0;ep=D;tp=ri(Cu|0,Tu|0,Zu|0,ep|0)|0;ip=D;np=oi(Zu|0,ep|0,21)|0;rp=D;sp=ni(qu|0,zu|0,np|0,rp|0)|0;ap=D;lp=ii(tp|0,ip|0,21)|0;dp=D;cp=ri(bu|0,Pu|0,lp|0,dp|0)|0;hp=D;up=oi(lp|0,dp|0,21)|0;pp=D;gp=ni(tp|0,ip|0,up|0,pp|0)|0;mp=D;fp=ii(cp|0,hp|0,21)|0;Sp=D;yp=ri(fp|0,Sp|0,dh|0,ch|0)|0;Cp=D;Tp=oi(fp|0,Sp|0,21)|0;Ep=D;_p=ni(cp|0,hp|0,Tp|0,Ep|0)|0;bp=D;Pp=ii(yp|0,Cp|0,21)|0;Ip=D;Ap=ri(Pp|0,Ip|0,vh|0,yh|0)|0;Rp=D;Mp=oi(Pp|0,Ip|0,21)|0;Op=D;Dp=ni(yp|0,Cp|0,Mp|0,Op|0)|0;kp=D;Np=ii(Ap|0,Rp|0,21)|0;Lp=D;xp=ri(Np|0,Lp|0,Ah|0,Rh|0)|0;Fp=D;Up=oi(Np|0,Lp|0,21)|0;Vp=D;$p=ni(Ap|0,Rp|0,Up|0,Vp|0)|0;jp=D;Gp=ii(xp|0,Fp|0,21)|0;Wp=D;qp=ri(Gp|0,Wp|0,Lh|0,xh|0)|0;zp=D;Kp=oi(Gp|0,Wp|0,21)|0;Jp=D;Yp=ni(xp|0,Fp|0,Kp|0,Jp|0)|0;Qp=D;Zp=ii(qp|0,zp|0,21)|0;eg=D;tg=ri(Zp|0,eg|0,Wh|0,qh|0)|0;ig=D;ng=oi(Zp|0,eg|0,21)|0;rg=D;sg=ni(qp|0,zp|0,ng|0,rg|0)|0;ag=D;og=ii(tg|0,ig|0,21)|0;lg=D;cg=ri(og|0,lg|0,Xh|0,Zh|0)|0;hg=D;ug=oi(og|0,lg|0,21)|0;pg=D;gg=ni(tg|0,ig|0,ug|0,pg|0)|0;mg=D;fg=ku&255;n[e>>0]=fg;Sg=ai(ku|0,Nu|0,8)|0;vg=D;yg=Sg&255;Tg=e+1|0;n[Tg>>0]=yg;Eg=ai(ku|0,Nu|0,16)|0;_g=D;bg=oi($u|0,ju|0,5)|0;Pg=D;Ig=bg|Eg;Pg|_g;Ag=Ig&255;Rg=e+2|0;n[Rg>>0]=Ag;wg=ai($u|0,ju|0,3)|0;Mg=D;Dg=wg&255;kg=e+3|0;n[kg>>0]=Dg;Ng=ai($u|0,ju|0,11)|0;Lg=D;xg=Ng&255;Fg=e+4|0;n[Fg>>0]=xg;Ug=ai($u|0,ju|0,19)|0;Vg=D;Hg=oi(Qu|0,Xu|0,2)|0;Bg=D;jg=Hg|Ug;Bg|Vg;Gg=jg&255;Wg=e+5|0;n[Wg>>0]=Gg;qg=ai(Qu|0,Xu|0,6)|0;zg=D;Kg=qg&255;Jg=e+6|0;n[Jg>>0]=Kg;Yg=ai(Qu|0,Xu|0,14)|0;Qg=D;Xg=oi(sp|0,ap|0,7)|0;em=D;tm=Xg|Yg;em|Qg;im=tm&255;nm=e+7|0;n[nm>>0]=im;rm=ai(sp|0,ap|0,1)|0;sm=D;am=rm&255;om=e+8|0;n[om>>0]=am;lm=ai(sp|0,ap|0,9)|0;dm=D;hm=lm&255;um=e+9|0;n[um>>0]=hm;pm=ai(sp|0,ap|0,17)|0;gm=D;mm=oi(gp|0,mp|0,4)|0;fm=D;Sm=mm|pm;fm|gm;vm=Sm&255;ym=e+10|0;n[ym>>0]=vm;Cm=ai(gp|0,mp|0,4)|0;Em=D;_m=Cm&255;bm=e+11|0;n[bm>>0]=_m;Pm=ai(gp|0,mp|0,12)|0;Im=D;Am=Pm&255;Rm=e+12|0;n[Rm>>0]=Am;wm=ai(gp|0,mp|0,20)|0;Mm=D;Om=oi(_p|0,bp|0,1)|0;km=D;Nm=Om|wm;km|Mm;Lm=Nm&255;xm=e+13|0;n[xm>>0]=Lm;Fm=ai(_p|0,bp|0,7)|0;Um=D;Vm=Fm&255;Hm=e+14|0;n[Hm>>0]=Vm;Bm=ai(_p|0,bp|0,15)|0;$m=D;Wm=oi(Dp|0,kp|0,6)|0;qm=D;zm=Wm|Bm;qm|$m;Km=zm&255;Jm=e+15|0;n[Jm>>0]=Km;Ym=ai(Dp|0,kp|0,2)|0;Qm=D;Xm=Ym&255;Zm=e+16|0;n[Zm>>0]=Xm;ef=ai(Dp|0,kp|0,10)|0;nf=D;rf=ef&255;sf=e+17|0;n[sf>>0]=rf;af=ai(Dp|0,kp|0,18)|0;of=D;lf=oi($p|0,jp|0,3)|0;df=D;cf=lf|af;df|of;hf=cf&255;uf=e+18|0;n[uf>>0]=hf;gf=ai($p|0,jp|0,5)|0;mf=D;ff=gf&255;Sf=e+19|0;n[Sf>>0]=ff;vf=ai($p|0,jp|0,13)|0;yf=D;Cf=vf&255;Tf=e+20|0;n[Tf>>0]=Cf;Ef=Yp&255;_f=e+21|0;n[_f>>0]=Ef;Pf=ai(Yp|0,Qp|0,8)|0;If=D;Af=Pf&255;Rf=e+22|0;n[Rf>>0]=Af;wf=ai(Yp|0,Qp|0,16)|0;Mf=D;Of=oi(sg|0,ag|0,5)|0;Df=D;kf=Of|wf;Df|Mf;Nf=kf&255;xf=e+23|0;n[xf>>0]=Nf;Ff=ai(sg|0,ag|0,3)|0;Uf=D;Vf=Ff&255;Hf=e+24|0;n[Hf>>0]=Vf;Bf=ai(sg|0,ag|0,11)|0;$f=D;jf=Bf&255;Gf=e+25|0;n[Gf>>0]=jf;Wf=ai(sg|0,ag|0,19)|0;zf=D;Kf=oi(gg|0,mg|0,2)|0;Jf=D;Yf=Kf|Wf;Jf|zf;Qf=Yf&255;Xf=e+26|0;n[Xf>>0]=Qf;Zf=ai(gg|0,mg|0,6)|0;eS=D;tS=Zf&255;iS=e+27|0;n[iS>>0]=tS;rS=ai(gg|0,mg|0,14)|0;sS=D;aS=oi(cg|0,hg|0,7)|0;oS=D;lS=rS|aS;sS|oS;dS=lS&255;cS=e+28|0;n[cS>>0]=dS;hS=ai(cg|0,hg|0,1)|0;uS=D;pS=hS&255;mS=e+29|0;n[mS>>0]=pS;fS=ai(cg|0,hg|0,9)|0;SS=D;vS=fS&255;yS=e+30|0;n[yS>>0]=vS;CS=ai(cg|0,hg|0,17)|0;TS=D;ES=CS&255;_S=e+31|0;n[_S>>0]=ES;h=lN;return}function Vt(e){e=e|0;var t=0,i=0,r=0,s=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0;y=h;t=n[e>>0]|0;i=t&255;d=e+1|0;c=n[d>>0]|0;u=c&255;p=oi(u|0,0,8)|0;g=D;m=p|i;f=e+2|0;S=n[f>>0]|0;r=S&255;s=oi(r|0,0,16)|0;a=D;o=m|s;l=g|a;D=l;h=y;return o|0}function Ht(e){e=e|0;var t=0,i=0,r=0,s=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0;var _=0,b=0,P=0,I=0;I=h;t=n[e>>0]|0;i=t&255;m=e+1|0;v=n[m>>0]|0;y=v&255;C=oi(y|0,0,8)|0;T=D;E=C|i;_=e+2|0;b=n[_>>0]|0;r=b&255;s=oi(r|0,0,16)|0;a=D;o=E|s;l=T|a;d=e+3|0;c=n[d>>0]|0;u=c&255;p=oi(u|0,0,24)|0;g=D;f=o|p;S=l|g;D=S;h=I;return f|0}function Bt(e){e=e|0;var t=0,i=0,r=0,s=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0;var _=0,b=0,P=0,I=0,A=0,R=0,w=0,M=0,O=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0,j=0;var G=0,W=0,q=0,z=0,K=0,J=0,Y=0,Q=0,X=0,Z=0,ee=0,te=0,ie=0,ne=0,re=0,se=0,ae=0,oe=0,le=0,de=0;var ce=0,he=0,ue=0,pe=0,ge=0,me=0,fe=0,Se=0,ve=0,ye=0,Ce=0,Te=0,Ee=0,_e=0,be=0,Pe=0,Ie=0,Ae=0,Re=0,we=0;var Me=0,Oe=0,De=0,ke=0,Ne=0,Le=0,xe=0,Fe=0,Ue=0,Ve=0,He=0,Be=0,$e=0,je=0,Ge=0,We=0,qe=0,ze=0,Ke=0,Je=0;var Ye=0,Qe=0,Xe=0,Ze=0,et=0,tt=0,it=0,nt=0,rt=0,st=0,at=0,ot=0,lt=0,dt=0,ct=0,ht=0,ut=0,pt=0,gt=0,mt=0;var ft=0,St=0,vt=0,yt=0,Ct=0,Tt=0,Et=0,_t=0,bt=0,Pt=0,It=0,At=0,Rt=0,wt=0,Mt=0,Ot=0,Dt=0,kt=0,Nt=0,Lt=0;var xt=0,Ft=0,Ut=0,Vt=0,Ht=0,Bt=0,Gt=0,Wt=0,qt=0,zt=0,Kt=0,Jt=0,Yt=0,Qt=0,Xt=0,Zt=0,ei=0,ti=0,si=0,li=0;var di=0,ci=0,hi=0,ui=0,pi=0,gi=0,mi=0,Si=0,vi=0,yi=0,Ci=0,Ti=0,Ei=0,_i=0,bi=0,Pi=0,Ii=0,Ai=0,Ri=0,wi=0;var Mi=0,Oi=0,Di=0,ki=0,Ni=0,Li=0,xi=0,Fi=0,Ui=0,Vi=0,Hi=0,Bi=0,$i=0,ji=0,Gi=0,Wi=0,qi=0,zi=0,Ki=0,Ji=0;var Yi=0,Qi=0,Xi=0,Zi=0,en=0,tn=0,nn=0,rn=0,sn=0,an=0,on=0,ln=0,dn=0,cn=0,hn=0,un=0,pn=0,gn=0,mn=0,fn=0;var Sn=0,vn=0,yn=0,Cn=0,Tn=0,En=0,_n=0,bn=0,Pn=0,In=0,An=0,Rn=0,wn=0,Mn=0,On=0,Dn=0,kn=0,Nn=0,Ln=0,xn=0;var Fn=0,Un=0,Vn=0,Hn=0,Bn=0,$n=0,jn=0,Gn=0,Wn=0,qn=0,zn=0,Kn=0,Jn=0,Yn=0,Qn=0,Xn=0,Zn=0,er=0,tr=0,ir=0;var nr=0,rr=0,sr=0,ar=0,or=0,lr=0,dr=0,cr=0,hr=0,ur=0,pr=0,gr=0,mr=0,fr=0,Sr=0,vr=0,yr=0,Cr=0,Tr=0,Er=0;var _r=0,br=0,Pr=0,Ir=0,Ar=0,Rr=0,wr=0,Mr=0,Or=0,Dr=0,kr=0,Nr=0,Lr=0,xr=0,Fr=0,Ur=0,Vr=0,Hr=0,Br=0,$r=0;var jr=0,Gr=0,Wr=0,qr=0,zr=0,Kr=0,Jr=0,Yr=0,Qr=0,Xr=0,Zr=0,es=0,ts=0,is=0,ns=0,rs=0,ss=0,as=0,os=0,ls=0;var ds=0,cs=0,hs=0,us=0,ps=0,gs=0,ms=0,fs=0,Ss=0,vs=0,ys=0,Cs=0,Ts=0,Es=0,_s=0,bs=0,Ps=0,Is=0,As=0,Rs=0;var ws=0,Ms=0,Os=0,Ds=0,ks=0,Ns=0,Ls=0,xs=0,Fs=0,Us=0,Vs=0,Hs=0,Bs=0,$s=0,js=0,Gs=0,Ws=0,qs=0,zs=0,Ks=0;var Js=0,Ys=0,Qs=0,Xs=0,Zs=0,ea=0,ta=0,ia=0,na=0,ra=0,sa=0,aa=0,oa=0,la=0,da=0,ca=0,ha=0,ua=0,pa=0,ga=0;var ma=0,fa=0,Sa=0,va=0,ya=0,Ca=0,Ta=0,Ea=0,_a=0,ba=0,Pa=0,Ia=0,Aa=0,Ra=0,wa=0,Ma=0,Oa=0,Da=0,ka=0,Na=0;var La=0,xa=0,Fa=0,Ua=0,Va=0,Ha=0,Ba=0,$a=0,ja=0,Ga=0,Wa=0,qa=0,za=0,Ka=0,Ja=0,Ya=0,Qa=0,Xa=0,Za=0,eo=0;var to=0,io=0,no=0,ro=0,so=0,ao=0,oo=0,lo=0,co=0,ho=0,uo=0,po=0,go=0,mo=0,fo=0,So=0,vo=0,yo=0,Co=0,To=0;var Eo=0,_o=0,bo=0,Po=0,Io=0,Ao=0,Ro=0,wo=0,Mo=0,Oo=0,Do=0,ko=0,No=0,Lo=0,xo=0,Fo=0,Uo=0,Vo=0,Ho=0,Bo=0;var $o=0,jo=0,Go=0,Wo=0,qo=0,zo=0,Ko=0,Jo=0,Yo=0,Qo=0,Xo=0,Zo=0,el=0,tl=0,il=0,nl=0,rl=0,sl=0,al=0,ol=0;var ll=0,dl=0,cl=0,hl=0,ul=0,pl=0,gl=0,ml=0,fl=0,Sl=0,vl=0,yl=0,Cl=0,Tl=0,El=0,_l=0,bl=0,Pl=0,Il=0,Al=0;var Rl=0,wl=0,Ml=0,Ol=0,Dl=0,kl=0,Nl=0,Ll=0,xl=0,Fl=0,Ul=0,Vl=0,Hl=0,Bl=0,$l=0,jl=0,Gl=0,Wl=0,ql=0,zl=0;var Kl=0,Jl=0,Yl=0,Ql=0,Xl=0,Zl=0,ed=0,td=0,id=0,nd=0,rd=0,sd=0,ad=0,od=0,ld=0,dd=0,cd=0,hd=0,ud=0,pd=0;var gd=0,md=0,fd=0,Sd=0,vd=0,yd=0,Cd=0,Td=0,Ed=0,_d=0,bd=0,Pd=0,Id=0,Ad=0,Rd=0,wd=0,Md=0,Od=0,Dd=0,kd=0;var Nd=0,Ld=0,xd=0,Fd=0,Ud=0,Vd=0,Hd=0,Bd=0,$d=0,jd=0,Gd=0,Wd=0,qd=0,zd=0,Kd=0,Jd=0,Yd=0,Qd=0,Xd=0,Zd=0;var ec=0,tc=0,ic=0,nc=0,rc=0,sc=0,ac=0,oc=0,lc=0,dc=0,cc=0,hc=0,uc=0,pc=0,gc=0,mc=0,fc=0,Sc=0,vc=0,yc=0;var Cc=0,Tc=0,Ec=0,_c=0,bc=0,Pc=0,Ic=0,Ac=0,Rc=0,wc=0,Mc=0,Oc=0,Dc=0,kc=0,Nc=0,Lc=0,xc=0,Fc=0,Uc=0,Vc=0;var Hc=0,Bc=0,$c=0,jc=0,Gc=0,Wc=0,qc=0,zc=0,Kc=0,Jc=0,Yc=0,Qc=0,Xc=0,Zc=0,eh=0,th=0,ih=0,nh=0,rh=0,sh=0;var ah=0,oh=0,lh=0,dh=0,ch=0,hh=0,uh=0,ph=0,gh=0,mh=0,fh=0,Sh=0,vh=0,yh=0,Ch=0,Th=0,Eh=0,_h=0,bh=0,Ph=0;var Ih=0,Ah=0,Rh=0,wh=0,Mh=0,Oh=0,Dh=0,kh=0,Nh=0,Lh=0,xh=0,Fh=0,Uh=0,Vh=0,Hh=0,Bh=0,$h=0,jh=0,Gh=0,Wh=0;var qh=0,zh=0,Kh=0,Jh=0,Yh=0,Qh=0,Xh=0,Zh=0,eu=0,tu=0,iu=0,nu=0,ru=0,su=0,au=0,ou=0,lu=0,du=0,cu=0,hu=0;var uu=0,pu=0,gu=0,mu=0,fu=0,Su=0,vu=0,yu=0,Cu=0,Tu=0,Eu=0,_u=0,bu=0,Pu=0,Iu=0,Au=0,Ru=0,wu=0,Mu=0,Ou=0;var Du=0,ku=0,Nu=0,Lu=0,xu=0,Fu=0,Uu=0,Vu=0,Hu=0,Bu=0,$u=0,ju=0,Gu=0,Wu=0,qu=0,zu=0,Ku=0,Ju=0,Yu=0,Qu=0;var Xu=0,Zu=0,ep=0,tp=0,ip=0,np=0,rp=0,sp=0,ap=0,op=0,lp=0,dp=0,cp=0,hp=0,up=0,pp=0,gp=0,mp=0,fp=0,Sp=0;var vp=0,yp=0,Cp=0,Tp=0,Ep=0,_p=0,bp=0,Pp=0,Ip=0,Ap=0,Rp=0,wp=0,Mp=0,Op=0,Dp=0,kp=0,Np=0,Lp=0,xp=0,Fp=0;var Up=0,Vp=0,Hp=0,Bp=0,$p=0,jp=0,Gp=0,Wp=0,qp=0,zp=0,Kp=0,Jp=0,Yp=0,Qp=0,Xp=0,Zp=0,eg=0,tg=0,ig=0,ng=0;var rg=0,sg=0,ag=0,og=0,lg=0,dg=0,cg=0,hg=0,ug=0,pg=0,gg=0,mg=0,fg=0,Sg=0,vg=0,yg=0,Cg=0,Tg=0,Eg=0,_g=0;var bg=0,Pg=0,Ig=0,Ag=0,Rg=0,wg=0,Mg=0,Og=0,Dg=0,kg=0,Ng=0,Lg=0,xg=0,Fg=0,Ug=0,Vg=0,Hg=0,Bg=0,$g=0,jg=0;var Gg=0,Wg=0,qg=0,zg=0,Kg=0,Jg=0,Yg=0,Qg=0,Xg=0,Zg=0,em=0,tm=0,im=0,nm=0,rm=0,sm=0,am=0,om=0,lm=0,dm=0;var cm=0,hm=0,um=0,pm=0,gm=0,mm=0,fm=0,Sm=0,vm=0,ym=0,Cm=0,Tm=0,Em=0,_m=0,bm=0,Pm=0,Im=0,Am=0,Rm=0,wm=0;var Mm=0,Om=0,Dm=0,km=0,Nm=0,Lm=0,xm=0,Fm=0,Um=0,Vm=0,Hm=0,Bm=0,$m=0,jm=0,Gm=0,Wm=0,qm=0,zm=0,Km=0,Jm=0;var Ym=0,Qm=0,Xm=0,Zm=0,ef=0,tf=0,nf=0,rf=0,sf=0,af=0,of=0,lf=0,df=0,cf=0,hf=0,uf=0,pf=0,gf=0,mf=0,ff=0;var Sf=0,vf=0,yf=0,Cf=0,Tf=0,Ef=0,_f=0,bf=0,Pf=0,If=0,Af=0,Rf=0,wf=0,Mf=0,Of=0,Df=0,kf=0,Nf=0,Lf=0,xf=0;var Ff=0,Uf=0,Vf=0,Hf=0,Bf=0,$f=0,jf=0,Gf=0,Wf=0,qf=0,zf=0,Kf=0,Jf=0,Yf=0,Qf=0,Xf=0,Zf=0,eS=0,tS=0,iS=0;var nS=0,rS=0,sS=0,aS=0,oS=0,lS=0,dS=0,cS=0,hS=0,uS=0,pS=0,gS=0,mS=0,fS=0,SS=0,vS=0,yS=0,CS=0,TS=0,ES=0;var _S=0,bS=0,PS=0,IS=0,AS=0,RS=0,wS=0,MS=0,OS=0,DS=0,kS=0,NS=0,LS=0,xS=0,FS=0,US=0,VS=0,HS=0,BS=0,$S=0;var jS=0,GS=0,WS=0,qS=0,zS=0,KS=0,JS=0,YS=0,QS=0,XS=0,ZS=0,ev=0,tv=0,iv=0,nv=0,rv=0,sv=0,av=0,ov=0,lv=0;var dv=0,cv=0,hv=0,uv=0,pv=0;pv=h;t=$t(e)|0;i=D;Ot=t&2097151;jn=e+2|0;qs=jt(jn)|0;Yo=D;Zd=ai(qs|0,Yo|0,5)|0;iu=D;sg=Zd&2097151;df=e+5|0;r=$t(df)|0;H=D;Q=ai(r|0,H|0,2)|0;le=D;ye=Q&2097151;Me=e+7|0;Be=jt(Me)|0;Xe=D;dt=ai(Be|0,Xe|0,7)|0;Ct=D;Dt=dt&2097151;Wt=e+10|0;si=jt(Wt)|0;yi=D;Mi=ai(si|0,yi|0,4)|0;Bi=D;Xi=Mi&2097151;cn=e+13|0;Tn=$t(cn)|0;Dn=D;Gn=ai(Tn|0,Dn|0,1)|0;tr=D;ur=Gn&2097151;_r=e+15|0;Nr=jt(_r)|0;Wr=D;is=ai(Nr|0,Wr|0,6)|0;ps=D;bs=is&2097151;Ls=e+18|0;zs=$t(Ls)|0;ra=D;ma=ai(zs|0,ra|0,3)|0;Ia=D;Fa=ma&2097151;Ka=e+21|0;so=$t(Ka)|0;So=D;Ro=so&2097151;Vo=e+23|0;Qo=jt(Vo)|0;ll=D;yl=ai(Qo|0,ll|0,5)|0;Ml=D;Bl=yl&2097151;Xl=e+26|0;dd=$t(Xl)|0;Cd=D;Od=ai(dd|0,Cd|0,2)|0;$d=D;ec=Od&2097151;hc=e+28|0;Ec=jt(hc)|0;kc=D;Gc=ai(Ec|0,kc|0,7)|0;th=D;uh=Gc&2097151;_h=e+31|0;Nh=jt(_h)|0;Wh=D;nu=ai(Nh|0,Wh|0,4)|0;gu=D;Pu=nu&2097151;xu=e+34|0;zu=$t(xu)|0;rp=D;mp=ai(zu|0,rp|0,1)|0;Ip=D;Fp=mp&2097151;Kp=e+36|0;ag=jt(Kp)|0;Sg=D;Rg=ai(ag|0,Sg|0,6)|0;Vg=D;Yg=Rg&2097151;om=e+39|0;vm=$t(om)|0;wm=D;Hm=ai(vm|0,wm|0,3)|0;Qm=D;cf=Hm&2097151;Tf=e+42|0;Df=$t(Tf)|0;jf=D;eS=Df&2097151;hS=e+44|0;ES=jt(hS)|0;kS=D;GS=ai(ES|0,kS|0,5)|0;tv=D;s=GS&2097151;S=e+47|0;R=$t(S)|0;k=D;N=ai(R|0,k|0,2)|0;L=D;x=N&2097151;F=e+49|0;U=jt(F)|0;V=D;B=ai(U|0,V|0,7)|0;$=D;j=B&2097151;G=e+52|0;W=jt(G)|0;q=D;z=ai(W|0,q|0,4)|0;K=D;J=z&2097151;Y=e+55|0;X=$t(Y)|0;Z=D;ee=ai(X|0,Z|0,1)|0;te=D;ie=ee&2097151;ne=e+57|0;re=jt(ne)|0;se=D;ae=ai(re|0,se|0,6)|0;oe=D;de=ae&2097151;ce=e+60|0;he=jt(ce)|0;ue=D;pe=ai(he|0,ue|0,3)|0;ge=D;me=fi(pe|0,ge|0,666643,0)|0;fe=D;Se=fi(pe|0,ge|0,470296,0)|0;ve=D;Ce=fi(pe|0,ge|0,654183,0)|0;Te=D;Ee=fi(pe|0,ge|0,-997805,-1)|0;_e=D;be=fi(pe|0,ge|0,136657,0)|0;Pe=D;Ie=ri(be|0,Pe|0,cf|0,0)|0;Ae=D;Re=fi(pe|0,ge|0,-683901,-1)|0;we=D;Oe=ri(Re|0,we|0,eS|0,0)|0;De=D;ke=fi(de|0,0,666643,0)|0;Ne=D;Le=fi(de|0,0,470296,0)|0;xe=D;Fe=fi(de|0,0,654183,0)|0;Ue=D;Ve=fi(de|0,0,-997805,-1)|0;He=D;$e=fi(de|0,0,136657,0)|0;je=D;Ge=fi(de|0,0,-683901,-1)|0;We=D;qe=ri(Ie|0,Ae|0,Ge|0,We|0)|0;ze=D;Ke=fi(ie|0,0,666643,0)|0;Je=D;Ye=fi(ie|0,0,470296,0)|0;Qe=D;Ze=fi(ie|0,0,654183,0)|0;et=D;tt=fi(ie|0,0,-997805,-1)|0;it=D;nt=fi(ie|0,0,136657,0)|0;rt=D;st=fi(ie|0,0,-683901,-1)|0;at=D;ot=ri(st|0,at|0,Yg|0,0)|0;lt=D;ct=ri(ot|0,lt|0,Ee|0,_e|0)|0;ht=D;ut=ri(ct|0,ht|0,$e|0,je|0)|0;pt=D;gt=fi(J|0,0,666643,0)|0;mt=D;ft=fi(J|0,0,470296,0)|0;St=D;vt=fi(J|0,0,654183,0)|0;yt=D;Tt=fi(J|0,0,-997805,-1)|0;Et=D;_t=fi(J|0,0,136657,0)|0;bt=D;Pt=fi(J|0,0,-683901,-1)|0;It=D;At=fi(j|0,0,666643,0)|0;Rt=D;wt=fi(j|0,0,470296,0)|0;Mt=D;kt=fi(j|0,0,654183,0)|0;Nt=D;Lt=fi(j|0,0,-997805,-1)|0;xt=D;Ft=fi(j|0,0,136657,0)|0;Ut=D;Vt=fi(j|0,0,-683901,-1)|0;Ht=D;Bt=ri(Vt|0,Ht|0,Pu|0,0)|0;Gt=D;qt=ri(Bt|0,Gt|0,_t|0,bt|0)|0;zt=D;Kt=ri(qt|0,zt|0,tt|0,it|0)|0;Jt=D;Yt=ri(Kt|0,Jt|0,Se|0,ve|0)|0;Qt=D;Xt=ri(Yt|0,Qt|0,Fe|0,Ue|0)|0;Zt=D;ei=fi(x|0,0,666643,0)|0;ti=D;li=ri(ei|0,ti|0,bs|0,0)|0;di=D;ci=fi(x|0,0,470296,0)|0;hi=D;ui=fi(x|0,0,654183,0)|0;pi=D;gi=ri(ui|0,pi|0,Ro|0,0)|0;mi=D;Si=ri(gi|0,mi|0,wt|0,Mt|0)|0;vi=D;Ci=ri(Si|0,vi|0,gt|0,mt|0)|0;Ti=D;Ei=fi(x|0,0,-997805,-1)|0;_i=D;bi=fi(x|0,0,136657,0)|0;Pi=D;Ii=ri(bi|0,Pi|0,ec|0,0)|0;Ai=D;Ri=ri(Ii|0,Ai|0,Lt|0,xt|0)|0;wi=D;Oi=ri(Ri|0,wi|0,vt|0,yt|0)|0;Di=D;ki=ri(Oi|0,Di|0,Ye|0,Qe|0)|0;Ni=D;Li=ri(ki|0,Ni|0,ke|0,Ne|0)|0;xi=D;Fi=fi(x|0,0,-683901,-1)|0;Ui=D;Vi=ri(li|0,di|0,1048576,0)|0;Hi=D;$i=ai(Vi|0,Hi|0,21)|0;ji=D;Gi=ri(ci|0,hi|0,Fa|0,0)|0;Wi=D;qi=ri(Gi|0,Wi|0,At|0,Rt|0)|0;zi=D;Ki=ri(qi|0,zi|0,$i|0,ji|0)|0;Ji=D;Yi=oi($i|0,ji|0,21)|0;Qi=D;Zi=ni(li|0,di|0,Yi|0,Qi|0)|0;en=D;tn=ri(Ci|0,Ti|0,1048576,0)|0;nn=D;rn=ai(tn|0,nn|0,21)|0;sn=D;an=ri(Ei|0,_i|0,Bl|0,0)|0;on=D;ln=ri(an|0,on|0,kt|0,Nt|0)|0;dn=D;hn=ri(ln|0,dn|0,ft|0,St|0)|0;un=D;pn=ri(hn|0,un|0,Ke|0,Je|0)|0;gn=D;mn=ri(pn|0,gn|0,rn|0,sn|0)|0;fn=D;Sn=oi(rn|0,sn|0,21)|0;vn=D;yn=ni(Ci|0,Ti|0,Sn|0,vn|0)|0;Cn=D;En=ri(Li|0,xi|0,1048576,0)|0;_n=D;bn=ii(En|0,_n|0,21)|0;Pn=D;In=ri(Fi|0,Ui|0,uh|0,0)|0;An=D;Rn=ri(In|0,An|0,Ft|0,Ut|0)|0;wn=D;Mn=ri(Rn|0,wn|0,Tt|0,Et|0)|0;On=D;kn=ri(Mn|0,On|0,Ze|0,et|0)|0;Nn=D;Ln=ri(kn|0,Nn|0,me|0,fe|0)|0;xn=D;Fn=ri(Ln|0,xn|0,Le|0,xe|0)|0;Un=D;Vn=ri(Fn|0,Un|0,bn|0,Pn|0)|0;Hn=D;Bn=oi(bn|0,Pn|0,21)|0;$n=D;Wn=ni(Li|0,xi|0,Bn|0,$n|0)|0;qn=D;zn=ri(Xt|0,Zt|0,1048576,0)|0;Kn=D;Jn=ii(zn|0,Kn|0,21)|0;Yn=D;Qn=ri(Pt|0,It|0,Fp|0,0)|0;Xn=D;Zn=ri(Qn|0,Xn|0,nt|0,rt|0)|0;er=D;ir=ri(Zn|0,er|0,Ce|0,Te|0)|0;nr=D;rr=ri(ir|0,nr|0,Ve|0,He|0)|0;sr=D;ar=ri(rr|0,sr|0,Jn|0,Yn|0)|0;or=D;lr=oi(Jn|0,Yn|0,21)|0;dr=D;cr=ni(Xt|0,Zt|0,lr|0,dr|0)|0;hr=D;pr=ri(ut|0,pt|0,1048576,0)|0;gr=D;mr=ii(pr|0,gr|0,21)|0;fr=D;Sr=ri(qe|0,ze|0,mr|0,fr|0)|0;vr=D;yr=oi(mr|0,fr|0,21)|0;Cr=D;Tr=ni(ut|0,pt|0,yr|0,Cr|0)|0;Er=D;br=ri(Oe|0,De|0,1048576,0)|0;Pr=D;Ir=ii(br|0,Pr|0,21)|0;Ar=D;Rr=ri(Ir|0,Ar|0,s|0,0)|0;wr=D;Mr=oi(Ir|0,Ar|0,21)|0;Or=D;Dr=ni(Oe|0,De|0,Mr|0,Or|0)|0;kr=D;Lr=ri(Ki|0,Ji|0,1048576,0)|0;xr=D;Fr=ai(Lr|0,xr|0,21)|0;Ur=D;Vr=ri(yn|0,Cn|0,Fr|0,Ur|0)|0;Hr=D;Br=oi(Fr|0,Ur|0,21)|0;$r=D;jr=ni(Ki|0,Ji|0,Br|0,$r|0)|0;Gr=D;qr=ri(mn|0,fn|0,1048576,0)|0;zr=D;Kr=ii(qr|0,zr|0,21)|0;Jr=D;Yr=ri(Wn|0,qn|0,Kr|0,Jr|0)|0;Qr=D;Xr=oi(Kr|0,Jr|0,21)|0;Zr=D;es=ni(mn|0,fn|0,Xr|0,Zr|0)|0;ts=D;ns=ri(Vn|0,Hn|0,1048576,0)|0;rs=D;ss=ii(ns|0,rs|0,21)|0;as=D;os=ri(cr|0,hr|0,ss|0,as|0)|0;ls=D;ds=oi(ss|0,as|0,21)|0;cs=D;hs=ni(Vn|0,Hn|0,ds|0,cs|0)|0;us=D;gs=ri(ar|0,or|0,1048576,0)|0;ms=D;fs=ii(gs|0,ms|0,21)|0;Ss=D;vs=ri(fs|0,Ss|0,Tr|0,Er|0)|0;ys=D;Cs=oi(fs|0,Ss|0,21)|0;Ts=D;Es=ni(ar|0,or|0,Cs|0,Ts|0)|0;_s=D;Ps=ri(Sr|0,vr|0,1048576,0)|0;Is=D;As=ii(Ps|0,Is|0,21)|0;Rs=D;ws=ri(As|0,Rs|0,Dr|0,kr|0)|0;Ms=D;Os=oi(As|0,Rs|0,21)|0;Ds=D;ks=ni(Sr|0,vr|0,Os|0,Ds|0)|0;Ns=D;xs=fi(Rr|0,wr|0,666643,0)|0;Fs=D;Us=ri(xs|0,Fs|0,ur|0,0)|0;Vs=D;Hs=fi(Rr|0,wr|0,470296,0)|0;Bs=D;$s=ri(Zi|0,en|0,Hs|0,Bs|0)|0;js=D;Gs=fi(Rr|0,wr|0,654183,0)|0;Ws=D;Ks=ri(jr|0,Gr|0,Gs|0,Ws|0)|0;Js=D;Ys=fi(Rr|0,wr|0,-997805,-1)|0;Qs=D;Xs=ri(Vr|0,Hr|0,Ys|0,Qs|0)|0;Zs=D;ea=fi(Rr|0,wr|0,136657,0)|0;ta=D;ia=ri(es|0,ts|0,ea|0,ta|0)|0;na=D;sa=fi(Rr|0,wr|0,-683901,-1)|0;aa=D;oa=ri(Yr|0,Qr|0,sa|0,aa|0)|0;la=D;da=fi(ws|0,Ms|0,666643,0)|0;ca=D;ha=fi(ws|0,Ms|0,470296,0)|0;ua=D;pa=fi(ws|0,Ms|0,654183,0)|0;ga=D;fa=ri($s|0,js|0,pa|0,ga|0)|0;Sa=D;va=fi(ws|0,Ms|0,-997805,-1)|0;ya=D;Ca=ri(Ks|0,Js|0,va|0,ya|0)|0;Ta=D;Ea=fi(ws|0,Ms|0,136657,0)|0;_a=D;ba=ri(Xs|0,Zs|0,Ea|0,_a|0)|0;Pa=D;Aa=fi(ws|0,Ms|0,-683901,-1)|0;Ra=D;wa=ri(ia|0,na|0,Aa|0,Ra|0)|0;Ma=D;Oa=fi(ks|0,Ns|0,666643,0)|0;Da=D;ka=fi(ks|0,Ns|0,470296,0)|0;Na=D;La=fi(ks|0,Ns|0,654183,0)|0;xa=D;Ua=fi(ks|0,Ns|0,-997805,-1)|0;Va=D;Ha=fi(ks|0,Ns|0,136657,0)|0;Ba=D;$a=fi(ks|0,Ns|0,-683901,-1)|0;ja=D;Ga=ri(ba|0,Pa|0,$a|0,ja|0)|0;Wa=D;qa=fi(vs|0,ys|0,666643,0)|0;za=D;Ja=fi(vs|0,ys|0,470296,0)|0;Ya=D;Qa=fi(vs|0,ys|0,654183,0)|0;Xa=D;Za=fi(vs|0,ys|0,-997805,-1)|0;eo=D;to=fi(vs|0,ys|0,136657,0)|0;io=D;no=fi(vs|0,ys|0,-683901,-1)|0;ro=D;ao=fi(Es|0,_s|0,666643,0)|0;oo=D;lo=fi(Es|0,_s|0,470296,0)|0;co=D;ho=fi(Es|0,_s|0,654183,0)|0;uo=D;po=fi(Es|0,_s|0,-997805,-1)|0;go=D;mo=fi(Es|0,_s|0,136657,0)|0;fo=D;vo=fi(Es|0,_s|0,-683901,-1)|0;yo=D;Co=ri(fa|0,Sa|0,to|0,io|0)|0;To=D;Eo=ri(Co|0,To|0,Ua|0,Va|0)|0;_o=D;bo=ri(Eo|0,_o|0,vo|0,yo|0)|0;Po=D;Io=fi(os|0,ls|0,666643,0)|0;Ao=D;wo=ri(Io|0,Ao|0,Ot|0,0)|0;Mo=D;Oo=fi(os|0,ls|0,470296,0)|0;Do=D;ko=fi(os|0,ls|0,654183,0)|0;No=D;Lo=ri(ko|0,No|0,ye|0,0)|0;xo=D;Fo=ri(Lo|0,xo|0,qa|0,za|0)|0;Uo=D;Ho=ri(Fo|0,Uo|0,lo|0,co|0)|0;Bo=D;$o=fi(os|0,ls|0,-997805,-1)|0;jo=D;Go=fi(os|0,ls|0,136657,0)|0;Wo=D;qo=ri(Go|0,Wo|0,Xi|0,0)|0;zo=D;Ko=ri(qo|0,zo|0,da|0,ca|0)|0;Jo=D;Xo=ri(Ko|0,Jo|0,Qa|0,Xa|0)|0;Zo=D;el=ri(Xo|0,Zo|0,ka|0,Na|0)|0;tl=D;il=ri(el|0,tl|0,po|0,go|0)|0;nl=D;rl=fi(os|0,ls|0,-683901,-1)|0;sl=D;al=ri(wo|0,Mo|0,1048576,0)|0;ol=D;dl=ii(al|0,ol|0,21)|0;cl=D;hl=ri(Oo|0,Do|0,sg|0,0)|0;ul=D;pl=ri(hl|0,ul|0,ao|0,oo|0)|0;gl=D;ml=ri(pl|0,gl|0,dl|0,cl|0)|0;fl=D;Sl=oi(dl|0,cl|0,21)|0;vl=D;Cl=ni(wo|0,Mo|0,Sl|0,vl|0)|0;Tl=D;El=ri(Ho|0,Bo|0,1048576,0)|0;_l=D;bl=ii(El|0,_l|0,21)|0;Pl=D;Il=ri($o|0,jo|0,Dt|0,0)|0;Al=D;Rl=ri(Il|0,Al|0,Ja|0,Ya|0)|0;wl=D;Ol=ri(Rl|0,wl|0,Oa|0,Da|0)|0;Dl=D;kl=ri(Ol|0,Dl|0,ho|0,uo|0)|0;Nl=D;Ll=ri(kl|0,Nl|0,bl|0,Pl|0)|0;xl=D;Fl=oi(bl|0,Pl|0,21)|0;Ul=D;Vl=ri(il|0,nl|0,1048576,0)|0;Hl=D;$l=ii(Vl|0,Hl|0,21)|0;jl=D;Gl=ri(Us|0,Vs|0,rl|0,sl|0)|0;Wl=D;ql=ri(Gl|0,Wl|0,ha|0,ua|0)|0;zl=D;Kl=ri(ql|0,zl|0,Za|0,eo|0)|0;Jl=D;Yl=ri(Kl|0,Jl|0,La|0,xa|0)|0;Ql=D;Zl=ri(Yl|0,Ql|0,mo|0,fo|0)|0;ed=D;td=ri(Zl|0,ed|0,$l|0,jl|0)|0;id=D;nd=oi($l|0,jl|0,21)|0;rd=D;sd=ri(bo|0,Po|0,1048576,0)|0;ad=D;od=ii(sd|0,ad|0,21)|0;ld=D;cd=ri(Ca|0,Ta|0,no|0,ro|0)|0;hd=D;ud=ri(cd|0,hd|0,Ha|0,Ba|0)|0;pd=D;gd=ri(ud|0,pd|0,od|0,ld|0)|0;md=D;fd=oi(od|0,ld|0,21)|0;Sd=D;vd=ni(bo|0,Po|0,fd|0,Sd|0)|0;yd=D;Td=ri(Ga|0,Wa|0,1048576,0)|0;Ed=D;_d=ii(Td|0,Ed|0,21)|0;bd=D;Pd=ri(wa|0,Ma|0,_d|0,bd|0)|0;Id=D;Ad=oi(_d|0,bd|0,21)|0;Rd=D;wd=ni(Ga|0,Wa|0,Ad|0,Rd|0)|0;Md=D;Dd=ri(oa|0,la|0,1048576,0)|0;kd=D;Nd=ii(Dd|0,kd|0,21)|0;Ld=D;xd=ri(Nd|0,Ld|0,hs|0,us|0)|0;Fd=D;Ud=oi(Nd|0,Ld|0,21)|0;Vd=D;Hd=ni(oa|0,la|0,Ud|0,Vd|0)|0;Bd=D;jd=ri(ml|0,fl|0,1048576,0)|0;Gd=D;Wd=ii(jd|0,Gd|0,21)|0;qd=D;zd=oi(Wd|0,qd|0,21)|0;Kd=D;Jd=ri(Ll|0,xl|0,1048576,0)|0;Yd=D;Qd=ii(Jd|0,Yd|0,21)|0;Xd=D;tc=oi(Qd|0,Xd|0,21)|0;ic=D;nc=ri(td|0,id|0,1048576,0)|0;rc=D;sc=ii(nc|0,rc|0,21)|0;ac=D;oc=ri(vd|0,yd|0,sc|0,ac|0)|0;lc=D;dc=oi(sc|0,ac|0,21)|0;cc=D;uc=ri(gd|0,md|0,1048576,0)|0;pc=D;gc=ii(uc|0,pc|0,21)|0;mc=D;fc=ri(wd|0,Md|0,gc|0,mc|0)|0;Sc=D;vc=oi(gc|0,mc|0,21)|0;yc=D;Cc=ni(gd|0,md|0,vc|0,yc|0)|0;Tc=D;_c=ri(Pd|0,Id|0,1048576,0)|0;bc=D;Pc=ii(_c|0,bc|0,21)|0;Ic=D;Ac=ri(Hd|0,Bd|0,Pc|0,Ic|0)|0;Rc=D;wc=oi(Pc|0,Ic|0,21)|0;Mc=D;Oc=ni(Pd|0,Id|0,wc|0,Mc|0)|0;Dc=D;Nc=ri(xd|0,Fd|0,1048576,0)|0;Lc=D;xc=ii(Nc|0,Lc|0,21)|0;Fc=D;Uc=oi(xc|0,Fc|0,21)|0;Vc=D;Hc=ni(xd|0,Fd|0,Uc|0,Vc|0)|0;Bc=D;$c=fi(xc|0,Fc|0,666643,0)|0;jc=D;Wc=ri(Cl|0,Tl|0,$c|0,jc|0)|0;qc=D;zc=fi(xc|0,Fc|0,470296,0)|0;Kc=D;Jc=fi(xc|0,Fc|0,654183,0)|0;Yc=D;Qc=fi(xc|0,Fc|0,-997805,-1)|0;Xc=D;Zc=fi(xc|0,Fc|0,136657,0)|0;eh=D;ih=fi(xc|0,Fc|0,-683901,-1)|0;nh=D;rh=ii(Wc|0,qc|0,21)|0;sh=D;ah=ri(zc|0,Kc|0,ml|0,fl|0)|0;oh=D;lh=ni(ah|0,oh|0,zd|0,Kd|0)|0;dh=D;ch=ri(lh|0,dh|0,rh|0,sh|0)|0;hh=D;ph=oi(rh|0,sh|0,21)|0;gh=D;mh=ni(Wc|0,qc|0,ph|0,gh|0)|0;fh=D;Sh=ii(ch|0,hh|0,21)|0;vh=D;yh=ri(Jc|0,Yc|0,Ho|0,Bo|0)|0;Ch=D;Th=ni(yh|0,Ch|0,Fl|0,Ul|0)|0;Eh=D;bh=ri(Th|0,Eh|0,Wd|0,qd|0)|0;Ph=D;Ih=ri(bh|0,Ph|0,Sh|0,vh|0)|0;Ah=D;Rh=oi(Sh|0,vh|0,21)|0;wh=D;Mh=ni(ch|0,hh|0,Rh|0,wh|0)|0;Oh=D;Dh=ii(Ih|0,Ah|0,21)|0;kh=D;Lh=ri(Ll|0,xl|0,Qc|0,Xc|0)|0;xh=D;Fh=ni(Lh|0,xh|0,tc|0,ic|0)|0;Uh=D;Vh=ri(Fh|0,Uh|0,Dh|0,kh|0)|0;Hh=D;Bh=oi(Dh|0,kh|0,21)|0;$h=D;jh=ni(Ih|0,Ah|0,Bh|0,$h|0)|0;Gh=D;qh=ii(Vh|0,Hh|0,21)|0;zh=D;Kh=ri(Zc|0,eh|0,il|0,nl|0)|0;Jh=D;Yh=ni(Kh|0,Jh|0,nd|0,rd|0)|0;Qh=D;Xh=ri(Yh|0,Qh|0,Qd|0,Xd|0)|0;Zh=D;eu=ri(Xh|0,Zh|0,qh|0,zh|0)|0;tu=D;ru=oi(qh|0,zh|0,21)|0;su=D;au=ni(Vh|0,Hh|0,ru|0,su|0)|0;ou=D;lu=ii(eu|0,tu|0,21)|0;du=D;cu=ri(td|0,id|0,ih|0,nh|0)|0;hu=D;uu=ni(cu|0,hu|0,dc|0,cc|0)|0;pu=D;mu=ri(uu|0,pu|0,lu|0,du|0)|0;fu=D;Su=oi(lu|0,du|0,21)|0;vu=D;yu=ni(eu|0,tu|0,Su|0,vu|0)|0;Cu=D;Tu=ii(mu|0,fu|0,21)|0;Eu=D;_u=ri(oc|0,lc|0,Tu|0,Eu|0)|0;bu=D;Iu=oi(Tu|0,Eu|0,21)|0;Au=D;Ru=ni(mu|0,fu|0,Iu|0,Au|0)|0;wu=D;Mu=ii(_u|0,bu|0,21)|0;Ou=D;Du=ri(Mu|0,Ou|0,Cc|0,Tc|0)|0;ku=D;Nu=oi(Mu|0,Ou|0,21)|0;Lu=D;Fu=ni(_u|0,bu|0,Nu|0,Lu|0)|0;Uu=D;Vu=ii(Du|0,ku|0,21)|0;Hu=D;Bu=ri(fc|0,Sc|0,Vu|0,Hu|0)|0;$u=D;ju=oi(Vu|0,Hu|0,21)|0;Gu=D;Wu=ni(Du|0,ku|0,ju|0,Gu|0)|0;qu=D;Ku=ii(Bu|0,$u|0,21)|0;Ju=D;Yu=ri(Ku|0,Ju|0,Oc|0,Dc|0)|0;Qu=D;Xu=oi(Ku|0,Ju|0,21)|0;Zu=D;ep=ni(Bu|0,$u|0,Xu|0,Zu|0)|0;tp=D;ip=ii(Yu|0,Qu|0,21)|0;np=D;sp=ri(Ac|0,Rc|0,ip|0,np|0)|0;ap=D;op=oi(ip|0,np|0,21)|0;lp=D;dp=ni(Yu|0,Qu|0,op|0,lp|0)|0;cp=D;hp=ii(sp|0,ap|0,21)|0;up=D;pp=ri(hp|0,up|0,Hc|0,Bc|0)|0;gp=D;fp=oi(hp|0,up|0,21)|0;Sp=D;vp=ni(sp|0,ap|0,fp|0,Sp|0)|0;yp=D;Cp=ii(pp|0,gp|0,21)|0;Tp=D;Ep=oi(Cp|0,Tp|0,21)|0;_p=D;bp=ni(pp|0,gp|0,Ep|0,_p|0)|0;Pp=D;Ap=fi(Cp|0,Tp|0,666643,0)|0;Rp=D;wp=ri(Ap|0,Rp|0,mh|0,fh|0)|0;Mp=D;Op=fi(Cp|0,Tp|0,470296,0)|0;Dp=D;kp=ri(Mh|0,Oh|0,Op|0,Dp|0)|0;Np=D;Lp=fi(Cp|0,Tp|0,654183,0)|0;xp=D;Up=ri(jh|0,Gh|0,Lp|0,xp|0)|0;Vp=D;Hp=fi(Cp|0,Tp|0,-997805,-1)|0;Bp=D;$p=ri(au|0,ou|0,Hp|0,Bp|0)|0;jp=D;Gp=fi(Cp|0,Tp|0,136657,0)|0;Wp=D;qp=ri(yu|0,Cu|0,Gp|0,Wp|0)|0;zp=D;Jp=fi(Cp|0,Tp|0,-683901,-1)|0;Yp=D;Qp=ri(Ru|0,wu|0,Jp|0,Yp|0)|0;Xp=D;Zp=ii(wp|0,Mp|0,21)|0;eg=D;tg=ri(kp|0,Np|0,Zp|0,eg|0)|0;ig=D;ng=oi(Zp|0,eg|0,21)|0;rg=D;og=ni(wp|0,Mp|0,ng|0,rg|0)|0;lg=D;dg=ii(tg|0,ig|0,21)|0;cg=D;hg=ri(Up|0,Vp|0,dg|0,cg|0)|0;ug=D;pg=oi(dg|0,cg|0,21)|0;gg=D;mg=ni(tg|0,ig|0,pg|0,gg|0)|0;fg=D;vg=ii(hg|0,ug|0,21)|0;yg=D;Cg=ri($p|0,jp|0,vg|0,yg|0)|0;Tg=D;Eg=oi(vg|0,yg|0,21)|0;_g=D;bg=ni(hg|0,ug|0,Eg|0,_g|0)|0;Pg=D;Ig=ii(Cg|0,Tg|0,21)|0;Ag=D;wg=ri(qp|0,zp|0,Ig|0,Ag|0)|0;Mg=D;Og=oi(Ig|0,Ag|0,21)|0;Dg=D;kg=ni(Cg|0,Tg|0,Og|0,Dg|0)|0;Ng=D;Lg=ii(wg|0,Mg|0,21)|0;xg=D;Fg=ri(Qp|0,Xp|0,Lg|0,xg|0)|0;Ug=D;Hg=oi(Lg|0,xg|0,21)|0;Bg=D;$g=ni(wg|0,Mg|0,Hg|0,Bg|0)|0;jg=D;Gg=ii(Fg|0,Ug|0,21)|0;Wg=D;qg=ri(Gg|0,Wg|0,Fu|0,Uu|0)|0;zg=D;Kg=oi(Gg|0,Wg|0,21)|0;Jg=D;Qg=ni(Fg|0,Ug|0,Kg|0,Jg|0)|0;Xg=D;Zg=ii(qg|0,zg|0,21)|0;em=D;tm=ri(Zg|0,em|0,Wu|0,qu|0)|0;im=D;nm=oi(Zg|0,em|0,21)|0;rm=D;sm=ni(qg|0,zg|0,nm|0,rm|0)|0;am=D;lm=ii(tm|0,im|0,21)|0;dm=D;cm=ri(lm|0,dm|0,ep|0,tp|0)|0;hm=D;um=oi(lm|0,dm|0,21)|0;pm=D;gm=ni(tm|0,im|0,um|0,pm|0)|0;mm=D;fm=ii(cm|0,hm|0,21)|0;Sm=D;ym=ri(fm|0,Sm|0,dp|0,cp|0)|0;Cm=D;Tm=oi(fm|0,Sm|0,21)|0;Em=D;_m=ni(cm|0,hm|0,Tm|0,Em|0)|0;bm=D;Pm=ii(ym|0,Cm|0,21)|0;Im=D;Am=ri(Pm|0,Im|0,vp|0,yp|0)|0;Rm=D;Mm=oi(Pm|0,Im|0,21)|0;Om=D;Dm=ni(ym|0,Cm|0,Mm|0,Om|0)|0;km=D;Nm=ii(Am|0,Rm|0,21)|0;Lm=D;xm=ri(Nm|0,Lm|0,bp|0,Pp|0)|0;Fm=D;Um=oi(Nm|0,Lm|0,21)|0;Vm=D;Bm=ni(Am|0,Rm|0,Um|0,Vm|0)|0;$m=D;jm=og&255;n[e>>0]=jm;Gm=ai(og|0,lg|0,8)|0;Wm=D;qm=Gm&255;zm=e+1|0;n[zm>>0]=qm;Km=ai(og|0,lg|0,16)|0;Jm=D;Ym=oi(mg|0,fg|0,5)|0;Xm=D;Zm=Ym|Km;Xm|Jm;ef=Zm&255;n[jn>>0]=ef;tf=ai(mg|0,fg|0,3)|0;nf=D;rf=tf&255;sf=e+3|0;n[sf>>0]=rf;af=ai(mg|0,fg|0,11)|0;of=D;lf=af&255;hf=e+4|0;n[hf>>0]=lf;uf=ai(mg|0,fg|0,19)|0;pf=D;gf=oi(bg|0,Pg|0,2)|0;mf=D;ff=gf|uf;mf|pf;Sf=ff&255;n[df>>0]=Sf;vf=ai(bg|0,Pg|0,6)|0;yf=D;Cf=vf&255;Ef=e+6|0;n[Ef>>0]=Cf;_f=ai(bg|0,Pg|0,14)|0;bf=D;Pf=oi(kg|0,Ng|0,7)|0;If=D;Af=Pf|_f;If|bf;Rf=Af&255;n[Me>>0]=Rf;wf=ai(kg|0,Ng|0,1)|0;Mf=D;Of=wf&255;kf=e+8|0;n[kf>>0]=Of;Nf=ai(kg|0,Ng|0,9)|0;Lf=D;xf=Nf&255;Ff=e+9|0;n[Ff>>0]=xf;Uf=ai(kg|0,Ng|0,17)|0;Vf=D;Hf=oi($g|0,jg|0,4)|0;Bf=D;$f=Hf|Uf;Bf|Vf;Gf=$f&255;n[Wt>>0]=Gf;Wf=ai($g|0,jg|0,4)|0;qf=D;zf=Wf&255;Kf=e+11|0;n[Kf>>0]=zf;Jf=ai($g|0,jg|0,12)|0;Yf=D;Qf=Jf&255;Xf=e+12|0;n[Xf>>0]=Qf;Zf=ai($g|0,jg|0,20)|0;tS=D;iS=oi(Qg|0,Xg|0,1)|0;nS=D;rS=iS|Zf;nS|tS;sS=rS&255;n[cn>>0]=sS;aS=ai(Qg|0,Xg|0,7)|0;oS=D;lS=aS&255;dS=e+14|0;n[dS>>0]=lS;cS=ai(Qg|0,Xg|0,15)|0;uS=D;pS=oi(sm|0,am|0,6)|0;gS=D;mS=pS|cS;gS|uS;fS=mS&255;n[_r>>0]=fS;SS=ai(sm|0,am|0,2)|0;vS=D;yS=SS&255;CS=e+16|0;n[CS>>0]=yS;TS=ai(sm|0,am|0,10)|0;_S=D;bS=TS&255;PS=e+17|0;n[PS>>0]=bS;IS=ai(sm|0,am|0,18)|0;AS=D;RS=oi(gm|0,mm|0,3)|0;wS=D;MS=RS|IS;wS|AS;OS=MS&255;n[Ls>>0]=OS;DS=ai(gm|0,mm|0,5)|0;NS=D;LS=DS&255;xS=e+19|0;n[xS>>0]=LS;FS=ai(gm|0,mm|0,13)|0;US=D;VS=FS&255;HS=e+20|0;n[HS>>0]=VS;BS=_m&255;n[Ka>>0]=BS;$S=ai(_m|0,bm|0,8)|0;jS=D;WS=$S&255;qS=e+22|0;n[qS>>0]=WS;zS=ai(_m|0,bm|0,16)|0;KS=D;JS=oi(Dm|0,km|0,5)|0;YS=D;QS=JS|zS;YS|KS;XS=QS&255;n[Vo>>0]=XS;ZS=ai(Dm|0,km|0,3)|0;ev=D;iv=ZS&255;nv=e+24|0;n[nv>>0]=iv;rv=ai(Dm|0,km|0,11)|0;sv=D;av=rv&255;ov=e+25|0;n[ov>>0]=av;lv=ai(Dm|0,km|0,19)|0;dv=D;cv=oi(Bm|0,$m|0,2)|0;hv=D;a=cv|lv;hv|dv;o=a&255;n[Xl>>0]=o;l=ai(Bm|0,$m|0,6)|0;d=D;c=l&255;u=e+27|0;n[u>>0]=c;p=ai(Bm|0,$m|0,14)|0;g=D;m=oi(xm|0,Fm|0,7)|0;f=D;v=p|m;g|f;y=v&255;n[hc>>0]=y;C=ai(xm|0,Fm|0,1)|0;T=D;E=C&255;_=e+29|0;n[_>>0]=E;b=ai(xm|0,Fm|0,9)|0;P=D;I=b&255;A=e+30|0;n[A>>0]=I;w=ai(xm|0,Fm|0,17)|0;M=D;O=w&255;n[_h>>0]=O;h=pv;return}function $t(e){e=e|0;var t=0,i=0,r=0,s=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0;y=h;t=n[e>>0]|0;i=t&255;d=e+1|0;c=n[d>>0]|0;u=c&255;p=oi(u|0,0,8)|0;g=D;m=p|i;f=e+2|0;S=n[f>>0]|0;r=S&255;s=oi(r|0,0,16)|0;a=D;o=m|s;l=g|a;D=l;h=y;return o|0}function jt(e){e=e|0;var t=0,i=0,r=0,s=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0;var _=0,b=0,P=0,I=0;I=h;t=n[e>>0]|0;i=t&255;m=e+1|0;v=n[m>>0]|0;y=v&255;C=oi(y|0,0,8)|0;T=D;E=C|i;_=e+2|0;b=n[_>>0]|0;r=b&255;s=oi(r|0,0,16)|0;a=D;o=E|s;l=T|a;d=e+3|0;c=n[d>>0]|0;u=c&255;p=oi(u|0,0,24)|0;g=D;f=o|p;S=l|g;D=S;h=I;return f|0}function Gt(e){e=e|0;var t=0,i=0,n=0,r=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0;c=h;t=e+128|0;l=t+0|0;u=31840+0|0;p=l+64|0;do{s[l>>2]=s[u>>2]|0;l=l+4|0;u=u+4|0}while((l|0)<(p|0));i=e+192|0;n=i;r=n;s[r>>2]=0;a=n+4|0;o=a;s[o>>2]=0;h=c;return}function Wt(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,r=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0,b=0;var P=0,I=0,A=0,R=0,w=0,M=0,O=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0;$=h;o=e+192|0;l=(i|0)==0;if(l){h=$;return}C=o;O=C;k=s[O>>2]|0;N=C+4|0;L=N;x=s[L>>2]|0;F=k&127;U=e+128|0;r=i;a=t;V=F;while(1){d=128-V|0;c=d>>>0>r>>>0;n=c?r:d;u=e+V|0;di(u|0,a|0,n|0)|0;p=a+n|0;g=n+V|0;m=r-n|0;f=(g|0)==128;if(f){zt(e,U);H=0}else{H=g}S=o;v=S;y=s[v>>2]|0;T=S+4|0;E=T;_=s[E>>2]|0;b=ri(y|0,_|0,n|0,0)|0;P=D;I=o;A=I;s[A>>2]=b;R=I+4|0;w=R;s[w>>2]=P;M=(r|0)==(n|0);if(M){break}else{r=m;a=p;V=H}}h=$;return}function qt(e,t){e=e|0;t=t|0;var i=0,n=0;n=h;Kt(e,t,8);Gt(e);h=n;return}function zt(e,t){e=e|0;t=t|0;var i=0,n=0,r=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0;var b=0,P=0,I=0,A=0,R=0,w=0,M=0,O=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0,j=0,G=0;var W=0,q=0,z=0,K=0,J=0,Y=0,Q=0,X=0,Z=0,ee=0,te=0,ie=0,ne=0,re=0,se=0,ae=0,oe=0,le=0,de=0,ce=0;var he=0,ue=0,pe=0,ge=0,me=0,fe=0,Se=0,ve=0,ye=0,Ce=0,Te=0,Ee=0,_e=0,be=0,Pe=0,Ie=0,Ae=0,Re=0,we=0,Me=0;var Oe=0,De=0,ke=0,Ne=0,Le=0,xe=0,Fe=0,Ue=0,Ve=0,He=0,Be=0,$e=0,je=0,Ge=0,We=0,qe=0,ze=0,Ke=0,Je=0,Ye=0;var Qe=0,Xe=0,Ze=0,et=0,tt=0,it=0,nt=0,rt=0,st=0,at=0,ot=0,lt=0,dt=0,ct=0,ht=0,ut=0,pt=0,gt=0,mt=0,ft=0;var St=0,vt=0,yt=0,Ct=0,Tt=0,Et=0,_t=0,bt=0,Pt=0,It=0,At=0,Rt=0,wt=0,Mt=0,Ot=0,Dt=0,kt=0,Nt=0,Lt=0,xt=0;var Ft=0,Ut=0,Vt=0,Ht=0,Bt=0,$t=0,jt=0,Gt=0,Wt=0,qt=0,zt=0,Kt=0,Jt=0,Qt=0,Xt=0,Zt=0,ei=0,ti=0,ii=0,ni=0;var si=0,li=0,di=0,ci=0,hi=0,ui=0,pi=0,gi=0,mi=0,fi=0,Si=0,vi=0,yi=0,Ci=0,Ti=0,Ei=0,_i=0,bi=0,Pi=0,Ii=0;var Ai=0,Ri=0,wi=0,Mi=0,Oi=0,Di=0,ki=0,Ni=0,Li=0,xi=0,Fi=0,Ui=0,Vi=0,Hi=0,Bi=0,$i=0,ji=0,Gi=0,Wi=0,qi=0;var zi=0,Ki=0,Ji=0,Yi=0,Qi=0,Xi=0,Zi=0,en=0,tn=0,nn=0,rn=0,sn=0,an=0,on=0,ln=0,dn=0,cn=0,hn=0,un=0,pn=0;var gn=0,mn=0,fn=0,Sn=0,vn=0,yn=0,Cn=0,Tn=0,En=0,_n=0,bn=0,Pn=0,In=0,An=0,Rn=0,wn=0,Mn=0,On=0,Dn=0,kn=0;var Nn=0,Ln=0,xn=0,Fn=0,Un=0,Vn=0,Hn=0,Bn=0,$n=0,jn=0,Gn=0,Wn=0,qn=0,zn=0,Kn=0,Jn=0,Yn=0,Qn=0,Xn=0,Zn=0;var er=0,tr=0,ir=0,nr=0,rr=0,sr=0,ar=0,or=0,lr=0,dr=0,cr=0,hr=0,ur=0,pr=0,gr=0,mr=0,fr=0,Sr=0,vr=0,yr=0;var Cr=0,Tr=0,Er=0,_r=0,br=0,Pr=0,Ir=0,Ar=0,Rr=0,wr=0,Mr=0,Or=0,Dr=0,kr=0,Nr=0,Lr=0,xr=0,Fr=0,Ur=0,Vr=0;var Hr=0,Br=0,$r=0,jr=0,Gr=0,Wr=0,qr=0,zr=0,Kr=0,Jr=0,Yr=0,Qr=0,Xr=0,Zr=0,es=0,ts=0,is=0,ns=0,rs=0,ss=0;var as=0,os=0,ls=0,ds=0,cs=0,hs=0,us=0,ps=0,gs=0,ms=0,fs=0,Ss=0,vs=0,ys=0,Cs=0,Ts=0,Es=0,_s=0,bs=0,Ps=0;var Is=0,As=0,Rs=0,ws=0,Ms=0,Os=0,Ds=0,ks=0,Ns=0,Ls=0,xs=0,Fs=0,Us=0,Vs=0,Hs=0,Bs=0,$s=0,js=0,Gs=0,Ws=0;var qs=0,zs=0,Ks=0,Js=0,Ys=0,Qs=0,Xs=0,Zs=0,ea=0,ta=0,ia=0,na=0,ra=0,sa=0,aa=0,oa=0,la=0,da=0,ca=0,ha=0;var ua=0,pa=0,ga=0,ma=0,fa=0,Sa=0,va=0,ya=0,Ca=0,Ta=0,Ea=0,_a=0,ba=0,Pa=0,Ia=0,Aa=0,Ra=0,wa=0,Ma=0,Oa=0;var Da=0,ka=0,Na=0,La=0,xa=0,Fa=0,Ua=0,Va=0,Ha=0,Ba=0,$a=0,ja=0,Ga=0,Wa=0,qa=0,za=0,Ka=0,Ja=0,Ya=0,Qa=0;var Xa=0,Za=0,eo=0,to=0,io=0,no=0,ro=0,so=0,ao=0,oo=0,lo=0,co=0,ho=0,uo=0,po=0,go=0,mo=0,fo=0,So=0,vo=0;var yo=0,Co=0,To=0,Eo=0,_o=0,bo=0,Po=0,Io=0,Ao=0,Ro=0,wo=0,Mo=0,Oo=0,Do=0,ko=0,No=0,Lo=0,xo=0,Fo=0,Uo=0;var Vo=0,Ho=0,Bo=0,$o=0,jo=0,Go=0,Wo=0,qo=0,zo=0,Ko=0,Jo=0,Yo=0,Qo=0,Xo=0,Zo=0,el=0,tl=0,il=0,nl=0,rl=0;var sl=0,al=0,ol=0,ll=0,dl=0,cl=0,hl=0,ul=0,pl=0,gl=0,ml=0,fl=0,Sl=0,vl=0,yl=0,Cl=0,Tl=0,El=0,_l=0,bl=0;var Pl=0,Il=0,Al=0,Rl=0,wl=0,Ml=0,Ol=0,Dl=0,kl=0,Nl=0,Ll=0,xl=0,Fl=0,Ul=0,Vl=0,Hl=0,Bl=0,$l=0,jl=0,Gl=0;var Wl=0,ql=0,zl=0,Kl=0,Jl=0,Yl=0,Ql=0,Xl=0,Zl=0,ed=0,td=0,id=0,nd=0,rd=0,sd=0,ad=0,od=0,ld=0,dd=0,cd=0;var hd=0,ud=0,pd=0,gd=0,md=0,fd=0,Sd=0,vd=0,yd=0,Cd=0,Td=0,Ed=0,_d=0,bd=0,Pd=0,Id=0,Ad=0,Rd=0,wd=0,Md=0;var Od=0,Dd=0,kd=0,Nd=0,Ld=0,xd=0,Fd=0,Ud=0,Vd=0,Hd=0,Bd=0,$d=0,jd=0,Gd=0,Wd=0,qd=0,zd=0,Kd=0,Jd=0,Yd=0;var Qd=0,Xd=0,Zd=0,ec=0,tc=0,ic=0,nc=0,rc=0,sc=0,ac=0,oc=0,lc=0,dc=0,cc=0,hc=0,uc=0,pc=0,gc=0,mc=0,fc=0;var Sc=0,vc=0,yc=0,Cc=0,Tc=0,Ec=0,_c=0,bc=0,Pc=0,Ic=0,Ac=0,Rc=0,wc=0,Mc=0,Oc=0,Dc=0,kc=0,Nc=0,Lc=0,xc=0;var Fc=0,Uc=0,Vc=0,Hc=0,Bc=0,$c=0,jc=0,Gc=0,Wc=0,qc=0,zc=0,Kc=0,Jc=0,Yc=0,Qc=0,Xc=0,Zc=0,eh=0,th=0,ih=0;var nh=0,rh=0,sh=0,ah=0,oh=0,lh=0,dh=0,ch=0,hh=0,uh=0,ph=0,gh=0,mh=0,fh=0,Sh=0,vh=0,yh=0,Ch=0,Th=0,Eh=0;var _h=0,bh=0,Ph=0,Ih=0,Ah=0,Rh=0,wh=0,Mh=0,Oh=0,Dh=0,kh=0,Nh=0,Lh=0,xh=0,Fh=0,Uh=0,Vh=0,Hh=0,Bh=0,$h=0;var jh=0,Gh=0,Wh=0,qh=0,zh=0,Kh=0,Jh=0,Yh=0,Qh=0,Xh=0,Zh=0,eu=0,tu=0,iu=0,nu=0,ru=0,su=0,au=0,ou=0,lu=0;var du=0,cu=0,hu=0,uu=0,pu=0,gu=0,mu=0,fu=0,Su=0,vu=0,yu=0,Cu=0,Tu=0,Eu=0,_u=0,bu=0,Pu=0,Iu=0,Au=0,Ru=0;var wu=0,Mu=0,Ou=0,Du=0,ku=0,Nu=0,Lu=0,xu=0,Fu=0,Uu=0,Vu=0,Hu=0,Bu=0,$u=0,ju=0,Gu=0,Wu=0,qu=0,zu=0,Ku=0;var Ju=0,Yu=0,Qu=0,Xu=0,Zu=0,ep=0,tp=0,ip=0,np=0,rp=0,sp=0,ap=0,op=0,lp=0,dp=0,cp=0,hp=0,up=0,pp=0,gp=0;var mp=0,fp=0,Sp=0,vp=0,yp=0,Cp=0,Tp=0,Ep=0,_p=0,bp=0,Pp=0,Ip=0,Ap=0,Rp=0,wp=0,Mp=0,Op=0,Dp=0,kp=0,Np=0;var Lp=0,xp=0,Fp=0,Up=0,Vp=0,Hp=0,Bp=0,$p=0,jp=0,Gp=0,Wp=0,qp=0,zp=0,Kp=0,Jp=0,Yp=0,Qp=0,Xp=0,Zp=0,eg=0;var tg=0,ig=0,ng=0,rg=0,sg=0,ag=0,og=0,lg=0,dg=0,cg=0,hg=0,ug=0,pg=0,gg=0,mg=0,fg=0,Sg=0,vg=0,yg=0,Cg=0;var Tg=0,Eg=0,_g=0,bg=0,Pg=0,Ig=0,Ag=0,Rg=0,wg=0,Mg=0,Og=0,Dg=0,kg=0,Ng=0,Lg=0,xg=0,Fg=0,Ug=0,Vg=0,Hg=0;var Bg=0,$g=0,jg=0,Gg=0,Wg=0,qg=0,zg=0,Kg=0,Jg=0,Yg=0,Qg=0,Xg=0,Zg=0,em=0,tm=0,im=0,nm=0,rm=0,sm=0,am=0;var om=0,lm=0,dm=0,cm=0,hm=0,um=0,pm=0,gm=0,mm=0,fm=0,Sm=0,vm=0,ym=0,Cm=0,Tm=0,Em=0,_m=0,bm=0,Pm=0,Im=0;var Am=0,Rm=0,wm=0,Mm=0,Om=0,Dm=0,km=0,Nm=0,Lm=0,xm=0,Fm=0,Um=0,Vm=0,Hm=0,Bm=0,$m=0,jm=0,Gm=0,Wm=0,qm=0;var zm=0,Km=0,Jm=0,Ym=0,Qm=0,Xm=0,Zm=0,ef=0,tf=0,nf=0,rf=0,sf=0,af=0,of=0,lf=0,df=0,cf=0,hf=0,uf=0,pf=0;var gf=0,mf=0,ff=0,Sf=0,vf=0,yf=0,Cf=0,Tf=0,Ef=0,_f=0,bf=0,Pf=0,If=0,Af=0,Rf=0,wf=0,Mf=0,Of=0,Df=0,kf=0;var Nf=0,Lf=0,xf=0,Ff=0,Uf=0,Vf=0,Hf=0,Bf=0,$f=0,jf=0,Gf=0,Wf=0,qf=0,zf=0,Kf=0,Jf=0,Yf=0,Qf=0,Xf=0,Zf=0;var eS=0,tS=0;tS=h;h=h+640|0;Kf=tS;Qf=0;while(1){i=Qf<<3;n=e+i|0;dt=Yt(n)|0;Sn=D;Cs=Kf+(Qf<<3)|0;bo=Cs;Ad=bo;s[Ad>>2]=dt;Mh=bo+4|0;kp=Mh;s[kp>>2]=Sn;xm=Qf+1|0;Yf=(xm|0)==16;if(Yf){Xf=16;break}else{Qf=xm}}while(1){r=Xf+-2|0;S=Kf+(r<<3)|0;R=S;H=R;Q=s[H>>2]|0;le=R+4|0;ye=le;Me=s[ye>>2]|0;Be=oi(Q|0,Me|0,45)|0;Xe=D;ct=ai(Q|0,Me|0,19)|0;Tt=D;Dt=Be|ct;jt=Xe|Tt;ti=oi(Q|0,Me|0,3)|0;mi=D;Ii=ai(Q|0,Me|0,61)|0;Fi=D;Ki=ti|Ii;an=mi|Fi;vn=ai(Q|0,Me|0,6)|0;wn=D;Hn=Ki^vn;Qn=an^wn;lr=Hn^Dt;yr=Qn^jt;Mr=Xf+-7|0;Br=Kf+(Mr<<3)|0;Xr=Br;ds=Xr;Ts=s[ds>>2]|0;Ds=Xr+4|0;js=Ds;ea=s[js>>2]|0;ha=Xf+-15|0;Ea=Kf+(ha<<3)|0;ka=Ea;Ga=ka;to=s[Ga>>2]|0;po=ka+4|0;Po=po;xo=s[Po>>2]|0;zo=oi(to|0,xo|0,63)|0;rl=D;ml=ai(to|0,xo|0,1)|0;Il=D;Fl=zo|ml;Kl=rl|Il;sd=oi(to|0,xo|0,56)|0;fd=D;Rd=ai(to|0,xo|0,8)|0;Vd=D;Yd=sd|Rd;oc=fd|Vd;vc=ai(to|0,xo|0,7)|0;wc=D;Hc=Yd^vc;Qc=oc^wc;lh=Hc^Fl;yh=Qc^Kl;Oh=Xf+-16|0;$h=Kf+(Oh<<3)|0;Zh=$h;cu=Zh;Tu=s[cu>>2]|0;Du=Zh+4|0;ju=Du;ep=s[ju>>2]|0;hp=ri(Tu|0,ep|0,Ts|0,ea|0)|0;Ep=D;Np=ri(hp|0,Ep|0,lr|0,yr|0)|0;Wp=D;ig=ri(Np|0,Wp|0,lh|0,yh|0)|0;pg=D;bg=Kf+(Xf<<3)|0;Lg=bg;qg=Lg;s[qg>>2]=ig;nm=Lg+4|0;gm=nm;s[gm>>2]=pg;Pm=Xf+1|0;Jf=(Pm|0)==80;if(Jf){break}else{Xf=Pm}}Fm=t;Km=Fm;af=s[Km>>2]|0;Sf=Fm+4|0;Rf=Sf;Vf=s[Rf>>2]|0;Gf=t+8|0;Wf=Gf;qf=Wf;zf=s[qf>>2]|0;a=Wf+4|0;o=a;l=s[o>>2]|0;d=t+16|0;c=d;u=c;p=s[u>>2]|0;g=c+4|0;m=g;f=s[m>>2]|0;v=t+24|0;y=v;C=y;T=s[C>>2]|0;E=y+4|0;_=E;b=s[_>>2]|0;P=t+32|0;I=P;A=I;w=s[A>>2]|0;M=I+4|0;O=M;k=s[O>>2]|0;N=t+40|0;L=N;x=L;F=s[x>>2]|0;U=L+4|0;V=U;B=s[V>>2]|0;$=t+48|0;j=$;G=j;W=s[G>>2]|0;q=j+4|0;z=q;K=s[z>>2]|0;J=t+56|0;Y=J;X=Y;Z=s[X>>2]|0;ee=Y+4|0;te=ee;ie=s[te>>2]|0;ne=w;re=k;Oe=W;De=F;Ne=K;Le=B;it=Z;nt=ie;gt=af;mt=Vf;Bt=zf;Gt=l;Kt=p;Qt=f;ni=T;si=b;Zf=0;while(1){se=oi(ne|0,re|0,50)|0;ae=D;oe=ai(ne|0,re|0,14)|0;de=D;ce=se|oe;he=ae|de;ue=oi(ne|0,re|0,46)|0;pe=D;ge=ai(ne|0,re|0,18)|0;me=D;fe=ue|ge;Se=pe|me;ve=ce^fe;Ce=he^Se;Te=oi(ne|0,re|0,23)|0;Ee=D;_e=ai(ne|0,re|0,41)|0;be=D;Pe=Te|_e;Ie=Ee|be;Ae=ve^Pe;Re=Ce^Ie;we=De^Oe;ke=Le^Ne;xe=we&ne;Fe=ke&re;Ue=xe^Oe;Ve=Fe^Ne;He=31904+(Zf<<3)|0;$e=He;je=$e;Ge=s[je>>2]|0;We=$e+4|0;qe=We;ze=s[qe>>2]|0;Ke=Kf+(Zf<<3)|0;Je=Ke;Ye=Je;Qe=s[Ye>>2]|0;Ze=Je+4|0;et=Ze;tt=s[et>>2]|0;rt=ri(Ue|0,Ve|0,it|0,nt|0)|0;st=D;at=ri(rt|0,st|0,Ae|0,Re|0)|0;ot=D;lt=ri(at|0,ot|0,Ge|0,ze|0)|0;ht=D;ut=ri(lt|0,ht|0,Qe|0,tt|0)|0;pt=D;ft=oi(gt|0,mt|0,36)|0;St=D;vt=ai(gt|0,mt|0,28)|0;yt=D;Ct=ft|vt;Et=St|yt;_t=oi(gt|0,mt|0,30)|0;bt=D;Pt=ai(gt|0,mt|0,34)|0;It=D;At=_t|Pt;Rt=bt|It;wt=Ct^At;Mt=Et^Rt;Ot=oi(gt|0,mt|0,25)|0;kt=D;Nt=ai(gt|0,mt|0,39)|0;Lt=D;xt=Ot|Nt;Ft=kt|Lt;Ut=wt^xt;Vt=Mt^Ft;Ht=gt&Bt;$t=mt&Gt;Wt=gt|Bt;qt=mt|Gt;zt=Wt&Kt;Jt=qt&Qt;Xt=zt|Ht;Zt=Jt|$t;ei=ri(Ut|0,Vt|0,Xt|0,Zt|0)|0;ii=D;li=ri(ut|0,pt|0,ni|0,si|0)|0;di=D;ci=ri(ei|0,ii|0,ut|0,pt|0)|0;hi=D;ui=oi(li|0,di|0,50)|0;pi=D;gi=ai(li|0,di|0,14)|0;fi=D;Si=ui|gi;vi=pi|fi;yi=oi(li|0,di|0,46)|0;Ci=D;Ti=ai(li|0,di|0,18)|0;Ei=D;_i=yi|Ti;bi=Ci|Ei;Pi=Si^_i;Ai=vi^bi;Ri=oi(li|0,di|0,23)|0;wi=D;Mi=ai(li|0,di|0,41)|0;Oi=D;Di=Ri|Mi;ki=wi|Oi;Ni=Pi^Di;Li=Ai^ki;xi=ne^De;Ui=re^Le;Vi=li&xi;Hi=di&Ui;Bi=Vi^De;$i=Hi^Le;ji=Zf|1;Gi=31904+(ji<<3)|0;Wi=Gi;qi=Wi;zi=s[qi>>2]|0;Ji=Wi+4|0;Yi=Ji;Qi=s[Yi>>2]|0;Xi=Kf+(ji<<3)|0;Zi=Xi;en=Zi;tn=s[en>>2]|0;nn=Zi+4|0;rn=nn;sn=s[rn>>2]|0;on=ri(zi|0,Qi|0,Oe|0,Ne|0)|0;ln=D;dn=ri(on|0,ln|0,tn|0,sn|0)|0;cn=D;hn=ri(dn|0,cn|0,Bi|0,$i|0)|0;un=D;pn=ri(hn|0,un|0,Ni|0,Li|0)|0;gn=D;mn=oi(ci|0,hi|0,36)|0;fn=D;yn=ai(ci|0,hi|0,28)|0;Cn=D;Tn=mn|yn;En=fn|Cn;_n=oi(ci|0,hi|0,30)|0;bn=D;Pn=ai(ci|0,hi|0,34)|0;In=D;An=_n|Pn;Rn=bn|In;Mn=Tn^An;On=En^Rn;Dn=oi(ci|0,hi|0,25)|0;kn=D;Nn=ai(ci|0,hi|0,39)|0;Ln=D;xn=Dn|Nn;Fn=kn|Ln;Un=Mn^xn;Vn=On^Fn;Bn=ci&gt;$n=hi&mt;jn=ci|gt;Gn=hi|mt;Wn=jn&Bt;qn=Gn&Gt;zn=Wn|Bn;Kn=qn|$n;Jn=ri(Un|0,Vn|0,zn|0,Kn|0)|0;Yn=D;Xn=ri(pn|0,gn|0,Kt|0,Qt|0)|0;Zn=D;er=ri(Jn|0,Yn|0,pn|0,gn|0)|0;tr=D;ir=oi(Xn|0,Zn|0,50)|0;nr=D;rr=ai(Xn|0,Zn|0,14)|0;sr=D;ar=ir|rr;or=nr|sr;dr=oi(Xn|0,Zn|0,46)|0;cr=D;hr=ai(Xn|0,Zn|0,18)|0;ur=D;pr=dr|hr;gr=cr|ur;mr=ar^pr;fr=or^gr;Sr=oi(Xn|0,Zn|0,23)|0;vr=D;Cr=ai(Xn|0,Zn|0,41)|0;Tr=D;Er=Sr|Cr;_r=vr|Tr;br=mr^Er;Pr=fr^_r;Ir=li^ne;Ar=di^re;Rr=Xn&Ir;wr=Zn&Ar;Or=Rr^ne;Dr=wr^re;kr=Zf|2;Nr=31904+(kr<<3)|0;Lr=Nr;xr=Lr;Fr=s[xr>>2]|0;Ur=Lr+4|0;Vr=Ur;Hr=s[Vr>>2]|0;$r=Kf+(kr<<3)|0;jr=$r;Gr=jr;Wr=s[Gr>>2]|0;qr=jr+4|0;zr=qr;Kr=s[zr>>2]|0;Jr=ri(Fr|0,Hr|0,De|0,Le|0)|0;Yr=D;Qr=ri(Jr|0,Yr|0,Wr|0,Kr|0)|0;Zr=D;es=ri(Qr|0,Zr|0,Or|0,Dr|0)|0;ts=D;is=ri(es|0,ts|0,br|0,Pr|0)|0;ns=D;rs=oi(er|0,tr|0,36)|0;ss=D;as=ai(er|0,tr|0,28)|0;os=D;ls=rs|as;cs=ss|os;hs=oi(er|0,tr|0,30)|0;us=D;ps=ai(er|0,tr|0,34)|0;gs=D;ms=hs|ps;fs=us|gs;Ss=ls^ms;vs=cs^fs;ys=oi(er|0,tr|0,25)|0;Es=D;_s=ai(er|0,tr|0,39)|0;bs=D;Ps=ys|_s;Is=Es|bs;As=Ss^Ps;Rs=vs^Is;ws=er&ci;Ms=tr&hi;Os=er|ci;ks=tr|hi;Ns=Os&gt;Ls=ks&mt;xs=Ns|ws;Fs=Ls|Ms;Us=ri(As|0,Rs|0,xs|0,Fs|0)|0;Vs=D;Hs=ri(is|0,ns|0,Bt|0,Gt|0)|0;Bs=D;$s=ri(Us|0,Vs|0,is|0,ns|0)|0;Gs=D;Ws=oi(Hs|0,Bs|0,50)|0;qs=D;zs=ai(Hs|0,Bs|0,14)|0;Ks=D;Js=Ws|zs;Ys=qs|Ks;Qs=oi(Hs|0,Bs|0,46)|0;Xs=D;Zs=ai(Hs|0,Bs|0,18)|0;ta=D;ia=Qs|Zs;na=Xs|ta;ra=Js^ia;sa=Ys^na;aa=oi(Hs|0,Bs|0,23)|0;oa=D;la=ai(Hs|0,Bs|0,41)|0;da=D;ca=aa|la;ua=oa|da;pa=ra^ca;ga=sa^ua;ma=Xn^li;fa=Zn^di;Sa=Hs&ma;va=Bs&fa;ya=Sa^li;Ca=va^di;Ta=Zf|3;_a=31904+(Ta<<3)|0;ba=_a;Pa=ba;Ia=s[Pa>>2]|0;Aa=ba+4|0;Ra=Aa;wa=s[Ra>>2]|0;Ma=Kf+(Ta<<3)|0;Oa=Ma;Da=Oa;Na=s[Da>>2]|0;La=Oa+4|0;xa=La;Fa=s[xa>>2]|0;Ua=ri(Ia|0,wa|0,ne|0,re|0)|0;Va=D;Ha=ri(Ua|0,Va|0,Na|0,Fa|0)|0;Ba=D;$a=ri(Ha|0,Ba|0,ya|0,Ca|0)|0;ja=D;Wa=ri($a|0,ja|0,pa|0,ga|0)|0;qa=D;za=oi($s|0,Gs|0,36)|0;Ka=D;Ja=ai($s|0,Gs|0,28)|0;Ya=D;Qa=za|Ja;Xa=Ka|Ya;Za=oi($s|0,Gs|0,30)|0;eo=D;io=ai($s|0,Gs|0,34)|0;no=D;ro=Za|io;so=eo|no;ao=Qa^ro;oo=Xa^so;lo=oi($s|0,Gs|0,25)|0;co=D;ho=ai($s|0,Gs|0,39)|0;uo=D;go=lo|ho;mo=co|uo;fo=ao^go;So=oo^mo;vo=$s&er;yo=Gs&tr;Co=$s|er;To=Gs|tr;Eo=Co&ci;_o=To&hi;Io=Eo|vo;Ao=_o|yo;Ro=ri(fo|0,So|0,Io|0,Ao|0)|0;wo=D;Mo=ri(Wa|0,qa|0,gt|0,mt|0)|0;Oo=D;Do=ri(Ro|0,wo|0,Wa|0,qa|0)|0;ko=D;No=oi(Mo|0,Oo|0,50)|0;Lo=D;Fo=ai(Mo|0,Oo|0,14)|0;Uo=D;Vo=No|Fo;Ho=Lo|Uo;Bo=oi(Mo|0,Oo|0,46)|0;$o=D;jo=ai(Mo|0,Oo|0,18)|0;Go=D;Wo=Bo|jo;qo=$o|Go;Ko=Vo^Wo;Jo=Ho^qo;Yo=oi(Mo|0,Oo|0,23)|0;Qo=D;Xo=ai(Mo|0,Oo|0,41)|0;Zo=D;el=Yo|Xo;tl=Qo|Zo;il=Ko^el;nl=Jo^tl;sl=Hs^Xn;al=Bs^Zn;ol=Mo&sl;ll=Oo&al;dl=ol^Xn;cl=ll^Zn;hl=Zf|4;ul=31904+(hl<<3)|0;pl=ul;gl=pl;fl=s[gl>>2]|0;Sl=pl+4|0;vl=Sl;yl=s[vl>>2]|0;Cl=Kf+(hl<<3)|0;Tl=Cl;El=Tl;_l=s[El>>2]|0;bl=Tl+4|0;Pl=bl;Al=s[Pl>>2]|0;Rl=ri(fl|0,yl|0,li|0,di|0)|0;wl=D;Ml=ri(Rl|0,wl|0,_l|0,Al|0)|0;Ol=D;Dl=ri(Ml|0,Ol|0,dl|0,cl|0)|0;kl=D;Nl=ri(Dl|0,kl|0,il|0,nl|0)|0;Ll=D;xl=oi(Do|0,ko|0,36)|0;Ul=D;Vl=ai(Do|0,ko|0,28)|0;Hl=D;Bl=xl|Vl;$l=Ul|Hl;jl=oi(Do|0,ko|0,30)|0;Gl=D;Wl=ai(Do|0,ko|0,34)|0;ql=D;zl=jl|Wl;Jl=Gl|ql;Yl=Bl^zl;Ql=$l^Jl;Xl=oi(Do|0,ko|0,25)|0;Zl=D;ed=ai(Do|0,ko|0,39)|0;td=D;id=Xl|ed;nd=Zl|td;rd=Yl^id;ad=Ql^nd;od=Do&$s;ld=ko&Gs;dd=Do|$s;cd=ko|Gs;hd=dd&er;ud=cd&tr;pd=hd|od;gd=ud|ld;md=ri(rd|0,ad|0,pd|0,gd|0)|0;Sd=D;vd=ri(Nl|0,Ll|0,ci|0,hi|0)|0;yd=D;Cd=ri(md|0,Sd|0,Nl|0,Ll|0)|0;Td=D;Ed=oi(vd|0,yd|0,50)|0;_d=D;bd=ai(vd|0,yd|0,14)|0;Pd=D;Id=Ed|bd;wd=_d|Pd;Md=oi(vd|0,yd|0,46)|0;Od=D;Dd=ai(vd|0,yd|0,18)|0;kd=D;Nd=Md|Dd;Ld=Od|kd;xd=Id^Nd;Fd=wd^Ld;Ud=oi(vd|0,yd|0,23)|0;Hd=D;Bd=ai(vd|0,yd|0,41)|0;$d=D;jd=Ud|Bd;Gd=Hd|$d;Wd=xd^jd;qd=Fd^Gd;zd=Mo^Hs;Kd=Oo^Bs;Jd=vd&zd;Qd=yd&Kd;Xd=Jd^Hs;Zd=Qd^Bs;ec=Zf|5;tc=31904+(ec<<3)|0;ic=tc;nc=ic;rc=s[nc>>2]|0;sc=ic+4|0;ac=sc;lc=s[ac>>2]|0;dc=Kf+(ec<<3)|0;cc=dc;hc=cc;uc=s[hc>>2]|0;pc=cc+4|0;gc=pc;mc=s[gc>>2]|0;fc=ri(rc|0,lc|0,Xn|0,Zn|0)|0;Sc=D;yc=ri(fc|0,Sc|0,uc|0,mc|0)|0;Cc=D;Tc=ri(yc|0,Cc|0,Xd|0,Zd|0)|0;Ec=D;_c=ri(Tc|0,Ec|0,Wd|0,qd|0)|0;bc=D;Pc=oi(Cd|0,Td|0,36)|0;Ic=D;Ac=ai(Cd|0,Td|0,28)|0;Rc=D;Mc=Pc|Ac;Oc=Ic|Rc;Dc=oi(Cd|0,Td|0,30)|0;kc=D;Nc=ai(Cd|0,Td|0,34)|0;Lc=D;xc=Dc|Nc;Fc=kc|Lc;Uc=Mc^xc;Vc=Oc^Fc;Bc=oi(Cd|0,Td|0,25)|0;$c=D;jc=ai(Cd|0,Td|0,39)|0;Gc=D;Wc=Bc|jc;qc=$c|Gc;zc=Uc^Wc;Kc=Vc^qc;Jc=Cd&Do;Yc=Td&ko;Xc=Cd|Do;Zc=Td|ko;eh=Xc&$s;th=Zc&Gs;ih=eh|Jc;nh=th|Yc;rh=ri(zc|0,Kc|0,ih|0,nh|0)|0;sh=D;ah=ri(_c|0,bc|0,er|0,tr|0)|0;oh=D;dh=ri(rh|0,sh|0,_c|0,bc|0)|0;ch=D;hh=oi(ah|0,oh|0,50)|0;uh=D;ph=ai(ah|0,oh|0,14)|0;gh=D;mh=hh|ph;fh=uh|gh;Sh=oi(ah|0,oh|0,46)|0;vh=D;Ch=ai(ah|0,oh|0,18)|0;Th=D;Eh=Sh|Ch;_h=vh|Th;bh=mh^Eh;Ph=fh^_h;Ih=oi(ah|0,oh|0,23)|0;Ah=D;Rh=ai(ah|0,oh|0,41)|0;wh=D;Dh=Ih|Rh;kh=Ah|wh;Nh=bh^Dh;Lh=Ph^kh;xh=vd^Mo;Fh=yd^Oo;Uh=ah&xh;Vh=oh&Fh;Hh=Uh^Mo;Bh=Vh^Oo;jh=Zf|6;Gh=31904+(jh<<3)|0;Wh=Gh;qh=Wh;zh=s[qh>>2]|0;Kh=Wh+4|0;Jh=Kh;Yh=s[Jh>>2]|0;Qh=Kf+(jh<<3)|0;Xh=Qh;eu=Xh;tu=s[eu>>2]|0;iu=Xh+4|0;nu=iu;ru=s[nu>>2]|0;su=ri(tu|0,ru|0,zh|0,Yh|0)|0;au=D;ou=ri(su|0,au|0,Hs|0,Bs|0)|0;lu=D;du=ri(ou|0,lu|0,Hh|0,Bh|0)|0;hu=D;uu=ri(du|0,hu|0,Nh|0,Lh|0)|0;pu=D;gu=oi(dh|0,ch|0,36)|0;mu=D;fu=ai(dh|0,ch|0,28)|0;Su=D;vu=gu|fu;yu=mu|Su;Cu=oi(dh|0,ch|0,30)|0;Eu=D;_u=ai(dh|0,ch|0,34)|0;bu=D;Pu=Cu|_u;Iu=Eu|bu;Au=vu^Pu;Ru=yu^Iu;wu=oi(dh|0,ch|0,25)|0;Mu=D;Ou=ai(dh|0,ch|0,39)|0;ku=D;Nu=wu|Ou;Lu=Mu|ku;xu=Au^Nu;Fu=Ru^Lu;Uu=dh&Cd;Vu=ch&Td;Hu=dh|Cd;Bu=ch|Td;$u=Hu&Do;Gu=Bu&ko;Wu=$u|Uu;qu=Gu|Vu;zu=ri(xu|0,Fu|0,Wu|0,qu|0)|0;Ku=D;Ju=ri(uu|0,pu|0,$s|0,Gs|0)|0;Yu=D;Qu=ri(zu|0,Ku|0,uu|0,pu|0)|0;Xu=D;Zu=oi(Ju|0,Yu|0,50)|0;tp=D;ip=ai(Ju|0,Yu|0,14)|0;np=D;rp=Zu|ip;sp=tp|np;ap=oi(Ju|0,Yu|0,46)|0;op=D;lp=ai(Ju|0,Yu|0,18)|0;dp=D;cp=ap|lp;up=op|dp;pp=rp^cp;gp=sp^up;mp=oi(Ju|0,Yu|0,23)|0;fp=D;Sp=ai(Ju|0,Yu|0,41)|0;vp=D;yp=mp|Sp;Cp=fp|vp;Tp=pp^yp;_p=gp^Cp;bp=ah^vd;Pp=oh^yd;Ip=Ju&bp;Ap=Yu&Pp;Rp=Ip^vd;wp=Ap^yd;Mp=Zf|7;Op=31904+(Mp<<3)|0;Dp=Op;Lp=Dp;xp=s[Lp>>2]|0;Fp=Dp+4|0;Up=Fp;Vp=s[Up>>2]|0;Hp=Kf+(Mp<<3)|0;Bp=Hp;$p=Bp;jp=s[$p>>2]|0;Gp=Bp+4|0;qp=Gp;zp=s[qp>>2]|0;Kp=ri(jp|0,zp|0,xp|0,Vp|0)|0;Jp=D;Yp=ri(Kp|0,Jp|0,Mo|0,Oo|0)|0;Qp=D;Xp=ri(Yp|0,Qp|0,Rp|0,wp|0)|0;Zp=D;eg=ri(Xp|0,Zp|0,Tp|0,_p|0)|0;tg=D;ng=oi(Qu|0,Xu|0,36)|0;rg=D;sg=ai(Qu|0,Xu|0,28)|0;ag=D;og=ng|sg;lg=rg|ag;dg=oi(Qu|0,Xu|0,30)|0;cg=D;hg=ai(Qu|0,Xu|0,34)|0;ug=D;gg=dg|hg;mg=cg|ug;fg=og^gg;Sg=lg^mg;vg=oi(Qu|0,Xu|0,25)|0;yg=D;Cg=ai(Qu|0,Xu|0,39)|0;Tg=D;Eg=vg|Cg;_g=yg|Tg;Pg=fg^Eg;Ig=Sg^_g;Ag=Qu&dh;Rg=Xu&ch;wg=Qu|dh;Mg=Xu|ch;Og=wg&Cd;Dg=Mg&Td;kg=Og|Ag;Ng=Dg|Rg;xg=ri(Pg|0,Ig|0,kg|0,Ng|0)|0;Fg=D;Ug=ri(eg|0,tg|0,Do|0,ko|0)|0;Vg=D;Hg=ri(xg|0,Fg|0,eg|0,tg|0)|0;Bg=D;$g=Zf+8|0;jg=($g|0)<80;if(jg){ne=Ug;re=Vg;Oe=ah;De=Ju;Ne=oh;Le=Yu;it=vd;nt=yd;gt=Hg;mt=Bg;Bt=Qu;Gt=Xu;Kt=dh;Qt=ch;ni=Cd;si=Td;Zf=$g}else{break}}Gg=t;Wg=Gg;zg=s[Wg>>2]|0;Kg=Gg+4|0;Jg=Kg;Yg=s[Jg>>2]|0;Qg=ri(zg|0,Yg|0,Hg|0,Bg|0)|0;Xg=D;Zg=t;em=Zg;s[em>>2]=Qg;tm=Zg+4|0;im=tm;s[im>>2]=Xg;rm=Gf;sm=rm;am=s[sm>>2]|0;om=rm+4|0;lm=om;dm=s[lm>>2]|0;cm=ri(am|0,dm|0,Qu|0,Xu|0)|0;hm=D;um=Gf;pm=um;s[pm>>2]=cm;mm=um+4|0;fm=mm;s[fm>>2]=hm;Sm=d;vm=Sm;ym=s[vm>>2]|0;Cm=Sm+4|0;Tm=Cm;Em=s[Tm>>2]|0;_m=ri(ym|0,Em|0,dh|0,ch|0)|0;bm=D;Im=d;Am=Im;s[Am>>2]=_m;Rm=Im+4|0;wm=Rm;s[wm>>2]=bm;Mm=v;Om=Mm;Dm=s[Om>>2]|0;km=Mm+4|0;Nm=km;Lm=s[Nm>>2]|0;Um=ri(Dm|0,Lm|0,Cd|0,Td|0)|0;Vm=D;Hm=v;Bm=Hm;s[Bm>>2]=Um;$m=Hm+4|0;jm=$m;s[jm>>2]=Vm;Gm=P;Wm=Gm;qm=s[Wm>>2]|0;zm=Gm+4|0;Jm=zm;Ym=s[Jm>>2]|0;Qm=ri(qm|0,Ym|0,Ug|0,Vg|0)|0;Xm=D;Zm=P;ef=Zm;s[ef>>2]=Qm;tf=Zm+4|0;nf=tf;s[nf>>2]=Xm;rf=N;sf=rf;of=s[sf>>2]|0;lf=rf+4|0;df=lf;cf=s[df>>2]|0;hf=ri(of|0,cf|0,Ju|0,Yu|0)|0;uf=D;pf=N;gf=pf;s[gf>>2]=hf;mf=pf+4|0;ff=mf;s[ff>>2]=uf;vf=$;yf=vf;Cf=s[yf>>2]|0;Tf=vf+4|0;Ef=Tf;_f=s[Ef>>2]|0;bf=ri(Cf|0,_f|0,ah|0,oh|0)|0;Pf=D;If=$;Af=If;s[Af>>2]=bf;wf=If+4|0;Mf=wf;s[Mf>>2]=Pf;Of=J;Df=Of;kf=s[Df>>2]|0;Nf=Of+4|0;Lf=Nf;xf=s[Lf>>2]|0;Ff=ri(kf|0,xf|0,vd|0,yd|0)|0;Uf=D;Hf=J;Bf=Hf;s[Bf>>2]=Ff;$f=Hf+4|0;jf=$f;s[jf>>2]=Uf;h=tS;return}function Kt(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,r=0;r=h;Jt(e,0,0,t,i);h=r;return}function Jt(e,t,i,r,a){e=e|0;t=t|0;i=i|0;r=r|0;a=a|0;var o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0,b=0,P=0,I=0,A=0;var R=0,w=0,M=0,O=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0,j=0,G=0,W=0,q=0,z=0,K=0;var J=0,Y=0,Q=0,X=0,Z=0,ee=0,te=0,ie=0,ne=0,re=0,se=0,ae=0,oe=0,le=0,de=0,ce=0,he=0,ue=0;he=h;o=e+192|0;l=o;C=l;O=s[C>>2]|0;j=l+4|0;ee=j;ne=s[ee>>2]|0;re=O&127;se=128>>>i;ae=0-se|0;d=ae&t;c=d|se;u=c&255;p=re+1|0;g=e+re|0;n[g>>0]=u;m=p>>>0>112;f=e+p|0;if(m){S=re^127;si(f|0,0,S|0)|0;v=e+128|0;zt(e,v);de=e+0|0;ue=de+112|0;do{n[de>>0]=0|0;de=de+1|0}while((de|0)<(ue|0))}else{y=111-re|0;si(f|0,0,y|0)|0}T=e+112|0;E=o;_=E;b=s[_>>2]|0;P=E+4|0;I=P;A=s[I>>2]|0;R=ai(b|0,A|0,61)|0;w=D;Qt(T,R,w);M=e+120|0;k=o;N=k;L=s[N>>2]|0;x=k+4|0;F=x;U=s[F>>2]|0;V=oi(L|0,U|0,3)|0;H=D;B=ri(V|0,H|0,i|0,0)|0;$=D;Qt(M,B,$);G=e+128|0;zt(e,G);W=(a|0)==0;if(W){h=he;return}else{le=0}while(1){q=le<<3;z=r+q|0;K=G+(le<<3)|0;J=K;Y=J;Q=s[Y>>2]|0;X=J+4|0;Z=X;te=s[Z>>2]|0;Xt(z,Q,te);ie=le+1|0;oe=(ie|0)==(a|0);if(oe){break}else{le=ie}}h=he;return}function Yt(e){e=e|0;var t=0,i=0,r=0,s=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0;var _=0,b=0,P=0,I=0,A=0,R=0,w=0,M=0,O=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0,j=0;var G=0,W=0,q=0,z=0,K=0,J=0,Y=0,Q=0,X=0;X=h;t=n[e>>0]|0;i=t&255;m=oi(i|0,0,56)|0;I=D;U=e+1|0;q=n[U>>0]|0;z=q&255;K=oi(z|0,0,48)|0;J=D;Y=K|m;r=J|I;s=e+2|0;a=n[s>>0]|0;o=a&255;l=oi(o|0,0,40)|0;d=D;c=Y|l;u=r|d;p=e+3|0;g=n[p>>0]|0;f=g&255;S=u|f;v=e+4|0;y=n[v>>0]|0;C=y&255;T=oi(C|0,0,24)|0;E=D;_=c|T;b=S|E;P=e+5|0;A=n[P>>0]|0;R=A&255;w=oi(R|0,0,16)|0;M=D;O=_|w;k=b|M;N=e+6|0;L=n[N>>0]|0;x=L&255;F=oi(x|0,0,8)|0;V=D;H=O|F;B=k|V;$=e+7|0;j=n[$>>0]|0;G=j&255;W=H|G;D=B;h=X;return W|0}function Qt(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,s=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0,b=0;var P=0,I=0,A=0,R=0,w=0,M=0,O=0,k=0,N=0;N=h;m=ai(t|0,i|0,56)|0;P=D;I=m&255;n[e>>0]=I;A=ai(t|0,i|0,48)|0;R=D;w=A&255;M=e+1|0;n[M>>0]=w;O=ai(t|0,i|0,40)|0;r=D;s=O&255;a=e+2|0;n[a>>0]=s;o=i&255;l=e+3|0;n[l>>0]=o;d=ai(t|0,i|0,24)|0;c=D;u=d&255;p=e+4|0;n[p>>0]=u;g=ai(t|0,i|0,16)|0;f=D;S=g&255;v=e+5|0;n[v>>0]=S;y=ai(t|0,i|0,8)|0;C=D;T=y&255;E=e+6|0;n[E>>0]=T;_=t&255;b=e+7|0;n[b>>0]=_;h=N;return}function Xt(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,s=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0,b=0;var P=0,I=0,A=0,R=0,w=0,M=0,O=0,k=0,N=0;N=h;m=ai(t|0,i|0,56)|0;P=D;I=m&255;n[e>>0]=I;A=ai(t|0,i|0,48)|0;R=D;w=A&255;M=e+1|0;n[M>>0]=w;O=ai(t|0,i|0,40)|0;r=D;s=O&255;a=e+2|0;n[a>>0]=s;o=i&255;l=e+3|0;n[l>>0]=o;d=ai(t|0,i|0,24)|0;c=D;u=d&255;p=e+4|0;n[p>>0]=u;g=ai(t|0,i|0,16)|0;f=D;S=g&255;v=e+5|0;n[v>>0]=S;y=ai(t|0,i|0,8)|0;C=D;T=y&255;E=e+6|0;n[E>>0]=T;_=t&255;b=e+7|0;n[b>>0]=_;h=N;return}function Zt(e){e=e|0;var t=0,i=0,n=0,r=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0;var _=0,b=0,P=0,I=0,A=0,R=0,w=0,M=0,O=0,D=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0;var j=0,G=0,W=0,q=0,z=0,K=0,J=0,Y=0,Q=0,X=0,Z=0,ee=0,te=0,ie=0,ne=0,re=0,se=0,ae=0,de=0,ue=0;var pe=0,ge=0,fe=0,Se=0,ve=0,ye=0,Ce=0,Te=0,Ee=0,_e=0,be=0,Pe=0,Ie=0,Ae=0,Re=0,we=0,Me=0,Oe=0,De=0,ke=0;var Ne=0,Le=0,xe=0,Fe=0,Ue=0,Ve=0,He=0,Be=0,$e=0,je=0,Ge=0,We=0,qe=0,ze=0,Ke=0,Je=0,Ye=0,Qe=0,Xe=0,Ze=0;var et=0,tt=0,it=0,nt=0,rt=0,st=0,at=0,ot=0,lt=0,dt=0,ct=0,ht=0,ut=0,pt=0,gt=0,mt=0,ft=0,St=0,vt=0,yt=0;var Ct=0,Tt=0,Et=0,_t=0,bt=0,Pt=0,It=0,At=0,Rt=0,wt=0,Mt=0,Ot=0,Dt=0,kt=0,Nt=0,Lt=0,xt=0,Ft=0,Ut=0,Vt=0;var Ht=0,Bt=0,$t=0,jt=0,Gt=0,Wt=0,qt=0,zt=0,Kt=0,Jt=0,Yt=0,Qt=0,Xt=0,Zt=0,ei=0,ti=0,ii=0,ni=0,ri=0,si=0;var ai=0,oi=0,li=0,di=0,ci=0,hi=0,ui=0,pi=0,gi=0,mi=0,fi=0,Si=0,vi=0,yi=0,Ci=0,Ti=0,Ei=0,_i=0,bi=0,Pi=0;var Ii=0,Ai=0,Ri=0,wi=0,Mi=0,Oi=0,Di=0,ki=0,Ni=0,Li=0,xi=0,Fi=0,Ui=0,Vi=0,Hi=0,Bi=0,$i=0,ji=0,Gi=0,Wi=0;var qi=0,zi=0,Ki=0,Ji=0,Yi=0,Qi=0,Xi=0,Zi=0,en=0,tn=0,nn=0,rn=0,sn=0,an=0,on=0,ln=0,dn=0,cn=0,hn=0,un=0;var pn=0,gn=0,mn=0,fn=0,Sn=0,vn=0,yn=0,Cn=0,Tn=0,En=0,_n=0,bn=0,Pn=0,In=0,An=0,Rn=0,wn=0,Mn=0,On=0,Dn=0;var kn=0,Nn=0,Ln=0,xn=0,Fn=0,Un=0,Vn=0,Hn=0,Bn=0,$n=0,jn=0,Gn=0,Wn=0,qn=0,zn=0,Kn=0,Jn=0,Yn=0,Qn=0,Xn=0;var Zn=0,er=0,tr=0,ir=0,nr=0,rr=0,sr=0,ar=0,or=0,lr=0,dr=0,cr=0,hr=0,ur=0,pr=0,gr=0,mr=0,fr=0,Sr=0,vr=0;var yr=0,Cr=0,Tr=0,Er=0,_r=0,br=0,Pr=0,Ir=0,Ar=0,Rr=0,wr=0,Mr=0,Or=0,Dr=0,kr=0,Nr=0,Lr=0,xr=0,Fr=0,Ur=0;var Vr=0,Hr=0,Br=0,$r=0,jr=0,Gr=0,Wr=0,qr=0,zr=0,Kr=0,Jr=0,Yr=0,Qr=0,Xr=0,Zr=0,es=0,ts=0,is=0,ns=0,rs=0;var ss=0,as=0,os=0,ls=0,ds=0,cs=0,hs=0,us=0,ps=0,gs=0,ms=0,fs=0,Ss=0,vs=0,ys=0,Cs=0,Ts=0,Es=0,_s=0,bs=0;var Ps=0,Is=0,As=0,Rs=0,ws=0,Ms=0,Os=0,Ds=0,ks=0,Ns=0,Ls=0,xs=0,Fs=0,Us=0,Vs=0,Hs=0,Bs=0,$s=0,js=0,Gs=0;var Ws=0,qs=0,zs=0,Ks=0,Js=0,Ys=0,Qs=0,Xs=0,Zs=0,ea=0,ta=0,ia=0,na=0,ra=0,sa=0,aa=0,oa=0,la=0,da=0,ca=0;var ha=0,ua=0,pa=0,ga=0,ma=0,fa=0,Sa=0,va=0,ya=0,Ca=0,Ta=0,Ea=0,_a=0,ba=0,Pa=0,Ia=0,Aa=0,Ra=0,wa=0,Ma=0;var Oa=0,Da=0,ka=0,Na=0,La=0,xa=0,Fa=0,Ua=0,Va=0,Ha=0,Ba=0,$a=0,ja=0,Ga=0,Wa=0,qa=0,za=0,Ka=0,Ja=0,Ya=0;var Qa=0,Xa=0,Za=0,eo=0,to=0,io=0,no=0,ro=0,so=0,ao=0,oo=0,lo=0,co=0,ho=0,uo=0,po=0,go=0,mo=0,fo=0,So=0;var vo=0,yo=0,Co=0,To=0,Eo=0,_o=0,bo=0,Po=0,Io=0,Ao=0,Ro=0,wo=0,Mo=0,Oo=0,Do=0,ko=0,No=0,Lo=0,xo=0,Fo=0;var Uo=0,Vo=0,Ho=0,Bo=0,$o=0,jo=0,Go=0,Wo=0,qo=0,zo=0,Ko=0,Jo=0,Yo=0,Qo=0,Xo=0,Zo=0,el=0,tl=0,il=0,nl=0;var rl=0,sl=0,al=0,ol=0,ll=0,dl=0,cl=0,hl=0,ul=0,pl=0,gl=0,ml=0,fl=0,Sl=0,vl=0,yl=0,Cl=0,Tl=0,El=0,_l=0;var bl=0,Pl=0,Il=0,Al=0,Rl=0,wl=0,Ml=0,Ol=0,Dl=0,kl=0,Nl=0,Ll=0,xl=0,Fl=0,Ul=0,Vl=0,Hl=0,Bl=0,$l=0,jl=0;var Gl=0,Wl=0,ql=0,zl=0,Kl=0,Jl=0,Yl=0,Ql=0,Xl=0,Zl=0,ed=0,td=0,id=0,nd=0,rd=0,sd=0,ad=0,od=0,ld=0,dd=0;var cd=0,hd=0,ud=0,pd=0,gd=0,md=0,fd=0,Sd=0,vd=0,yd=0,Cd=0,Td=0,Ed=0,_d=0,bd=0,Pd=0,Id=0,Ad=0,Rd=0,wd=0;var Md=0,Od=0,Dd=0,kd=0,Nd=0,Ld=0,xd=0,Fd=0,Ud=0,Vd=0,Hd=0,Bd=0,$d=0,jd=0,Gd=0,Wd=0,qd=0,zd=0,Kd=0,Jd=0;var Yd=0,Qd=0,Xd=0,Zd=0,ec=0,tc=0,ic=0,nc=0,rc=0,sc=0,ac=0,oc=0,lc=0,dc=0,cc=0,hc=0,uc=0,pc=0,gc=0,mc=0;var fc=0,Sc=0,vc=0,yc=0,Cc=0,Tc=0,Ec=0,_c=0,bc=0,Pc=0,Ic=0,Ac=0,Rc=0,wc=0,Mc=0,Oc=0,Dc=0,kc=0,Nc=0,Lc=0;var xc=0,Fc=0,Uc=0,Vc=0,Hc=0,Bc=0,$c=0,jc=0,Gc=0,Wc=0,qc=0,zc=0,Kc=0,Jc=0,Yc=0,Qc=0,Xc=0,Zc=0,eh=0,th=0;var ih=0,nh=0,rh=0,sh=0,ah=0,oh=0,lh=0,dh=0,ch=0,hh=0,uh=0,ph=0,gh=0,mh=0,fh=0,Sh=0,vh=0,yh=0,Ch=0,Th=0;var Eh=0,_h=0,bh=0,Ph=0,Ih=0,Ah=0,Rh=0,wh=0,Mh=0,Oh=0,Dh=0,kh=0,Nh=0,Lh=0,xh=0,Fh=0,Uh=0,Vh=0,Hh=0,Bh=0;var $h=0,jh=0,Gh=0,Wh=0,qh=0,zh=0,Kh=0,Jh=0,Yh=0,Qh=0,Xh=0,Zh=0,eu=0,tu=0,iu=0,nu=0,ru=0,su=0,au=0,ou=0;var lu=0,du=0,cu=0,hu=0,uu=0,pu=0,gu=0,mu=0,fu=0,Su=0,vu=0,yu=0,Cu=0,Tu=0,Eu=0,_u=0,bu=0,Pu=0,Iu=0,Au=0;var Ru=0,wu=0,Mu=0,Ou=0,Du=0,ku=0,Nu=0,Lu=0,xu=0,Fu=0,Uu=0,Vu=0,Hu=0,Bu=0,$u=0,ju=0,Gu=0,Wu=0,qu=0,zu=0;var Ku=0,Ju=0,Yu=0,Qu=0,Xu=0,Zu=0,ep=0,tp=0,ip=0,np=0,rp=0,sp=0,ap=0,op=0,lp=0,dp=0,cp=0,hp=0,up=0,pp=0;var gp=0,mp=0,fp=0,Sp=0,vp=0,yp=0,Cp=0,Tp=0,Ep=0,_p=0,bp=0,Pp=0,Ip=0,Ap=0,Rp=0,wp=0,Mp=0,Op=0,Dp=0,kp=0;var Np=0,Lp=0,xp=0,Fp=0,Up=0,Vp=0,Hp=0,Bp=0,$p=0,jp=0,Gp=0,Wp=0,qp=0,zp=0,Kp=0,Jp=0,Yp=0,Qp=0,Xp=0,Zp=0;var eg=0,tg=0,ig=0,ng=0,rg=0,sg=0,ag=0,og=0,lg=0,dg=0,cg=0,hg=0,ug=0,pg=0,gg=0,mg=0,fg=0,Sg=0,vg=0,yg=0;var Cg=0,Tg=0,Eg=0,_g=0,bg=0,Pg=0,Ig=0,Ag=0,Rg=0,wg=0,Mg=0,Og=0,Dg=0,kg=0,Ng=0,Lg=0,xg=0,Fg=0,Ug=0,Vg=0;var Hg=0,Bg=0,$g=0,jg=0,Gg=0,Wg=0,qg=0,zg=0,Kg=0,Jg=0,Yg=0,Qg=0,Xg=0,Zg=0,em=0,tm=0,im=0,nm=0,rm=0,sm=0;var am=0,om=0,lm=0,dm=0,cm=0,hm=0,um=0,pm=0,gm=0,mm=0,fm=0,Sm=0,vm=0,ym=0,Cm=0,Tm=0,Em=0,_m=0,bm=0,Pm=0;var Im=0,Am=0,Rm=0,wm=0,Mm=0,Om=0,Dm=0,km=0,Nm=0,Lm=0,xm=0,Fm=0,Um=0,Vm=0,Hm=0,Bm=0,$m=0,jm=0,Gm=0,Wm=0;var qm=0,zm=0,Km=0,Jm=0,Ym=0,Qm=0,Xm=0,Zm=0,ef=0,tf=0,nf=0,rf=0,sf=0,af=0,of=0,lf=0,df=0,cf=0,hf=0,uf=0;var pf=0,gf=0,mf=0,ff=0,Sf=0,vf=0,yf=0,Cf=0,Tf=0,Ef=0,_f=0,bf=0,Pf=0,If=0,Af=0,Rf=0,wf=0,Mf=0,Of=0,Df=0;var kf=0,Nf=0,Lf=0,xf=0,Ff=0,Uf=0,Vf=0,Hf=0,Bf=0,$f=0,jf=0,Gf=0,Wf=0,qf=0,zf=0,Kf=0,Jf=0,Yf=0,Qf=0,Xf=0;var Zf=0,eS=0,tS=0,iS=0,nS=0,rS=0,sS=0,aS=0,oS=0,lS=0,dS=0,cS=0,hS=0,uS=0,pS=0,gS=0,mS=0,fS=0,SS=0,vS=0;var yS=0,CS=0,TS=0,ES=0,_S=0,bS=0,PS=0,IS=0,AS=0,RS=0,wS=0,MS=0,OS=0,DS=0,kS=0,NS=0,LS=0,xS=0,FS=0,US=0;var VS=0,HS=0,BS=0,$S=0,jS=0,GS=0,WS=0,qS=0,zS=0,KS=0,JS=0,YS=0,QS=0,XS=0,ZS=0,ev=0,tv=0,iv=0,nv=0,rv=0;var sv=0,av=0,ov=0,lv=0,dv=0,cv=0,hv=0,uv=0,pv=0,gv=0,mv=0,fv=0,Sv=0,vv=0,yv=0,Cv=0,Tv=0,Ev=0,_v=0,bv=0;var Pv=0,Iv=0,Av=0,Rv=0,wv=0,Mv=0,Ov=0,Dv=0,kv=0,Nv=0,Lv=0,xv=0,Fv=0,Uv=0,Vv=0,Hv=0,Bv=0,$v=0,jv=0,Gv=0;var Wv=0,qv=0,zv=0,Kv=0,Jv=0,Yv=0,Qv=0,Xv=0,Zv=0,ey=0,ty=0,iy=0,ny=0,ry=0,sy=0,ay=0,oy=0,ly=0,dy=0,cy=0;var hy=0,uy=0,py=0,gy=0,my=0,fy=0,Sy=0,vy=0,yy=0,Cy=0,Ty=0,Ey=0,_y=0,by=0,Py=0,Iy=0,Ay=0,Ry=0,wy=0,My=0;var Oy=0,Dy=0,ky=0,Ny=0,Ly=0,xy=0,Fy=0,Uy=0,Vy=0,Hy=0,By=0,$y=0,jy=0,Gy=0,Wy=0,qy=0,zy=0,Ky=0,Jy=0,Yy=0;var Qy=0,Xy=0,Zy=0,eC=0,tC=0,iC=0,nC=0,rC=0,sC=0,aC=0,oC=0,lC=0,dC=0,cC=0,hC=0,uC=0,pC=0,gC=0,mC=0,fC=0;var SC=0,vC=0,yC=0,CC=0,TC=0,EC=0,_C=0,bC=0,PC=0,IC=0,AC=0,RC=0,wC=0,MC=0,OC=0,DC=0,kC=0,NC=0,LC=0,xC=0;var FC=0,UC=0,VC=0,HC=0,BC=0,$C=0,jC=0,GC=0,WC=0,qC=0,zC=0,KC=0,JC=0,YC=0,QC=0,XC=0,ZC=0,eT=0,tT=0,iT=0;var nT=0,rT=0,sT=0,aT=0,oT=0,lT=0,dT=0,cT=0,hT=0,uT=0,pT=0,gT=0,mT=0,fT=0,ST=0,vT=0,yT=0,CT=0,TT=0,ET=0;var _T=0,bT=0,PT=0,IT=0,AT=0,RT=0,wT=0,MT=0,OT=0,DT=0,kT=0,NT=0,LT=0,xT=0,FT=0,UT=0,VT=0,HT=0,BT=0,$T=0;var jT=0,GT=0,WT=0,qT=0,zT=0,KT=0,JT=0,YT=0,QT=0,XT=0,ZT=0,eE=0,tE=0,iE=0,nE=0,rE=0,sE=0,aE=0,oE=0,lE=0;var dE=0,cE=0,hE=0,uE=0,pE=0,gE=0,mE=0,fE=0,SE=0,vE=0,yE=0,CE=0,TE=0,EE=0,_E=0,bE=0,PE=0,IE=0,AE=0,RE=0;var wE=0,ME=0,OE=0,DE=0,kE=0,NE=0,LE=0,xE=0,FE=0,UE=0,VE=0,HE=0,BE=0,$E=0,jE=0,GE=0;GE=h;pt=e>>>0<245;do{if(pt){gt=e>>>0<11;if(gt){Jc=16}else{Vr=e+11|0;$a=Vr&-8;Jc=$a}ql=Jc>>>3;Xu=s[32544>>2]|0;tm=Xu>>>ql;sS=tm&3;ly=(sS|0)==0;if(!ly){mt=tm&1;zi=mt^1;sn=zi+ql|0;fn=sn<<1;An=(32544+(fn<<2)|0)+40|0;N=fn+2|0;Un=(32544+(N<<2)|0)+40|0;Jn=s[Un>>2]|0;ar=Jn+8|0;Sr=s[ar>>2]|0;Rr=(An|0)==(Sr|0);do{if(Rr){Hr=1<<sn;Qr=Hr^-1;ls=Xu&Qr;s[32544>>2]=ls}else{ys=s[(32544+16|0)>>2]|0;Ms=Sr>>>0<ys>>>0;if(Ms){le()}Bs=Sr+12|0;Xs=s[Bs>>2]|0;da=(Xs|0)==(Jn|0);if(da){s[Bs>>2]=An;s[Un>>2]=Sr;break}else{le()}}}while(0);Ca=sn<<3;Oa=Ca|3;ja=Jn+4|0;s[ja>>2]=Oa;Q=Ca|4;eo=Jn+Q|0;uo=s[eo>>2]|0;_o=uo|1;s[eo>>2]=_o;qT=ar;h=GE;return qT|0}No=s[(32544+8|0)>>2]|0;Wo=Jc>>>0>No>>>0;if(Wo){il=(tm|0)==0;if(!il){pl=tm<<ql;bl=2<<ql;Ll=0-bl|0;zl=bl|Ll;rd=pl&zl;md=0-rd|0;Id=rd&md;Fd=Id+-1|0;Kd=Fd>>>12;sc=Kd&16;fc=Fd>>>sc;Ac=fc>>>5;Uc=Ac&8;Yc=Uc|sc;oh=fc>>>Uc;vh=oh>>>2;wh=vh&4;Hh=Yc|wh;Qh=oh>>>wh;lu=Qh>>>1;yu=lu&2;Mu=Hh|yu;Bu=Qh>>>yu;Zu=Bu>>>1;cp=Zu&1;Tp=Mu|cp;Dp=Bu>>>cp;jp=Tp+Dp|0;eg=jp<<1;hg=(32544+(eg<<2)|0)+40|0;Ke=eg+2|0;Eg=(32544+(Ke<<2)|0)+40|0;kg=s[Eg>>2]|0;Gg=kg+8|0;im=s[Gg>>2]|0;pm=(hg|0)==(im|0);do{if(pm){bm=1<<jp;Lm=bm^-1;qm=Xu&Lm;s[32544>>2]=qm;Hv=No}else{rf=s[(32544+16|0)>>2]|0;mf=im>>>0<rf>>>0;if(mf){le()}If=im+12|0;Ff=s[If>>2]|0;Kf=(Ff|0)==(kg|0);if(Kf){s[If>>2]=hg;s[Eg>>2]=im;t=s[(32544+8|0)>>2]|0;Hv=t;break}else{le()}}}while(0);aS=jp<<3;SS=aS-Jc|0;RS=Jc|3;VS=kg+4|0;s[VS>>2]=RS;YS=kg+Jc|0;ov=SS|1;it=Jc|4;vv=kg+it|0;s[vv>>2]=ov;wv=kg+aS|0;s[wv>>2]=SS;Qv=(Hv|0)==0;if(!Qv){dy=s[(32544+20|0)>>2]|0;Cy=Hv>>>3;Oy=Cy<<1;$y=(32544+(Oy<<2)|0)+40|0;Zy=s[32544>>2]|0;cC=1<<Cy;TC=Zy&cC;DC=(TC|0)==0;if(DC){jC=Zy|cC;s[32544>>2]=jC;ot=Oy+2|0;g=(32544+(ot<<2)|0)+40|0;p=g;pT=$y}else{lt=Oy+2|0;eT=(32544+(lt<<2)|0)+40|0;ft=s[eT>>2]|0;At=s[(32544+16|0)>>2]|0;Ut=ft>>>0<At>>>0;if(Ut){le()}else{p=eT;pT=ft}}s[p>>2]=dy;Jt=pT+12|0;s[Jt>>2]=dy;ai=dy+8|0;s[ai>>2]=pT;Si=dy+12|0;s[Si>>2]=$y}s[(32544+8|0)>>2]=SS;s[(32544+20|0)>>2]=YS;qT=Gg;h=GE;return qT|0}Ri=s[(32544+4|0)>>2]|0;Vi=(Ri|0)==0;if(Vi){zT=Jc}else{Wi=0-Ri|0;qi=Ri&Wi;Ki=qi+-1|0;Ji=Ki>>>12;Yi=Ji&16;Qi=Ki>>>Yi;Xi=Qi>>>5;Zi=Xi&8;en=Zi|Yi;tn=Qi>>>Zi;nn=tn>>>2;rn=nn&4;an=en|rn;on=tn>>>rn;ln=on>>>1;dn=ln&2;cn=an|dn;hn=on>>>dn;un=hn>>>1;pn=un&1;gn=cn|pn;mn=hn>>>pn;Sn=gn+mn|0;vn=(32544+(Sn<<2)|0)+304|0;yn=s[vn>>2]|0;Cn=yn+4|0;Tn=s[Cn>>2]|0;En=Tn&-8;_n=En-Jc|0;cE=_n;AE=yn;FE=yn;while(1){bn=AE+16|0;Pn=s[bn>>2]|0;In=(Pn|0)==(0|0);if(In){Rn=AE+20|0;wn=s[Rn>>2]|0;Mn=(wn|0)==(0|0);if(Mn){break}else{Dn=wn}}else{Dn=Pn}On=Dn+4|0;kn=s[On>>2]|0;Nn=kn&-8;Ln=Nn-Jc|0;xn=Ln>>>0<cE>>>0;f=xn?Ln:cE;ut=xn?Dn:FE;cE=f;AE=Dn;FE=ut}Fn=s[(32544+16|0)>>2]|0;Vn=FE>>>0<Fn>>>0;if(Vn){le()}Hn=FE+Jc|0;Bn=FE>>>0<Hn>>>0;if(!Bn){le()}$n=FE+24|0;jn=s[$n>>2]|0;Gn=FE+12|0;Wn=s[Gn>>2]|0;qn=(Wn|0)==(FE|0);do{if(qn){nr=FE+20|0;rr=s[nr>>2]|0;sr=(rr|0)==(0|0);if(sr){or=FE+16|0;lr=s[or>>2]|0;dr=(lr|0)==(0|0);if(dr){IT=0;break}else{_T=lr;wT=or}}else{_T=rr;wT=nr}while(1){cr=_T+20|0;hr=s[cr>>2]|0;ur=(hr|0)==(0|0);if(!ur){_T=hr;wT=cr;continue}pr=_T+16|0;gr=s[pr>>2]|0;mr=(gr|0)==(0|0);if(mr){break}else{_T=gr;wT=pr}}fr=wT>>>0<Fn>>>0;if(fr){le()}else{s[wT>>2]=0;IT=_T;break}}else{zn=FE+8|0;Kn=s[zn>>2]|0;Yn=Kn>>>0<Fn>>>0;if(Yn){le()}Qn=Kn+12|0;Xn=s[Qn>>2]|0;Zn=(Xn|0)==(FE|0);if(!Zn){le()}er=Wn+8|0;tr=s[er>>2]|0;ir=(tr|0)==(FE|0);if(ir){s[Qn>>2]=Wn;s[er>>2]=Kn;IT=Wn;break}else{le()}}}while(0);vr=(jn|0)==(0|0);do{if(!vr){yr=FE+28|0;Cr=s[yr>>2]|0;Tr=(32544+(Cr<<2)|0)+304|0;Er=s[Tr>>2]|0;_r=(FE|0)==(Er|0);if(_r){s[Tr>>2]=IT;HT=(IT|0)==(0|0);if(HT){br=1<<Cr;Pr=br^-1;Ir=s[(32544+4|0)>>2]|0;Ar=Ir&Pr;s[(32544+4|0)>>2]=Ar;break}}else{wr=s[(32544+16|0)>>2]|0;Mr=jn>>>0<wr>>>0;if(Mr){le()}Or=jn+16|0;Dr=s[Or>>2]|0;kr=(Dr|0)==(FE|0);if(kr){s[Or>>2]=IT}else{Nr=jn+20|0;s[Nr>>2]=IT}Lr=(IT|0)==(0|0);if(Lr){break}}xr=s[(32544+16|0)>>2]|0;Fr=IT>>>0<xr>>>0;if(Fr){le()}Ur=IT+24|0;s[Ur>>2]=jn;Br=FE+16|0;$r=s[Br>>2]|0;jr=($r|0)==(0|0);do{if(!jr){Gr=$r>>>0<xr>>>0;if(Gr){le()}else{Wr=IT+16|0;s[Wr>>2]=$r;qr=$r+24|0;s[qr>>2]=IT;break}}}while(0);zr=FE+20|0;Kr=s[zr>>2]|0;Jr=(Kr|0)==(0|0);if(!Jr){Yr=s[(32544+16|0)>>2]|0;Xr=Kr>>>0<Yr>>>0;if(Xr){le()}else{Zr=IT+20|0;s[Zr>>2]=Kr;es=Kr+24|0;s[es>>2]=IT;break}}}}while(0);ts=cE>>>0<16;if(ts){is=cE+Jc|0;ns=is|3;rs=FE+4|0;s[rs>>2]=ns;Je=is+4|0;ss=FE+Je|0;as=s[ss>>2]|0;os=as|1;s[ss>>2]=os}else{ds=Jc|3;cs=FE+4|0;s[cs>>2]=ds;hs=cE|1;A=Jc|4;us=FE+A|0;s[us>>2]=hs;w=cE+Jc|0;ps=FE+w|0;s[ps>>2]=cE;gs=s[(32544+8|0)>>2]|0;ms=(gs|0)==0;if(!ms){fs=s[(32544+20|0)>>2]|0;Ss=gs>>>3;vs=Ss<<1;Cs=(32544+(vs<<2)|0)+40|0;Ts=s[32544>>2]|0;Es=1<<Ss;_s=Ts&Es;bs=(_s|0)==0;if(bs){Ps=Ts|Es;s[32544>>2]=Ps;Re=vs+2|0;i=(32544+(Re<<2)|0)+40|0;c=i;uT=Cs}else{Ve=vs+2|0;Is=(32544+(Ve<<2)|0)+40|0;As=s[Is>>2]|0;Rs=s[(32544+16|0)>>2]|0;ws=As>>>0<Rs>>>0;if(ws){le()}else{c=Is;uT=As}}s[c>>2]=fs;Os=uT+12|0;s[Os>>2]=fs;Ds=fs+8|0;s[Ds>>2]=uT;ks=fs+12|0;s[ks>>2]=Cs}s[(32544+8|0)>>2]=cE;s[(32544+20|0)>>2]=Hn}Ns=FE+8|0;qT=Ns;h=GE;return qT|0}}else{zT=Jc}}else{Ls=e>>>0>4294967231;if(Ls){zT=-1}else{xs=e+11|0;Fs=xs&-8;Us=s[(32544+4|0)>>2]|0;Vs=(Us|0)==0;if(Vs){zT=Fs}else{Hs=0-Fs|0;$s=xs>>>8;js=($s|0)==0;if(js){WT=0}else{Gs=Fs>>>0>16777215;if(Gs){WT=31}else{Ws=$s+1048320|0;qs=Ws>>>16;zs=qs&8;Ks=$s<<zs;Js=Ks+520192|0;Ys=Js>>>16;Qs=Ys&4;Zs=Qs|zs;ea=Ks<<Qs;ta=ea+245760|0;ia=ta>>>16;na=ia&2;ra=Zs|na;sa=14-ra|0;aa=ea<<na;oa=aa>>>15;la=sa+oa|0;ca=la<<1;ha=la+7|0;ua=Fs>>>ha;pa=ua&1;ga=pa|ca;WT=ga}}ma=(32544+(WT<<2)|0)+304|0;fa=s[ma>>2]|0;Sa=(fa|0)==(0|0);e:do{if(Sa){pE=Hs;wE=0;HE=0}else{va=(WT|0)==31;if(va){_a=0}else{ya=WT>>>1;Ta=25-ya|0;_a=Ta}Ea=Fs<<_a;hE=Hs;fE=0;vE=Ea;RE=fa;UE=0;while(1){ba=RE+4|0;Pa=s[ba>>2]|0;Ia=Pa&-8;Aa=Ia-Fs|0;Ra=Aa>>>0<hE>>>0;if(Ra){wa=(Ia|0)==(Fs|0);if(wa){pE=Aa;wE=RE;HE=RE;break e}else{uE=Aa;VE=RE}}else{uE=hE;VE=UE}Ma=RE+20|0;Da=s[Ma>>2]|0;ka=vE>>>31;Na=(RE+(ka<<2)|0)+16|0;La=s[Na>>2]|0;xa=(Da|0)==(0|0);Fa=(Da|0)==(La|0);eE=xa|Fa;SE=eE?fE:Da;Ua=(La|0)==(0|0);Va=vE<<1;if(Ua){pE=uE;wE=SE;HE=VE;break}else{hE=uE;fE=SE;vE=Va;RE=La;UE=VE}}}}while(0);Ha=(wE|0)==(0|0);Ba=(HE|0)==(0|0);JT=Ha&Ba;if(JT){Ga=2<<WT;Wa=0-Ga|0;qa=Ga|Wa;za=Us&qa;Ka=(za|0)==0;if(Ka){zT=Fs;break}Ja=0-za|0;Ya=za&Ja;Qa=Ya+-1|0;Xa=Qa>>>12;Za=Xa&16;to=Qa>>>Za;io=to>>>5;no=io&8;ro=no|Za;so=to>>>no;ao=so>>>2;oo=ao&4;lo=ro|oo;co=so>>>oo;ho=co>>>1;po=ho&2;go=lo|po;mo=co>>>po;fo=mo>>>1;So=fo&1;vo=go|So;yo=mo>>>So;Co=vo+yo|0;To=(32544+(Co<<2)|0)+304|0;Eo=s[To>>2]|0;ME=Eo}else{ME=wE}bo=(ME|0)==(0|0);if(bo){gE=pE;BE=HE}else{mE=pE;DE=ME;$E=HE;while(1){Po=DE+4|0;Io=s[Po>>2]|0;Ao=Io&-8;Ro=Ao-Fs|0;wo=Ro>>>0<mE>>>0;S=wo?Ro:mE;OE=wo?DE:$E;Mo=DE+16|0;Oo=s[Mo>>2]|0;Do=(Oo|0)==(0|0);if(!Do){mE=S;DE=Oo;$E=OE;continue}ko=DE+20|0;Lo=s[ko>>2]|0;xo=(Lo|0)==(0|0);if(xo){gE=S;BE=OE;break}else{mE=S;DE=Lo;$E=OE}}}Fo=(BE|0)==(0|0);if(Fo){zT=Fs}else{Uo=s[(32544+8|0)>>2]|0;Vo=Uo-Fs|0;Ho=gE>>>0<Vo>>>0;if(Ho){Bo=s[(32544+16|0)>>2]|0;$o=BE>>>0<Bo>>>0;if($o){le()}jo=BE+Fs|0;Go=BE>>>0<jo>>>0;if(!Go){le()}qo=BE+24|0;zo=s[qo>>2]|0;Ko=BE+12|0;Jo=s[Ko>>2]|0;Yo=(Jo|0)==(BE|0);do{if(Yo){ol=BE+20|0;ll=s[ol>>2]|0;dl=(ll|0)==(0|0);if(dl){cl=BE+16|0;hl=s[cl>>2]|0;ul=(hl|0)==(0|0);if(ul){RT=0;break}else{PT=hl;OT=cl}}else{PT=ll;OT=ol}while(1){gl=PT+20|0;ml=s[gl>>2]|0;fl=(ml|0)==(0|0);if(!fl){PT=ml;OT=gl;continue}Sl=PT+16|0;vl=s[Sl>>2]|0;yl=(vl|0)==(0|0);if(yl){break}else{PT=vl;OT=Sl}}Cl=OT>>>0<Bo>>>0;if(Cl){le()}else{s[OT>>2]=0;RT=PT;break}}else{Qo=BE+8|0;Xo=s[Qo>>2]|0;Zo=Xo>>>0<Bo>>>0;if(Zo){le()}el=Xo+12|0;tl=s[el>>2]|0;nl=(tl|0)==(BE|0);if(!nl){le()}rl=Jo+8|0;sl=s[rl>>2]|0;al=(sl|0)==(BE|0);if(al){s[el>>2]=Jo;s[rl>>2]=Xo;RT=Jo;break}else{le()}}}while(0);Tl=(zo|0)==(0|0);do{if(!Tl){El=BE+28|0;_l=s[El>>2]|0;Pl=(32544+(_l<<2)|0)+304|0;Il=s[Pl>>2]|0;Al=(BE|0)==(Il|0);if(Al){s[Pl>>2]=RT;$T=(RT|0)==(0|0);if($T){Rl=1<<_l;wl=Rl^-1;Ml=s[(32544+4|0)>>2]|0;Ol=Ml&wl;s[(32544+4|0)>>2]=Ol;break}}else{Dl=s[(32544+16|0)>>2]|0;kl=zo>>>0<Dl>>>0;if(kl){le()}Nl=zo+16|0;xl=s[Nl>>2]|0;Fl=(xl|0)==(BE|0);if(Fl){s[Nl>>2]=RT}else{Ul=zo+20|0;s[Ul>>2]=RT}Vl=(RT|0)==(0|0);if(Vl){break}}Hl=s[(32544+16|0)>>2]|0;Bl=RT>>>0<Hl>>>0;if(Bl){le()}$l=RT+24|0;s[$l>>2]=zo;jl=BE+16|0;Gl=s[jl>>2]|0;Wl=(Gl|0)==(0|0);do{if(!Wl){Kl=Gl>>>0<Hl>>>0;if(Kl){le()}else{Jl=RT+16|0;s[Jl>>2]=Gl;Yl=Gl+24|0;s[Yl>>2]=RT;break}}}while(0);Ql=BE+20|0;Xl=s[Ql>>2]|0;Zl=(Xl|0)==(0|0);if(!Zl){ed=s[(32544+16|0)>>2]|0;td=Xl>>>0<ed>>>0;if(td){le()}else{id=RT+20|0;s[id>>2]=Xl;nd=Xl+24|0;s[nd>>2]=RT;break}}}}while(0);sd=gE>>>0<16;e:do{if(sd){ad=gE+Fs|0;od=ad|3;ld=BE+4|0;s[ld>>2]=od;ye=ad+4|0;dd=BE+ye|0;cd=s[dd>>2]|0;hd=cd|1;s[dd>>2]=hd}else{ud=Fs|3;pd=BE+4|0;s[pd>>2]=ud;gd=gE|1;P=Fs|4;fd=BE+P|0;s[fd>>2]=gd;k=gE+Fs|0;Sd=BE+k|0;s[Sd>>2]=gE;vd=gE>>>3;yd=gE>>>0<256;if(yd){Cd=vd<<1;Td=(32544+(Cd<<2)|0)+40|0;Ed=s[32544>>2]|0;_d=1<<vd;bd=Ed&_d;Pd=(bd|0)==0;do{if(Pd){Ad=Ed|_d;s[32544>>2]=Ad;de=Cd+2|0;a=(32544+(de<<2)|0)+40|0;d=a;mT=Td}else{Se=Cd+2|0;Rd=(32544+(Se<<2)|0)+40|0;wd=s[Rd>>2]|0;Md=s[(32544+16|0)>>2]|0;Od=wd>>>0<Md>>>0;if(!Od){d=Rd;mT=wd;break}le()}}while(0);s[d>>2]=jo;Dd=mT+12|0;s[Dd>>2]=jo;ue=Fs+8|0;kd=BE+ue|0;s[kd>>2]=mT;ge=Fs+12|0;Nd=BE+ge|0;s[Nd>>2]=Td;break}Ld=gE>>>8;xd=(Ld|0)==0;if(xd){vT=0}else{Ud=gE>>>0>16777215;if(Ud){vT=31}else{Vd=Ld+1048320|0;Hd=Vd>>>16;Bd=Hd&8;$d=Ld<<Bd;jd=$d+520192|0;Gd=jd>>>16;Wd=Gd&4;qd=Wd|Bd;zd=$d<<Wd;Jd=zd+245760|0;Yd=Jd>>>16;Qd=Yd&2;Xd=qd|Qd;Zd=14-Xd|0;ec=zd<<Qd;tc=ec>>>15;ic=Zd+tc|0;nc=ic<<1;rc=ic+7|0;ac=gE>>>rc;oc=ac&1;lc=oc|nc;vT=lc}}dc=(32544+(vT<<2)|0)+304|0;Ee=Fs+28|0;cc=BE+Ee|0;s[cc>>2]=vT;Be=Fs+16|0;hc=BE+Be|0;Ye=Fs+20|0;uc=BE+Ye|0;s[uc>>2]=0;s[hc>>2]=0;pc=s[(32544+4|0)>>2]|0;gc=1<<vT;mc=pc&gc;Sc=(mc|0)==0;if(Sc){vc=pc|gc;s[(32544+4|0)>>2]=vc;s[dc>>2]=jo;et=Fs+24|0;yc=BE+et|0;s[yc>>2]=dc;nt=Fs+12|0;Cc=BE+nt|0;s[Cc>>2]=jo;st=Fs+8|0;Tc=BE+st|0;s[Tc>>2]=jo;break}Ec=s[dc>>2]|0;_c=(vT|0)==31;if(_c){Dc=0}else{bc=vT>>>1;Pc=25-bc|0;Dc=Pc}Ic=Ec+4|0;Rc=s[Ic>>2]|0;wc=Rc&-8;Mc=(wc|0)==(gE|0);t:do{if(Mc){DT=Ec}else{Oc=gE<<Dc;CT=Oc;xT=Ec;while(1){Hc=CT>>>31;Bc=(xT+(Hc<<2)|0)+16|0;Lc=s[Bc>>2]|0;$c=(Lc|0)==(0|0);if($c){break}kc=CT<<1;Nc=Lc+4|0;xc=s[Nc>>2]|0;Fc=xc&-8;Vc=(Fc|0)==(gE|0);if(Vc){DT=Lc;break t}else{CT=kc;xT=Lc}}jc=s[(32544+16|0)>>2]|0;Gc=Bc>>>0<jc>>>0;if(Gc){le()}else{s[Bc>>2]=jo;q=Fs+24|0;Wc=BE+q|0;s[Wc>>2]=xT;ie=Fs+12|0;qc=BE+ie|0;s[qc>>2]=jo;re=Fs+8|0;zc=BE+re|0;s[zc>>2]=jo;break e}}}while(0);Kc=DT+8|0;Qc=s[Kc>>2]|0;Xc=s[(32544+16|0)>>2]|0;Zc=DT>>>0>=Xc>>>0;eh=Qc>>>0>=Xc>>>0;iE=Zc&eh;if(iE){th=Qc+12|0;s[th>>2]=jo;s[Kc>>2]=jo;at=Fs+8|0;ih=BE+at|0;s[ih>>2]=Qc;dt=Fs+12|0;nh=BE+dt|0;s[nh>>2]=DT;L=Fs+24|0;rh=BE+L|0;s[rh>>2]=0;break}else{le()}}}while(0);sh=BE+8|0;qT=sh;h=GE;return qT|0}else{zT=Fs}}}}}}while(0);ah=s[(32544+8|0)>>2]|0;lh=ah>>>0<zT>>>0;if(!lh){dh=ah-zT|0;ch=s[(32544+20|0)>>2]|0;hh=dh>>>0>15;if(hh){uh=ch+zT|0;s[(32544+20|0)>>2]=uh;s[(32544+8|0)>>2]=dh;ph=dh|1;Te=zT+4|0;gh=ch+Te|0;s[gh>>2]=ph;mh=ch+ah|0;s[mh>>2]=dh;fh=zT|3;Sh=ch+4|0;s[Sh>>2]=fh}else{s[(32544+8|0)>>2]=0;s[(32544+20|0)>>2]=0;yh=ah|3;Ch=ch+4|0;s[Ch>>2]=yh;R=ah+4|0;Th=ch+R|0;Eh=s[Th>>2]|0;_h=Eh|1;s[Th>>2]=_h}bh=ch+8|0;qT=bh;h=GE;return qT|0}Ph=s[(32544+12|0)>>2]|0;Ih=Ph>>>0>zT>>>0;if(Ih){Ah=Ph-zT|0;s[(32544+12|0)>>2]=Ah;Rh=s[(32544+24|0)>>2]|0;Mh=Rh+zT|0;s[(32544+24|0)>>2]=Mh;Oh=Ah|1;v=zT+4|0;Dh=Rh+v|0;s[Dh>>2]=Oh;kh=zT|3;Nh=Rh+4|0;s[Nh>>2]=kh;Lh=Rh+8|0;qT=Lh;h=GE;return qT|0}xh=s[33016>>2]|0;Fh=(xh|0)==0;do{if(Fh){Uh=oe(30)|0;Vh=Uh+-1|0;Bh=Vh&Uh;$h=(Bh|0)==0;if($h){s[(33016+8|0)>>2]=Uh;s[(33016+4|0)>>2]=Uh;s[(33016+12|0)>>2]=-1;s[(33016+16|0)>>2]=-1;s[(33016+20|0)>>2]=0;s[(32544+444|0)>>2]=0;jh=he(0|0)|0;Gh=jh&-16;Wh=Gh^1431655768;s[33016>>2]=Wh;break}else{le()}}}while(0);qh=zT+48|0;zh=s[(33016+8|0)>>2]|0;Kh=zT+47|0;Jh=zh+Kh|0;Yh=0-zh|0;Xh=Jh&Yh;Zh=Xh>>>0>zT>>>0;if(!Zh){qT=0;h=GE;return qT|0}eu=s[(32544+440|0)>>2]|0;tu=(eu|0)==0;if(!tu){iu=s[(32544+432|0)>>2]|0;nu=iu+Xh|0;ru=nu>>>0<=iu>>>0;su=nu>>>0>eu>>>0;ZT=ru|su;if(ZT){qT=0;h=GE;return qT|0}}au=s[(32544+444|0)>>2]|0;ou=au&4;du=(ou|0)==0;e:do{if(du){cu=s[(32544+24|0)>>2]|0;hu=(cu|0)==(0|0);t:do{if(hu){jE=181}else{yE=32544+448|0;while(1){uu=s[yE>>2]|0;pu=uu>>>0>cu>>>0;if(!pu){gu=yE+4|0;mu=s[gu>>2]|0;fu=uu+mu|0;Su=fu>>>0>cu>>>0;if(Su){break}}vu=yE+8|0;Cu=s[vu>>2]|0;Tu=(Cu|0)==(0|0);if(Tu){jE=181;break t}else{yE=Cu}}Eu=(yE|0)==(0|0);if(Eu){jE=181}else{zu=s[(32544+12|0)>>2]|0;Ku=Jh-zu|0;Ju=Ku&Yh;Yu=Ju>>>0<2147483647;if(Yu){Qu=ce(Ju|0)|0;ep=s[yE>>2]|0;tp=s[gu>>2]|0;ip=ep+tp|0;np=(Qu|0)==(ip|0);if(np){UT=Qu;bE=Ju;jE=190}else{VT=Qu;PE=Ju;jE=191}}else{NE=0}}}}while(0);do{if((jE|0)==181){_u=ce(0)|0;bu=(_u|0)==(-1|0);if(bu){NE=0}else{Pu=_u;Iu=s[(33016+4|0)>>2]|0;Au=Iu+-1|0;Ru=Au&Pu;wu=(Ru|0)==0;if(wu){_E=Xh}else{Ou=Au+Pu|0;Du=0-Iu|0;ku=Ou&Du;Nu=Xh-Pu|0;Lu=Nu+ku|0;_E=Lu}xu=s[(32544+432|0)>>2]|0;Fu=xu+_E|0;Uu=_E>>>0>zT>>>0;Vu=_E>>>0<2147483647;XT=Uu&Vu;if(XT){Hu=s[(32544+440|0)>>2]|0;$u=(Hu|0)==0;if(!$u){ju=Fu>>>0<=xu>>>0;Gu=Fu>>>0>Hu>>>0;tE=ju|Gu;if(tE){NE=0;break}}Wu=ce(_E|0)|0;qu=(Wu|0)==(_u|0);if(qu){UT=_u;bE=_E;jE=190}else{VT=Wu;PE=_E;jE=191}}else{NE=0}}}}while(0);t:do{if((jE|0)==190){rp=(UT|0)==(-1|0);if(rp){NE=bE}else{kE=UT;xE=bE;jE=201;break e}}else if((jE|0)==191){sp=0-PE|0;ap=(VT|0)!=(-1|0);op=PE>>>0<2147483647;aE=ap&op;lp=qh>>>0>PE>>>0;rE=aE&lp;do{if(rE){dp=s[(33016+8|0)>>2]|0;hp=Kh-PE|0;up=hp+dp|0;pp=0-dp|0;gp=up&pp;mp=gp>>>0<2147483647;if(mp){fp=ce(gp|0)|0;Sp=(fp|0)==(-1|0);if(Sp){ce(sp|0)|0;NE=0;break t}else{vp=gp+PE|0;IE=vp;break}}else{IE=PE}}else{IE=PE}}while(0);yp=(VT|0)==(-1|0);if(yp){NE=0}else{kE=VT;xE=IE;jE=201;break e}}}while(0);Cp=s[(32544+444|0)>>2]|0;Ep=Cp|4;s[(32544+444|0)>>2]=Ep;LE=NE;jE=198}else{LE=0;jE=198}}while(0);if((jE|0)==198){_p=Xh>>>0<2147483647;if(_p){bp=ce(Xh|0)|0;Pp=ce(0)|0;Ip=(bp|0)!=(-1|0);Ap=(Pp|0)!=(-1|0);nE=Ip&Ap;Rp=bp>>>0<Pp>>>0;oE=nE&Rp;if(oE){wp=Pp;Mp=bp;Op=wp-Mp|0;kp=zT+40|0;Np=Op>>>0>kp>>>0;ht=Np?Op:LE;if(Np){kE=bp;xE=ht;jE=201}}}}if((jE|0)==201){Lp=s[(32544+432|0)>>2]|0;xp=Lp+xE|0;s[(32544+432|0)>>2]=xp;Fp=s[(32544+436|0)>>2]|0;Up=xp>>>0>Fp>>>0;if(Up){s[(32544+436|0)>>2]=xp}Vp=s[(32544+24|0)>>2]|0;Hp=(Vp|0)==(0|0);e:do{if(Hp){Bp=s[(32544+16|0)>>2]|0;$p=(Bp|0)==(0|0);Gp=kE>>>0<Bp>>>0;lE=$p|Gp;if(lE){s[(32544+16|0)>>2]=kE}s[(32544+448|0)>>2]=kE;s[(32544+452|0)>>2]=xE;s[(32544+460|0)>>2]=0;Wp=s[33016>>2]|0;s[(32544+36|0)>>2]=Wp;s[(32544+32|0)>>2]=-1;GT=0;while(1){qp=GT<<1;zp=(32544+(qp<<2)|0)+40|0;y=qp+3|0;Kp=(32544+(y<<2)|0)+40|0;s[Kp>>2]=zp;M=qp+2|0;Jp=(32544+(M<<2)|0)+40|0;s[Jp>>2]=zp;Yp=GT+1|0;jT=(Yp|0)==32;if(jT){break}else{GT=Yp}}Qp=xE+-40|0;Xp=kE+8|0;Zp=Xp;tg=Zp&7;ig=(tg|0)==0;if(ig){ag=0}else{ng=0-Zp|0;rg=ng&7;ag=rg}sg=kE+ag|0;og=Qp-ag|0;s[(32544+24|0)>>2]=sg;s[(32544+12|0)>>2]=og;lg=og|1;T=ag+4|0;dg=kE+T|0;s[dg>>2]=lg;_e=xE+-36|0;cg=kE+_e|0;s[cg>>2]=40;ug=s[(33016+16|0)>>2]|0;s[(32544+28|0)>>2]=ug}else{TE=32544+448|0;while(1){pg=s[TE>>2]|0;gg=TE+4|0;mg=s[gg>>2]|0;fg=pg+mg|0;Sg=(kE|0)==(fg|0);if(Sg){jE=213;break}vg=TE+8|0;yg=s[vg>>2]|0;Cg=(yg|0)==(0|0);if(Cg){break}else{TE=yg}}if((jE|0)==213){Tg=TE+12|0;_g=s[Tg>>2]|0;bg=_g&8;Pg=(bg|0)==0;if(Pg){Ig=Vp>>>0>=pg>>>0;Ag=Vp>>>0<kE>>>0;sE=Ig&Ag;if(sE){Rg=mg+xE|0;s[gg>>2]=Rg;wg=s[(32544+12|0)>>2]|0;Mg=wg+xE|0;Og=Vp+8|0;Dg=Og;Ng=Dg&7;Lg=(Ng|0)==0;if(Lg){Vg=0}else{xg=0-Dg|0;Fg=xg&7;Vg=Fg}Ug=Vp+Vg|0;Hg=Mg-Vg|0;s[(32544+24|0)>>2]=Ug;s[(32544+12|0)>>2]=Hg;Bg=Hg|1;_=Vg+4|0;$g=Vp+_|0;s[$g>>2]=Bg;Ie=Mg+4|0;jg=Vp+Ie|0;s[jg>>2]=40;Wg=s[(33016+16|0)>>2]|0;s[(32544+28|0)>>2]=Wg;break}}}qg=s[(32544+16|0)>>2]|0;zg=kE>>>0<qg>>>0;if(zg){s[(32544+16|0)>>2]=kE;hf=kE}else{hf=qg}Kg=kE+xE|0;EE=32544+448|0;while(1){Jg=s[EE>>2]|0;Yg=(Jg|0)==(Kg|0);if(Yg){jE=223;break}Qg=EE+8|0;Xg=s[Qg>>2]|0;Zg=(Xg|0)==(0|0);if(Zg){break}else{EE=Xg}}if((jE|0)==223){em=EE+12|0;nm=s[em>>2]|0;rm=nm&8;sm=(rm|0)==0;if(sm){s[EE>>2]=kE;am=EE+4|0;om=s[am>>2]|0;lm=om+xE|0;s[am>>2]=lm;dm=kE+8|0;cm=dm;hm=cm&7;um=(hm|0)==0;if(um){Sm=0}else{gm=0-cm|0;mm=gm&7;Sm=mm}fm=kE+Sm|0;U=xE+8|0;vm=kE+U|0;ym=vm;Cm=ym&7;Tm=(Cm|0)==0;if(Tm){Pm=0}else{Em=0-ym|0;_m=Em&7;Pm=_m}V=Pm+xE|0;Im=kE+V|0;Am=Im;Rm=fm;wm=Am-Rm|0;b=Sm+zT|0;Mm=kE+b|0;Om=wm-zT|0;Dm=zT|3;D=Sm+4|0;km=kE+D|0;s[km>>2]=Dm;Nm=(Im|0)==(Vp|0);t:do{if(Nm){xm=s[(32544+12|0)>>2]|0;Fm=xm+Om|0;s[(32544+12|0)>>2]=Fm;s[(32544+24|0)>>2]=Mm;Um=Fm|1;Ze=b+4|0;Vm=kE+Ze|0;s[Vm>>2]=Um}else{Hm=s[(32544+20|0)>>2]|0;Bm=(Im|0)==(Hm|0);if(Bm){$m=s[(32544+8|0)>>2]|0;jm=$m+Om|0;s[(32544+8|0)>>2]=jm;s[(32544+20|0)>>2]=Mm;Gm=jm|1;Qe=b+4|0;Wm=kE+Qe|0;s[Wm>>2]=Gm;Xe=jm+b|0;zm=kE+Xe|0;s[zm>>2]=jm;break}Ae=xE+4|0;H=Ae+Pm|0;Km=kE+H|0;Jm=s[Km>>2]|0;Ym=Jm&3;Qm=(Ym|0)==1;if(Qm){Xm=Jm&-8;Zm=Jm>>>3;ef=Jm>>>0<256;i:do{if(ef){qe=Pm|8;ee=qe+xE|0;tf=kE+ee|0;nf=s[tf>>2]|0;ze=xE+12|0;te=ze+Pm|0;sf=kE+te|0;af=s[sf>>2]|0;of=Zm<<1;lf=(32544+(of<<2)|0)+40|0;df=(nf|0)==(lf|0);do{if(!df){cf=nf>>>0<hf>>>0;if(cf){le()}uf=nf+12|0;pf=s[uf>>2]|0;gf=(pf|0)==(Im|0);if(gf){break}le()}}while(0);ff=(af|0)==(nf|0);if(ff){Sf=1<<Zm;vf=Sf^-1;yf=s[32544>>2]|0;Cf=yf&vf;s[32544>>2]=Cf;break}Tf=(af|0)==(lf|0);do{if(Tf){m=af+8|0;u=m}else{Ef=af>>>0<hf>>>0;if(Ef){le()}_f=af+8|0;bf=s[_f>>2]|0;Pf=(bf|0)==(Im|0);if(Pf){u=_f;break}le()}}while(0);Af=nf+12|0;s[Af>>2]=af;s[u>>2]=nf}else{Ge=Pm|24;B=Ge+xE|0;Rf=kE+B|0;wf=s[Rf>>2]|0;tt=xE+12|0;$=tt+Pm|0;Mf=kE+$|0;Of=s[Mf>>2]|0;Df=(Of|0)==(Im|0);do{if(Df){rt=Pm|16;X=Ae+rt|0;jf=kE+X|0;Gf=s[jf>>2]|0;Wf=(Gf|0)==(0|0);if(Wf){Z=rt+xE|0;qf=kE+Z|0;zf=s[qf>>2]|0;Jf=(zf|0)==(0|0);if(Jf){AT=0;break}else{bT=zf;MT=qf}}else{bT=Gf;MT=jf}while(1){Yf=bT+20|0;Qf=s[Yf>>2]|0;Xf=(Qf|0)==(0|0);if(!Xf){bT=Qf;MT=Yf;continue}Zf=bT+16|0;eS=s[Zf>>2]|0;tS=(eS|0)==(0|0);if(tS){break}else{bT=eS;MT=Zf}}iS=MT>>>0<hf>>>0;if(iS){le()}else{s[MT>>2]=0;AT=bT;break}}else{We=Pm|8;j=We+xE|0;kf=kE+j|0;Nf=s[kf>>2]|0;Lf=Nf>>>0<hf>>>0;if(Lf){le()}xf=Nf+12|0;Uf=s[xf>>2]|0;Vf=(Uf|0)==(Im|0);if(!Vf){le()}Hf=Of+8|0;Bf=s[Hf>>2]|0;$f=(Bf|0)==(Im|0);if($f){s[xf>>2]=Of;s[Hf>>2]=Nf;AT=Of;break}else{le()}}}while(0);nS=(wf|0)==(0|0);if(nS){break}$e=xE+28|0;G=$e+Pm|0;rS=kE+G|0;oS=s[rS>>2]|0;lS=(32544+(oS<<2)|0)+304|0;dS=s[lS>>2]|0;cS=(Im|0)==(dS|0);do{if(cS){s[lS>>2]=AT;BT=(AT|0)==(0|0);if(!BT){break}hS=1<<oS;uS=hS^-1;pS=s[(32544+4|0)>>2]|0;gS=pS&uS;s[(32544+4|0)>>2]=gS;break i}else{mS=s[(32544+16|0)>>2]|0;fS=wf>>>0<mS>>>0;if(fS){le()}vS=wf+16|0;yS=s[vS>>2]|0;CS=(yS|0)==(Im|0);if(CS){s[vS>>2]=AT}else{TS=wf+20|0;s[TS>>2]=AT}ES=(AT|0)==(0|0);if(ES){break i}}}while(0);_S=s[(32544+16|0)>>2]|0;bS=AT>>>0<_S>>>0;if(bS){le()}PS=AT+24|0;s[PS>>2]=wf;je=Pm|16;W=je+xE|0;IS=kE+W|0;AS=s[IS>>2]|0;wS=(AS|0)==(0|0);do{if(!wS){MS=AS>>>0<_S>>>0;if(MS){le()}else{OS=AT+16|0;s[OS>>2]=AS;DS=AS+24|0;s[DS>>2]=AT;break}}}while(0);J=Ae+je|0;kS=kE+J|0;NS=s[kS>>2]|0;LS=(NS|0)==(0|0);if(LS){break}xS=s[(32544+16|0)>>2]|0;FS=NS>>>0<xS>>>0;if(FS){le()}else{US=AT+20|0;s[US>>2]=NS;HS=NS+24|0;s[HS>>2]=AT;break}}}while(0);ct=Xm|Pm;Y=ct+xE|0;BS=kE+Y|0;$S=Xm+Om|0;KT=BS;dE=$S}else{KT=Im;dE=Om}jS=KT+4|0;GS=s[jS>>2]|0;WS=GS&-2;s[jS>>2]=WS;qS=dE|1;x=b+4|0;zS=kE+x|0;s[zS>>2]=qS;K=dE+b|0;KS=kE+K|0;s[KS>>2]=dE;JS=dE>>>3;QS=dE>>>0<256;if(QS){XS=JS<<1;ZS=(32544+(XS<<2)|0)+40|0;ev=s[32544>>2]|0;tv=1<<JS;iv=ev&tv;nv=(iv|0)==0;do{if(nv){rv=ev|tv;s[32544>>2]=rv;Le=XS+2|0;r=(32544+(Le<<2)|0)+40|0;l=r;gT=ZS}else{Ue=XS+2|0;sv=(32544+(Ue<<2)|0)+40|0;av=s[sv>>2]|0;lv=s[(32544+16|0)>>2]|0;dv=av>>>0<lv>>>0;if(!dv){l=sv;gT=av;break}le()}}while(0);s[l>>2]=Mm;cv=gT+12|0;s[cv>>2]=Mm;xe=b+8|0;hv=kE+xe|0;s[hv>>2]=gT;Fe=b+12|0;uv=kE+Fe|0;s[uv>>2]=ZS;break}pv=dE>>>8;gv=(pv|0)==0;do{if(gv){yT=0}else{mv=dE>>>0>16777215;if(mv){yT=31;break}fv=pv+1048320|0;Sv=fv>>>16;yv=Sv&8;Cv=pv<<yv;Tv=Cv+520192|0;Ev=Tv>>>16;_v=Ev&4;bv=_v|yv;Pv=Cv<<_v;Iv=Pv+245760|0;Av=Iv>>>16;Rv=Av&2;Mv=bv|Rv;Ov=14-Mv|0;Dv=Pv<<Rv;kv=Dv>>>15;Nv=Ov+kv|0;Lv=Nv<<1;xv=Nv+7|0;Fv=dE>>>xv;Uv=Fv&1;Vv=Uv|Lv;yT=Vv}}while(0);Bv=(32544+(yT<<2)|0)+304|0;ne=b+28|0;$v=kE+ne|0;s[$v>>2]=yT;se=b+16|0;jv=kE+se|0;ae=b+20|0;Gv=kE+ae|0;s[Gv>>2]=0;s[jv>>2]=0;Wv=s[(32544+4|0)>>2]|0;qv=1<<yT;zv=Wv&qv;Kv=(zv|0)==0;if(Kv){Jv=Wv|qv;s[(32544+4|0)>>2]=Jv;s[Bv>>2]=Mm;pe=b+24|0;Yv=kE+pe|0;s[Yv>>2]=Bv;fe=b+12|0;Xv=kE+fe|0;s[Xv>>2]=Mm;ve=b+8|0;Zv=kE+ve|0;s[Zv>>2]=Mm;break}ey=s[Bv>>2]|0;ty=(yT|0)==31;if(ty){hy=0}else{iy=yT>>>1;ny=25-iy|0;hy=ny}ry=ey+4|0;sy=s[ry>>2]|0;ay=sy&-8;oy=(ay|0)==(dE|0);i:do{if(oy){NT=ey}else{cy=dE<<hy;ET=cy;FT=ey;while(1){vy=ET>>>31;yy=(FT+(vy<<2)|0)+16|0;gy=s[yy>>2]|0;Ty=(gy|0)==(0|0);if(Ty){break}uy=ET<<1;py=gy+4|0;my=s[py>>2]|0;fy=my&-8;Sy=(fy|0)==(dE|0);if(Sy){NT=gy;break i}else{ET=uy;FT=gy}}Ey=s[(32544+16|0)>>2]|0;_y=yy>>>0<Ey>>>0;if(_y){le()}else{s[yy>>2]=Mm;De=b+24|0;by=kE+De|0;s[by>>2]=FT;ke=b+12|0;Py=kE+ke|0;s[Py>>2]=Mm;Ne=b+8|0;Iy=kE+Ne|0;s[Iy>>2]=Mm;break t}}}while(0);Ay=NT+8|0;Ry=s[Ay>>2]|0;wy=s[(32544+16|0)>>2]|0;My=NT>>>0>=wy>>>0;Dy=Ry>>>0>=wy>>>0;QT=My&Dy;if(QT){ky=Ry+12|0;s[ky>>2]=Mm;s[Ay>>2]=Mm;we=b+8|0;Ny=kE+we|0;s[Ny>>2]=Ry;Me=b+12|0;Ly=kE+Me|0;s[Ly>>2]=NT;Oe=b+24|0;xy=kE+Oe|0;s[xy>>2]=0;break}else{le()}}}while(0);Ce=Sm|8;Fy=kE+Ce|0;qT=Fy;h=GE;return qT|0}}CE=32544+448|0;while(1){Uy=s[CE>>2]|0;Vy=Uy>>>0>Vp>>>0;if(!Vy){Hy=CE+4|0;By=s[Hy>>2]|0;jy=Uy+By|0;Gy=jy>>>0>Vp>>>0;if(Gy){break}}Wy=CE+8|0;qy=s[Wy>>2]|0;CE=qy}E=By+-47|0;O=By+-39|0;zy=Uy+O|0;Ky=zy;Jy=Ky&7;Yy=(Jy|0)==0;if(Yy){eC=0}else{Qy=0-Ky|0;Xy=Qy&7;eC=Xy}Pe=E+eC|0;tC=Uy+Pe|0;iC=Vp+16|0;nC=tC>>>0<iC>>>0;rC=nC?Vp:tC;sC=rC+8|0;aC=xE+-40|0;oC=kE+8|0;lC=oC;dC=lC&7;hC=(dC|0)==0;if(hC){mC=0}else{uC=0-lC|0;pC=uC&7;mC=pC}gC=kE+mC|0;fC=aC-mC|0;s[(32544+24|0)>>2]=gC;s[(32544+12|0)>>2]=fC;SC=fC|1;C=mC+4|0;vC=kE+C|0;s[vC>>2]=SC;be=xE+-36|0;yC=kE+be|0;s[yC>>2]=40;CC=s[(33016+16|0)>>2]|0;s[(32544+28|0)>>2]=CC;EC=rC+4|0;s[EC>>2]=27;s[sC+0>>2]=s[(32544+448|0)+0>>2]|0;s[sC+4>>2]=s[(32544+448|0)+4>>2]|0;s[sC+8>>2]=s[(32544+448|0)+8>>2]|0;s[sC+12>>2]=s[(32544+448|0)+12>>2]|0;s[(32544+448|0)>>2]=kE;s[(32544+452|0)>>2]=xE;s[(32544+460|0)>>2]=0;s[(32544+456|0)>>2]=sC;_C=rC+28|0;s[_C>>2]=7;bC=rC+32|0;PC=bC>>>0<jy>>>0;if(PC){AC=_C;while(1){IC=AC+4|0;s[IC>>2]=7;RC=AC+8|0;wC=RC>>>0<jy>>>0;if(wC){AC=IC}else{break}}}MC=(rC|0)==(Vp|0);if(!MC){OC=rC;kC=Vp;NC=OC-kC|0;LC=Vp+NC|0;He=NC+4|0;xC=Vp+He|0;FC=s[xC>>2]|0;UC=FC&-2;s[xC>>2]=UC;VC=NC|1;HC=Vp+4|0;s[HC>>2]=VC;s[LC>>2]=NC;BC=NC>>>3;$C=NC>>>0<256;if($C){GC=BC<<1;WC=(32544+(GC<<2)|0)+40|0;qC=s[32544>>2]|0;zC=1<<BC;KC=qC&zC;JC=(KC|0)==0;do{if(JC){YC=qC|zC;s[32544>>2]=YC;F=GC+2|0;n=(32544+(F<<2)|0)+40|0;o=n;hT=WC}else{z=GC+2|0;QC=(32544+(z<<2)|0)+40|0;XC=s[QC>>2]|0;ZC=s[(32544+16|0)>>2]|0;tT=XC>>>0<ZC>>>0;if(!tT){o=QC;hT=XC;break}le()}}while(0);s[o>>2]=Vp;iT=hT+12|0;s[iT>>2]=Vp;nT=Vp+8|0;s[nT>>2]=hT;rT=Vp+12|0;s[rT>>2]=WC;break}sT=NC>>>8;aT=(sT|0)==0;if(aT){ST=0}else{oT=NC>>>0>16777215;if(oT){ST=31}else{lT=sT+1048320|0;dT=lT>>>16;cT=dT&8;St=sT<<cT;vt=St+520192|0;yt=vt>>>16;Ct=yt&4;Tt=Ct|cT;Et=St<<Ct;_t=Et+245760|0;bt=_t>>>16;Pt=bt&2;It=Tt|Pt;Rt=14-It|0;wt=Et<<Pt;Mt=wt>>>15;Ot=Rt+Mt|0;Dt=Ot<<1;kt=Ot+7|0;Nt=NC>>>kt;Lt=Nt&1;xt=Lt|Dt;ST=xt}}Ft=(32544+(ST<<2)|0)+304|0;Vt=Vp+28|0;fT=ST;s[Vt>>2]=fT;Ht=Vp+20|0;s[Ht>>2]=0;Bt=Vp+16|0;s[Bt>>2]=0;$t=s[(32544+4|0)>>2]|0;jt=1<<ST;Gt=$t&jt;Wt=(Gt|0)==0;if(Wt){qt=$t|jt;s[(32544+4|0)>>2]=qt;s[Ft>>2]=Vp;zt=Vp+24|0;s[zt>>2]=Ft;Kt=Vp+12|0;s[Kt>>2]=Vp;Yt=Vp+8|0;s[Yt>>2]=Vp;break}Qt=s[Ft>>2]|0;Xt=(ST|0)==31;if(Xt){oi=0}else{Zt=ST>>>1;ei=25-Zt|0;oi=ei}ti=Qt+4|0;ii=s[ti>>2]|0;ni=ii&-8;ri=(ni|0)==(NC|0);t:do{if(ri){kT=Qt}else{si=NC<<oi;TT=si;LT=Qt;while(1){gi=TT>>>31;mi=(LT+(gi<<2)|0)+16|0;ci=s[mi>>2]|0;fi=(ci|0)==(0|0);if(fi){break}li=TT<<1;di=ci+4|0;hi=s[di>>2]|0;ui=hi&-8;pi=(ui|0)==(NC|0);if(pi){kT=ci;break t}else{TT=li;LT=ci}}vi=s[(32544+16|0)>>2]|0;yi=mi>>>0<vi>>>0;if(yi){le()}else{s[mi>>2]=Vp;Ci=Vp+24|0;s[Ci>>2]=LT;Ti=Vp+12|0;s[Ti>>2]=Vp;Ei=Vp+8|0;s[Ei>>2]=Vp;break e}}}while(0);_i=kT+8|0;bi=s[_i>>2]|0;Pi=s[(32544+16|0)>>2]|0;Ii=kT>>>0>=Pi>>>0;Ai=bi>>>0>=Pi>>>0;YT=Ii&Ai;if(YT){wi=bi+12|0;s[wi>>2]=Vp;s[_i>>2]=Vp;Mi=Vp+8|0;s[Mi>>2]=bi;Oi=Vp+12|0;s[Oi>>2]=kT;Di=Vp+24|0;s[Di>>2]=0;break}else{le()}}}}while(0);ki=s[(32544+12|0)>>2]|0;Ni=ki>>>0>zT>>>0;if(Ni){Li=ki-zT|0;s[(32544+12|0)>>2]=Li;xi=s[(32544+24|0)>>2]|0;Fi=xi+zT|0;s[(32544+24|0)>>2]=Fi;Ui=Li|1;I=zT+4|0;Hi=xi+I|0;s[Hi>>2]=Ui;Bi=zT|3;$i=xi+4|0;s[$i>>2]=Bi;ji=xi+8|0;qT=ji;h=GE;return qT|0}}Gi=me()|0;s[Gi>>2]=12;qT=0;h=GE;return qT|0}function ei(e){e=e|0;var t=0,i=0,n=0,r=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0;var _=0,b=0,P=0,I=0,A=0,R=0,w=0,M=0,O=0,D=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0;var j=0,G=0,W=0,q=0,z=0,K=0,J=0,Y=0,Q=0,X=0,Z=0,ee=0,te=0,ie=0,ne=0,re=0,se=0,ae=0,oe=0,de=0;var ce=0,he=0,ue=0,pe=0,ge=0,me=0,fe=0,Se=0,ve=0,ye=0,Ce=0,Te=0,Ee=0,_e=0,be=0,Pe=0,Ie=0,Ae=0,Re=0,we=0;var Me=0,Oe=0,De=0,ke=0,Ne=0,Le=0,xe=0,Fe=0,Ue=0,Ve=0,He=0,Be=0,$e=0,je=0,Ge=0,We=0,qe=0,ze=0,Ke=0,Je=0;var Ye=0,Qe=0,Xe=0,Ze=0,et=0,tt=0,it=0,nt=0,rt=0,st=0,at=0,ot=0,lt=0,dt=0,ct=0,ht=0,ut=0,pt=0,gt=0,mt=0;var ft=0,St=0,vt=0,yt=0,Ct=0,Tt=0,Et=0,_t=0,bt=0,Pt=0,It=0,At=0,Rt=0,wt=0,Mt=0,Ot=0,Dt=0,kt=0,Nt=0,Lt=0;var xt=0,Ft=0,Ut=0,Vt=0,Ht=0,Bt=0,$t=0,jt=0,Gt=0,Wt=0,qt=0,zt=0,Kt=0,Jt=0,Yt=0,Qt=0,Xt=0,Zt=0,ei=0,ti=0;var ii=0,ni=0,ri=0,si=0,ai=0,oi=0,li=0,di=0,ci=0,hi=0,ui=0,pi=0,gi=0,mi=0,fi=0,Si=0,vi=0,yi=0,Ci=0,Ti=0;var Ei=0,_i=0,bi=0,Pi=0,Ii=0,Ai=0,Ri=0,wi=0,Mi=0,Oi=0,Di=0,ki=0,Ni=0,Li=0,xi=0,Fi=0,Ui=0,Vi=0,Hi=0,Bi=0;var $i=0,ji=0,Gi=0,Wi=0,qi=0,zi=0,Ki=0,Ji=0,Yi=0,Qi=0,Xi=0,Zi=0,en=0,tn=0,nn=0,rn=0,sn=0,an=0,on=0,ln=0;var dn=0,cn=0,hn=0,un=0,pn=0,gn=0,mn=0,fn=0,Sn=0,vn=0,yn=0,Cn=0,Tn=0,En=0,_n=0,bn=0,Pn=0,In=0,An=0,Rn=0;var wn=0,Mn=0,On=0,Dn=0,kn=0,Nn=0,Ln=0,xn=0,Fn=0,Un=0,Vn=0,Hn=0,Bn=0,$n=0,jn=0,Gn=0,Wn=0,qn=0,zn=0,Kn=0;var Jn=0,Yn=0,Qn=0,Xn=0,Zn=0,er=0,tr=0,ir=0,nr=0,rr=0,sr=0,ar=0,or=0,lr=0,dr=0,cr=0,hr=0,ur=0,pr=0,gr=0;var mr=0,fr=0,Sr=0,vr=0,yr=0,Cr=0,Tr=0,Er=0,_r=0,br=0,Pr=0,Ir=0,Ar=0,Rr=0,wr=0,Mr=0,Or=0,Dr=0,kr=0,Nr=0;var Lr=0,xr=0,Fr=0,Ur=0,Vr=0,Hr=0,Br=0,$r=0,jr=0,Gr=0,Wr=0,qr=0,zr=0,Kr=0,Jr=0,Yr=0,Qr=0,Xr=0,Zr=0,es=0;var ts=0,is=0,ns=0,rs=0,ss=0,as=0,os=0,ls=0,ds=0,cs=0,hs=0,us=0,ps=0,gs=0,ms=0,fs=0,Ss=0,vs=0,ys=0,Cs=0;var Ts=0,Es=0,_s=0,bs=0,Ps=0,Is=0,As=0,Rs=0,ws=0,Ms=0,Os=0,Ds=0,ks=0,Ns=0,Ls=0,xs=0,Fs=0,Us=0,Vs=0,Hs=0;var Bs=0,$s=0,js=0,Gs=0,Ws=0,qs=0,zs=0,Ks=0,Js=0,Ys=0,Qs=0,Xs=0,Zs=0,ea=0,ta=0;ta=h;N=(e|0)==(0|0);if(N){h=ta;return}L=e+-8|0;Vt=s[(32544+16|0)>>2]|0;jn=L>>>0<Vt>>>0;if(jn){le()}Er=e+-4|0;kr=s[Er>>2]|0;Gr=kr&3;ts=(Gr|0)==1;if(ts){le()}us=kr&-8;l=us+-8|0;_s=e+l|0;x=kr&1;z=(x|0)==0;do{if(z){re=s[L>>2]|0;fe=(Gr|0)==0;if(fe){h=ta;return}g=-8-re|0;Ae=e+g|0;Ue=re+us|0;Je=Ae>>>0<Vt>>>0;if(Je){le()}at=s[(32544+20|0)>>2]|0;St=(Ae|0)==(at|0);if(St){T=us+-4|0;H=e+T|0;B=s[H>>2]|0;$=B&3;j=($|0)==3;if(!j){Js=Ae;Ys=Ue;break}s[(32544+8|0)>>2]=Ue;G=B&-2;s[H>>2]=G;W=Ue|1;v=g+4|0;q=e+v|0;s[q>>2]=W;s[_s>>2]=Ue;h=ta;return}Rt=re>>>3;Ht=re>>>0<256;if(Ht){R=g+8|0;Qt=e+R|0;li=s[Qt>>2]|0;w=g+12|0;yi=e+w|0;Mi=s[yi>>2]|0;Bi=Rt<<1;Xi=(32544+(Bi<<2)|0)+40|0;cn=(li|0)==(Xi|0);if(!cn){Tn=li>>>0<Vt>>>0;if(Tn){le()}Dn=li+12|0;Gn=s[Dn>>2]|0;tr=(Gn|0)==(Ae|0);if(!tr){le()}}ur=(Mi|0)==(li|0);if(ur){mr=1<<Rt;fr=mr^-1;Sr=s[32544>>2]|0;vr=Sr&fr;s[32544>>2]=vr;Js=Ae;Ys=Ue;break}yr=(Mi|0)==(Xi|0);if(yr){o=Mi+8|0;n=o}else{Cr=Mi>>>0<Vt>>>0;if(Cr){le()}Tr=Mi+8|0;_r=s[Tr>>2]|0;br=(_r|0)==(Ae|0);if(br){n=Tr}else{le()}}Pr=li+12|0;s[Pr>>2]=Mi;s[n>>2]=li;Js=Ae;Ys=Ue;break}y=g+24|0;Ir=e+y|0;Ar=s[Ir>>2]|0;C=g+12|0;Rr=e+C|0;wr=s[Rr>>2]|0;Mr=(wr|0)==(Ae|0);do{if(Mr){_=g+20|0;Br=e+_|0;$r=s[Br>>2]|0;jr=($r|0)==(0|0);if(jr){E=g+16|0;Wr=e+E|0;qr=s[Wr>>2]|0;zr=(qr|0)==(0|0);if(zr){Vs=0;break}else{Us=qr;$s=Wr}}else{Us=$r;$s=Br}while(1){Kr=Us+20|0;Jr=s[Kr>>2]|0;Yr=(Jr|0)==(0|0);if(!Yr){Us=Jr;$s=Kr;continue}Qr=Us+16|0;Xr=s[Qr>>2]|0;Zr=(Xr|0)==(0|0);if(Zr){break}else{Us=Xr;$s=Qr}}es=$s>>>0<Vt>>>0;if(es){le()}else{s[$s>>2]=0;Vs=Us;break}}else{A=g+8|0;Or=e+A|0;Dr=s[Or>>2]|0;Nr=Dr>>>0<Vt>>>0;if(Nr){le()}Lr=Dr+12|0;xr=s[Lr>>2]|0;Fr=(xr|0)==(Ae|0);if(!Fr){le()}Ur=wr+8|0;Vr=s[Ur>>2]|0;Hr=(Vr|0)==(Ae|0);if(Hr){s[Lr>>2]=wr;s[Ur>>2]=Dr;Vs=wr;break}else{le()}}}while(0);is=(Ar|0)==(0|0);if(is){Js=Ae;Ys=Ue}else{b=g+28|0;ns=e+b|0;rs=s[ns>>2]|0;ss=(32544+(rs<<2)|0)+304|0;as=s[ss>>2]|0;os=(Ae|0)==(as|0);if(os){s[ss>>2]=Vs;qs=(Vs|0)==(0|0);if(qs){ls=1<<rs;ds=ls^-1;cs=s[(32544+4|0)>>2]|0;hs=cs&ds;s[(32544+4|0)>>2]=hs;Js=Ae;Ys=Ue;break}}else{ps=s[(32544+16|0)>>2]|0;gs=Ar>>>0<ps>>>0;if(gs){le()}ms=Ar+16|0;fs=s[ms>>2]|0;Ss=(fs|0)==(Ae|0);if(Ss){s[ms>>2]=Vs}else{vs=Ar+20|0;s[vs>>2]=Vs}ys=(Vs|0)==(0|0);if(ys){Js=Ae;Ys=Ue;break}}Cs=s[(32544+16|0)>>2]|0;Ts=Vs>>>0<Cs>>>0;if(Ts){le()}Es=Vs+24|0;s[Es>>2]=Ar;P=g+16|0;bs=e+P|0;Ps=s[bs>>2]|0;Is=(Ps|0)==(0|0);do{if(!Is){As=Ps>>>0<Cs>>>0;if(As){le()}else{Rs=Vs+16|0;s[Rs>>2]=Ps;ws=Ps+24|0;s[ws>>2]=Vs;break}}}while(0);I=g+20|0;Ms=e+I|0;Os=s[Ms>>2]|0;Ds=(Os|0)==(0|0);if(Ds){Js=Ae;Ys=Ue}else{ks=s[(32544+16|0)>>2]|0;F=Os>>>0<ks>>>0;if(F){le()}else{U=Vs+20|0;s[U>>2]=Os;V=Os+24|0;s[V>>2]=Vs;Js=Ae;Ys=Ue;break}}}}else{Js=L;Ys=us}}while(0);K=Js>>>0<_s>>>0;if(!K){le()}S=us+-4|0;J=e+S|0;Y=s[J>>2]|0;Q=Y&1;X=(Q|0)==0;if(X){le()}Z=Y&2;ee=(Z|0)==0;if(ee){te=s[(32544+24|0)>>2]|0;ie=(_s|0)==(te|0);if(ie){ne=s[(32544+12|0)>>2]|0;se=ne+Ys|0;s[(32544+12|0)>>2]=se;s[(32544+24|0)>>2]=Js;ae=se|1;oe=Js+4|0;s[oe>>2]=ae;de=s[(32544+20|0)>>2]|0;ce=(Js|0)==(de|0);if(!ce){h=ta;return}s[(32544+20|0)>>2]=0;s[(32544+8|0)>>2]=0;h=ta;return}he=s[(32544+20|0)>>2]|0;ue=(_s|0)==(he|0);if(ue){pe=s[(32544+8|0)>>2]|0;ge=pe+Ys|0;s[(32544+8|0)>>2]=ge;s[(32544+20|0)>>2]=Js;me=ge|1;Se=Js+4|0;s[Se>>2]=me;ve=Js+ge|0;s[ve>>2]=ge;h=ta;return}ye=Y&-8;Ce=ye+Ys|0;Te=Y>>>3;Ee=Y>>>0<256;do{if(Ee){_e=e+us|0;be=s[_e>>2]|0;f=us|4;Pe=e+f|0;Ie=s[Pe>>2]|0;Re=Te<<1;we=(32544+(Re<<2)|0)+40|0;Me=(be|0)==(we|0);if(!Me){Oe=s[(32544+16|0)>>2]|0;De=be>>>0<Oe>>>0;if(De){le()}ke=be+12|0;Ne=s[ke>>2]|0;Le=(Ne|0)==(_s|0);if(!Le){le()}}xe=(Ie|0)==(be|0);if(xe){Fe=1<<Te;Ve=Fe^-1;He=s[32544>>2]|0;Be=He&Ve;s[32544>>2]=Be;break}$e=(Ie|0)==(we|0);if($e){a=Ie+8|0;i=a}else{je=s[(32544+16|0)>>2]|0;Ge=Ie>>>0<je>>>0;if(Ge){le()}We=Ie+8|0;qe=s[We>>2]|0;ze=(qe|0)==(_s|0);if(ze){i=We}else{le()}}Ke=be+12|0;s[Ke>>2]=Ie;s[i>>2]=be}else{M=us+16|0;Ye=e+M|0;Qe=s[Ye>>2]|0;O=us|4;Xe=e+O|0;Ze=s[Xe>>2]|0;et=(Ze|0)==(_s|0);do{if(et){k=us+12|0;ut=e+k|0;pt=s[ut>>2]|0;gt=(pt|0)==(0|0);if(gt){D=us+8|0;mt=e+D|0;ft=s[mt>>2]|0;vt=(ft|0)==(0|0);if(vt){Bs=0;break}else{Hs=ft;js=mt}}else{Hs=pt;js=ut}while(1){yt=Hs+20|0;Ct=s[yt>>2]|0;Tt=(Ct|0)==(0|0);if(!Tt){Hs=Ct;js=yt;continue}Et=Hs+16|0;_t=s[Et>>2]|0;bt=(_t|0)==(0|0);if(bt){break}else{Hs=_t;js=Et}}Pt=s[(32544+16|0)>>2]|0;It=js>>>0<Pt>>>0;if(It){le()}else{s[js>>2]=0;Bs=Hs;break}}else{tt=e+us|0;it=s[tt>>2]|0;nt=s[(32544+16|0)>>2]|0;rt=it>>>0<nt>>>0;if(rt){le()}st=it+12|0;ot=s[st>>2]|0;lt=(ot|0)==(_s|0);if(!lt){le()}dt=Ze+8|0;ct=s[dt>>2]|0;ht=(ct|0)==(_s|0);if(ht){s[st>>2]=Ze;s[dt>>2]=it;Bs=Ze;break}else{le()}}}while(0);At=(Qe|0)==(0|0);if(!At){u=us+20|0;wt=e+u|0;Mt=s[wt>>2]|0;Ot=(32544+(Mt<<2)|0)+304|0;Dt=s[Ot>>2]|0;kt=(_s|0)==(Dt|0);if(kt){s[Ot>>2]=Bs;zs=(Bs|0)==(0|0);if(zs){Nt=1<<Mt;Lt=Nt^-1;xt=s[(32544+4|0)>>2]|0;Ft=xt&Lt;s[(32544+4|0)>>2]=Ft;break}}else{Ut=s[(32544+16|0)>>2]|0;Bt=Qe>>>0<Ut>>>0;if(Bt){le()}$t=Qe+16|0;jt=s[$t>>2]|0;Gt=(jt|0)==(_s|0);if(Gt){s[$t>>2]=Bs}else{Wt=Qe+20|0;s[Wt>>2]=Bs}qt=(Bs|0)==(0|0);if(qt){break}}zt=s[(32544+16|0)>>2]|0;Kt=Bs>>>0<zt>>>0;if(Kt){le()}Jt=Bs+24|0;s[Jt>>2]=Qe;p=us+8|0;Yt=e+p|0;Xt=s[Yt>>2]|0;Zt=(Xt|0)==(0|0);do{if(!Zt){ei=Xt>>>0<zt>>>0;if(ei){le()}else{ti=Bs+16|0;s[ti>>2]=Xt;ii=Xt+24|0;s[ii>>2]=Bs;break}}}while(0);m=us+12|0;ni=e+m|0;ri=s[ni>>2]|0;si=(ri|0)==(0|0);if(!si){ai=s[(32544+16|0)>>2]|0;oi=ri>>>0<ai>>>0;if(oi){le()}else{di=Bs+20|0;s[di>>2]=ri;ci=ri+24|0;s[ci>>2]=Bs;break}}}}}while(0);hi=Ce|1;ui=Js+4|0;s[ui>>2]=hi;pi=Js+Ce|0;s[pi>>2]=Ce;gi=s[(32544+20|0)>>2]|0;mi=(Js|0)==(gi|0);if(mi){s[(32544+8|0)>>2]=Ce;h=ta;return}else{Qs=Ce}}else{fi=Y&-2;s[J>>2]=fi;Si=Ys|1;vi=Js+4|0;s[vi>>2]=Si;Ci=Js+Ys|0;s[Ci>>2]=Ys;Qs=Ys}Ti=Qs>>>3;Ei=Qs>>>0<256;if(Ei){_i=Ti<<1;bi=(32544+(_i<<2)|0)+40|0;Pi=s[32544>>2]|0;Ii=1<<Ti;Ai=Pi&Ii;Ri=(Ai|0)==0;if(Ri){wi=Pi|Ii;s[32544>>2]=wi;d=_i+2|0;t=(32544+(d<<2)|0)+40|0;r=t;Ns=bi}else{c=_i+2|0;Oi=(32544+(c<<2)|0)+40|0;Di=s[Oi>>2]|0;ki=s[(32544+16|0)>>2]|0;Ni=Di>>>0<ki>>>0;if(Ni){le()}else{r=Oi;Ns=Di}}s[r>>2]=Js;Li=Ns+12|0;s[Li>>2]=Js;xi=Js+8|0;s[xi>>2]=Ns;Fi=Js+12|0;s[Fi>>2]=bi;h=ta;return}Ui=Qs>>>8;Vi=(Ui|0)==0;if(Vi){Ls=0}else{Hi=Qs>>>0>16777215;if(Hi){Ls=31}else{$i=Ui+1048320|0;ji=$i>>>16;Gi=ji&8;Wi=Ui<<Gi;qi=Wi+520192|0;zi=qi>>>16;Ki=zi&4;Ji=Ki|Gi;Yi=Wi<<Ki;Qi=Yi+245760|0;Zi=Qi>>>16;en=Zi&2;tn=Ji|en;nn=14-tn|0;rn=Yi<<en;sn=rn>>>15;an=nn+sn|0;on=an<<1;ln=an+7|0;dn=Qs>>>ln;hn=dn&1;un=hn|on;Ls=un}}pn=(32544+(Ls<<2)|0)+304|0;gn=Js+28|0;xs=Ls;s[gn>>2]=xs;mn=Js+20|0;s[mn>>2]=0;fn=Js+16|0;s[fn>>2]=0;Sn=s[(32544+4|0)>>2]|0;vn=1<<Ls;yn=Sn&vn;Cn=(yn|0)==0;e:do{if(Cn){En=Sn|vn;s[(32544+4|0)>>2]=En;s[pn>>2]=Js;_n=Js+24|0;s[_n>>2]=pn;bn=Js+12|0;s[bn>>2]=Js;Pn=Js+8|0;s[Pn>>2]=Js}else{In=s[pn>>2]|0;An=(Ls|0)==31;if(An){xn=0}else{Rn=Ls>>>1;wn=25-Rn|0;xn=wn}Mn=In+4|0;On=s[Mn>>2]|0;kn=On&-8;Nn=(kn|0)==(Qs|0);t:do{if(Nn){Gs=In}else{Ln=Qs<<xn;Fs=Ln;Ws=In;while(1){Wn=Fs>>>31;qn=(Ws+(Wn<<2)|0)+16|0;Vn=s[qn>>2]|0;zn=(Vn|0)==(0|0);if(zn){break}Fn=Fs<<1;Un=Vn+4|0;Hn=s[Un>>2]|0;Bn=Hn&-8;$n=(Bn|0)==(Qs|0);if($n){Gs=Vn;break t}else{Fs=Fn;Ws=Vn}}Kn=s[(32544+16|0)>>2]|0;Jn=qn>>>0<Kn>>>0;if(Jn){le()}else{s[qn>>2]=Js;Yn=Js+24|0;s[Yn>>2]=Ws;Qn=Js+12|0;s[Qn>>2]=Js;Xn=Js+8|0;s[Xn>>2]=Js;break e}}}while(0);Zn=Gs+8|0;er=s[Zn>>2]|0;ir=s[(32544+16|0)>>2]|0;nr=Gs>>>0>=ir>>>0;rr=er>>>0>=ir>>>0;Ks=nr&rr;if(Ks){sr=er+12|0;s[sr>>2]=Js;s[Zn>>2]=Js;ar=Js+8|0;s[ar>>2]=er;or=Js+12|0;s[or>>2]=Gs;lr=Js+24|0;s[lr>>2]=0;break}else{le()}}}while(0);dr=s[(32544+32|0)>>2]|0;cr=dr+-1|0;s[(32544+32|0)>>2]=cr;hr=(cr|0)==0;if(hr){Zs=32544+456|0}else{h=ta;return}while(1){Xs=s[Zs>>2]|0;pr=(Xs|0)==(0|0);gr=Xs+8|0;if(pr){break}else{Zs=gr}}s[(32544+32|0)>>2]=-1;h=ta;return}function ti(){}function ii(e,t,i){e=e|0;t=t|0;i=i|0;var n=0;if((i|0)<32){n=(1<<i)-1|0;D=t>>i;return e>>>i|(t&n)<<32-i}D=(t|0)<0?-1:0;return t>>i-32|0}function ni(e,t,i,n){e=e|0;t=t|0;i=i|0;n=n|0;var r=0,s=0;r=e-i>>>0;s=t-n>>>0;s=t-n-(i>>>0>e>>>0|0)>>>0;return(D=s,r|0)|0}function ri(e,t,i,n){e=e|0;t=t|0;i=i|0;n=n|0;var r=0,s=0;r=e+i>>>0;s=t+n+(r>>>0<e>>>0|0)>>>0;return(D=s,r|0)|0}function si(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,a=0,o=0,l=0;r=e+i|0;if((i|0)>=20){t=t&255;l=e&3;a=t|t<<8|t<<16|t<<24;o=r&~3;if(l){l=e+4-l|0;while((e|0)<(l|0)){n[e>>0]=t;e=e+1|0}}while((e|0)<(o|0)){s[e>>2]=a;e=e+4|0}}while((e|0)<(r|0)){n[e>>0]=t;e=e+1|0}return e-i|0}function ai(e,t,i){e=e|0;t=t|0;i=i|0;var n=0;if((i|0)<32){n=(1<<i)-1|0;D=t>>>i;return e>>>i|(t&n)<<32-i}D=0;return t>>>i-32|0}function oi(e,t,i){e=e|0;t=t|0;i=i|0;var n=0;if((i|0)<32){n=(1<<i)-1|0;D=t<<i|(e&n<<32-i)>>>32-i;return e<<i}D=e<<i-32;return 0}function li(e){e=e|0;var t=0;t=e;while(n[t>>0]|0){t=t+1|0}return t-e|0}function di(e,t,i){e=e|0;t=t|0;i=i|0;var r=0;if((i|0)>=4096)return pe(e|0,t|0,i|0)|0;r=e|0;if((e&3)==(t&3)){while(e&3){if((i|0)==0)return r|0;n[e>>0]=n[t>>0]|0;e=e+1|0;t=t+1|0;i=i-1|0}while((i|0)>=4){s[e>>2]=s[t>>2]|0;e=e+4|0;t=t+4|0;i=i-4|0}}while((i|0)>0){n[e>>0]=n[t>>0]|0;e=e+1|0;t=t+1|0;i=i-1|0}return r|0}function ci(e,t,i){e=e|0;t=t|0;i=i|0;var r=0;if((t|0)<(e|0)&(e|0)<(t+i|0)){r=e;t=t+i|0;e=e+i|0;while((i|0)>0){e=e-1|0;t=t-1|0;i=i-1|0;n[e>>0]=n[t>>0]|0}e=r}else{di(e,t,i)|0}return e|0}function hi(e){e=e|0;var t=0;t=n[f+(e>>>24)>>0]|0;if((t|0)<8)return t|0;t=n[f+(e>>16&255)>>0]|0;if((t|0)<8)return t+8|0;t=n[f+(e>>8&255)>>0]|0;if((t|0)<8)return t+16|0;return(n[f+(e&255)>>0]|0)+24|0}function ui(e){e=e|0;var t=0;t=n[m+(e&255)>>0]|0;if((t|0)<8)return t|0;t=n[m+(e>>8&255)>>0]|0;if((t|0)<8)return t+8|0;t=n[m+(e>>16&255)>>0]|0;if((t|0)<8)return t+16|0;return(n[m+(e>>>24)>>0]|0)+24|0}function pi(e,t){e=e|0;t=t|0;var i=0,n=0,r=0,s=0,a=0,o=0,l=0;i=e&65535;n=t&65535;r=ie(n,i)|0;s=e>>>16;a=(r>>>16)+(ie(n,s)|0)|0;o=t>>>16;l=ie(o,i)|0;return(D=((a>>>16)+(ie(o,s)|0)|0)+(((a&65535)+l|0)>>>16)|0,0|(a+l<<16|r&65535))|0}function gi(e,t,i,n){e=e|0;t=t|0;i=i|0;n=n|0;var r=0,s=0,a=0,o=0,l=0,d=0,c=0,h=0,u=0,p=0,g=0;r=t>>31|((t|0)<0?-1:0)<<1;s=((t|0)<0?-1:0)>>31|((t|0)<0?-1:0)<<1;a=n>>31|((n|0)<0?-1:0)<<1;o=((n|0)<0?-1:0)>>31|((n|0)<0?-1:0)<<1;l=ni(r^e,s^t,r,s)|0;d=D;c=ni(a^i,o^n,a,o)|0;h=a^r;u=o^s;p=yi(l,d,c,D,0)|0;g=ni(p^h,D^u,h,u)|0;return(D=D,g)|0}function mi(e,t,i,n){e=e|0;t=t|0;i=i|0;n=n|0;var r=0,a=0,o=0,l=0,d=0,c=0,u=0,p=0,g=0,m=0,f=0;f=h;h=h+8|0;r=f|0;a=t>>31|((t|0)<0?-1:0)<<1;o=((t|0)<0?-1:0)>>31|((t|0)<0?-1:0)<<1;l=n>>31|((n|0)<0?-1:0)<<1;d=((n|0)<0?-1:0)>>31|((n|0)<0?-1:0)<<1;c=ni(a^e,o^t,a,o)|0;u=D;p=ni(l^i,d^n,l,d)|0;yi(c,u,p,D,r)|0;g=ni(s[r>>2]^a,s[r+4>>2]^o,a,o)|0;m=D;h=f;return(D=m,g)|0}function fi(e,t,i,n){e=e|0;t=t|0;i=i|0;n=n|0;var r=0,s=0,a=0,o=0,l=0;r=e;s=i;a=pi(r,s)|0;o=D;l=ie(t,s)|0;return(D=((ie(n,r)|0)+l|0)+o|o&0,0|a&-1)|0}function Si(e,t,i,n){e=e|0;t=t|0;i=i|0;n=n|0;var r=0;r=yi(e,t,i,n,0)|0;return(D=D,r)|0}function vi(e,t,i,n){e=e|0;t=t|0;i=i|0;n=n|0;var r=0,a=0;a=h;h=h+8|0;r=a|0;yi(e,t,i,n,r)|0;h=a;return(D=s[r+4>>2]|0,s[r>>2]|0)|0}function yi(e,t,i,n,r){e=e|0;t=t|0;i=i|0;n=n|0;r=r|0;var a=0,o=0,l=0,d=0,c=0,h=0,u=0,p=0,g=0,m=0,f=0,S=0,v=0,y=0,C=0,T=0,E=0,_=0,b=0,P=0,I=0,A=0,R=0,w=0,M=0,O=0,k=0,N=0,L=0,x=0,F=0,U=0,V=0,H=0,B=0,$=0,j=0,G=0,W=0,q=0,z=0,K=0,J=0,Y=0,Q=0,X=0,Z=0,ee=0,te=0,ie=0,ne=0,re=0,se=0,ae=0,oe=0,le=0,de=0,ce=0,he=0,ue=0,pe=0,ge=0,me=0,fe=0;a=e;o=t;l=o;d=i;c=n;h=c;if((l|0)==0){u=(r|0)!=0;if((h|0)==0){if(u){s[r>>2]=(a>>>0)%(d>>>0);s[r+4>>2]=0}fe=0;me=(a>>>0)/(d>>>0)>>>0;return(D=fe,me)|0}else{if(!u){fe=0;me=0;return(D=fe,me)|0}s[r>>2]=e&-1;s[r+4>>2]=t&0;fe=0;me=0;return(D=fe,me)|0}}p=(h|0)==0;do{if((d|0)==0){if(p){if((r|0)!=0){s[r>>2]=(l>>>0)%(d>>>0);s[r+4>>2]=0}fe=0;me=(l>>>0)/(d>>>0)>>>0;return(D=fe,me)|0}if((a|0)==0){if((r|0)!=0){s[r>>2]=0;s[r+4>>2]=(l>>>0)%(h>>>0)}fe=0;me=(l>>>0)/(h>>>0)>>>0;return(D=fe,me)|0}g=h-1|0;if((g&h|0)==0){if((r|0)!=0){s[r>>2]=0|e&-1;s[r+4>>2]=g&l|t&0}fe=0;me=l>>>((ui(h|0)|0)>>>0);return(D=fe,me)|0}m=hi(h|0)|0;f=m-(hi(l|0)|0)|0;if(f>>>0<=30){S=f+1|0;v=31-f|0;U=S;F=l<<v|a>>>(S>>>0);x=l>>>(S>>>0);L=0;N=a<<v;break}if((r|0)==0){fe=0;me=0;return(D=fe,me)|0}s[r>>2]=0|e&-1;s[r+4>>2]=o|t&0;fe=0;me=0;return(D=fe,me)|0}else{if(!p){R=hi(h|0)|0;w=R-(hi(l|0)|0)|0;if(w>>>0<=31){M=w+1|0;O=31-w|0;k=w-31>>31;U=M;F=a>>>(M>>>0)&k|l<<O;x=l>>>(M>>>0)&k;L=0;N=a<<O;break}if((r|0)==0){fe=0;me=0;return(D=fe,me)|0}s[r>>2]=0|e&-1;s[r+4>>2]=o|t&0;fe=0;me=0;return(D=fe,me)|0}y=d-1|0;if((y&d|0)!=0){T=(hi(d|0)|0)+33|0;E=T-(hi(l|0)|0)|0;_=64-E|0;b=32-E|0;P=b>>31;I=E-32|0;A=I>>31;U=E;F=b-1>>31&l>>>(I>>>0)|(l<<b|a>>>(E>>>0))&A;x=A&l>>>(E>>>0);L=a<<_&P;N=(l<<_|a>>>(I>>>0))&P|a<<b&E-33>>31;break}if((r|0)!=0){s[r>>2]=y&a;s[r+4>>2]=0}if((d|0)==1){fe=o|t&0;me=0|e&-1;return(D=fe,me)|0}else{C=ui(d|0)|0;fe=0|l>>>(C>>>0);me=l<<32-C|a>>>(C>>>0)|0;return(D=fe,me)|0}}}while(0);if((U|0)==0){he=N;ce=L;de=x;le=F;oe=0;ae=0}else{V=0|i&-1;H=c|n&0;B=ri(V,H,-1,-1)|0;$=D;K=N;z=L;q=x;W=F;G=U;j=0;while(1){J=z>>>31|K<<1;Y=j|z<<1;Q=0|(W<<1|K>>>31);X=W>>>31|q<<1|0;ni(B,$,Q,X)|0;Z=D;ee=Z>>31|((Z|0)<0?-1:0)<<1;te=ee&1;ie=ni(Q,X,ee&V,(((Z|0)<0?-1:0)>>31|((Z|0)<0?-1:0)<<1)&H)|0;ne=ie;re=D;se=G-1|0;if((se|0)==0){break}else{K=J;z=Y;q=re;W=ne;G=se;j=te}}he=J;ce=Y;de=re;le=ne;oe=0;ae=te}ue=ce;pe=0;ge=he|pe;if((r|0)!=0){s[r>>2]=0|le;s[r+4>>2]=de|0}fe=(0|ue)>>>31|ge<<1|(pe<<1|ue>>>31)&0|oe;me=(ue<<1|0>>>31)&-2|ae;return(D=fe,me)|0}return{_curve25519_verify:Ae,_crypto_sign_ed25519_ref10_ge_scalarmult_base:Mt,_curve25519_sign:Ie,_free:ei,_i64Add:ri,_memmove:ci,_bitshift64Ashr:ii,_sph_sha512_init:Gt,_curve25519_donna:Me,_memset:si,_malloc:Zt,_memcpy:di,_strlen:li,_bitshift64Lshr:ai,_i64Subtract:ni,_bitshift64Shl:oi,runPostSets:ti,stackAlloc:Se,stackSave:ve,stackRestore:ye,setThrew:Ce,setTempRet0:_e,getTempRet0:be}}(Module.asmGlobalArg,Module.asmLibraryArg,buffer),_curve25519_verify=Module._curve25519_verify=asm._curve25519_verify,_crypto_sign_ed25519_ref10_ge_scalarmult_base=Module._crypto_sign_ed25519_ref10_ge_scalarmult_base=asm._crypto_sign_ed25519_ref10_ge_scalarmult_base,_curve25519_sign=Module._curve25519_sign=asm._curve25519_sign,_free=Module._free=asm._free,_i64Add=Module._i64Add=asm._i64Add,_memmove=Module._memmove=asm._memmove,_bitshift64Ashr=Module._bitshift64Ashr=asm._bitshift64Ashr,_sph_sha512_init=Module._sph_sha512_init=asm._sph_sha512_init,_curve25519_donna=Module._curve25519_donna=asm._curve25519_donna,_memset=Module._memset=asm._memset,_malloc=Module._malloc=asm._malloc,_memcpy=Module._memcpy=asm._memcpy,_strlen=Module._strlen=asm._strlen,_bitshift64Lshr=Module._bitshift64Lshr=asm._bitshift64Lshr,_i64Subtract=Module._i64Subtract=asm._i64Subtract,_bitshift64Shl=Module._bitshift64Shl=asm._bitshift64Shl,runPostSets=Module.runPostSets=asm.runPostSets;Runtime.stackAlloc=asm.stackAlloc,Runtime.stackSave=asm.stackSave,Runtime.stackRestore=asm.stackRestore,Runtime.setTempRet0=asm.setTempRet0,Runtime.getTempRet0=asm.getTempRet0;var i64Math=function(){var e={math:{}};e.math.Long=function(e,t){this.low_=0|e,this.high_=0|t},e.math.Long.IntCache_={},e.math.Long.fromInt=function(t){if(-128<=t&&t<128){var i=e.math.Long.IntCache_[t];if(i)return i}var n=new e.math.Long(0|t,t<0?-1:0);return-128<=t&&t<128&&(e.math.Long.IntCache_[t]=n),n},e.math.Long.fromNumber=function(t){return isNaN(t)||!isFinite(t)?e.math.Long.ZERO:t<=-e.math.Long.TWO_PWR_63_DBL_?e.math.Long.MIN_VALUE:t+1>=e.math.Long.TWO_PWR_63_DBL_?e.math.Long.MAX_VALUE:t<0?e.math.Long.fromNumber(-t).negate():new e.math.Long(t%e.math.Long.TWO_PWR_32_DBL_|0,t/e.math.Long.TWO_PWR_32_DBL_|0)},e.math.Long.fromBits=function(t,i){return new e.math.Long(t,i)},e.math.Long.fromString=function(t,i){if(0==t.length)throw Error("number format error: empty string");var n=i||10;if(n<2||36<n)throw Error("radix out of range: "+n);if("-"==t.charAt(0))return e.math.Long.fromString(t.substring(1),n).negate();if(t.indexOf("-")>=0)throw Error('number format error: interior "-" character: '+t);for(var r=e.math.Long.fromNumber(Math.pow(n,8)),s=e.math.Long.ZERO,a=0;a<t.length;a+=8){var o=Math.min(8,t.length-a),l=parseInt(t.substring(a,a+o),n);if(o<8){var d=e.math.Long.fromNumber(Math.pow(n,o));s=s.multiply(d).add(e.math.Long.fromNumber(l))}else s=(s=s.multiply(r)).add(e.math.Long.fromNumber(l))}return s},e.math.Long.TWO_PWR_16_DBL_=65536,e.math.Long.TWO_PWR_24_DBL_=1<<24,e.math.Long.TWO_PWR_32_DBL_=e.math.Long.TWO_PWR_16_DBL_*e.math.Long.TWO_PWR_16_DBL_,e.math.Long.TWO_PWR_31_DBL_=e.math.Long.TWO_PWR_32_DBL_/2,e.math.Long.TWO_PWR_48_DBL_=e.math.Long.TWO_PWR_32_DBL_*e.math.Long.TWO_PWR_16_DBL_,e.math.Long.TWO_PWR_64_DBL_=e.math.Long.TWO_PWR_32_DBL_*e.math.Long.TWO_PWR_32_DBL_,e.math.Long.TWO_PWR_63_DBL_=e.math.Long.TWO_PWR_64_DBL_/2,e.math.Long.ZERO=e.math.Long.fromInt(0),e.math.Long.ONE=e.math.Long.fromInt(1),e.math.Long.NEG_ONE=e.math.Long.fromInt(-1),e.math.Long.MAX_VALUE=e.math.Long.fromBits(-1,2147483647),e.math.Long.MIN_VALUE=e.math.Long.fromBits(0,-2147483648),e.math.Long.TWO_PWR_24_=e.math.Long.fromInt(1<<24),e.math.Long.prototype.toInt=function(){return this.low_},e.math.Long.prototype.toNumber=function(){return this.high_*e.math.Long.TWO_PWR_32_DBL_+this.getLowBitsUnsigned()},e.math.Long.prototype.toString=function(t){var i=t||10;if(i<2||36<i)throw Error("radix out of range: "+i);if(this.isZero())return"0";if(this.isNegative()){if(this.equals(e.math.Long.MIN_VALUE)){var n=e.math.Long.fromNumber(i),r=this.div(n),s=r.multiply(n).subtract(this);return r.toString(i)+s.toInt().toString(i)}return"-"+this.negate().toString(i)}for(var a=e.math.Long.fromNumber(Math.pow(i,6)),o=(s=this,"");;){var l=s.div(a),d=s.subtract(l.multiply(a)).toInt().toString(i);if((s=l).isZero())return d+o;for(;d.length<6;)d="0"+d;o=""+d+o}},e.math.Long.prototype.getHighBits=function(){return this.high_},e.math.Long.prototype.getLowBits=function(){return this.low_},e.math.Long.prototype.getLowBitsUnsigned=function(){return this.low_>=0?this.low_:e.math.Long.TWO_PWR_32_DBL_+this.low_},e.math.Long.prototype.getNumBitsAbs=function(){if(this.isNegative())return this.equals(e.math.Long.MIN_VALUE)?64:this.negate().getNumBitsAbs();for(var t=0!=this.high_?this.high_:this.low_,i=31;i>0&&0==(t&1<<i);i--);return 0!=this.high_?i+33:i+1},e.math.Long.prototype.isZero=function(){return 0==this.high_&&0==this.low_},e.math.Long.prototype.isNegative=function(){return this.high_<0},e.math.Long.prototype.isOdd=function(){return 1==(1&this.low_)},e.math.Long.prototype.equals=function(e){return this.high_==e.high_&&this.low_==e.low_},e.math.Long.prototype.notEquals=function(e){return this.high_!=e.high_||this.low_!=e.low_},e.math.Long.prototype.lessThan=function(e){return this.compare(e)<0},e.math.Long.prototype.lessThanOrEqual=function(e){return this.compare(e)<=0},e.math.Long.prototype.greaterThan=function(e){return this.compare(e)>0},e.math.Long.prototype.greaterThanOrEqual=function(e){return this.compare(e)>=0},e.math.Long.prototype.compare=function(e){if(this.equals(e))return 0;var t=this.isNegative(),i=e.isNegative();return t&&!i?-1:!t&&i?1:this.subtract(e).isNegative()?-1:1},e.math.Long.prototype.negate=function(){return this.equals(e.math.Long.MIN_VALUE)?e.math.Long.MIN_VALUE:this.not().add(e.math.Long.ONE)},e.math.Long.prototype.add=function(t){var i=this.high_>>>16,n=65535&this.high_,r=this.low_>>>16,s=65535&this.low_,a=t.high_>>>16,o=65535&t.high_,l=t.low_>>>16,d=0,c=0,h=0,u=0;return h+=(u+=s+(65535&t.low_))>>>16,u&=65535,c+=(h+=r+l)>>>16,h&=65535,d+=(c+=n+o)>>>16,c&=65535,d+=i+a,d&=65535,e.math.Long.fromBits(h<<16|u,d<<16|c)},e.math.Long.prototype.subtract=function(e){return this.add(e.negate())},e.math.Long.prototype.multiply=function(t){if(this.isZero())return e.math.Long.ZERO;if(t.isZero())return e.math.Long.ZERO;if(this.equals(e.math.Long.MIN_VALUE))return t.isOdd()?e.math.Long.MIN_VALUE:e.math.Long.ZERO;if(t.equals(e.math.Long.MIN_VALUE))return this.isOdd()?e.math.Long.MIN_VALUE:e.math.Long.ZERO;if(this.isNegative())return t.isNegative()?this.negate().multiply(t.negate()):this.negate().multiply(t).negate();if(t.isNegative())return this.multiply(t.negate()).negate();if(this.lessThan(e.math.Long.TWO_PWR_24_)&&t.lessThan(e.math.Long.TWO_PWR_24_))return e.math.Long.fromNumber(this.toNumber()*t.toNumber());var i=this.high_>>>16,n=65535&this.high_,r=this.low_>>>16,s=65535&this.low_,a=t.high_>>>16,o=65535&t.high_,l=t.low_>>>16,d=65535&t.low_,c=0,h=0,u=0,p=0;return u+=(p+=s*d)>>>16,p&=65535,h+=(u+=r*d)>>>16,u&=65535,h+=(u+=s*l)>>>16,u&=65535,c+=(h+=n*d)>>>16,h&=65535,c+=(h+=r*l)>>>16,h&=65535,c+=(h+=s*o)>>>16,h&=65535,c+=i*d+n*l+r*o+s*a,c&=65535,e.math.Long.fromBits(u<<16|p,c<<16|h)},e.math.Long.prototype.div=function(t){if(t.isZero())throw Error("division by zero");if(this.isZero())return e.math.Long.ZERO;if(this.equals(e.math.Long.MIN_VALUE)){if(t.equals(e.math.Long.ONE)||t.equals(e.math.Long.NEG_ONE))return e.math.Long.MIN_VALUE;if(t.equals(e.math.Long.MIN_VALUE))return e.math.Long.ONE;if((r=this.shiftRight(1).div(t).shiftLeft(1)).equals(e.math.Long.ZERO))return t.isNegative()?e.math.Long.ONE:e.math.Long.NEG_ONE;var i=this.subtract(t.multiply(r));return r.add(i.div(t))}if(t.equals(e.math.Long.MIN_VALUE))return e.math.Long.ZERO;if(this.isNegative())return t.isNegative()?this.negate().div(t.negate()):this.negate().div(t).negate();if(t.isNegative())return this.div(t.negate()).negate();var n=e.math.Long.ZERO;for(i=this;i.greaterThanOrEqual(t);){for(var r=Math.max(1,Math.floor(i.toNumber()/t.toNumber())),s=Math.ceil(Math.log(r)/Math.LN2),a=s<=48?1:Math.pow(2,s-48),o=e.math.Long.fromNumber(r),l=o.multiply(t);l.isNegative()||l.greaterThan(i);)r-=a,l=(o=e.math.Long.fromNumber(r)).multiply(t);o.isZero()&&(o=e.math.Long.ONE),n=n.add(o),i=i.subtract(l)}return n},e.math.Long.prototype.modulo=function(e){return this.subtract(this.div(e).multiply(e))},e.math.Long.prototype.not=function(){return e.math.Long.fromBits(~this.low_,~this.high_)},e.math.Long.prototype.and=function(t){return e.math.Long.fromBits(this.low_&t.low_,this.high_&t.high_)},e.math.Long.prototype.or=function(t){return e.math.Long.fromBits(this.low_|t.low_,this.high_|t.high_)},e.math.Long.prototype.xor=function(t){return e.math.Long.fromBits(this.low_^t.low_,this.high_^t.high_)},e.math.Long.prototype.shiftLeft=function(t){if(0==(t&=63))return this;var i=this.low_;if(t<32){var n=this.high_;return e.math.Long.fromBits(i<<t,n<<t|i>>>32-t)}return e.math.Long.fromBits(0,i<<t-32)},e.math.Long.prototype.shiftRight=function(t){if(0==(t&=63))return this;var i=this.high_;if(t<32){var n=this.low_;return e.math.Long.fromBits(n>>>t|i<<32-t,i>>t)}return e.math.Long.fromBits(i>>t-32,i>=0?0:-1)},e.math.Long.prototype.shiftRightUnsigned=function(t){if(0==(t&=63))return this;var i=this.high_;if(t<32){var n=this.low_;return e.math.Long.fromBits(n>>>t|i<<32-t,i>>>t)}return 32==t?e.math.Long.fromBits(i,0):e.math.Long.fromBits(i>>>t-32,0)};var t,i="Modern Browser";function n(e,t,i){null!=e&&("number"==typeof e?this.fromNumber(e,t,i):null==t&&"string"!=typeof e?this.fromString(e,256):this.fromString(e,t))}function r(){return new n(null)}"Microsoft Internet Explorer"==i?(n.prototype.am=function(e,t,i,n,r,s){for(var a=32767&t,o=t>>15;--s>=0;){var l=32767&this[e],d=this[e++]>>15,c=o*l+d*a;r=((l=a*l+((32767&c)<<15)+i[n]+(1073741823&r))>>>30)+(c>>>15)+o*d+(r>>>30),i[n++]=1073741823&l}return r},t=30):"Netscape"!=i?(n.prototype.am=function(e,t,i,n,r,s){for(;--s>=0;){var a=t*this[e++]+i[n]+r;r=Math.floor(a/67108864),i[n++]=67108863&a}return r},t=26):(n.prototype.am=function(e,t,i,n,r,s){for(var a=16383&t,o=t>>14;--s>=0;){var l=16383&this[e],d=this[e++]>>14,c=o*l+d*a;r=((l=a*l+((16383&c)<<14)+i[n]+r)>>28)+(c>>14)+o*d,i[n++]=268435455&l}return r},t=28),n.prototype.DB=t,n.prototype.DM=(1<<t)-1,n.prototype.DV=1<<t;n.prototype.FV=Math.pow(2,52),n.prototype.F1=52-t,n.prototype.F2=2*t-52;var s,a,o="0123456789abcdefghijklmnopqrstuvwxyz",l=new Array;for(s="0".charCodeAt(0),a=0;a<=9;++a)l[s++]=a;for(s="a".charCodeAt(0),a=10;a<36;++a)l[s++]=a;for(s="A".charCodeAt(0),a=10;a<36;++a)l[s++]=a;function d(e){return o.charAt(e)}function c(e,t){var i=l[e.charCodeAt(t)];return null==i?-1:i}function h(e){var t=r();return t.fromInt(e),t}function u(e){var t,i=1;return 0!=(t=e>>>16)&&(e=t,i+=16),0!=(t=e>>8)&&(e=t,i+=8),0!=(t=e>>4)&&(e=t,i+=4),0!=(t=e>>2)&&(e=t,i+=2),0!=(t=e>>1)&&(e=t,i+=1),i}function p(e){this.m=e}function g(e){this.m=e,this.mp=e.invDigit(),this.mpl=32767&this.mp,this.mph=this.mp>>15,this.um=(1<<e.DB-15)-1,this.mt2=2*e.t}p.prototype.convert=function(e){return e.s<0||e.compareTo(this.m)>=0?e.mod(this.m):e},p.prototype.revert=function(e){return e},p.prototype.reduce=function(e){e.divRemTo(this.m,null,e)},p.prototype.mulTo=function(e,t,i){e.multiplyTo(t,i),this.reduce(i)},p.prototype.sqrTo=function(e,t){e.squareTo(t),this.reduce(t)},g.prototype.convert=function(e){var t=r();return e.abs().dlShiftTo(this.m.t,t),t.divRemTo(this.m,null,t),e.s<0&&t.compareTo(n.ZERO)>0&&this.m.subTo(t,t),t},g.prototype.revert=function(e){var t=r();return e.copyTo(t),this.reduce(t),t},g.prototype.reduce=function(e){for(;e.t<=this.mt2;)e[e.t++]=0;for(var t=0;t<this.m.t;++t){var i=32767&e[t],n=i*this.mpl+((i*this.mph+(e[t]>>15)*this.mpl&this.um)<<15)&e.DM;for(e[i=t+this.m.t]+=this.m.am(0,n,e,t,0,this.m.t);e[i]>=e.DV;)e[i]-=e.DV,e[++i]++}e.clamp(),e.drShiftTo(this.m.t,e),e.compareTo(this.m)>=0&&e.subTo(this.m,e)},g.prototype.mulTo=function(e,t,i){e.multiplyTo(t,i),this.reduce(i)},g.prototype.sqrTo=function(e,t){e.squareTo(t),this.reduce(t)},n.prototype.copyTo=function(e){for(var t=this.t-1;t>=0;--t)e[t]=this[t];e.t=this.t,e.s=this.s},n.prototype.fromInt=function(e){this.t=1,this.s=e<0?-1:0,e>0?this[0]=e:e<-1?this[0]=e+DV:this.t=0},n.prototype.fromString=function(e,t){var i;if(16==t)i=4;else if(8==t)i=3;else if(256==t)i=8;else if(2==t)i=1;else if(32==t)i=5;else{if(4!=t)return void this.fromRadix(e,t);i=2}this.t=0,this.s=0;for(var r=e.length,s=!1,a=0;--r>=0;){var o=8==i?255&e[r]:c(e,r);o<0?"-"==e.charAt(r)&&(s=!0):(s=!1,0==a?this[this.t++]=o:a+i>this.DB?(this[this.t-1]|=(o&(1<<this.DB-a)-1)<<a,this[this.t++]=o>>this.DB-a):this[this.t-1]|=o<<a,(a+=i)>=this.DB&&(a-=this.DB))}8==i&&0!=(128&e[0])&&(this.s=-1,a>0&&(this[this.t-1]|=(1<<this.DB-a)-1<<a)),this.clamp(),s&&n.ZERO.subTo(this,this)},n.prototype.clamp=function(){for(var e=this.s&this.DM;this.t>0&&this[this.t-1]==e;)--this.t},n.prototype.dlShiftTo=function(e,t){var i;for(i=this.t-1;i>=0;--i)t[i+e]=this[i];for(i=e-1;i>=0;--i)t[i]=0;t.t=this.t+e,t.s=this.s},n.prototype.drShiftTo=function(e,t){for(var i=e;i<this.t;++i)t[i-e]=this[i];t.t=Math.max(this.t-e,0),t.s=this.s},n.prototype.lShiftTo=function(e,t){var i,n=e%this.DB,r=this.DB-n,s=(1<<r)-1,a=Math.floor(e/this.DB),o=this.s<<n&this.DM;for(i=this.t-1;i>=0;--i)t[i+a+1]=this[i]>>r|o,o=(this[i]&s)<<n;for(i=a-1;i>=0;--i)t[i]=0;t[a]=o,t.t=this.t+a+1,t.s=this.s,t.clamp()},n.prototype.rShiftTo=function(e,t){t.s=this.s;var i=Math.floor(e/this.DB);if(i>=this.t)t.t=0;else{var n=e%this.DB,r=this.DB-n,s=(1<<n)-1;t[0]=this[i]>>n;for(var a=i+1;a<this.t;++a)t[a-i-1]|=(this[a]&s)<<r,t[a-i]=this[a]>>n;n>0&&(t[this.t-i-1]|=(this.s&s)<<r),t.t=this.t-i,t.clamp()}},n.prototype.subTo=function(e,t){for(var i=0,n=0,r=Math.min(e.t,this.t);i<r;)n+=this[i]-e[i],t[i++]=n&this.DM,n>>=this.DB;if(e.t<this.t){for(n-=e.s;i<this.t;)n+=this[i],t[i++]=n&this.DM,n>>=this.DB;n+=this.s}else{for(n+=this.s;i<e.t;)n-=e[i],t[i++]=n&this.DM,n>>=this.DB;n-=e.s}t.s=n<0?-1:0,n<-1?t[i++]=this.DV+n:n>0&&(t[i++]=n),t.t=i,t.clamp()},n.prototype.multiplyTo=function(e,t){var i=this.abs(),r=e.abs(),s=i.t;for(t.t=s+r.t;--s>=0;)t[s]=0;for(s=0;s<r.t;++s)t[s+i.t]=i.am(0,r[s],t,s,0,i.t);t.s=0,t.clamp(),this.s!=e.s&&n.ZERO.subTo(t,t)},n.prototype.squareTo=function(e){for(var t=this.abs(),i=e.t=2*t.t;--i>=0;)e[i]=0;for(i=0;i<t.t-1;++i){var n=t.am(i,t[i],e,2*i,0,1);(e[i+t.t]+=t.am(i+1,2*t[i],e,2*i+1,n,t.t-i-1))>=t.DV&&(e[i+t.t]-=t.DV,e[i+t.t+1]=1)}e.t>0&&(e[e.t-1]+=t.am(i,t[i],e,2*i,0,1)),e.s=0,e.clamp()},n.prototype.divRemTo=function(e,t,i){var s=e.abs();if(!(s.t<=0)){var a=this.abs();if(a.t<s.t)return null!=t&&t.fromInt(0),void(null!=i&&this.copyTo(i));null==i&&(i=r());var o=r(),l=this.s,d=e.s,c=this.DB-u(s[s.t-1]);c>0?(s.lShiftTo(c,o),a.lShiftTo(c,i)):(s.copyTo(o),a.copyTo(i));var h=o.t,p=o[h-1];if(0!=p){var g=p*(1<<this.F1)+(h>1?o[h-2]>>this.F2:0),m=this.FV/g,f=(1<<this.F1)/g,S=1<<this.F2,v=i.t,y=v-h,C=null==t?r():t;for(o.dlShiftTo(y,C),i.compareTo(C)>=0&&(i[i.t++]=1,i.subTo(C,i)),n.ONE.dlShiftTo(h,C),C.subTo(o,o);o.t<h;)o[o.t++]=0;for(;--y>=0;){var T=i[--v]==p?this.DM:Math.floor(i[v]*m+(i[v-1]+S)*f);if((i[v]+=o.am(0,T,i,y,0,h))<T)for(o.dlShiftTo(y,C),i.subTo(C,i);i[v]<--T;)i.subTo(C,i)}null!=t&&(i.drShiftTo(h,t),l!=d&&n.ZERO.subTo(t,t)),i.t=h,i.clamp(),c>0&&i.rShiftTo(c,i),l<0&&n.ZERO.subTo(i,i)}}},n.prototype.invDigit=function(){if(this.t<1)return 0;var e=this[0];if(0==(1&e))return 0;var t=3&e;return(t=(t=(t=(t=t*(2-(15&e)*t)&15)*(2-(255&e)*t)&255)*(2-((65535&e)*t&65535))&65535)*(2-e*t%this.DV)%this.DV)>0?this.DV-t:-t},n.prototype.isEven=function(){return 0==(this.t>0?1&this[0]:this.s)},n.prototype.exp=function(e,t){if(e>4294967295||e<1)return n.ONE;var i=r(),s=r(),a=t.convert(this),o=u(e)-1;for(a.copyTo(i);--o>=0;)if(t.sqrTo(i,s),(e&1<<o)>0)t.mulTo(s,a,i);else{var l=i;i=s,s=l}return t.revert(i)},n.prototype.toString=function(e){if(this.s<0)return"-"+this.negate().toString(e);var t;if(16==e)t=4;else if(8==e)t=3;else if(2==e)t=1;else if(32==e)t=5;else{if(4!=e)return this.toRadix(e);t=2}var i,n=(1<<t)-1,r=!1,s="",a=this.t,o=this.DB-a*this.DB%t;if(a-- >0)for(o<this.DB&&(i=this[a]>>o)>0&&(r=!0,s=d(i));a>=0;)o<t?(i=(this[a]&(1<<o)-1)<<t-o,i|=this[--a]>>(o+=this.DB-t)):(i=this[a]>>(o-=t)&n,o<=0&&(o+=this.DB,--a)),i>0&&(r=!0),r&&(s+=d(i));return r?s:"0"},n.prototype.negate=function(){var e=r();return n.ZERO.subTo(this,e),e},n.prototype.abs=function(){return this.s<0?this.negate():this},n.prototype.compareTo=function(e){var t=this.s-e.s;if(0!=t)return t;var i=this.t;if(0!=(t=i-e.t))return this.s<0?-t:t;for(;--i>=0;)if(0!=(t=this[i]-e[i]))return t;return 0},n.prototype.bitLength=function(){return this.t<=0?0:this.DB*(this.t-1)+u(this[this.t-1]^this.s&this.DM)},n.prototype.mod=function(e){var t=r();return this.abs().divRemTo(e,null,t),this.s<0&&t.compareTo(n.ZERO)>0&&e.subTo(t,t),t},n.prototype.modPowInt=function(e,t){var i;return i=e<256||t.isEven()?new p(t):new g(t),this.exp(e,i)},n.ZERO=h(0),n.ONE=h(1),n.prototype.fromRadix=function(e,t){this.fromInt(0),null==t&&(t=10);for(var i=this.chunkSize(t),r=Math.pow(t,i),s=!1,a=0,o=0,l=0;l<e.length;++l){var d=c(e,l);d<0?"-"==e.charAt(l)&&0==this.signum()&&(s=!0):(o=t*o+d,++a>=i&&(this.dMultiply(r),this.dAddOffset(o,0),a=0,o=0))}a>0&&(this.dMultiply(Math.pow(t,a)),this.dAddOffset(o,0)),s&&n.ZERO.subTo(this,this)},n.prototype.chunkSize=function(e){return Math.floor(Math.LN2*this.DB/Math.log(e))},n.prototype.signum=function(){return this.s<0?-1:this.t<=0||1==this.t&&this[0]<=0?0:1},n.prototype.dMultiply=function(e){this[this.t]=this.am(0,e-1,this,0,0,this.t),++this.t,this.clamp()},n.prototype.dAddOffset=function(e,t){if(0!=e){for(;this.t<=t;)this[this.t++]=0;for(this[t]+=e;this[t]>=this.DV;)this[t]-=this.DV,++t>=this.t&&(this[this.t++]=0),++this[t]}},n.prototype.toRadix=function(e){if(null==e&&(e=10),0==this.signum()||e<2||e>36)return"0";var t=this.chunkSize(e),i=Math.pow(e,t),n=h(i),s=r(),a=r(),o="";for(this.divRemTo(n,s,a);s.signum()>0;)o=(i+a.intValue()).toString(e).substr(1)+o,s.divRemTo(n,s,a);return a.intValue().toString(e)+o},n.prototype.intValue=function(){if(this.s<0){if(1==this.t)return this[0]-this.DV;if(0==this.t)return-1}else{if(1==this.t)return this[0];if(0==this.t)return 0}return(this[1]&(1<<32-this.DB)-1)<<this.DB|this[0]},n.prototype.addTo=function(e,t){for(var i=0,n=0,r=Math.min(e.t,this.t);i<r;)n+=this[i]+e[i],t[i++]=n&this.DM,n>>=this.DB;if(e.t<this.t){for(n+=e.s;i<this.t;)n+=this[i],t[i++]=n&this.DM,n>>=this.DB;n+=this.s}else{for(n+=this.s;i<e.t;)n+=e[i],t[i++]=n&this.DM,n>>=this.DB;n+=e.s}t.s=n<0?-1:0,n>0?t[i++]=n:n<-1&&(t[i++]=this.DV+n),t.t=i,t.clamp()};var m={abs:function(t,i){var n,r=new e.math.Long(t,i);n=r.isNegative()?r.negate():r,HEAP32[tempDoublePtr>>2]=n.low_,HEAP32[tempDoublePtr+4>>2]=n.high_},ensureTemps:function(){m.ensuredTemps||(m.ensuredTemps=!0,m.two32=new n,m.two32.fromString("4294967296",10),m.two64=new n,m.two64.fromString("18446744073709551616",10),m.temp1=new n,m.temp2=new n)},lh2bignum:function(e,t){var i=new n;i.fromString(t.toString(),10);var r=new n;i.multiplyTo(m.two32,r);var s=new n;s.fromString(e.toString(),10);var a=new n;return s.addTo(r,a),a},stringify:function(t,i,r){var s=new e.math.Long(t,i).toString();if(r&&"-"==s[0]){m.ensureTemps();var a=new n;a.fromString(s,10),s=new n,m.two64.addTo(a,s),s=s.toString(10)}return s},fromString:function(t,i,r,s,a){m.ensureTemps();var o=new n;o.fromString(t,i);var l=new n;l.fromString(r,10);var d=new n;if(d.fromString(s,10),a&&o.compareTo(n.ZERO)<0){var c=new n;o.addTo(m.two64,c),o=c}var h=!1;o.compareTo(l)<0?(o=l,h=!0):o.compareTo(d)>0&&(o=d,h=!0);var u=e.math.Long.fromString(o.toString());if(HEAP32[tempDoublePtr>>2]=u.low_,HEAP32[tempDoublePtr+4>>2]=u.high_,h)throw"range error"}};return m}(),initialStackTop;if(memoryInitializer)if("function"==typeof Module.locateFile?memoryInitializer=Module.locateFile(memoryInitializer):Module.memoryInitializerPrefixURL&&(memoryInitializer=Module.memoryInitializerPrefixURL+memoryInitializer),ENVIRONMENT_IS_NODE||ENVIRONMENT_IS_SHELL){var data=Module.readBinary(memoryInitializer);HEAPU8.set(data,STATIC_BASE)}else addRunDependency("memory initializer"),Browser.asyncLoad(memoryInitializer,(function(e){HEAPU8.set(e,STATIC_BASE),removeRunDependency("memory initializer")}),(function(e){throw"could not load memory initializer "+memoryInitializer}));function ExitStatus(e){this.name="ExitStatus",this.message="Program terminated with exit("+e+")",this.status=e}ExitStatus.prototype=new Error,ExitStatus.prototype.constructor=ExitStatus;var preloadStartTime=null,calledMain=!1;function run(e){function t(){Module.calledRun||(Module.calledRun=!0,ABORT||(ensureInitRuntime(),preMain(),ENVIRONMENT_IS_WEB&&null!==preloadStartTime&&Module.printErr("pre-main prep time: "+(Date.now()-preloadStartTime)+" ms"),Module.onRuntimeInitialized&&Module.onRuntimeInitialized(),Module._main&&shouldRunNow&&Module.callMain(e),postRun()))}e=e||Module.arguments,null===preloadStartTime&&(preloadStartTime=Date.now()),runDependencies>0||(preRun(),runDependencies>0||Module.calledRun||(Module.setStatus?(Module.setStatus("Running..."),setTimeout((function(){setTimeout((function(){Module.setStatus("")}),1),t()}),1)):t()))}function exit(e){if(!Module.noExitRuntime)throw ABORT=!0,EXITSTATUS=e,STACKTOP=initialStackTop,exitRuntime(),ENVIRONMENT_IS_NODE?(process.stdout.once("drain",(function(){process.exit(e)})),console.log(" "),setTimeout((function(){process.exit(e)}),500)):ENVIRONMENT_IS_SHELL&&"function"==typeof quit&&quit(e),new ExitStatus(e)}function abort(e){e&&(Module.print(e),Module.printErr(e)),ABORT=!0,EXITSTATUS=1;throw"abort() at "+stackTrace()+"\nIf this abort() is unexpected, build with -s ASSERTIONS=1 which can give more information."}if(dependenciesFulfilled=function e(){!Module.calledRun&&shouldRunNow&&run(),Module.calledRun||(dependenciesFulfilled=e)},Module.callMain=Module.callMain=function(e){e=e||[],ensureInitRuntime();var t=e.length+1;function i(){for(var e=0;e<3;e++)n.push(0)}var n=[allocate(intArrayFromString(Module.thisProgram),"i8",ALLOC_NORMAL)];i();for(var r=0;r<t-1;r+=1)n.push(allocate(intArrayFromString(e[r]),"i8",ALLOC_NORMAL)),i();n.push(0),n=allocate(n,"i32",ALLOC_NORMAL),initialStackTop=STACKTOP;try{exit(Module._main(t,n,0))}catch(e){if(e instanceof ExitStatus)return;if("SimulateInfiniteLoop"==e)return void(Module.noExitRuntime=!0);throw e&&"object"==typeof e&&e.stack&&Module.printErr("exception thrown: "+[e,e.stack]),e}finally{calledMain=!0}},Module.run=Module.run=run,Module.exit=Module.exit=exit,Module.abort=Module.abort=abort,Module.preInit)for("function"==typeof Module.preInit&&(Module.preInit=[Module.preInit]);Module.preInit.length>0;)Module.preInit.pop()();var shouldRunNow=!0;Module.noInitialRun&&(shouldRunNow=!1),run();var Internal=Internal||{};!function(){"use strict";function e(e){var t=Module._malloc(e.length);return Module.HEAPU8.set(e,t),t}function t(e,t,i){i.set(Module.HEAPU8.subarray(e,e+t))}var i=new Uint8Array(32);i[0]=9,Internal.curve25519={keyPair:function(n){var r=new Uint8Array(n);r[0]&=248,r[31]&=127,r[31]|=64;var s=Module._malloc(32),a=e(r),o=e(i),l=(Module._curve25519_donna(s,a,o),new Uint8Array(32));return t(s,32,l),Module._free(s),Module._free(a),Module._free(o),{pubKey:l.buffer,privKey:r.buffer}},sharedSecret:function(i,n){var r=Module._malloc(32),s=e(new Uint8Array(n)),a=e(new Uint8Array(i)),o=(Module._curve25519_donna(r,s,a),new Uint8Array(32));return t(r,32,o),Module._free(r),Module._free(s),Module._free(a),o.buffer},sign:function(i,n){var r=Module._malloc(64),s=e(new Uint8Array(i)),a=e(new Uint8Array(n)),o=(Module._curve25519_sign(r,s,a,n.byteLength),new Uint8Array(64));return t(r,64,o),Module._free(r),Module._free(s),Module._free(a),o.buffer},verify:function(t,i,n){var r=e(new Uint8Array(t)),s=e(new Uint8Array(n)),a=e(new Uint8Array(i)),o=Module._curve25519_verify(s,r,a,i.byteLength);return Module._free(r),Module._free(s),Module._free(a),0!==o}},Internal.curve25519_async={keyPair:function(e){return new Promise((function(t){t(Internal.curve25519.keyPair(e))}))},sharedSecret:function(e,t){return new Promise((function(i){i(Internal.curve25519.sharedSecret(e,t))}))},sign:function(e,t){return new Promise((function(i){i(Internal.curve25519.sign(e,t))}))},verify:function(e,t,i){return new Promise((function(n,r){Internal.curve25519.verify(e,t,i)?r(new Error("Invalid signature")):n()}))}},module.exports=Internal}()},194795:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=n.__importStar(i(516778)),a=i(667294);class o extends a.Component{constructor(){super(...arguments),this._onRef=e=>this._inputRef=e,this.requestFocus=()=>{}}blur(){var e;null===(e=this._inputRef)||void 0===e||e.blur()}render(){return(0,r.jsx)(s.TextInput,Object.assign({},this.props,{ref:this._onRef}))}}t.default=o},165986:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(194795),t);var r=i(194795);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},753998:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IsAccountCleanupDoneKey=void 0,t.IsAccountCleanupDoneKey="IsAccountCleanupDone"},323692:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IsAccountCleanupDoneKey=t.AccountManagment=void 0;const n=i(753998);Object.defineProperty(t,"IsAccountCleanupDoneKey",{enumerable:!0,get:function(){return n.IsAccountCleanupDoneKey}});t.AccountManagment=new class{doAccountCleanup(e){}}},415523:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});i(197582).__exportStar(i(323692),t)},419451:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CommonAppConfigModule=void 0;class i{onAppConfigChanged(e){}}t.CommonAppConfigModule=i,t.default=new i},449593:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(419451),t);var r=i(419451);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},514639:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.AudioModes=void 0,function(e){e[e.Default=1]="Default",e[e.VideoPlayback=2]="VideoPlayback",e[e.AudioPlayback=3]="AudioPlayback",e[e.IncomingRing=4]="IncomingRing",e[e.RecordAudioMessage=5]="RecordAudioMessage",e[e.Capture=6]="Capture",e[e.Call=7]="Call",e[e.CallPreferSpeaker=8]="CallPreferSpeaker",e[e.AudioPlaybackWithScreenReader=9]="AudioPlaybackWithScreenReader"}(i||(t.AudioModes=i={}))},119557:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(735483),t);var r=i(735483);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},735483:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AudioModes=void 0;const n=i(197582),r=n.__importDefault(i(974634)),s=n.__importStar(i(397691));var a=i(514639);Object.defineProperty(t,"AudioModes",{enumerable:!0,get:function(){return a.AudioModes}}),t.default=new class{constructor(){this.audioOutputChangedEvent=new r.default,this.AudioOutputSpeaker=1,this.AudioOutputEarpiece=2,this.AudioOutputWiredHeadset=3,this.AudioOutputBluetooth=4,this.AudioOutputOther=5,this.availableAudioOutputsChangedEvent=new r.default,this.audioInterruptedChangedEvent=new r.default,this.mediaActionEvent=new r.default,this.audioSystemResetEvent=new r.default}setConfig(e){}requestMode(e,t){return s.Resolved(1)}exchangeMode(e,t,i){return s.Resolved(1)}requestOutput(e){return s.Resolved(1)}requestAvailableOutputRoutesArray(e){return s.Resolved([])}release(e,t){}requestEndToInterruption(){}audioOutput(){return s.Resolved(this.AudioOutputSpeaker)}audioOutputStreamWithInitialValue(e){const t=this.audioOutputChangedEvent.subscribe(e);return this.audioOutput().then(e),t}availableAudioOutputs(){return s.Resolved([this.AudioOutputSpeaker])}availableAudioOutputsStreamWithInitialValue(e){const t=this.availableAudioOutputsChangedEvent.subscribe(e);return this.availableAudioOutputs().then(e),t}routePickerView(){return null}}},333001:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},272991:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(889386),t);var r=i(889386);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},889386:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(815063),s=i(167606),a=n.__importStar(i(397691)),o=i(861049),l=n.__importDefault(i(606617)),d=n.__importStar(i(85385)),c=n.__importDefault(i(139221)),h=n.__importDefault(i(601274));n.__exportStar(i(333001),t);const u="undefined"!=typeof window,p=u&&"undefined"!=typeof navigator,g=u&&("AudioContext"in window||"webkitAudioContext"in window);class m{constructor(){this._isRecording=!1}isCapturingAudio(){return!!this._recorder}startRecording(e,t=100){return this._isRecording=!0,this._recorder=new o.Recorder({wasmURL:c.default.getWasmPath("vmsg.wasm"),useBaseUrl:!0}),a.fromThenable(this._recorder.initAudio()).then((()=>this._recorder?a.fromThenable(this._recorder.initWorker()):a.Rejected())).then((()=>{e&&(this._volumeSampleTimer=h.default.setInterval((()=>this._onVolumeSample(e)),t)),this._recorder&&this._recorder.startRecording()})).fail((e=>d.log(s.LogTraceArea.GenericUnsafe,"Failed to init audio recorder",e)))}stopRecording(){if(this._isRecording=!1,!this._recorder)return a.Rejected();let e;try{e=this._recorder.stopRecording()}catch(t){e=a.Rejected(t)}return a.fromThenable(e).then((e=>{const t=(new Date).getMilliseconds(),i=++m._fileNameIndex+m.FileName,n=l.default.extractFileExtension(i),r={file:this._getFile(e,i,t),extension:n};return this._recorder&&this._recorder.close(),{data:r,extension:n}})).fail((e=>d.log(s.LogTraceArea.GenericUnsafe,"Failed to stop audio recorder",e)))}_getFile(e,t,i){const n="audio/mpeg";if(r.BrowserEnvironment.isEngineEdgeHTML()){const r=new Blob([e],{type:n});return r.name=t,r.lastModified=i,r}return new File([e],t,{type:n,lastModified:i})}_onVolumeSample(e){this._isRecording?e(.01):this._volumeSampleTimer&&clearInterval(this._volumeSampleTimer)}}m.FileName="-audioMessage.mp3",m._fileNameIndex=0;t.default=new class{isCapturingAudioSupported(){return!!(g&&o.Recorder&&p)}createRecordingSession(){return new m}}},826805:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PAUSE_PROGRESS_ANIMATION=t.START_PROGRESS_ANIMATION=t.AUDIO_WAVE_WIDTH=t.AUDIO_WAVE_HEIGHT=void 0,t.AUDIO_WAVE_HEIGHT=17,t.AUDIO_WAVE_WIDTH=60,t.START_PROGRESS_ANIMATION="startProgressAnimation",t.PAUSE_PROGRESS_ANIMATION="pauseProgressAnimation"},34678:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(189439),t);var r=i(189439);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},189439:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=i(667294),a=i(537180),o=n.__importDefault(i(821796)),l=i(826805),d=l.AUDIO_WAVE_HEIGHT-2,c=a.StyleSheet.create({audioWave:{width:l.AUDIO_WAVE_WIDTH,height:d,flex:1,justifyContent:"center"}}),h=(0,s.forwardRef)(((e,t)=>{const{progressColor:i,colorForBackground:n,contentUrl:l,currentProgress:h}=e||{},u=(0,s.useRef)(null),[p,g]=(0,s.useState)(),m=(0,s.useCallback)((()=>{if(p)return;if(!(l&&i&&n&&u.current))return;const e=o.default.create({container:u.current,height:d,barHeight:d,barMinHeight:1,barWidth:2,barRadius:2,progressColor:i,waveColor:n,fillParent:!0,hideCursor:!1,cursorColor:"transparent",autoCenter:!0});e.load(`${l}`),e.on("ready",(()=>{g(e)}))}),[p,i,n,l]);return(0,s.useEffect)((()=>{m()}),[m]),(0,s.useEffect)((()=>{p&&h&&p.seekTo(h)}),[h,p]),(0,r.jsx)(a.View,{style:[c.audioWave,e.style],ref:u})}));t.default=h},333897:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CoachMarkWrapper=t.CoachMarkNativeError=void 0;const n=i(217041);var r;!function(e){e[e.FailedToAttachEventListener=0]="FailedToAttachEventListener",e[e.FailedToRemoveEventListener=1]="FailedToRemoveEventListener"}(r||(t.CoachMarkNativeError=r={}));class s extends n.ComponentBase{}t.CoachMarkWrapper=s},773256:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(898942),t);var r=i(898942);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},898942:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CoachMark=t.CoachMarkNativeError=void 0;const n=i(197582),r=i(785893),s=n.__importStar(i(973935)),a=n.__importStar(i(516778)),o=i(217041);var l=i(333897);Object.defineProperty(t,"CoachMarkNativeError",{enumerable:!0,get:function(){return l.CoachMarkNativeError}});class d extends o.ComponentBase{constructor(){super(...arguments),this._subscribeToUserEvents=()=>{this._parentWindow&&(this._parentWindow.addEventListener("mousedown",this._onDismissEvent),this._parentWindow.addEventListener("wheel",this._onDismissEvent),this._didSubscribe=!0)},this._unsubscribeFromUserEvents=()=>{this._parentWindow&&(this._parentWindow.removeEventListener("mousedown",this._onDismissEvent),this._parentWindow.removeEventListener("wheel",this._onDismissEvent),this._didUnsubscribe=!0)},this._onDismissEvent=e=>{const t=this.props.coachMarkLayoutInfo(),i=t.container,n=t.anchor;this._isMouseEventInside(e,i)||this._isMouseEventInside(e,n)||(this._unsubscribeFromUserEvents(),this.props.onDismissEvent())},this._isMouseEventInside=(e,t)=>{const i=e.x>=t.x&&e.x<=t.x+t.width,n=e.y>=t.y&&e.y<=t.y+t.height;return i&&n},this._onCoachMarkWrapperRef=e=>{this._wrapperRef=e||void 0}}componentDidMount(){this._didUnsubscribe=!1,this._didSubscribe=!1,super.componentDidMount(),this._setupWindowObject(this._wrapperRef),this._subscribeToUserEvents()}componentWillUnmount(){super.componentWillUnmount(),this._didSubscribe&&!this._didUnsubscribe&&this._unsubscribeFromUserEvents()}_setupWindowObject(e){if(e){const t=s.findDOMNode(e);this._parentWindow=t.parentElement||void 0}}render(){return(0,r.jsx)(a.View,{ref:this._onCoachMarkWrapperRef,style:this.props.baseStyle,tabIndex:-1,ignorePointerEvents:!0,restrictFocusWithin:!!this.props.restrictFocusWithin,onLayout:this.props.onLayoutChanged,children:this.props.children},this.props.keyView)}}t.CoachMark=d,t.default=d},638753:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(902332),t);var r=i(902332);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},902332:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=n.__importStar(i(167606)),s=n.__importStar(i(397691)),a="FileCache not implemented for this platform";t.default=new class{constructor(){this.DefaultCacheName=void 0}isLocalCacheSupported(){return!1}getLocalUri(e,t){}getLocalUriBase(e){}save(e,t,i,n){return r.error(r.LogTraceArea.GenericUnsafe,a),s.Rejected(a)}remove(e,t){return r.error(r.LogTraceArea.GenericUnsafe,a),s.Rejected(a)}getAllCachedFileNames(e){return r.error(r.LogTraceArea.GenericUnsafe,a),s.Rejected(a)}copyToDownloadFolder(e,t){return s.Rejected(a)}copyToUri(e,t){return s.Rejected(a)}removeFromDownloadFolder(e){return s.Rejected(a)}evictFromImageCache(e,t){return s.Rejected(a)}initializeUserCache(e){return s.Resolved()}onLogout(e){return s.Resolved()}setEnableUserCache(e){return s.Resolved()}}},524163:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(185405),t);var r=i(185405);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},235656:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getColorHarmonies=function(e){const t=s.Defer(),i=new Image;return i.onload=()=>{const e=[];let n;try{n=r.extractImageColors(i,"hex")}catch(e){return l.error(o.LogTraceArea.GenericUnsafe,"[Colibri] Could not extract colors. Err: "+d.default.errorAsString(e)),void t.reject([])}let s=(0,a.colorStringToHsl)(n.background);if(g(s)){let e;for(let t=0;t<n.content.length;t++){const i=(0,a.colorStringToHsl)(n.content[t]);if(!g(i)){e=i;break}}s=e||(0,a.colorStringToHsl)(c.Color.sxBlue)}for(let t=90;t<=360;t+=90){const i=t/360,n=(s.hue+i)%1;e.push({key:m(n),colors:p(n,s.saturation)})}e.push({key:"White",colors:[c.Color.white,c.Color.white]}),t.resolve(e)},i.onerror=()=>t.reject([]),i.setAttribute("crossorigin","anonymous"),i.src=e,t.promise()};const n=i(197582),r=n.__importStar(i(3036)),s=n.__importStar(i(397691)),a=i(198649),o=i(815146),l=n.__importStar(i(85385)),d=n.__importDefault(i(655192)),c=i(16549),h=.2,u=[{id:15,stringKey:"Red"},{id:45,stringKey:"Orange"},{id:65,stringKey:"Yellow"},{id:79,stringKey:"Yellowgreen"},{id:160,stringKey:"Green"},{id:188,stringKey:"Bluegreen"},{id:260,stringKey:"Blue"},{id:270,stringKey:"Blueviolet"},{id:291,stringKey:"Violet"},{id:327,stringKey:"Redviolet"},{id:360,stringKey:"Red"}];function p(e,t){const i=Math.min(1.5*t,1);return[{hue:e,saturation:i,lightness:.9},{hue:e,saturation:i,lightness:.67}].map((e=>(0,a.hslToColorString)(e)))}function g(e){return e.saturation<=h}function m(e){const t=Math.floor(360*e),i=u.find((e=>e.id>=t));return(null==i?void 0:i.stringKey)||""}},185405:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ImageModule=void 0;const n=i(197582),r=n.__importStar(i(697762)),s=n.__importStar(i(397691)),a=i(16549),o=i(235656),l=i(641400),d=i(796792),c=n.__importDefault(i(606617));class h{getImageSize(e){const t=s.Defer(),i=new Image;return i.onload=e=>{const i=e.target.naturalWidth,n=e.target.naturalHeight;i>=0&&n>=0?t.resolve({width:i,height:n}):t.resolve(void 0)},i.onerror=e=>{t.resolve(void 0)},i.src=e,t.promise()}createResizedImage(e,t,i,n,r,a){return s.Rejected()}getColorHarmonies(e){return(0,o.getColorHarmonies)(e).then((e=>{var t;if((null!==(t=null==e?void 0:e.length)&&void 0!==t?t:0)>0){const t=e.map((e=>{const t=e.colors;return{key:e.key,colorGradientStart:t[0],colorGradientEnd:t[1]}}));return s.Resolved({colors:t})}return s.Resolved(void 0)}))}applyBackgroundGradientToImage(e,t,i,n,o,h=d.FallbackAvatarFileName){const u=s.Defer(),p=document.createElement("canvas");p.width=i.width,p.height=i.height;const g=p.getContext("2d");if(g){const i=g.createLinearGradient(0,0,p.width,p.height);if(i.addColorStop(0,t.colorGradientStart),i.addColorStop(1,t.colorGradientEnd),g.fillStyle=i,g.fillRect(0,0,p.width,p.height),e){const t=new Image;t.onload=()=>{null==g||g.drawImage(t,o.horizontal,o.vertical,n.height,n.width),p.toBlob((e=>{if(e){const t=new File([e],h,{type:c.default.imageContentTypes.jpeg});u.resolve({file:t,extension:"jpg",dimensions:{width:p.width,height:p.height}})}else u.resolve(void 0)}),c.default.imageContentTypes.jpeg,1)},t.onerror=()=>{u.resolve(void 0)},t.setAttribute("crossorigin","anonymous"),t.src=e}else{const e=(0,l.getIcon)(l.SkypeIcon.MeetNow,l.IconSize.size128,"White"===t.key?a.Color.gray400:a.Color.white),i=r.renderToStaticMarkup(e),n="data:image/svg+xml;base64,"+btoa(i),s=new Image;s.onload=()=>{g.drawImage(s,60,60,240,240),p.toBlob((e=>{if(e){const t=new File([e],h,{type:c.default.imageContentTypes.jpeg});u.resolve({file:t,extension:"jpg",dimensions:{width:p.width,height:p.height}})}else u.resolve(void 0)}),c.default.imageContentTypes.jpeg,1)},s.src=n}}else u.resolve(void 0);return u.promise()}}t.ImageModule=h,t.default=new h},238199:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addUrlHandler=function(e){n.Linking.addEventListener("url",(t=>e(t.url)))};const n=i(537180)},652069:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CommonTimeZoneProvider=void 0;const n=i(197582).__importStar(i(167606));class r{getDefaultId(){if("undefined"!=typeof window&&"Intl"in window)try{return Intl.DateTimeFormat().resolvedOptions().timeZone}catch(e){if(e instanceof RangeError)return void n.warn(void 0,"RangeError trying to resolve timeZone: "+e.toString());throw e}}}t.CommonTimeZoneProvider=r,t.default=new r},959536:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(652069),t);var r=i(652069);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},526929:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setEndCallHandler=function(e){},t.registerActiveCall=function(e){return n.Resolved()},t.notifyCallEnded=function(e){};const n=i(197582).__importStar(i(397691))},491907:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});i(197582).__exportStar(i(526929),t)},362704:(e,t)=>{"use strict";var i,n,r;Object.defineProperty(t,"__esModule",{value:!0}),t.CallingCallkitError=t.StopSharingOrigin=t.IncomingVideoNotificationOrigin=t.CallEndedReason=void 0,function(e){e[e.Failed=1]="Failed",e[e.RemoteEnded=2]="RemoteEnded",e[e.Unanswered=3]="Unanswered",e[e.AnsweredElsewhere=4]="AnsweredElsewhere",e[e.DeclinedElsewhere=5]="DeclinedElsewhere"}(i||(t.CallEndedReason=i={})),function(e){e[e.NotSpecified=0]="NotSpecified",e[e.IncomingCall=1]="IncomingCall",e[e.IncomingWhileInBackground=2]="IncomingWhileInBackground"}(n||(t.IncomingVideoNotificationOrigin=n={})),function(e){e[e.ScreenSharingToolbar=0]="ScreenSharingToolbar",e[e.CallView=1]="CallView",e[e.CallMonitor=2]="CallMonitor",e[e.Other=3]="Other"}(r||(t.StopSharingOrigin=r={}));class s extends Error{constructor(e,t,i,n,r){super(t),this.action=e,this.message=t,this.terminatedReason=i,this.failureType=n,this.validationReason=r}}t.CallingCallkitError=s},183641:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StopSharingOrigin=t.IncomingVideoNotificationOrigin=t.CallEndedReason=t.StubCallManager=t.CallManagerBase=void 0;const n=i(197582),r=n.__importStar(i(397691)),s=i(873324),a=i(776791),o=n.__importStar(i(85385)),l=n.__importDefault(i(150343)).default.getS4LCMCFeaturesNoSubscription().commonCallManagerCallKitTimeoutMS;t.CallManagerBase=class{constructor(){this._initialized=!1,this._trackDisabledCalls=!1,this._disabledCallIds=[]}requestHideSystemNotification(e,t){return this._timeout(this._enabledCheck(e,(()=>(o.log(a.LogTraceArea.Calling,"CallManager calling this.getCallManager().requestHideSystemNotification "+e+"and causeId: "+t),r.fromThenable(this.getCallManager().requestHideSystemNotification(e,t)).catch((t=>this._handleCallKitError(t,e,"requestHideSystemNotification")?r.Resolved():r.Rejected(t))))),(()=>r.Resolved())),"RequestHideSystemNotification",t)}test_reset(){if(this._initialized=!1,this._initDeferral){const e=this._initDeferral;this._initDeferral=void 0,e.reject()}}isRingless(){return!1}_onInitialized(){if(this._initialized=!0,this._initDeferral){const e=this._initDeferral;this._initDeferral=void 0,e.resolve(void 0)}}_blockUntilInitialized(){return this._initialized?r.Resolved():(this._initDeferral||(this._initDeferral=r.Defer()),this._initDeferral.promise())}_executeActionFunc(e,t){this._blockUntilInitialized().then((()=>t())).then((()=>this.getCallManager().completeAction(e,null)),(t=>this.getCallManager().completeAction(e,t)))}_timeout(e,t,i,n=l){const d=Date.now();return r.raceTimer(e,n).then((e=>{if(e.timedOut)return o.error(a.LogTraceArea.Calling,"[CallManagerBase]","[_timeout]","timeout triggered for",`methodName: ${t}`,`causeId: ${i}`),o.track(new s.CallManagerError(t)),this.getCallManager().reportTimedOutError(t,i),r.Rejected(`${t}: timed out`);{const e=Date.now();o.track(new s.CallManagerRequestCompleteEvent(t,e-d))}return r.Resolved(e.result)}))}_enabledCheck(e,t,i){return this._isCallDisabled(e)?i():this.isEnabled().then((e=>e?t():i()))}_executeFuncWithTimeoutIfEnabled(e,t,i,n){this._timeout(this._enabledCheck(e,(()=>(t(),r.Resolved())),(()=>r.Resolved())),i,n)}_isCallDisabled(e){return this._disabledCallIds.includes(e)}};class d{constructor(){this._initialized=!1,this.DefaultOneToOneAvatarPath="",this.DefaultGroupAvatarPath=""}setConfig(e){}selectedMicDidChange(e,t,i){}initialize(e,t,i,n,r,s,a,o,l,d,c){this._endCallActionFunc=o,this._muteCallActionFunc=d,this._holdCallActionFunc=c,this._onInitialized()}test_reset(){if(this._initialized=!1,this._initDeferral){const e=this._initDeferral;this._initDeferral=void 0,e.reject()}}isEnabled(){return r.Resolved(!1)}isRingless(){return!1}reportIncomingCall(e,t,i,n,s,a,o,l,d,c){return r.Resolved(!1)}postIncomingVideoNotification(e,t,i,n,r,s){}reportOutgoingCallConnecting(e,t){}reportOutgoingCallConnected(e,t){}reportCallEnded(e,t,i){}reportCallAccepted(e,t,i){return r.Resolved()}requestStartCall(e,t,i,n){return r.Resolved()}requestMuteStateChange(e,t,i,n){return this._blockUntilInitialized().then((()=>this._muteCallActionFunc(e,t,i,n)))}requestEndCall(e,t,i){return this._blockUntilInitialized().then((()=>this._endCallActionFunc(e,t,i)))}requestHoldCall(e,t){return this._blockUntilInitialized().then((()=>this._holdCallActionFunc(e,!0,t)))}requestResumeCall(e,t){return this._blockUntilInitialized().then((()=>this._holdCallActionFunc(e,!1,t)))}isCallKitCall(e){return r.Resolved(!1)}requestHideSystemNotification(e,t){return r.Resolved()}_onInitialized(){if(this._initialized=!0,this._initDeferral){const e=this._initDeferral;this._initDeferral=void 0,e.resolve(void 0)}}_blockUntilInitialized(){return this._initialized?r.Resolved():(this._initDeferral||(this._initDeferral=r.Defer()),this._initDeferral.promise())}}t.StubCallManager=d;var c=i(362704);Object.defineProperty(t,"CallEndedReason",{enumerable:!0,get:function(){return c.CallEndedReason}}),Object.defineProperty(t,"IncomingVideoNotificationOrigin",{enumerable:!0,get:function(){return c.IncomingVideoNotificationOrigin}}),Object.defineProperty(t,"StopSharingOrigin",{enumerable:!0,get:function(){return c.StopSharingOrigin}}),t.default=new d},224807:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(183641),t);var r=i(183641);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},478516:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582).__importStar(i(397691));t.default=new class{constructor(){this.triggerOnNavigation=!1}show(e,t,i,n){}hide(e){}destroy(e){}setCallbacks(e){}showVideo(e,t){return!1}stopVideo(e,t){}updateDevices(e){}updateMuted(e){}updateVideoOn(e){}updateSharingOn(e){}updateEnabled(e){}updateStrings(e){}updateConversation(e){}showBanner(e){}hideBanner(){}subscribeBlurEvent(e){}subscribeFocusEvent(e){}unsubscribeBlurEvent(){}unsubscribeFocusEvent(){}switchToMainView(e,t){return Promise.resolve()}isCallWindowInFullScreenMode(){return n.Resolved(!1)}onCallStarted(){}onCallEnded(){}}},253207:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(478516),t);var r=i(478516);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},233955:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ElectronVideoFrame=t.RNVideoFrame=t.CallingVideoViewBase=void 0;const n=i(197582),r=n.__importStar(i(167606)),s=n.__importStar(i(516778));class a extends s.Component{_getInstanceId(){return this._instanceId}UNSAFE_componentWillMount(){this._instanceId=a._nextInstanceId++,r.log(r.LogTraceArea.CallingUI,this.description("UNSAFE_componentWillMount"))}componentWillUnmount(){r.log(r.LogTraceArea.CallingUI,this.description("componentWillUnmount"))}componentDidMount(){r.log(r.LogTraceArea.CallingUI,this.description("componentDidMount"))}}t.CallingVideoViewBase=a,a._nextInstanceId=0;t.RNVideoFrame=class{constructor(e,t,i,n,r){this._width=e,this._height=t,this._mirrored=i,this._angle=n,this._key=r}getSize(){return{width:this._width,height:this._height}}isMirrored(){return this._mirrored}getAngle(){return this._angle}getKey(){return this._key}};t.ElectronVideoFrame=class{constructor(e){this.imageData=e,this._imageData=e}getSize(){return{width:this._imageData.width,height:this._imageData.height}}isMirrored(){return!1}getImageData(){return this._imageData}getAngle(){return 0}}},216837:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(683474),t);var r=i(683474);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},683474:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VideoView=t.RNVideoFrame=t.ElectronVideoFrame=void 0;const n=i(197582),r=i(785893),s=n.__importStar(i(496486)),a=n.__importStar(i(167606)),o=n.__importStar(i(973935)),l=n.__importStar(i(516778)),d=n.__importStar(i(397691)),c=i(233955),h=i(26703),u="inset 0.5s",p="top 0.5s, left 0.5s",g="none",m=(0,h.lazyProperties)({flippedView:()=>l.Styles.createViewStyle({transform:[{scaleX:-1}]}),webVideoContainerAnimation:()=>({transition:u}),zoomPositionControl:()=>({width:"100%",height:"100%",position:"absolute",top:0,left:0,transition:p})});class f extends c.CallingVideoViewBase{constructor(){super(...arguments),this._setZoomPositionControlRef=e=>{this._zoomPositionControlEl=e||void 0},this._setVideoDivRef=e=>{this._videoDiv=o.findDOMNode(e),a.log(a.LogTraceArea.CallingUI,this.description("_setVideoDivRef")+" video: "+!!e+" videoDiv: "+!!this._videoDiv)}}description(e){return(this.props.parentView?this.props.parentView+".":"")+`${this._getVideoViewId()}.${e}`}render(){let e;this.props.videoBorderRadius&&(e=l.Styles.createViewStyle({borderRadius:this.props.videoBorderRadius,overflow:"hidden"},!1));let t=e?l.Styles.combine(e,this.props.style):this.props.style;this.props.isLocal&&(t=l.Styles.combine(t,m.flippedView)),t=l.Styles.combine(t,m.webVideoContainerAnimation);const i=this._getVideoViewId();return(0,r.jsx)("div",{ref:this._setZoomPositionControlRef,style:m.zoomPositionControl,children:(0,r.jsx)("div",{style:this._combineStyleArray([t]),className:"webVideoContainer",id:i,ref:e=>this._setVideoDivRef(e)})})}handleZoomPositionUpdate(e,t){this._zoomPositionControlEl&&(e&&(this._zoomPositionControlEl.style.left=e),t&&(this._zoomPositionControlEl.style.top=t))}togglePositionChangeAnimation(e){this._zoomPositionControlEl&&(this._zoomPositionControlEl.style.transition=e?p:g)}getZoomControllerRect(){if(this._zoomPositionControlEl){const e=this._zoomPositionControlEl.getBoundingClientRect();return{width:e.width,height:e.height}}}handleZoom(e){this._videoDiv&&void 0!==this._videoDiv.style.inset&&(this._videoDiv.style.inset=e)}_getVideoViewId(){return`CallingVideoView[${this.props.nametag}][${this._getInstanceId()}]`}_combineStyleArray(e){if(s.isArray(e)){const t=e.map((e=>this._combineStyleArray(e)));return s.extend({},...t)}return e}getVideoContainer(){return this._videoDiv}panVideo(e){}resetPan(){}captureStill(e,t){return d.Rejected()}}var S=i(233955);Object.defineProperty(t,"ElectronVideoFrame",{enumerable:!0,get:function(){return S.ElectronVideoFrame}}),Object.defineProperty(t,"RNVideoFrame",{enumerable:!0,get:function(){return S.RNVideoFrame}}),t.VideoView=void 0,t.default=f},609481:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CallingMethod=t.CallingStackState=void 0,t.defer=c;const n=i(197582),r=n.__importStar(i(496486)),s=n.__importStar(i(167606)),a=i(743726);var o,l;!function(e){e[e.None=0]="None",e[e.Initialized=1]="Initialized",e[e.Started=2]="Started"}(o||(t.CallingStackState=o={})),function(e){e[e.EarlyStart=0]="EarlyStart",e[e.SetEcs=1]="SetEcs",e[e.GetEcs=2]="GetEcs",e[e.GetNodeId=3]="GetNodeId",e[e.GetRegistrationId=4]="GetRegistrationId",e[e.GetFingerprintId=5]="GetFingerprintId",e[e.Unmute=6]="Unmute",e[e.GetVolume=7]="GetVolume",e[e.SetVolume=8]="SetVolume",e[e.GetSystemVolume=9]="GetSystemVolume",e[e.SetSystemVolume=10]="SetSystemVolume",e[e.GetOutputLevels=11]="GetOutputLevels",e[e.ProvideCqf=12]="ProvideCqf"}(l||(t.CallingMethod=l={}));const d={[l.EarlyStart]:o.Initialized,[l.SetEcs]:o.Initialized,[l.GetEcs]:o.Initialized,[l.GetNodeId]:o.Initialized,[l.GetRegistrationId]:o.Initialized,[l.GetFingerprintId]:o.Initialized,[l.Unmute]:o.Started,[l.GetVolume]:o.Started,[l.SetVolume]:o.Started,[l.GetSystemVolume]:o.Started,[l.SetSystemVolume]:o.Started,[l.GetOutputLevels]:o.Started,[l.ProvideCqf]:o.Initialized};function c(){let e,t;return{promise:new Promise(((i,n)=>{e=i,t=n})),resolve:e,reject:t}}class h{constructor(){this._state=o.None,this._waitingForState={}}onStateChanged(e){if(this.isInState(e))return;const t=(0,a.newCauseId)();s.log(s.LogTraceArea.Calling,"Setting state "+o[this._state]+" -> "+o[e]+" causeId: "+t),this._state=e;const i=h._getResolveRejectStates(e);r.each(i.resolve,(e=>{const i=this._waitingForState[e];i?(delete this._waitingForState[this._state],s.log(s.LogTraceArea.Calling,"Completed promises waiting for state change "+o[e]+" causeId: "+t),i.resolve(void 0)):s.log(s.LogTraceArea.Calling,"No promises waiting for state change "+o[e]+" causeId: "+t)})),r.each(i.reject,(e=>{const i=this._waitingForState[e];i?(delete this._waitingForState[this._state],s.log(s.LogTraceArea.Calling,"Rejected promises waiting for state change "+o[e]+" causeId: "+t),i.reject(new Error("Calling is in state "+o[e]))):s.log(s.LogTraceArea.Calling,"No promises waiting for state change "+o[e]+" causeId: "+t)}))}isInState(e){return this._isInStates([e])}_isInStates(e){return r.some(e,(e=>e===this._state))}waitForStateForMethod(e){return this.waitForState(d[e])}waitForState(e){if(this._isInStates(h._getValidStates(e)))return Promise.resolve();let t=this._waitingForState[e];return t||(t=c(),this._waitingForState[e]=t),t.promise}static _getResolveRejectStates(e){switch(e){case o.None:return{resolve:[o.None],reject:[o.Initialized,o.Started]};case o.Initialized:return{resolve:[o.Initialized],reject:[]};case o.Started:return{resolve:[o.Initialized,o.Started],reject:[]}}}static _getValidStates(e){switch(e){case o.None:case o.Started:return[e];case o.Initialized:return[e,o.Started]}}}t.default=h},573203:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=n.__importStar(i(496486)),s=n.__importStar(i(167606));class a{constructor(e){this._getPrefix=r.isFunction(e)?e:()=>e}createChild(e){const t=r.isFunction(e)?e:()=>e;return new a((()=>this._getPrefix()+"/"+t()))}log(...e){this._apply((e=>s.log(s.LogTraceArea.TsCalling,e)),e)}debug(...e){this._apply((e=>s.debug((()=>e))),e)}info(...e){this._apply((e=>s.log(s.LogTraceArea.TsCalling,e)),e)}warn(...e){this._apply((e=>s.warn(s.LogTraceArea.TsCalling,e)),e)}error(...e){this._apply((e=>s.error(s.LogTraceArea.TsCalling,e)),e)}_apply(e,t=[]){this._addPrefix(t);const i=t.map((e=>r.isObject(e)?JSON.stringify(e):e)).join(", ");e.call(s,i)}_addPrefix(e){if(e&&e[0]){const t=this._getPrefix()+" "+e[0];e[0]=t}}}t.default=a},264596:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(998748),t);var r=i(998748);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},499025:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(174958),s=n.__importStar(i(496486)),a=i(743726),o=i(662783);t.default=class{constructor(e){this._logger=e,this._requests={}}getRequestOptions(e,t,i,n){return{headers:t||{},reporting:{serviceName:"HttpRequestDispatcher"+(e?`-${e}`:"")},payload:i,timeout:n}}getAsync(e,t){return this._executeWebRequest("GET",e,t)}postAsync(e,t){return this._executeWebRequest("POST",e,t)}putAsync(e,t){return this._executeWebRequest("PUT",e,t)}removeAsync(e,t){return this._executeWebRequest("DELETE",e,t)}_executeWebRequest(e,t,i){const n=(0,a.newGuid)(),l=new o.SimpleWebRequest(e,t,this._requestOptionsToWebRequestOptions(i));return this._requests[n]=l,this._mostRecentRequest=l,s.isUndefined(i.timeout)||s.isNumber(i.timeout)||i.timeout.then((()=>{const i=this._requests[n];i&&(this._logger.warn(`Aborting on timeout ${e} request url: ${r.pii.Omit(t)} id: ${n}`),delete this._requests[n],i.abort())})),this._logger.debug(`Initiating ${e} request url: ${r.pii.Omit(t)} id: ${n}`),l.start().then((i=>(this._logger.debug(`Completing ${e} request url: ${r.pii.Omit(t)} id: ${n}`),{request:{status:i.statusCode,statusText:i.statusText},response:i.body?i.body:{status:i.statusCode}}))).fail((()=>this._logger.warn(`Failing on error ${e} request url: ${r.pii.Omit(t)} id: ${n}`))).finally((()=>delete this._requests[n])).toEs6Promise()}_requestOptionsToWebRequestOptions(e){const t=this._splitRequestHeaders(e.headers),i={headers:t.headers,overrideGetHeaders:t.headers,retries:0,contentType:t.contentType||"application/json",acceptType:t.acceptType,sendData:e.payload,priority:o.WebRequestPriority.High};return s.isNumber(e.timeout)&&(i.timeout=e.timeout),i}_splitRequestHeaders(e){const t=e["Content-Type"],i=e.Accept;if(!t&&!i)return{headers:e};const n=s.clone(e);return delete n["Content-Type"],delete n.Accept,{headers:n,contentType:t,acceptType:i}}test_getMostRecentRequest(){return this._mostRecentRequest}}},998748:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HttpRequestDispatcher=t.CallingStackState=t.CallingLogger=t.CallingLifetime=void 0;const n=i(197582),r=i(566456),s=n.__importStar(i(609481));t.CallingLifetime=s.default,Object.defineProperty(t,"CallingStackState",{enumerable:!0,get:function(){return s.CallingStackState}});const a=n.__importDefault(i(573203));t.CallingLogger=a.default;const o=n.__importDefault(i(786714));var l=i(499025);Object.defineProperty(t,"HttpRequestDispatcher",{enumerable:!0,get:function(){return n.__importDefault(l).default}});t.default=new class{constructor(){this._lifetime=new s.default}getVersion(){return r.pluginlessStackFactory.getVersion()}initialize(e){return this._lifetime.isInState(s.CallingStackState.Initialized)?Promise.resolve(this._callingStack):o.default.initialize({logger:new a.default("Calling"),version:e.version,debug:e.debug,localeProvider:e.localeProvider,tokenProvider:e.tokenProvider,telemetry:e.telemetry,clientInfoProvider:e.clientInfoProvider,getMDNTRAPClientConfig:e.getMDNTRAPClientConfig}).then((e=>(this._callingStack=e,this._lifetime.onStateChanged(s.CallingStackState.Initialized),e)))}earlyStart(){return Promise.resolve()}getStack(){return this._callingStack}onStarted(){this._lifetime.onStateChanged(s.CallingStackState.Started)}onStopped(){this._lifetime.isInState(s.CallingStackState.None)||this._lifetime.onStateChanged(s.CallingStackState.Initialized)}setEcsConfig(e){return this._lifetime.waitForStateForMethod(s.CallingMethod.SetEcs).then((()=>this._callingStack.getEcsProvider().setEcsConfig(e)))}getEcsQueryParameters(){return this._lifetime.waitForStateForMethod(s.CallingMethod.GetEcs).then((()=>this._callingStack.getEcsProvider().getEcsQueryParameters()))}shouldTriggerCQF(e,t,i){return this._lifetime.waitForStateForMethod(s.CallingMethod.GetEcs).then((()=>this._callingStack.getEcsProvider().shouldTriggerCQF(e,t,i)))}getNodeId(){return Promise.resolve(void 0)}getRegistrationId(){return Promise.resolve(void 0)}getFingerprintId(){return Promise.resolve(void 0)}unmuteSpeaker(){}getSpeakerVolume(){return Promise.reject("Not supported")}setSpeakerVolume(e){return Promise.reject("Not supported")}getSpeakerSystemVolume(){return Promise.reject("Not supported")}setSpeakerSystemVolume(e){return Promise.reject("Not supported")}unmuteMicrophone(){}getMicrophoneVolume(){return Promise.reject("Not supported")}setMicrophoneVolume(e){return Promise.reject("Not supported")}popUpVideoDeviceSetting(e){return Promise.reject("Not supported")}getNrgLevelsForDeviceTuner(e){return Promise.reject("Not supported")}provideCallQualityFeedback(e,t,i,n,r,s){}}},786714:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=n.__importStar(i(496486)),s=i(815063),a=i(566456),o=n.__importDefault(i(499025)),l=n.__importDefault(i(800449)),d=n.__importDefault(i(739665));function c(){return l.default.getTrouter().getInternal()}class h{constructor(e){this._config=e}getCallingAdapter(){const e=this._config.callingSender;return{sendEvent(t,i){e(t,i)}}}getGenericTelemetryLogger(e){const t=this._config.genericSender;return{sendEvent(i){t(e,i.eventName,i.props)}}}sendEvents(e){return r.each(e,(e=>this._config.callingSender(e.eventName,e.props))),Promise.resolve()}}class u{constructor(e){this._getMDNTRAPClientConfig=e}getSkypeConfig(){return Promise.resolve({})}getRelayConfig(){return Promise.resolve(this._getMDNTRAPClientConfig())}}class p{constructor(e){this._logger=e}getVideoEffectProvider(){return n.__awaiter(this,void 0,void 0,(function*(){const{VideoEffectProvider:e}=yield n.__awaiter(void 0,void 0,void 0,(function*(){return new Promise(((e,t)=>{i.e(751).then((n=>{try{const t=i(466222);e(t)}catch(e){t(e)}}).bind(null,i)).catch(i.oe)}))}));return new e(this._logger)}))}getModelConfig(){return n.__awaiter(this,void 0,void 0,(function*(){return{modelUrl:"",weightPathPrefix:""}}))}}class g{initialize(e){this._config=e,this._httpRequestDispatcher=new o.default(this._config.logger.createChild("HTTP"));const t={signalingAgentConfig:this._getSignalingAgentConfig(),mediaAgentFactoryConfig:this._getMediaAgentFactoryConfig(),trouterService:c(),logger:this._config.logger,telemetryService:this._getTelemetryService(),platformType:g._getPlatformName(),telemetryTenants:{media:this._config.telemetry.tenants.media,signaling:this._config.telemetry.tenants.signaling},callSettings:{useLwjForAllCalls:!1}};return a.pluginlessStackFactory.build(t)}_getSignalingAgentConfig(){return{conversationServiceUrl:"https://api.conv.skype.com/conv/",trouterServiceProvider:new d.default(c()),logger:this._config.logger.createChild("SignalingAgent"),skypeToken:this._config.tokenProvider,languageCode:this._config.localeProvider,clientInformation:this._config.clientInfoProvider(),doHostlessCalling:!0,shouldServiceSendCallEventMessages:!0,shouldServiceSendNGCUpgradeMessages:!0,supportsHostlessGroupCalls:!0,httpRequestDispatcher:this._httpRequestDispatcher,isGVCJoiningEnabled:!0,isGVCOutgoingEnabled:!0,serverMuteUnmute:!0,cloudScreenSharingFlag:"enabled",isWebRtcEnabled:s.BrowserEnvironment.isChrome(),emergencyCallCountry:"",telemetryManager:this._getTelemetryService().getCallingAdapter()}}_getMediaAgentFactoryConfig(){const e=this._config.logger.createChild("MediaAgent");return{logger:e,tokenProvider:this._config.tokenProvider,configProvider:new u(this._config.getMDNTRAPClientConfig),settings:this._getMediaAgentConfig(e),httpRequestDispatcher:this._httpRequestDispatcher,appStateProvider:this._getAppStateProvider(),webcvProvider:new p(this._config.logger.createChild("WebCV")),detectH264Support:this._shouldDetectH264Support()}}_shouldDetectH264Support(){return s.BrowserEnvironment.isEngineChromium()}_getTelemetryService(){return new h(this._config.telemetry)}static _getPlatformName(){return s.BrowserEnvironment.isChrome()?"chrome":s.BrowserEnvironment.isEngineEdgeHTML()?"edge":s.BrowserEnvironment.isFirefox()?"firefox":s.BrowserEnvironment.isSafari()?"safari":"unknown"}_getMediaAgentConfig(e){return{debug:this._config.debug,logger:e,numVideoChannelsGvc:6,requestTimeoutMs:3e4,webrtcVideoSubscriptionDisposeTimeout:0}}_getAppStateProvider(){return{isOnline:()=>!0}}}t.default=new g},739665:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(942111),s=n.__importStar(i(496486));t.default=class{constructor(e){this._trouterService=e,this._trouterUrlGenerator=new a,this.trouterUrl=this._trouterUrlGenerator.generate()}state(){return this._trouterService?this._trouterService.state():r.TrouterState.Disconnected}getTrouterUrlAsync(){return this._trouterService?this._trouterService.getTrouterUrlAsync():Promise.reject("Trouter not available")}checkConnection(e){this._trouterService&&this._trouterService.checkConnection&&this._trouterService.checkConnection(e)}onStateChanged(e){this._trouterService&&this._trouterService.onStateChanged(e)}offStateChanged(e){this._trouterService&&this._trouterService.offStateChanged(e)}};class a{constructor(){this._changedListeners=[]}generate(){return s.assign(this._observableFunc,{changed:s.assign(this._changedFunc,{off:this._offFunc}),_notifyAll:this._notifyAll,_value:this._value,_changedListeners:this._changedListeners})}_observableFunc(e){if(s.isUndefined(e))return this._value;this._value=e,this._notifyAll(e)}_notifyAll(e){s.each(this._changedListeners,(t=>t(e)))}_changedFunc(e){this._changedListeners.push(e)}_offFunc(e){s.remove(this._changedListeners,(t=>t===e))}}},451021:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(479665),t);var r=i(479665);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},479665:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582).__importStar(i(397691));t.default=new class{saveToCameraRoll(e,t){return n.Rejected("Camera roll not implemented for Web")}getPhotos(e){return n.Rejected("Camera roll not implemented for web")}}},332605:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CameraViewBase=t.CameraPreviewFailureNoCamera=t.CameraPreviewFailureErrorOnStart=void 0;const n=i(197582).__importStar(i(516778));t.CameraPreviewFailureErrorOnStart="ErrorOnStartCamera",t.CameraPreviewFailureNoCamera="NoCamera";class r extends n.Component{}t.CameraViewBase=r},842232:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CameraView=t.DefaultCamera=t.CameraPreviewFailureNoCamera=t.CameraPreviewFailureErrorOnStart=void 0;const n=i(197582),r=i(785893),s=n.__importStar(i(516778)),a=n.__importStar(i(397691)),o=i(332605);var l=i(332605);Object.defineProperty(t,"CameraPreviewFailureErrorOnStart",{enumerable:!0,get:function(){return l.CameraPreviewFailureErrorOnStart}}),Object.defineProperty(t,"CameraPreviewFailureNoCamera",{enumerable:!0,get:function(){return l.CameraPreviewFailureNoCamera}});class d{static getDefaultCamera(e){return a.Resolved("none")}}t.DefaultCamera=d;class c extends o.CameraViewBase{capture(e){return a.fromThenable(c._rejectPromise("Capture not available"))}supportedCameras(){return a.fromThenable(c._resolvePromise(0))}getDefaultCamera(e){return d.getDefaultCamera(e)}hasFlash(){return a.Resolved(!1)}startRecording(){return a.fromThenable(c._rejectPromise("Recording not available"))}finishRecording(){}cancelRecording(){}focusTap(e,t){}zoom(e,t,i){}setZoomFactor(e){}getMaxZoom(){return a.fromThenable(c._resolvePromise(0))}hasBackTelephotoCamera(){return a.fromThenable(c._resolvePromise(!1))}cancel(){}enterPreview(){}static discardTempFiles(){}destroy(){}render(){return(0,r.jsx)(s.View,Object.assign({},this.props,{style:this.props.style,children:this.props.children}))}static _rejectPromise(e){return new Promise(((t,i)=>i(e)))}static _resolvePromise(e){return new Promise(((t,i)=>t(e)))}}t.CameraView=c,t.default=c},482469:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(842232),t);var r=i(842232);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},23372:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CaptureMarkupPathBase=t.CaptureMarkupPathRenderType=void 0;const n=i(197582).__importStar(i(516778));var r;!function(e){e[e.All=0]="All",e[e.Current=1]="Current",e[e.Dormant=2]="Dormant"}(r||(t.CaptureMarkupPathRenderType=r={}));class s extends n.Component{}t.CaptureMarkupPathBase=s},901166:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(622062),t);var r=i(622062);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},622062:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CaptureMarkupPathRenderType=t.CaptureMarkupPath=void 0;const n=i(197582),r=i(785893),s=n.__importStar(i(516778)),a=i(23372);class o extends a.CaptureMarkupPathBase{addPoint(e){}addTap(e){}undoLast(){}flushPoints(){}setColor(e){}setStrokeWidth(e){}render(){return(0,r.jsx)(s.View,Object.assign({},this.props,{style:this.props.style,children:this.props.children}))}}t.CaptureMarkupPath=o;var l=i(23372);Object.defineProperty(t,"CaptureMarkupPathRenderType",{enumerable:!0,get:function(){return l.CaptureMarkupPathRenderType}}),t.default=o},748546:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CaptureSnapshotViewBase=void 0;const n=i(197582),r=n.__importStar(i(516778)),s=n.__importStar(i(397691));class a extends r.Component{static takeSnapshotOfWindow(e){return s.Rejected("NotImplemented")}static takeSnapshotOfView(e,t,i){return s.Rejected("NotImplemented")}}t.CaptureSnapshotViewBase=a},161502:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(54862),t);var r=i(54862);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},54862:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CaptureSnapshotView=void 0;const n=i(197582),r=i(785893),s=n.__importStar(i(516778)),a=n.__importStar(i(397691)),o=i(748546);class l extends o.CaptureSnapshotViewBase{static takeSnapshotOfWindow(e){return a.Rejected("takeSnapshotOfWindow not yet implemented on web")}static takeSnapshotOfView(e,t,i){return t?a.Resolved(t):a.Rejected("Snapshot not yet implemented on web")}takeSnapshot(e,t){return l.takeSnapshotOfView(this,e,t)}render(){return(0,r.jsx)(s.View,Object.assign({},this.props,{style:this.props.style,children:this.props.children}))}}t.CaptureSnapshotView=l,t.default=l},576540:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(773256),t);var r=i(773256);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},114168:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(293418),t);var r=i(293418);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},293418:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=n.__importStar(i(516778)),a=i(217041),o=(0,i(26703).lazyProperties)({container:()=>s.Styles.combine({flex:1,alignItems:"stretch",alignSelf:"stretch",overflow:"visible",display:"flex"})});class l extends a.ComponentBase{constructor(){super(...arguments),this._onRef=e=>{this._ref=e||void 0}}componentDidMount(){super.componentDidMount(),this._ref&&this._ref.addEventListener("copy",this.props.handler)}componentWillUnmount(){super.componentWillUnmount(),this._ref&&this._ref.removeEventListener("copy",this.props.handler)}render(){return(0,r.jsx)("div",{style:o.container,ref:this._onRef,children:this.props.children})}triggerCopy(){return!(!this._ref||!this._ref.ownerDocument)&&this._ref.ownerDocument.execCommand("copy")}}t.default=l},443584:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CredentialsMigration=void 0;const n=i(197582).__importStar(i(397691));t.CredentialsMigration=new class{tryMigrateCredentials(){return n.Rejected("Platform does not support credentials migration")}onMigrationComplete(){}}},591339:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});i(197582).__exportStar(i(443584),t)},790408:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DatabaseProvidersBase=void 0;const n=i(217215);t.DatabaseProvidersBase=class{getProviders(e=!1){const t={name:"InMemoryProvider",provider:new n.InMemoryProvider};return[...this._getPlatformProviders(e),t]}}},449829:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(126017),t);var r=i(126017);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},126017:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(769609),r=i(823645),s=i(790408);class a extends s.DatabaseProvidersBase{_getPlatformProviders(){return[{name:"IndexedDbProvider",provider:new n.IndexedDbProvider},{name:"WebSqlProvider",provider:new r.WebSqlProvider}]}}t.default=new a},453907:(e,t)=>{"use strict";var i,n,r,s,a,o,l;Object.defineProperty(t,"__esModule",{value:!0}),t.ToastLength=t.AppThemeType=t.OSTheme=t.DeviceOrientationInSpace=t.DeviceOrientation=t.DeviceRingerMode=t.Permission=void 0,function(e){e[e.Unknown=0]="Unknown",e[e.Camera=1]="Camera",e[e.Contacts=2]="Contacts",e[e.Location=3]="Location",e[e.Microphone=4]="Microphone"}(i||(t.Permission=i={})),function(e){e[e.Silent=0]="Silent",e[e.Vibrate=1]="Vibrate",e[e.Normal=2]="Normal",e[e.Unknown=3]="Unknown"}(n||(t.DeviceRingerMode=n={})),function(e){e[e.Unlocked=0]="Unlocked",e[e.Portrait=1]="Portrait",e[e.Landscape=2]="Landscape"}(r||(t.DeviceOrientation=r={})),function(e){e[e.Unknown=0]="Unknown",e[e.Portrait=1]="Portrait",e[e.PortraitUpsideDown=2]="PortraitUpsideDown",e[e.LandscapeLeft=3]="LandscapeLeft",e[e.LandscapeRight=4]="LandscapeRight"}(s||(t.DeviceOrientationInSpace=s={})),function(e){e[e.Light=0]="Light",e[e.Dark=1]="Dark",e[e.Unknown=2]="Unknown"}(a||(t.OSTheme=a={})),function(e){e[e.Light=0]="Light",e[e.Dark=1]="Dark",e[e.System=2]="System"}(o||(t.AppThemeType=o={})),function(e){e[e.long=1]="long",e[e.short=0]="short"}(l||(t.ToastLength=l={}))},331654:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(815260),t);var r=i(815260);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},815260:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DeviceOrientationInSpace=t.Permission=t.AppThemeType=t.OSTheme=t.DeviceRingerMode=t.DeviceOrientation=void 0;const n=i(197582),r=n.__importDefault(i(974634)),s=n.__importStar(i(397691)),a=i(453907),o=i(972830);var l=i(453907);Object.defineProperty(t,"DeviceOrientation",{enumerable:!0,get:function(){return l.DeviceOrientation}}),Object.defineProperty(t,"DeviceRingerMode",{enumerable:!0,get:function(){return l.DeviceRingerMode}}),Object.defineProperty(t,"OSTheme",{enumerable:!0,get:function(){return l.OSTheme}}),Object.defineProperty(t,"AppThemeType",{enumerable:!0,get:function(){return l.AppThemeType}}),Object.defineProperty(t,"Permission",{enumerable:!0,get:function(){return l.Permission}}),Object.defineProperty(t,"DeviceOrientationInSpace",{enumerable:!0,get:function(){return l.DeviceOrientationInSpace}}),t.default=new class{constructor(){var e,t,i;this.onResume=new r.default,this.onExit=new r.default,this.onSuspend=new r.default,this.onSystemIdleChange=new r.default,this.onReload=new r.default,this.osThemeChanged=new r.default,this.screenOnOffEvent=new r.default,this._orientationNotificationHandlers=new Map,null===(t=(e=window.matchMedia("(prefers-color-scheme: dark)")).addEventListener)||void 0===t||t.call(e,"change",(e=>{this.osThemeChanged.fire(e.matches?a.OSTheme.Dark:a.OSTheme.Light)})),null===(i=window.screen.orientation)||void 0===i||i.addEventListener("change",(e=>{const t=this._getOrientationInSpace(e.type),i=t===a.DeviceOrientationInSpace.Portrait||t===a.DeviceOrientationInSpace.PortraitUpsideDown?a.DeviceOrientation.Portrait:a.DeviceOrientation.Landscape;for(const[,e]of this._orientationNotificationHandlers)e(i,t)}))}isIgnoringBatteryOptimizations(){return Promise.resolve(void 0)}showToast(e){}showBatteryOptimizationNotification(){return Promise.resolve(!1)}isSystemIdle(){return Promise.resolve(!1)}enableProximitySensor(){return s.Resolved()}disableProximitySensor(){return s.Resolved()}blockScreenLock(){return s.Resolved()}allowScreenLock(){return s.Resolved()}enableLowProfileMode(){return s.Resolved()}disableLowProfileMode(){return s.Resolved()}reEnableKeyguardIfSet(e){return s.Resolved()}disableKeyguard(){}enableWifiLock(){return s.Resolved()}disableWifiLock(){return s.Resolved()}currentOrientation(){if(window.screen.orientation){const e=this._getOrientationInSpace(window.screen.orientation.type);return s.Resolved(e===a.DeviceOrientationInSpace.LandscapeLeft||e===a.DeviceOrientationInSpace.LandscapeRight?a.DeviceOrientation.Landscape:a.DeviceOrientation.Portrait)}return s.Resolved(a.DeviceOrientation.Unlocked)}currentOrientationInSpace(){let e=a.DeviceOrientationInSpace.Unknown;return window.screen.orientation&&(e=this._getOrientationInSpace(window.screen.orientation.type)),s.Resolved(e)}unlockOrientation(){var e;return null===(e=window.screen.orientation)||void 0===e||e.unlock(),s.Resolved(!0)}lockOrientation(e){return window.screen.orientation?s.fromThenable(window.screen.orientation.lock(e===a.DeviceOrientation.Landscape?"landscape":"portrait").then((()=>!0))):s.Resolved(!0)}registerShakeGestureListener(e,t){}removeShakeGestureListener(e){}addOrientationEventListener(e,t){this._orientationNotificationHandlers.set(e,t)}removeOrientationEventListener(e){this._orientationNotificationHandlers.delete(e)}setAutorotateEnabled(e){return s.Resolved(!1)}addSafeAreaEventListener(e,t){}removeSafeAreaEventListener(e){}addAccessibilityEscapeEventListener(e){}removeAccessibilityEscapeEventListener(e){}addVolumeKeyPressedEventListener(e,t){}removeVolumeKeyPressedEventListener(e){}isInLowPowerMode(){return s.Resolved(!1)}addLowPowerModeChangeListener(e,t){}removeLowPowerModeChangeListener(e){}getRingerMode(){return s.Resolved(a.DeviceRingerMode.Unknown)}vibrate(e){return s.Resolved(!1)}cancelVibrate(){return s.Resolved(!1)}screenDpi(){return s.Resolved(96*window.devicePixelRatio)}statusBarHeight(){return s.Resolved(0)}supportsNativeEmergencyCalling(){return s.Resolved(!1)}makeNativeEmergencyCall(e){return s.Resolved(!1)}makeNativeEmergencySMS(e){return s.Resolved(!1)}enableOrientationAnimation(){return s.Resolved()}disableOrientationAnimation(){return s.Resolved()}getMaxViewSizeForTexture(){return s.Resolved(0)}getPhoneNumber(){return s.Resolved("")}getMncMccCode(){return s.Resolved(void 0)}registerSMSReader(e,t){}unregisterSMSReader(e){}registerSMSOtpRetriever(e,t,i){return s.Resolved(!1)}unregisterSMSOtpRetriever(e){}getDeviceCountry(e){return s.Resolved(void 0)}safeAreaInsets(){return s.Resolved(void 0)}prepareFeedbackGenerator(){return s.Resolved(!1)}unprepareFeedbackGenerator(){return s.Resolved(!1)}triggerFeedback(){return s.Resolved(!1)}isSplitScreen(){return s.Resolved(!1)}addSplitScreenEventListener(e,t){}removeSplitScreenEventListener(e){}setUseSystemTheme(e){}updateVisuals(e,t,i,n,r){}isFullScreenMode(e){return s.Resolved(!!document.fullscreenElement||!!document.webkitCurrentFullScreenElement)}tryEnterFullScreenMode(e){const t=document.querySelector("html");return t&&t.requestFullscreen?(t.requestFullscreen(),s.Resolved(!0)):t&&t.webkitRequestFullScreen?(t.webkitRequestFullScreen(),s.Resolved(!0)):s.Resolved(!1)}exitFullScreenMode(e){return document.exitFullscreen&&document.exitFullscreen(),document.webkitExitFullscreen&&document.webkitExitFullscreen(),s.Resolved()}getOSTheme(){return(0,o.isDarkThemeBrowser)()?s.Resolved(a.OSTheme.Dark):s.Resolved(a.OSTheme.Light)}setAppTheme(e){}storeAppThemeInfo(e){}openAppSettings(){}openAppPermissionOptions(e){}openSystemStartupSettings(){}uriForAsset(e){return s.Resolved(e)}rateApp(){}isAppInstalled(e){return s.Resolved(!1)}getT1UserSettings(e){return s.Resolved(void 0)}isT1UserSettingsMigrated(){return s.Resolved(!0)}markUserSettingsAsMigrated(){}isSyncAddressBookEnabledInT1(e){return s.Resolved(!1)}openScreenRecordingPrivacyPane(){}getAppMetrics(){return s.Resolved([])}getSystemUsage(){return s.Resolved(void 0)}getUptimeMillis(){return s.Resolved(0)}setNavigationBarColor(e,t){}setNavigationBarStyle(e,t){}drawContentBehindSystemBars(e){}launchChromeAppAtURL(e){return Promise.resolve(!1)}isChromeAppInstalled(){return Promise.resolve(!1)}launchSafariSettings(){return Promise.resolve(!1)}_getOrientationInSpace(e){switch(e){case"portrait-primary":return a.DeviceOrientationInSpace.Portrait;case"portrait-secondary":return a.DeviceOrientationInSpace.PortraitUpsideDown;case"landscape-primary":return a.DeviceOrientationInSpace.LandscapeLeft;case"landscape-secondary":return a.DeviceOrientationInSpace.LandscapeRight}return a.DeviceOrientationInSpace.Unknown}}},344398:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582).__importStar(i(516778));class r extends n.Component{onDataChanged(e,t,i,n){}scrollToEnd(){}scrollToPosition(e){}}t.default=r},845666:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582).__importDefault(i(344398));t.default=n.default},166552:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(845666),t);var r=i(845666);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},928755:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Os=t.Engines=t.Browsers=t.EnvironmentInfoBaseClass=t.OperatingSystems=t.UITestsConfigOptions=t.PlatformType=void 0;const n=i(197582),r=n.__importStar(i(496486)),s=(n.__importStar(i(516778)),n.__importDefault(i(974634)));var a,o,l,d,c;!function(e){e[e.iOS=1]="iOS",e[e.Android=2]="Android",e[e.Windows=3]="Windows",e[e.OSX=4]="OSX",e[e.Linux=5]="Linux",e[e.Unknown=999]="Unknown"}(a||(t.PlatformType=a={})),function(e){e[e.IsUiResponsivenessModeOn=0]="IsUiResponsivenessModeOn",e[e.ShouldSkipOnboarding=1]="ShouldSkipOnboarding"}(o||(t.UITestsConfigOptions=o={})),t.OperatingSystems={Windows:"Windows",MacOSX:"Mac OS",WindowsPhone:"Windows Phone",WindowsRT:"Windows RT",IOS:"iOS",Android:"Android",Linux:"Linux",Unknown:"Unknown"};t.EnvironmentInfoBaseClass=class{constructor(){this.onLocaleChange=new s.default(!0)}getPlatformType(){if(r.isNumber(this._platformType))return this._platformType;switch(this._osName){case t.OperatingSystems.IOS:this._platformType=a.iOS;break;case t.OperatingSystems.Android:this._platformType=a.Android;break;case t.OperatingSystems.Windows:case t.OperatingSystems.WindowsRT:case t.OperatingSystems.WindowsPhone:this._platformType=a.Windows;break;case t.OperatingSystems.MacOSX:this._platformType=a.OSX;break;case t.OperatingSystems.Linux:this._platformType=a.Linux;break;default:this._platformType=a.Unknown}return this._platformType}getPlatformTypeName(){return a[this.getPlatformType()]}isMobile(){return!1}getPhoneNumber(){return Promise.resolve(void 0)}},function(e){e.Unknown="Unknown",e.MsIE="IE",e.Chrome="Chrome",e.Chromium="Chromium",e.Firefox="Firefox",e.Safari="Safari",e.MobileSafari="Mobile Safari",e.Edge="Edge",e.Electron="Electron",e.SkypeShell="SkypeShell",e.Opera="Opera",e.Yandex="Yandex"}(l||(t.Browsers=l={})),function(e){e.Unknown="Unknown",e.Webkit="WebKit",e.Blink="Blink",e.EdgeHTML="EdgeHTML",e.Gecko="Gecko",e.Trident="Trident"}(d||(t.Engines=d={})),function(e){e.Unknown="Unknown",e.Android="Android",e.iOS="iOS",e.MacOS="Mac OS",e.Windows="Windows",e.Linux="Linux"}(c||(t.Os=c={}))},815063:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(158827),t);var r=i(158827);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},158827:(e,t,i)=>{"use strict";var n=i(734155);Object.defineProperty(t,"__esModule",{value:!0}),t.UITestsConfigOptions=t.PlatformType=t.OperatingSystems=t.Browsers=t.BrowserEnvironment=t.EnvironmentInfo=t.WebEnvironmentInfo=void 0,t.getUserSessionInfo=function(){return Promise.reject(new Error("getUserSessionInfo not implemented."))},t.updateUserSessionActivationSource=function(e,t){};const r=i(197582),s=r.__importStar(i(496486)),a=i(743726),o=r.__importDefault(i(42238)),l=i(928755),d="deviceId";class c extends l.EnvironmentInfoBaseClass{constructor(){var e,t,i,n,r,a,d,c,h;if(super(),this.Unknown="Unknown","undefined"==typeof navigator||"undefined"==typeof document)return this._browserName=l.Browsers.Unknown,this.SystemLocale="en-US",this.SystemLanguage="en",this.SystemModel=l.Browsers.Unknown,void(this.OsVersion=this.Unknown);const u=[];s.each(navigator.plugins,(e=>{u.push(e.name)}));const p=this._getLocaleInfo();if(window.addEventListener("languagechange",(()=>{this.onLocaleChange.fire(this._getLocaleInfo())})),"undefined"!=typeof window&&void 0!==window.electronApi){const e=window.electronApi.ipcProvider.environment.getInfo.send();this.InitializationTimestamp=e.initializationTimestamp,this.AppLoadDuration=e.electronLoadDuration,this.CorporateInstallationTag=e.corporateInstallationTag,this.StartUpInfo=e.startupInfo,this.SkypeProcessInfo=e.skypeProcessInfo,this.ActivateKind=e.activateKind}else this.InitializationTimestamp=0,this.AppLoadDuration=0;this._miniNavigator={userAgent:null!==(e=navigator.userAgent)&&void 0!==e?e:"",vendor:navigator.vendor,language:p.systemLanguage,plugins:u};const g=(new o.default).getResult();this._browserName=null!==(t=g.browser.name)&&void 0!==t?t:l.Browsers.Unknown,this._engineName=null!==(i=g.engine.name)&&void 0!==i?i:l.Engines.Unknown,this._isMobile=!!s.includes([o.default.DEVICE.MOBILE,o.default.DEVICE.TABLET],g.device.type),this._osName=null!==(n=g.os.name)&&void 0!==n?n:l.Os.Unknown,this._isConsideredAsChromium=this._chromiumCheck(this._engineName)&&this._browserName!==l.Browsers.Electron;const m={main:null!==(r=g.browser.version)&&void 0!==r?r:this.Unknown,chrome:this._chromiumCheck(this._engineName)?null!==(a=g.engine.version)&&void 0!==a?a:this.Unknown:this._browserName===l.Browsers.Chrome&&null!==(d=g.browser.version)&&void 0!==d?d:this.Unknown},f=this._getBrowserUIFeaturesSupport(this._browserName,m,this._engineName);this._supportsCopy=f.isCopySupported,this._supportsDragAndDropEffect=f.isDragAndDropSupported;const S=this._getDeviceIds();this.SystemModel=this._browserName,this.SystemManufacturer=m.main,this.SystemLocale=p.systemLocale,this.SystemLanguage=p.systemLanguage,this.OsName=this._osName,this.DeviceId=S.deviceId,this.DeviceName=S.deviceName,this.OsVersion=null!==(c=g.os.version)&&void 0!==c?c:this.Unknown;const v=!!(null===(h=navigator.mediaDevices)||void 0===h?void 0:h.getDisplayMedia);this._supportsScreenSharing=v&&!this.isMobile()}supportsCopy(){return this._supportsCopy}supportsDragAndDropEffect(){return this._supportsDragAndDropEffect}supportsScreenSharing(){return this._supportsScreenSharing}supportsNotifications(){return"Notification"in window}isMobile(){return this._isMobile}isAndroid(){return this.OsName===l.Os.Android}isEngineChromium(){return this._isConsideredAsChromium}isEngineChromiumEdge(){return this._browserName===l.Browsers.Edge&&this._chromiumCheck(this._engineName)}isEngineGecko(){return this._engineName===l.Engines.Gecko}isEngineWebkit(){return this._engineName===l.Engines.Webkit}isEngineEdgeHTML(){return this._engineName===l.Engines.EdgeHTML}isEngineTrident(){return this._engineName===l.Engines.Trident}getBrowserEngine(){return this._engineName}isChrome(){return this._isChromeOrChromiumEdge(this._browserName,this._engineName)}isFirefox(){return this._browserName===l.Browsers.Firefox}isSafari(){return this._browserName===l.Browsers.Safari||this._browserName===l.Browsers.MobileSafari}getUserAgent(){var e;return null!==(e=this._miniNavigator.userAgent)&&void 0!==e?e:""}_isChromeOrChromiumEdge(e,t){return e===l.Browsers.Chrome||e===l.Browsers.Edge&&this._chromiumCheck(t)}_chromiumCheck(e){return e===l.Engines.Blink}_getBrowserUIFeaturesSupport(e,t,i){const r=this._isConsideredAsChromium&&this._versionCompare(t.chrome,"43.0.2356")>0,s=e===l.Browsers.Firefox&&this._versionCompare(t.main,"41.0")>=0,a=(e===l.Browsers.Safari||e===l.Browsers.MobileSafari)&&this._versionCompare(t.main,"10.0")>=0,o=e===l.Browsers.Opera&&this._versionCompare(t.main,"29.0")>=0,d=e===l.Browsers.MsIE&&this._versionCompare(t.main,"10.0")>=0,c=e===l.Browsers.Edge,h=e===l.Browsers.Electron&&n&&n.versions&&"undefined"!==n.versions.electron;return{isCopySupported:r||s||d||c||o||a||h,isDragAndDropSupported:r||s||h}}_getDeviceIds(){let e,t;if("undefined"!=typeof window&&void 0!==window.electronApi)e=window.electronApi.ipcProvider.device.getId.send()||(0,a.newGuid)(),t=window.electronApi.ipcProvider.device.getDeviceName.send()||window.electronApi.ipcProvider.device.getHostname.send();else{let i,n;"undefined"!=typeof document&&(i=document.cookie.split(/[;,]/g),n=s.find(i,(e=>e.split("=")[0].trim()===d))),e=n?n.substring(n.indexOf("=")+1):(0,a.newGuid)(),t=e,document.cookie=d+"="+e}return{deviceName:t,deviceId:e}}_versionCompare(e,t,i){const n=i&&i.lexicographical,r=i&&i.zeroExtend;let s=e.split("."),a=t.split(".");const o=e=>(n?/^\d+[A-Za-z]*$/:/^\d+$/).test(e);if(!s.every(o)||!a.every(o))return NaN;if(r){for(;s.length<a.length;)s.push("0");for(;a.length<s.length;)a.push("0")}n||(s=s.map(Number),a=a.map(Number));for(let e=0;e<s.length;++e){if(a.length===e)return 1;if(s[e]!==a[e])return s[e]>a[e]?1:-1}return s.length!==a.length?-1:0}_getLocaleInfo(){let e;if("undefined"!=typeof window&&void 0!==window.electronApi){const t=window.electronApi.ipcProvider.localisation.getLocaleCountryCode.send();2===t.length&&(e=navigator.language.substring(0,2)+"-"+t)}e||(e=s.head(navigator.languages)||navigator.language||navigator.userLanguage||"en-US");const t=e.split("-");return{systemLocale:e,systemLanguage:t.shift(),systemCountry:""}}}t.WebEnvironmentInfo=c;const h=new c;t.EnvironmentInfo=h,t.BrowserEnvironment=h;var u=i(928755);Object.defineProperty(t,"Browsers",{enumerable:!0,get:function(){return u.Browsers}}),Object.defineProperty(t,"OperatingSystems",{enumerable:!0,get:function(){return u.OperatingSystems}}),Object.defineProperty(t,"PlatformType",{enumerable:!0,get:function(){return u.PlatformType}}),Object.defineProperty(t,"UITestsConfigOptions",{enumerable:!0,get:function(){return u.UITestsConfigOptions}}),t.default=t.EnvironmentInfo},260955:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.normalizeLogs=void 0,t.packCrashLogs=function(e,i){if(e){let r=n.textToBytes("Debug information:\n\n"+e);if(i){let e="Log buffer:\n\n";r.length>0&&(e="\n\n"+e),r=r.concat(n.textToBytes(e),n.fromBase64((0,t.normalizeLogs)(i)))}return n.toBase64(r)}return i?(0,t.normalizeLogs)(i):void 0};const n=i(197582).__importStar(i(775463));t.normalizeLogs=e=>e.replace("ULOG2!","").trim()},940028:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(946150),t);var r=i(946150);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},946150:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=n.__importStar(i(174958)),s=i(815063),a=n.__importStar(i(167606)),o=i(743726),l=i(662783),d=n.__importStar(i(397691)),c=n.__importDefault(i(150343)),h=n.__importStar(i(704704)),u=n.__importDefault(i(139221)),p=i(260955),g=/Cannot redefine property: BetterJsPop|ResizeObserver loop limit exceeded/i;t.default=new class{constructor(){this.handleException=e=>!g.test(e.errorMessage)?r.RootToolsManager.dumpLogBuffer({filter:[{component:"root",level:0}]},{maxSize:0}).then((t=>{this._handleCrashReport(e,(0,p.packCrashLogs)(e.debugHeader,t))})).catch((()=>{this._handleCrashReport(e,(0,p.packCrashLogs)(e.debugHeader))})):d.Resolved()}_shouldReload(){return c.default.getS4LFeatures().exceptions.reloadOnException}_showAlertAndReload(){const e=c.default.isMurphyUser()||u.default.isDebug(),t=h.getString("Global.PageWillReload");let i;e?i=window.confirm(t):(window.alert(t),i=!0),i&&window.location.reload()}_handleCrashReport(e,t){const i=(0,o.newGuid)(),n=this._createHandledError(e,i);let r;t&&(r=this._createErrorAttachment(t,i)),this._sendCrashReport(n,r,(()=>{this._shouldReload()&&this._showAlertAndReload()}))}_createHandledError(e,t){return{id:t,type:"handledError",timestamp:(new Date).toISOString(),appLaunchTimestamp:(new Date).toISOString(),device:this._getDeviceInfo(),exception:{type:e.errorName,message:e.errorMessage,stackTrace:this._getReportString(e),innerExceptions:[]},userId:s.EnvironmentInfo.DeviceId}}_createErrorAttachment(e,t){return{errorId:t,type:"errorAttachment",timestamp:(new Date).toISOString(),device:this._getDeviceInfo(),contentType:"text/plain",data:e}}_getDeviceInfo(){return{appVersion:u.default.getAppVersion(),appBuild:"",sdkName:"appcenter.custom",sdkVersion:"0.1",osName:s.EnvironmentInfo.OsName,osVersion:s.EnvironmentInfo.OsVersion,model:s.EnvironmentInfo.SystemModel,locale:h.getLocale(),appNamespace:"com.microsoft.electron"}}_getReportString(e){return e.stackTrace?e.stackTrace:e.errorMessage?e.errorMessage+" at "+e.source+" ("+e.fileNumber+","+e.columnNumber+")":JSON.stringify(e)}_sendCrashReport(e,t,i){const n=u.default.getCrashReportingAppId();if(!n)return void a.error(a.LogTraceArea.GenericUnsafe,`App secret not found for host: ${u.default.getFrontendHost()}`);const r={logs:[e]};t&&r.logs.push(t);return new l.SimpleWebRequest("POST","https://in.appcenter.ms/logs?Api-Version=1.0.0",{headers:{"app-secret":n,"install-id":s.EnvironmentInfo.DeviceId},contentType:"application/json",sendData:r,retries:1}).start().then((e=>{a.log(a.LogTraceArea.GenericUnsafe,"Crash report response: ",e),i&&i()})).catch((e=>{a.log(a.LogTraceArea.GenericUnsafe,"Crash report failed: ",e),i&&i()}))}}},161545:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExtensionTelemetry=void 0;const n=i(197582).__importStar(i(397691));class r{getCalendarExtensionTelemetryData(){return n.Rejected("Not implemented.")}getSiriExtensionTelemetryData(){return n.Rejected("Not implemented.")}getShareExtensionTelemetryData(){return n.Rejected("Not implemented.")}getNotificationExtensionTelemetryData(){return n.Rejected("Not implemented.")}}t.ExtensionTelemetry=r,t.default=new r},880963:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(161545),t);var r=i(161545);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},587845:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(638753),t);var r=i(638753);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},650186:(e,t)=>{"use strict";var i,n,r;Object.defineProperty(t,"__esModule",{value:!0}),t.VerticalTextAlignment=t.HorizontalTextAlignment=t.GCPathTypes=void 0,function(e){e[e.Arc=0]="Arc"}(i||(t.GCPathTypes=i={})),function(e){e[e.Left=1]="Left",e[e.Center=2]="Center",e[e.Right=3]="Right"}(n||(t.HorizontalTextAlignment=n={})),function(e){e[e.Top=1]="Top",e[e.Center=2]="Center",e[e.Bottom=3]="Bottom"}(r||(t.VerticalTextAlignment=r={}))},55644:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(880791),t);var r=i(880791);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},880791:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VerticalTextAlignment=t.HorizontalTextAlignment=t.GCPathTypes=void 0;const n=i(197582),r=i(216837),s=n.__importStar(i(397691)),a=n.__importStar(i(650186));class o{constructor(){this._path=new Path2D,this.type=a.GCPathTypes.Arc}get2DPath(){return this._path}appencArcToPath(e,t,i,n){this._path.arc(e.x,e.y,t,i,n)}}class l{constructor(){this._allContexts={},this._nextRef=0}createImageContext(e,t){const i=document.createElement("canvas");return i?(i.width=e,i.height=t,s.Resolved(this._interCanvas(i))):s.Rejected()}_interCanvas(e){const t=this._nextRef++;return this._allContexts[t]=e,t}createImageContextWithURL(e,t,i){if(e){const n=s.Defer(),r=new Image,a=this;return r.onload=function(){const e=document.createElement("canvas"),r=e.getContext("2d");void 0!==t&&void 0!==i?(e.width=t,e.height=i,r.drawImage(this,0,0,t,i)):(e.width=this.naturalWidth,e.height=this.naturalHeight,r.drawImage(this,0,0)),n.resolve(a._interCanvas(e))},r.onerror=function(){n.reject()},r.src=e,n.promise()}return s.Rejected()}isContextValid(e){return void 0!==this._allContexts[e]&&void 0!==this._allContexts[e]}static extractFileExtension(e,t=!0){if(!e)return"";const i=e.lastIndexOf(".");let n="";return i>=0&&(n=e.substring(i+1)),t&&(n=n.toLowerCase()),n}createFileData(e,t,i){const n=this._allContexts[e];n.toBlob((function(e){if(null!==e){const r={file:new File([e],t),extension:l.extractFileExtension(t),dimensions:{width:n.width,height:n.height}};i(r)}else i(null)}),"image/jpeg",1)}createImageData(e,t,i,n,a){const o=s.Defer(),l=this._get2DContext(e);return l?o.resolve(new r.ElectronVideoFrame(l.getImageData(t,i,n,a))):o.reject(void 0),o.promise()}saveContext(e){const t=this._get2DContext(e);t&&t.save()}restoreContext(e){const t=this._get2DContext(e);t&&t.restore()}destroyContext(e){delete this._allContexts[e]}_get2DContext(e){const t=this._allContexts[e];return null!==t?t.getContext("2d"):null}setFillColor(e,t,i,n,r){const s=this._get2DContext(e);s&&(s.fillStyle="rgba("+t+", "+i+", "+n+", "+r+")")}setStrokeColor(e,t,i,n,r){const s=this._get2DContext(e);s&&(s.strokeStyle="rgba("+t+", "+i+", "+n+", "+r+")")}setFont(e,t,i,n){const r=this._get2DContext(e);r&&(r.font=(n?"bold ":"")+i+"pt "+t)}setLineWidth(e,t){const i=this._get2DContext(e);i&&(i.lineWidth=t)}setTextAlignment(e,t,i){const n=this._get2DContext(e);if(n){switch(t){case a.HorizontalTextAlignment.Left:n.textAlign="left";break;case a.HorizontalTextAlignment.Center:n.textAlign="center";break;case a.HorizontalTextAlignment.Right:n.textAlign="right"}switch(i){case a.VerticalTextAlignment.Top:n.textBaseline="top";break;case a.VerticalTextAlignment.Center:n.textBaseline="middle";break;case a.VerticalTextAlignment.Bottom:n.textBaseline="bottom"}}}getSize(e){const t=this._allContexts[e];return null!==t?{width:t.width,height:t.height}:{width:-1,height:-1}}setTranslate(e,t,i){const n=this._get2DContext(e);n&&n.translate(t,i)}clipPath(e,t){const i=this._get2DContext(e);if(i){const e=t;i.clip(e.get2DPath())}}drawImage(e,t,i,n,r,s,a,o,l,d){const c=this._get2DContext(e);if(c){const e=document.createElement("canvas");e.width=r,e.height=s;const h=e.getContext("2d");null!==h&&h.putImageData(t.getImageData(),0-i,0-n,i,n,r,s),c.drawImage(e,0,0,r,s,a,o,l,d)}}drawGraphicsContext(e,t,i,n){this.createImageData(t,i.origin.x,i.origin.y,i.size.width,i.size.height).then((t=>{void 0!==t&&this.drawImage(e,t,0,0,i.size.width,i.size.height,n.origin.x,n.origin.y,n.size.width,n.size.height)}))}fillText(e,t,i,n){const r=this._get2DContext(e);r&&r.fillText(t,i,n)}drawLinearGradient(e,t,i,n,r,s){const a=this._get2DContext(e);if(a){const e=a.createLinearGradient(t.x,t.y,n.x,n.y);e.addColorStop(0,i),e.addColorStop(1,r),a.fillStyle=e,a.fillRect(s.origin.x,s.origin.y,s.size.width,s.size.height)}}strokeArc(e,t,i,n,r){const s=this._get2DContext(e);s&&(s.arc(t.x,t.y,i,n,r),s.stroke())}fillArc(e,t,i,n,r){const s=this._get2DContext(e);s&&(s.arc(t.x,t.y,i,n,r),s.fill())}setFilter(e,t){const i=this._get2DContext(e);i&&(i.filter=t)}createPath(e){if(e===a.GCPathTypes.Arc)return new o}}var d=i(650186);Object.defineProperty(t,"GCPathTypes",{enumerable:!0,get:function(){return d.GCPathTypes}}),Object.defineProperty(t,"HorizontalTextAlignment",{enumerable:!0,get:function(){return d.HorizontalTextAlignment}}),Object.defineProperty(t,"VerticalTextAlignment",{enumerable:!0,get:function(){return d.VerticalTextAlignment}}),t.default=new l},326036:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(524163),t);var r=i(524163);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},239399:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(417613),t);var r=i(417613);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},417613:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InAppWebBrowser=void 0;const n=i(197582),r=i(785893),s=i(174958),a=n.__importStar(i(496486)),o=i(167606),l=n.__importStar(i(859745)),d=n.__importStar(i(516778)),c=n.__importDefault(i(453761)),h=n.__importDefault(i(320697)),u=n.__importStar(i(85385)),p=i(26703),g=n.__importStar(i(704704)),m=i(729196),f=i(16549),S=n.__importDefault(i(20758)),v=i(641400),y=n.__importStar(i(179582)),C=n.__importDefault(i(497910)),T=n.__importDefault(i(220534)),E={red:0,green:0,blue:0},_=(0,p.lazyProperties)({container:()=>d.Styles.createViewStyle({flex:1,flexDirection:"column",backgroundColor:f.Color.white}),webView:()=>d.Styles.createWebViewStyle({flex:1,backgroundColor:f.Color.white}),errorView:()=>d.Styles.createWebViewStyle({flex:1,paddingVertical:100,alignItems:"center"}),errorViewContainer:()=>d.Styles.createWebViewStyle({flex:-1,justifyContent:"center",alignItems:"center",padding:10}),errorActionBtnViewContainer:()=>d.Styles.createWebViewStyle({flex:1,alignItems:"center",justifyContent:"space-between",flexDirection:"row",marginBottom:10}),errorHeader:()=>d.Styles.createTextStyle({font:S.default.font.uiDisplayBold,textAlign:"center"}),errorText:()=>d.Styles.createTextStyle({font:S.default.font.uiDisplayRegular,textAlign:"center",marginTop:10}),errorActionButton:()=>d.Styles.createButtonStyle({justifyContent:"center",alignItems:"center",alignSelf:"center",flexWrap:"nowrap",marginHorizontal:10,borderWidth:1,borderRadius:15,height:30,width:90,marginTop:20}),actionButtonText:()=>d.Styles.createTextStyle({font:S.default.font.uiDisplayRegular,fontSize:S.default.fontSize.size13Deprecated}),footer:()=>d.Styles.createViewStyle({flexDirection:"row",height:48,paddingVertical:0,paddingHorizontal:0,alignItems:"center",alignSelf:"stretch",justifyContent:"flex-start",backgroundColor:f.Color.white,borderColor:f.Color.gray200,borderTopWidth:1,borderStyle:"solid"}),footerButton:()=>d.Styles.createButtonStyle({flex:-1,width:60}),optionalFooterButtonContainer:()=>d.Styles.createButtonStyle({flex:1,flexDirection:"row",justifyContent:"flex-end",alignItems:"center",alignSelf:"center",flexWrap:"nowrap"})});class b extends C.default{constructor(){super(...arguments),this._renderError=(e,t,i)=>{if(!this.state.isError)return null;const n=this.state.errorDomain?this.state.errorDomain:e,s=this.state.errorCode?this.state.errorCode:t,a=this.state.errorDescription?this.state.errorDescription:i,o=[_.errorActionButton,d.Styles.createButtonStyle({borderColor:this._themeColors.primaryTextColor},!1)];return(0,r.jsx)(d.View,{style:_.errorView,children:(0,r.jsxs)(d.View,{style:_.errorViewContainer,children:[(0,r.jsx)(d.Text,{style:_.errorHeader,children:g.getString("InAppWebBrowser.GenericErrorTitle")}),(0,r.jsxs)(d.View,{style:_.errorActionBtnViewContainer,children:[(0,r.jsx)(d.Button,{style:o,onPress:this._goBack,children:(0,r.jsx)(d.Text,{style:[_.actionButtonText,this._themeStyles.primaryTextColorStyle],children:g.getString("InAppWebBrowser.BackFromErrorTitle")})},"backFromErrorButton"),(0,r.jsx)(d.Button,{style:o,onPress:this._showDetailedError,children:(0,r.jsx)(d.Text,{style:[_.actionButtonText,this._themeStyles.primaryTextColorStyle],children:this.state.showDetailedError?g.getString("InAppWebBrowser.HideErrorDetails"):g.getString("InAppWebBrowser.ShowErrorDetails")})},"errorDetailsButton")]}),!!this.state.showDetailedError&&a&&(0,r.jsx)(d.Text,{style:_.errorText,children:a}),!!this.state.showDetailedError&&n&&(0,r.jsx)(d.Text,{style:_.errorText,children:g.getString("InAppWebBrowser.ErrorDomain",{errorDomain:n})}),!!this.state.showDetailedError&&s&&(0,r.jsx)(d.Text,{style:_.errorText,children:g.getString("InAppWebBrowser.ErrorCode",{errorCode:s})})]})})},this._onAnimatedFooterRef=e=>{this._animatedFooter=e},this._onError=e=>{const t=e.nativeEvent;if(u.debug((()=>({InAppWebBrowser_onError:t}))),h.default.shouldSuppressError(t.domain,t.code)){if(this.state.isError)return;this.isComponentMounted()&&(this.setState({currentWebControlURL:t.url,currentWebControlTitle:t.title,fullScreen:!1,showAddressBar:!1,canGoBack:t.canGoBack,canGoForward:t.canGoForward,loading:!1,isError:!1,errorDomain:"",errorCode:0,errorDescription:""},this._animateHeaderFooter),h.default.shouldLaunchExternalAppForError(this.state.currentWebControlURL,t.domain,t.code)&&d.Linking.openUrl(this.state.currentWebControlURL))}else this.isComponentMounted()&&this.setState({isError:!0,loading:!1,errorDomain:t.domain,errorCode:parseInt(t.code,10),errorDescription:t.description}),u.warn(o.LogTraceArea.InAppWebBrowser,"_onError called with code: "+t.code+", errorDesc: "+t.description+", domain: "+s.pii.Omit(t.domain)+", currentUrl: "+s.pii.Omit(this.state.currentWebControlURL||"")),this.props.onError&&this.props.onError(e)},this._onWebMessage=e=>{e.data&&this._onMessage(e.data)},this._onMessage=e=>{e&&(u.log(o.LogTraceArea.InAppWebBrowser,"Message received over the bridge "+s.pii.Omit(JSON.stringify(e))),this.props.onMessage&&this.props.onMessage(e))},this._onLoad=e=>{const t=e.nativeEvent;h.default.shouldLaunchExternalApp(t.url)||(u.log(o.LogTraceArea.InAppWebBrowser,"onLoad: navState.url: "+s.pii.Omit(t.url)),this.isComponentMounted()&&(this.setState({loading:!1}),u.debug((()=>"InAppBrowser navigating to "+t.url)),this.props.onLoad&&this.props.onLoad(e)))},this._onNavigationStateChange=e=>{h.default.shouldLaunchExternalApp(e.url)||this.isComponentMounted()&&(this.setState({currentWebControlURL:e.url,currentWebControlTitle:e.title,fullScreen:!1,showAddressBar:!1,canGoBack:e.canGoBack,canGoForward:e.canGoForward},this._animateHeaderFooter),this.props.onNavigationStateChange&&this.props.onNavigationStateChange(e))},this._showDetailedError=e=>{e.stopPropagation(),this.isComponentMounted()&&this.setState((e=>({showDetailedError:!e.showDetailedError})))},this._goBack=e=>{e.stopPropagation(),this._back()},this._goForward=e=>{e.stopPropagation(),this.state.canGoForward&&this._webViewBridge&&this._webViewBridge.goForward()},this._onWebViewBridgeRef=e=>{this._webViewBridge=e}}_buildState(e,t){const i={};return t&&(i.currentWebControlTitle=void 0,i.currentWebControlURL=void 0,i.fullScreen=!1,i.showAddressBar=!1,i.canGoBack=!1,i.canGoForward=!1,i.loading=!1,i.isError=!1,i.dimensions=d.UserInterface.measureWindow()),i}componentDidMount(){super.componentDidMount(),window&&window.addEventListener("message",this._onWebMessage)}componentWillUnmount(){super.componentWillUnmount(),window&&window.removeEventListener("message",this._onWebMessage)}render(){return(0,r.jsxs)(d.View,{style:_.container,children:[this._getHeader(),this.state.isError?this._renderError():this._getWebView(),this._getFooter()]})}reload(){this._webViewBridge&&this._webViewBridge.reload()}postMessage(e){this._webViewBridge&&this._webViewBridge.postMessage(e)}_getHeader(){let e="";return e=this.props.headerTitle&&this._showFixedHeaderTitle()?this.props.headerTitle:this.state.currentWebControlTitle&&!this.state.showAddressBar?this.state.currentWebControlTitle:this.state.currentWebControlURL?this.state.currentWebControlURL:this.props.url||"",this.props.renderHeader?this.props.renderHeader(e,!!this.state.loading):null}_getFooter(){if(!this._showFooter())return null;const e=g.getString("InAppWebBrowser.BackLabel"),t=g.getString("InAppWebBrowser.ForwardLabel"),i=(0,r.jsx)(c.default,{accessibilityLabel:e,title:e,style:_.footerButton,size:v.IconSize.size24,onPress:this._goBack,color:this._themeColors.primaryIconColor,hoverColor:this._themeColors.iconHoverColor,icon:y.navBackIcon(!0),disabled:!this.state.canGoBack}),n=(0,r.jsx)(c.default,{accessibilityLabel:t,title:t,style:_.footerButton,size:v.IconSize.size24,onPress:this._goForward,color:this._themeColors.primaryIconColor,hoverColor:this._themeColors.iconHoverColor,icon:y.navForwardIcon(!0),disabled:!this.state.canGoForward}),s=this.state.isError||a.isEmpty(this.props.optionalFooterButtons)?null:(0,r.jsx)(d.View,{style:_.optionalFooterButtonContainer,children:this.props.optionalFooterButtons});return(0,r.jsxs)(l.View,{ref:this._onAnimatedFooterRef,style:_.footer,children:[i,n,s]})}_showFixedHeaderTitle(){return this.props.headerTitle&&(!this.state.currentWebControlURL||this.props.url&&T.default.getDomainName(this.state.currentWebControlURL)===T.default.getDomainName(this.props.url))}_getWebView(){const e=d.Styles.createWebViewStyle({backgroundColor:this.props.bodyBackgroundColor},!1),t=[_.webView,e],i=d.Types.WebViewSandboxMode.AllowForms|d.Types.WebViewSandboxMode.AllowScripts|d.Types.WebViewSandboxMode.AllowPopups|d.Types.WebViewSandboxMode.AllowSameOrigin|d.Types.WebViewSandboxMode.AllowModals;return(0,r.jsx)(m.WebViewBridge,Object.assign({},this.props,{ref:this._onWebViewBridgeRef,style:t,sandbox:i,onError:this._onError,renderLoading:this.props.renderLoading,onLoad:this._onLoad,onNavigationStateChange:this._onNavigationStateChange,fullScreenBackgroundColor:E,ariaLabel:this.props.headerTitle?this.props.headerTitle:g.getString("WindowControls.AppTitle"),children:this.props.children}))}_close(){this.props.onClose&&this.props.onClose()}_back(){return this.state.isError&&this.isComponentMounted()&&this.setState({isError:!1,errorDomain:"",errorCode:0,errorDescription:""}),this._webViewBridge&&this.state.canGoBack?this._webViewBridge.goBack():this._close(),!0}_animateHeaderFooter(e,t=250){if(!this.isComponentMounted()||this._animatingFooter)return;const i=(a.isUndefined(e)?this.state.fullScreen:e)?48:0;this._animatingFooter=!0,this._animatedFooter&&this._animatedFooter.getAnimation({y:i}).start((()=>this._animatingFooter=!1))}_showFooter(){return!this.state.isError&&(this.state.canGoBack||this.state.canGoForward||!a.isEmpty(this.props.optionalFooterButtons))}}t.InAppWebBrowser=b,t.default=b},596294:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.updateLogLevels=t.setShouldFindPotentialPii=t.setLocalTracingMasks=t.setEnableDebug=t.setEcsOptions=t.piiTrustMeThisIsSafe=t.isTraceEnabled=t.getLogHistory=t.output=t.devWarningEvent=t.devErrorEvent=t.taggedRegex=t.FindSkypeIdRegExp=t.potentialPii=t.ECSMaskLength=t.warn=t.log=t.error=t.debug=t.NotificationsSource=t.LogTraceArea=void 0;const n=i(197582);var r=i(776791);Object.defineProperty(t,"LogTraceArea",{enumerable:!0,get:function(){return r.LogTraceArea}}),Object.defineProperty(t,"NotificationsSource",{enumerable:!0,get:function(){return r.NotificationsSource}});const s=n.__importStar(i(937872));t.debug=s.debug,t.error=s.error,t.log=s.log,t.warn=s.warn;var a=i(937872);Object.defineProperty(t,"ECSMaskLength",{enumerable:!0,get:function(){return a.ECSMaskLength}}),Object.defineProperty(t,"potentialPii",{enumerable:!0,get:function(){return a.potentialPii}}),Object.defineProperty(t,"FindSkypeIdRegExp",{enumerable:!0,get:function(){return a.FindSkypeIdRegExp}}),Object.defineProperty(t,"taggedRegex",{enumerable:!0,get:function(){return a.taggedRegex}});var o=i(937872);Object.defineProperty(t,"devErrorEvent",{enumerable:!0,get:function(){return o.devErrorEvent}}),Object.defineProperty(t,"devWarningEvent",{enumerable:!0,get:function(){return o.devWarningEvent}}),Object.defineProperty(t,"output",{enumerable:!0,get:function(){return o.output}});var l=i(937872);Object.defineProperty(t,"getLogHistory",{enumerable:!0,get:function(){return l.getLogHistory}}),Object.defineProperty(t,"isTraceEnabled",{enumerable:!0,get:function(){return l.isTraceEnabled}}),Object.defineProperty(t,"piiTrustMeThisIsSafe",{enumerable:!0,get:function(){return l.piiTrustMeThisIsSafe}}),Object.defineProperty(t,"setEcsOptions",{enumerable:!0,get:function(){return l.setEcsOptions}}),Object.defineProperty(t,"setEnableDebug",{enumerable:!0,get:function(){return l.setEnableDebug}}),Object.defineProperty(t,"setLocalTracingMasks",{enumerable:!0,get:function(){return l.setLocalTracingMasks}}),Object.defineProperty(t,"setShouldFindPotentialPii",{enumerable:!0,get:function(){return l.setShouldFindPotentialPii}}),Object.defineProperty(t,"updateLogLevels",{enumerable:!0,get:function(){return l.updateLogLevels}})},167606:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});i(197582).__exportStar(i(596294),t)},776791:(e,t)=>{"use strict";var i,n;Object.defineProperty(t,"__esModule",{value:!0}),t.NotificationsSource=t.LogTraceArea=void 0,function(e){e[e.Push=1]="Push",e[e.ChatServiceTransport=2]="ChatServiceTransport",e[e.AppFlow=3]="AppFlow",e[e.ChatService=4]="ChatService",e[e.Notifications=5]="Notifications",e[e.ConsumptionHorizon=6]="ConsumptionHorizon",e[e.ConversationCalculations=7]="ConversationCalculations",e[e.ResponsiveWidthStore=8]="ResponsiveWidthStore",e[e.Startup=9]="Startup",e[e.Navigation=10]="Navigation",e[e.Pes=11]="Pes",e[e.MessageStreamStore=12]="MessageStreamStore",e[e.VirtualMessageViewDebug=13]="VirtualMessageViewDebug",e[e.PostingService=14]="PostingService",e[e.BackgroundTransferService=15]="BackgroundTransferService",e[e.PersistentActionsService=16]="PersistentActionsService",e[e.MessageComposer=17]="MessageComposer",e[e.ChatServiceSubscriptions=18]="ChatServiceSubscriptions",e[e.Highlights=19]="Highlights",e[e.AsyncMediaClient=20]="AsyncMediaClient",e[e.CallsTabPanel=21]="CallsTabPanel",e[e.VirtualMessageView=22]="VirtualMessageView",e[e.ConnectivityStatusBar=23]="ConnectivityStatusBar",e[e.MessageStream=24]="MessageStream",e[e.InAppWebBrowser=25]="InAppWebBrowser",e[e.ConversationsDraftStore=26]="ConversationsDraftStore",e[e.Contacts=27]="Contacts",e[e.LowBandwidth=28]="LowBandwidth",e[e.MessageStreamDebug=29]="MessageStreamDebug",e[e.DownloadService=30]="DownloadService",e[e.UrlPreviewClient=31]="UrlPreviewClient",e[e.LinkNode=32]="LinkNode",e[e.BackgroundTransferServiceDebug=33]="BackgroundTransferServiceDebug",e[e.Responsiveness=34]="Responsiveness",e[e.MediaPrefetchService=35]="MediaPrefetchService",e[e.LocationPicker=36]="LocationPicker",e[e.BRB=37]="BRB",e[e.FindPanel=38]="FindPanel",e[e.CallDebug=39]="CallDebug",e[e.MediaViewerPanel=41]="MediaViewerPanel",e[e.MediaViewerPanelModal=42]="MediaViewerPanelModal",e[e.ConversationMediaStore=43]="ConversationMediaStore",e[e.AlertsStore=44]="AlertsStore",e[e.LocationNode=45]="LocationNode",e[e.CookieUtils=46]="CookieUtils",e[e.MessageStreamStoreDebug=47]="MessageStreamStoreDebug",e[e.EntitlementsClient=48]="EntitlementsClient",e[e.ErrorSafeImage=49]="ErrorSafeImage",e[e.AuthService=50]="AuthService",e[e.MessageActionMenu=51]="MessageActionMenu",e[e.AgentProvisioningService=52]="AgentProvisioningService",e[e.SyncStatus=53]="SyncStatus",e[e.NetworkConnectionStore=54]="NetworkConnectionStore",e[e.OrderService=55]="OrderService",e[e.PopCardStore=56]="PopCardStore",e[e.OrderStatusChangeNotifier=57]="OrderStatusChangeNotifier",e[e.ApsClient=58]="ApsClient",e[e.OrderStore=59]="OrderStore",e[e.QrCode=60]="QrCode",e[e.UsersActiveStore=61]="UsersActiveStore",e[e.VideoWithTelemetry=62]="VideoWithTelemetry",e[e.AudioPlayer=63]="AudioPlayer",e[e.FileUploadCache=64]="FileUploadCache",e[e.FileCacheMetadataService=65]="FileCacheMetadataService",e[e.PublicDownloadsFolderService=66]="PublicDownloadsFolderService",e[e.AgentsStore=67]="AgentsStore",e[e.OfferStore=69]="OfferStore",e[e.PurchaseOptionsStore=70]="PurchaseOptionsStore",e[e.StreamItem=71]="StreamItem",e[e.MessageOptionsHelper=72]="MessageOptionsHelper",e[e.Avatars=73]="Avatars",e[e.ReactionIconButton=74]="ReactionIconButton",e[e.Formatting=75]="Formatting",e[e.Calling=76]="Calling",e[e.WebFlow=77]="WebFlow",e[e.Bookmarks=78]="Bookmarks",e[e.BalanceStatePollingStrategiesService=80]="BalanceStatePollingStrategiesService",e[e.MediaBarItem=81]="MediaBarItem",e[e.MediaBar=82]="MediaBar",e[e.CommandInvoker=83]="CommandInvoker",e[e.TodayTab=84]="TodayTab",e[e.PrefetchedImage=85]="PrefetchedImage",e[e.PrefetchedImagesStore=86]="PrefetchedImagesStore",e[e.UrlUtils=87]="UrlUtils",e[e.BlockAndReport=88]="BlockAndReport",e[e.Keyboard=89]="Keyboard",e[e.ShareToSkype=90]="ShareToSkype",e[e.ReportedConnectivityStore=91]="ReportedConnectivityStore",e[e.ReactionsPopupMenu=92]="ReactionsPopupMenu",e[e.PopCard=93]="PopCard",e[e.TodayArticleReader=94]="TodayArticleReader",e[e.Capture=95]="Capture",e[e.WeatherTab=96]="WeatherTab",e[e.TokenStore=97]="TokenStore",e[e.DeviceStore=98]="DeviceStore",e[e.VideoViewer=99]="VideoViewer",e[e.UsersStore=100]="UsersStore",e[e.Trouter=101]="Trouter",e[e.MissedCallRegistrar=102]="MissedCallRegistrar",e[e.Onboarding=104]="Onboarding",e[e.ReactionsPopupSummary=105]="ReactionsPopupSummary",e[e.ReactionsActionSheet=106]="ReactionsActionSheet",e[e.ReactionsCountButton=107]="ReactionsCountButton",e[e.CallMonitor=108]="CallMonitor",e[e.AnimatedEmoticon=109]="AnimatedEmoticon",e[e.MagicBot=110]="MagicBot",e[e.AudioMessageComposer=111]="AudioMessageComposer",e[e.MediaPickerWrapperView=112]="MediaPickerWrapperView",e[e.JoinLink=113]="JoinLink",e[e.MediaViewer=114]="MediaViewer",e[e.PictureViewer=115]="PictureViewer",e[e.ConversationsListItem=116]="ConversationsListItem",e[e.MediaPickerPanel=117]="MediaPickerPanel",e[e.MessageContent=118]="MessageContent",e[e.Moji=119]="Moji",e[e.Deserializer=120]="Deserializer",e[e.InputEntity=121]="InputEntity",e[e.XmlParser=122]="XmlParser",e[e.SkypeConversationLocal=123]="SkypeConversationLocal",e[e.KeyboardAwareView=124]="KeyboardAwareView",e[e.SlashCommandUtils=125]="SlashCommandUtils",e[e.MessagePanel=126]="MessagePanel",e[e.Presence=129]="Presence",e[e.CurrentUserActiveStore=130]="CurrentUserActiveStore",e[e.OngoingCallService=131]="OngoingCallService",e[e.ActiveEndpointService=132]="ActiveEndpointService",e[e.ElectronStateStore=133]="ElectronStateStore",e[e.ToneRewrite=134]="ToneRewrite",e[e.ConversationColorStore=135]="ConversationColorStore",e[e.KeyboardShortcuts=136]="KeyboardShortcuts",e[e.PnvStore=137]="PnvStore",e[e.IntegrationsStore=138]="IntegrationsStore",e[e.MediaPickerPostUtils=139]="MediaPickerPostUtils",e[e.ScenarioTracker=140]="ScenarioTracker",e[e.PesService=141]="PesService",e[e.CustomReactionsToggleFromModal=142]="CustomReactionsToggleFromModal",e[e.CustomReactionRemovedFromSet=143]="CustomReactionRemovedFromSet",e[e.NoticeMessageService=144]="NoticeMessageService",e[e.Engagement=145]="Engagement",e[e.AVSettings=146]="AVSettings",e[e.CallReactionsDrawer=147]="CallReactionsDrawer",e[e.HeaderAuthWebFlowPanel=148]="HeaderAuthWebFlowPanel",e[e.DeviceUtilities=149]="DeviceUtilities",e[e.IntegrationsSharePingClient=150]="IntegrationsSharePingClient",e[e.UnansweredCall=151]="UnansweredCall",e[e.DesktopCallingSettingsWebPanel=152]="DesktopCallingSettingsWebPanel",e[e.ContactsPanel=153]="ContactsPanel",e[e.Suggestions=154]="Suggestions",e[e.CallReactions=155]="CallReactions",e[e.Permissions=156]="Permissions",e[e.CoachMarks=157]="CoachMarks",e[e.FileSizeHelpers=158]="FileSizeHelpers",e[e.BotMessageService=159]="BotMessageService",e[e.ManageSearchInfo=160]="ManageSearchInfo",e[e.CallNavigation=161]="CallNavigation",e[e.ReadReceipts=162]="ReadReceipts",e[e.RaiseHands=163]="RaiseHands",e[e.SMSClient=164]="SMSClient",e[e.DesktopCallNotification=165]="DesktopCallNotification",e[e.InAppWebBrowserPage=166]="InAppWebBrowserPage",e[e.MoodMessage=167]="MoodMessage",e[e.E2EEncryption=168]="E2EEncryption",e[e.MessageStreamStoreCache=169]="MessageStreamStoreCache",e[e.ContentChannels=170]="ContentChannels",e[e.ImageGeneration=171]="ImageGeneration",e[e.IdleSchedulingService=172]="IdleSchedulingService",e[e.TsCalling=173]="TsCalling",e[e.GroupShareButton=175]="GroupShareButton",e[e.EngagementNavigationService=176]="EngagementNavigationService",e[e.SkypeSmsFlowIdStore=177]="SkypeSmsFlowIdStore",e[e.RegistrarService=179]="RegistrarService",e[e.HardwareBackButton=180]="HardwareBackButton",e[e.DialerStore=181]="DialerStore",e[e.DialerPanel=182]="DialerPanel",e[e.ConnectorsStore=183]="ConnectorsStore",e[e.MsaPhoneAccrual=184]="MsaPhoneAccrual",e[e.SearchStore=185]="SearchStore",e[e.ConnectorChatServiceClient=186]="ConnectorChatServiceClient",e[e.ConnectorsClient=188]="ConnectorsClient",e[e.PrivateConversationsStore=189]="PrivateConversationsStore",e[e.AppCenter=190]="AppCenter",e[e.Video=192]="Video",e[e.ClientTriggeredEngagement=193]="ClientTriggeredEngagement",e[e.AppUpgrade=194]="AppUpgrade",e[e.ConsoleSink=195]="ConsoleSink",e[e.CallingUI=196]="CallingUI",e[e.AudioManagerClient=197]="AudioManagerClient",e[e.ExceptionHandling=198]="ExceptionHandling",e[e.QuickCallPanel=199]="QuickCallPanel",e[e.CallCard=200]="CallCard",e[e.CallQualityFeedback=201]="CallQualityFeedback",e[e.ContentPanel=202]="ContentPanel",e[e.CallActivities=203]="CallActivities",e[e.MobileHub=204]="MobileHub",e[e.ShareWithPanel=205]="ShareWithPanel",e[e.RootAppView=206]="RootAppView",e[e.SISU=207]="SISU",e[e.Error=208]="Error",e[e.CoreUI=209]="CoreUI",e[e.Search=210]="Search",e[e.Profile=211]="Profile",e[e.Swift=212]="Swift",e[e.PreferencesStores=213]="PreferencesStores",e[e.GenericUnsafe=214]="GenericUnsafe",e[e.InFlightConnectionStore=215]="InFlightConnectionStore",e[e.NetworkOperator=216]="NetworkOperator",e[e.Kyc=217]="Kyc",e[e.UserActionsTelemetry=218]="UserActionsTelemetry",e[e.SkypeFeedback=219]="SkypeFeedback",e[e.RootShareWithView=220]="RootShareWithView",e[e.AutoBuddy=221]="AutoBuddy",e[e.Ndi=222]="Ndi",e[e.HeadlessJsTask=223]="HeadlessJsTask",e[e.SlideSearch=224]="SlideSearch",e[e.GifProviderService=225]="GifProviderService",e[e.NewsChannel=226]="NewsChannel",e[e.NewsBot=227]="NewsBot",e[e.MediaThumbnail=228]="MediaThumbnail",e[e.ShareWithContactPanel=229]="ShareWithContactPanel",e[e.Addins=230]="Addins",e[e.SyncAddressBookDialog=231]="SyncAddressBookDialog",e[e.SkypeClips=232]="SkypeClips",e[e.FileNode=233]="FileNode",e[e.IntegrationsAuthStore=234]="IntegrationsAuthStore",e[e.TeamsImageService=235]="TeamsImageService",e[e.BingImageSearchServiceClient=236]="BingImageSearchServiceClient",e[e.FilePicker=237]="FilePicker",e[e.InCallBotService=238]="InCallBotService",e[e.Phone=239]="Phone",e[e.ABCHStore=240]="ABCHStore",e[e.IntegrationsAuthService=241]="IntegrationsAuthService",e[e.ArchiveConversation=242]="ArchiveConversation",e[e.EngagementApiClient=243]="EngagementApiClient",e[e.IntegrationsCombinedView=244]="IntegrationsCombinedView",e[e.TenorClient=245]="TenorClient",e[e.InlineMediaPickerView=246]="InlineMediaPickerView",e[e.AlertsHelpers=247]="AlertsHelpers",e[e.PurchaseConfirmationDialog=248]="PurchaseConfirmationDialog",e[e.Theme=249]="Theme",e[e.MsaAuthFlow=250]="MsaAuthFlow",e[e.NewSmsConversation=251]="NewSmsConversation",e[e.SXAnimated=252]="SXAnimated",e[e.UrlPreviews=253]="UrlPreviews",e[e.ScheduleCall=254]="ScheduleCall",e[e.ConversationStore=255]="ConversationStore",e[e.DNDSetting=256]="DNDSetting",e[e.ImageCachingStore=257]="ImageCachingStore",e[e.OldFriendBack=258]="OldFriendBack",e[e.ContactPresenceSubscriptionHelper=259]="ContactPresenceSubscriptionHelper",e[e.Gallery=260]="Gallery",e[e.ShortCircuitContactsStore=261]="ShortCircuitContactsStore",e[e.AutoDownloadService=262]="AutoDownloadService",e[e.PicturePrefetchService=263]="PicturePrefetchService",e[e.SQLiteClient=264]="SQLiteClient",e[e.CensusService=265]="CensusService",e[e.EngagementSharePanel=266]="EngagementSharePanel",e[e.SubscriptionDataSection=267]="SubscriptionDataSection",e[e.QuickActionsService=268]="QuickActionsService",e[e.ImageResizeUtils=269]="ImageResizeUtils",e[e.LandingPageCards=270]="LandingPageCards",e[e.NativeCodeTelemetry=271]="NativeCodeTelemetry",e[e.NativeAds=272]="NativeAds",e[e.Lifecycle=273]="Lifecycle",e[e.Payments3ds=274]="Payments3ds",e[e.MessageReactionHints=275]="MessageReactionHints",e[e.CommerceFeature=276]="CommerceFeature",e[e.PollStore=277]="PollStore",e[e.ReminderNotificationsService=278]="ReminderNotificationsService",e[e.ConversationGroupingStore=279]="ConversationGroupingStore",e[e.LogProvider=280]="LogProvider",e[e.Lobby=281]="Lobby",e[e.ScreenSharing=282]="ScreenSharing",e[e.PresenceChangeNotification=283]="PresenceChangeNotification",e[e.LocalVideoViewer=284]="LocalVideoViewer",e[e.MessageSearch=285]="MessageSearch",e[e.GoogleContactsImport=286]="GoogleContactsImport",e[e.DirectShareUtils=287]="DirectShareUtils"}(i||(t.LogTraceArea=i={})),function(e){e[e.BotChatSettingsPanel=0]="BotChatSettingsPanel",e[e.MessagePanelNotifications=1]="MessagePanelNotifications",e[e.ConversationListItem=2]="ConversationListItem"}(n||(t.NotificationsSource=n={}))},937872:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FindSkypeIdRegExp=t.ECSMaskLength=t.devErrorEvent=t.devWarningEvent=t.output=t.anonymizeLogs=t.taggedRegex=t.potentialPii=void 0,t.piiTrustMeThisIsSafe=function(e){return f(e)},t.getLogHistory=function(){return T.concat(E)},t.setEnableDebug=function(e){R=e},t.debug=function(e){if(R&&R()){const t=e(),i=s.isArray(t)?t:[t];w(void 0,r.LogLevel.Trace,(e=>e.debug4(null,...i)),i)}},t.log=function(e,...t){0;w(e,r.LogLevel.Debug4,(e=>e.trace(null,...t)),t)},t.warn=function(e,...t){w(e,r.LogLevel.Warning,(e=>e.warn(null,...t)),t)},t.error=function(e,...t){w(e,r.LogLevel.Error,(e=>e.error(null,...t)),t)},t.isTraceEnabled=D,t.updateLogLevels=k,t.setLocalTracingMasks=function(e){y=e,k()},t.setEcsOptions=function(e,t){v=e,p=t,k()},t.setShouldFindPotentialPii=function(e){t.potentialPii.findInLogs=e};const n=i(197582),r=n.__importStar(i(174958)),s=n.__importStar(i(496486)),a=n.__importDefault(i(974634)),o=i(776791),l=r.LogFactory.instance().component("JS"),d=[];for(let e=C(o.LogTraceArea);e>=0;e--)d[e]=r.LogFactory.instance().component("JS."+o.LogTraceArea[e]),r.LogFactory.instance().declareComponentExtendedInfo("JS."+o.LogTraceArea[e],e);const c=[o.LogTraceArea.AppFlow,o.LogTraceArea.ErrorSafeImage,o.LogTraceArea.ReportedConnectivityStore,o.LogTraceArea.SlashCommandUtils,o.LogTraceArea.TokenStore,o.LogTraceArea.UrlUtils,o.LogTraceArea.XmlParser],h=[o.LogTraceArea.ABCHStore,o.LogTraceArea.ActiveEndpointService,o.LogTraceArea.Addins,o.LogTraceArea.AgentProvisioningService,o.LogTraceArea.AgentsStore,o.LogTraceArea.AlertsHelpers,o.LogTraceArea.AlertsStore,o.LogTraceArea.AnimatedEmoticon,o.LogTraceArea.ApsClient,o.LogTraceArea.ArchiveConversation,o.LogTraceArea.AsyncMediaClient,o.LogTraceArea.AudioManagerClient,o.LogTraceArea.AudioMessageComposer,o.LogTraceArea.AudioPlayer,o.LogTraceArea.AutoBuddy,o.LogTraceArea.AuthService,o.LogTraceArea.Avatars,o.LogTraceArea.AVSettings,o.LogTraceArea.BackgroundTransferService,o.LogTraceArea.BackgroundTransferServiceDebug,o.LogTraceArea.BalanceStatePollingStrategiesService,o.LogTraceArea.BingImageSearchServiceClient,o.LogTraceArea.BlockAndReport,o.LogTraceArea.BotMessageService,o.LogTraceArea.BRB,o.LogTraceArea.CallActivities,o.LogTraceArea.CallCard,o.LogTraceArea.Calling,o.LogTraceArea.CallingUI,o.LogTraceArea.CallMonitor,o.LogTraceArea.CallNavigation,o.LogTraceArea.CallQualityFeedback,o.LogTraceArea.CallReactions,o.LogTraceArea.CallReactionsDrawer,o.LogTraceArea.Capture,o.LogTraceArea.ChatService,o.LogTraceArea.ChatServiceSubscriptions,o.LogTraceArea.ChatServiceTransport,o.LogTraceArea.ClientTriggeredEngagement,o.LogTraceArea.CoachMarks,o.LogTraceArea.CommandInvoker,o.LogTraceArea.ConnectivityStatusBar,o.LogTraceArea.ConnectorChatServiceClient,o.LogTraceArea.ConnectorsClient,o.LogTraceArea.ConnectorsStore,o.LogTraceArea.ConsoleSink,o.LogTraceArea.ConsumptionHorizon,o.LogTraceArea.ContactPresenceSubscriptionHelper,o.LogTraceArea.Contacts,o.LogTraceArea.ContactsPanel,o.LogTraceArea.ContentPanel,o.LogTraceArea.ConversationCalculations,o.LogTraceArea.ConversationColorStore,o.LogTraceArea.ConversationMediaStore,o.LogTraceArea.ConversationsListItem,o.LogTraceArea.ConversationStore,o.LogTraceArea.CookieUtils,o.LogTraceArea.CoreUI,o.LogTraceArea.CurrentUserActiveStore,o.LogTraceArea.Deserializer,o.LogTraceArea.DesktopCallingSettingsWebPanel,o.LogTraceArea.DesktopCallNotification,o.LogTraceArea.DeviceStore,o.LogTraceArea.DeviceUtilities,o.LogTraceArea.DialerPanel,o.LogTraceArea.DialerStore,o.LogTraceArea.DNDSetting,o.LogTraceArea.DownloadService,o.LogTraceArea.E2EEncryption,o.LogTraceArea.ElectronStateStore,o.LogTraceArea.Engagement,o.LogTraceArea.EngagementNavigationService,o.LogTraceArea.EngagementSharePanel,o.LogTraceArea.EntitlementsClient,o.LogTraceArea.ExceptionHandling,o.LogTraceArea.FileCacheMetadataService,o.LogTraceArea.FileNode,o.LogTraceArea.FilePicker,o.LogTraceArea.FileSizeHelpers,o.LogTraceArea.FileUploadCache,o.LogTraceArea.FindPanel,o.LogTraceArea.GroupShareButton,o.LogTraceArea.HardwareBackButton,o.LogTraceArea.HeaderAuthWebFlowPanel,o.LogTraceArea.HeadlessJsTask,o.LogTraceArea.AppCenter,o.LogTraceArea.IdleSchedulingService,o.LogTraceArea.ImageCachingStore,o.LogTraceArea.ImageResizeUtils,o.LogTraceArea.InAppWebBrowser,o.LogTraceArea.InAppWebBrowserPage,o.LogTraceArea.InCallBotService,o.LogTraceArea.InFlightConnectionStore,o.LogTraceArea.InlineMediaPickerView,o.LogTraceArea.InputEntity,o.LogTraceArea.IntegrationsAuthService,o.LogTraceArea.IntegrationsAuthStore,o.LogTraceArea.IntegrationsCombinedView,o.LogTraceArea.IntegrationsSharePingClient,o.LogTraceArea.IntegrationsStore,o.LogTraceArea.JoinLink,o.LogTraceArea.Keyboard,o.LogTraceArea.KeyboardAwareView,o.LogTraceArea.KeyboardShortcuts,o.LogTraceArea.Lifecycle,o.LogTraceArea.LinkNode,o.LogTraceArea.LocationNode,o.LogTraceArea.LocationPicker,o.LogTraceArea.LogProvider,o.LogTraceArea.LowBandwidth,o.LogTraceArea.ManageSearchInfo,o.LogTraceArea.MediaBar,o.LogTraceArea.MediaBarItem,o.LogTraceArea.MediaPickerPanel,o.LogTraceArea.MediaPickerPostUtils,o.LogTraceArea.MediaPickerWrapperView,o.LogTraceArea.MediaPrefetchService,o.LogTraceArea.MediaThumbnail,o.LogTraceArea.MediaViewer,o.LogTraceArea.MediaViewerPanel,o.LogTraceArea.MediaViewerPanelModal,o.LogTraceArea.MessageActionMenu,o.LogTraceArea.MessageComposer,o.LogTraceArea.MessageContent,o.LogTraceArea.MessageOptionsHelper,o.LogTraceArea.MessageStream,o.LogTraceArea.MessageStreamDebug,o.LogTraceArea.MessageStreamStore,o.LogTraceArea.MessageStreamStoreCache,o.LogTraceArea.MessageStreamStoreDebug,o.LogTraceArea.MissedCallRegistrar,o.LogTraceArea.MobileHub,o.LogTraceArea.MoodMessage,o.LogTraceArea.MsaAuthFlow,o.LogTraceArea.MsaPhoneAccrual,o.LogTraceArea.Presence,o.LogTraceArea.Navigation,o.LogTraceArea.Ndi,o.LogTraceArea.NetworkConnectionStore,o.LogTraceArea.NetworkOperator,o.LogTraceArea.NewSmsConversation,o.LogTraceArea.NoticeMessageService,o.LogTraceArea.Notifications,o.LogTraceArea.OfferStore,o.LogTraceArea.Onboarding,o.LogTraceArea.OngoingCallService,o.LogTraceArea.OrderService,o.LogTraceArea.OrderStatusChangeNotifier,o.LogTraceArea.OrderStore,o.LogTraceArea.ConversationsDraftStore,o.LogTraceArea.Permissions,o.LogTraceArea.PersistentActionsService,o.LogTraceArea.Pes,o.LogTraceArea.PesService,o.LogTraceArea.Phone,o.LogTraceArea.PictureViewer,o.LogTraceArea.PnvStore,o.LogTraceArea.PopCard,o.LogTraceArea.PopCardStore,o.LogTraceArea.PostingService,o.LogTraceArea.PreferencesStores,o.LogTraceArea.PrefetchedImage,o.LogTraceArea.PrefetchedImagesStore,o.LogTraceArea.PrivateConversationsStore,o.LogTraceArea.Profile,o.LogTraceArea.PublicDownloadsFolderService,o.LogTraceArea.PurchaseConfirmationDialog,o.LogTraceArea.PurchaseOptionsStore,o.LogTraceArea.Push,o.LogTraceArea.QuickCallPanel,o.LogTraceArea.ReactionIconButton,o.LogTraceArea.ReactionsActionSheet,o.LogTraceArea.ReactionsCountButton,o.LogTraceArea.ReactionsPopupMenu,o.LogTraceArea.ReactionsPopupSummary,o.LogTraceArea.CustomReactionsToggleFromModal,o.LogTraceArea.CustomReactionRemovedFromSet,o.LogTraceArea.ReadReceipts,o.LogTraceArea.RegistrarService,o.LogTraceArea.ResponsiveWidthStore,o.LogTraceArea.RootAppView,o.LogTraceArea.RootShareWithView,o.LogTraceArea.ScheduleCall,o.LogTraceArea.Search,o.LogTraceArea.SearchStore,o.LogTraceArea.ShareToSkype,o.LogTraceArea.ShareWithContactPanel,o.LogTraceArea.ShareWithPanel,o.LogTraceArea.ShortCircuitContactsStore,o.LogTraceArea.SISU,o.LogTraceArea.SkypeConversationLocal,o.LogTraceArea.SkypeFeedback,o.LogTraceArea.SkypeSmsFlowIdStore,o.LogTraceArea.SMSClient,o.LogTraceArea.SQLiteClient,o.LogTraceArea.Startup,o.LogTraceArea.StreamItem,o.LogTraceArea.Suggestions,o.LogTraceArea.Swift,o.LogTraceArea.SXAnimated,o.LogTraceArea.SyncAddressBookDialog,o.LogTraceArea.SyncStatus,o.LogTraceArea.TeamsImageService,o.LogTraceArea.Theme,o.LogTraceArea.Trouter,o.LogTraceArea.TsCalling,o.LogTraceArea.UnansweredCall,o.LogTraceArea.UrlPreviews,o.LogTraceArea.UrlPreviewClient,o.LogTraceArea.UserActionsTelemetry,o.LogTraceArea.UsersActiveStore,o.LogTraceArea.UsersStore,o.LogTraceArea.Video,o.LogTraceArea.VideoViewer,o.LogTraceArea.VideoWithTelemetry,o.LogTraceArea.VirtualMessageView,o.LogTraceArea.VirtualMessageViewDebug,o.LogTraceArea.WebFlow],u=[o.LogTraceArea.CallDebug,o.LogTraceArea.GenericUnsafe,o.LogTraceArea.ScenarioTracker];let p=[];s.each(h,(e=>r.LogFactory.instance().declareComponentSafe("JS."+o.LogTraceArea[e],!0))),t.potentialPii={findInLogs:!1,debug_searchOnlySafeAreas:!0,debug_alwaysAssert:!1,found:{}};const g=/eyJ[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*/g;t.taggedRegex=/\[(pii|safe)<[^<>]*>]/g;const m=e=>"[pii<"+(e=>-1===e.indexOf("eyJ")?e:e.replace(g,"[hidden_token]"))(e+"").replace(/[<>]/g,encodeURIComponent)+">]",f=e=>m(e).replace("pii","safe");t.anonymizeLogs=!0,r.enableAnonymization(t.anonymizeLogs),r.useTagger(m),t.output=new a.default,t.devWarningEvent=new a.default,t.devErrorEvent=new a.default;const S=32;let v=[0,0,0,0,0,0,0,0,0],y=[0,0,0,0,0,0,0,0,0];function C(e){return s.max(s.filter(s.values(e),s.isNumber))}t.ECSMaskLength=v.length;let T=[],E=[];const _=/^(\d\d:\d\d:\d\d$|\d\d:\d\d\.\d\d\dZ|1:1$|\d+(:|\d{1,4})+$)/i,b=/\b(\d{1,2}):([-\w\.\+\:\@\,]+)/g;function P(e){if(s.isError(e))return[];if(s.isString(e)){const i=[],n=e.replace(t.taggedRegex,"");let r;for(;r=b.exec(n);){const[e,t]=r,n=Number(t);s.isNaN(n)||_.test(e)||i.push(e)}for(b.lastIndex=0;r=t.FindSkypeIdRegExp.exec(n);)i.push(r[0]);return t.FindSkypeIdRegExp.lastIndex=0,i}return s.isObjectLike(e)?s.flatMap(e,P):[]}t.FindSkypeIdRegExp=/\blive:([-\w\.\+\:\@\,]+)/g;const I=/[\da-f]*\d[\da-f]*/gi,A=/\D/g;let R;function w(e,i,n,r){n(e?d[e]:l),t.potentialPii.findInLogs&&function(e,i){if(!e||s.includes(u,e)||s.includes(p,e))return;const n=s.includes(h,e)||s.includes(c,e);if(t.potentialPii.debug_searchOnlySafeAreas&&!n)return;if(s.flatMap(i,P).length){t.potentialPii.found[e]||(t.potentialPii.found[e]={});const r=s.map(i,(e=>s.isString(e)?e.replace(b,"^mri^").replace(I,(e=>A.test(e)?"^hex^":"^num^")):""+e)).join("|^|"),a=s.truncate(r,{length:100});t.potentialPii.found[e][a]=!0,t.potentialPii.debug_alwaysAssert||n||s.includes(c,e)}}(e,r)}class M extends r.AbstractLogAppender{constructor(){super(new r.StandardLogFormatter(r.SLF_Flags.LogId|r.SLF_Flags.Level|r.SLF_Flags.Component))}log(e,i,n,r){let s=e.component.extendedInfo();"number"!=typeof s&&(s=o.LogTraceArea.GenericUnsafe),function(e,i,n){T.length>=50?(E.push({level:e,traceArea:i,args:n}),E.length>=50&&(T=E,E=[])):T.push({level:e,traceArea:i,args:n}),t.output.fire(e,i,n)}(e.level,s,r)}}const O=new M;function D(e){const t=Math.floor(e/S),i=e%S;return 1==((v[t]|y[t])>>>i&1)}function k(){if(s.every(v,((e,t)=>-1==(v[t]|y[t]))))r.RootToolsManager.setLocalLogLevelConfig({JS:r.LogLevel.Trace});else{const e={};for(let t=C(o.LogTraceArea);t>=0;t--)D(t)?e[d[t].name()]=r.LogLevel.Trace:e[d[t].name()]=r.LogLevel.Fatal;e.RootToolsManager=r.LogLevel.Fatal,r.RootToolsManager.setLocalLogLevelConfig(e)}s.each(p,(e=>{r.LogFactory.instance().declareComponentSafe("JS."+o.LogTraceArea[e],!1)}))}r.LogFactory.instance().addAppender(O)},728:(e,t)=>{"use strict";var i,n;Object.defineProperty(t,"__esModule",{value:!0}),t.KeyboardAwareResizeMode=t.VirtualKeyboardEvent=void 0,function(e){e[e.keyboardWillShow=0]="keyboardWillShow",e[e.keyboardDidShow=1]="keyboardDidShow",e[e.keyboardDidHide=2]="keyboardDidHide",e[e.keyboardWillChangeFrame=3]="keyboardWillChangeFrame"}(i||(t.VirtualKeyboardEvent=i={})),function(e){e[e.Default=0]="Default",e[e.None=1]="None"}(n||(t.KeyboardAwareResizeMode=n={}))},149374:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(933844),t);var r=i(933844);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},933844:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VirtualKeyboardEvent=t.KeyboardAwareResizeMode=void 0;var n=i(728);Object.defineProperty(t,"KeyboardAwareResizeMode",{enumerable:!0,get:function(){return n.KeyboardAwareResizeMode}}),Object.defineProperty(t,"VirtualKeyboardEvent",{enumerable:!0,get:function(){return n.VirtualKeyboardEvent}});t.default=new class{onKeyboardEvent(e,t){}onKeyboardLayoutAnimation(e){}getScreenDimensions(){}}},282007:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(512067);t.default=new n.KycVerify},512067:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.KycVerify=void 0;const n=i(197582).__importStar(i(397691));t.KycVerify=class{isImplemented(){return!1}getClaimsFromIssueRequest(e){return n.Rejected({code:"not_implemented",message:"Not implemented"})}presentVerifiedId(e,t){return n.Rejected({code:"not_implemented",message:"Not implemented"})}}},164858:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LensVideoViewBase=t.ReencodeErrorType=t.ReencodeProfileType=t.ReencodeProgressType=void 0;const n=i(197582),r=i(217041),s=n.__importStar(i(397691));var a,o,l;!function(e){e.Fetch="Fetch",e.Reencode="Reencode"}(a||(t.ReencodeProgressType=a={})),function(e){e[e.SD=0]="SD",e[e.HD=1]="HD",e[e.Custom=2]="Custom"}(o||(t.ReencodeProfileType=o={})),function(e){e.ReencodeError="ReencodeError",e.Cancelled="Cancelled",e.AlreadyInProgress="AlreadyInProgress",e.FetchError="FetchError",e.CompressionRatioError="CompressionRatio",e.TooLargeFile="TooLargeFile",e.InvalidRequest="InvalidRequest"}(l||(t.ReencodeErrorType=l={}));class d extends r.ComponentBase{static reencodeVideo(e,t,i,n){return s.Rejected("Not Implemented")}static cancelReencode(){}}t.LensVideoViewBase=d},678152:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LensVideoView=t.ReencodeErrorType=t.ReencodeProfileType=t.ReencodeProgressType=t.reencodeProgressChangedEvent=void 0;const n=i(197582),r=i(785893),s=n.__importStar(i(516778)),a=n.__importDefault(i(974634)),o=n.__importStar(i(397691)),l=i(164858);Object.defineProperty(t,"ReencodeErrorType",{enumerable:!0,get:function(){return l.ReencodeErrorType}}),Object.defineProperty(t,"ReencodeProfileType",{enumerable:!0,get:function(){return l.ReencodeProfileType}}),Object.defineProperty(t,"ReencodeProgressType",{enumerable:!0,get:function(){return l.ReencodeProgressType}}),t.reencodeProgressChangedEvent=new a.default;class d extends l.LensVideoViewBase{captureWithOverlay(e,t,i){return o.Rejected("Capture not supported on web")}render(){return(0,r.jsx)(s.View,{})}}t.LensVideoView=d,t.default=d},426433:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(678152),t);var r=i(678152);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},353042:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});i(197582).__exportStar(i(238199),t)},28685:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LocationBase=void 0;const n=i(197582).__importDefault(i(284632));t.LocationBase=class{getCurrentPosition(e){return new Promise(((t,i)=>n.default.getCurrentPosition(t,i,e)))}setRNConfiguration(e){n.default.setRNConfiguration(e)}}},656574:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(28685);class r extends n.LocationBase{setConfiguration(e){}}t.default=new r},126740:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(656574),t);var r=i(656574);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},212042:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(384181),t);var r=i(384181);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},384181:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=n.__importStar(i(174958)),s=n.__importStar(i(397691));class a{supportsLogs(){return!0}mostRecentLogFileUris(e){return s.Resolved([a._logFileName])}allRecentLogFileUris(e){return s.Resolved([a._logFileName])}zippedLogFileBundle(e,t,i,n){return t?r.RootToolsManager.dumpLogBuffer({filter:[{component:"root",level:0}]},{maxSize:0}).then((e=>{const t=new Blob([e],{type:"text/plain"});return t.lastModifiedDate=new Date,t.name=a._logFileName,s.Resolved(t)})):s.Resolved(void 0)}setAppConfigProvider(e){}storeZippedClientLogFilesToDevice(e){return s.Rejected("Downloading logs not supported on this device")}}a._logFileName="web_log",t.default=new a},596491:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(835413),t);var r=i(835413);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},835413:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=n.__importStar(i(496486)),s=n.__importDefault(i(974634)),a="LogoutIndicator";t.default=new class{constructor(){this.onLogoutSignal=new s.default,this._listening=!1,this._handleStorageEvent=e=>{const{key:t,oldValue:i,newValue:n}=e;t===a&&n&&(r.isNil(i)||i<n)&&this.onLogoutSignal.fire(i||void 0,n)}}startListeningForLogout(){this._listening||(this._listening=!0,"undefined"!=typeof window&&window.addEventListener("storage",this._handleStorageEvent))}stopListeningForLogout(){this._listening=!1,window.removeEventListener("storage",this._handleStorageEvent)}forceOtherLogout(){const e=a,t=window.localStorage.getItem(e);window.localStorage.setItem(e,""+(1+(t?Number(t):0)))}}},391003:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MediaPickerUtilsBase=void 0;const n=i(197582).__importDefault(i(974634));t.MediaPickerUtilsBase=class{constructor(){this.recentAssetThumbnailChangedEvent=new n.default}}},883596:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(492688),t);var r=i(492688);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},492688:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582).__importStar(i(397691)),r=i(391003);class s extends r.MediaPickerUtilsBase{open(){return n.Resolved(1)}close(e){}getPhotos(e,t){return n.Rejected("MediaPickerUtils not implemented for web")}getAlbums(e,t){return n.Rejected("MediaPickerUtils not implemented for web")}prepareMediaSelection(e,t,i){return n.Rejected("MediaPickerUtils not implemented for web")}getRecentAssetThumbnail(){return n.Rejected("MediaPickerUtils.getRecentAssetThumbnail not implemented")}setRecentAssetThumbnailChangedEventEnabled(e){}}t.default=new s},27954:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(682272),t);var r=i(682272);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},682272:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MediaPickerModule=t.WebMediaPickerView=t.MediaPickerConsts=void 0;const n=i(197582),r=i(785893),s=n.__importStar(i(516778)),a=n.__importStar(i(397691));t.MediaPickerConsts={IndexReplacementKey:"__INDEX__",TotalReplacementKey:"__TOTAL__",TypeReplacementKey:"__TYPE__",RecentAssetThumbnailChangedEvent:"__RECENT_THUMBNAIL_EVENT__"};class o extends s.Component{render(){return(0,r.jsx)(s.View,Object.assign({},this.props,{children:this.props.children}))}scrollToTop(){}}t.WebMediaPickerView=o;t.MediaPickerModule=class{static open(){return a.Rejected("Not implemented")}static close(e){}static getPhotos(e,t){return a.Rejected("Not implemented")}static getAlbumInfo(e,t){return a.Rejected("Not implemented")}static getRecentAssetThumbnail(){return a.Rejected("Not implemented")}static setRecentAssetThumbnailChangedEventEnabled(e){}static iOSfileNameForAsset(e,t){return a.Rejected("Not implemented")}static androidSelectPhoto(e,t){return a.Rejected("Not implemented")}},t.default=o},359971:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});i(197582).__exportStar(i(908946),t)},908946:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.requestSearchInputFocus=function(e){o();let t=e();if(t&&(t.requestFocus(),s.UserInterface.isNavigatingWithKeyboard())){const i=r.findDOMNode(t);i&&(i.setAttribute("aria-hidden","true"),a=window.setTimeout((()=>{a=void 0,t=e(),t&&(i.setAttribute("aria-hidden","false"),t.requestFocus())}),500))}},t.cancelRequestSearchInputFocus=o;const n=i(197582),r=n.__importStar(i(973935)),s=n.__importStar(i(516778));let a;function o(){a&&(window.clearTimeout(a),a=void 0)}},545540:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=new class{onTelemetryEvent(e){}}},898743:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(545540),t);var r=i(545540);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},463612:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},890548:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(217041),s=n.__importStar(i(397691));n.__exportStar(i(463612),t);class a extends r.StoreBase{cleanUpAsync(){return s.Resolved()}isSupported(){return!1}isCaptured(){return!1}updateLocalizedStrings(e){}updateSettings(e){}}t.default=new class{createAsync(e,t,i){return s.Resolved(new a)}}},8399:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(890548),t);var r=i(890548);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},69825:(e,t)=>{"use strict";var i,n;Object.defineProperty(t,"__esModule",{value:!0}),t.FallbackCameraType=t.OfficeLensStatusCode=void 0,function(e){e[e.Success=200]="Success",e[e.AccessDenied=403]="AccessDenied",e[e.CameraNotSupported=415]="CameraNotSupported",e[e.OfficeLensNotInitialised=416]="OfficeLensNotInitialised",e[e.DocumentMenuNotInitialised=417]="DocumentMenuNotInitialised",e[e.FailedToWrite=418]="FailedToWrite",e[e.ImagePickerFailedFetch=419]="ImagePickerFailedFetch",e[e.ImagePickerCancelled=420]="ImagePickerCancelled",e[e.OfficeLensCancelled=421]="OfficeLensCancelled",e[e.DocumentProviderCancelled=422]="DocumentProviderCancelled",e[e.EmptyResponse=450]="EmptyResponse",e[e.NoImages=451]="NoImages",e[e.NoVideo=452]="NoVideo",e[e.Unknown=500]="Unknown"}(i||(t.OfficeLensStatusCode=i={})),function(e){e.Image="image",e.Video="video"}(n||(t.FallbackCameraType=n={}))},587203:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OfficeLensStatusCode=t.FallbackCameraType=t.OfficeLensStub=t.limitedAccesEvent=t.telemetryEventSaveAndroid=t.telemetryEventLaunchAndroid=t.telemetryEventSaveiOS=t.telemetryEventLaunchiOS=void 0;const n=i(197582),r=n.__importDefault(i(974634)),s=n.__importStar(i(397691)),a=i(69825);Object.defineProperty(t,"OfficeLensStatusCode",{enumerable:!0,get:function(){return a.OfficeLensStatusCode}}),Object.defineProperty(t,"FallbackCameraType",{enumerable:!0,get:function(){return a.FallbackCameraType}}),t.telemetryEventLaunchiOS=new r.default,t.telemetryEventSaveiOS=new r.default,t.telemetryEventLaunchAndroid=new r.default,t.telemetryEventSaveAndroid=new r.default,t.limitedAccesEvent=new r.default;class o{isImplemented(){return!1}init(){}startInGalleryMode(e,t,i,n){return s.Resolved({identifiers:[],statusCode:-1})}startInCameraMode(e,t,i,n){return s.Resolved({identifiers:[],statusCode:-1})}startInAvatarPickerMode(e,t,i,n){return s.Resolved({identifiers:[],statusCode:-1})}startInFallbackCameraMode(e){return s.Resolved({identifiers:[],statusCode:-1})}startInFallbackGalleryMode(){return s.Resolved({identifiers:[],statusCode:-1})}startInBarScannerMode(e,t,i,n){return s.Resolved({identifiers:[],statusCode:-1})}enableTelemetryEvents(){}disableTelemetryEvents(){}isTelemetryEnabled(){return!1}}t.OfficeLensStub=o,t.default=new o},454398:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(587203),t);var r=i(587203);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},885233:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582).__importStar(i(397691));t.default=new class{isImplemented(){return!1}migrateAccountToOneAuth(e,t){return n.Rejected()}signOutCurrentAccount(e){return n.Rejected()}getAvailableAccounts(){return n.Rejected()}subscribeToDiscoveryFinished(e,t){}unsubscribeFromDiscoveryFinished(e){}signInOrSignUp(e,t,i,r){return n.Rejected()}acquireCredentialsSilently(e,t,i){return n.Rejected()}acquireCredentialsSilentlyWithUIFallback(e,t,i,r){return n.Rejected()}acquireCredentialsInteractively(e,t,i){return n.Rejected()}updateMsaConfigInformation(e,t){}storeSessionIdToOneAuth(e){}setAccountId(e){}associateAccount(e){}}},297550:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(885233),t);var r=i(885233);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},68031:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OneCameraStatusCode=void 0;const n=i(210916);var r=i(523531);Object.defineProperty(t,"OneCameraStatusCode",{enumerable:!0,get:function(){return r.OneCameraStatusCode}}),t.default=new n.OneCamera},210916:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OneCamera=void 0;const n=i(523531);t.OneCamera=class{isImplemented(){return!1}launchInCameraMode(e){return Promise.resolve({identifiers:[],statusCode:n.OneCameraStatusCode.UNKNOWN})}launchInAvatarMode(e){return Promise.resolve({identifiers:[],statusCode:n.OneCameraStatusCode.UNKNOWN})}launchInPickerMode(e){return Promise.resolve({identifiers:[],statusCode:n.OneCameraStatusCode.UNKNOWN})}launchInQrCodeScanningMode(e){return Promise.resolve({barcode:"",statusCode:n.OneCameraStatusCode.UNKNOWN})}}},523531:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.OneCameraStatusCode=void 0,function(e){e[e.SUCCESS=200]="SUCCESS",e[e.UNKNOWN=500]="UNKNOWN",e[e.USER_CANCEL=501]="USER_CANCEL"}(i||(t.OneCameraStatusCode=i={}))},140033:(e,t)=>{"use strict";var i,n,r;Object.defineProperty(t,"__esModule",{value:!0}),t.SkipAugmentedWebPanelConfig=t.PermissionOrigin=t.PermissionStatus=void 0,function(e){e[e.Unknown=0]="Unknown",e[e.Granted=1]="Granted",e[e.Denied=2]="Denied",e[e.MicGrantedAndCameraDenied=3]="MicGrantedAndCameraDenied",e[e.MicDeniedAndCameraGranted=4]="MicDeniedAndCameraGranted",e[e.Prompt=5]="Prompt",e[e.Unavailable=6]="Unavailable",e[e.Limited=7]="Limited"}(i||(t.PermissionStatus=i={})),function(e){e[e.Call=0]="Call",e[e.CapturePanel=1]="CapturePanel",e[e.AVSettings=2]="AVSettings",e[e.OnboardingAVSettings=3]="OnboardingAVSettings",e[e.OnboardingPromptDialog=4]="OnboardingPromptDialog",e[e.NotificationPrompt=5]="NotificationPrompt",e[e.NotificationPromptExternal=6]="NotificationPromptExternal",e[e.VideoMessageItem=7]="VideoMessageItem",e[e.CallPreview=8]="CallPreview",e[e.MeetNowCallPreview=9]="MeetNowCallPreview"}(n||(t.PermissionOrigin=n={})),function(e){e[e.All=0]="All",e[e.InitialOnly=1]="InitialOnly"}(r||(t.SkipAugmentedWebPanelConfig=r={}))},444948:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(279211),r=i(140033);t.default=class{static notificationsPermissionStatus(){return n.LocalNotifications.getNotificationPermissionStatus().then((e=>this.convertNotificationPermissionStatus(e)))}static convertNotificationPermissionStatus(e){switch(e){case n.NotificationPermissionState.Granted:return r.PermissionStatus.Granted;case n.NotificationPermissionState.Denied:return r.PermissionStatus.Denied}return r.PermissionStatus.Unknown}}},269276:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PermissionsPromptHelper=void 0;const n=i(197582).__importDefault(i(974634));class r{constructor(){this._microphonePermissionPrompt=!1,this._cameraPermissionPrompt=!1,this._micAndCamPermissionPrompt=!1,this.augmentedCameraPermissionPromptEvent=new n.default,this.augmentedMicrophonePermissionPromptEvent=new n.default,this.augmentedMicrophoneAndCameraPermissionPromptEvent=new n.default}showSkypeMicrophonePermissionPrompt(){this._microphonePermissionPrompt||(this._microphonePermissionPrompt=!0,this.augmentedMicrophonePermissionPromptEvent.fire(this._microphonePermissionPrompt))}dismissSkypeMicrophonePermissionPrompt(){this._microphonePermissionPrompt&&(this._microphonePermissionPrompt=!1,this.augmentedMicrophonePermissionPromptEvent.fire(this._microphonePermissionPrompt))}showSkypeCameraPermissionPrompt(){this._cameraPermissionPrompt||(this._cameraPermissionPrompt=!0,this.augmentedCameraPermissionPromptEvent.fire(this._cameraPermissionPrompt))}dismissSkypeCameraPermissionPrompt(){this._cameraPermissionPrompt&&(this._cameraPermissionPrompt=!1,this.augmentedCameraPermissionPromptEvent.fire(this._cameraPermissionPrompt))}showSkypeMicrophoneAndCameraPermissionPrompt(){this._micAndCamPermissionPrompt||(this._micAndCamPermissionPrompt=!0,this.augmentedMicrophoneAndCameraPermissionPromptEvent.fire(this._micAndCamPermissionPrompt))}dismissSkypeMicrophoneAndCameraPermissionPrompt(){this._micAndCamPermissionPrompt&&(this._micAndCamPermissionPrompt=!1,this.augmentedMicrophoneAndCameraPermissionPromptEvent.fire(this._micAndCamPermissionPrompt))}resetPermissionPromptsState(){this._micAndCamPermissionPrompt=!1,this._cameraPermissionPrompt=!1,this._microphonePermissionPrompt=!1}}t.PermissionsPromptHelper=r,t.default=new r},380157:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(269040),t);var r=i(269040);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},269040:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PermissionsPromptHelper=t.SkipAugmentedWebPanelConfig=t.PermissionStatus=t.PermissionOrigin=t.WebPermissionsHelper=void 0;const n=i(197582),r=n.__importDefault(i(264596)),s=i(815063),a=i(148540),o=n.__importStar(i(397691)),l=(i(673620),i(140033)),d=n.__importDefault(i(444948)),c=n.__importDefault(i(269276));t.PermissionsPromptHelper=c.default;class h{cameraPermissionStatus(){const e=this._getDeviceManager();if(this.supportsGetPermissionState()&&e){const t=e.getPermissionState(a.PermissionType.Camera);return o.Resolved(this._getPermissionStatusFromState(t))}return o.Resolved(l.PermissionStatus.Unknown)}cameraRollPermissionStatus(){return o.Resolved(l.PermissionStatus.Granted)}writeCameraRollPermissionStatus(){return o.Resolved(l.PermissionStatus.Granted)}microphonePermissionStatus(){const e=this._getDeviceManager();if(this.supportsGetPermissionState()&&e){const t=e.getPermissionState(a.PermissionType.Microphone);return o.Resolved(this._getPermissionStatusFromState(t))}return o.Resolved(l.PermissionStatus.Unknown)}microphoneAndCameraPermissionStatus(){const e=this._getDeviceManager();if(this.supportsGetPermissionState()&&e){const t=e.getPermissionState(a.PermissionType.Camera),i=e.getPermissionState(a.PermissionType.Microphone);let n=l.PermissionStatus.Unknown;return t===a.PermissionState.Prompt||i===a.PermissionState.Prompt?n=l.PermissionStatus.Prompt:t===a.PermissionState.Granted&&i===a.PermissionState.Granted?n=l.PermissionStatus.Granted:t===a.PermissionState.Denied&&i===a.PermissionState.Denied?n=l.PermissionStatus.Denied:t===a.PermissionState.Denied&&i===a.PermissionState.Granted?n=l.PermissionStatus.MicGrantedAndCameraDenied:t===a.PermissionState.Granted&&i===a.PermissionState.Denied&&(n=l.PermissionStatus.MicDeniedAndCameraGranted),o.Resolved(n)}return o.Resolved(l.PermissionStatus.Unknown)}contactsPermissionStatus(){return o.Resolved(l.PermissionStatus.Granted)}notificationsPermissionStatus(){return d.default.notificationsPermissionStatus()}locationPermissionStatus(){return o.Resolved(l.PermissionStatus.Granted)}locationAlwaysPermissionStatus(){return o.Resolved(l.PermissionStatus.Granted)}calendarPermissionStatus(){return o.Resolved(l.PermissionStatus.Denied)}readPhoneStatePermissionStatus(){return o.Resolved(l.PermissionStatus.Denied)}drawOverPermissionStatus(){return o.Resolved(l.PermissionStatus.Denied)}backgroundExecutionStatus(){return o.Resolved(l.PermissionStatus.Denied)}cameraRollLimitedCheck(){return o.Resolved(l.PermissionStatus.Denied)}requestCameraPermission(e){const t=r.default.getStack(),i=t&&t.getDeviceManager(),n=()=>{e!==l.SkipAugmentedWebPanelConfig.All&&c.default.showSkypeCameraPermissionPrompt()};return i?this.cameraPermissionStatus().then((t=>(this._canPermissionBeAsked(t)&&e!==l.SkipAugmentedWebPanelConfig.InitialOnly&&n(),o.fromThenable(i.askDevicePermission({audio:!1,video:!0})).then((e=>{let t=l.PermissionStatus.Denied;return e.video?(c.default.dismissSkypeCameraPermissionPrompt(),t=l.PermissionStatus.Granted):n(),t}))))):o.Resolved(l.PermissionStatus.Granted)}requestCameraRollPermission(){return o.Resolved(l.PermissionStatus.Granted)}requestWriteCameraRollPermission(){return o.Resolved(l.PermissionStatus.Granted)}requestMicrophonePermission(e){const t=r.default.getStack(),i=t&&t.getDeviceManager(),n=()=>{e!==l.SkipAugmentedWebPanelConfig.All&&c.default.showSkypeMicrophonePermissionPrompt()};return i?this.microphonePermissionStatus().then((t=>(this._canPermissionBeAsked(t)&&e!==l.SkipAugmentedWebPanelConfig.InitialOnly&&n(),o.fromThenable(i.askDevicePermission({audio:!0,video:!1})).then((e=>{let t=l.PermissionStatus.Denied;return e.audio?(c.default.dismissSkypeMicrophonePermissionPrompt(),t=l.PermissionStatus.Granted):n(),t}))))):o.Resolved(l.PermissionStatus.Granted)}requestMicrophoneAndCameraPermission(e){const t=r.default.getStack(),i=t&&t.getDeviceManager(),n=()=>{e!==l.SkipAugmentedWebPanelConfig.All&&c.default.showSkypeMicrophoneAndCameraPermissionPrompt()};return i?this.microphoneAndCameraPermissionStatus().then((t=>(this._canPermissionBeAsked(t)&&e!==l.SkipAugmentedWebPanelConfig.InitialOnly&&n(),o.fromThenable(i.askDevicePermission({audio:!0,video:!0})).then((e=>{let t=l.PermissionStatus.Denied;return e.audio&&e.video?(t=l.PermissionStatus.Granted,c.default.dismissSkypeMicrophoneAndCameraPermissionPrompt()):e.audio?(t=l.PermissionStatus.MicGrantedAndCameraDenied,c.default.dismissSkypeMicrophoneAndCameraPermissionPrompt()):e.video?(t=l.PermissionStatus.MicDeniedAndCameraGranted,n()):n(),t}))))):o.Resolved(l.PermissionStatus.Granted)}requestContactsPermission(){return o.Resolved(l.PermissionStatus.Granted)}prePromptWithMessageAndTitle(e,t){return o.Resolved(l.PermissionStatus.Granted)}requestLocationPermission(){return o.Resolved(l.PermissionStatus.Granted)}requestLocationAlwaysPermission(){return o.Resolved(l.PermissionStatus.Granted)}requestCalendarPermission(){return o.Resolved(l.PermissionStatus.Denied)}requestReadPhoneStatePermission(){return o.Resolved(l.PermissionStatus.Denied)}requestDrawOverPermission(){return o.Resolved(l.PermissionStatus.Denied)}requestBackgroundExecutionPermission(e){return o.Resolved(l.PermissionStatus.Denied)}requestScreenRecordingPermission(){return o.Resolved(l.PermissionStatus.Granted)}supportsGetPermissionState(){return s.BrowserEnvironment.isEngineChromium()}subscribePermissionStatusChange(e){var t;const i={denied:l.PermissionStatus.Denied,prompt:l.PermissionStatus.Prompt,granted:l.PermissionStatus.Granted};return null===(t=window.navigator.permissions)||void 0===t?void 0:t.query({name:"notifications"}).then((t=>{const n=()=>{e(i[t.state])};t.addEventListener("change",n);return()=>{t.removeEventListener("change",n)}}))}_getPermissionStatusFromState(e){switch(e){case a.PermissionState.Denied:return l.PermissionStatus.Denied;case a.PermissionState.Granted:return l.PermissionStatus.Granted;case a.PermissionState.Prompt:return l.PermissionStatus.Prompt;case a.PermissionState.Unknown:default:return l.PermissionStatus.Unknown}}_getDeviceManager(){const e=r.default.getStack();return e&&e.getDeviceManager()}_canPermissionBeAsked(e){return e===l.PermissionStatus.Prompt||e===l.PermissionStatus.Unknown||e===l.PermissionStatus.Unavailable}}t.WebPermissionsHelper=h;var u=i(140033);Object.defineProperty(t,"PermissionOrigin",{enumerable:!0,get:function(){return u.PermissionOrigin}}),Object.defineProperty(t,"PermissionStatus",{enumerable:!0,get:function(){return u.PermissionStatus}}),Object.defineProperty(t,"SkipAugmentedWebPanelConfig",{enumerable:!0,get:function(){return u.SkipAugmentedWebPanelConfig}}),t.default=new h},638884:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(668011),t);var r=i(668011);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},668011:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=new class{getApplicationId(){return"com.microsoft.skype.s4l-df.web"}getTemplateKey(e,t){return this.getApplicationId()+":"+t.webVersion}getPlatformName(){return"web"}getTransports(e,t,i,n,r){}getNotificationFilteringService(){}useNativeRegistrationId(){return!1}}},995645:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.QuickActionItemKeys=t.DefaultQuickActionIds=t.isValidShortcutItemKeyArr=void 0;const n=i(197582).__importStar(i(397691)),r=i(203924);Object.defineProperty(t,"DefaultQuickActionIds",{enumerable:!0,get:function(){return r.DefaultQuickActionIds}}),Object.defineProperty(t,"isValidShortcutItemKeyArr",{enumerable:!0,get:function(){return r.isValidShortcutItemKeyArr}}),Object.defineProperty(t,"QuickActionItemKeys",{enumerable:!0,get:function(){return r.QuickActionItemKeys}});t.default=new class{constructor(){this.isSystemSupported=!1}removeAll(){return n.Rejected()}updateAll(e){return n.Rejected()}getAndClearInitialUrl(){return Promise.reject()}getAllPinnedShortcuts(){return n.Rejected()}}},203924:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultQuickActionIds=t.QuickActionItemKeys=void 0,t.isValidShortcutItemKeyArr=function(e){return n.every(e,(e=>n.includes(s,e)))},t.toShortcutInfoArr=function(e){return n.map(e,(function(e){return a[e]}))};const n=i(197582).__importStar(i(496486)),r="skype:?quickaction=";var s;!function(e){e.NewCall="NewCall",e.DialPad="DialPad",e.NewChat="NewChat",e.Chats="Chats",e.ChangePresence="ChangePresence",e.Recents="Recents"}(s||(s={}));const a={NewCall:{id:"NewCall",stringKey:"quick_actions_new_call",uri:r+"call",icon:"call_start"},DialPad:{id:"DialPad",stringKey:"quick_actions_dial_pad",uri:r+"dialpad",icon:"dialpad"},NewChat:{id:"NewChat",stringKey:"quick_actions_new_chat",uri:r+"chat",icon:"conversation_note"},Recents:{id:"Recents",stringKey:"quick_actions_recents",uri:r+"recents",icon:"recent"},Chats:{id:"Chats",stringKey:"quick_actions_chats",uri:r+"recents",icon:"chat"},ChangePresence:{id:"ChangePresence",stringKey:"quick_actions_change_presence",uri:r+"presence",icon:"presence"}};t.QuickActionItemKeys=n.keys(s),t.DefaultQuickActionIds=["NewCall","DialPad","Chats","ChangePresence"]},730215:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(995645),t);var r=i(995645);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},527755:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.Duration=void 0,function(e){e[e.Tiny=150]="Tiny",e[e.Short=234]="Short",e[e.Default=300]="Default",e[e.Long=434]="Long",e[e.Debug=1e4]="Debug"}(i||(t.Duration=i={}))},905482:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Easing=void 0;const n=i(197582).__importStar(i(516778)),r={SkypeExpoIn5:n.Animated.Easing.CubicBezier(.67,.01,.83,.21),SkypeExpoInOut5:n.Animated.Easing.CubicBezier(.78,0,.22,1),SkypeExpoOut5:n.Animated.Easing.CubicBezier(.17,.8,.33,.99),SkypeBounce1:n.Animated.Easing.CubicBezier(.65,0,.26,1.31),SkypeBounce2:n.Animated.Easing.CubicBezier(1,0,.35,1.36),SkypeEaseIn:n.Animated.Easing.CubicBezier(1,0,.78,1),SkypeEaseOut:n.Animated.Easing.CubicBezier(.33,0,0,1),SkypeShotgun:n.Animated.Easing.CubicBezier(0,0,0,1),SkypeEaseIn90:n.Animated.Easing.CubicBezier(.9,0,.78,1),SkypeEaseOut90:n.Animated.Easing.CubicBezier(.33,0,.1,1),SkypeEaseIn80:n.Animated.Easing.CubicBezier(.8,0,.78,1),SkypeEaseOut80:n.Animated.Easing.CubicBezier(.33,0,.2,1),SkypeEaseIn70:n.Animated.Easing.CubicBezier(.7,0,.78,1),SkypeEaseOut70:n.Animated.Easing.CubicBezier(.33,0,.3,1),SkypeEaseIn60:n.Animated.Easing.CubicBezier(.6,0,.78,1),SkypeEaseOut60:n.Animated.Easing.CubicBezier(.33,0,.4,1),SkypeEaseInAlt:n.Animated.Easing.CubicBezier(1,0,.67,1),SkypeEaseInSmooth:n.Animated.Easing.CubicBezier(.6,0,.67,1),SkypeEaseOutSmooth:n.Animated.Easing.CubicBezier(.6,0,0,1),SkypeEasyEase:n.Animated.Easing.CubicBezier(.33,0,.67,1),Linear:n.Animated.Easing.Linear(),CubicBezier:(e,t,i,r)=>n.Animated.Easing.CubicBezier(e,t,i,r)};t.Easing=r},419500:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setAnimated=function(e){o=e},t.isAnimated=l,t.parallel=function(e){return s.Animated.parallel(e)},t.sequence=function(e){return s.Animated.sequence(e)},t.getCompositeAnimation=function(e,t){return l()?t.useNativeDriver?a.default.timing(e,t):s.Animated.timing(e,t):{start:i=>{e.setValue(t.toValue),i&&i({finished:!0})},stop:r.noop}};const n=i(197582),r=n.__importStar(i(496486)),s=n.__importStar(i(516778)),a=n.__importDefault(i(73251));let o=!0;function l(){return o}},301277:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NativeUtils=t.Common=t.View=t.timing=t.sequence=t.setAnimated=t.parallel=t.isAnimated=t.getCompositeAnimation=t.Easing=void 0;const n=i(197582),r=n.__importStar(i(527755));t.Common=r;const s=n.__importDefault(i(73251));t.NativeUtils=s.default;var a=i(905482);Object.defineProperty(t,"Easing",{enumerable:!0,get:function(){return a.Easing}});var o=i(419500);Object.defineProperty(t,"getCompositeAnimation",{enumerable:!0,get:function(){return o.getCompositeAnimation}}),Object.defineProperty(t,"isAnimated",{enumerable:!0,get:function(){return o.isAnimated}}),Object.defineProperty(t,"parallel",{enumerable:!0,get:function(){return o.parallel}}),Object.defineProperty(t,"setAnimated",{enumerable:!0,get:function(){return o.setAnimated}}),Object.defineProperty(t,"sequence",{enumerable:!0,get:function(){return o.sequence}});var l=i(794926);Object.defineProperty(t,"timing",{enumerable:!0,get:function(){return l.timing}});var d=i(45417);Object.defineProperty(t,"View",{enumerable:!0,get:function(){return d.View}})},73251:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=n.__importStar(i(496486)),s=n.__importStar(i(516778));t.default=class{static markAnimatedValue(e,t){let i=t;if(r.isNull(i)||r.isUndefined(i)){i=0}}static delayDuration(e){return e}static timing(e,t){if(r.isNil(t.toValue)||r.isNaN(t.toValue)){t.toValue;t.toValue=0}return t.loop&&r.isNil(t.isInteraction)&&(t.isInteraction=!1),s.Animated.timing(e,t)}}},794926:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.timing=void 0;const n=i(197582),r=n.__importStar(i(496486)),s=n.__importStar(i(167606)),a=n.__importStar(i(516778)),o=i(527755),l=i(905482),d=i(419500),c=n.__importDefault(i(73251));const h=new class{bounceIn(e,t){const i=r.map(e,(e=>this.easeIn(e))),n=r.map(t,(e=>this.easeOut(e)));return a.Animated.sequence([a.Animated.parallel(i),a.Animated.parallel(n)])}easeIn(e){const t={toValue:e.toValue,delay:this._getDelay(e.delay),easing:l.Easing.SkypeEaseIn,duration:this._getDuration(e.duration),isInteraction:e.isInteraction,useNativeDriver:!!e.useNativeDriver};return(0,d.getCompositeAnimation)(e.value,t)}easeOut(e){const t={toValue:e.toValue,delay:this._getDelay(e.delay),easing:l.Easing.SkypeEaseOut,duration:this._getDuration(e.duration),isInteraction:e.isInteraction,useNativeDriver:!!e.useNativeDriver};return(0,d.getCompositeAnimation)(e.value,t)}easeOut5(e){const t={toValue:e.toValue,delay:this._getDelay(e.delay),easing:l.Easing.SkypeExpoOut5,duration:this._getDuration(e.duration),isInteraction:e.isInteraction,useNativeDriver:!!e.useNativeDriver};return(0,d.getCompositeAnimation)(e.value,t)}linear(e){const t={toValue:e.toValue,delay:this._getDelay(e.delay),easing:l.Easing.Linear,duration:this._getDuration(e.duration),isInteraction:e.isInteraction,useNativeDriver:!!e.useNativeDriver};return(0,d.getCompositeAnimation)(e.value,t)}shotgun(e){const t={toValue:e.toValue,delay:this._getDelay(e.delay),easing:l.Easing.SkypeShotgun,duration:this._getDuration(e.duration),isInteraction:e.isInteraction,useNativeDriver:!!e.useNativeDriver};return(0,d.getCompositeAnimation)(e.value,t)}_getDelay(e){return e?c.default.delayDuration(e):void 0}_getDuration(e){return r.isUndefined(e)?e=o.Duration.Default:e<o.Duration.Tiny?(s.warn(s.LogTraceArea.SXAnimated,"Timing: Duration used of "+e+" exceeds the minimum duration of SXAnimated.Common.Duration.Tiny"),e=o.Duration.Tiny):e>o.Duration.Long&&(s.warn(s.LogTraceArea.SXAnimated,"Timing: Duration used of "+e+" exceeds the maximum duration of SXAnimated.Common.Duration.Long"),e=o.Duration.Long),e}};t.timing=h},45417:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.View=void 0;const n=i(197582),r=i(785893),s=i(743726),a=n.__importStar(i(516778)),o=i(217041),l=n.__importStar(i(527755)),d=i(905482),c=n.__importStar(i(419500));class h extends o.ComponentBase{constructor(){super(...arguments),this._defaultAnimationConfig={isInteraction:!1,useNativeDriver:!0},this._fadeCallback=(e,t,i)=>{delete this._animation,t.finished&&(this._animatedValues.opacity=e),null==i||i(t)},this._maybeStopAnimation=()=>{this._animation&&this._animation.stop()},this._onLayoutChanged=e=>{this._layoutInfo=e,this.props.onLayout&&this.props.onLayout(e)}}_buildState(e,t){return t&&(this._animatedValues={x:e.x||0,y:e.y||0,scale:void 0===e.scale?1:e.scale,opacity:void 0===e.opacity?1:e.opacity},this._animatedOpacityValue=new a.Animated.Value(this._animatedValues.opacity),this._animatedTranslateXValue=new a.Animated.Value(this._animatedValues.x),this._animatedTranslateYValue=new a.Animated.Value(this._animatedValues.y),this._animatedScaleValue=new a.Animated.Value(this._animatedValues.scale),this._animatedInnerStyle=a.Styles.createAnimatedViewStyle({opacity:this._animatedOpacityValue,transform:[{scale:this._animatedScaleValue},{translateX:this._animatedTranslateXValue},{translateY:this._animatedTranslateYValue}]})),{}}fadeIn(e,t,i){const n=this._getAnimationConfig(t);this._maybeStopAnimation(),this._animation=this._fade(1,n,i),this._animation.start((t=>this._fadeCallback(1,t,e)))}fadeOut(e,t,i){const n=this._getAnimationConfig(t);this._maybeStopAnimation(),this._animation=this._fade(0,n,i),this._animation.start((t=>this._fadeCallback(0,t,e)))}getAnimation(e,t,i){var n,r,a,o,h,u,p,g;t=t||(0,s.newCauseId)();const m=[],f=this._getAnimationConfig(i);let S,v,y,C;this._checkAnimationProperties(e,t);let T,E,_,b,P=!1,I=!1,A=!1,R=!1;void 0!==e.opacity&&(P=!(!e.opacity||"number"==typeof e.opacity),T=e.opacity,S=P?T.toValue:e.opacity),void 0!==e.scale&&(I=!(!e.scale||"number"==typeof e.scale),E=e.scale,v=I?E.toValue:e.scale),void 0!==e.x&&(A=!(!e.x||"number"==typeof e.x),_=e.x,y=A?_.toValue:e.x),void 0!==e.y&&(R=!(!e.y||"number"==typeof e.y),b=e.y,C=R?b.toValue:e.y);const w=void 0!==S&&void 0!==this._animatedValues.opacity,M=void 0!==v&&void 0!==this._animatedValues.scale,O=void 0!==y&&void 0!==this._animatedValues.x,D=void 0!==C&&void 0!==this._animatedValues.y,k=M&&this._animatedValues.scale<v;if(M){let e,t,i=k?d.Easing.SkypeExpoOut5:d.Easing.SkypeExpoIn5,s=l.Duration.Short;(O||D)&&(i=d.Easing.SkypeExpoOut5,s=l.Duration.Long),I&&E&&(i=null!==(n=E.easing)&&void 0!==n?n:i,e=E.delay,s=null!==(r=E.duration)&&void 0!==r?r:s),m.push(this._getCompositeAnimation(this._animatedScaleValue,{toValue:v,easing:i,delay:e,duration:s,loop:t,isInteraction:f.isInteraction,useNativeDriver:f.useNativeDriver}))}if(w){let e,t=M&&!k?100:void 0;M&&k?e=l.Duration.Tiny:O||D?e=l.Duration.Short:P&&T&&(e=null!==(a=T.duration)&&void 0!==a?a:e,t=null!==(o=T.delay)&&void 0!==o?o:t),m.push(this._fade(S,f,{duration:e,delay:t}))}if(O){let e,t,i=d.Easing.SkypeExpoOut5,n=l.Duration.Long;if(M){const e=this._layoutInfo?this._layoutInfo.width/2:0;y=this._translateAndScale(this._animatedValues.x,y,v,e)}A&&_&&(i=null!==(h=_.easing)&&void 0!==h?h:i,e=_.delay,n=null!==(u=_.duration)&&void 0!==u?u:n,t=_.loop),m.push(this._getCompositeAnimation(this._animatedTranslateXValue,{toValue:y,easing:i,delay:e,duration:n,loop:t,isInteraction:f.isInteraction,useNativeDriver:f.useNativeDriver}))}if(D){let e,t,i=d.Easing.SkypeExpoOut5,n=l.Duration.Long;if(M){const e=this._layoutInfo?this._layoutInfo.height/2:0;C=this._translateAndScale(this._animatedValues.y,C,v,e)}R&&b&&(i=null!==(p=b.easing)&&void 0!==p?p:i,e=b.delay,n=null!==(g=b.duration)&&void 0!==g?g:n,t=b.loop),m.push(this._getCompositeAnimation(this._animatedTranslateYValue,{toValue:C,easing:i,duration:n,delay:e,loop:t,isInteraction:f.isInteraction,useNativeDriver:f.useNativeDriver}))}let N;const L=c.parallel(m);return{start:e=>{N=e,this._maybeStopAnimation(),this._animation=L,this._animation.start((e=>{delete this._animation,e.finished&&(this._animatedValues.scale=M?v:this._animatedValues.scale,this._animatedValues.opacity=w?S:this._animatedValues.opacity,this._animatedValues.x=O?y:this._animatedValues.x,this._animatedValues.y=D?C:this._animatedValues.y),null==N||N(e)}))},stop:()=>{L.stop()}}}setValue(e,t){t=t||(0,s.newCauseId)(),this._checkAnimationProperties(e,t),this._maybeStopAnimation(),void 0!==e.x&&(this._animatedValues.x=e.x,this._animatedTranslateXValue.setValue(e.x)),void 0!==e.y&&(this._animatedValues.y=e.y,this._animatedTranslateYValue.setValue(e.y)),void 0!==e.scale&&(this._animatedValues.scale=e.scale,this._animatedScaleValue.setValue(e.scale)),void 0!==e.opacity&&(this._animatedValues.opacity=e.opacity,this._animatedOpacityValue.setValue(e.opacity))}stop(){this._maybeStopAnimation()}render(){return(0,r.jsx)(a.Animated.View,Object.assign({},this.props,{style:[this.props.style,this._animatedInnerStyle],onLayout:this._onLayoutChanged,children:this.props.children}))}_checkAnimationProperties(e,t){}_fade(e,t,i={}){const n=this._getFadeConfigs(e,t,i);return c.getCompositeAnimation(this._animatedOpacityValue,n)}_getAnimationConfig(e){return{isInteraction:e&&e.isInteraction?e.isInteraction:!!this._defaultAnimationConfig.isInteraction,useNativeDriver:e&&void 0!==e.useNativeDriver?e.useNativeDriver:!!this._defaultAnimationConfig.useNativeDriver}}_getCompositeAnimation(e,t){return c.getCompositeAnimation(e,t)}_getFadeConfigs(e,t,i={}){return Object.assign(Object.assign({},t),{toValue:e,easing:i.easing||d.Easing.Linear,duration:i.duration||l.Duration.Short})}_translateAndScale(e,t,i,n=0){return t/i+(t-e>0?1:-1)*n}}t.View=h},859745:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});i(197582).__exportStar(i(301277),t)},646224:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=n.__importStar(i(167606)),s=n.__importStar(i(397691));t.default=new class{launchSystemScreenShareMenu(e){return r.log(r.LogTraceArea.CallingUI,"ScreenShareManager.launchSystemScreenShareMenu Not Implemented"),s.Rejected()}}},807592:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(646224),t);var r=i(646224);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},773671:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(668780),t);var r=i(668780);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},668780:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=n.__importStar(i(496486)),a=i(217041);class o extends a.ComponentBase{constructor(){super(...arguments),this._onCopy=e=>{if(s.isNil(this._innerTextRef))return;e.preventDefault();const[t,i]=this._getSelection(this._innerTextRef);return s.isEmpty(t)||s.isEmpty(i)?void 0:(this.props.onCopy(e,i,t),!0)},this._onRef=e=>this._innerTextRef=e}render(){return(0,r.jsx)("span",{ref:this._onRef,children:this.props.children})}copySelection(e){return this._onCopy(e)}quoteSelection(){return this._onQuote()}_onQuote(){if(s.isNil(this._innerTextRef))return;const[e]=this._getSelection(this._innerTextRef);return e}_getSelection(e){var t;const i=null===(t=e.ownerDocument)||void 0===t?void 0:t.getSelection();return(null==i?void 0:i.containsNode(e,!0))?[this._getSelectionContent(i),i.toString()]:[]}_getSelectionContent(e){if(s.isNil(this._innerTextRef))return;const t=e.getRangeAt(0),i=new Range,n=this._innerTextRef.contains(t.startContainer),r=this._innerTextRef.contains(t.endContainer),a=t.startContainer.textContent&&t.startContainer.textContent.length>t.startOffset;return n&&a?i.setStart(t.startContainer,t.startOffset):i.setStart(this._innerTextRef.firstChild||this._innerTextRef,0),r?i.setEnd(t.endContainer,t.endOffset):i.setEndAfter(this._innerTextRef.lastChild||this._innerTextRef),i.toString()}}t.default=o},400059:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(272576),t);var r=i(272576);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},272576:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=n.__importStar(i(397691)),s=n.__importDefault(i(880791));t.default=new class{drawLogo(e,t,n){const a=r.Defer(),o=(n>t?t:n)/5,l=i(17280).Z;return s.default.createImageContext(o,o).then((i=>{s.default.setFilter(i,"invert(100%) opacity(20%)"),s.default.createImageContextWithURL(l,o,o).then((n=>{s.default.drawGraphicsContext(i,n,{size:{width:o,height:o},origin:{x:0,y:0}},{size:{width:o,height:o},origin:{x:0,y:0}}),s.default.drawGraphicsContext(e,i,{size:{width:o,height:o},origin:{x:0,y:0}},{size:{width:o,height:o},origin:{x:0,y:t-o}}),s.default.destroyContext(n),s.default.destroyContext(i),a.resolve()}))})),a.promise()}}},50554:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=new class{onSplashScreenClosed(){}}},111878:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(50554),t);var r=i(50554);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},690103:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582).__importStar(i(516778));t.default=new class{getFontSize(e){const t=n.Styles.combine(e);if(t.fontSize)return t.fontSize}}},672205:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(690103),t);var r=i(690103);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},663111:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582).__importStar(i(397691));t.default=new class{createSyncAccount(){return n.Rejected("Not implemented")}deleteSyncAccount(){return n.Rejected("Not implemented")}refresh(e){return n.Rejected("Not implemented")}addSkypeCapabilitiesToNativeContacts(e){return n.Rejected("Not implemented")}autoGrantContactsWritePermissions(){return n.Rejected("Not implemented")}}},955983:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(663111),t);var r=i(663111);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},831179:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SystemHotKey=void 0;class i{registerHotKey(e,t){return!1}unRegisterHotKey(e,t){return!1}}t.SystemHotKey=i,t.default=new i},210576:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(831179),t);var r=i(831179);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},313649:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(186806),t);var r=i(186806);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},186806:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=new class{getNotices(){return new Promise(((e,t)=>{i.e(503).then((n=>{try{const t=i(907942);e(t.value)}catch(e){t(e)}}).bind(null,i)).catch(i.oe)}))}}},336550:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(959536),t);var r=i(959536);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},200466:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(605005),t);var r=i(605005);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},605005:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=n.__importStar(i(496486)),s=n.__importStar(i(167606)),a=n.__importDefault(i(974634)),o=n.__importStar(i(397691)),l={};t.default=new class{constructor(){this.onResponse=new a.default,this.onClientFailure=new a.default,this.onProgress=new a.default,this.onAllBackgroundRequestsFinished=new a.default}getKnownRequestIdsAtStartup(e){return o.Resolved([])}send(e,t,i,n={}){var a;"GET"===t&&"blob"===(null===(a=n.headers)||void 0===a?void 0:a.responseType)&&(l[e]={id:e,fileUri:i},l[e].request=fetch(new Request(i)).then((t=>{if(!r.isUndefined(l[e]))return delete l[e],t.blob().then((e=>({uri:URL.createObjectURL(e),blob:e}))).then((({uri:t,blob:i})=>{const n={statusCode:200,headers:{"content-type":"application/json"},body:JSON.stringify({uri:t,sizeInBytes:i.size})};this.onResponse.fire(e,n),r.size(l)||this.onAllBackgroundRequestsFinished.fire()}))})).catch((t=>{s.log(s.LogTraceArea.GenericUnsafe,`[UrlRequest] failed with error: ${t}`),delete l[e];const i={statusCode:404,headers:{},body:void 0,error:t};this.onClientFailure.fire(e,i),r.size(l)||this.onAllBackgroundRequestsFinished.fire()})))}cancel(e){r.isUndefined(l[e])||delete l[e]}notifyFinished(e,t,i){}}},184810:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(729196),t);var r=i(729196);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},729196:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WebViewBridge=void 0;const n=i(197582),r=i(785893),s=n.__importStar(i(516778)),a=i(26703),o=n.__importDefault(i(220534)),l=(0,a.lazyProperties)({webViewDefault:()=>s.Styles.createWebViewStyle({flex:1,alignSelf:"stretch",borderStyle:"none"}),webViewContainer:()=>s.Styles.createViewStyle({flexDirection:"column",flex:1,alignSelf:"stretch"})});class d extends s.Component{constructor(e){super(e),this._onIframeRef=e=>{this._iframeDom=e},this._onLoad=e=>{this.props.onLoad&&this.props.onLoad(e)},this._sandboxToStringValue=e=>{const t=[];return e&s.Types.WebViewSandboxMode.AllowForms&&t.push("allow-forms"),e&s.Types.WebViewSandboxMode.AllowModals&&t.push("allow-modals"),e&s.Types.WebViewSandboxMode.AllowOrientationLock&&t.push("allow-orientation-lock"),e&s.Types.WebViewSandboxMode.AllowPointerLock&&t.push("allow-pointer-lock"),e&s.Types.WebViewSandboxMode.AllowPopups&&t.push("allow-popups"),e&s.Types.WebViewSandboxMode.AllowPopupsToEscapeSandbox&&t.push("allow-popups-to-escape-sandbox"),e&s.Types.WebViewSandboxMode.AllowPresentation&&t.push("allow-presentation"),e&s.Types.WebViewSandboxMode.AllowSameOrigin&&t.push("allow-same-origin"),e&s.Types.WebViewSandboxMode.AllowScripts&&t.push("allow-scripts"),e&s.Types.WebViewSandboxMode.AllowTopNavigation&&t.push("allow-top-navigation"),t.join(" ")},this._webFrameIdentifier="frame"+d._webFrameNumber,d._webFrameNumber++}render(){const e=s.Styles.combine(l.webViewDefault,this.props.style),t=void 0!==this.props.sandbox?this.props.sandbox:this.props.javaScriptEnabled?s.Types.WebViewSandboxMode.AllowScripts:s.Types.WebViewSandboxMode.None;return(0,r.jsx)(s.View,{style:l.webViewContainer,children:(0,r.jsx)("iframe",{"aria-label":this.props.ariaLabel,ref:this._onIframeRef,name:this._webFrameIdentifier,id:this._webFrameIdentifier,style:e,src:this.props.url,onLoad:this._onLoad,sandbox:this._sandboxToStringValue(t),width:"100%",allow:this.props.allow})})}reload(){if(this._iframeDom&&this._iframeDom.contentWindow){o.default.getDomainName(this._iframeDom.src)===o.default.getDomainName(window.location.href)?this._iframeDom.contentWindow.location.reload(!0):this._iframeDom.src=this._iframeDom.src}}goBack(){this._iframeDom&&this._iframeDom.contentWindow&&this._iframeDom.contentWindow.history.back()}goForward(){this._iframeDom&&this._iframeDom.contentWindow&&this._iframeDom.contentWindow.history.forward()}postMessage(e,t="*"){this._iframeDom&&this._iframeDom.contentWindow&&this._iframeDom.contentWindow.postMessage(e,t)}focus(){this._iframeDom&&this._iframeDom.contentWindow&&this._iframeDom.contentWindow.focus()}blur(){this._iframeDom&&this._iframeDom.contentWindow&&this._iframeDom.contentWindow.blur()}injectJavaScript(e){throw new Error("Method not implemented.")}}t.WebViewBridge=d,d._webFrameNumber=1,t.default=d},814169:(e,t)=>{"use strict";var i,n,r;Object.defineProperty(t,"__esModule",{value:!0}),t.MainRootViewId=t.NativeWindowType=t.SplitViewMode=t.WindowType=void 0,function(e){e[e.CallMonitor=0]="CallMonitor",e[e.MainView=1]="MainView",e[e.SplitView=2]="SplitView"}(i||(t.WindowType=i={})),function(e){e[e.None=0]="None",e[e.MultiWindow=1]="MultiWindow"}(n||(t.SplitViewMode=n={})),function(e){e.Child="child",e.Modal="modal",e.TopModal="top-modal",e.CallNotification="call-notification",e.ScreenSharing="screen-sharing",e.CallMonitor="call-monitor",e.ClipsCamera="clips-camera",e.ClipsControls="clips-controls",e.ClipsScreenPicker="clips-screenpicker",e.ClipsControlsDebug="clips-controls-debug"}(r||(t.NativeWindowType=r={})),t.MainRootViewId="__MAIN_ROOT_VIEW_ID__"},970068:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MainWindow=void 0;class i{flashIfInactive(){}cancelFlash(){}isMaximized(){return!1}setMaximizable(e){}setResizable(e){}setSize(e,t,i){}setupForLogin(){}tryRestoreBounds(){}isFullscreen(){return Promise.reject()}setFullScreen(e){}isVisible(){return Promise.reject()}center(){}maximize(){}isFocused(){return!1}requestFocus(){}getPrimaryDisplaySize(){return{width:0,height:0}}getBounds(){}getNativeRootComponent(){return document.getElementsByClassName("app-container")[0]}addEventListener(e,t){}removeEventListener(e,t){}}t.MainWindow=i,t.default=new i},338565:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WindowType=t.NativeWindowType=t.MainRootViewId=t.MainWindow=t.NativeWindow=void 0;const n=i(197582),r=n.__importStar(i(397691)),s=i(814169);Object.defineProperty(t,"MainRootViewId",{enumerable:!0,get:function(){return s.MainRootViewId}}),Object.defineProperty(t,"NativeWindowType",{enumerable:!0,get:function(){return s.NativeWindowType}}),Object.defineProperty(t,"WindowType",{enumerable:!0,get:function(){return s.WindowType}});const a=n.__importDefault(i(970068));t.MainWindow=a.default;const o=n.__importDefault(i(408740));t.NativeWindow=o.default;t.default=new class{constructor(){this.splitViewSupported=!1,this.splitViewMode=s.SplitViewMode.None}turnOnSplitView(e){return r.Rejected("Split view not supported")}turnOffSplitView(e,t){return r.Rejected("Split view not supported")}openNativeWindow(e,t,i,n,s){return r.Rejected("Native windows are not supported")}closeNativeWindow(e){}openSplitView(e,t,i,n,s,a){return r.Rejected("Split view not supported")}closeSplitView(e){return r.Rejected("Split view not supported")}openMainView(e){return r.Rejected("Split view not supported")}closeAllSplitViews(){return r.Rejected("Split view not supported")}getLastActiveSplitView(){return r.Rejected("Split view not supported")}getLastActiveSplitViewWindow(){}getFocusedSplitViewId(){}isMainViewInFocus(){return r.Rejected("Split view not supported")}isMainViewClosed(){return r.Rejected("Split view not supported")}isSplitViewInFocus(e){return r.Rejected("Split view not supported")}flashIfInactive(e){}setTitle(e,t){}addSplitViewsEventListener(e,t){}removeSplitViewsEventListener(e,t){}}},408740:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582).__importStar(i(397691));t.default=class{open(e,t,i,r,s,a,o){return n.Rejected()}reRender(e,t){}close(){}setTitle(e){}setSize(e,t,i){}getRootViewId(){}setBackgroundColor(e){}getWindow(){}getNativeRootComponent(){}hasFocus(){return!1}requestFocus(){}setOpacity(e){}show(e){}hide(){}clearVisiblityIntervalsAndShowWindow(){}clearVisiblityIntervalsAndHideWindow(){}startVisibilityIntervals(e,t){}setPosition(e,t){}getBounds(){}}},720415:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(338565),t);var r=i(338565);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},875540:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=n.__importStar(i(496486)),a=n.__importStar(i(516778)),o=n.__importStar(i(313755)),l=i(438278),d=i(26703),c=n.__importStar(i(471968)),h=(0,d.lazyProperties)({containerStyle:()=>a.Styles.createViewStyle({flex:1,flexDirection:"column"})});class u extends l.AdaptiveCardBaseView{constructor(){super(...arguments),this._onExecuteAction=(e,t)=>{if(e.type===c.ActionTypes.actionShowCard){const t=e.card;this.setState({actionCard:this.state.actionCard===t?void 0:t})}this.props.onExecuteAction&&this.props.onExecuteAction(e,t)},this._onActionLayoutChange=e=>{e.width-this.state.maxActionWidth>10&&this.setState({maxActionWidth:e.width,scrollAvailable:this._getScrollAvailable(e.width,this.state.maxWidth)})},this._onLayoutChange=e=>{const t=Math.max(e.width,this.state.maxWidth);this.setState({maxWidth:t,scrollAvailable:this._getScrollAvailable(this.state.maxActionWidth,t)})}}_buildState(e,t){const i={};return t&&(i.actionCard=void 0,i.maxActionWidth=0,i.maxWidth=0,i.scrollAvailable=this._getScrollConfigured()),i}render(){const e=this._getScrollConfigured()&&this.state.scrollAvailable,t=this._getScrollConfigured()||this.props.hostConfig.actions.actionsOrientation===c.ActionsOrientationTypes.horizontal,i=this._getScrollConfigured()&&!this.state.scrollAvailable||this.props.hostConfig.actions.actionAlignment===c.ActionAlignmentTypes.stretch,n=this._getActionsCount(),o=s.compact(s.map(this.props.actions,((r,s)=>r&&s<n?this._renderAction(r,s,n,t,i,e):void 0))),l=this.state.actionCard?a.Styles.createViewStyle({marginTop:this.props.hostConfig.actions.showCard.inlineTopMargin},!1):void 0,d=this.state.actionCard&&this.props.hostConfig.actions.showCard.actionMode!==c.ShowActionModeTypes.popup?(0,r.jsx)(a.View,{style:l,children:this.props.renderCard(this.state.actionCard)},"actionCard"):void 0,u=e?this._renderScrollableActions(o):this._renderActions(o,t);return(0,r.jsxs)(a.View,{style:h.containerStyle,onLayout:this._onLayoutChange,children:[u,d]},"actionsContainer")}_renderAction(e,t,i,n,s,l){const d=t>0?this.props.hostConfig.actions.buttonSpacing:void 0,h=a.Styles.createViewStyle({flex:s?1:l?0:void 0,flexBasis:s&&n?0:void 0,marginLeft:n?d:void 0,marginTop:n?void 0:d,minWidth:l?this.state.maxActionWidth:void 0},!1),u=e.type===c.ActionTypes.actionShowCard&&e.card===this.state.actionCard;return(0,r.jsx)(a.View,{style:h,onLayout:this._onActionLayoutChange,children:(0,r.jsx)(o.default,{action:e,hostConfig:this.props.hostConfig,customButtonStyles:this.props.customButtonStyles,customTextStyles:this.props.customTextStyles,customViewStyles:this.props.customViewStyles,parentContainerStyle:this.props.parentContainerStyle,placement:this._getActionPlacement(t,i),isExpanded:u,isHorizontal:n,isScrollable:l,onExecuteAction:this._onExecuteAction})},this.getReactKey("action",t))}_renderScrollableActions(e){const t=a.Styles.createViewStyle({flex:1,flexDirection:"row",paddingBottom:this.props.hostConfig.actions.scrollBarPadding,marginTop:this.props.hostConfig.spacing[this.props.hostConfig.actions.spacing]},!1);return(0,r.jsx)(a.ScrollView,{bounces:!0,horizontal:!0,vertical:!1,keyboardDismissMode:"none",keyboardShouldPersistTaps:!1,overScrollMode:"never",scrollEnabled:!0,showsHorizontalScrollIndicator:!1,showsVerticalScrollIndicator:!1,tabNavigation:"cycle",style:t,children:e},"actions")}_renderActions(e,t){let i;switch(this.props.hostConfig.actions.actionAlignment){case c.ActionAlignmentTypes.left:i="flex-start";break;case c.ActionAlignmentTypes.center:i="center";break;case c.ActionAlignmentTypes.right:i="flex-end";break;case c.ActionAlignmentTypes.stretch:case c.ActionAlignmentTypes.scroll:i=void 0;break;default:i="center"}const n=a.Styles.createViewStyle({flex:1,flexDirection:t?"row":"column",alignItems:t?void 0:i,justifyContent:t?i:void 0,marginTop:this.props.hostConfig.spacing[this.props.hostConfig.actions.spacing]},!1);return(0,r.jsx)(a.View,{style:n,children:e},"actions")}_getActionsCount(){return Math.min(this.props.actions.length,this.props.hostConfig.actions.maxActions)}_getScrollAvailable(e,t){return t<e*this._getActionsCount()}_getScrollConfigured(){return this.props.hostConfig.actions.actionAlignment===c.ActionAlignmentTypes.scroll}_getActionPlacement(e,t){return 1===t?o.Placement.Single:0===e?o.Placement.First:e===t-1?o.Placement.Last:o.Placement.Middle}}t.default=u},313755:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Placement=void 0;const n=i(197582),r=i(785893),s=n.__importStar(i(516778)),a=i(438278),o=i(26703),l=i(471968),d=(0,o.lazyProperties)({buttonBase:()=>s.Styles.createButtonStyle({flex:1,flexDirection:"row",alignItems:"center",cursor:"pointer"}),buttonDefaultStyle:()=>s.Styles.createButtonStyle({borderWidth:0,borderStyle:"solid",borderColor:"#E5E4E8",backgroundColor:"#F1F1F4"}),buttonDefaultText:()=>s.Styles.createTextStyle({flex:1,marginLeft:12,marginRight:12,marginTop:10,marginBottom:10,color:"#2B2C33",flexWrap:"nowrap",fontWeight:"bold",textAlign:"center",fontSize:14})});var c;!function(e){e[e.Single=0]="Single",e[e.First=1]="First",e[e.Middle=2]="Middle",e[e.Last=3]="Last"}(c||(t.Placement=c={}));class h extends a.AdaptiveCardBaseView{constructor(){super(...arguments),this._onButtonRef=e=>{this._buttonRef=e},this._onLongPress=e=>{if(e.stopPropagation(),this.props.action.type===l.ActionTypes.actionOpenUrl){const e=Object.assign(Object.assign({},this.props.action),{preview:!0});this._executeAction(e)}},this._onPress=e=>{e.stopPropagation(),this._executeAction(this.props.action)},this._executeAction=(e,t)=>{this.props.onExecuteAction&&this._buttonRef&&this.props.onExecuteAction(e,this._buttonRef)},this._handleHoverStart=()=>{this.setState({isHover:!0})},this._handleHoverEnd=()=>{this.setState({isHover:!1})}}_buildState(e,t){const i={};return t&&(i.isHover=!1),i}render(){const e=[d.buttonDefaultStyle],t=[d.buttonDefaultText,s.Styles.createTextStyle({fontFamily:this.props.hostConfig.fontFamily},!1)];if(this.props.customButtonStyles){switch(e.push(this.props.customButtonStyles[a.CustomStyleNames.action]),this.state.isHover&&e.push(this.props.customButtonStyles[a.CustomStyleNames.actionHover]),this.props.placement){case c.First:this.props.isHorizontal||this.props.isScrollable?e.push(this.props.customButtonStyles[a.CustomStyleNames.actionFirstHorizontal]):e.push(this.props.customButtonStyles[a.CustomStyleNames.actionFirst]);break;case c.Middle:e.push(this.props.customButtonStyles[a.CustomStyleNames.actionMiddle]);break;case c.Last:this.props.isHorizontal||this.props.isScrollable?e.push(this.props.customButtonStyles[a.CustomStyleNames.actionLastHorizontal]):e.push(this.props.customButtonStyles[a.CustomStyleNames.actionLast]);break;case c.Single:e.push(this.props.customButtonStyles[a.CustomStyleNames.actionSingle])}this.props.action.type===l.ActionTypes.actionShowCard&&(e.push(this.props.customButtonStyles[a.CustomStyleNames.actionExpandable]),e.push(this.props.isExpanded?this.props.customButtonStyles[a.CustomStyleNames.actionExpanded]:this.props.customButtonStyles[a.CustomStyleNames.actionSubdued]))}if(this.props.customTextStyles)switch(t.push(this.props.customTextStyles[a.CustomStyleNames.action]),this.state.isHover&&t.push(this.props.customTextStyles[a.CustomStyleNames.actionHover]),this.props.placement){case c.First:this.props.isHorizontal||this.props.isScrollable?t.push(this.props.customTextStyles[a.CustomStyleNames.actionFirstHorizontal]):t.push(this.props.customTextStyles[a.CustomStyleNames.actionFirst]);break;case c.Middle:t.push(this.props.customTextStyles[a.CustomStyleNames.actionMiddle]);break;case c.Last:this.props.isHorizontal||this.props.isScrollable?t.push(this.props.customTextStyles[a.CustomStyleNames.actionLastHorizontal]):t.push(this.props.customTextStyles[a.CustomStyleNames.actionLast]);break;case c.Single:t.push(this.props.customTextStyles[a.CustomStyleNames.actionSingle])}return(0,r.jsx)(s.Button,{ref:this._onButtonRef,style:[e,d.buttonBase],onLongPress:this._onLongPress,onPress:this._onPress,onHoverStart:this._handleHoverStart,onHoverEnd:this._handleHoverEnd,title:this.props.action.type===l.ActionTypes.actionOpenUrl?this.props.action.url:void 0,children:(0,r.jsx)(s.Text,{style:t,numberOfLines:1,children:this.props.action.title})})}}t.default=h},89265:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AdaptiveCardView=t.CardImagePlacement=void 0;const n=i(197582),r=i(785893),s=n.__importStar(i(496486)),a=n.__importStar(i(516778)),o=n.__importDefault(i(875540)),l=n.__importDefault(i(913264)),d=n.__importDefault(i(189432)),c=i(438278),h=n.__importDefault(i(486610)),u=n.__importDefault(i(69282)),p=n.__importDefault(i(554775)),g=n.__importDefault(i(950527)),m=n.__importDefault(i(753938)),f=n.__importDefault(i(523054)),S=n.__importDefault(i(714518)),v=n.__importDefault(i(789567)),y=n.__importStar(i(251577)),C=n.__importDefault(i(701875)),T=n.__importDefault(i(505869)),E=n.__importDefault(i(755879)),_=n.__importDefault(i(165901)),b=n.__importDefault(i(151932)),P=n.__importDefault(i(960912)),I=n.__importDefault(i(114818)),A=i(26703),R=n.__importDefault(i(73776)),w=n.__importDefault(i(979304)),M=n.__importDefault(i(549187)),O=n.__importDefault(i(581911)),D=n.__importDefault(i(954567)),k=n.__importStar(i(471968)),N="showCardActionPopup",L=(0,A.lazyProperties)({cardContainerStyle:()=>a.Styles.createViewStyle({flex:1,flexDirection:"column",alignItems:"stretch"}),cardContainerFixedDimensions:()=>a.Styles.createViewStyle({flexDirection:"column",alignItems:"stretch"}),cardContainerSideImage:()=>a.Styles.createViewStyle({flex:1,flexDirection:"row",alignItems:"stretch"}),cardHeroImage:()=>a.Styles.createViewStyle({flex:1}),cardBaseStyle:()=>a.Styles.createViewStyle({flex:0,flexDirection:"column"}),cardDefaultStyle:()=>a.Styles.createViewStyle({borderWidth:1,borderStyle:"solid",borderColor:"#E5E4E8"}),elementsContainer:()=>a.Styles.createViewStyle({flex:1,flexDirection:"column",justifyContent:"flex-start"}),placeHolder:()=>a.Styles.createViewStyle({flex:1}),attributionContainer:()=>a.Styles.createViewStyle({flexDirection:"row",position:"absolute",bottom:0,left:0,paddingLeft:10,paddingBottom:8,paddingTop:4})});var x;!function(e){e[e.Left=0]="Left",e[e.Right=1]="Right",e[e.Top=2]="Top",e[e.Bottom=3]="Bottom",e[e.Stretch=4]="Stretch"}(x||(t.CardImagePlacement=x={}));class F extends c.AdaptiveCardBaseView{constructor(){super(...arguments),this._animatedOpacityValue=new a.Animated.Value(0),this._animatedOpacityStyle=a.Styles.createAnimatedViewStyle({opacity:this._animatedOpacityValue}),this._renderCard=(e,t)=>{if(!e)return null;let i=0;const n=[L.cardBaseStyle],o=[];this.props.customViewStyles&&(this.props.customViewStyles.card&&(i=n.push(this.props.customViewStyles[c.CustomStyleNames.card]),o.push(this.props.customViewStyles[c.CustomStyleNames.card])),s.isEmpty(this.props.adaptiveCard.actions&&this.props.customViewStyles[c.CustomStyleNames.cardWithActions])||(i=n.push(this.props.customViewStyles[c.CustomStyleNames.cardWithActions]),o.push(this.props.customViewStyles[c.CustomStyleNames.cardWithActions]))),i||(n.push(L.cardDefaultStyle),n.push(a.Styles.createViewStyle({backgroundColor:this.state.mergedHostConfig.container.default.backgroundColor},!1)));const l=e["-ms-height"]!==k.CardHeightTypes.auto&&(this.props.aspectRatio||O.default.stringToAspectRatio(e["-ms-aspectRatio"])),d=this.props.height||(l&&this.state.viewWidth?Math.floor(this.state.viewWidth/l):void 0),h=this.props.maxHeight||e["-ms-maxHeight"];let u;d||h?u=a.Styles.createViewStyle({height:h&&d?Math.min(d,h):d,maxHeight:h},!1):(u=a.Styles.createViewStyle({maxHeight:this.props.maxHeight},!1),o.push(a.Styles.createViewStyle({maxWidth:this._removeBorderFromWidth(this.props.maxWidth)},!1))),n.push(u);const p=[];this.props.width||this.props.maxWidth?p.push(L.cardContainerFixedDimensions,a.Styles.createViewStyle({width:this._removeBorderFromWidth(this.props.width),maxWidth:this._removeBorderFromWidth(this.props.maxWidth)},!1)):p.push(L.cardContainerStyle);const g=l||t&&t.relativeWidth,m=h&&d?Math.min(d,h):d||h,f=t?this._renderElementsWithImage(e.body,t,m):this._renderElementsContainer(e.body,m),S=e.backgroundImage?(0,r.jsx)(y.default,{url:e.backgroundImage.url,mode:e.backgroundImage.mode,horizontalAlignment:e.backgroundImage.horizontalAlignment,verticalAlignment:e.backgroundImage.verticalAlignment,size:k.ImageSizes.stretch,displayStyle:y.ImageDisplayStyle.Background,eventEmitter:this.props.eventEmitter,hostConfig:this.state.mergedHostConfig,imagePrefetchingEnabled:this.props.imagePrefetchingEnabled,children:f}):f,v=S?(0,r.jsx)(a.View,{style:n,children:S}):void 0,C=s.isEmpty(e.actions)?void 0:this._renderActions(e.actions),T=(0,r.jsx)(a.View,{style:L.placeHolder});let E;if(this.state.showCardContent||o.push(a.Styles.createViewStyle({height:(h&&d?Math.min(d,h):d)||150,maxHeight:h},!1)),this.props.placeholderLoadingEnabled){const t=[this._animatedOpacityStyle].concat(p);E=(0,r.jsxs)(a.Animated.View,{style:t,onLayout:g?this._onLayout:void 0,children:[v,C]},this.getReactKey("card",e.body.length,e.actions?e.actions.length:0))}else E=(0,r.jsxs)(a.View,{style:p,onLayout:g?this._onLayout:void 0,children:[v,C]},this.getReactKey("card",e.body.length,e.actions?e.actions.length:0));return(0,r.jsxs)(a.View,{style:this.state.showCardContent?void 0:o,children:[this.state.showCardContent?void 0:T,E]})},this._onLayout=e=>{if(this.state.viewWidth!==e.width){const t=this._removeBorderFromWidth(e.width);this.isComponentMounted()&&!s.isUndefined(t)&&this.setState({viewWidth:t})}},this._onInputValueChanged=(e,t)=>{this.setState((i=>{const n=s.cloneDeep(i.inputsValue);return n[e]=t,{inputsValue:n}}))},this._onInputValidationPerformed=(e,t)=>{this.setState((i=>{const n=s.cloneDeep(i.inputsValidationPerformed);return n[e]=t,{inputsValidationPerformed:n}}))},this._onExecuteAction=(e,t)=>{if(this.props.onExecuteAction)switch(e.type){case k.ActionTypes.actionOpenUrl:{const t=e;return void this.props.onExecuteAction(t)}case k.ActionTypes.actionSubmit:{const t=e;if(s.some(this.state.inputsValidationPerformed,(e=>!e)))return;const i=s.mapValues(s.cloneDeep(this.state.inputsValue),(e=>"string"==typeof e?O.default.sanitizeString(e):e)),n="string"==typeof t.data?s.isEmpty(i)?t.data:i:s.merge(t.data,i);return this.props.onExecuteAction(s.merge(t,{data:n})),void(a.Popup.isDisplayed(N)&&a.Popup.dismiss(N))}case k.ActionTypes.actionShowCard:{if(this.state.mergedHostConfig.actions.showCard.actionMode===k.ShowActionModeTypes.popup){const i=e.card;if(t&&i){const e={getAnchor:()=>t,renderPopup:(e,t,n,s)=>i?(0,r.jsx)(R.default,{anchorPosition:e,anchorOffset:t,popupWidth:n,popupHeight:s,children:this._renderCard(i)}):null,dismissIfShown:!0};a.Popup.show(e,N)}}const i=e;return void this.props.onExecuteAction(i)}}},this._renderElements=(e,t,i)=>{const n=e.length,r=[];return s.each(e,((e,s)=>{const a=i&&i[e.type]||this._elementRenderers[e.type];if(!a)return;const o=a(e,s,n,t);if(!o)return;const l=e.type===k.ElementTypes.column;if(s>0&&e.spacing!==k.SpacingStyles.none){const t=this._renderSpacing(e,l,s);r.push(t)}r.push(o)})),r},this._renderContainerView=(e,t,i,n)=>(0,r.jsx)(p.default,{container:e,hostConfig:this.state.mergedHostConfig,eventEmitter:this.props.eventEmitter,parentContainerStyle:this.state.mergedHostConfig.container.default,renderElements:this._renderElements,onExecuteAction:this._onExecuteAction,availableHeight:n},this.getReactKey("container",t)),this._renderImageSetView=(e,t,i)=>(0,r.jsx)(v.default,{imageSet:e,hostConfig:this.state.mergedHostConfig,eventEmitter:this.props.eventEmitter,parentContainerStyle:this.state.mergedHostConfig.container.default,onExecuteAction:this._onExecuteAction,imagePrefetchingEnabled:this.props.imagePrefetchingEnabled},this.getReactKey("imageSet",t)),this._renderColumnSetView=(e,t,i,n)=>(0,r.jsx)(h.default,{columnSet:e,hostConfig:this.state.mergedHostConfig,eventEmitter:this.props.eventEmitter,parentContainerStyle:this.state.mergedHostConfig.container.default,renderElements:this._renderElements,onExecuteAction:this._onExecuteAction,availableHeight:n},this.getReactKey("columnSet",t)),this._renderFactSetView=(e,t,i)=>(0,r.jsx)(m.default,{factSet:e,hostConfig:this.state.mergedHostConfig,customTextStyles:this.props.customTextStyles,eventEmitter:this.props.eventEmitter,parentContainerStyle:this.state.mergedHostConfig.container.default},this.getReactKey("factSet",t)),this._renderImageView=(e,t,i,n)=>(0,r.jsx)(y.default,{url:e.url,style:e.style,selectAction:e.selectAction,size:e.size,altText:e.altText,horizontalAlignment:e.horizontalAlignment,displayStyle:y.ImageDisplayStyle.Normal,hostConfig:this.state.mergedHostConfig,eventEmitter:this.props.eventEmitter,parentContainerStyle:this.state.mergedHostConfig.container.default,onExecuteAction:this._onExecuteAction,imagePrefetchingEnabled:this.props.imagePrefetchingEnabled,availableHeight:n},this.getReactKey("image",t)),this._renderTextBlockView=(e,t,i,n)=>(0,r.jsx)(D.default,{textBlock:e,hostConfig:this.state.mergedHostConfig,customTextStyles:this.props.customTextStyles,customViewStyles:this.props.customViewStyles,eventEmitter:this.props.eventEmitter,parentContainerStyle:this.state.mergedHostConfig.container.default,onExecuteAction:this._onExecuteAction,availableHeight:n},this.getReactKey("textBlock",t)),this._renderInputTextView=(e,t,i)=>(0,r.jsx)(_.default,{inputText:e,hostConfig:this.state.mergedHostConfig,customTextStyles:this.props.customTextStyles,customViewStyles:this.props.customViewStyles,eventEmitter:this.props.eventEmitter,parentContainerStyle:this.state.mergedHostConfig.container.default,onExecuteAction:this._onExecuteAction,onInputValueChanged:this._onInputValueChanged,onInputValidationPerformed:this._onInputValidationPerformed},this.getReactKey("inputText",t)),this._renderInputNumberView=(e,t,i)=>(0,r.jsx)(E.default,{inputNumber:e,hostConfig:this.state.mergedHostConfig,customTextStyles:this.props.customTextStyles,customViewStyles:this.props.customViewStyles,eventEmitter:this.props.eventEmitter,parentContainerStyle:this.state.mergedHostConfig.container.default,onExecuteAction:this._onExecuteAction,onInputValueChanged:this._onInputValueChanged,onInputValidationPerformed:this._onInputValidationPerformed},this.getReactKey("inputNumber",t)),this._renderInputDateView=(e,t,i)=>(0,r.jsx)(T.default,{inputDate:e,hostConfig:this.state.mergedHostConfig,customTextStyles:this.props.customTextStyles,customViewStyles:this.props.customViewStyles,eventEmitter:this.props.eventEmitter,parentContainerStyle:this.state.mergedHostConfig.container.default,onExecuteAction:this._onExecuteAction,onInputValueChanged:this._onInputValueChanged,onInputValidationPerformed:this._onInputValidationPerformed},this.getReactKey("inputDate",t)),this._renderInputTimeView=(e,t,i)=>(0,r.jsx)(b.default,{inputTime:e,hostConfig:this.state.mergedHostConfig,customTextStyles:this.props.customTextStyles,customViewStyles:this.props.customViewStyles,eventEmitter:this.props.eventEmitter,parentContainerStyle:this.state.mergedHostConfig.container.default,onExecuteAction:this._onExecuteAction,onInputValueChanged:this._onInputValueChanged,onInputValidationPerformed:this._onInputValidationPerformed},this.getReactKey("inputTime",t)),this._renderInputToggleView=(e,t,i)=>(0,r.jsx)(P.default,{inputToggle:e,hostConfig:this.state.mergedHostConfig,customTextStyles:this.props.customTextStyles,customViewStyles:this.props.customViewStyles,eventEmitter:this.props.eventEmitter,localization:this.props.localization,parentContainerStyle:this.state.mergedHostConfig.container.default,onExecuteAction:this._onExecuteAction,onInputValueChanged:this._onInputValueChanged,onInputValidationPerformed:this._onInputValidationPerformed},this.getReactKey("inputToggle",t)),this._renderInputChoiceSetView=(e,t,i)=>(0,r.jsx)(C.default,{choiceSet:e,hostConfig:this.state.mergedHostConfig,customTextStyles:this.props.customTextStyles,customViewStyles:this.props.customViewStyles,customPickerStyles:this.props.customPickerStyles,pickerIcon:this.props.pickerIcon,eventEmitter:this.props.eventEmitter,localization:this.props.localization,parentContainerStyle:this.state.mergedHostConfig.container.default,onExecuteAction:this._onExecuteAction,onInputValueChanged:this._onInputValueChanged,onInputValidationPerformed:this._onInputValidationPerformed,onShowPickerChoices:this.props.onShowPickerChoices},this.getReactKey("inputChoiceSet",t))}componentDidMount(){super.componentDidMount();const e=this.props.placeholderLoadingTimeout||1e3;this.props.placeholderLoadingEnabled&&setTimeout((()=>{this.isComponentMounted()&&this.setState({showCardContent:!0}),this._animateCard()}),e)}_animateCard(){a.Animated.timing(this._animatedOpacityValue,{toValue:1,duration:232,easing:a.Animated.Easing.In()}).start()}_buildState(e,t){const i={},n=this.props;if(!t&&(0,I.default)(n.adaptiveCard,e.adaptiveCard)||(i.adaptiveCard=e.skipSanitization?s.cloneDeep(e.adaptiveCard):d.default.sanitizeAdaptiveCard(e.adaptiveCard),i.cardImage=this._extractCardImage(i.adaptiveCard)),e.imagePrefetchingEnabled&&(t||!(0,I.default)(n.eventEmitter,e.eventEmitter))){const t=l.default.getImages(i.adaptiveCard),n=s.map(t,(t=>e.eventEmitter&&e.eventEmitter.proxyImageUrl?e.eventEmitter.proxyImageUrl(t.url):t.url));w.default.initNoSubscription(s.compact(n))}if(t||!(0,I.default)(n.hostConfigs,e.hostConfigs)){const t=f.default.sanitizeHostConfig(e.hostConfigs);i.mergedHostConfig=S.default.mergeHostConfigs(t),this._paddingStyle=a.Styles.createViewStyle({paddingLeft:i.mergedHostConfig.adaptiveCard.padding.left,paddingRight:i.mergedHostConfig.adaptiveCard.padding.right,paddingTop:i.mergedHostConfig.adaptiveCard.padding.top,paddingBottom:i.mergedHostConfig.adaptiveCard.padding.bottom},!1),this._elementDefaultSeparations={[k.ElementTypeNames.column]:i.mergedHostConfig.column.separation,[k.ElementTypeNames.columnSet]:i.mergedHostConfig.columnSet.separation,[k.ElementTypeNames.container]:i.mergedHostConfig.container.separation,[k.ElementTypeNames.factSet]:void 0,[k.ElementTypeNames.image]:i.mergedHostConfig.image.separation,[k.ElementTypeNames.imageSet]:void 0,[k.ElementTypeNames.inputChoiceSet]:void 0,[k.ElementTypeNames.inputDate]:i.mergedHostConfig.dateInput.separation,[k.ElementTypeNames.inputNumber]:i.mergedHostConfig.numberInput.separation,[k.ElementTypeNames.inputText]:i.mergedHostConfig.textInput.separation,[k.ElementTypeNames.inputTime]:i.mergedHostConfig.timeInput.separation,[k.ElementTypeNames.inputToggle]:i.mergedHostConfig.toggleInput.separation,[k.ElementTypeNames.textBlock]:i.mergedHostConfig.textBlock.separation}}if(t){i.viewWidth=void 0,i.inputsValue={},i.inputsValidationPerformed={},i.showCardContent=!e.placeholderLoadingEnabled;const t=e.adaptiveCard["-ms-attribution"];t&&t.icon&&(i.attributionIcon=e.eventEmitter&&e.eventEmitter.proxyImageUrl?e.eventEmitter.proxyImageUrl(t.icon):t.icon),this._elementRenderers={[k.ElementTypeNames.columnSet]:this._renderColumnSetView,[k.ElementTypeNames.container]:this._renderContainerView,[k.ElementTypeNames.factSet]:this._renderFactSetView,[k.ElementTypeNames.image]:this._renderImageView,[k.ElementTypeNames.imageSet]:this._renderImageSetView,[k.ElementTypeNames.inputChoiceSet]:this._renderInputChoiceSetView,[k.ElementTypeNames.inputDate]:this._renderInputDateView,[k.ElementTypeNames.inputNumber]:this._renderInputNumberView,[k.ElementTypeNames.inputText]:this._renderInputTextView,[k.ElementTypeNames.inputTime]:this._renderInputTimeView,[k.ElementTypeNames.inputToggle]:this._renderInputToggleView,[k.ElementTypeNames.textBlock]:this._renderTextBlockView},e.environmentInfo&&g.default.initialize(e.environmentInfo)}return i}render(){return this.state.adaptiveCard?this._renderCard(this.state.adaptiveCard,this.state.cardImage):null}_getAttribution(){const e=this.props.adaptiveCard["-ms-attribution"];if(!e||!e.text)return;const t=this.state.mergedHostConfig.attribution.size?this.state.mergedHostConfig.fontSizes[this.state.mergedHostConfig.attribution.size]:this.state.mergedHostConfig.fontSizes.default,i=a.Styles.createTextStyle({fontSize:t,color:this.state.mergedHostConfig.attribution.color,backgroundColor:"#00000000",fontFamily:this.state.mergedHostConfig.fontFamily,alignSelf:"center"},!1),n=a.Styles.createImageStyle({height:16,width:16,marginRight:4},!1),s=e.icon?(0,r.jsx)(a.Image,{style:n,source:this.state.attributionIcon,title:e.text},"attributionIcon"):void 0;return(0,r.jsxs)(a.View,{style:L.attributionContainer,children:[s,(0,r.jsx)(a.Text,{numberOfLines:1,importantForAccessibility:a.Types.ImportantForAccessibility.NoHideDescendants,style:i,children:e.text})]})}_removeBorderFromWidth(e){return e?e-2*this.state.mergedHostConfig.adaptiveCard.borderWidth:e}_renderElementsContainer(e,t){if(s.isEmpty(e))return;const i=this.props.adaptiveCard["-ms-attribution"],n=t?Math.max(t-this.state.mergedHostConfig.adaptiveCard.padding.bottom-2*this.state.mergedHostConfig.adaptiveCard.borderWidth-(i&&i.text?28:0),0):void 0,o=n?a.Styles.createViewStyle({maxHeight:n},!1):void 0;return(0,r.jsxs)(a.View,{style:[L.elementsContainer,this._paddingStyle],children:[(0,r.jsx)(a.View,{style:o,children:this._renderElements(e,n)},"elementsContainer"),this._getAttribution()]})}_renderElementsWithImage(e,t,i){const n=this._renderElementsContainer(e,i),s=t.placement===x.Right||t.placement===x.Bottom,o=t.placement===x.Top||t.placement===x.Bottom,l=t.image["-ms-width"],d=this.state.viewWidth&&t.relativeWidth?this.state.viewWidth*t.relativeWidth:void 0,c=o?L.cardHeroImage:a.Styles.createViewStyle({flex:l||d?void 0:1,width:l||d},!1),h=o?L.cardContainerStyle:L.cardContainerSideImage,u=o?y.ImageDisplayStyle.BackgroundExpanded:y.ImageDisplayStyle.Background;return(0,r.jsxs)(a.View,{style:h,children:[s?n:void 0,(0,r.jsx)(a.View,{style:c,children:(0,r.jsx)(y.default,{url:t.image.url,mode:t.image.mode,horizontalAlignment:t.image.horizontalAlignment,verticalAlignment:t.image.verticalAlignment,size:k.ImageSizes.stretch,displayStyle:u,eventEmitter:this.props.eventEmitter,hostConfig:this.state.mergedHostConfig,aspectRatio:O.default.stringToAspectRatio(t.image["-ms-aspectRatio"]),customWidth:l,customHeight:t.image["-ms-height"],borderRadiusStyle:this._getFullbleedImageBordering(t.placement),imagePrefetchingEnabled:this.props.imagePrefetchingEnabled})}),s?void 0:n]})}_getFullbleedImageBordering(e){if(!this.props.customViewStyles||!this.props.customViewStyles.card)return;const t=this.props.customViewStyles.card,i=t.borderTopLeftRadius,n=t.borderTopRightRadius,r=t.borderBottomLeftRadius,s=t.borderBottomRightRadius;return e===x.Stretch&&(i||n||r||s)?a.Styles.createViewStyle({borderTopLeftRadius:i,borderTopRightRadius:n,borderBottomLeftRadius:r,borderBottomRightRadius:s},!1):e===x.Top&&(i||n)?a.Styles.createViewStyle({borderTopLeftRadius:i,borderTopRightRadius:n},!1):e===x.Bottom&&(r||s)?a.Styles.createViewStyle({borderBottomLeftRadius:r,borderBottomRightRadius:s},!1):e===x.Left&&(i||r)?a.Styles.createViewStyle({borderTopLeftRadius:i,borderBottomLeftRadius:r},!1):e===x.Right&&(n||s)?a.Styles.createViewStyle({borderTopRightRadius:n,borderBottomRightRadius:s},!1):void 0}_renderActions(e){return(0,r.jsx)(o.default,{customButtonStyles:this.props.customButtonStyles,customTextStyles:this.props.customTextStyles,customViewStyles:this.props.customViewStyles,parentContainerStyle:this.state.mergedHostConfig.container.default,actions:e,hostConfig:this.state.mergedHostConfig,onExecuteAction:this._onExecuteAction,renderCard:this._renderCard})}_renderSpacing(e,t,i){const n=e.spacing?this.state.mergedHostConfig.spacing[e.spacing]:this._getElementDefaultSpacing(e);return(0,r.jsx)(M.default,{spacingAmount:n,isVertical:t},this.getReactKey("spacing",i))}_getElementDefaultSpacing(e){const t=this._elementDefaultSeparations[e.type];return t?t.spacing:this.state.mergedHostConfig.spacing[k.SpacingStyles.default]}_extractColumnBackgroundImage(e,t){if(t&&t.backgroundImage&&t.backgroundImage.mode===k.BackgroundImageModes.stretch&&s.isEmpty(t.items))return s.remove(e.columns,(e=>e===t)),t.backgroundImage}_extractContainerBackgroundImage(e,t){if(t&&t.backgroundImage&&t.backgroundImage.mode===k.BackgroundImageModes.stretch&&s.isEmpty(t.items))return s.remove(e,(e=>e===t)),t.backgroundImage}_calculateColumnRelativeWidth(e,t){const i=h.default.calculateTotalFlex(e.columns);return u.default.calculateRelativeWidth(t,i)}_extractCardImage(e){if(!e||s.isEmpty(e.body))return;const t=s.first(e.body),i=s.last(e.body);if(t.type===k.ElementTypes.columnSet){const e=t;let i=s.first(e.columns),n=this._calculateColumnRelativeWidth(e,i),r=this._extractColumnBackgroundImage(e,i);return r?{image:r,placement:x.Left,relativeWidth:n}:(i=s.last(e.columns),n=this._calculateColumnRelativeWidth(e,i),r=this._extractColumnBackgroundImage(e,i),r?{image:r,placement:x.Right,relativeWidth:n}:void 0)}if(t.type===k.ElementTypes.container&&t===i){const i=t,n=this._extractContainerBackgroundImage(e.body,i);if(n)return{image:n,placement:x.Stretch}}if(t.type===k.ElementTypes.container){const i=t,n=this._extractContainerBackgroundImage(e.body,i);if(n)return{image:n,placement:x.Top}}if(i.type===k.ElementTypes.container){const t=i,n=this._extractContainerBackgroundImage(e.body,t);if(n)return{image:n,placement:x.Bottom}}}}t.AdaptiveCardView=F,t.default=F},127850:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseInputChoiceView=void 0;const n=i(197582),r=i(785893),s=n.__importStar(i(516778)),a=i(12805),o=i(26703),l=n.__importDefault(i(581911)),d=(0,o.lazyProperties)({containerStyle:()=>s.Styles.createViewStyle({alignItems:"flex-start"}),buttonStyle:()=>s.Styles.createViewStyle({flexDirection:"row",alignItems:"center",cursor:"pointer"})});class c extends a.BaseInputView{constructor(){super(...arguments),this._onPress=e=>{this.onPress(e)}}render(){return this.createStyles(),(0,r.jsx)(s.View,{style:d.containerStyle,children:(0,r.jsxs)(s.Button,{accessibilityLabel:this._getAccessibilityLabel(this.isSelected),accessibilityTraits:s.Types.AccessibilityTrait.None,style:d.buttonStyle,onPress:this._onPress,tabIndex:0,children:[(0,r.jsx)(s.View,{style:this._choiceViewStyles,children:this.isSelected?this._getSelectedView():void 0}),(0,r.jsx)(s.Text,{style:this._titleStyles,children:this.title})]})})}createStyles(){this._choiceViewStyles=[s.Styles.createViewStyle({width:this.fontSize,height:this.fontSize,borderRadius:this.borderRadius,borderWidth:1,borderColor:"#000000",alignItems:"center",justifyContent:"center"},!1),this.customChoiceStyles],this._titleStyles=[s.Styles.createTextStyle({fontFamily:this.props.hostConfig.fontFamily,fontSize:this.fontSize,fontWeight:this.props.hostConfig.fontWeights.default,marginLeft:this.fontSize/4},!1),this.customTitleStyles]}_getAccessibilityLabel(e){let t;return this.props.localization&&(t=e?this.props.localization.inputChoiceSelectedAccessibilityLabel:this.props.localization.inputChoiceUnselectedAccessibilityLabel),l.default.inputChoiceAccessibilityLabel(e,this.title,t)}_getSelectedView(){return this._selectedView||(this._selectedView=this.buildSelectedView()),this._selectedView}}t.BaseInputChoiceView=c,t.default=c},12805:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseInputView=void 0;const n=i(438278);class r extends n.ElementBaseView{handleInputValueChanged(e){this.props.onInputValueChanged(this.inputId,e)}handleInputValidationResult(e){this.props.onInputValidationPerformed&&this.props.onInputValidationPerformed(this.inputId,e)}}t.BaseInputView=r,t.default=r},438278:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ElementBaseView=t.AdaptiveCardBaseView=t.CustomStyleNames=void 0;const n=i(197582).__importStar(i(516778)),r=i(217041),s=i(26703),a=i(471968),o=(0,s.lazyProperties)({actionCursor:()=>n.Styles.createTextStyle({cursor:"pointer"})});var l;!function(e){e.card="card",e.cardWithActions="card.withActions",e.action="action",e.actionFirst="action.first",e.actionMiddle="action.middle",e.actionLast="action.last",e.actionFirstHorizontal="action.firstHorizontal",e.actionLastHorizontal="action.lastHorizontal",e.actionSingle="action.single",e.actionHover="action.hover",e.actionExpandable="action.expandable",e.actionExpanded="action.expanded",e.actionSubdued="action.subdued",e.textDefault="textBlock.default",e.textBolder="textBlock.bolder",e.textLigher="textBlock.lighter",e.textItalic="textBlock.italic",e.textLink="textBlock.link",e.input="input",e.inputText="inputText",e.inputTextMultiline="inputText.multiline",e.inputTime="inputTime",e.inputDate="inputDate",e.inputNumber="inputNumber",e.inputChoice="inputChoice",e.inputTitle="inputTitle",e.inputValidationFailed="inputValidationFailed",e.inputTitleSelected="inputTitleSelected",e.inputRadioButtonSelected="inputRadioButtonSelected",e.inputRadioButtonUnselected="inputRadioButtonUnselected",e.inputToggleSelected="inputToggleSelected",e.inputToggleSelectedAnimated="inputToggleSelectedAnimated",e.inputToggleUnselected="inputToggleUnselected",e.inputPicker="inputPicker",e.inputPickerItems="inputPickerItems",e.inputPickerItem="inputPickerItem",e.inputPickerItemHovering="inputPickerItemHovering",e.inputPickerItemSelected="inputPickerItemSelected"}(l||(t.CustomStyleNames=l={}));class d extends r.ComponentBase{getReactKey(e,...t){return e+"-"+t.join("-")}}t.AdaptiveCardBaseView=d;t.ElementBaseView=class extends d{constructor(){super(...arguments),this.onActionLongPress=e=>{if(this.isActionable&&this.selectAction&&this.props.onExecuteAction){e.stopPropagation();const t=this.selectAction.type===a.ActionTypes.actionOpenUrl?Object.assign(Object.assign({},this.selectAction),{preview:!0}):this.selectAction;this.props.onExecuteAction(t)}},this.onActionPress=e=>{this.isActionable&&this.selectAction&&this.props.onExecuteAction&&(e.stopPropagation(),this.props.onExecuteAction(this.selectAction))},this.onActionKeyPress=e=>{this.isActionable&&this.selectAction&&this.props.onExecuteAction&&("Enter"===e.key||" "===e.key)&&(e.stopPropagation(),this.props.onExecuteAction(this.selectAction))}}get isActionable(){return!!this.selectAction&&!!this.props.onExecuteAction}get selectAction(){}get actionCursorStyle(){return this.isActionable?o.actionCursor:void 0}get actionLongPress(){return this.isActionable?this.onActionLongPress:void 0}get actionPress(){return this.isActionable?this.onActionPress:void 0}get actionKeyPress(){return this.isActionable?this.onActionKeyPress:void 0}get actionAccessibilityLabel(){return this.isActionable&&this.selectAction?this.selectAction.title:void 0}get actionAccessibilityTraits(){return this.isActionable?[n.Types.AccessibilityTrait.Button]:void 0}get actionImportantForAccessibility(){return this.isActionable?n.Types.ImportantForAccessibility.Yes:n.Types.ImportantForAccessibility.Auto}get actionTabIndex(){return this.isActionable?0:void 0}get actionTitle(){return this.isActionable&&this.selectAction&&this.selectAction.type===a.ActionTypes.actionOpenUrl?this.selectAction.url:void 0}},t.default=d},486610:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=n.__importStar(i(496486)),a=n.__importStar(i(516778)),o=i(438278),l=n.__importDefault(i(69282)),d=i(26703),c=n.__importDefault(i(982880)),h=n.__importStar(i(471968)),u=(0,d.lazyProperties)({containerNormal:()=>a.Styles.createViewStyle({alignItems:"stretch",flexDirection:"column"}),containerStretched:()=>a.Styles.createViewStyle({flex:1,alignItems:"stretch",flexDirection:"column"}),columnSetView:()=>a.Styles.createViewStyle({flex:1,flexDirection:"row",alignItems:"stretch",justifyContent:"flex-start"})});class p extends o.ElementBaseView{constructor(){super(...arguments),this._onContainerLayout=e=>{this.setState({height:e.height,relativeYPosition:e.y})},this._onLayout=e=>{const t=s.reduce(this.props.columnSet.columns,((e,t,i)=>{if(!t||0===i)return e;return e-(t.spacing?this.props.hostConfig.spacing[t.spacing]:this.props.hostConfig.spacing.default)}),e.width);this.state.availableWidth!==t&&this.setState({availableWidth:t})},this._renderColumnView=(e,t,i,n)=>(0,r.jsx)(l.default,{column:e,columnSetTotalFlex:this._totalFlex,columnSetAvailableWidth:this.state.availableWidth,hostConfig:this.props.hostConfig,eventEmitter:this.props.eventEmitter,parentContainerStyle:this.props.hostConfig.container.default,renderElements:this.props.renderElements,onExecuteAction:this.props.onExecuteAction,availableHeight:n},this.getReactKey("column",t,i,this.state.availableWidth||0))}_buildState(e,t){const i={};return t&&(i.availableWidth=void 0,i.height=void 0,i.relativeYPosition=void 0),this._totalFlex=p.calculateTotalFlex(e.columnSet.columns),this._hasFixedWidthColumns=s.some(e.columnSet.columns,(e=>e.width!==h.ColumnWidths.auto&&e.width!==h.ColumnWidths.stretch)),i}get selectAction(){return this.props.columnSet.selectAction}render(){const e=c.default.getAvailableHeight(this.state.height,this.state.relativeYPosition,this.props.availableHeight),t=this.props.renderElements(this.props.columnSet.columns,e,{[h.ElementTypes.column]:this._renderColumnView}),i=this.props.columnSet.height===h.ContainerHeights.stretch?u.containerStretched:u.containerNormal;return(0,r.jsx)(a.View,{style:i,onLayout:this._onContainerLayout,children:(0,r.jsx)(a.View,{style:[u.columnSetView,this.actionCursorStyle],onLayout:this._hasFixedWidthColumns?this._onLayout:void 0,onLongPress:this.actionLongPress,onPress:this.actionPress,onKeyPress:this.actionKeyPress,accessibilityLabel:this.actionAccessibilityLabel,accessibilityTraits:this.actionAccessibilityTraits,importantForAccessibility:this.actionImportantForAccessibility,tabIndex:this.actionTabIndex,title:this.actionTitle,children:t})})}static calculateTotalFlex(e){return s.reduce(e,((e,t)=>{const i="string"==typeof t.width&&parseInt(t.width,10);return i&&!isNaN(i)?e+i:e}),0)}}t.default=p},69282:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=n.__importStar(i(496486)),a=n.__importStar(i(516778)),o=i(438278),l=n.__importStar(i(251577)),d=n.__importDefault(i(982880)),c=n.__importDefault(i(581911)),h=n.__importStar(i(471968));var u;!function(e){e.flexStart="flex-start",e.flexEnd="flex-end",e.center="center"}(u||(u={}));class p extends o.ElementBaseView{constructor(){super(...arguments),this._onLayout=e=>{this.setState({height:e.height,relativeYPosition:e.y})}}_buildState(e,t){const i=this._getFlexStyle(e.column);return this._containerStyle=a.Styles.createViewStyle({flexGrow:i.flexGrow,flexShrink:i.flexShrink,flexBasis:i.flexBasis,flexDirection:"column",flexWrap:"nowrap",alignItems:"stretch",justifyContent:e.column.verticalContentAlignment?p._alignmentMap[e.column.verticalContentAlignment]:u.flexStart,backgroundColor:"rgba(0, 0, 0, 0)",overflow:"hidden"},!1),{}}get selectAction(){return this.props.column.selectAction}render(){const e=d.default.getAvailableHeight(this.state.height,this.state.relativeYPosition,this.props.availableHeight),t=this.props.renderElements(this.props.column.items,e),i=(0,r.jsx)(a.View,{style:[this._containerStyle,this.actionCursorStyle],onLongPress:this.actionLongPress,onPress:this.actionPress,onKeyPress:this.actionKeyPress,accessibilityLabel:this.actionAccessibilityLabel,accessibilityTraits:this.actionAccessibilityTraits,importantForAccessibility:this.actionImportantForAccessibility,tabIndex:this.actionTabIndex,title:this.actionTitle,onLayout:this._onLayout,children:t});return this.props.column.backgroundImage?(0,r.jsx)(l.default,{url:this.props.column.backgroundImage.url,mode:this.props.column.backgroundImage.mode,horizontalAlignment:this.props.column.backgroundImage.horizontalAlignment,verticalAlignment:this.props.column.backgroundImage.verticalAlignment,size:h.ImageSizes.stretch,displayStyle:l.ImageDisplayStyle.Background,hostConfig:this.props.hostConfig,eventEmitter:this.props.eventEmitter,customWidth:this.props.column.backgroundImage["-ms-width"],customHeight:this.props.column.backgroundImage["-ms-height"],aspectRatio:c.default.stringToAspectRatio(this.props.column.backgroundImage["-ms-aspectRatio"]),children:i}):i}static calculateRelativeWidth(e,t){const i="string"==typeof e.width?parseInt(e.width,10):void 0;return i&&!s.isNaN(i)?i/(t||100):0}_getFlexStyle(e){if(e.pixelWidth)return{flexGrow:0,flexShrink:0,flexBasis:e.pixelWidth};if(e.width===h.ColumnWidths.auto)return{flexGrow:0,flexShrink:1};if(e.width===h.ColumnWidths.stretch)return{flexGrow:1,flexShrink:1};const t=p.calculateRelativeWidth(e,this.props.columnSetTotalFlex);return t?{flexGrow:0,flexShrink:1,flexBasis:this.props.columnSetAvailableWidth?this.props.columnSetAvailableWidth*t:void 0}:{flexGrow:1,flexShrink:1}}}p._alignmentMap={[h.VerticalAlignments.top]:u.flexStart,[h.VerticalAlignments.bottom]:u.flexEnd,[h.VerticalAlignments.center]:u.center},t.default=p},554775:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=n.__importStar(i(496486)),a=n.__importStar(i(516778)),o=i(438278),l=n.__importStar(i(251577)),d=i(26703),c=n.__importDefault(i(982880)),h=n.__importDefault(i(581911)),u=n.__importStar(i(471968)),p=(0,d.lazyProperties)({containerStyleNormal:()=>a.Styles.createViewStyle({flexDirection:"column"}),containerStyleStretched:()=>a.Styles.createViewStyle({flex:1,flexDirection:"column"})});class g extends o.ElementBaseView{constructor(){super(...arguments),this._onLayout=e=>{this.setState({height:e.height,relativeYPosition:e.y})}}get selectAction(){return this.props.container.selectAction}render(){const e=c.default.getAvailableHeight(this.state.height,this.state.relativeYPosition,this.props.availableHeight),t=this.props.renderElements(this.props.container.items,e),i=s.isEmpty(t)&&this.props.container.backgroundImage?l.ImageDisplayStyle.BackgroundExpanded:l.ImageDisplayStyle.Background,n=this.props.container.backgroundImage?(0,r.jsx)(l.default,{url:this.props.container.backgroundImage.url,mode:this.props.container.backgroundImage.mode,horizontalAlignment:this.props.container.backgroundImage.horizontalAlignment,verticalAlignment:this.props.container.backgroundImage.verticalAlignment,size:u.ImageSizes.stretch,displayStyle:i,hostConfig:this.props.hostConfig,eventEmitter:this.props.eventEmitter,aspectRatio:h.default.stringToAspectRatio(this.props.container.backgroundImage["-ms-aspectRatio"]),customWidth:this.props.container.backgroundImage["-ms-width"],customHeight:this.props.container.backgroundImage["-ms-height"],children:t}):t,o=this.props.container.height===u.ContainerHeights.stretch?p.containerStyleStretched:p.containerStyleNormal;return(0,r.jsx)(a.View,{style:[o,this.actionCursorStyle],onLongPress:this.actionLongPress,onPress:this.actionPress,onKeyPress:this.actionKeyPress,accessibilityLabel:this.actionAccessibilityLabel,accessibilityTraits:this.actionAccessibilityTraits,importantForAccessibility:this.actionImportantForAccessibility,tabIndex:this.actionTabIndex,title:this.actionTitle,onLayout:this._onLayout,children:n})}}t.default=g},753938:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=n.__importStar(i(496486)),a=n.__importStar(i(516778)),o=i(438278),l=i(26703),d=n.__importDefault(i(549187)),c=n.__importDefault(i(954567)),h=n.__importStar(i(471968)),u=(0,l.lazyProperties)({containerStyle:()=>a.Styles.createViewStyle({flex:1,flexDirection:"row"}),factTextContainer:()=>a.Styles.createViewStyle({flexDirection:"column",justifyContent:"flex-start"})});class p extends o.ElementBaseView{constructor(){super(...arguments),this._onLayout=e=>{this.setState({height:e.height})}}render(){const e=this._renderFactTitles(),t=this._renderFactValues();return(0,r.jsxs)(a.View,{style:u.containerStyle,onLayout:this._onLayout,children:[(0,r.jsx)(a.View,{style:u.factTextContainer,children:e},this.getReactKey("factTitles")),(0,r.jsx)(d.default,{spacingAmount:this.props.hostConfig.factSet.spacing,isVertical:!0}),(0,r.jsx)(a.View,{style:u.factTextContainer,children:t},this.getReactKey("factValues"))]})}_renderFactTitles(){const e=[],t=this.props.hostConfig.factSet.separation.spacing;return s.each(this.props.factSet.facts,((i,n)=>{if(!i)return;const s={type:h.ElementTypes.textBlock,text:i.title,size:this.props.hostConfig.factSet.title.size,color:this.props.hostConfig.factSet.title.color,isSubtle:this.props.hostConfig.factSet.title.isSubtle,weight:this.props.hostConfig.factSet.title.weight,wrap:this.props.hostConfig.factSet.title.wrap,spacing:h.SpacingStyles.none};n>0&&t&&e.push((0,r.jsx)(d.default,{spacingAmount:t},this.getReactKey("spacing",n))),e.push((0,r.jsx)(c.default,{textBlock:s,hostConfig:this.props.hostConfig,customTextStyles:this.props.customTextStyles,parentContainerStyle:this.props.parentContainerStyle,availableHeight:this.state.height},this.getReactKey("factTitle",n)))})),e}_renderFactValues(){const e=[],t=this.props.hostConfig.factSet.separation.spacing;return s.each(this.props.factSet.facts,((i,n)=>{if(!i)return;const s={type:h.ElementTypes.textBlock,text:i.value,size:this.props.hostConfig.factSet.value.size,color:this.props.hostConfig.factSet.value.color,isSubtle:this.props.hostConfig.factSet.value.isSubtle,weight:this.props.hostConfig.factSet.value.weight,wrap:this.props.hostConfig.factSet.value.wrap,spacing:h.SpacingStyles.none};n>0&&t&&e.push((0,r.jsx)(d.default,{spacingAmount:t},this.getReactKey("spacing",n))),e.push((0,r.jsx)(c.default,{textBlock:s,hostConfig:this.props.hostConfig,customTextStyles:this.props.customTextStyles,parentContainerStyle:this.props.parentContainerStyle,availableHeight:this.state.height},this.getReactKey("factValue",n)))})),e}}t.default=p},789567:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=n.__importStar(i(496486)),a=n.__importStar(i(516778)),o=i(438278),l=n.__importStar(i(251577)),d=i(26703),c=n.__importDefault(i(549187)),h=(0,d.lazyProperties)({containerStyle:()=>a.Styles.createViewStyle({flex:1,flexDirection:"row",justifyContent:"center",flexWrap:"wrap"})});class u extends o.ElementBaseView{render(){const e=[],t=this.props.hostConfig.imageSet.separation?this.props.hostConfig.imageSet.separation.spacing:0;return s.each(this.props.imageSet.images,((i,n)=>{i&&(n>0&&t&&e.push((0,r.jsx)(c.default,{spacingAmount:t,isVertical:!0},this.getReactKey("spacing",n))),i.size=this.props.imageSet.imageSize||this.props.hostConfig.imageSet.imageSize,e.push((0,r.jsx)(l.default,{url:i.url,style:i.style,selectAction:i.selectAction,size:i.size,altText:i.altText,horizontalAlignment:i.horizontalAlignment,displayStyle:l.ImageDisplayStyle.Normal,hostConfig:this.props.hostConfig,customButtonStyles:this.props.customButtonStyles,customTextStyles:this.props.customTextStyles,customViewStyles:this.props.customViewStyles,customPickerStyles:this.props.customPickerStyles,eventEmitter:this.props.eventEmitter,parentContainerStyle:this.props.parentContainerStyle,onExecuteAction:this.props.onExecuteAction,imagePrefetchingEnabled:this.props.imagePrefetchingEnabled},this.getReactKey("image",n))))})),(0,r.jsx)(a.View,{style:h.containerStyle,children:e})}}t.default=u},251577:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ImageDisplayStyle=void 0;const n=i(197582),r=i(785893),s=n.__importStar(i(496486)),a=n.__importStar(i(516778)),o=i(438278),l=n.__importDefault(i(114818)),d=i(26703),c=i(880163),h=n.__importDefault(i(982880)),u=n.__importStar(i(471968)),p=(0,d.lazyProperties)({actionContainer:()=>a.Styles.createViewStyle({flex:1}),imageBackground:()=>a.Styles.createImageStyle({overflow:"hidden",position:"absolute",top:0,bottom:0,left:0,right:0}),imageErrorAlignment:()=>a.Styles.createViewStyle({alignItems:"center",justifyContent:"center"}),imageErrorText:()=>a.Styles.createTextStyle({flex:0,flexDirection:"row",textAlign:"center",color:"#333333"})}),g="flex-start",m="flex-end",f="center",S="stretch";var v;!function(e){e[e.Normal=0]="Normal",e[e.Background=1]="Background",e[e.BackgroundExpanded=2]="BackgroundExpanded"}(v||(t.ImageDisplayStyle=v={}));class y extends o.ElementBaseView{constructor(){super(...arguments),this._onLayout=e=>{const t=this.props.size||this.props.hostConfig.image.imageSize||u.ImageSizes.auto;!(t!==u.ImageSizes.stretch&&t!==u.ImageSizes.auto||this.props.customWidth&&this.props.customHeight)&&!this.state.viewWidth&&this.setState({viewWidth:e.width}),e.height!==this.state.viewHeight&&this.setState({viewHeight:e.height,yPosition:e.y})},this._onLoad=e=>{this.setState({imageWidth:e.width,imageHeight:e.height})},this._onError=e=>{this.state.imageUrl&&this.setState({isError:!0})}}_buildState(e,t){const i={},n=this.props;return!t&&(0,l.default)(n.eventEmitter,e.eventEmitter)&&n.url===e.url||(i.imageUrl=e.eventEmitter&&e.eventEmitter.proxyImageUrl?e.eventEmitter.proxyImageUrl(e.url):e.url),i}get selectAction(){return this.props.selectAction}render(){const e=this._isStaticBackground(),t=this.props.size||this.props.hostConfig.image.imageSize||u.ImageSizes.auto,i=h.default.getAvailableHeight(this.state.viewHeight,0,this.props.availableHeight);if(!s.isUndefined(i)&&!s.isUndefined(this.state.viewHeight)&&i<this.state.viewHeight)return null;const n=a.Styles.createViewStyle({flex:e?1:-1,justifyContent:"flex-start",alignItems:y._getImageAlignment(this.props.horizontalAlignment,t),backgroundColor:"rgba(0, 0, 0, 0)"},!1),o=[];if(this.props.borderRadiusStyle&&o.push(this.props.borderRadiusStyle),e)o.push(p.imageBackground);else{const e=this._getDimensions(t);this.props.style===u.ImageStyles.person&&o.push(a.Styles.createImageStyle({borderRadius:e.width/2},!1)),o.push(a.Styles.createImageStyle({overflow:"hidden",width:e.width,height:e.height},!1))}let l=this.state.imageUrl?(0,r.jsx)(a.Image,{resizeMode:this._getImageResizeMode(),style:a.Styles.combine(o),source:this.state.imageUrl,title:this.props.altText,onLoad:this._onLoad,onError:this._onError,children:e?void 0:this.props.children},this.getReactKey("imageView",this.state.imageUrl)):void 0;return this.props.imagePrefetchingEnabled&&(l=this.state.imageUrl?(0,r.jsx)(c.PrefetchedImage,{altView:()=>this._getImageLoadingView(o),errorView:()=>this._getImageErrorView(o),resizeMode:this._getImageResizeMode(),style:a.Styles.combine(o),source:this.state.imageUrl,title:this.props.altText,onLoad:this._onLoad,onError:this._onError,children:e?void 0:this.props.children},this.getReactKey("prefetchedImageView",this.state.imageUrl)):void 0),(0,r.jsx)(a.View,{style:n,onLayout:this._onLayout,children:(0,r.jsxs)(a.View,{style:[p.actionContainer,this.actionCursorStyle],onLongPress:this.actionLongPress,onPress:this.actionPress,onKeyPress:this.actionKeyPress,accessibilityLabel:this.isActionable&&this.selectAction?this.props.altText?this.props.altText:this.selectAction.title:void 0,accessibilityTraits:this.actionAccessibilityTraits,importantForAccessibility:this.actionImportantForAccessibility,tabIndex:this.actionTabIndex,title:this.actionTitle,children:[this.state.isError?this._getImageErrorView(o):l,e||!l?this.props.children:null]})})}_getImageErrorView(e){const t=(0,r.jsx)(a.Text,{style:p.imageErrorText,children:""}),i=this.props.eventEmitter&&this.props.eventEmitter.imageLoadErrorView?this.props.eventEmitter.imageLoadErrorView():t;return(0,r.jsx)(a.View,{style:[e,p.imageErrorAlignment],children:i})}_getImageLoadingView(e){return(0,r.jsx)(a.View,{style:e})}_isStaticBackground(){return this.props.displayStyle===v.Background&&!this.props.aspectRatio&&!this.props.customWidth&&!this.props.customHeight}_getDimensions(e){if(e!==u.ImageSizes.stretch&&e!==u.ImageSizes.auto){let t=0;switch(e){case u.ImageSizes.small:t=this.props.hostConfig.imageSizes.small;break;case u.ImageSizes.medium:t=this.props.hostConfig.imageSizes.medium;break;case u.ImageSizes.large:t=this.props.hostConfig.imageSizes.large;break;default:t=this.props.hostConfig.imageSizes.medium}return{width:t,height:t}}if((this.props.customWidth||this.props.customHeight)&&!this.props.aspectRatio)return{width:this.props.customWidth||this.props.customHeight,height:this.props.customHeight||this.props.customWidth};const t=this.props.customWidth||this.state.viewWidth;if(this.props.aspectRatio&&t)return{width:t,height:Math.floor(t/this.props.aspectRatio)};if(!this.state.imageWidth||!this.state.imageHeight||!this.state.viewWidth)return{width:1,height:1};const i=this.state.imageHeight/this.state.imageWidth;return{height:Math.floor(this.state.viewWidth*i),width:this.state.viewWidth}}_getImageResizeMode(){if(this.props.displayStyle===v.Normal)return"contain";switch(this.props.mode){case u.BackgroundImageModes.repeat:case u.BackgroundImageModes.repeatHorizontally:case u.BackgroundImageModes.repeatVertically:return"repeat";default:return"cover"}}static _getImageAlignment(e,t){return t===u.ImageSizes.stretch?S:e&&y._alignmentMap[e]||f}}y._alignmentMap={[u.HorizontalAlignments.left]:g,[u.HorizontalAlignments.right]:m,[u.HorizontalAlignments.center]:f},t.default=y},701875:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=n.__importStar(i(496486)),a=n.__importStar(i(516778)),o=i(12805),l=n.__importDefault(i(196107)),d=n.__importDefault(i(632334)),c=n.__importDefault(i(960912)),h=n.__importDefault(i(549187)),u=i(471968),p={containerStyle:a.Styles.createViewStyle({flex:1})};class g extends o.BaseInputView{constructor(){super(...arguments),this._onRadioButtonPress=(e,t)=>{this.setState({selectedValue:t}),this.handleInputValueChanged(t)},this._onPickerChanged=(e,t)=>{s.some(this.props.choiceSet.choices,(e=>e.value===t))&&(this.setState({selectedValue:t}),this.handleInputValueChanged(t))}}_buildState(e,t){const i={selectedValue:e.choiceSet.value||""};return this._selectedMultiChoices=e.choiceSet.choices.map((t=>!!e.choiceSet.value&&e.choiceSet.value.split(",").indexOf(t.value)>-1)),i}get inputId(){return this.props.choiceSet.id}componentDidMount(){super.componentDidMount(),this.handleInputValueChanged(this.state.selectedValue)}render(){let e;return e=this.props.choiceSet.isMultiSelect?this._renderMultiSelect():"expandedToggle"===this.props.choiceSet.style?this._renderSingleChoiceToggle():"expanded"!==this.props.choiceSet.style?this._renderPicker():this._renderRadioButton(),(0,r.jsx)(a.View,{style:p.containerStyle,children:e})}_renderPicker(){const e=s.findIndex(this.props.choiceSet.choices,(e=>this.state.selectedValue===e.value)),t=e>-1?this.props.choiceSet.choices[e]:{title:"",value:this.state.selectedValue};return(0,r.jsx)(l.default,{choiceSet:this.props.choiceSet,customButtonStyles:this.props.customButtonStyles,customPickerStyles:this.props.customPickerStyles,customTextStyles:this.props.customTextStyles,customViewStyles:this.props.customViewStyles,pickerIcon:this.props.pickerIcon,localization:this.props.localization,eventEmitter:this.props.eventEmitter,hostConfig:this.props.hostConfig,onExecuteAction:this.props.onExecuteAction,onInputValueChanged:this._onPickerChanged,onInputValidationPerformed:this.props.onInputValidationPerformed,onShowPickerChoices:this.props.onShowPickerChoices,selectedChoice:t},this.getReactKey("inputChoiceSetPicker"))}_renderRadioButton(){const e=[],t=this.props.hostConfig.choiceSet.separation.spacing;return s.each(this.props.choiceSet.choices,((i,n)=>{n>0&&t&&e.push((0,r.jsx)(h.default,{spacingAmount:t},this.getReactKey("spacing",n))),e.push((0,r.jsx)(d.default,{inputId:this.getReactKey("radioButtonInput",n,i.title,i.value),hostConfig:this.props.hostConfig,customViewStyles:this.props.customViewStyles,customTextStyles:this.props.customTextStyles,localization:this.props.localization,isSelected:this.state.selectedValue===i.value,title:i.title,value:i.value,onInputValueChanged:this._onRadioButtonPress},this.getReactKey("radioButton",n,i.title,i.value)))})),e}_renderSingleChoiceToggle(){const e=[],t=this.props.hostConfig.choiceSet.separation.spacing;return s.each(this.props.choiceSet.choices,((i,n)=>{n>0&&t&&e.push((0,r.jsx)(h.default,{spacingAmount:t},this.getReactKey("spacing",n)));const s={id:"toggle"+n,title:i.title,value:i.value,valueOn:i.value,valueOff:void 0,type:u.ElementTypes.inputToggle};e.push((0,r.jsx)(c.default,{inputToggle:s,hostConfig:this.props.hostConfig,customViewStyles:this.props.customViewStyles,customTextStyles:this.props.customTextStyles,localization:this.props.localization,parentContainerStyle:this.props.parentContainerStyle,onExecuteAction:this.props.onExecuteAction,onInputValueChanged:this._onRadioButtonPress,isSelected:this.state.selectedValue===i.value},this.getReactKey("singleChoiceToggle",n,i.title)))})),e}_renderMultiSelect(){const e=[],t=this.props.hostConfig.choiceSet.separation.spacing;return s.each(this.props.choiceSet.choices,((i,n)=>{if(!this.props.choiceSet.value)return;e.length>0&&t&&e.push((0,r.jsx)(h.default,{spacingAmount:t},this.getReactKey("spacing",n)));const a={id:"toggle"+n,title:i.title,value:this.props.choiceSet.value.split(",").indexOf(i.value)>-1?"true":"false",valueOn:i.value,valueOff:void 0,type:u.ElementTypes.inputToggle};e.push((0,r.jsx)(c.default,{inputToggle:a,hostConfig:this.props.hostConfig,customViewStyles:this.props.customViewStyles,customTextStyles:this.props.customTextStyles,localization:this.props.localization,parentContainerStyle:this.props.parentContainerStyle,onExecuteAction:this.props.onExecuteAction,onInputValueChanged:(e,t)=>{this._selectedMultiChoices[n]=t,this.handleInputValueChanged(s.reduce(this._selectedMultiChoices,((e,t,i)=>{if(!t)return e;const n=this.props.choiceSet.choices[i].value;return e+(e?";"+n:n)}),""))}},this.getReactKey("toggle",n,a.title)))})),s.isEmpty(e)?void 0:e}}t.default=g},505869:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=n.__importStar(i(496486)),a=n.__importStar(i(516778)),o=i(759982),l=i(12805),d=i(438278),c=(0,i(26703).lazyProperties)({containerStyle:()=>a.Styles.createViewStyle({flex:1,flexDirection:"column",alignItems:"stretch"}),inputDefaultStyle:()=>a.Styles.createViewStyle({borderWidth:2,borderColor:"#DDDDDD",borderStyle:"solid",paddingTop:4,paddingBottom:4,paddingLeft:8,paddingRight:8}),inputValidationFailedDefaultStyle:()=>a.Styles.createViewStyle({borderColor:"#f44283",borderWidth:2})});class h extends l.BaseInputView{constructor(){super(...arguments),this._onDateChange=e=>{const t=this._validateInput(e);this.setState({value:e,isValid:t}),this.handleInputValidationResult(t),this.handleInputValueChanged(e),this.forceUpdate()},this._validateInput=e=>s.isUndefined(this._minValue)||s.isUndefined(this._maxValue)?s.isUndefined(this._minValue)?!!s.isUndefined(this._maxValue)||!s.isUndefined(e)&&e<=this._maxValue:!s.isUndefined(e)&&e>=this._minValue:!s.isUndefined(e)&&e>=this._minValue&&e<=this._maxValue}_buildState(e,t){const i={};this._maxValue=e.inputDate.max?new Date(e.inputDate.max):void 0,this._minValue=e.inputDate.min?new Date(e.inputDate.min):void 0;const n=e.inputDate.value?new Date(e.inputDate.value):void 0;return i.value=n,i.isValid=this._validateInput(n),i}get inputId(){return this.props.inputDate.id}componentDidMount(){super.componentDidMount(),this.handleInputValueChanged(this.state.value),this.handleInputValidationResult(this.state.isValid)}render(){const e=a.Styles.createTextStyle({fontSize:this.props.hostConfig.fontSizes.default},!1),t=[e];this.props.customTextStyles&&t.push(this.props.customTextStyles[d.CustomStyleNames.inputText]);const i=[e];this.props.customTextStyles&&i.push(this.props.customTextStyles[d.CustomStyleNames.inputDate]);const n=[c.inputDefaultStyle];return this.props.customViewStyles&&n.push(this.props.customViewStyles[d.CustomStyleNames.input]),this.state.isValid||(n.push(c.inputValidationFailedDefaultStyle),this.props.customViewStyles&&n.push(this.props.customViewStyles.inputValidationFailed)),(0,r.jsxs)(a.View,{style:c.containerStyle,children:[(0,r.jsx)(a.Text,{style:t,children:this.props.inputDate.placeholder}),(0,r.jsx)(o.DatePicker,{date:this.state.value,maximumDate:this._maxValue,minimumDate:this._minValue,customStyles:{container:a.Styles.combine([n]),text:a.Styles.combine([i])},onDateChange:this._onDateChange})]})}}t.default=h},755879:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=n.__importStar(i(496486)),a=n.__importStar(i(516778)),o=i(12805),l=i(438278),d=(0,i(26703).lazyProperties)({inputDefaultStyle:()=>a.Styles.createTextStyle({borderWidth:2,borderColor:"#DDDDDD",borderStyle:"solid",paddingTop:4,paddingBottom:4,paddingLeft:8,paddingRight:8}),inputValidationFailedDefaultStyle:()=>a.Styles.createViewStyle({borderColor:"#f44283",borderWidth:2})});class c extends o.BaseInputView{constructor(){super(...arguments),this._getValueAsString=()=>s.isUndefined(this.state.value)||s.isNaN(this.state.value)?"":0===this.state.value?"0":this.state.value.toString(),this._onTextInputRef=e=>{this._inputRef=e},this._onFocus=e=>{this.props.hostConfig.supportsInteractivity&&(this.props.onFocus&&this.props.onFocus(),this.setState({isEditing:!0}))},this._onBlur=()=>{this.props.onBlur&&this.props.onBlur(),this._onSubmitEdit()},this._onChangeText=e=>{const t=parseFloat(e);this.setState({value:t}),this.handleInputValueChanged(t)},this._onSubmitEdit=()=>{const e=this._validateInput(this.state.value);this.handleInputValidationResult(e),this.setState({isEditing:!1,isValid:e})},this._validateInput=e=>!s.isUndefined(e)&&!s.isNaN(e)&&(e>=this._minValue&&e<=this._maxValue)}_buildState(e,t){const i={};return this._maxValue=void 0!==e.inputNumber.max?e.inputNumber.max:Number.MAX_VALUE,this._minValue=void 0!==e.inputNumber.min?e.inputNumber.min:Number.MIN_VALUE,i.value=e.inputNumber.value,i.isValid=this._validateInput(e.inputNumber.value),i}get inputId(){return this.props.inputNumber.id}focus(){this._inputRef&&this.props.hostConfig.supportsInteractivity&&this._inputRef.focus()}blur(){this._inputRef&&(this.setState({isEditing:!1}),this._inputRef.blur())}componentDidMount(){super.componentDidMount(),this.handleInputValueChanged(this.state.value),this.handleInputValidationResult(this.state.isValid)}render(){const e=a.Styles.createTextStyle({fontSize:this.props.hostConfig.fontSizes.default},!1),t=[d.inputDefaultStyle,e];return this.props.customViewStyles&&t.push(this.props.customViewStyles[l.CustomStyleNames.input]),this.props.customTextStyles&&t.push(this.props.customTextStyles[l.CustomStyleNames.inputNumber]),this.state.isValid||(t.push(d.inputValidationFailedDefaultStyle),this.props.customViewStyles&&t.push(this.props.customViewStyles.inputValidationFailed)),(0,r.jsx)(a.TextInput,{ref:this._onTextInputRef,style:t,value:this._getValueAsString(),placeholder:this.props.inputNumber.placeholder,onChangeText:this._onChangeText,onFocus:this._onFocus,onBlur:this._onBlur,editable:this.props.hostConfig.supportsInteractivity,blurOnSubmit:!0,returnKeyType:"done",keyboardType:"numeric",onSubmitEditing:this._onSubmitEdit},this.getReactKey("numberInput"))}}t.default=c},903244:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=n.__importStar(i(516778)),a=i(12805),o=i(438278),l=i(26703),d=n.__importDefault(i(581911)),c=(0,l.lazyProperties)({inputPickerItemStyle:()=>s.Styles.createViewStyle({backgroundColor:"#FFFFFF",paddingTop:8,paddingBottom:8,paddingLeft:8,paddingRight:8}),inputPickerItemHoveringStyle:()=>s.Styles.createViewStyle({backgroundColor:"#F0F0F0"}),inputPickerItemSelectedStyle:()=>s.Styles.createViewStyle({backgroundColor:"#DDDDDD"})});class h extends a.BaseInputView{constructor(){super(...arguments),this._onButtonRef=e=>{this._buttonRef=e},this._onButtonHoverEnd=()=>{this.setState({isHovering:!1})},this._onButtonHoverStart=()=>{this.setState({isHovering:!0})},this._onButtonFocus=e=>{this.props.onItemFocused(this)},this._onButtonPress=e=>{e.stopPropagation(),this.props.onInputValueChanged(this.inputId,this.props.choice.value)}}_buildState(e,t){const i={};return t&&(i.isHovering=!1),i}get inputId(){return this.props.inputId}render(){const e=[c.inputPickerItemStyle];this.props.customPickerStyles&&e.push(this.props.customPickerStyles[o.CustomStyleNames.inputPickerItem]),this.props.isSelected?(e.push(c.inputPickerItemSelectedStyle),this.props.customPickerStyles&&e.push(this.props.customPickerStyles[o.CustomStyleNames.inputPickerItemSelected])):this.state.isHovering&&(e.push(c.inputPickerItemHoveringStyle),this.props.customPickerStyles&&e.push(this.props.customPickerStyles[o.CustomStyleNames.inputPickerItemHovering]));const t=[s.Styles.createTextStyle({fontFamily:this.props.hostConfig.fontFamily,fontSize:this.props.hostConfig.fontSizes.default,fontWeight:this.props.hostConfig.fontWeights.default},!1)];return this.props.customTextStyles&&t.push(this.props.customTextStyles[o.CustomStyleNames.inputTitle]),(0,r.jsx)(s.Button,{ref:this._onButtonRef,accessibilityLabel:this._getAccessibilityLabel(this.props.isSelected),accessibilityTraits:s.Types.AccessibilityTrait.None,style:e,onHoverEnd:this._onButtonHoverEnd,onHoverStart:this._onButtonHoverStart,onFocus:this._onButtonFocus,onPress:this._onButtonPress,children:(0,r.jsx)(s.Text,{style:t,children:this.props.choice.title})})}focus(){this._buttonRef&&this._buttonRef.focus()}_getAccessibilityLabel(e){let t;return this.props.localization&&(t=e?this.props.localization.inputChoiceSelectedAccessibilityLabel:this.props.localization.inputChoiceUnselectedAccessibilityLabel),d.default.inputChoiceAccessibilityLabel(e,this.props.choice.title,t)}}t.default=h},196107:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=n.__importStar(i(496486)),a=n.__importStar(i(516778)),o=i(12805),l=i(438278),d=n.__importDefault(i(950527)),c=n.__importDefault(i(903244)),h=i(26703),u=i(73776),p=n.__importDefault(i(549187)),g="PICKER_POPUP",m=(0,h.lazyProperties)({inputDefaultStyle:()=>a.Styles.createViewStyle({backgroundColor:"rgba(0, 0, 0, 0)",borderWidth:2,borderColor:"#DDDDDD",borderStyle:"solid",paddingTop:4,paddingBottom:4,paddingLeft:8,paddingRight:8}),inputPickerStyle:()=>a.Styles.createViewStyle({flex:1,flexDirection:"row",alignItems:"center",justifyContent:"space-between"})});class f extends o.BaseInputView{constructor(){super(...arguments),this._focusedPickerItemIndex=0,this._pickerDim={x:0,y:0},this._pickerItems=[],this._onPickerItemsKeyPress=e=>{e.keyCode!==d.default.keyArrowDown&&e.keyCode!==d.default.keyArrowUp||(e.stopPropagation(),e.keyCode===d.default.keyArrowDown&&(this._focusedPickerItemIndex++,this._focusedPickerItemIndex>this._pickerItems.length-1&&(this._focusedPickerItemIndex=0)),e.keyCode===d.default.keyArrowUp&&(this._focusedPickerItemIndex--,this._focusedPickerItemIndex<0&&(this._focusedPickerItemIndex=this._pickerItems.length-1)),this._pickerItems[this._focusedPickerItemIndex].focus())},this._onPickerItemFocused=e=>{this._focusedPickerItemIndex=this._pickerItems.indexOf(e),-1===this._focusedPickerItemIndex&&(this._focusedPickerItemIndex=0)},this._onPickerItemRef=e=>{this._pickerItems.push(e)},this._onPickerItemSelected=(e,t)=>{a.Popup.isDisplayed(g)&&a.Popup.dismiss(g),this.handleInputValueChanged(t)},this._onPickerDismiss=()=>{this._pickerRef&&this._pickerRef.focus()},this._onPickerLayout=e=>{this._pickerDim={x:e.width,y:e.height}},this._onPickerPress=e=>{e.stopPropagation(),this.props.onShowPickerChoices?this.props.onShowPickerChoices(this.props.choiceSet.choices,(e=>this._onPickerItemSelected("",e))):this._renderPickerItems()},this._onPickerRef=e=>{this._pickerRef=e}}get inputId(){return this.props.choiceSet.id}render(){const e=[m.inputDefaultStyle,m.inputPickerStyle];this.props.customPickerStyles&&e.push(this.props.customPickerStyles[l.CustomStyleNames.inputPicker]);const t=[a.Styles.createTextStyle({fontFamily:this.props.hostConfig.fontFamily,fontSize:this.props.hostConfig.fontSizes.default,fontWeight:this.props.hostConfig.fontWeights.default},!1)];return this.props.customTextStyles&&t.push(this.props.customTextStyles[l.CustomStyleNames.inputTitle]),(0,r.jsx)(a.View,{onLayout:this._onPickerLayout,children:(0,r.jsxs)(a.Button,{accessibilityLabel:this.props.selectedChoice.title,accessibilityTraits:a.Types.AccessibilityTrait.Button,onPress:this._onPickerPress,ref:this._onPickerRef,style:e,children:[(0,r.jsx)(a.Text,{style:t,children:this.props.selectedChoice.title}),this.props.pickerIcon]})})}_renderPickerItems(){const e=[];this._pickerItems.length=0;const t=this.props.hostConfig.choiceSet.separation.spacing;this.props.choiceSet.choices.length>0&&t&&e.push((0,r.jsx)(p.default,{spacingAmount:t/2},this.getReactKey("topSpacing"))),s.each(this.props.choiceSet.choices,((i,n)=>{n>0&&t&&e.push((0,r.jsx)(p.default,{spacingAmount:t},this.getReactKey("spacing",n))),e.push((0,r.jsx)(c.default,{inputId:this.getReactKey("pickerItemInput",n,i.title,i.value),ref:this._onPickerItemRef,onInputValueChanged:this._onPickerItemSelected,onItemFocused:this._onPickerItemFocused,customPickerStyles:this.props.customPickerStyles,customTextStyles:this.props.customTextStyles,pickerIcon:this.props.pickerIcon,hostConfig:this.props.hostConfig,localization:this.props.localization,choice:i,isSelected:this.props.selectedChoice.value===i.value},this.getReactKey("pickerItem",n,i.title,i.value)))})),this.props.choiceSet.choices.length>0&&t&&e.push((0,r.jsx)(p.default,{spacingAmount:t/2},this.getReactKey("bottomSpacing")));const i=[a.Styles.createViewStyle({width:this._pickerDim.x},!1)];if(this.props.customPickerStyles&&i.push(this.props.customPickerStyles[l.CustomStyleNames.inputPickerItems]),this._pickerRef){const t=this._pickerRef,n={getAnchor:()=>t,renderPopup:(t,n,s,o)=>(0,r.jsx)(u.Popup,{anchorPosition:t,anchorOffset:n,offset:{x:0,y:0},popupWidth:s,popupHeight:o,strokeColor:"rgba(0, 0, 0, 0)",fillColor:"rgba(0, 0, 0, 0)",children:(0,r.jsx)(a.View,{style:i,onKeyPress:this._onPickerItemsKeyPress,children:e})}),dismissIfShown:!0,onDismiss:this._onPickerDismiss};a.Popup.show(n,g)}}}t.default=f},632334:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=n.__importStar(i(496486)),a=n.__importStar(i(516778)),o=n.__importDefault(i(127850)),l=i(438278),d=n.__importDefault(i(950527));class c extends o.default{_buildState(e,t){return{}}get inputId(){return this.props.inputId}get fontSize(){return this.props.hostConfig.fontSizes.default}get borderRadius(){return this.fontSize/2}get isSelected(){return this.props.isSelected}get title(){return this.props.title}get customChoiceStyles(){const e=this.props.customViewStyles&&s.compact([this.props.customViewStyles[l.CustomStyleNames.inputChoice],this.props.customViewStyles[l.CustomStyleNames.inputRadioButtonUnselected]]);return s.isEmpty(e)?void 0:e}get customTitleStyles(){const e=this.props.customTextStyles&&s.compact([this.isSelected?this.props.customTextStyles[l.CustomStyleNames.inputTitleSelected]:this.props.customTextStyles[l.CustomStyleNames.inputTitle]]);return s.isEmpty(e)?void 0:e}onPress(e){e.stopPropagation(),this.handleInputValueChanged(this.props.value),d.default.isWindows()||a.Accessibility.announceForAccessibility(this._getAccessibilityLabel(!0))}buildSelectedView(){const e=Math.floor(this.fontSize/2),t=1&e^1&this.fontSize?e+1:e,i=[a.Styles.createViewStyle({height:t,width:t,borderRadius:t/2,backgroundColor:"#000000"},!1)];return this.props.customViewStyles&&(i.push(this.props.customViewStyles[l.CustomStyleNames.inputChoice]),i.push(this.props.customViewStyles[l.CustomStyleNames.inputRadioButtonSelected])),(0,r.jsx)(a.View,{style:i})}}t.default=c},165901:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=n.__importStar(i(516778)),a=i(12805),o=i(438278),l=(0,i(26703).lazyProperties)({inputDefaultStyle:()=>s.Styles.createTextStyle({borderWidth:2,borderColor:"#DDDDDD",borderStyle:"solid",paddingTop:4,paddingBottom:4,paddingLeft:8,paddingRight:8})});class d extends a.BaseInputView{constructor(){super(...arguments),this._onTextInputRef=e=>{this._inputRef=e},this._onFocus=e=>{this.props.hostConfig.supportsInteractivity&&(this.props.onFocus&&this.props.onFocus(),this.setState({isEditing:!0}))},this._onBlur=()=>{this.props.onBlur&&this.props.onBlur(),this.setState({isEditing:!1})},this._onChangeText=e=>{this.setState({newText:e}),this.handleInputValueChanged(e)}}_buildState(e,t){const i={};return t&&(i.newText=e.inputText.value),i}get inputId(){return this.props.inputText.id}focus(){this._inputRef&&this.props.hostConfig.supportsInteractivity&&this._inputRef.focus()}blur(){this._inputRef&&(this.setState({isEditing:!1}),this._inputRef.blur())}componentDidMount(){super.componentDidMount(),this.handleInputValueChanged(this.state.newText),this.handleInputValidationResult(!0)}render(){const e=s.Styles.createTextStyle({fontSize:this.props.hostConfig.fontSizes.default},!1),t=[l.inputDefaultStyle,e];return this.props.customViewStyles&&t.push(this.props.customViewStyles[o.CustomStyleNames.input]),this.props.customTextStyles&&(t.push(this.props.customTextStyles[o.CustomStyleNames.inputText]),this.props.inputText.isMultiline&&t.push(this.props.customTextStyles[o.CustomStyleNames.inputTextMultiline])),(0,r.jsx)(s.TextInput,{ref:this._onTextInputRef,style:t,value:this.state.newText,placeholder:this.props.inputText.placeholder,onChangeText:this._onChangeText,onFocus:this._onFocus,onBlur:this._onBlur,editable:this.props.hostConfig.supportsInteractivity,multiline:this.props.inputText.isMultiline,maxLength:this.props.inputText.maxLength,blurOnSubmit:!0,returnKeyType:"done"},this.getReactKey("textInput"))}}t.default=d},151932:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=n.__importStar(i(496486)),a=n.__importStar(i(516778)),o=i(759982),l=i(12805),d=i(438278),c=i(26703),h=/([0-9]+)\:([0-9]+)\s?([ap][mM])?/,u=(0,c.lazyProperties)({containerStyle:()=>a.Styles.createViewStyle({flex:1,flexDirection:"column",alignItems:"stretch"}),inputDefaultStyle:()=>a.Styles.createViewStyle({borderWidth:2,borderColor:"#DDDDDD",borderStyle:"solid",paddingTop:4,paddingBottom:4,paddingLeft:8,paddingRight:8}),inputValidationFailedDefaultStyle:()=>a.Styles.createViewStyle({borderColor:"#f44283",borderWidth:2})});class p extends l.BaseInputView{constructor(){super(...arguments),this._onTimeChange=e=>{const t=this._validateInput(e);this.setState({value:e,isValid:t}),this.handleInputValidationResult(t),this.handleInputValueChanged(e)},this._validateInput=e=>{const t=this._dateFromTime(e);return t>=this._minValue&&t<=this._maxValue}}_buildState(e,t){const i={};this._maxValue=void 0!==e.inputTime.max?this._dateFromString(e.inputTime.max):new Date(0,0,0,23,59),this._minValue=void 0!==e.inputTime.min?this._dateFromString(e.inputTime.min):new Date(0,0,0);const n=this._timeFromString(e.inputTime.value);return i.value=n,i.isValid=this._validateInput(n),i}componentDidMount(){super.componentDidMount(),this.handleInputValueChanged(this.state.value),this.handleInputValidationResult(this.state.isValid)}render(){const e=a.Styles.createTextStyle({fontSize:this.props.hostConfig.fontSizes.default},!1),t=[e];this.props.customTextStyles&&t.push(this.props.customTextStyles[d.CustomStyleNames.inputText]);const i=[e];this.props.customTextStyles&&i.push(this.props.customTextStyles[d.CustomStyleNames.inputTime]);const n=[u.inputDefaultStyle];return this.props.customViewStyles&&n.push(this.props.customViewStyles[d.CustomStyleNames.input]),this.state.isValid||(n.push(u.inputValidationFailedDefaultStyle),this.props.customViewStyles&&n.push(this.props.customViewStyles.inputValidationFailed)),(0,r.jsxs)(a.View,{style:u.containerStyle,children:[(0,r.jsx)(a.Text,{style:t,children:this.props.inputTime.placeholder}),(0,r.jsx)(o.TimePicker,{time:this._dateFromTime(this.state.value),customStyles:{container:a.Styles.combine([n]),text:a.Styles.combine([i])},onTimeChange:this._onTimeChange})]})}get inputId(){return this.props.inputTime.id}_getCurrentTime(){const e=new Date;return{hour:e.getHours(),minute:e.getMinutes()}}_timeFromString(e){if(!e)return this._getCurrentTime();const t=h.exec(e);if(!t||t.length<3)return this._getCurrentTime();let i=parseInt(t[1],10);const n=parseInt(t[2],10);return s.isNaN(i)||s.isNaN(n)||i<0||i>24||n<0||n>59?this._getCurrentTime():(t[3]&&s.startsWith(t[3].toLowerCase(),"p")&&i<=12&&(i=12),{hour:i,minute:n})}_dateFromTime(e){return e?new Date(0,0,0,e.hour,e.minute):new Date(0,0,0)}_dateFromString(e){const t=this._timeFromString(e);return t?new Date(0,0,0,t.hour,t.minute):new Date(0,0,0)}}t.default=p},960912:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=n.__importStar(i(496486)),a=n.__importStar(i(516778)),o=n.__importDefault(i(127850)),l=i(438278),d=n.__importDefault(i(950527));class c extends o.default{_buildState(e,t){const i={};return t&&(i.isChecked=!!e.inputToggle.value&&"true"===e.inputToggle.value.toLowerCase()),i.controlledMode=!s.isUndefined(e.isSelected),i}componentDidMount(){super.componentDidMount();const e=this.state.controlledMode?this.props.inputToggle.value:this.state.isChecked;this.handleInputValueChanged(e)}get fontSize(){return this.props.hostConfig.fontSizes.default}get borderRadius(){return 2}get isSelected(){return this.state.controlledMode?this.props.isSelected:this.state.isChecked}get title(){return this.props.inputToggle.title}get inputId(){return this.props.inputToggle.id}get customChoiceStyles(){const e=this.props.customViewStyles&&s.compact([this.props.customViewStyles[l.CustomStyleNames.inputChoice],this.props.customViewStyles[l.CustomStyleNames.inputToggleUnselected]]);return s.isEmpty(e)?void 0:e}get customTitleStyles(){const e=this.props.customTextStyles&&s.compact([this.isSelected?this.props.customTextStyles[l.CustomStyleNames.inputTitleSelected]:this.props.customTextStyles[l.CustomStyleNames.inputTitle]]);return s.isEmpty(e)?void 0:e}onPress(e){e.stopPropagation();const t=!this.state.isChecked;this.setState({isChecked:t});const i=this.state.controlledMode?this.props.inputToggle.value:t;this.handleInputValueChanged(i),d.default.isWindows()&&t||a.Accessibility.announceForAccessibility(this._getAccessibilityLabel(t))}buildSelectedView(){const e=[a.Styles.createViewStyle({borderColor:"#000000",borderWidth:Math.floor(this.fontSize/6),borderTopWidth:0,borderRightWidth:0,height:Math.floor(this.fontSize/3)+1,width:Math.floor(this.fontSize/2)+1,marginBottom:1},!1)];this.props.customViewStyles&&(e.push(this.props.customViewStyles[l.CustomStyleNames.inputChoice]),e.push(this.props.customViewStyles[l.CustomStyleNames.inputToggleSelected]));const t=new a.Animated.Value(307),i=[a.Styles.createAnimatedViewStyle({transform:[{rotate:t.interpolate({inputRange:[0,307],outputRange:["0deg","307deg"]})}]})];return this.props.customViewStyles&&i.push(this.props.customViewStyles[l.CustomStyleNames.inputToggleSelectedAnimated]),(0,r.jsx)(a.Animated.View,{style:i,children:(0,r.jsx)(a.View,{style:e})})}}t.default=c},860745:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Types=t.AdaptiveCardSanitizer=t.default=void 0;const n=i(197582),r=n.__importDefault(i(189432));t.AdaptiveCardSanitizer=r.default;const s=i(89265);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return s.AdaptiveCardView}});const a=n.__importStar(i(471968));t.Types=a},73776:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Popup=void 0;const n=i(197582),r=i(785893),s=n.__importStar(i(516778)),a=i(217041),o=i(26703),l=(0,o.lazyProperties)({popupContainer:()=>s.Styles.createButtonStyle({overflow:"visible",backgroundColor:"rgba(0, 0, 0, 0)"}),popupInnerContainer:()=>s.Styles.createViewStyle({flex:-1,overflow:"visible"}),popupPadding:()=>s.Styles.createViewStyle({paddingTop:1,paddingBottom:1,paddingLeft:0,paddingRight:1}),popupPaddingContentStretchTopBottom:()=>s.Styles.createViewStyle({paddingTop:0,paddingBottom:1,paddingLeft:2,paddingRight:2}),popupPaddingContentStretchLeftRight:()=>s.Styles.createViewStyle({paddingTop:2,paddingBottom:2,paddingLeft:0,paddingRight:1}),popupPaddingTop:()=>s.Styles.createViewStyle({paddingTop:1,paddingBottom:1,paddingLeft:1,paddingRight:1}),popupPaddingTopStretchContents:()=>s.Styles.createViewStyle({paddingTop:1,paddingBottom:0,paddingLeft:2,paddingRight:2}),popupPaddingRight:()=>s.Styles.createViewStyle({paddingTop:1,paddingBottom:1,paddingLeft:1,paddingRight:1}),popupPaddingRightStretchContents:()=>s.Styles.createViewStyle({paddingTop:2,paddingBottom:2,paddingLeft:0,paddingRight:1}),popupPaddingLeft:()=>s.Styles.createViewStyle({paddingTop:1,paddingBottom:1,paddingLeft:1,paddingRight:1}),popupPaddingLeftStretchContents:()=>s.Styles.createViewStyle({paddingTop:2,paddingBottom:2,paddingLeft:1,paddingRight:0}),popupPaddingBottom:()=>s.Styles.createViewStyle({paddingTop:1,paddingBottom:1,paddingLeft:1,paddingRight:1}),popupPaddingBottomStretchContents:()=>s.Styles.createViewStyle({paddingTop:0,paddingBottom:1,paddingLeft:2,paddingRight:2}),borderSvg:()=>s.Styles.createImageStyle({position:"absolute",left:0,top:0,overflow:"visible"})});class d extends a.ComponentBase{constructor(){super(...arguments),this._handleContextMenu=e=>{this.props.disableContextMenu&&(e.preventDefault(),e.stopPropagation())},this._onContainerRef=e=>{this._container=e},this._onPress=e=>{e.preventDefault(),e.stopPropagation()}}_buildState(e,t){return this._fillColor=e.fillColor||"#FFFFFF",this._strokeColor=e.strokeColor||"#F1F1F4",this._strokeOpacity=e.strokeOpacity||1,{svgStyle:this._buildSvgStyle(e)}}componentDidMount(){super.componentDidMount(),this._container&&!this.props.skipPopupAutoFocus&&this._container.focus()}render(){const e=[l.popupInnerContainer,l.popupPadding];let t;this.props.contentStretchAcrossWidth?e.push(l.popupPaddingContentStretchTopBottom):this.props.contentStretchAcrossHeight&&e.push(l.popupPaddingContentStretchLeftRight);const i=this._isAnchorPositionBottom(this.props),n=this._isAnchorPositionTop(this.props),a=this._isAnchorPositionRight(this.props),o=this._isAnchorPositionLeft(this.props);if(this.props.popupWidth>0&&this.props.popupHeight>0){this.props.contentStretchAcrossWidth||this.props.contentStretchAcrossHeight?i?e.push(l.popupPaddingTopStretchContents):n?e.push(l.popupPaddingBottomStretchContents):a?e.push(l.popupPaddingLeftStretchContents):e.push(l.popupPaddingRightStretchContents):a?e.push(l.popupPaddingLeft):i?e.push(l.popupPaddingTop):n?e.push(l.popupPaddingBottom):e.push(l.popupPaddingRight);const d=[l.borderSvg,this.state.svgStyle];let c=this.props.popupHeight,h=this.props.popupWidth;this.props.paddingInPopupCanvas&&((n||i)&&c>this.props.paddingInPopupCanvas?(c-=this.props.paddingInPopupCanvas,d.push(s.Styles.createImageStyle({marginTop:n?this.props.paddingInPopupCanvas:void 0,marginBottom:i?this.props.paddingInPopupCanvas:void 0},!1))):(a||o)&&h>this.props.paddingInPopupCanvas&&(h-=this.props.paddingInPopupCanvas,d.push(s.Styles.createImageStyle({marginRight:a?this.props.paddingInPopupCanvas:void 0,marginLeft:o?this.props.paddingInPopupCanvas:void 0},!1))));const u=s.Styles.createViewStyle({width:h,height:c,borderWidth:this._strokeOpacity,borderColor:this._strokeColor,backgroundColor:this._fillColor},!1);t=(0,r.jsx)(s.View,{style:[d,u]})}const d=[l.popupContainer];return this.props.containerStyle&&d.push(this.props.containerStyle),this.props.offset&&d.push(s.Styles.createViewStyle({transform:[{translateX:this.props.offset.x},{translateY:this.props.offset.y}]},!1)),(0,r.jsxs)(s.View,{onPress:this._onPress,onContextMenu:this._handleContextMenu,style:d,disableTouchOpacityAnimation:!0,restrictFocusWithin:!this.props.allowFocusOutside,children:[t,(0,r.jsx)(s.View,{style:e,ref:this._onContainerRef,children:this.props.children})]})}_isAnchorPositionTop(e){return"top"===e.anchorPosition}_isAnchorPositionBottom(e){return"bottom"===e.anchorPosition}_isAnchorPositionRight(e){return"right"===e.anchorPosition}_isAnchorPositionLeft(e){return"left"===e.anchorPosition}_buildSvgStyle(e){if(!e.popupWidth||!e.popupHeight)return;const t=this._isAnchorPositionBottom(e),i=this._isAnchorPositionTop(e),n=this._isAnchorPositionRight(e),r=this._isAnchorPositionLeft(e);let a=e.popupHeight,o=e.popupWidth;return e.paddingInPopupCanvas&&((i||t)&&a>e.paddingInPopupCanvas?a-=e.paddingInPopupCanvas:(n||r)&&o>e.paddingInPopupCanvas&&(o-=e.paddingInPopupCanvas)),s.Styles.createImageStyle({width:o,height:a},!1)}}t.Popup=d,t.default=d},880163:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PrefetchedImage=void 0;const n=i(197582),r=i(785893),s=n.__importStar(i(516778)),a=i(217041),o=n.__importDefault(i(979304)),l=i(471968);class d extends a.ComponentBase{_buildState(e,t){return{prefetchState:o.default.getImagePrefetchState(e.source)}}shouldComponentUpdate(e,t){return(this.state.prefetchState!==l.ImagePrefetchState.None||t.prefetchState!==l.ImagePrefetchState.Prefetching)&&(this.state.prefetchState!==l.ImagePrefetchState.Prefetched||t.prefetchState!==l.ImagePrefetchState.None)}render(){switch(this.state.prefetchState){case l.ImagePrefetchState.Prefetched:return(0,r.jsx)(s.Image,Object.assign({},this.props));case l.ImagePrefetchState.None:case l.ImagePrefetchState.Prefetching:return this.props.altView()||null;case l.ImagePrefetchState.Failed:return this.props.errorView()||null;default:return null}}}t.PrefetchedImage=d},549187:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=n.__importStar(i(516778)),a=i(217041);class o extends a.ComponentBase{render(){const e=this.props.isVertical?s.Styles.createViewStyle({width:this.props.spacingAmount},!1):s.Styles.createViewStyle({height:this.props.spacingAmount},!1);return(0,r.jsx)(s.View,{style:e})}}t.default=o},954567:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=n.__importStar(i(496486)),a=n.__importDefault(i(727484)),o=n.__importStar(i(516778)),l=i(438278),d=i(26703),c=n.__importDefault(i(581911)),h=n.__importStar(i(471968)),u=/(\*\*)(.*?)\1/g,p=/(_)(.*?)\1/g,g=/\{\{(DATE|TIME)\((.*?)\)\}\}/g,m=/\[([^\[]+)\]\(([^\)]+)\)/g,f=/([^\\]*)(\\)(.+)/g,S=/^(https?:|skype:|mailto:)?([\S]*)/i;var v,y,C,T,E,_;!function(e){e[e.All=0]="All",e[e.Markdown=1]="Markdown",e[e.Text=2]="Text"}(v||(v={})),function(e){e[e.All=0]="All",e[e.Type=1]="Type",e[e.DateTimeAndFormat=2]="DateTimeAndFormat"}(y||(y={})),function(e){e[e.All=0]="All",e[e.Title=1]="Title",e[e.Url=2]="Url"}(C||(C={})),function(e){e[e.All=0]="All",e[e.Title=1]="Title",e[e.Backslash=2]="Backslash",e[e.Trailing=3]="Trailing"}(T||(T={})),function(e){e[e.DateTime=0]="DateTime",e[e.Format=1]="Format"}(E||(E={})),function(e){e[e.All=0]="All",e[e.Protocol=1]="Protocol"}(_||(_={}));const b=["https:","skype:","mailto:"],P=(0,d.lazyProperties)({boldText:()=>o.Styles.createTextStyle({fontWeight:"bold"}),italicText:()=>o.Styles.createTextStyle({fontStyle:"italic"}),linkText:()=>o.Styles.createTextStyle({color:"#000000",cursor:"pointer",fontWeight:"bold"})});class I extends l.ElementBaseView{constructor(){super(...arguments),this._tags=[],this._key=0,this._currentHeight=0,this._onLayout=e=>{e.height!==this._currentHeight&&(this._currentHeight=e.height,this.setState({relativeYPosition:e.y,height:e.height}))},this._getBoldTextToken=e=>this._getTextToken(e,this._getCustomStyle(l.CustomStyleNames.textBolder)||P.boldText),this._getItalicTextToken=e=>this._getTextToken(e,this._getCustomStyle(l.CustomStyleNames.textItalic)||P.italicText),this._getDateTimeToken=e=>{const t=e.length>y.DateTimeAndFormat?e[y.DateTimeAndFormat].split(",",2):void 0;if(!t||!t.length)return;const i=new Date(t[E.DateTime].trim());if(!i||s.isNaN(i))return;const n=(0,a.default)(i),r=e[y.Type].toLowerCase();if("time"===r)return n.format(this.props.hostConfig.textBlock.timeFormat);if("date"===r){let e="";switch(t.length>E.Format?t[E.Format].trim().toLowerCase():h.DateFormats.compact){case h.DateFormats.short:e=this.props.hostConfig.textBlock.shortDateFormat;break;case h.DateFormats.long:e=this.props.hostConfig.textBlock.longDateFormat;break;default:e=this.props.hostConfig.textBlock.compactDateFormat}return n.format(e)}},this._getUrlToken=e=>{this._key++;const t=e.length>=C.Title?e[C.Title]:void 0,i=e.length>=C.Url?this._cleanupUrl(e[C.Url]):void 0;if(t&&i)return(0,r.jsx)(o.Link,{title:i,style:[P.linkText,this._getCustomStyle(l.CustomStyleNames.textLink)],onLongPress:this._onLongPress,onPress:this._onPress,url:i,children:t},this.getReactKey("url",this._key))},this._getNumberedListToken=e=>{let t=e.length>=T.Title?e[T.Title]:void 0;if(t)return e.length>=T.Trailing&&(t+=e[T.Trailing]),t},this._onLongPress=(e,t)=>{e.stopPropagation(),this._executeActionOpenUrl(t,!0)},this._onPress=(e,t)=>{e.stopPropagation(),this._executeActionOpenUrl(t)},this._executeActionOpenUrl=(e,t)=>{if(this.props.onExecuteAction){const i={type:h.ActionTypes.actionOpenUrl,url:e,preview:!!t||void 0};this.props.onExecuteAction(i)}}}_buildState(e,t){return this._tags=[{regExp:u,getToken:this._getBoldTextToken},{regExp:p,getToken:this._getItalicTextToken},{regExp:g,getToken:this._getDateTimeToken},{regExp:m,getToken:this._getUrlToken},{regExp:f,getToken:this._getNumberedListToken}],{}}render(){this._key=0;const e=this.props.textBlock.weight?this.props.hostConfig.fontWeights[this.props.textBlock.weight]:this.props.hostConfig.fontWeights.default,t=this.props.textBlock.size?this.props.hostConfig.fontSizes[this.props.textBlock.size]:this.props.hostConfig.fontSizes.default,i=[],n=this._tokenizeMarkdownText(this.props.textBlock.text),s=this._getMaxLinesAndTruncate(1.33*t,i),a=this._getFontColor();i.push(o.Styles.createTextStyle({color:a,textAlign:this.props.textBlock.horizontalAlignment||h.HorizontalAlignments.left,flexWrap:this.props.textBlock.wrap?"wrap":"nowrap",fontFamily:this.props.hostConfig.fontFamily,fontSize:t,fontWeight:e},!1));const l=this._getTextWeightStyle(this.props.textBlock.weight);return l&&i.push(l),(0,r.jsx)(o.View,{onLayout:this._onLayout,children:(0,r.jsx)(o.Text,{style:i,numberOfLines:s,allowFontScaling:!1,id:this.props.textBlock.id,children:n})})}_getFontColor(){const e=this.props.parentContainerStyle?this.props.parentContainerStyle:this.props.hostConfig.container.default;if(0===this._currentHeight)return e.backgroundColor;const t=this.props.textBlock.color?e.foregroundColors[this.props.textBlock.color]:e.foregroundColors.default;return c.default.stringToCssColor(this.props.textBlock.isSubtle?t.subtle:t.default)}_getTextWeightStyle(e){let t;switch(e){case h.TextWeights.default:t=this._getCustomStyle(l.CustomStyleNames.textDefault);break;case h.TextWeights.bolder:t=this._getCustomStyle(l.CustomStyleNames.textBolder);break;case h.TextWeights.lighter:t=this._getCustomStyle(l.CustomStyleNames.textLigher)}return t}_getCustomStyle(e){if(e&&this.props.customTextStyles)return this.props.customTextStyles[e]}_getMaxLinesAndTruncate(e,t){if(s.isUndefined(this.props.availableHeight)||s.isUndefined(this.state.height))return this.props.textBlock.maxLines;let i=this.props.textBlock.maxLines;i&&this.state.height>e*i&&i&&(this._currentHeight=s.ceil(e*i),t.push(o.Styles.createTextStyle({height:this._currentHeight},!1)));if(this.state.relativeYPosition+this.state.height>this.props.availableHeight){const n=this.state.relativeYPosition<this.props.availableHeight?this.props.availableHeight-this.state.relativeYPosition:0,r=s.floor(n/e);i=Math.max(!this.props.textBlock.maxLines||this.props.textBlock.maxLines>r?r:this.props.textBlock.maxLines,0)||0,this._currentHeight=i<=0?0:s.ceil(e*i),t.push(o.Styles.createTextStyle({height:this._currentHeight},!1))}return i}_findNextTag(e,t){if(t>=e.length)return;const i=s.compact(s.map(this._tags,(i=>{i.regExp.lastIndex=t;const n=i.regExp.exec(e);if(n)return{tag:i,match:n}}))).sort(((e,t)=>e.match.index-t.match.index));return s.isEmpty(i)?void 0:i[0]}_tokenizeMarkdownText(e){const t=[];let i,n=0,r=this._findNextTag(e,n);for(;r;){i=e.slice(n,r.match.index),i&&i.length&&t.push(i),n=r.match.index+r.match[0].length;const s=r.tag.getToken(r.match);t.push(s),r=this._findNextTag(e,n)}return i=e.slice(n),i&&i.length&&t.push(i),s.compact(t)}_getTextToken(e,t){this._key++;const i=e.length>v.Text?this._tokenizeMarkdownText(e[v.Text]):void 0;return s.isEmpty(i)?void 0:(0,r.jsx)(o.Text,{style:t,children:i},this.getReactKey("text",this._key))}_cleanupUrl(e){if(!e)return;const t=S.exec(e);if(!t||t.length<=_.Protocol)return;let i=t[_.Protocol];if(!i)return;if(i=i.toLowerCase(),!s.some(b,(e=>i===e)))return;const n=t[_.All];return n||void 0}}t.default=I},471968:(e,t)=>{"use strict";var i,n;Object.defineProperty(t,"__esModule",{value:!0}),t.ImagePrefetchState=t.EnvironmentShells=t.EnvironmentPlatforms=t.CardHeightTypes=t.ShowActionModeTypes=t.BackgroundImageModes=t.DateFormats=t.VerticalAlignments=t.HorizontalAlignments=t.SpacingStyles=t.ContainerHeights=t.ImageStyles=t.ImageSizes=t.TextWeights=t.TextSizes=t.TextColors=t.FontWeights=t.ColumnWidths=t.ActionsOrientationTypes=t.ActionTypes=t.ActionAlignmentTypes=t.InputChoiceTypes=t.ElementTypes=t.AdaptiveCardTypes=t.ElementTypeNames=void 0,function(e){e.textBlock="textblock",e.image="image",e.container="container",e.columnSet="columnset",e.column="column",e.factSet="factset",e.imageSet="imageset",e.inputText="input.text",e.inputDate="input.date",e.inputTime="input.time",e.inputNumber="input.number",e.inputToggle="input.toggle",e.inputChoiceSet="input.choiceset"}(i||(t.ElementTypeNames=i={})),t.AdaptiveCardTypes={adaptiveCard:"AdaptiveCard"},t.ElementTypes={textBlock:i.textBlock,image:i.image,container:i.container,columnSet:i.columnSet,column:i.column,factSet:i.factSet,imageSet:i.imageSet,inputText:i.inputText,inputDate:i.inputDate,inputTime:i.inputTime,inputNumber:i.inputNumber,inputToggle:i.inputToggle,inputChoiceSet:i.inputChoiceSet},t.InputChoiceTypes={inputChoice:"input.choice"},t.ActionAlignmentTypes={left:"left",center:"center",right:"right",stretch:"stretch",scroll:"scroll"},t.ActionTypes={actionOpenUrl:"action.openurl",actionSubmit:"action.submit",actionShowCard:"action.showcard",actionToggleVisibility:"action.togglevisibility",actionExecute:"action.execute"},t.ActionsOrientationTypes={horizontal:"horizontal",vertical:"vertical"},t.ColumnWidths={auto:"auto",stretch:"stretch"},t.FontWeights={normal:"normal",bold:"bold",100:"100",200:"200",300:"300",400:"400",500:"500",600:"600",700:"700",800:"800",900:"900"},t.TextColors={default:"default",dark:"dark",light:"light",accent:"accent",good:"good",warning:"warning",attention:"attention"},t.TextSizes={small:"small",default:"default",medium:"medium",large:"large",extraLarge:"extraLarge"},t.TextWeights={lighter:"lighter",default:"default",bolder:"bolder"},t.ImageSizes={auto:"auto",stretch:"stretch",small:"small",medium:"medium",large:"large"},t.ImageStyles={default:"default",person:"person"},t.ContainerHeights={auto:"auto",stretch:"stretch"},t.SpacingStyles={none:"none",small:"small",default:"default",medium:"medium",large:"large",extraLarge:"extraLarge",padding:"padding"},t.HorizontalAlignments={left:"left",center:"center",right:"right"},t.VerticalAlignments={top:"top",center:"center",bottom:"bottom"},t.DateFormats={compact:"compact",short:"short",long:"long"},t.BackgroundImageModes={stretch:"stretch",repeatHorizontally:"repeatHorizontally",repeatVertically:"repeatVertically",repeat:"repeat"},t.ShowActionModeTypes={inlineEdgeToEdge:"InlineEdgeToEdge",inline:"Inline",popup:"Popup"},t.CardHeightTypes={fixed:"fixed",auto:"auto"},t.EnvironmentPlatforms={iOS:"iOS",android:"Android",windows:"Windows",osx:"OSX",linux:"Linux",unknown:"Unknown"},t.EnvironmentShells={browser:"Browser",reactNative:"ReactNative",electron:"Electron",unknown:"Unknown"},function(e){e[e.None=0]="None",e[e.Prefetching=1]="Prefetching",e[e.Prefetched=2]="Prefetched",e[e.Failed=3]="Failed"}(n||(t.ImagePrefetchState=n={}))},654442:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.XmlAndHtmlEntities=t.CharToXmlEntity=t.CharsToXmlEscapeRegExp=void 0;const n=i(197582).__importStar(i(496486)),r={quot:'"',amp:"&",apos:"'",lt:"<",gt:">"};t.CharsToXmlEscapeRegExp=new RegExp("["+n.values(r).join("")+"]","g"),t.CharToXmlEntity=n.invert(r),t.XmlAndHtmlEntities={quot:'"',amp:"&",apos:"'",lt:"<",gt:">",nbsp:String.fromCharCode(160),iexcl:String.fromCharCode(161),cent:String.fromCharCode(162),pound:String.fromCharCode(163),curren:String.fromCharCode(164),yen:String.fromCharCode(165),brvbar:String.fromCharCode(166),sect:String.fromCharCode(167),uml:String.fromCharCode(168),copy:String.fromCharCode(169),ordf:String.fromCharCode(170),laquo:String.fromCharCode(171),not:String.fromCharCode(172),shy:String.fromCharCode(173),reg:String.fromCharCode(174),macr:String.fromCharCode(175),deg:String.fromCharCode(176),plusmn:String.fromCharCode(177),sup2:String.fromCharCode(178),sup3:String.fromCharCode(179),acute:String.fromCharCode(180),micro:String.fromCharCode(181),para:String.fromCharCode(182),middot:String.fromCharCode(183),cedil:String.fromCharCode(184),sup1:String.fromCharCode(185),ordm:String.fromCharCode(186),raquo:String.fromCharCode(187),frac14:String.fromCharCode(188),frac12:String.fromCharCode(189),frac34:String.fromCharCode(190),iquest:String.fromCharCode(191),Agrave:String.fromCharCode(192),Aacute:String.fromCharCode(193),Acirc:String.fromCharCode(194),Atilde:String.fromCharCode(195),Auml:String.fromCharCode(196),Aring:String.fromCharCode(197),AElig:String.fromCharCode(198),Ccedil:String.fromCharCode(199),Egrave:String.fromCharCode(200),Eacute:String.fromCharCode(201),Ecirc:String.fromCharCode(202),Euml:String.fromCharCode(203),Igrave:String.fromCharCode(204),Iacute:String.fromCharCode(205),Icirc:String.fromCharCode(206),Iuml:String.fromCharCode(207),ETH:String.fromCharCode(208),Ntilde:String.fromCharCode(209),Ograve:String.fromCharCode(210),Oacute:String.fromCharCode(211),Ocirc:String.fromCharCode(212),Otilde:String.fromCharCode(213),Ouml:String.fromCharCode(214),times:String.fromCharCode(215),Oslash:String.fromCharCode(216),Ugrave:String.fromCharCode(217),Uacute:String.fromCharCode(218),Ucirc:String.fromCharCode(219),Uuml:String.fromCharCode(220),Yacute:String.fromCharCode(221),THORN:String.fromCharCode(222),szlig:String.fromCharCode(223),agrave:String.fromCharCode(224),aacute:String.fromCharCode(225),acirc:String.fromCharCode(226),atilde:String.fromCharCode(227),auml:String.fromCharCode(228),aring:String.fromCharCode(229),aelig:String.fromCharCode(230),ccedil:String.fromCharCode(231),egrave:String.fromCharCode(232),eacute:String.fromCharCode(233),ecirc:String.fromCharCode(234),euml:String.fromCharCode(235),igrave:String.fromCharCode(236),iacute:String.fromCharCode(237),icirc:String.fromCharCode(238),iuml:String.fromCharCode(239),eth:String.fromCharCode(240),ntilde:String.fromCharCode(241),ograve:String.fromCharCode(242),oacute:String.fromCharCode(243),ocirc:String.fromCharCode(244),otilde:String.fromCharCode(245),ouml:String.fromCharCode(246),divide:String.fromCharCode(247),oslash:String.fromCharCode(248),ugrave:String.fromCharCode(249),uacute:String.fromCharCode(250),ucirc:String.fromCharCode(251),uuml:String.fromCharCode(252),yacute:String.fromCharCode(253),thorn:String.fromCharCode(254),yuml:String.fromCharCode(255),OElig:String.fromCharCode(338),oelig:String.fromCharCode(339),Scaron:String.fromCharCode(352),scaron:String.fromCharCode(353),Yuml:String.fromCharCode(376),fnof:String.fromCharCode(402),circ:String.fromCharCode(710),tilde:String.fromCharCode(732),Alpha:String.fromCharCode(913),Beta:String.fromCharCode(914),Gamma:String.fromCharCode(915),Delta:String.fromCharCode(916),Epsilon:String.fromCharCode(917),Zeta:String.fromCharCode(918),Eta:String.fromCharCode(919),Theta:String.fromCharCode(920),Iota:String.fromCharCode(921),Kappa:String.fromCharCode(922),Lambda:String.fromCharCode(923),Mu:String.fromCharCode(924),Nu:String.fromCharCode(925),Xi:String.fromCharCode(926),Omicron:String.fromCharCode(927),Pi:String.fromCharCode(928),Rho:String.fromCharCode(929),Sigma:String.fromCharCode(931),Tau:String.fromCharCode(932),Upsilon:String.fromCharCode(933),Phi:String.fromCharCode(934),Chi:String.fromCharCode(935),Psi:String.fromCharCode(936),Omega:String.fromCharCode(937),alpha:String.fromCharCode(945),beta:String.fromCharCode(946),gamma:String.fromCharCode(947),delta:String.fromCharCode(948),epsilon:String.fromCharCode(949),zeta:String.fromCharCode(950),eta:String.fromCharCode(951),theta:String.fromCharCode(952),iota:String.fromCharCode(953),kappa:String.fromCharCode(954),lambda:String.fromCharCode(955),mu:String.fromCharCode(956),nu:String.fromCharCode(957),xi:String.fromCharCode(958),omicron:String.fromCharCode(959),pi:String.fromCharCode(960),rho:String.fromCharCode(961),sigmaf:String.fromCharCode(962),sigma:String.fromCharCode(963),tau:String.fromCharCode(964),upsilon:String.fromCharCode(965),phi:String.fromCharCode(966),chi:String.fromCharCode(967),psi:String.fromCharCode(968),omega:String.fromCharCode(969),thetasym:String.fromCharCode(977),upsih:String.fromCharCode(978),piv:String.fromCharCode(982),ensp:String.fromCharCode(8194),emsp:String.fromCharCode(8195),thinsp:String.fromCharCode(8201),zwnj:String.fromCharCode(8204),zwj:String.fromCharCode(8205),lrm:String.fromCharCode(8206),rlm:String.fromCharCode(8207),ndash:String.fromCharCode(8211),mdash:String.fromCharCode(8212),lsquo:String.fromCharCode(8216),rsquo:String.fromCharCode(8217),sbquo:String.fromCharCode(8218),ldquo:String.fromCharCode(8220),rdquo:String.fromCharCode(8221),bdquo:String.fromCharCode(8222),dagger:String.fromCharCode(8224),Dagger:String.fromCharCode(8225),bull:String.fromCharCode(8226),hellip:String.fromCharCode(8230),permil:String.fromCharCode(8240),prime:String.fromCharCode(8242),Prime:String.fromCharCode(8243),lsaquo:String.fromCharCode(8249),rsaquo:String.fromCharCode(8250),oline:String.fromCharCode(8254),frasl:String.fromCharCode(8260),euro:String.fromCharCode(8364),image:String.fromCharCode(8465),weierp:String.fromCharCode(8472),real:String.fromCharCode(8476),trade:String.fromCharCode(8482),alefsym:String.fromCharCode(8501),larr:String.fromCharCode(8592),uarr:String.fromCharCode(8593),rarr:String.fromCharCode(8594),darr:String.fromCharCode(8595),harr:String.fromCharCode(8596),crarr:String.fromCharCode(8629),lArr:String.fromCharCode(8656),uArr:String.fromCharCode(8657),rArr:String.fromCharCode(8658),dArr:String.fromCharCode(8659),hArr:String.fromCharCode(660),forall:String.fromCharCode(8704),part:String.fromCharCode(8706),exist:String.fromCharCode(8707),empty:String.fromCharCode(8709),nabla:String.fromCharCode(8711),isin:String.fromCharCode(8712),notin:String.fromCharCode(8713),ni:String.fromCharCode(8715),prod:String.fromCharCode(8719),sum:String.fromCharCode(8721),minus:String.fromCharCode(8722),lowast:String.fromCharCode(8727),radic:String.fromCharCode(8730),prop:String.fromCharCode(8733),infin:String.fromCharCode(8734),ang:String.fromCharCode(8736),and:String.fromCharCode(8743),or:String.fromCharCode(8744),cap:String.fromCharCode(8745),cup:String.fromCharCode(8746),int:String.fromCharCode(8747),there4:String.fromCharCode(8756),sim:String.fromCharCode(8764),cong:String.fromCharCode(8773),asymp:String.fromCharCode(8776),ne:String.fromCharCode(8800),equiv:String.fromCharCode(8801),le:String.fromCharCode(8804),ge:String.fromCharCode(8805),sub:String.fromCharCode(8834),sup:String.fromCharCode(8835),nsub:String.fromCharCode(8836),sube:String.fromCharCode(8838),supe:String.fromCharCode(8839),oplus:String.fromCharCode(8853),otimes:String.fromCharCode(8855),perp:String.fromCharCode(8869),sdot:String.fromCharCode(8901),lceil:String.fromCharCode(8968),rceil:String.fromCharCode(8969),lfloor:String.fromCharCode(8970),rfloor:String.fromCharCode(8971),lang:String.fromCharCode(9001),rang:String.fromCharCode(9002),loz:String.fromCharCode(9674),spades:String.fromCharCode(9824),clubs:String.fromCharCode(9827),hearts:String.fromCharCode(9829),diams:String.fromCharCode(9830)}},979304:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=n.__importStar(i(496486)),s=n.__importStar(i(516778)),a=i(217041),o=i(411444),l=i(471968);let d=class extends a.StoreBase{constructor(){super(),this._getImagePrefetchStateImpl=e=>{const t=this._prefetchStateCache.getOrSet(e,{state:l.ImagePrefetchState.Prefetching,retryCount:0});return t.state!==l.ImagePrefetchState.Prefetching&&(t.state=l.ImagePrefetchState.Prefetching),this._ongoingRequests[e]=s.Image.prefetch(e).then((t=>{const i=t?l.ImagePrefetchState.Prefetched:l.ImagePrefetchState.Failed;return this._updateImageState(e,i),this.trigger(e),delete this._ongoingRequests[e],t})).fail((i=>{t.retryCount<3?(++t.retryCount,this._prefetchStateCache.set(e,t),this._getImagePrefetchStateImpl(e)):(this._updateImageState(e,l.ImagePrefetchState.Failed),this.trigger(e),delete this._ongoingRequests[e])})),this._prefetchStateCache.getOrSet(e,t).state};const e={hashFn:e=>e,maxAge:18e4,maxSize:100,shouldProlongFn:e=>!r.includes([l.ImagePrefetchState.Failed,l.ImagePrefetchState.None],e.state)};this._prefetchStateCache=new o.SimpleLRUCache(e),this._ongoingRequests={}}_updateImageState(e,t){const i=this._prefetchStateCache.getOrSet(e,{state:t,retryCount:0});i.state!==t&&(i.state=t,this._prefetchStateCache.set(e,i))}isImagePrefetched(e,t=!0){const i=this._prefetchStateCache.get(e);if(i)return i.state===l.ImagePrefetchState.Prefetched;t&&this._getImagePrefetchStateImpl(e)}getImagePrefetchState(e){const t=this._prefetchStateCache.get(e);return t?t.state:this._getImagePrefetchStateImpl(e)}initNoSubscription(e){r.each(r.uniq(e),(e=>{if(this._ongoingRequests[e]||this._prefetchStateCache.get(e))return;const t={state:l.ImagePrefetchState.None,retryCount:0};this._prefetchStateCache.set(e,t),this._getImagePrefetchStateImpl(e)}))}};n.__decorate([a.autoSubscribe,n.__param(0,a.key)],d.prototype,"getImagePrefetchState",null),n.__decorate([a.disableWarnings],d.prototype,"initNoSubscription",null),d=n.__decorate([a.AutoSubscribeStore],d);const c=new d;t.default=c},913264:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=n.__importStar(i(496486)),s=n.__importDefault(i(189432)),a=n.__importStar(i(471968));class o{static getImages(e){const t=[];if(!e||!e.body)return t;if(e.backgroundImage){const i={url:e.backgroundImage.url,type:a.ElementTypeNames.image};o._fetchImagesFromElement(i,t)}return r.each(e.body,((e,i)=>o._fetchImagesFromElement(e,t))),t}static _fetchImagesFromElement(e,t){if(!e)return;const i=s.default.sanitizeElementType(e.type);if(i)switch(i){case a.ElementTypes.container:return o._fetchImageFromContainer(e,t);case a.ElementTypes.imageSet:return o._fetchImageFromImageSet(e,t);case a.ElementTypes.columnSet:return o._fetchImageFromColumnSet(e,t);case a.ElementTypes.column:return o._fetchImagesFromColumn(e,t);case a.ElementTypes.image:return t.push(e)}}static _fetchImageFromContainer(e,t){if(e&&(e.items&&r.each(e.items,((e,i)=>o._fetchImagesFromElement(e,t))),e.backgroundImage)){const i={url:e.backgroundImage.url,type:a.ElementTypeNames.image};o._fetchImagesFromElement(i,t)}}static _fetchImageFromColumnSet(e,t){e&&r.each(e.columns,((e,i)=>o._fetchImagesFromElement(e,t)))}static _fetchImagesFromColumn(e,t){if(e){if(e.backgroundImage){const i={url:e.backgroundImage.url,type:a.ElementTypeNames.image};o._fetchImagesFromElement(i,t)}r.each(e.items,((e,i)=>o._fetchImagesFromElement(e,t)))}}static _fetchImageFromImageSet(e,t){e&&r.each(e.images,((e,i)=>o._fetchImagesFromElement(e,t)))}}t.default=o},189432:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=n.__importStar(i(496486)),s=n.__importDefault(i(581911)),a=n.__importStar(i(471968)),o="imback";class l{static sanitizeAdaptiveCard(e,t=!0){if(!e)return;const i=t?r.cloneDeep(e):e,n=l._sanitizeElements(i.body),s=l._sanitizeActions(i.actions);if(r.isEmpty(n)&&r.isEmpty(s))return;const o=l._sanitizeText(i["-ms-source"]),d=l._sanitizeStringOrNumber(i["-ms-aspectRatio"]),c=l._sanitizeTextToLowerCase(i["-ms-height"]),h=l._sanitizeNumber(i["-ms-maxHeight"]),u=l._sanitizeAttribution(i["-ms-attribution"]);return{body:n,type:a.AdaptiveCardTypes.adaptiveCard,actions:s,version:i.version,minVersion:i.minVersion,fallbackText:i.fallbackText,speak:i.speak,backgroundImage:l._sanitizeBackgroundImage(i.backgroundImage),"-ms-source":o,"-ms-height":c,"-ms-maxHeight":h,"-ms-aspectRatio":d,"-ms-attribution":u}}static sanitizeElementType(e){if(!e)return;const t=e.toLowerCase();return r.some(a.ElementTypes,(e=>e===t))?t:void 0}static _sanitizeString(e){if(e&&"string"==typeof e)return e}static _sanitizeNumber(e){if(e&&"number"==typeof e)return e}static _sanitizeStringOrNumber(e){if(e)return"string"==typeof e?l._sanitizeString(e):"number"==typeof e?e.toString():void 0}static _sanitizeTextColor(e){let t=l._sanitizeString(e);if(t&&(t=t.toLowerCase(),r.some(a.TextColors,(e=>e===t))))return t}static _sanitizeBaseElement(e){if(!e)return;const t=l.sanitizeElementType(e.type);return t?{type:t,spacing:e.spacing,separator:e.separator}:void 0}static _sanitizeElement(e){if(!e)return;const t=l.sanitizeElementType(e.type);if(t)switch(t){case a.ElementTypes.container:return l._sanitizeContainer(e);case a.ElementTypes.imageSet:return l._sanitizeImageSet(e);case a.ElementTypes.columnSet:return l._sanitizeColumnSet(e);case a.ElementTypes.factSet:return l._sanitizeFactSet(e);case a.ElementTypes.image:return l._sanitizeImage(e);case a.ElementTypes.textBlock:return l._sanitizeTextBlock(e);case a.ElementTypes.inputText:return l._sanitizeInputText(e);case a.ElementTypes.inputDate:return l._sanitizeInputDate(e);case a.ElementTypes.inputTime:return l._sanitizeInputTime(e);case a.ElementTypes.inputNumber:return l._sanitizeInputNumber(e);case a.ElementTypes.inputToggle:return l._sanitizeInputToggle(e);case a.ElementTypes.inputChoiceSet:return l._sanitizeInputChoiceSet(e);default:return}}static _sanitizeElements(e){return r.compact(r.map(e,((e,t)=>l._sanitizeElement(e))))}static _sanitizeAction(e){if(!e||!e.type)return;const t=e.type.toLowerCase();if(!r.some(a.ActionTypes,(e=>e===t))&&t!==o)return;const i=l._sanitizeString(e.title);switch(t){case a.ActionTypes.actionOpenUrl:{const n=e.url;if(n)return{type:t,title:i,url:n};break}case a.ActionTypes.actionShowCard:{const n=e.card;if(n)return{type:t,title:i,card:l.sanitizeAdaptiveCard(n,!1)};break}case o:case a.ActionTypes.actionSubmit:{const t=e.data;return{type:a.ActionTypes.actionSubmit,title:i,data:t}}default:return}}static _sanitizeActions(e){const t=r.compact(r.map(e,((e,t)=>l._sanitizeAction(e))));return r.isEmpty(t)?void 0:t}static _sanitizeColumn(e){if(!e)return;const t=l._sanitizeBaseElement(e);return t&&t.type===a.ElementTypes.column?{type:t.type,spacing:t.spacing,separator:t.separator,id:e.id,width:l._sanitizeTextToLowerCase(e.width),pixelWidth:l._sanitizeNumber(e.pixelWidth),items:l._sanitizeElements(e.items)||[],selectAction:l._sanitizeAction(e.selectAction),backgroundImage:l._sanitizeBackgroundImage(e.backgroundImage),verticalContentAlignment:e.verticalContentAlignment}:void 0}static _sanitizeContainer(e){if(!e)return;const t=l._sanitizeBaseElement(e);return t&&t.type===a.ElementTypes.container?{type:t.type,spacing:t.spacing,separator:t.separator,id:e.id,items:l._sanitizeElements(e.items),selectAction:l._sanitizeAction(e.selectAction),style:e.style,height:e.height,backgroundImage:l._sanitizeBackgroundImage(e.backgroundImage)}:void 0}static _sanitizeFact(e){if(!e)return;let t=l._sanitizeText(e.title),i=l._sanitizeText(e.value);return t||i?(t=t||" ",i=i||" ",{title:t,value:i}):void 0}static _sanitizeFactSet(e){if(!e||!e.facts||r.isEmpty(e.facts))return;const t=l._sanitizeBaseElement(e);if(!t)return;if(t.type!==a.ElementTypes.factSet)return;const i=r.compact(r.map(e.facts,((e,t)=>l._sanitizeFact(e))));return r.isEmpty(i)?void 0:{type:t.type,spacing:t.spacing,separator:t.separator,id:e.id,facts:i}}static _sanitizeImage(e){if(!e||!e.url)return;const t=l._sanitizeBaseElement(e);return t&&t.type===a.ElementTypes.image&&e.url?{type:t.type,spacing:t.spacing,separator:t.separator,id:e.id,url:e.url,style:e.style,size:e.size,altText:e.altText,horizontalAlignment:e.horizontalAlignment,selectAction:l._sanitizeAction(e.selectAction)}:void 0}static _sanitizeBackgroundImage(e){if(!e)return;const t={url:""};if("string"==typeof e){const i=e;if(!i)return;t.url=i,t.mode="stretch"}else{const i=e;t.url=i.url,t.mode=i.mode,t.horizontalAlignment=i.horizontalAlignment,t.verticalAlignment=i.verticalAlignment,t["-ms-width"]=l._sanitizeNumber(i["-ms-width"]),t["-ms-height"]=l._sanitizeNumber(i["-ms-height"]),t["-ms-aspectRatio"]=l._sanitizeStringOrNumber(i["-ms-aspectRatio"])}return t}static _sanitizeImageSet(e){if(!e||!e.images||r.isEmpty(e.images))return;const t=l._sanitizeBaseElement(e);if(!t)return;if(t.type!==a.ElementTypes.imageSet)return;const i=r.compact(r.map(e.images,((e,t)=>l._sanitizeImage(e))));return r.isEmpty(i)?void 0:{type:t.type,spacing:t.spacing,separator:t.separator,id:e.id,images:i,imageSize:e.imageSize}}static _sanitizeColumnSet(e){if(!e||!e.columns||r.isEmpty(e.columns))return;const t=l._sanitizeBaseElement(e);if(!t)return;if(t.type!==a.ElementTypes.columnSet)return;const i=r.compact(r.map(e.columns,((e,t)=>l._sanitizeColumn(e))));return r.isEmpty(i)?void 0:{type:t.type,spacing:t.spacing,separator:t.separator,id:e.id,columns:i,height:e.height,selectAction:l._sanitizeAction(e.selectAction)}}static _sanitizeText(e){const t=l._sanitizeString(e);if(!t)return;let i=s.default.unescapeXml(t.trim());return 0!==i.length?(i.length>512&&(i=i.substring(0,512)),i=i.replace(/\r/g,"\n"),i):void 0}static _sanitizeTextToLowerCase(e){const t=l._sanitizeText(e);return t?t.toLowerCase():void 0}static _sanitizeTextBlock(e){if(!e||!e.text)return;const t=l._sanitizeBaseElement(e);if(!t)return;if(t.type!==a.ElementTypes.textBlock)return;const i=l._sanitizeText(e.text);if(!i)return;const n=e.maxLines?Math.min(e.maxLines,20):void 0;return{type:t.type,spacing:t.spacing,separator:t.separator,id:e.id,text:i,size:e.size,weight:e.weight,color:l._sanitizeTextColor(e.color),isSubtle:e.isSubtle,maxLines:n,horizontalAlignment:e.horizontalAlignment,wrap:e.wrap}}static _sanitizeInputText(e){if(!e)return;const t=l._sanitizeBaseElement(e);if(!t)return;if(t.type!==a.ElementTypes.inputText)return;const i=e.maxLength||void 0;return{type:t.type,spacing:t.spacing,separator:t.separator,id:e.id,isMultiline:e.isMultiline,maxLength:i,placeholder:l._sanitizeString(e.placeholder),style:l._sanitizeString(e.style),value:l._sanitizeString(e.value)}}static _sanitizeInputNumber(e){if(!e)return;const t=l._sanitizeBaseElement(e);return t&&t.type===a.ElementTypes.inputNumber?{type:t.type,spacing:t.spacing,separator:t.separator,id:e.id,max:l._sanitizeNumber(e.max),min:l._sanitizeNumber(e.min),placeholder:l._sanitizeString(e.placeholder),value:l._sanitizeNumber(e.value)}:void 0}static _sanitizeInputDate(e){if(!e)return;const t=l._sanitizeBaseElement(e);return t&&t.type===a.ElementTypes.inputDate?{type:t.type,spacing:t.spacing,separator:t.separator,id:e.id,max:l._sanitizeString(e.max),min:l._sanitizeString(e.min),placeholder:l._sanitizeString(e.placeholder),value:l._sanitizeString(e.value)}:void 0}static _sanitizeInputTime(e){if(!e)return;const t=l._sanitizeBaseElement(e);return t&&t.type===a.ElementTypes.inputTime?{type:t.type,spacing:t.spacing,separator:t.separator,id:e.id,max:l._sanitizeString(e.max),min:l._sanitizeString(e.min),placeholder:l._sanitizeString(e.placeholder),value:l._sanitizeString(e.value)}:void 0}static _sanitizeInputToggle(e){if(!e)return;const t=l._sanitizeBaseElement(e);if(!t)return;if(t.type!==a.ElementTypes.inputToggle)return;const i=l._sanitizeString(e.title);return i?{type:t.type,spacing:t.spacing,separator:t.separator,id:e.id,title:i,value:l._sanitizeString(e.value),valueOff:l._sanitizeString(e.valueOff),valueOn:l._sanitizeString(e.valueOn)}:void 0}static _sanitizeInputChoiceSet(e){if(!e||!e.choices||r.isEmpty(e.choices))return;const t=l._sanitizeBaseElement(e);if(!t)return;if(t.type!==a.ElementTypes.inputChoiceSet)return;const i=r.compact(r.map(e.choices,((e,t)=>l._sanitizeInputChoice(e))));if(r.isEmpty(i))return;const n=l._sanitizeString(e.value);return n?{type:t.type,spacing:t.spacing,separator:t.separator,id:e.id,choices:i,isMultiSelect:e.isMultiSelect,style:l._sanitizeString(e.style),value:n}:void 0}static _sanitizeInputChoice(e){if(!e)return;const t=l._sanitizeString(e.title),i=l._sanitizeString(e.value);return t&&i?{type:a.InputChoiceTypes.inputChoice,title:t,value:i}:void 0}static _sanitizeAttribution(e){if(!e||!e.text)return;return l._sanitizeText(e.text)?{text:l._sanitizeText(e.text)||"",icon:e.icon}:void 0}}t.default=l},950527:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(471968);class r{static getPlatform(){return this._environmentInfo.platform}static getShell(){return this._environmentInfo.shell}static isWindows(){return this.getPlatform()===n.EnvironmentPlatforms.windows}static initialize(e){this.initialized||(this._environmentInfo=e)}static get keyArrowDown(){return this.getShell()===n.EnvironmentShells.reactNative?20:40}static get keyArrowUp(){return this.getShell()===n.EnvironmentShells.reactNative?19:38}}r._environmentInfo={platform:n.EnvironmentPlatforms.unknown,shell:n.EnvironmentShells.unknown},r.initialized=!1,t.default=r},523054:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=n.__importStar(i(496486)),s=n.__importDefault(i(714518)),a=n.__importStar(i(471968));class o{static sanitizeHostConfig(e){if(e&&!r.isEmpty(e))return r.compact(r.map(r.isArray(e)?e:[e],(e=>{if(e)return o._sanitize(e)})))}static _sanitize(e){const t=s.default.getDefaultHostConfig();return o._sanitizeActions(e.actions,t.actions),o._sanitizeAdaptiveCard(e.adaptiveCard,t.adaptiveCard),o._sanitizeChoiceSet(e.choiceSet,t.choiceSet),o._sanitizeContainer(e.container,t.container),o._sanitizeImageSizes(e.imageSizes,t.imageSizes),o._sanitizeFactSet(e.factSet,t.factSet),r.isString(e.fontFamily)&&(t.fontFamily=e.fontFamily),o._sanitizeFontSizes(e.fontSizes,t.fontSizes),o._sanitizeFontWeights(e.fontWeights,t.fontWeights),o._sanitizeSeparation(e.separator,t.separator),o._sanitizeSpacing(e.spacing,t.spacing),o._sanitizeAttribuion(e.attribution,t.attribution),r.isBoolean(e.supportsInteractivity)&&(t.supportsInteractivity=e.supportsInteractivity),t}static _sanitizeActions(e,t){if(e){if(r.isString(e.actionsOrientation)){const i=e.actionsOrientation.toLowerCase();r.some(a.ActionsOrientationTypes,(e=>e===i))&&(t.actionsOrientation=i)}if(r.isString(e.actionAlignment)){const i=e.actionAlignment.toLowerCase();r.some(a.ActionAlignmentTypes,(e=>e===i))&&(t.actionAlignment=i)}if(r.isNumber(e.buttonSpacing)&&(t.buttonSpacing=e.buttonSpacing),r.isNumber(e.maxActions)&&(t.maxActions=e.maxActions),r.isString(e.spacing)){const i=e.spacing.toLowerCase();r.some(a.SpacingStyles,(e=>e===i))&&(t.spacing=i)}o._sanitizeShowCard(e.showCard,t.showCard),r.isNumber(e.scrollBarPadding)&&(t.scrollBarPadding=e.scrollBarPadding)}}static _sanitizeShowCard(e,t){if(e){if(r.isString(e.actionMode)){const i=e.actionMode.toLowerCase();r.some(a.ShowActionModeTypes,(e=>e===i))&&(t.actionMode=i)}r.isString(e.backgroundColor)&&(t.backgroundColor=e.backgroundColor),r.isNumber(e.inlineTopMargin)&&(t.inlineTopMargin=e.inlineTopMargin),e.padding&&(t.padding=e.padding)}}static _sanitizeAdaptiveCard(e,t){e&&(r.isBoolean(e.allowCustomStyle)&&(t.allowCustomStyle=e.allowCustomStyle),r.isString(e.backgroundColor)&&(t.backgroundColor=e.backgroundColor),o._sanitizeSpacingDefinition(e.padding,t.padding))}static _sanitizeChoiceSet(e,t){e&&o._sanitizeSeparation(e.separation,t.separation)}static _sanitizeContainer(e,t){e&&(o._sanitizeContainerStyleConfig(e.default,t.default),o._sanitizeContainerStyleConfig(e.emphasis,t.emphasis),o._sanitizeSeparation(e.separation,t.separation))}static _sanitizeContainerStyleConfig(e,t){if(e){r.isString(e.backgroundColor)&&(t.backgroundColor=e.backgroundColor),r.isString(e.borderColor)&&(t.borderColor=e.borderColor),o._sanitizeSpacingDefinition(e.borderThickness,t.borderThickness);const i=e.foregroundColors,n=t.foregroundColors;i&&(o._sanitizeColorConfig(i.accent,n.accent),o._sanitizeColorConfig(i.attention,n.attention),o._sanitizeColorConfig(i.dark,n.dark),o._sanitizeColorConfig(i.default,n.default),o._sanitizeColorConfig(i.good,n.good),o._sanitizeColorConfig(i.light,n.light),o._sanitizeColorConfig(i.warning,n.warning)),o._sanitizeSpacingDefinition(e.padding,t.padding)}}static _sanitizeImageSizes(e,t){e&&(r.isNumber(e.small)&&(t.small=e.small),r.isNumber(e.medium)&&(t.medium=e.medium),r.isNumber(e.large)&&(t.large=e.large))}static _sanitizeTextConfig(e,t){if(e){if(r.isString(e.color)){const i=e.color.toLowerCase();r.some(a.TextColors,(e=>e===i))&&(t.color=i)}if(r.isBoolean(e.isSubtle)&&(t.isSubtle=e.isSubtle),r.isString(e.size)){const i=e.size.toLowerCase();r.some(a.TextSizes,(e=>e===i))&&(t.size=i)}if(r.isString(e.weight)){const i=e.weight.toLowerCase();r.some(a.TextWeights,(e=>e===i))&&(t.weight=i)}r.isBoolean(e.wrap)&&(t.wrap=e.wrap)}}static _sanitizeFactSet(e,t){e&&(o._sanitizeTextConfig(e.title,t.title),o._sanitizeTextConfig(e.value,t.value),o._sanitizeSeparation(e.separation,t.separation),r.isNumber(e.spacing)&&(t.spacing=e.spacing))}static _sanitizeFontSizes(e,t){e&&(r.isNumber(e.small)&&(t.small=e.small),r.isNumber(e.default)&&(t.default=e.default),r.isNumber(e.medium)&&(t.medium=e.medium),r.isNumber(e.large)&&(t.large=e.large),r.isNumber(e.extraLarge)&&(t.extraLarge=e.extraLarge))}static _sanitizeFontWeights(e,t){e&&(t.lighter=o._sanitizeFontWeight(e.lighter,t.lighter),t.default=o._sanitizeFontWeight(e.default,t.default),t.bolder=o._sanitizeFontWeight(e.bolder,t.bolder))}static _sanitizeSpacing(e,t){e&&(r.isNumber(e.none)&&(t.none=e.none),r.isNumber(e.small)&&(t.small=e.small),r.isNumber(e.default)&&(t.default=e.default),r.isNumber(e.medium)&&(t.medium=e.medium),r.isNumber(e.large)&&(t.large=e.large),r.isNumber(e.extraLarge)&&(t.extraLarge=e.extraLarge),r.isNumber(e.padding)&&(t.padding=e.padding))}static _sanitizeFontWeight(e,t){return r.isString(e)&&r.some(a.FontWeights,(t=>t===e.toLowerCase()))?e:t}static _sanitizeColorConfig(e,t){e&&(r.isString(e.default)&&(t.default=e.default),r.isString(e.subtle)&&(t.subtle=e.subtle))}static _sanitizeSpacingDefinition(e,t){e&&(r.isNumber(e.top)&&(t.top=e.top),r.isNumber(e.left)&&(t.left=e.left),r.isNumber(e.right)&&(t.right=e.right),r.isNumber(e.bottom)&&(t.bottom=e.bottom))}static _sanitizeSeparation(e,t){e&&t&&(r.isString(e.lineColor)&&(t.lineColor=e.lineColor),r.isNumber(e.lineThickness)&&(t.lineThickness=e.lineThickness),r.isNumber(e.spacing)&&(t.spacing=e.spacing))}static _sanitizeAttribuion(e,t){e&&t&&(r.isString(e.color)&&(t.color=e.color),r.some(a.TextSizes,(t=>t===e.size))&&(t.size=e.size))}}t.default=o},714518:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=n.__importStar(i(496486)),s=n.__importStar(i(471968));const a=new class{mergeHostConfigs(e){let t=this.getDefaultHostConfig();return r.each(r.isArray(e)?e:[e],(e=>{e&&(t=this._mergeConfigs(t,e))})),r.cloneDeep(t)}getDefaultHostConfig(){return this._defaultHostConfig||(this._defaultHostConfig={actions:this._getActionsConfigDefaults(),adaptiveCard:this._getAdaptiveCardConfigDefaults(),choiceSet:this._getChoiceSetConfigDefaults(),column:this._getColumnConfigDefaults(),columnSet:this._getColumnSetConfigDefaults(),container:this._getContainerConfigDefaults(),dateInput:this._getDateInputConfigDefaults(),factSet:this._getFactSetConfigDefaults(),fontFamily:'"SF Regular", "Segoe System UI Regular", "Segoe UI Regular", sans-serif',fontSizes:this._getFontSizesConfigDefaults(),fontWeights:this._getFontWeightsConfigDefaults(),image:this._getImageConfigDefaults(),imageSet:this._getImageSetConfigDefaults(),imageSizes:this._getImageSizesConfigDefaults(),numberInput:this._getNumberInputConfigDefaults(),separator:this._getSeparationConfigDefaults(),spacing:this._getSpacingConfigDefaults(),textBlock:this._getTextBlockConfigDefaults(),textInput:this._getTextInputConfigDefaults(),timeInput:this._getTimeInputConfigDefaults(),toggleInput:this._getToggleInputConfigDefaults(),attribution:this._getAttributionConfigDefaults(),supportsInteractivity:!0}),this._defaultHostConfig}_mergeConfigs(e,t){return r.merge(e,t)}_getActionsConfigDefaults(){return{actionsOrientation:s.ActionsOrientationTypes.horizontal,actionAlignment:s.ActionAlignmentTypes.center,buttonSpacing:10,maxActions:5,spacing:s.SpacingStyles.none,showCard:{actionMode:s.ShowActionModeTypes.inline,backgroundColor:"#FFF8F8F8",inlineTopMargin:10,padding:{left:10,right:10,top:8,bottom:8}},scrollBarPadding:0}}_getAdaptiveCardConfigDefaults(){return{allowCustomStyle:!1,backgroundColor:"#FFFFFFFF",padding:{left:10,right:10,top:8,bottom:8},borderWidth:1}}_getChoiceSetConfigDefaults(){return{separation:{lineColor:"#EEEEEE",lineThickness:0,spacing:0}}}_getColumnConfigDefaults(){return{separation:this._getSeparationConfigDefaults()}}_getColumnSetConfigDefaults(){return{separation:this._getSeparationConfigDefaults()}}_getDateInputConfigDefaults(){return{separation:this._getSeparationConfigDefaults()}}_getContainerConfigDefaults(){return{default:{backgroundColor:"#FFFFFFFF",borderColor:"#00000000",borderThickness:{top:0,left:0,right:0,bottom:0},foregroundColors:{accent:{default:"#1686D9",subtle:"rgba(22, 134, 217, 0.5)"},attention:{default:"#F44336",subtle:"rgba(244, 67, 54, 0.8)"},dark:{default:"#8A8D91",subtle:"#FFFFFF"},default:{default:"#2B2C33",subtle:"#8A8D91"},good:{default:"#4CAF50",subtle:"rgba(76, 175, 80, 0.8)"},light:{default:"#000000",subtle:"#8A8D91"},warning:{default:"#F0C01E",subtle:"rgba(240, 192, 30, 0.8)"}},padding:{top:0,left:0,right:0,bottom:0}},emphasis:{backgroundColor:"#EEEEEE",borderColor:"#00000000",borderThickness:{top:0,left:0,right:0,bottom:0},foregroundColors:{accent:{default:"#1686D9",subtle:"rgba(22, 134, 217, 0.5)"},attention:{default:"#F44336",subtle:"rgba(244, 67, 54, 0.8)"},dark:{default:"#8A8D91",subtle:"#FFFFFF"},default:{default:"#2B2C33",subtle:"#8A8D91"},good:{default:"#4CAF50",subtle:"rgba(76, 175, 80, 0.8)"},light:{default:"#000000",subtle:"#8A8D91"},warning:{default:"#F0C01E",subtle:"rgba(240, 192, 30, 0.8)"}},padding:{top:0,left:0,right:0,bottom:0}}}}_getImageConfigDefaults(){return{separation:this._getSeparationConfigDefaults()}}_getImageSizesConfigDefaults(){return{small:40,medium:80,large:160}}_getImageSetConfigDefaults(){return{imageSize:s.ImageSizes.medium,separation:this._getSeparationConfigDefaults()}}_getFactSetConfigDefaults(){return{title:{color:s.TextColors.default,isSubtle:!1,size:s.TextSizes.default,weight:s.TextWeights.bolder,wrap:!0},value:{color:s.TextColors.default,isSubtle:!1,size:s.TextSizes.default,weight:s.TextWeights.default,wrap:!0},separation:this._getSeparationConfigDefaults(),spacing:10}}_getFontSizesConfigDefaults(){return{small:11,default:12,medium:14,large:16,extraLarge:24}}_getFontWeightsConfigDefaults(){return{lighter:s.FontWeights[200],default:s.FontWeights[400],bolder:s.FontWeights[600]}}_getNumberInputConfigDefaults(){return{separation:this._getSeparationConfigDefaults()}}_getSeparationConfigDefaults(){return{lineColor:"#EEEEEE",lineThickness:0,spacing:8}}_getSpacingConfigDefaults(){return{none:0,small:3,default:8,medium:20,large:30,extraLarge:40,padding:10}}_getTextBlockConfigDefaults(){return{timeFormat:"hh:mm A",compactDateFormat:"M/D/YY",longDateFormat:"dddd, MMMM Do YYYY",shortDateFormat:"MM/DD/YYYY"}}_getTextInputConfigDefaults(){return{separation:this._getSeparationConfigDefaults()}}_getTimeInputConfigDefaults(){return{separation:this._getSeparationConfigDefaults()}}_getToggleInputConfigDefaults(){return{separation:this._getSeparationConfigDefaults()}}_getAttributionConfigDefaults(){return{color:"#8a8d91"}}};t.default=a},982880:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582).__importStar(i(496486));t.default=class{static getAvailableHeight(e,t,i){if(n.isUndefined(i)||n.isUndefined(t)||n.isUndefined(e)||t>i)return;if(e<=0||i<=0)return 0;const r=Math.min(i-t,e);return Math.max(r,0)}}},411444:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleLRUCache=void 0;const n=i(197582).__importStar(i(496486));t.SimpleLRUCache=class{constructor(e){this._cache={},this._hashFn=e.hashFn,this._ttl=e.maxAge?e.maxAge:3e4,this._maxSize=e.maxSize?e.maxSize:30,this._shouldProlongFn=e.shouldProlongFn?e.shouldProlongFn:e=>!0,this._lastEviction=Date.now()}set(e,t){const i=Date.now();if(n.size(this._cache)>=this._maxSize){const e=(e,t)=>this._cache[e].timestamp<this._cache[t].timestamp?e:t,t=e=>delete this._cache[e];t(n.keys(this._cache).reduce(e))}this._cache[this._hashFn(e)]={timestamp:i,value:t}}get(e){this._evict();const t=this._cache[this._hashFn(e)];if(t)return this._shouldProlongFn(t.value)&&(t.timestamp=Date.now()),t.value}getOrSet(e,t){const i=this.get(e);return i||(this.set(e,t),t)}_evict(){const e=Date.now()-this._ttl;if(this._lastEviction>e)return;this._lastEviction=Date.now();n.keys(this._cache).filter((t=>this._cache[t].timestamp<e)).forEach((e=>delete this._cache[e]))}}},581911:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582).__importStar(i(496486)),r=i(654442),s=/#([0-9A-F]{2})([0-9A-F]{2})([0-9A-F]{2})([0-9A-F]{2})?/gi,a=/&(?:#x([0-9a-fA-F]+)|#(\d+)|([a-zA-Z]+));/g,o={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"};t.default=class{static stringToCssColor(e){const t=s.exec(e);if(!t||!t[4])return e;const i=parseInt(t[1],16)/255;return"rgba("+parseInt(t[2],16)+","+parseInt(t[3],16)+","+parseInt(t[4],16)+","+i+")"}static unescapeXml(e){if(!e)return e;const t=e.replace(a,((e,t,i,n)=>t?String.fromCharCode(parseInt(t,16)):i?String.fromCharCode(parseInt(i,10)):n&&r.XmlAndHtmlEntities.hasOwnProperty(n)?r.XmlAndHtmlEntities[n]:e));return a.lastIndex=0,t}static sanitizeString(e){return e.replace(/[<>"'`]|&(?!(?:amp|lt|gt|quot|apos|#x?\d+);)/g,(e=>o[e]))}static stringToAspectRatio(e){if(!e)return;const t=e.split(":",2);if(n.isEmpty(t)){const t=parseFloat(e);return!n.isNaN(t)&&t?t:void 0}const i=parseFloat(t[0]),r=parseFloat(t[1]);return!n.isNaN(i)&&!n.isNaN(r)&&i&&r?i/r:void 0}static inputChoiceAccessibilityLabel(e,t,i){return i?i.replace("{text}",t):e?t+", selected":t+", not selected"}}},389008:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(860745),t);var r=i(860745);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},131813:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582).__importStar(i(397691));t.default=new class{getAdId(){return n.Rejected("AdID not available")}}},415642:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(131813),t);var r=i(131813);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},272078:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AEAnimationBase=void 0;const n=i(197582).__importStar(i(516778));class r extends n.Component{constructor(e){super(e)}}t.AEAnimationBase=r},198243:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(116226),t);var r=i(116226);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},116226:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=n.__importStar(i(516778)),a=n.__importStar(i(275009)),o=i(272078);class l extends o.AEAnimationBase{constructor(){super(...arguments),this._onDivRef=e=>{this._divRef=e||void 0}}componentDidMount(){if(this._divRef){const e={container:this._divRef,renderer:"svg",loop:this.props.loop||!1,rendererSettings:{progressiveLoad:!1},animationData:this.props.source};this._anim=a.loadAnimation(e),this._anim.setSpeed(this.props.speed||1)}}componentWillUnmount(){var e;null===(e=this._anim)||void 0===e||e.destroy()}play(){var e;null===(e=this._anim)||void 0===e||e.play()}reset(){var e;null===(e=this._anim)||void 0===e||e.goToAndStop(0,!1)}render(){const e=s.Styles.combine(this.props.style);return(0,r.jsx)("div",{ref:this._onDivRef,style:e})}}t.default=l},91100:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AppCenterBase=void 0;t.AppCenterBase=class{}},216518:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582).__importStar(i(397691)),r=i(91100);class s extends r.AppCenterBase{configure(e){}configureAttachment(e){}start(){}checkForUpdates(){}addCrashMetadata(e){}didCrashInLastSession(){return n.Resolved(!1)}}t.default=new s},309628:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(216518),t);var r=i(216518);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},304149:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AssetReaderBase=void 0;t.AssetReaderBase=class{}},627212:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(792293),t);var r=i(792293);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},792293:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(662783),r=i(304149);class s extends r.AssetReaderBase{readAssetFile(e){return new n.SimpleWebRequest("GET",e,{}).start().then((e=>JSON.stringify(e.body)))}}t.default=new s},517441:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AudioPlayerBase=t.AudioPlayerSoundType=void 0;const n=i(197582).__importStar(i(516778));var r;!function(e){e[e.Default=0]="Default",e[e.Media=1]="Media",e[e.Ringtone=2]="Ringtone",e[e.System=3]="System"}(r||(t.AudioPlayerSoundType=r={}));t.AudioPlayerBase=class{constructor(){this.progressEvent=new n.Types.SubscribableEvent,this.loadedEvent=new n.Types.SubscribableEvent,this.endedEvent=new n.Types.SubscribableEvent,this.errorEvent=new n.Types.SubscribableEvent}}},782118:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});i(197582).__exportStar(i(853112),t)},853112:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AudioPlayer=t.Audio=t.AudioPlayerSoundType=void 0;const n=i(197582),r=i(174958),s=n.__importStar(i(167606)),a=i(517441),o=n.__importDefault(i(606617));var l=i(517441);Object.defineProperty(t,"AudioPlayerSoundType",{enumerable:!0,get:function(){return l.AudioPlayerSoundType}});t.Audio=class{static openFile(e,t,i){return new d(e,t)}};class d extends a.AudioPlayerBase{constructor(e,t){super(),this._mySound=new Audio,this._mySound.appendChild(this._getAudioSource(e,t)),this._mySound.preload="none",this._bufferedDuration=0,this._mySound.addEventListener("progress",(()=>{const e=this._mySound.buffered;let t=0;for(let i=0;i<e.length;i++)if(0===e.start(i)){t=e.end(i);break}this._bufferedDuration!==t&&(this._bufferedDuration=t,this._emitProgressUpdateEvent())}),!0),this._mySound.addEventListener("timeupdate",(()=>{this._emitProgressUpdateEvent()}),!0),this._mySound.addEventListener("loadedmetadata",(()=>{this.loadedEvent.fire({duration:this._mySound.duration})}),!0),this._mySound.addEventListener("error",(e=>{this.errorEvent.fire(e)}),!0),this._mySound.preload="auto"}_getAudioSource(e,t){const i=document.createElement("source");return""!==t&&(i.type=o.default.getAudioFileContentTypeFromExtension(t)),i.src=e,i}_emitProgressUpdateEvent(){this.progressEvent.fire(this._getProgress())}play(e,t){try{this._mySound.loop=e,this._mySound.onended=()=>{this.endedEvent.fire()},this._mySound.play()}catch(e){s.error(s.LogTraceArea.AudioPlayer,"Caught exception on SoundPlayer.play: "+r.pii.Omit(e))}}stop(){try{this._mySound.pause(),this._mySound.currentTime=0}catch(e){s.error(s.LogTraceArea.AudioPlayer,"Caught exception on SoundPlayer.stop: "+r.pii.Omit(e))}}release(){this.stop()}pause(){try{this._mySound.pause()}catch(e){s.error(s.LogTraceArea.AudioPlayer,"Caught exception on SoundPlayer.pause: "+r.pii.Omit(e))}}seek(e){try{this._mySound.currentTime=e}catch(e){s.error(s.LogTraceArea.AudioPlayer,"Caught exception on SoundPlayer.seek: "+r.pii.Omit(e))}}setSpeed(e,t=!0){try{this._mySound.playbackRate=e}catch(e){s.error(s.LogTraceArea.AudioPlayer,"Caught exception on SoundPlayer.setSpeed: "+r.pii.Omit(e))}}_getProgress(){return{currentPosition:this._mySound.currentTime,bufferedDuration:this._bufferedDuration}}getDuration(){return this._mySound.duration}setOutputDevice(e,t){return"setSinkId"in this._mySound?this._mySound.setSinkId(t):Promise.resolve()}setVolume(e){try{this._mySound.volume=e}catch(e){s.error(s.LogTraceArea.AudioPlayer,"Caught exception on SoundPlayer.setVolume: "+r.pii.Omit(e))}}getVolume(){return this._mySound.volume}setMuted(e){try{this._mySound.muted=e}catch(e){s.error(s.LogTraceArea.AudioPlayer,"Caught exception on SoundPlayer.setMuted: "+r.pii.Omit(e))}}getMuted(){return this._mySound.muted}}t.AudioPlayer=d},965193:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BackgroundExecutionBase=void 0;t.BackgroundExecutionBase=class{}},196475:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BackgroundExecution=void 0;const n=i(197582).__importStar(i(397691)),r=i(965193);class s extends r.BackgroundExecutionBase{constructor(){super(...arguments),this._count=1}requestTime(e,t){return this._count++,n.Resolved(this._count.toString())}requestMaxTime(e){return this._count++,n.Resolved(this._count.toString())}release(e,t){return n.Resolved()}releaseAll(e){return n.Resolved()}}t.BackgroundExecution=s,t.default=new s},819059:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(196475),t);var r=i(196475);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},934635:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BackgroundTimerBase=void 0;t.BackgroundTimerBase=class{}},31086:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BackgroundTimer=void 0;const n=i(934635);class r extends n.BackgroundTimerBase{constructor(){super(),"undefined"!=typeof window?this._timerSource=window:void 0!==i.g&&(this._timerSource=i.g)}setTimeout(e,t,...i){return this._timerSource.setTimeout(e,Math.max(0,t),...i)}setInterval(e,t,...i){return this._timerSource.setInterval(e,Math.max(0,t),...i)}setExpiration(e,t){return this.setTimeout(e,t-Date.now())}clearTimeout(e){return this._timerSource.clearTimeout(e)}clearInterval(e){return this._timerSource.clearInterval(e)}clearExpiration(e){return this.clearTimeout(e)}}t.BackgroundTimer=r,t.default=new r},55331:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(31086),t);var r=i(31086);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},566697:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.BlurStyle=void 0,function(e){e[e.Dark=0]="Dark",e[e.Light=1]="Light",e[e.ExtraLight=2]="ExtraLight"}(i||(t.BlurStyle=i={}))},234065:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BlurView=t.BlurStyle=void 0;const n=i(197582),r=i(785893),s=n.__importStar(i(516778)),a=i(566697);Object.defineProperty(t,"BlurStyle",{enumerable:!0,get:function(){return a.BlurStyle}});const o=(0,i(26703).lazyProperties)({dark:()=>s.Styles.createViewStyle({backgroundColor:"rgba(0, 0, 0, 0.7)"}),light:()=>s.Styles.createViewStyle({backgroundColor:"rgba(255, 255, 255, 0.7)"}),extraLight:()=>s.Styles.createViewStyle({backgroundColor:"rgba(255, 255, 255, 0.9)"})});class l extends s.Component{render(){let e;if(this.props.opacity)if(this.props.blurStyle===a.BlurStyle.Dark){const t=`rgba(0, 0, 0, ${this.props.opacity})`;e=s.Styles.createViewStyle({backgroundColor:t},!1)}else{const t=`rgba(255, 255, 255, ${this.props.opacity})`;e=s.Styles.createViewStyle({backgroundColor:t},!1)}else e=this._convertBlurStyleEnumToStyle(this.props.blurStyle);const t=s.Styles.combine(e,this.props.style);return(0,r.jsx)(s.View,{style:t})}_convertBlurStyleEnumToStyle(e){switch(e){case a.BlurStyle.Dark:return o.dark;case a.BlurStyle.Light:return o.light;case a.BlurStyle.ExtraLight:return o.extraLight}}}t.BlurView=l,t.default=l},464291:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(234065),t);var r=i(234065);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},847293:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(525198),t);var r=i(525198);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},525198:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=n.__importStar(i(516778)),s=n.__importStar(i(397691));t.default=new class{prefetchImageAndGetCachedPath(e){return r.Image.prefetch(e).then((e=>{}))}setQueryCacheInFlightLimit(e){}isImageCached(e){return s.Resolved(void 0)}queryCache(e){return s.Resolved([])}prefetch(e){return r.Image.prefetch(e)}}},521745:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Calendar=void 0;t.Calendar=class{}},124664:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CommonCalendar=void 0;const n=i(521745);class r extends n.Calendar{showCalendar(e){}createEvent(e,t,i,n){}}t.CommonCalendar=r,t.default=new r},28766:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(124664),t);var r=i(124664);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},288824:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.IntentEventType=void 0,function(e){e.call="call",e.dial="dial",e.contactPhone="contactPhone",e.contactAudio="contactAudio",e.contactVideo="contactVideo",e.contactMessage="contactMessage"}(i||(t.IntentEventType=i={}))},794863:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IntentEventType=void 0;const n=i(288824);Object.defineProperty(t,"IntentEventType",{enumerable:!0,get:function(){return n.IntentEventType}});t.default=new class{setListener(e){}removeListener(){}}},314210:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(794863),t);var r=i(794863);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},744950:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582).__importStar(i(397691));t.default=new class{getReferrer(){return n.Resolved("")}}},783509:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(744950),t);var r=i(744950);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},951394:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=n.__importStar(i(397691)),s=n.__importDefault(i(220534));t.default=class{constructor(e){this._config=e}getRequestUrl(){return s.default.addUrlParameter(this._config.url+this._config.path,"n",Date.now().toString())}checkConnectivity(){const e=this.getRequestUrl(),t=fetch(e,{method:"GET",headers:{Accept:"text/plain","Content-Type":"text/plain","Cache-Control":"no-cache, no-store, must-revalidate"},redirect:"manual",credentials:"omit"});return r.raceTimer(r.fromThenable(t),this._config.timeout).then((e=>{if(e.timedOut||void 0===e.result)return r.Rejected({timedOut:!0});const t=e.result;return r.fromThenable(t.text()).then((e=>r.Resolved({connected:this.isConnected(t.status,e),statusCode:t.status,responseLength:e?e.length:0}))).catch((e=>r.Resolved({connected:!0,statusCode:t.status,responseLength:void 0})))})).catch((e=>{const t=e&&e.message?e.message.toString():void 0;return r.Rejected({statusText:t})}))}isConnected(e,t){return e>=500||e===this._config.statusCode&&t===this._config.expectedContent}}},129528:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConnectivityCheckFactory=void 0;const n=i(197582),r=n.__importStar(i(397691)),s=n.__importDefault(i(951394));class a{isDetectionSupported(){return!0}getClient(e){return new s.default(e)}canBypassNetworkAvailability(){return r.Resolved(!1)}}t.ConnectivityCheckFactory=a,t.default=new a},55003:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(279438),t);var r=i(279438);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},279438:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(129528);class r extends n.ConnectivityCheckFactory{isDetectionSupported(){return!1}}t.default=new r},973949:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CommandInvokerBase=void 0;const n=i(197582).__importStar(i(516778));t.CommandInvokerBase=class{constructor(){this.onLoginCommand=new n.Types.SubscribableEvent,this.onLogoutCommand=new n.Types.SubscribableEvent,this.onStartCallCommand=new n.Types.SubscribableEvent,this.onAnswerCallCommand=new n.Types.SubscribableEvent,this.onHangupCallCommand=new n.Types.SubscribableEvent,this.onMuteUnmuteCallCommand=new n.Types.SubscribableEvent}}},799483:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CommandInvoker=void 0;const n=i(973949);class r extends n.CommandInvokerBase{beginReceivingEvents(){}}t.CommandInvoker=r,t.default=new r},965866:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(799483),t);var r=i(799483);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},417009:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AddressBookBase=void 0;const n=i(197582).__importDefault(i(974634));t.AddressBookBase=class{constructor(){this.updateContacts=new n.default}}},677590:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AddressBook=void 0;const n=i(197582).__importStar(i(397691)),r=i(417009);class s extends r.AddressBookBase{registerForAddressBookChanges(){}unregisterFromAddressBookChanges(){}getContactsCount(){return n.Resolved(0)}runAllTests(){return n.Resolved(!1)}getAllContacts(){return n.Resolved([])}}t.AddressBook=s,t.default=new s},444876:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(677590),t);var r=i(677590);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},612326:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CookieManager=void 0;t.CookieManager=class{}},168040:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(897265),t);var r=i(897265);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},897265:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CookieManager=void 0;const n=i(197582),r=n.__importStar(i(397691)),s=n.__importStar(i(612326));class a extends s.CookieManager{clearAllCookies(){return document.cookie.split(";").forEach((e=>{document.cookie=e.replace(/^ +/,"").replace(/=.*/,"=;expires="+new Date(Date.now()-1e4).toUTCString()+";path=/;secure")})),r.Resolved()}getCookiesForDomain(e){throw"Not Implemented"}setCookie(e,t,i,n){const s=`${t}=${i};path=/;domain=${n||e};secure`;return document.cookie=s,r.Resolved()}}t.CookieManager=a,t.default=new a},760249:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});i(197582).__exportStar(i(1411),t)},1411:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.curve_async=t.curve=void 0;const n=i(287633);t.curve=n.curve25519,t.curve_async=n.curve25519_async},162835:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VirtualKeyboardBase=t.CustomKeyboardEvent=t.VirtualKeyboardEvent=void 0;const n=i(197582).__importStar(i(516778));var r,s;!function(e){e[e.keyboardDidShow=0]="keyboardDidShow",e[e.keyboardDidHide=1]="keyboardDidHide"}(r||(t.VirtualKeyboardEvent=r={})),function(e){e[e.customKeyboardSeen=0]="customKeyboardSeen",e[e.customKeyboardHidden=1]="customKeyboardHidden"}(s||(t.CustomKeyboardEvent=s={}));class a extends n.Component{static isSupported(){return!1}static dismiss(){}static showNativeKeyboard(){}static on(e,t){}static onCustomKeyboardEvent(e,t){}static hideKeyboardOnAndroidBackButton(e){}show(){}}t.VirtualKeyboardBase=a},994070:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(31049),t);var r=i(31049);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},31049:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CustomKeyboardEvent=t.VirtualKeyboardEvent=void 0;const n=i(162835);var r=i(162835);Object.defineProperty(t,"VirtualKeyboardEvent",{enumerable:!0,get:function(){return r.VirtualKeyboardEvent}}),Object.defineProperty(t,"CustomKeyboardEvent",{enumerable:!0,get:function(){return r.CustomKeyboardEvent}});class s extends n.VirtualKeyboardBase{render(){return this.props.children}}t.default=s},194288:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DateTimePickerBase=t.TimePickerBase=t.DatePickerBase=void 0;const n=i(197582),r=n.__importDefault(i(727484)),s=n.__importDefault(i(356176)),a=n.__importStar(i(516778));r.default.extend(s.default);class o extends a.Component{constructor(){super(...arguments),this._formatDate=e=>this.props.formatDate?this.props.formatDate(e):(0,r.default)(e).format("LL")}}t.DatePickerBase=o;class l extends a.Component{constructor(){super(...arguments),this._formatTime=e=>this.props.formatTime?this.props.formatTime(e):(0,r.default)(e).format("HH:mm")}}t.TimePickerBase=l;class d extends a.Component{}t.DateTimePickerBase=d},759982:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});i(197582).__exportStar(i(556970),t)},730277:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=n.__importDefault(i(727484)),a=n.__importDefault(i(356176)),o=i(194288);s.default.extend(a.default);const l="YYYY-MM-DD";class d extends o.DatePickerBase{constructor(){super(...arguments),this._onDateChange=e=>{const t=e.target.valueAsDate;t&&this.props.onDateChange(t)}}render(){let e=this.props.palette?{border:"0",color:this.props.palette.textColor,backgroundColor:this.props.palette.backgroundColor}:{border:"0"};return this.props.isRTL&&(e=Object.assign(Object.assign({},e),{textAlign:"right"})),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("style",{children:`\n                        input {\n                            color-scheme: ${this.props.isDarkMode?"dark":void 0};\n                        }\n                    `}),(0,r.jsx)("input",{type:"date",value:(0,s.default)(this.props.date).format(l),min:this.props.minimumDate?(0,s.default)(this.props.minimumDate).format(l):void 0,max:this.props.maximumDate?(0,s.default)(this.props.maximumDate).format(l):void 0,required:!0,onChange:this._onDateChange,style:e})]})}}t.default=d},169339:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DateTimePicker=void 0;const n=i(197582),r=i(785893),s=n.__importDefault(i(727484)),a=n.__importDefault(i(356176)),o=n.__importStar(i(516778)),l=n.__importDefault(i(730277)),d=i(194288),c=i(26703),h=n.__importDefault(i(680103));s.default.extend(a.default);const u=(0,c.lazyProperties)({dateTimePickerContainer:()=>o.Styles.createViewStyle({flexDirection:"column"})});class p extends d.DateTimePickerBase{constructor(e){super(e),this._onDateChange=e=>{const t=e?(0,s.default)(e).format("YYYY-MM-DD"):"";this.setState({date:t},this._onDateTimeChange)},this._onTimeChange=e=>{let t="";if(e){t=(e.hour<10?"0"+e.hour:e.hour)+":"+(e.minute<10?"0"+e.minute:e.minute)}this.setState({time:t},this._onDateTimeChange)},this.props.locale&&s.default.locale(this.props.locale),this.state={date:this.props.dateTime?(0,s.default)(this.props.dateTime).format("YYYY-MM-DD"):"",time:this.props.dateTime?(0,s.default)(this.props.dateTime).format("HH:mm"):""}}render(){const e=o.Styles.combine([u.dateTimePickerContainer,this.props.customStyles?this.props.customStyles.container:void 0]),t=this.props.customStyles?Object.assign(Object.assign({},this.props.customStyles),{container:void 0}):void 0;return(0,r.jsxs)("div",{style:e,children:[(0,r.jsx)(l.default,{date:(0,s.default)(this.state.date).toDate(),maximumDate:this.props.maximumDate,minimumDate:this.props.minimumDate,onDateChange:this._onDateChange,customStyles:t,palette:this.props.palette}),(0,r.jsx)(h.default,{time:(0,s.default)(this.state.time,"HH:mm").toDate(),onTimeChange:this._onTimeChange,customStyles:t,formatTime:this.props.formatTime,hidePastTimes:this.props.timePickerHidePastTimes,minutesInterval:this.props.timePickerMinutesInterval,pickerAccessibilityLabel:this.props.timePickerAccessibilityLabel,palette:this.props.palette})]})}_onDateTimeChange(){if(this.props.onDateTimeChange){const e=this.state.date+" "+this.state.time,t=(0,s.default)(e,"YYYY-MM-DD HH:mm",!0),i=t.isValid()?t.toDate():void 0;this.props.onDateTimeChange(i)}}}t.DateTimePicker=p,t.default=p},556970:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TimePicker=t.DateTimePicker=t.DatePicker=void 0;const n=i(197582),r=n.__importDefault(i(730277));t.DatePicker=r.default;const s=n.__importDefault(i(169339));t.DateTimePicker=s.default;const a=n.__importDefault(i(680103));t.TimePicker=a.default},680103:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=n.__importDefault(i(727484)),a=n.__importDefault(i(679212)),o=n.__importDefault(i(356176)),l=i(194288);s.default.extend(o.default),s.default.extend(a.default);const d="HH:mm";class c extends l.TimePickerBase{constructor(){super(...arguments),this._id=c._instanceCounter++,this._onTimeChange=e=>{const t=e.currentTarget.valueAsDate;t&&this.props.onTimeChange({hour:t.getUTCHours(),minute:t.getUTCMinutes()})}}render(){const e=this._createTimeOptions();let t=this.props.palette?{border:"0",color:this.props.palette.textColor,backgroundColor:this.props.palette.backgroundColor}:{border:"0"};this.props.isRTL&&(t=Object.assign(Object.assign({},t),{textAlign:"right"}));const i="time_datalist_"+this._id;return[(0,r.jsx)("datalist",{id:i,children:e},i),(0,r.jsx)("input",{type:"time",list:i,value:(0,s.default)(this.props.time).format(d),required:!0,onChange:this._onTimeChange,"aria-label":this.props.pickerAccessibilityLabel,style:t,onBlur:this.props.onBlur},"time_input_"+this._id)]}_createTimeOptions(){const e=[],t=(0,s.default)(),i=(0,s.default)(this.props.time).startOf("day"),n=(0,s.default)(this.props.time).endOf("day");let a=i;for(;n.isSameOrAfter(a);){const i=this.props.hidePastTimes&&a.isBefore(t,"minute"),n=a.format(d);e.push((0,r.jsx)("option",{value:n,disabled:i},n)),a=a.add(this.props.minutesInterval||30,"minute")}return e}}c._instanceCounter=0,t.default=c},270555:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DeviceSettingsBase=void 0;t.DeviceSettingsBase=class{}},540761:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(717046),t);var r=i(717046);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},717046:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(270555);class r extends n.DeviceSettingsBase{openAppNotificationsSettings(){}}t.default=new r},170025:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582).__importStar(i(516778));class r extends n.Component{render(){return null}}t.default=r},722965:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(170025),t);var r=i(170025);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},956865:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.DragDropType=t.ContactDropEffect=void 0,t.ContactDropEffect="copy",function(e){e.FileFromDesktop="filefromdesktop",e.FileFromConversationToRecents="filefromconversationtorecents",e.ContactFromRecentsToConversation="contactfromrecentstoconversation",e.Unknown="unknown"}(i||(t.DragDropType=i={}))},762595:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});i(197582).__exportStar(i(523116),t)},615668:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(956865),s=n.__importDefault(i(655192));t.default=new class{addDragAndDropContactInformation(e,t){e.dataTransfer.effectAllowed=r.ContactDropEffect,e.dataTransfer.dropEffect=r.ContactDropEffect,e.dataTransfer.setData(r.DragDropType.ContactFromRecentsToConversation,JSON.stringify(t))}isContactEntityInDataTransfer(e){return!(!e.dataTransfer||!e.dataTransfer.items||1!==e.dataTransfer.items.length||e.dataTransfer.items[0].type!==r.DragDropType.ContactFromRecentsToConversation)}extractContactEntityFromDataTransfer(e){if(!this.isContactEntityInDataTransfer(e))return;const t=e.dataTransfer.getData(r.DragDropType.ContactFromRecentsToConversation);return s.default.parseJsonErrorToUndefined(t)}}},14211:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DragDroppableView=void 0;const n=i(785893),r=i(537180),s=i(516778),a="dnd-root";class o extends s.Component{constructor(){super(...arguments),this._onDragStart=e=>{this.props.onDragStart&&this.props.onDragStart(e),this._setDragImage(e)},this._onDragEnd=e=>{this._dragThumbnailElement&&(document.body.removeChild(this._dragThumbnailElement),this._dragThumbnailElement=void 0),this.props.onDragEnd&&this.props.onDragEnd(e)}}render(){return(0,n.jsx)(s.View,Object.assign({},this.props,{onDragStart:this.props.onDragStart?this._onDragStart:void 0,onDragEnd:this.props.onDragStart?this._onDragEnd:void 0}))}_setDragImage(e){e.dataTransfer&&void 0!==e.dataTransfer.setDragImage&&(this.props.dragThumbnailElement?this._setThumbnail(e,this.props.dragThumbnailElement):this.props.useChildrenThumbnail&&this.props.children&&this._setThumbnail(e,s.Children.only(this.props.children)))}_setThumbnail(e,t){const i=document.createElement("div");i.style.position="absolute",this.props.useThumbnailExplicitMaxWidth?i.style.maxWidth="321px":i.style.display="flex",document.body.appendChild(i),r.AppRegistry.registerRunnable(a,(()=>()=>t)),r.AppRegistry.runApplication(a,{rootTag:i}),this._dragThumbnailElement=i}}t.DragDroppableView=o},523116:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DragDropEvent=t.DragDroppableView=void 0;const n=i(197582).__importDefault(i(615668));t.DragDropEvent=n.default;const r=i(14211);Object.defineProperty(t,"DragDroppableView",{enumerable:!0,get:function(){return r.DragDroppableView}})},794778:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.newGuid=function(){const e=n.getRandomValues(new Array(16));return r[255&e[0]]+r[255&e[1]]+r[255&e[2]]+r[255&e[3]]+"-"+r[255&e[4]]+r[255&e[5]]+"-"+r[15&e[6]|64]+r[255&e[7]]+"-"+r[63&e[8]|128]+r[255&e[9]]+"-"+r[255&e[10]]+r[255&e[11]]+r[255&e[12]]+r[255&e[13]]+r[255&e[14]]+r[255&e[15]]},t.newCauseId=function(){const e=n.getRandomValues(new Array(4));return r[255&e[0]]+r[255&e[1]]+r[255&e[2]]+r[255&e[3]]},t.getRandomInt32=a,t.random=function e(){const t=a();if(t<s)return t/s;return e()},t.randomByte=function(){return n.getRandomValues(new Array(1))[0]},t.wrapRsaPubPkcs1WithPkcs8=function(e){const t=n.fromBase64("MA0GCSqGSIb3DQEBAQUA"),i=o(3,e);return o(48,t.concat(i))},t.wrapRsaPvtPkcs1WithPkcs8=function(e){const t=n.fromBase64("AgEAMA0GCSqGSIb3DQEBAQUA"),i=o(4,e),r=n.fromBase64("oA0wCwYDVR0PMQQDAgAQ");return o(48,t.concat(i,r))};const n=i(197582).__importStar(i(775463)),r=[];for(let e=0;e<256;e++)r[e]=(e<16?"0":"")+e.toString(16);const s=2147483647;function a(){const e=n.getRandomValues(new Array(4));return(127&e[0])<<24|e[1]<<16|e[2]<<8|e[3]}function o(e,t){let i=t.length;const n=[255&i];let r=[];if(3===e&&(i+=1,r=[0]),2===e&&128&i&&(i+=1,r=[0]),i>127){for(i>>>=8;i>0;)n.unshift(255&i),i>>>=8;n.unshift(128+n.length)}return[e].concat(n,r,t)}},976986:(e,t)=>{"use strict";var i,n;Object.defineProperty(t,"__esModule",{value:!0}),t.EntropyBase=t.KeySize=t.AsymmetricAlgorithmName=void 0,function(e){e[e.RSA=0]="RSA"}(i||(t.AsymmetricAlgorithmName=i={})),function(e){e[e.RSA2048=2048]="RSA2048"}(n||(t.KeySize=n={}));t.EntropyBase=class{}},743726:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});i(197582).__exportStar(i(898280),t)},898280:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Entropy=t.EntropySeed=t.AsymmetricAlgorithmName=t.randomByte=t.random=t.getRandomInt32=t.newCauseId=t.newGuid=void 0;const n=i(197582),r=n.__importStar(i(496486)),s=n.__importStar(i(397691)),a=i(976986),o=["encrypt","decrypt"];class l{constructor(e){this._cryptoObj=e}getCryptoStrongRandomValues(e){const t=new Uint8Array(e);return this._cryptoObj.getRandomValues(t),s.Resolved([].slice.call(t))}getKeyPair(e,t){if(t!==a.AsymmetricAlgorithmName.RSA)return s.Rejected("getKeyPair(): cannot perform that algorithm on this platform: "+t);if(!this._cryptoObj.subtle||!r.isFunction(this._cryptoObj.subtle.generateKey))return s.Rejected("getKeyPair(): key pair generation is not supported in this environment");const i={name:"RSA-OAEP",modulusLength:e,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}};return s.fromThenable(this._cryptoObj.subtle.generateKey(i,true,o)).then((e=>{const t=s.fromThenable(this._cryptoObj.subtle.exportKey("spki",e.publicKey)).then((e=>[].slice.call(new Uint8Array(e)))).catch((e=>s.Rejected("getKeyPair(): cannot export public key "+e))),i=s.fromThenable(this._cryptoObj.subtle.exportKey("pkcs8",e.privateKey)).then((e=>[].slice.call(new Uint8Array(e)))).catch((e=>s.Rejected("getKeyPair(): cannot export private key "+e)));return s.all([t,i]).then((([e,t])=>({publicKey:e,privateKey:t})))}),(e=>s.Rejected("getKeyPair(): cannot generate key pair "+e)))}}class d{getCryptoStrongRandomValues(e){return s.Rejected("getRandomValues() cannot generate cryptographically-secure random values on this platform")}getKeyPair(e,t){return s.Rejected("getKeys(): key pair generation is not supported on this platform")}}var c=i(794778);Object.defineProperty(t,"newGuid",{enumerable:!0,get:function(){return c.newGuid}}),Object.defineProperty(t,"newCauseId",{enumerable:!0,get:function(){return c.newCauseId}}),Object.defineProperty(t,"getRandomInt32",{enumerable:!0,get:function(){return c.getRandomInt32}}),Object.defineProperty(t,"random",{enumerable:!0,get:function(){return c.random}}),Object.defineProperty(t,"randomByte",{enumerable:!0,get:function(){return c.randomByte}});var h=i(976986);Object.defineProperty(t,"AsymmetricAlgorithmName",{enumerable:!0,get:function(){return h.AsymmetricAlgorithmName}}),t.EntropySeed=void 0,t.Entropy="undefined"!=typeof crypto&&r.isFunction(crypto.getRandomValues)?new l(crypto):"undefined"!=typeof msCrypto&&r.isFunction(msCrypto.getRandomValues)?new l(msCrypto):new d},411242:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExternalBrowserBase=void 0;t.ExternalBrowserBase=class{openAuthenticationUrl(e){return Promise.reject()}}},318153:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=n.__importStar(i(516778)),s=n.__importStar(i(397691)),a=i(411242);class o extends a.ExternalBrowserBase{openUrl(e){return r.Linking.openUrl(e)}dismiss(){return s.Rejected("N/A on web, windows and macos")}}t.default=new o},846025:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(318153),t);var r=i(318153);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},85623:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582).__importStar(i(397691));t.default=new class{fileExists(e){return n.Resolved(!1)}getFileInformation(e){return n.Rejected("Not implemented")}openFile(e){return n.Rejected()}openFileLocation(e){return n.Rejected(!1)}openFolderLocation(e){return n.Rejected(!1)}addMediaToSkypeAlbum(e){return n.Rejected("")}}},82201:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(85623),t);var r=i(85623);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},509319:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FilePickerBase=void 0,t.isNativeBlob=function(e){return"uri"in e};const n=i(197582).__importStar(i(397691));t.FilePickerBase=class{isDocumentPickerSupported(){return!1}showDocumentPicker(e){}getSaveAsUri(e,t){return n.Rejected(new Error("Not supported"))}cleanUp(e){}}},900407:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(323066),t);var r=i(323066);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},323066:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WebFilePicker=t.isNativeBlob=void 0;const n=i(197582),r=i(174958),s=n.__importStar(i(496486)),a=n.__importStar(i(167606)),o=n.__importStar(i(397691)),l=i(509319),d=i(814169),c=i(920440);t.isNativeBlob=l.isNativeBlob;const h=["png","jpg","jpeg","gif","svg","bmp","tif","tiff"],u=["mp4","ogv","mov"];class p extends l.FilePickerBase{constructor(){super(...arguments),this._mainWindowFileSelectionInput=null,this._fileSelectionInputs={}}saveFile(e,t){const i=document.createElement("a");i.style.display="none",i.href=e,i.download=t,document.body.appendChild(i);const n=t.replace(/^.*[\.]/,"").toLowerCase();s.includes(h,n)&&(i.target="_blank",i.rel="noreferrer"),i.click(),document.body.removeChild(i)}cleanUp(e){e!==d.MainRootViewId?this._fileSelectionInputs[e]&&(this._fileSelectionInputs[e].onchange=null):this._mainWindowFileSelectionInput&&(this._mainWindowFileSelectionInput.onchange=null)}show(e,t,i,n){const r=i.target&&i.target.ownerDocument?i.target.ownerDocument:document,a=this._getFileInput(t,r),l=[];e.acceptVideo&&l.push("video/*"),e.acceptImage&&l.push("image/*"),l?a.accept=l.join(","):a.removeAttribute("accept"),a.value="",a.multiple=!!e.allowMultipleSelection,a.onchange=()=>{const e=o.Defer(),t=[];if(a.files&&a.files.length>=1)for(let i=0;i<a.files.length;i++){const n=a.files[i],r=n.name.replace(/^.*[\.]/,""),o=r.toLowerCase(),l=URL.createObjectURL(n);if(s.includes(u,o))(0,c.captureFrameFromVideo)(l).then((i=>{let o,l;if(i){i.width>=0&&i.height>=0&&(o={width:i.width,height:i.height});const e=i.blob;let t=n.name;const r=n.name.lastIndexOf(".");r>0&&(t=t.substring(0,r)+"-thumbnail."+i.extension),s.attempt((()=>e.name=t)),e.lastModifiedDate=new Date(n.lastModified),l={file:e,extension:i.extension,dimensions:o}}t.push({file:n,extension:r,dimensions:o,thumbnail:l}),a.files&&t.length===a.files.length&&e.resolve(t)}));else if(s.includes(h,o)){const i=(i,n)=>r=>{const s=r.target.src,o=r.target.naturalWidth,l=r.target.naturalHeight;let d;o>=0&&l>=0&&(d={width:o,height:l}),t.push({file:i,extension:n,dimensions:d,path:s}),a.files&&t.length===a.files.length&&e.resolve(t)},s=(i,n)=>r=>{t.push({file:i,extension:n}),a.files&&t.length===a.files.length&&e.resolve(t)},o=new Image;n.size>0&&(o.onload=i(n,r),o.onerror=s(n,r),o.src=l)}else t.push({file:n,extension:r}),t.length===a.files.length&&e.resolve(t)}e.promise().then((()=>{n(t)}))},a.click()}showOpenDialog(e,t){}getFileDownloadPath(){return o.Rejected()}_getFileInput(e,t){if(e!==d.MainRootViewId){if(this._fileSelectionInputs[e])return this._fileSelectionInputs[e]}else if(this._mainWindowFileSelectionInput)return this._mainWindowFileSelectionInput;const i=t.createElement("input");return i.style.display="none",i.type="file",t.body.appendChild(i),e!==d.MainRootViewId?(t.defaultView&&t.defaultView.addEventListener("unload",(()=>{delete this._fileSelectionInputs[e];try{t.body.removeChild(i)}catch(t){a.error(a.LogTraceArea.GenericUnsafe,`[FilePicker]: Failed to remove input from dom for rootViewId: ${r.pii.Mri(e)}. Error: ${r.pii.Omit(t)}`)}})),this._fileSelectionInputs[e]=i):this._mainWindowFileSelectionInput=i,i}}t.WebFilePicker=p,t.default=new p},695751:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(688122),t);var r=i(688122);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},688122:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FocusOutline=void 0;const n=i(197582),r=i(785893),s=n.__importStar(i(496486)),a=n.__importStar(i(516778)),o=n.__importDefault(i(114818)),l={display:"none",position:"absolute",background:"#ff4500",width:0,height:0,left:0,top:0,zIndex:100500},d={left:{position:"absolute",background:"inherit",width:2,height:2,borderTopLeftRadius:2,borderBottomLeftRadius:2},top:{position:"absolute",background:"inherit",width:2,height:2,borderTopLeftRadius:2,borderTopRightRadius:2},right:{position:"absolute",background:"inherit",width:2,height:2,borderTopRightRadius:2,borderBottomRightRadius:2},bottom:{position:"absolute",background:"inherit",width:2,height:2,borderBottomLeftRadius:2,borderBottomRightRadius:2}};class c extends a.Component{constructor(e){super(e),this._onContainerRef=e=>{this._container=e},this._onLeftRef=e=>{this._left=e},this._onTopRef=e=>{this._top=e},this._onRightRef=e=>{this._right=e},this._onBottomRef=e=>{this._bottom=e},this._onFocusIn=e=>{if(!this._isNavigatingWithKeyboard)return;this._displayTimer&&(this.props.window.clearTimeout(this._displayTimer),this._displayTimer=void 0);const t=e&&e.target;(!t||"INPUT"!==t.tagName&&"TEXTAREA"!==t.tagName&&"true"!==t.contentEditable)&&(this._displayTimer=this.props.window.setTimeout((()=>{this._focusedElement=t;const e=()=>{this._setOutlinePosition(),this._displayTimer=this.props.window.setTimeout(e,30)};e()}),30))},this._onFocusOut=()=>{this._displayTimer&&(this.props.window.clearTimeout(this._displayTimer),this._displayTimer=void 0),this._focusedElement=void 0,this._setOutlinePosition()},this._onKeyboardNavigationStateChanged=e=>{this._isNavigatingWithKeyboard=e,e?this.state.isRendered||this.setState({isRendered:!0}):this._onFocusOut()},this._onScroll=e=>{this._isNavigatingWithKeyboard&&!this._updateAnimationFrame&&(this._updateAnimationFrame=this.props.window.requestAnimationFrame((()=>{this._updateAnimationFrame=void 0,this._setOutlinePosition()})))},this._isNavigatingWithKeyboard=a.UserInterface.isNavigatingWithKeyboard(),this.state={isRendered:this._isNavigatingWithKeyboard},this._isNavigatingWithKeyboard&&this._resetFocus()}componentDidMount(){a.UserInterface.keyboardNavigationEvent.subscribe(this._onKeyboardNavigationStateChanged),this._addWindowListeners(this.props.window)}componentWillUnmount(){a.UserInterface.keyboardNavigationEvent.unsubscribe(this._onKeyboardNavigationStateChanged),this._removeWindowListeners(this.props.window)}componentDidUpdate(e,t){this.props.window!==e.window&&(this._removeWindowListeners(e.window),this._displayTimer&&(e.window.clearTimeout(this._displayTimer),this._displayTimer=void 0),this._resetFocus(),this._addWindowListeners(this.props.window))}render(){if(!this.state.isRendered)return null;const e=s.clone(l);return e.background=this.props.color||"#ff4500",(0,r.jsxs)("div",{style:e,ref:this._onContainerRef,children:[(0,r.jsx)("div",{style:d.left,ref:this._onLeftRef},"left"),(0,r.jsx)("div",{style:d.top,ref:this._onTopRef},"top"),(0,r.jsx)("div",{style:d.right,ref:this._onRightRef},"right"),(0,r.jsx)("div",{style:d.bottom,ref:this._onBottomRef},"bottom")]},"container")}_addWindowListeners(e){e.document.addEventListener("focusin",this._onFocusIn,!0),e.document.addEventListener("focusout",this._onFocusOut,!0),e.addEventListener("scroll",this._onScroll,!0)}_removeWindowListeners(e){e.document.removeEventListener("focusin",this._onFocusIn,!0),e.document.removeEventListener("focusout",this._onFocusOut,!0),e.removeEventListener("scroll",this._onScroll,!0)}_resetFocus(){const e=void 0!==this.props.window.document&&this.props.window.document.body;let t;e&&(e.hasAttribute("tabindex")&&(t=e.tabIndex),e.tabIndex=-1,e.focus(),e.blur(),void 0!==t?e.tabIndex=t:e.removeAttribute("tabindex"))}_setOutlinePosition(){let e,t=this._focusedElement&&this._focusedElement.getBoundingClientRect();if(t&&(e={left:t.left,top:t.top,right:t.right,bottom:t.bottom}),(0,o.default)(e,this._currentPosition))return;const i=this._container;if(!i||!i.parentElement)return;let n;if(this._currentPosition=e,e){const r=s.clone(e);for(let e=this._focusedElement.parentElement;e;e=e.parentElement)if(0!==e.clientWidth&&0!==e.clientHeight&&(t=e.getBoundingClientRect(),t.left>r.left&&(r.left=t.left),t.top>r.top&&(r.top=t.top),t.right<r.right&&(r.right=t.right),t.bottom<r.bottom&&(r.bottom=t.bottom),this.props.isPopup&&e&&"100001"===e.style.zIndex)){n=t;break}this.props.isPopup&&n&&(r.left=r.left-n.left,r.right=r.right-n.left,r.top=r.top-n.top,r.bottom=r.bottom-n.top);const a=i.parentElement.clientWidth,o=i.parentElement.clientHeight;r.left=r.left>2?r.left-2:0,r.top=r.top>2?r.top-2:0,r.right=r.right<a-2?r.right+2:a,r.bottom=r.bottom<o-2?r.bottom+2:o;const l=r.right-r.left,d=r.bottom-r.top;if(l>4&&d>4){const e=this._left,t=this._top,n=this._right,s=this._bottom;if(!(e&&t&&n&&s))return;return e.style.left=t.style.left=s.style.left=r.left+"px",n.style.left=r.left+l-2+"px",e.style.top=n.style.top=t.style.top=r.top+"px",s.style.top=r.top+d-2+"px",e.style.height=n.style.height=d+"px",t.style.width=s.style.width=l+"px",void(i.style.display="block")}}i.style.display="none"}}t.FocusOutline=c,t.default=c},248133:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582).__importStar(i(397691));t.default=new class{geocodePosition(e){return n.Rejected()}}},742110:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(248133),t);var r=i(248133);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},802759:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PAYMENT_RESULT_ERROR=t.DefaultCardAuthMethods=t.DefaultCardNetworks=void 0,t.DefaultCardNetworks=["AMEX","DISCOVER","JCB","MASTERCARD","VISA"],t.DefaultCardAuthMethods=["PAN_ONLY","CRYPTOGRAM_3DS"],t.PAYMENT_RESULT_ERROR=104},511302:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GooglePay=t.GPAY_PAYMENT_RESULT_ERROR=void 0;const n=i(197582).__importStar(i(397691)),r=i(802759);Object.defineProperty(t,"GPAY_PAYMENT_RESULT_ERROR",{enumerable:!0,get:function(){return r.PAYMENT_RESULT_ERROR}});class s{init(){return n.Resolved()}isAvailable(){return!1}setAvailable(e){}setEnvironment(e){}isReadyToPay(){return n.Resolved(!0)}requestPayment(e){return n.Resolved({})}}t.GooglePay=s,s.ENVIRONMENT_TEST=0,s.ENVIRONMENT_PRODUCTION=1},273768:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});i(197582).__exportStar(i(511302),t)},82659:(e,t)=>{"use strict";var i,n,r,s,a,o;Object.defineProperty(t,"__esModule",{value:!0}),t.ProductPurchase=t.Product=t.ProductCommon=t.BillingResponseCodes=t.ErrorCodes=t.ProrationModes=t.PurchaseState=t.SkuType=t.TypesOfPurchasesSupported=void 0,function(e){e[e.NONE=0]="NONE",e[e.INAPPONLY=1]="INAPPONLY",e[e.INAPPANDSUBS=2]="INAPPANDSUBS"}(i||(t.TypesOfPurchasesSupported=i={})),function(e){e.INAPP="inapp",e.SUBS="subs"}(n||(t.SkuType=n={})),function(e){e[e.UNSPECIFIED_STATE=0]="UNSPECIFIED_STATE",e[e.PURCHASED=1]="PURCHASED",e[e.PENDING=2]="PENDING"}(r||(t.PurchaseState=r={})),function(e){e[e.UNKNOWN_SUBSCRIPTION_UPGRADE_DOWNGRADE_POLICY=0]="UNKNOWN_SUBSCRIPTION_UPGRADE_DOWNGRADE_POLICY",e[e.IMMEDIATE_WITH_TIME_PRORATION=1]="IMMEDIATE_WITH_TIME_PRORATION",e[e.IMMEDIATE_AND_CHARGE_PRORATED_PRICE=2]="IMMEDIATE_AND_CHARGE_PRORATED_PRICE",e[e.IMMEDIATE_WITHOUT_PRORATION=3]="IMMEDIATE_WITHOUT_PRORATION",e[e.DEFERRED=4]="DEFERRED"}(s||(t.ProrationModes=s={})),function(e){e.E_USER_CANCELLED="E_USER_CANCELLED",e.E_ALREADY_OWNED="E_ALREADY_OWNED",e.E_SKU_NOT_FOUND="EC_SKU_NOT_FOUND"}(a||(t.ErrorCodes=a={})),function(e){e[e.SERVICE_DISCONNECTED=-1]="SERVICE_DISCONNECTED"}(o||(t.BillingResponseCodes=o={}));class l{constructor(){}}t.ProductCommon=l;t.Product=class extends l{constructor(){super()}};t.ProductPurchase=class{}},214658:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GooglePlayBilling=t.ErrorCodes=t.PurchaseState=t.Product=t.ProductPurchase=t.TypesOfPurchasesSupported=t.SkuType=t.ProductCommon=t.BillingResponseCodes=void 0;const n=i(197582).__importStar(i(397691)),r=i(82659);Object.defineProperty(t,"BillingResponseCodes",{enumerable:!0,get:function(){return r.BillingResponseCodes}}),Object.defineProperty(t,"ProductCommon",{enumerable:!0,get:function(){return r.ProductCommon}}),Object.defineProperty(t,"Product",{enumerable:!0,get:function(){return r.Product}}),Object.defineProperty(t,"ProductPurchase",{enumerable:!0,get:function(){return r.ProductPurchase}}),Object.defineProperty(t,"TypesOfPurchasesSupported",{enumerable:!0,get:function(){return r.TypesOfPurchasesSupported}}),Object.defineProperty(t,"SkuType",{enumerable:!0,get:function(){return r.SkuType}}),Object.defineProperty(t,"PurchaseState",{enumerable:!0,get:function(){return r.PurchaseState}}),Object.defineProperty(t,"ErrorCodes",{enumerable:!0,get:function(){return r.ErrorCodes}});class s{initConnection(){return n.Rejected("Method not supported!")}endConnection(){return n.Rejected("Method not supported!")}getTypesOfPurchaseSupported(){return r.TypesOfPurchasesSupported.NONE}isReady(){return!1}supportsGooglePlay(){return!1}supportsGooglePlaySubscriptions(){return!1}supportsGooglePlayProductDetails(){return!1}fetchTypesOfPurchaseSupported(){return n.Rejected("Method not supported!")}fetchProductDetailsSupported(){return n.Rejected("Method not supported!")}flushFailedPurchasesCachedAsPending(){return n.Rejected("Method not supported!")}getProducts(e){return n.Rejected("Method not supported!")}getSubscriptions(e){return n.Rejected("Method not supported!")}getPurchaseHistory(){return n.Rejected("Method not supported!")}getAvailablePurchases(){return n.Rejected("Method not supported!")}requestPurchase(e,t,i){return n.Rejected("Method not supported!")}requestSubscription(e,t,i,r,s){return n.Rejected("Method not supported!")}finishTransaction(e,t,i){return n.Rejected("Method not supported!")}acknowledgePurchase(e,t){return n.Rejected("Method not supported!")}consumePurchase(e,t){return n.Rejected("Method not supported!")}purchaseUpdatedListener(e){}purchaseErrorListener(e){}}t.GooglePlayBilling=s,t.default=new s},350458:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(214658),t);var r=i(214658);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},67130:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.GradientDirection=void 0,function(e){e[e.TOP=0]="TOP",e[e.RIGHT=1]="RIGHT",e[e.BOTTOM=2]="BOTTOM",e[e.LEFT=3]="LEFT",e[e.TOP_RIGHT=4]="TOP_RIGHT",e[e.BOTTOM_RIGHT=5]="BOTTOM_RIGHT",e[e.BOTTOM_LEFT=6]="BOTTOM_LEFT",e[e.TOP_LEFT=7]="TOP_LEFT",e[e.TOBOTTOMRIGHT=8]="TOBOTTOMRIGHT"}(i||(t.GradientDirection=i={}))},854646:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GradientView=void 0;const n=i(197582);n.__exportStar(i(67130),t);var r=i(871820);Object.defineProperty(t,"GradientView",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},871820:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=n.__importStar(i(516778)),a=i(67130),o={[a.GradientDirection.TOP]:0,[a.GradientDirection.TOP_RIGHT]:45,[a.GradientDirection.RIGHT]:90,[a.GradientDirection.BOTTOM_RIGHT]:135,[a.GradientDirection.BOTTOM]:180,[a.GradientDirection.BOTTOM_LEFT]:225,[a.GradientDirection.LEFT]:270,[a.GradientDirection.TOP_LEFT]:315,[a.GradientDirection.TOBOTTOMRIGHT]:"to bottom right"};class l extends s.Component{_computeBackground(e,t){const i=t.join(", ");return`linear-gradient(${function(e){const t=o[e];return"string"==typeof t?t:t.toString()+"deg"}(e)}, ${i})`}_buildGradientStyle(){const e=[];return this.props.secondaryColors&&e.push(this._computeBackground(a.GradientDirection.TOP,this.props.secondaryColors)),this.props.colors&&e.push(this._computeBackground(this.props.direction,this.props.colors)),{background:e.join(", "),overflow:"hidden"}}render(){const e=s.Styles.combine([this._buildGradientStyle(),this.props.style]);return(0,r.jsx)(s.View,{style:e,ignorePointerEvents:this.props.ignorePointerEvents,children:this.props.children})}}l.defaultProps={direction:a.GradientDirection.BOTTOM,colors:["transparent","transparent"]},t.default=l},104644:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(309620),t);var r=i(309620);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},309620:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=n.__importStar(i(496486)),a=n.__importStar(i(530653)),o=n.__importStar(i(516778));t.default=new class{htmlToReact(e,t){return(0,r.jsx)(o.View,{style:t.defaultTextStyle,children:a.processNodes(e,(e=>this._transformParserCallback(e,t)))})}_transformParserCallback(e,t){if("tag"===e.type&&"span"===e.name&&e.attribs&&s.startsWith(e.attribs.class,"animated-emoticon")){const i=s.find(e.children,(e=>"tag"===e.type&&"img"===e.name)),n=i&&i.attribs&&i.attribs.itemid||e.attribs.itemid;if(n)return(0,r.jsx)("div",{style:{display:"inline-block",overflow:"hidden",verticalAlign:"text-bottom",height:t.emoticonSize},children:t.renderEmoticon(n)},this._getKeyForNode(e))}if("tag"===e.type&&"img"===e.name&&e.attribs&&"http://schema.skype.com/AMSImage"===e.attribs.itemtype){const i=e.attribs.src,n=this._parseImageStyles(e.attribs.style,e.attribs.width,e.attribs.height);if(i){const{result:s,renderInline:a}=t.renderImage(i,n);return(0,r.jsx)("div",{style:{display:a?"inline-block":"block"},children:s},this._getKeyForNode(e))}}if("tag"===e.type&&"span"===e.name&&e.attribs&&"http://schema.skype.com/Mention"===e.attribs.itemtype){const i=e.attribs.itemid;if(i)return t.renderAtMention(i)}if("text"===e.type&&!s.isEmpty(s.trim(e.data)))return t.renderTextNode(e.data)}_parseImageStyles(e,t,i){const n={};return t&&(n.width=s.toNumber(t)),i&&(n.height=s.toNumber(i)),e?e.split(";").filter((e=>e.split(":")[0]&&e.split(":")[1])).map((e=>[e.split(":")[0].trim().replace(/-./g,(e=>s.toUpper(e.substring(1)))),e.split(":")[1].trim()])).reduce(((e,t)=>Object.assign(Object.assign({},e),{[t[0]]:t[1]})),n):n}_getKeyForNode(e){return e.parent?"node"+s.indexOf(e.parent.children,e):"root"}}},540334:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ImageFilter=void 0;const n=i(197582),r=i(785893),s=n.__importStar(i(516778));class a extends s.Component{render(){const e=s.Styles.combine(this.props.style);return(0,r.jsx)(s.View,{style:e})}}t.ImageFilter=a,t.default=a},60033:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(540334),t);var r=i(540334);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},13253:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(770064),t);var r=i(770064);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},721602:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ImageSvg=void 0;const n=i(197582),r=i(785893),s=n.__importStar(i(516778));class a extends s.Component{render(){if(this.props.width>0&&this.props.height>0){const e=s.Styles.combine({position:"relative"},this.props.style);if(e.display="flex",void 0!==this.props.fillColor&&(e.fill=this.props.fillColor),void 0!==this.props.fillOpacity&&(e.fillOpacity=this.props.fillOpacity.toString()),void 0!==this.props.strokeColor&&(e.stroke=this.props.strokeColor),void 0!==this.props.strokeOpacity&&(e.strokeOpacity=this.props.strokeOpacity.toString()),void 0!==this.props.strokeWidth&&(e.strokeWidth=this.props.strokeWidth.toString()),void 0===e.flex&&(e.flex="0 0 auto"),void 0===e.overflow&&(e.overflow="hidden"),this.props.webShadow){e[s.Styles.getCssPropertyAliasesCssStyle().filter||"filter"]="drop-shadow("+this.props.webShadow+")"}return(0,r.jsxs)("svg",{viewBox:this.props.viewBox,style:e,height:this.props.height,width:this.props.width,"aria-label":this.props.accessibilityLabel,role:"img",children:[(0,r.jsx)("title",{children:this.props.title}),this.props.children]})}return null}}t.ImageSvg=a,t.default=a},770064:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ImageSvg=t.SvgPath=void 0;const n=i(721602);var r=i(361961);Object.defineProperty(t,"SvgPath",{enumerable:!0,get:function(){return r.SvgPath}});var s=i(721602);Object.defineProperty(t,"ImageSvg",{enumerable:!0,get:function(){return s.ImageSvg}}),t.default=n.ImageSvg},361961:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SvgPath=void 0;const n=i(197582),r=i(785893),s=n.__importStar(i(516778));class a extends s.Component{render(){return(0,r.jsx)("path",{fill:this.props.fillColor,fillOpacity:this.props.fillOpacity,stroke:this.props.strokeColor,strokeOpacity:this.props.strokeOpacity,strokeWidth:this.props.strokeWidth,d:this.props.d})}}t.SvgPath=a,t.default=a},134548:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PasswordNotFound=t.KeychainManagerBase=void 0;t.KeychainManagerBase=class{};class i extends Error{}t.PasswordNotFound=i},473896:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.KeychainManager=t.PasswordNotFound=void 0;const n=i(197582).__importStar(i(397691)),r=i(134548);var s=i(134548);Object.defineProperty(t,"PasswordNotFound",{enumerable:!0,get:function(){return s.PasswordNotFound}});class a extends r.KeychainManagerBase{setGenericPassword(e,t,i){return n.Rejected()}resetGenericPassword(e){return n.Rejected()}getGenericPassword(e){return n.Rejected()}setPassword(e,t,i){return n.Rejected()}getPassword(e,t){return n.Rejected()}deletePassword(e,t){return n.Rejected()}}t.KeychainManager=a,t.default=new a},872397:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(473896),t);var r=i(473896);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},780321:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.Commands=void 0,function(e){e.MapLoaded="map_loaded",e.SetInitialLocation="set_initial_location",e.SetCurrentLocation="set_current_location",e.SendCurrentLocation="send_current_location",e.SetNearbyLocation="set_nearby_location"}(i||(t.Commands=i={}))},663492:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});i(197582).__exportStar(i(780321),t)},694073:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});i(197582).__exportStar(i(663492),t)},828528:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapCalloutBase=t.MapMarkerBase=t.MapViewBase=void 0;const n=i(197582).__importStar(i(516778));class r extends n.Component{}t.MapViewBase=r;class s extends n.Component{}t.MapMarkerBase=s;class a extends n.Component{}t.MapCalloutBase=a},356850:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MapCallout=t.MapMarker=t.MapView=void 0;const n=i(828528);class r extends n.MapViewBase{render(){return null}animateToRegion(e,t){return Promise.reject("not implemented")}animateToCoordinate(e,t){return Promise.reject("not implemented")}fitToElements(e){}fitToSuppliedMarkers(){}fitToCoordinates(e,t){}takeSnapshot(e,t,i,n){}}t.MapView=r;class s extends n.MapMarkerBase{render(){return null}showCallout(){}hideCallout(){}}t.MapMarker=s;class a extends n.MapCalloutBase{render(){return null}}t.MapCallout=a},857969:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});i(197582).__exportStar(i(356850),t)},612094:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(971989),t);var r=i(971989);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},971989:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return(0,r.jsx)(s.View,{style:e.style,children:e.children})};const n=i(197582),r=i(785893),s=n.__importStar(i(516778))},939458:(e,t)=>{"use strict";var i,n,r;Object.defineProperty(t,"__esModule",{value:!0}),t.FindAllWebAccountsStatus=t.AccountType=t.TokenRequestHRESULT=void 0,function(e){e[e.S_OK=0]="S_OK",e[e.E_Unexpected=1]="E_Unexpected",e[e.E_ConnectionError=2]="E_ConnectionError",e[e.E_ProviderError=3]="E_ProviderError",e[e.E_UserInteractionRequired=4]="E_UserInteractionRequired",e[e.E_NoDefaultMSAAvailable=5]="E_NoDefaultMSAAvailable",e[e.E_AccountDeleted=6]="E_AccountDeleted",e[e.E_MainWindowNotFound=7]="E_MainWindowNotFound",e[e.E_ProviderNotFound=8]="E_ProviderNotFound",e[e.E_CachedAccountNotFound=9]="E_CachedAccountNotFound",e[e.E_AccountNotFound=10]="E_AccountNotFound",e[e.E_DefaultAccountNotFound=11]="E_DefaultAccountNotFound",e[e.E_EmptyResponse=12]="E_EmptyResponse",e[e.E_Exception=13]="E_Exception"}(i||(t.TokenRequestHRESULT=i={})),function(e){e[e.MSA=0]="MSA",e[e.Unknown=1]="Unknown"}(n||(t.AccountType=n={})),function(e){e[e.Success=0]="Success",e[e.NotAllowedByProvider=1]="NotAllowedByProvider",e[e.NotSupportedByProvider=2]="NotSupportedByProvider",e[e.ProviderError=3]="ProviderError"}(r||(t.FindAllWebAccountsStatus=r={}))},881580:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FindAllWebAccountsStatus=t.AccountType=t.TokenRequestHRESULT=void 0;const n=i(197582).__importStar(i(397691));var r=i(939458);Object.defineProperty(t,"TokenRequestHRESULT",{enumerable:!0,get:function(){return r.TokenRequestHRESULT}}),Object.defineProperty(t,"AccountType",{enumerable:!0,get:function(){return r.AccountType}}),Object.defineProperty(t,"FindAllWebAccountsStatus",{enumerable:!0,get:function(){return r.FindAllWebAccountsStatus}});t.default=new class{getAccessTokenSilently(e){return n.Rejected("Not supported on this platform")}getAccessTokenWithUIFallback(e){return n.Rejected("Not supported on this platform")}getAllAccounts(){return n.Rejected("Not supported on this platform")}clearWAMTokenCache(e){return n.Rejected("Not supported on this platform")}}},956013:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(881580),t);var r=i(881580);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},686168:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AbstractNativeAdClickableAreaView=t.AbstractNativeAdIconView=t.AbstractNativeAdMediaView=t.AbstractNativeAdView=t.AdProvider=t.NativeAdsError=void 0;const n=i(197582).__importStar(i(516778));var r;t.NativeAdsError={AdIsNull:{errorCode:2,errorMessage:"Cannot register the view on a null native ad."},AdIsNotValid:{errorCode:4,errorMessage:"Cannot register the view on an ad that is not valid."},CantCreateRequestObject:{errorCode:98,errorMessage:"Can't create the request details object"}},function(e){e.Msn="msn",e.MeetNow="meetnow"}(r||(t.AdProvider=r={}));class s extends n.Component{}t.AbstractNativeAdView=s;class a extends n.Component{}t.AbstractNativeAdMediaView=a;class o extends n.Component{}t.AbstractNativeAdIconView=o;class l extends n.Component{}t.AbstractNativeAdClickableAreaView=l},694814:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MeetNowAdsManager=void 0;const n=i(197582),r=i(743726),s=n.__importStar(i(317588)),a=n.__importStar(i(397691));t.MeetNowAdsManager=class{constructor(){this._adsDefinitionMap={}}init(e){const t=e.adRequestDetails;return this._adsDefinitionMap[t.placementId]?this.loadAds(t):(this._personalizeUrl=e.settings.personalizeUrl,this._sponsoredLabel=e.settings.customSponsoredLabel?e.settings.customSponsoredLabel:"",this._callToAction=e.settings.customCallToAction?e.settings.customCallToAction:"",this._callToActionOverride=e.settings.customCallToActionOverride,this._title=e.settings.dafaultTitle?e.settings.dafaultTitle:"",this._subTitle=e.settings.defaultDescription?e.settings.defaultDescription:"",this._adsDefinitionMap[t.placementId]={onAdsError:e.onAdsError,onAdsLoaded:e.onAdsLoaded,ads:{}},this._requestAds(t),a.Resolved())}loadAds(e){const t=e;return this._adsDefinitionMap[t.placementId]?(this._requestAds(t),a.Resolved()):a.Rejected("This placementId has not been initiallized. Use the init function instead.")}fetchAd(e,t){const i=this._adsDefinitionMap[e];if(i)return i.ads[t]}fetchAdWithCallbacks(e,t,i,n){}_requestAds(e){const t=this._adsDefinitionMap[e.placementId];if(!t)return;const i={title:this._title,sponsoredLabel:this._sponsoredLabel,body:this._subTitle,socialContext:this._callToAction,callToAction:this._callToAction,callToActionTarget:"skype:?action=meetnow",adChoicesImageUrl:void 0,adChoicesLinkUrl:this._personalizeUrl,adChoicesText:"",useInternalAdChoicesIcon:!1,mediaUrl:s.Collection.ADS_MEET_NOW_IMG,providerMediaUrl:void 0,providerName:void 0,impressionTrackingUrl:"-",impressionTrackingPayload:void 0,clickTrackingUrl:void 0,clickTrackingPayload:void 0,useCustomAdIcon:!0,useCustomAdIconUrl:s.Collection.ADS_MEET_NOW_ICON,callToActionFn:this._callToActionOverride};t.ads[(0,r.newGuid)()]=i,setTimeout((()=>{t.onAdsLoaded(Object.keys(t.ads))}),1)}}},534178:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NativeAdsError=t.AdProvider=t.NativeAdClickableAreaView=t.NativeAdView=t.NativeAdsManagerGlobal=t.MsnApiManager=t.MeetNowAdsManager=void 0;const n=i(197582);var r=i(694814);Object.defineProperty(t,"MeetNowAdsManager",{enumerable:!0,get:function(){return r.MeetNowAdsManager}});var s=i(99852);Object.defineProperty(t,"MsnApiManager",{enumerable:!0,get:function(){return s.MsnApiManager}});var a=i(243431);Object.defineProperty(t,"NativeAdsManagerGlobal",{enumerable:!0,get:function(){return n.__importDefault(a).default}});var o=i(802897);Object.defineProperty(t,"NativeAdView",{enumerable:!0,get:function(){return o.NativeAdView}});var l=i(793093);Object.defineProperty(t,"NativeAdClickableAreaView",{enumerable:!0,get:function(){return l.NativeAdClickableAreaView}});const d=i(686168);Object.defineProperty(t,"AdProvider",{enumerable:!0,get:function(){return d.AdProvider}}),Object.defineProperty(t,"NativeAdsError",{enumerable:!0,get:function(){return d.NativeAdsError}})},99852:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MsnApiManager=void 0;const n=i(197582),r=i(743726),s=n.__importStar(i(817673)),a=i(662783),o=n.__importStar(i(397691)),l=n.__importDefault(i(122792));t.MsnApiManager=class{constructor(){this._apiUrl=void 0,this._adsDefinitionMap={},this._msnMarket="en-us",this._httpClient=new a.GenericRestClient("https://api.msn.com/")}init(e){const t=e.adRequestDetails;if(e.settings.anid&&(this._msnUser="a-"+e.settings.anid),this._msnOcid=e.settings.ocid?e.settings.ocid:"",this._msnApiKey=e.settings.apiKey?e.settings.apiKey:"",this._appLanguage=e.settings.language?e.settings.language:"en",this._msnFeedbackUrl=e.settings.feedbackUrl?e.settings.feedbackUrl:"",this._msnPersonalizeUrl=e.settings.personalizeUrl,this._sponsoredLabel=e.settings.customSponsoredLabel?e.settings.customSponsoredLabel:"",this._callToAction=e.settings.customCallToAction?e.settings.customCallToAction:"",this._categoryFilter=e.settings.categoryFilter?[...e.settings.categoryFilter]:[],this._downloadProviderIcon=!!e.settings.downloadProviderIcon&&e.settings.downloadProviderIcon,!this._msnUser)return o.Rejected("No user ANID provided.");if(this._adsDefinitionMap[t.placementId])return this.loadAds(t);this._adsDefinitionMap[t.placementId]={onAdsError:e.onAdsError,onAdsLoaded:e.onAdsLoaded,ads:{}},this._setupLocale();const i=this._processInit(t),n=this._handleError(t.placementId);return this._requestAds(t).then(i).catch(n)}loadAds(e){const t=e;if(!this._msnUser)return o.Rejected("No user ANID provided.");if(!this._adsDefinitionMap[t.placementId])return o.Rejected("This placementId has not been initiallized. Use the init function instead.");const i=this._processInit(t),n=this._handleError(t.placementId);return this._requestAds(e).then(i).catch(n)}fetchAd(e,t){const i=this._adsDefinitionMap[e];if(i)return i.ads[t]}fetchAdWithCallbacks(e,t,i,n){}_setupLocale(){this._msnMarket=this._appLanguage}_requestAds(e){if(void 0===this._apiUrl){const e={market:this._msnMarket.toLowerCase(),$top:1,queryType:"myFeed",activityId:(0,r.newGuid)(),ocid:this._msnOcid,user:this._msnUser,apikey:this._msnApiKey,query:this._categoryFilter.length>0?this._categoryFilter.join(","):void 0},t=s.stringify(e);this._apiUrl="news/feed?"+t}return this._httpClient.performApiGet(this._apiUrl)}_processInit(e){return t=>{const i=this._adsDefinitionMap[e.placementId];if(!i)return;if(!t)return void l.default.bubbleUpTheError(i,1,"Request return empty response");if(!t.value||t.value.length<=0||!t.value[0].subCards||1!==t.value[0].subCards.length)return void l.default.bubbleUpTheError(i,2,"The response received contains no ads");if(t.value[0].nextPageUrl){const e=t.value[0].nextPageUrl;this._apiUrl=e.replace("https://api.msn.com:443/","")}const n=t.value[0].subCards[0];let r,s,a,o=!1,d="",c="",h="";const u={icon:void 0,providerMedia:void 0},p=n.id;if(n.title&&this._isAdTitleValid(n.title,i)&&(d=n.title,r=!0),n.url&&this._isAdUrlValid(n.url,i)&&(c=n.url,s=!0),n.images&&n.images.length>0&&n.images[0].url&&this._isAdImageUrlValid(n.images[0].url,i)&&(a=n.images[0].url+"?w=300&h=200&m=5",o=!0),n.provider&&n.provider.logoUrl&&this._isAdImageUrlValid(n.provider.logoUrl,i)&&(u.icon=n.provider.logoUrl,u.providerMedia=n.provider.logoUrl+"?w=18&h=18&m=5&q=80"),n.provider&&n.provider.name&&this._isAdTitleValid(n.provider.name,i)&&(h=n.provider.name),!r||!s||!o)return;const g=()=>{const e={title:d,sponsoredLabel:this._sponsoredLabel,body:n.abstract?n.abstract:"",socialContext:h+" "+this._sponsoredLabel,callToAction:this._callToAction,callToActionTarget:c,adChoicesImageUrl:void 0,adChoicesLinkUrl:this._msnPersonalizeUrl,adChoicesText:"",useInternalAdChoicesIcon:!0,mediaUrl:a,providerMediaUrl:u.providerMedia,providerName:h,impressionTrackingUrl:this._msnFeedbackUrl,impressionTrackingPayload:this._getFeedbackPayload(n,"Impression"),clickTrackingUrl:this._msnFeedbackUrl,clickTrackingPayload:this._getFeedbackPayload(n,"Click"),useCustomAdIcon:!0,useCustomAdIconUrl:u.icon};i.ads[p]=e,setTimeout((()=>{i.onAdsLoaded([p])}),1)};this._downloadProviderIcon&&n.provider.id?this._getProviderData(n.provider.id).then(this._processProviderData(u)).then(g):g()}}_getProviderData(e){const t={ids:e,ocid:this._msnOcid,apikey:this._msnApiKey},i=s.stringify(t);return this._httpClient.performApiGet("news/providers?"+i)}_processProviderData(e){return t=>{if(t&&t.value&&t.value[0]){const i=t.value[0];i.clusterLogo&&i.clusterLogo.url&&(e.icon=i.clusterLogo.url+"?h=100&w=100&m=5&q=80"),i.mainLogo&&i.mainLogo.url&&(e.providerMedia=i.mainLogo.url+"?w=18&h=18&m=5&q=80")}}}_getFeedbackPayload(e,t){const i={eventType:t,userId:this._msnUser,activityId:(0,r.newGuid)(),targetId:e.id,eventTime:new Date(Date.now()).toISOString(),targetType:"CmsArticle",market:this._msnMarket};return{clientId:this._msnOcid,product:"skype",market:this._msnMarket,events:[i]}}_isAdTitleValid(e,t){return!(void 0===e||!l.default.isNonEmptyString(e))||(l.default.bubbleUpTheError(t,2,"Response validation failed: Ad title missing"),!1)}_isAdUrlValid(e,t){return!(void 0===e||!l.default.isNonEmptyString(e))||(l.default.bubbleUpTheError(t,2,"Response validation failed: Ad url missing"),!1)}_isAdImageUrlValid(e,t){return!(void 0===e||!l.default.isNonEmptyString(e))||(l.default.bubbleUpTheError(t,2,"Response validation failed: Ad img missing"),!1)}_handleError(e){return t=>{const i=this._adsDefinitionMap[e];if(!i||!t)return;const n=t.body&&t.body.status||"";l.default.bubbleUpTheError(i,t.statusCode,n)}}}},793093:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NativeAdClickableAreaView=void 0;const n=i(197582),r=i(785893),s=n.__importStar(i(516778)),a=i(686168);class o extends a.AbstractNativeAdClickableAreaView{render(){return(0,r.jsx)(s.View,Object.assign({},this.props))}}t.NativeAdClickableAreaView=o},802897:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NativeAdView=void 0;const n=i(667294),r=i(686168),s=i(978798);class a extends r.AbstractNativeAdView{render(){return(0,n.createElement)(s.NativeAdWrapper,Object.assign({},this.props,{key:`${this.props.placementId}-${this.props.adId}`}))}}t.NativeAdView=a},978798:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NativeAdWrapper=void 0;const n=i(197582),r=i(785893),s=n.__importStar(i(516778)),a=n.__importDefault(i(846025)),o=i(686168),l=n.__importDefault(i(243431));class d extends s.Component{constructor(e){super(e),this._notifyAdError=e=>{this.props.onAdFailed&&this.props.onAdFailed({nativeEvent:e},Date.now()-this._startFetchTime)},this._notifyAdLoaded=()=>{const e=Date.now()-this._startFetchTime;this.props.onAdRegistered&&this.props.onAdRegistered(e),this.props.onAdLoaded&&this.props.onAdLoaded({nativeEvent:this.state.ad},e),this.props.onLoggingAdImpression&&this.props.onLoggingAdImpression()},this._performAction=()=>{this.state.ad&&this.state.ad.callToActionTarget&&(this.props.onAdClicked&&this.props.onAdClicked({nativeEvent:this.state.ad}),this.state.ad.callToActionFn?this.state.ad.callToActionFn():a.default.openUrl(this.state.ad.callToActionTarget))},this.state={}}componentDidMount(){super.componentDidMount&&super.componentDidMount(),this._startFetchTime=Date.now(),this._fetchAd()}_fetchAd(){const e=l.default.Instance.fetchAd(this.props.placementId,this.props.adId);if(!e)return this.state.ad&&this.setState({ad:void 0}),void this._notifyAdError(o.NativeAdsError.AdIsNull);this._isValid(e)?this.setState({ad:e},(()=>{this._notifyAdLoaded()})):this._notifyAdError(o.NativeAdsError.AdIsNotValid)}_isValid(e){return!!(e.adChoicesLinkUrl&&e.title&&e.socialContext&&e.mediaUrl&&e.callToActionTarget&&e.impressionTrackingUrl)}render(){if(!this.state.ad)return null;const e=this.props.renderAd({ad:this.state.ad,provider:this.props.provider,performAction:this._performAction});return(0,r.jsx)(s.View,Object.assign({},this.props,{children:e}))}}t.NativeAdWrapper=d},243431:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=new class{}},122792:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582).__importStar(i(496486));t.default=class{static isNonEmptyString(e){return!(!n.isString(e)||0===e.trim().length)}static bubbleUpTheError(e,t,i){e.onAdsError&&e.onAdsError({errorCode:t,errorMessage:i})}}},149827:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});i(197582).__exportStar(i(534178),t)},934552:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NetworkInfoBase=void 0;t.NetworkInfoBase=class{}},295249:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(599286),t);var r=i(599286);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},599286:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NetworkInfo=void 0;const n=i(197582).__importStar(i(397691)),r=i(934552);class s extends r.NetworkInfoBase{getSSID(){return n.Rejected("Requested Information Unavailable")}getBSSID(){return n.Rejected("Requested Information Unavailable")}getIPAddress(){return n.Rejected("Requested Information Unavailable")}getIPV4Address(){return n.Rejected("Requested Information Unavailable")}}t.NetworkInfo=s,t.default=new s},199118:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(480744),t);var r=i(480744);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},480744:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582).__importStar(i(397691));t.default=new class{constructor(){this._count=-1}setCount(e){e<0&&(e=0),"undefined"!=typeof window&&void 0!==window.electronApi?window.electronApi.ipcProvider.app.setBadgeCount.send(e):"undefined"!=typeof window&&void 0!==window.document&&this._setWebCount(e),this._count=e}getCount(){return n.Resolved(this._count)}setPresence(e){}_setWebCount(e){void 0===this._title&&(this._title=window.document.title),void 0===this._faviconHref&&(this._faviconHref=this._getHref("favicon")),void 0===this._unreadFaviconHref&&(this._unreadFaviconHref=this._getHref("favicon-unread"));const t=e?"("+e+") ":"";if(window.document.title=t+this._title,this._faviconHref&&this._unreadFaviconHref){const t=window.document.getElementById("favicon");t&&t.setAttribute("href",e?this._unreadFaviconHref:this._faviconHref)}}_getHref(e){const t=window.document.getElementById(e);return t&&t.getAttribute("href")||void 0}}},198796:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NotificationsLocalBase=t.NotificationsPushBase=t.NotificationActionBehavior=t.AndroidNotificationProvider=t.NotificationActionActivationMode=t.NotificationCategoryContext=t.NotificationPermissionState=t.NotificationPriority=void 0;const n=i(197582),r=n.__importStar(i(167606)),s=n.__importDefault(i(974634)),a=n.__importStar(i(397691));var o,l,d,c,h,u;!function(e){e[e.Minimal=-2]="Minimal",e[e.Low=-1]="Low",e[e.Normal=0]="Normal",e[e.High=1]="High",e[e.Max=2]="Max"}(o||(t.NotificationPriority=o={})),function(e){e[e.Default=0]="Default",e[e.Granted=1]="Granted",e[e.Denied=2]="Denied"}(l||(t.NotificationPermissionState=l={})),function(e){e[e.Default=0]="Default",e[e.Minimal=1]="Minimal"}(d||(t.NotificationCategoryContext=d={})),function(e){e[e.Foreground=0]="Foreground",e[e.Background=1]="Background"}(c||(t.NotificationActionActivationMode=c={})),function(e){e.FCM="fcm",e.ADM="adm"}(h||(t.AndroidNotificationProvider=h={})),function(e){e[e.Default=0]="Default",e[e.TextInput=1]="TextInput"}(u||(t.NotificationActionBehavior=u={}));t.NotificationsPushBase=class{constructor(){this._shouldSuppressRing=!1,this.registrationTokenReceivedEvent=new s.default,this.registrationAlertTokenReceivedEvent=new s.default,this.gaveUpOnFetchingRegistrationTokenEvent=new s.default,this.nonFatalErrorFetchingRegistrationTokenEvent=new s.default,this.registrationTokenInvalidatedEvent=new s.default,this.notificationReceivedEvent=new s.default,this._regTokenReceived=e=>{this._registrationToken=e,this.registrationTokenReceivedEvent.fire(this._registrationToken)},this._regAlertTokenReceived=e=>{this._registrationAlertToken=e,this.registrationAlertTokenReceivedEvent.fire(this._registrationAlertToken)},this._regTokenInvalidated=()=>{this._registrationToken=void 0,this.registrationTokenInvalidatedEvent.fire()},this._notificationQueueDrainedYet=!1,this._notificationQueue=[],this._notificationReceived=e=>{r.log(r.LogTraceArea.Notifications,"Push notification received - category: "+e.category+", identifier: "+e.id),this._notificationQueueDrainedYet||this._notificationQueue.push(e),this.notificationReceivedEvent.fire(e)}}getRegistrationToken(){return this._registrationToken}getAlertRegistrationToken(){return this._registrationAlertToken}isRingSuppressed(){return this._shouldSuppressRing}chatNotficationsToggleButtonChanged(e){}setEnableAlertNotifications(e){this._configuration.enableAlertNotifications=e}getAndroidNotificationProvider(){}drainInitialNotificationQueue(){r.log(r.LogTraceArea.Notifications,"Draining initial push notifications queue."),this._notificationQueueDrainedYet=!0;const e=this._notificationQueue;return this._notificationQueue=[],e}initialize(e){return r.log(r.LogTraceArea.Notifications,"Initializing push notifications module"),this.initializeInternal(e)}uninitialize(){return r.log(r.LogTraceArea.Notifications,"Uninitializing push notifications module"),this.uninitializeInternal()}};t.NotificationsLocalBase=class{constructor(){this.localNotificationEventReceivedEvent=new s.default,this.localNotificationEventReceivedLogMessageEvent=new s.default,this._notificationQueueDrainedYet=!1,this._notificationQueue=[],this._notificationProcessingDetached=!1,this._notificationReceived=e=>{r.log(r.LogTraceArea.Notifications,"Local notification received - category: "+e.category+", identifier: "+e.identifier),this._notificationQueueDrainedYet||this._notificationQueue.push(e),this._notificationProcessingDetached?e.notificationProcessingId&&this.notificationProcessingCompleted(e.notificationProcessingId):this.localNotificationEventReceivedEvent.fire(e)},this._notificationReceivedError=e=>{r.log(r.LogTraceArea.Notifications,"Local notification received error - message: "+e),this.localNotificationEventReceivedLogMessageEvent.fire(e)}}drainInitialNotificationQueue(){r.log(r.LogTraceArea.Notifications,"Draining initial local notifications queue."),this._notificationQueueDrainedYet=!0;const e=this._notificationQueue;return this._notificationQueue=[],e}initialize(e){return r.log(r.LogTraceArea.Notifications,"Initializing local notifications module"),this.initializeInternal(e)}uninitialize(){r.log(r.LogTraceArea.Notifications,"Uninitializing local notifications module"),this._notificationProcessingDetached=!0,this.uninitializeInternal()}show(e,t){return r.log(r.LogTraceArea.Notifications,"Preparing to show local notification - category: "+e.category+", correlationId: "+e.correlationId),this.showInternal(e,t)}uninitializeInternal(){}setActiveConversation(e,t,i){}resetNotificationSettings(){return a.Resolved(!1)}openSystemNotificationConfiguration(){}createNotificationChannelsIfNeeded(){}clearCachedIcons(){return a.Resolved()}}},279211:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});i(197582).__exportStar(i(135698),t)},909019:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Local=t.hasNotificationSupport=void 0;const n=i(197582),r=n.__importDefault(i(499560)),s=n.__importStar(i(496486)),a=n.__importStar(i(167606)),o=n.__importStar(i(397691)),l=i(815063),d=i(198796),c=n.__importDefault(i(760989)),h=n.__importStar(i(535775)),u=i(380157),p=n.__importDefault(i(444948));var g;!function(e){e.default="default",e.granted="granted",e.denied="denied"}(g||(g={}));const m="NavContext_",f="root";var S;!function(e){e[e.Unknown=0]="Unknown",e[e.ClaimedHere=1]="ClaimedHere",e[e.ClaimedElsewhere=2]="ClaimedElsewhere"}(S||(S={})),t.hasNotificationSupport=function(){if(!l.BrowserEnvironment.supportsNotifications())return!1;if(Notification.permission!==g.granted)try{return!!new Notification("")}catch(e){if("TypeError"===e.name)return!1}return!0}();class v extends d.NotificationsLocalBase{constructor(e){super(),this._pausingAudio=!1,this._playNextSound=()=>{if(this._audioElement&&this._audioElement.pause){if(!this._audioElement.paused){if(this._pausingAudio)return;return this._pausingAudio=!0,this._audioElement.pause(),void window.setTimeout(this._playNextSound,150)}try{this._audioElement.src=this._queuedAudioUrl||"",this._audioElement.load(),this._audioElement.currentTime=0,this._audioElement.play()}catch(e){console.warn("Overlapping file play errors: ",e)}this._queuedAudioUrl=void 0}},this._notificationReceivedCallback=e||this._notificationReceived,this._permissions=new y,this._audioElement=window.document.createElement("audio"),window.addEventListener("unload",(()=>{this._multiTabHelper&&this._multiTabHelper.clearSharedState()}))}initializeInternal(e){return this._permissions.getState()===d.NotificationPermissionState.Granted?o.Resolved(u.PermissionStatus.Granted):this._permissions.request(!e.startupInitialization).always((()=>p.default.convertNotificationPermissionStatus(this._permissions.getState())))}uninitializeInternal(){this._multiTabHelper&&this._multiTabHelper.clearSharedState()}showInternal(e,i){if(!t.hasNotificationSupport)return o.Resolved();if(this._multiTabHelper&&this._userMri&&this._multiTabHelper.isNotificationShownElsewhere(this._userMri,e.conversationId))return a.log(a.LogTraceArea.Notifications,"Notification ignored, HTML notification is shown in another tab"),o.Resolved();const n=this;i=i||v._NOTIFICATION_TIMEOUT;const r={body:e.message,tag:e.tag,icon:"string"==typeof e.icon?e.icon:void 0,silent:!(!e.silent&&!e.sound)},s=new h.default(h.ScenarioName.HtmlNotification);let l,d;s.start();try{l=new Notification(e.title||"",r),a.log(a.LogTraceArea.Notifications,"Initialzed HTML notification for category "+e.category)}catch(e){return a.log(a.LogTraceArea.Notifications,"Something went wrong when trying to show HTML5 notification (error: "+e+")"),s.fail(e.message),o.Rejected(e)}e.sound&&(this._queuedAudioUrl=e.sound.toString(),this._playNextSound());const c=window.setTimeout((()=>n._close(l)),v._MAX_NOTIFICATION_TIMEOUT),u=()=>{n._audioElement&&n._audioElement.pause&&n._audioElement.pause(),d&&window.clearTimeout(d),window.clearTimeout(c),n._close(l)};return l.onshow=()=>{s.finish(),a.log(a.LogTraceArea.Notifications,"Showing HTML notification for category "+e.category),d=window.setTimeout((()=>n._close(l)),i)},l.onclick=t=>{a.log(a.LogTraceArea.Notifications,"HTML notification clicked for category "+e.category),t&&t.preventDefault&&t.preventDefault(),u();const i={category:e.category||"",identifier:"_default_",serviceSpecificData:e.serviceSpecificData};this._notificationReceivedCallback(i)},l.onclose=()=>{a.log(a.LogTraceArea.Notifications,"HTML notification closed for category "+e.category),u()},l.onerror=()=>{s.fail("API error"),a.log(a.LogTraceArea.Notifications,`Unknown HTML notification error, probably it was not shown. Notifacation category: ${e.category}`),u()},o.Resolved()}setConfig(e){e.Web&&e.Web.MultiTabNotifications&&e.Web.MultiTabNotifications.enabled?this._multiTabHelper||(this._multiTabHelper=new C):this._multiTabHelper&&(this._multiTabHelper.clearSharedState(),this._multiTabHelper=void 0)}_close(e){try{e.close&&e.close()}catch(e){console.warn("Notification.close() failed: ",e)}}cancel(e){}cancelScheduledNotification(e){}cancelNotificationsByCategoryIdentifier(e){}registerCategories(e){}getNotificationPermissionStatus(){return o.Resolved(this._permissions.getState())}supportsStackedNotifications(){return o.Resolved(!1)}notificationProcessingCompleted(e){}backgroundPushProcessingCompleted(){}setActiveConversation(e,t,i){this._userMri=e,this._multiTabHelper&&this._multiTabHelper.setActiveConversation(e,t,i)}}t.Local=v,v._MAX_NOTIFICATION_TIMEOUT=3e4,v._NOTIFICATION_TIMEOUT=15e3;class y{getState(){return y.fromBrowserState()}request(e){const i=o.Defer();return t.hasNotificationSupport&&Notification.requestPermission&&(e||!l.BrowserEnvironment.isEngineChromiumEdge())?Notification.requestPermission((e=>{"granted"===e?i.resolve(void 0):i.reject()})).catch((()=>{i.reject()})):i.reject(new Error("Notifications not available in the current environment")),i.promise()}static fromBrowserState(){switch(t.hasNotificationSupport&&Notification.permission||g.default){case g.default:return d.NotificationPermissionState.Default;case g.granted:return d.NotificationPermissionState.Granted;case g.denied:return d.NotificationPermissionState.Denied}return d.NotificationPermissionState.Default}}class C{constructor(){this._localKeyValueCache={},this._tabId=c.default.newGuid()}_makeKeys(e,t){const i=e,n=i+"_"+(t||f),s=i+"_"+f;return{perUserKey:m+(0,r.default)(i).toString(),perConvKey:m+(0,r.default)(n).toString(),noConvKey:m+(0,r.default)(s).toString()}}_getKeyState(e,t){const i=window.localStorage.getItem(e);if(i){const e=s.split(i," ");if(3===e.length){const[i,n,r]=e;if(t<=s.toNumber(n)+s.toNumber(r))return i===this._tabId?S.ClaimedHere:S.ClaimedElsewhere}}return S.Unknown}setActiveConversation(e,t,i){const n=this._makeKeys(e,t),r=this._tabId+" "+Date.now()+" "+i;this._localKeyValueCache[n.perUserKey]=r,this._localKeyValueCache[n.perConvKey]=r,s.attempt((()=>{window.localStorage.setItem(n.perUserKey,r),window.localStorage.setItem(n.perConvKey,r)}))}isNotificationShownElsewhere(e,t){const i=this._makeKeys(e,t),n=Date.now(),r=this._getKeyState(i.perConvKey,n);if(r===S.ClaimedHere)return!1;if(r===S.ClaimedElsewhere)return!0;const s=this._getKeyState(i.noConvKey,n);if(s===S.ClaimedHere)return!1;if(s===S.ClaimedElsewhere)return!0;return this._getKeyState(i.perUserKey,n)===S.ClaimedElsewhere}clearSharedState(){s.forOwn(this._localKeyValueCache,((e,t)=>{e===window.localStorage.getItem(t)&&window.localStorage.removeItem(t)})),this._localKeyValueCache={};const e=Date.now();let t=0;for(t=0;;t++){const i=window.localStorage.key(t);if(null===i)break;s.startsWith(i,m)&&this._getKeyState(i,e)===S.Unknown&&window.localStorage.removeItem(i)}}}},135698:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PushNotifications=t.LocalNotifications=t.AndroidNotificationProvider=t.NotificationActionBehavior=t.NotificationActionActivationMode=t.NotificationCategoryContext=t.NotificationPermissionState=t.NotificationPriority=void 0;const n=i(197582),r=n.__importStar(i(397691)),s=n.__importStar(i(909019)),a=i(198796),o=i(380157);var l=i(198796);Object.defineProperty(t,"NotificationPriority",{enumerable:!0,get:function(){return l.NotificationPriority}}),Object.defineProperty(t,"NotificationPermissionState",{enumerable:!0,get:function(){return l.NotificationPermissionState}}),Object.defineProperty(t,"NotificationCategoryContext",{enumerable:!0,get:function(){return l.NotificationCategoryContext}}),Object.defineProperty(t,"NotificationActionActivationMode",{enumerable:!0,get:function(){return l.NotificationActionActivationMode}}),Object.defineProperty(t,"NotificationActionBehavior",{enumerable:!0,get:function(){return l.NotificationActionBehavior}}),Object.defineProperty(t,"AndroidNotificationProvider",{enumerable:!0,get:function(){return l.AndroidNotificationProvider}});class d extends a.NotificationsPushBase{initializeInternal(e){return this._configuration||(this._configuration=e),r.Resolved(o.PermissionStatus.Granted)}uninitializeInternal(){return r.Resolved(!0)}acknowledgeNotificationReceived(e){return r.Resolved()}getUnacknowledgedNotifications(){return r.Resolved([])}clearUnacknowledgedNotifications(){return r.Resolved([])}mostRecentPendingNotification(){return r.Resolved(void 0)}mostRecentPendingNotificationSync(){}showIncomingRing(e){}onCallStarted(e){}onCallEnded(e){}onCallScreenClose(){}onCallScreenRendered(e){}}class c extends a.NotificationsLocalBase{initializeInternal(e){return r.Resolved(o.PermissionStatus.Denied)}showInternal(e,t){return r.Resolved()}setConfig(e){}cancel(e){}cancelScheduledNotification(e){}cancelNotificationsByCategoryIdentifier(e){}registerCategories(e){}getNotificationPermissionStatus(){return r.Resolved(a.NotificationPermissionState.Denied)}notificationProcessingCompleted(e){}backgroundPushProcessingCompleted(){}supportsStackedNotifications(){return r.Resolved(!1)}}t.LocalNotifications=s.hasNotificationSupport?new s.Local:new c,t.PushNotifications=new d},680459:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PaymentStatus=t.SubscriptionPeriodUnit=t.PaymentProduct=void 0;var i,n;t.PaymentProduct=class{constructor(){}},function(e){e.DAY="DAY",e.WEEK="WEEK",e.MONTH="MONTH",e.YEAR="YEAR"}(i||(t.SubscriptionPeriodUnit=i={})),function(e){e[e.CONFIRMED=0]="CONFIRMED",e[e.FAILED=1]="FAILED"}(n||(t.PaymentStatus=n={}))},558387:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PaymentMethod=t.SubscriptionPeriodUnit=t.PaymentStatus=t.PaymentProduct=void 0;const n=i(197582).__importStar(i(397691)),r=i(680459);Object.defineProperty(t,"PaymentProduct",{enumerable:!0,get:function(){return r.PaymentProduct}}),Object.defineProperty(t,"PaymentStatus",{enumerable:!0,get:function(){return r.PaymentStatus}}),Object.defineProperty(t,"SubscriptionPeriodUnit",{enumerable:!0,get:function(){return r.SubscriptionPeriodUnit}});class s{getProducts(e){return n.Rejected("Method not supported!")}startTransaction(e,t){return n.Rejected("Method not supported!")}finishTransaction(e,t){return n.Rejected("Method not supported!")}unsubscribeToPaymentStatusChanges(e){}subscribeToPaymentStatusChanges(e){}suspendPaymentStatusChanges(){}getPromotedProduct(){return n.Rejected("Method not supported!")}buyPromotedProduct(){return n.Rejected("Method not supported!")}}t.PaymentMethod=s,t.default=new s},825390:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(558387),t);var r=i(558387);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},665844:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});i(197582).__exportStar(i(451198),t)},451198:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PesTabViewNoPaging=t.PesPackHorizontalListView=t.PesTabView=t.PesListView=void 0;const n=i(197582).__importStar(i(516778)),r=i(121428);Object.defineProperty(t,"PesListView",{enumerable:!0,get:function(){return r.PesListView}});const s=i(439801);Object.defineProperty(t,"PesTabView",{enumerable:!0,get:function(){return s.PesTabView}});class a extends n.Component{render(){return null}showTab(e,t=!1){}}t.PesTabViewNoPaging=a;class o extends n.Component{render(){return null}setBackgroundUpdatePriority(e){}}t.PesPackHorizontalListView=o},121428:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PesListView=void 0;const n=i(197582),r=i(785893),s=n.__importStar(i(496486)),a=n.__importStar(i(516778)),o=(0,i(26703).lazyProperties)({items:()=>a.Styles.createViewStyle({flexDirection:"row",flexWrap:"wrap"})});class l extends a.Component{constructor(){super(...arguments),this._lastScrollTopKeyboardFocus=0,this._lastScrollTop=-1,this._fullListcontainerHeight=0,this._visibleContainerHeight=0,this._onScrollViewRef=e=>{this._scrollViewRef=e},this._onKeyPress=e=>{if(this.props.onKeyPress&&this.props.onKeyPress(e),!this.props.setScrollTopOnKeyboardNavigation||38!==e.keyCode&&40!==e.keyCode||!this._scrollViewRef)return;this._lastScrollTop>-1&&this._lastScrollTopKeyboardFocus!==this._lastScrollTop&&(this._lastScrollTopKeyboardFocus=this._lastScrollTop);let t=38===e.keyCode?this._lastScrollTopKeyboardFocus-this.props.itemHeight:this._lastScrollTopKeyboardFocus+this.props.itemHeight;const i=this._fullListcontainerHeight-this._visibleContainerHeight;t>i?t=i:t<0&&(t=0),t!==this._lastScrollTopKeyboardFocus&&(this._lastScrollTopKeyboardFocus=t,this._scrollViewRef.setScrollTop(this._lastScrollTopKeyboardFocus))},this._onScrollLayout=e=>{this._visibleContainerHeight=e.height},this._onLayout=e=>{this._fullListcontainerHeight=e.height},this._onScroll=(e,t)=>{this._lastScrollTop=e,this.props.onScrolled&&this.props.onScrolled()},this._renderSection=e=>(0,r.jsxs)(a.View,{children:[this.props.renderPackHeader(e),(0,r.jsx)(a.View,{style:o.items,children:s.map(this.props.packs[e],this.props.renderPackItem)})]},e)}render(){const e=s.keys(this.props.packs);return this.props.setScrollTopOnKeyboardNavigation?(0,r.jsx)(a.ScrollView,{ref:this._onScrollViewRef,keyboardShouldPersistTaps:!0,style:this.props.style,scrollEventThrottle:32,onScroll:this._onScroll,onKeyPress:this._onKeyPress,onLayout:this._onScrollLayout,children:(0,r.jsx)(a.View,{onLayout:this._onLayout,children:s.map(e,this._renderSection)})}):(0,r.jsx)(a.ScrollView,{ref:this._onScrollViewRef,keyboardShouldPersistTaps:!0,style:this.props.style,scrollEventThrottle:32,onScroll:this._onScroll,onKeyPress:this._onKeyPress,children:s.map(e,this._renderSection)})}}t.PesListView=l},439801:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PesTabView=void 0;const n=i(197582),r=n.__importStar(i(496486)),s=n.__importStar(i(516778)),a=n.__importDefault(i(114818));class o extends s.Component{constructor(e){super(e),this._showTab=e=>{if(e!==this.state.currentTab){const t=e||this.props.tabs[0];this.setState({currentTab:t})}},this.showTab=(e,t=!0)=>{this._showTab(e)},this._renderTabContent=e=>this.props.renderTab(e),this.state={currentTab:e.initialTab||e.tabs[0]}}UNSAFE_componentWillReceiveProps(e){if(!(0,a.default)(this.props.tabs,e.tabs)){const t=r.find(e.tabs,(e=>e.id===this.state.currentTab.id))||e.tabs[0];this._showTab(t)}}render(){return this._renderTabContent(this.state.currentTab)}}t.PesTabView=o},53353:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ActionMenuBase=void 0;t.ActionMenuBase=class{}},402170:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ActionMenu=t.ContextMenu=t.ActionMenuImpl=void 0;const n=i(197582).__importStar(i(516778)),r=i(53353);class s extends r.ActionMenuBase{show(e,t){}}t.ActionMenuImpl=s;class a extends n.Component{render(){return null}showContextMenu(){}}t.ContextMenu=a,t.ActionMenu=new s},762025:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});i(197582).__exportStar(i(402170),t)},620529:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(759374),t);var r=i(759374);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},759374:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=n.__importStar(i(516778)),a=n.__importDefault(i(179361));class o extends s.Component{static isSupported(){return!0}render(){const e=this.props.iconSrc?{src:this.props.iconSrc,height:this.props.iconHeight,width:this.props.iconWidth,excavate:this.props.iconExcavate,x:this.props.iconX,y:this.props.iconY}:void 0;return(0,r.jsx)(s.View,{style:this.props.style,children:this.props.children||(0,r.jsx)(a.default,{size:this.props.size,value:this.props.message,bgColor:this.props.backgroundColor,fgColor:this.props.color,level:this.props.correctionLevel,includeMargin:this.props.includeMargin,imageSettings:e})})}}t.default=o},92759:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(999957),t);var r=i(999957);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},999957:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=new class{reload(){window.electronApi&&window.electronApi.ipcProvider.app.notifyAppReloading.send(),window.location.reload(!0)}exit(){window.electronApi&&window.electronApi.ipcProvider.app.manualExitApp.send()}}},560679:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(865326),t);var r=i(865326);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},865326:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(240265);t.default=new class{setImage(e){}setHtml(e,t){const i=t=>{t.clipboardData&&(t.clipboardData.setData("text/html",e),t.preventDefault())};document.addEventListener("copy",i);try{(0,n.writeTextToClipboard)(t)}finally{document.removeEventListener("copy",i)}}}},271675:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.ShareMenuBase=t.ShareMenuActivityType=void 0,function(e){e[e.Facebook=0]="Facebook",e[e.Twitter=1]="Twitter",e[e.Weibo=2]="Weibo",e[e.Message=3]="Message",e[e.Mail=4]="Mail",e[e.CameraRoll=5]="CameraRoll",e[e.ReadingList=6]="ReadingList",e[e.Flickr=7]="Flickr",e[e.Vimeo=8]="Vimeo",e[e.TencentWeibo=9]="TencentWeibo",e[e.AirDrop=10]="AirDrop",e[e.Print=11]="Print",e[e.CopyToPasteboard=12]="CopyToPasteboard",e[e.AssignToContact=13]="AssignToContact",e[e.LinkedIn=14]="LinkedIn",e[e.Aperture=15]="Aperture",e[e.TwitterProfileImage=16]="TwitterProfileImage",e[e.FacebookProfileImage=17]="FacebookProfileImage",e[e.LinkedInProfileImage=18]="LinkedInProfileImage",e[e.DesktopPicture=19]="DesktopPicture",e[e.Youku=20]="Youku",e[e.Tudou=21]="Tudou"}(i||(t.ShareMenuActivityType=i={}));t.ShareMenuBase=class{}},579713:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(425320),t);var r=i(425320);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},425320:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ShareMenu=t.ShareMenuActivityType=void 0;const n=i(271675);Object.defineProperty(t,"ShareMenuActivityType",{enumerable:!0,get:function(){return n.ShareMenuActivityType}});class r extends n.ShareMenuBase{show(e,t,i){}}t.ShareMenu=new r,t.default=t.ShareMenu},195279:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582).__importStar(i(397691));t.default=new class{donateConversationForShareSuggestion(e,t,i){return n.Resolved()}removeAllDonatedConversationsOnLogout(){return n.Resolved()}}},22404:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(195279),t);var r=i(195279);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},541356:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ShareToAppBase=void 0;t.ShareToAppBase=class{}},533440:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ShareToApp=void 0;const n=i(541356);class r extends n.ShareToAppBase{setListener(e,t){}removeListener(){}launchSkypeApp(){}open(e,t){}close(e){}clearDirectShareShortcuts(){}exposeDirectShareShortcuts(e){}}t.ShareToApp=r,t.default=new r},941259:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(533440),t);var r=i(533440);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},208607:(e,t)=>{"use strict";var i,n,r,s;Object.defineProperty(t,"__esModule",{value:!0}),t.PastedTextType=t.AccessibilityAnnouncement=t.AgnosticContentPosition=t.EditableEntityType=void 0,function(e){e.Agnostic="agnostic",e.AtMention="atMention",e.Emoticon="emoticon",e.Link="link",e.PlainText="plainText",e.HTML="html",e.SlashCommand="slashCommand"}(i||(t.EditableEntityType=i={})),function(e){e.Leading="leading",e.InPlaceWithTextStream="inPlace",e.Tailing="tailing"}(n||(t.AgnosticContentPosition=n={})),function(e){e[e.NewLineAdded=0]="NewLineAdded"}(r||(t.AccessibilityAnnouncement=r={})),function(e){e[e.None=0]="None",e[e.PlainText=1]="PlainText",e[e.HtmlText=2]="HtmlText",e[e.Link=3]="Link",e[e.EscapedLink=4]="EscapedLink",e[e.DraggedPlainText=5]="DraggedPlainText",e[e.DraggedHtmlText=6]="DraggedHtmlText",e[e.DraggedLink=7]="DraggedLink",e[e.DraggedEscapedLink=8]="DraggedEscapedLink",e[e.QuickReply=9]="QuickReply"}(s||(t.PastedTextType=s={}))},6625:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ContentUpdatedEventSender=t.ComposingIndicationEventSender=t.UncommittedChangesEventSender=t.EqualsInitialContentEventSender=t.EmptyIndicationEventSender=t.default=void 0;const n=i(197582);n.__exportStar(i(361313),t);var r=i(361313);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}});var s=i(543323);Object.defineProperty(t,"EmptyIndicationEventSender",{enumerable:!0,get:function(){return n.__importDefault(s).default}});var a=i(95078);Object.defineProperty(t,"EqualsInitialContentEventSender",{enumerable:!0,get:function(){return n.__importDefault(a).default}});var o=i(790043);Object.defineProperty(t,"UncommittedChangesEventSender",{enumerable:!0,get:function(){return n.__importDefault(o).default}});var l=i(888680);Object.defineProperty(t,"ComposingIndicationEventSender",{enumerable:!0,get:function(){return n.__importDefault(l).default}});var d=i(542998);Object.defineProperty(t,"ContentUpdatedEventSender",{enumerable:!0,get:function(){return n.__importDefault(d).default}})},361313:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.unicodeLetterRegex=t.handlePaste=t.dataUpdateReceivedEvent=t.PastedTextType=t.EditableEntityType=t.AgnosticContentPosition=t.AccessibilityAnnouncement=void 0;const n=i(197582),r=n.__importStar(i(496486));String.prototype.startsWith||(String.prototype.startsWith=function(e,t){return r.startsWith(this,e,t)});const s=n.__importDefault(i(935320));var a=i(208607);Object.defineProperty(t,"AccessibilityAnnouncement",{enumerable:!0,get:function(){return a.AccessibilityAnnouncement}}),Object.defineProperty(t,"AgnosticContentPosition",{enumerable:!0,get:function(){return a.AgnosticContentPosition}}),Object.defineProperty(t,"EditableEntityType",{enumerable:!0,get:function(){return a.EditableEntityType}}),Object.defineProperty(t,"PastedTextType",{enumerable:!0,get:function(){return a.PastedTextType}});var o=i(935320);Object.defineProperty(t,"dataUpdateReceivedEvent",{enumerable:!0,get:function(){return o.dataUpdateReceivedEvent}});var l=i(909712);Object.defineProperty(t,"handlePaste",{enumerable:!0,get:function(){return l.handlePaste}}),t.default=s.default,t.unicodeLetterRegex="A-Za-z-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------"},558794:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setConvenienceSpaceReplacingChars=function(e){a=e},t.checkAndEnforceEditConstraints=function(e,t,i,n){const o=t.getPlainText();if(n&&o.length+e.insertedText.length-e.deletionLength>n)return{newContentState:t,preferredCaretPosition:i.getAnchorOffset()};if(i.getAnchorOffset()<2||!i.isCollapsed())return;if(0!==e.deletionLength||1!==e.insertedText.length)return;const l=i.getAnchorOffset();if(o.length<=l-1||" "!==o[l-1]||-1===a.indexOf(e.insertedText))return;const d=s.getSpans(t,l-2,l-1),c=0===d.length?void 0:d[0].span;if(!c||c&&!c.appendConvenienceSpaceOnInsertion())return;let h=r.removeText(t,l-1,l);return h=r.insertText(h,e.insertedText,l-1),{newContentState:h,preferredCaretPosition:l+e.insertedText.length-1}};const n=i(197582),r=n.__importStar(i(217339)),s=n.__importStar(i(537967));let a=".,:;?!"},166691:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.checkAndEnforceEditConstraints=function(e,t,i,n){const a=r.checkAndEnforceEditConstraints(e,t,i,n);if(a)return a;return s.checkAndEnforceEditConstraints(e,t)},t.enforceEditConstraintsForBackspace=function(e,t){return s.enforceEditConstraintsForBackspace(e,t)};const n=i(197582),r=n.__importStar(i(558794)),s=n.__importStar(i(218216))},218216:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.checkAndEnforceEditConstraints=function(e,t){let i;do{if(0===e.deletionLength)break;const n=o.getSpansAndPlainTextSections(t,e.position,e.position+e.deletionLength),r=s.every(n,(e=>!e.span||e.span.getEditSupport()===l.EditSupport.InPlaceEditable));if(0===n.length||r)break;const c=e.position+e.deletionLength;let h={newContentState:t,preferredCaretPosition:void 0};s.eachRight(n,(t=>{if(e.position<=t.spanStart&&c>=t.spanEnd)return t.span&&(h.newContentState=o.undefineSpan(h.newContentState,t)),h.newContentState=a.removeText(h.newContentState,t.spanStart,t.spanEnd),void(h.preferredCaretPosition=t.spanStart);const i=Math.max(e.position,t.spanStart),n=Math.min(c,t.spanEnd);if(i>=n)return;if(!t.span)return h.newContentState=a.removeText(h.newContentState,i,n),void(h.preferredCaretPosition=i);const r=d(h.newContentState,{position:i,deletionLength:n-i,insertedText:""},t);r?h=r:(h.newContentState=a.removeText(h.newContentState,i,n),h.preferredCaretPosition=i)})),i=h}while(0);const n=i?i.newContentState:e.deletionLength>0?a.removeText(t,e.position,e.position+e.deletionLength):t,c=o.getSpan(n,e.position);!function(e,t,i){if(0===e.insertedText.length)return!1;if(e.position>0&&!i){if(o.getSpan(t,e.position-1))return!0}return!!i&&!!i.span}(e,n,c)?i&&(i={newContentState:a.insertText(n,e.insertedText,e.position),preferredCaretPosition:e.position+e.insertedText.length}):i=function(e,t,i){const n={newContentState:e,preferredCaretPosition:void 0};do{if(t.position>0&&!i){if(o.getSpan(e,t.position-1)){let i=a.rangeForCaretPosition(t.position);const s=a.insertText(e,t.insertedText,t.position);i=r.SelectionState.createEmpty("0").merge({anchorOffset:t.position,focusOffset:t.position+t.insertedText.length}),n.newContentState=r.Modifier.applyEntity(s,i,null),n.preferredCaretPosition=t.position+t.insertedText.length;break}}if(!i||!i.span||!i.spanKey)break;const s=a.rangeForCaretPosition(t.position);if(t.position===i.spanStart){n.newContentState=r.Modifier.insertText(n.newContentState,s,t.insertedText),n.preferredCaretPosition=t.position+t.insertedText.length;break}switch(i.span.getEditSupport()){case l.EditSupport.InPlaceEditable:n.newContentState=o.undefineSpan(n.newContentState,i),n.newContentState=r.Modifier.insertText(n.newContentState,s,t.insertedText),n.newContentState=o.defineSpan(n.newContentState,i.spanKey,i.spanStart,i.spanEnd+t.insertedText.length),n.preferredCaretPosition=t.position+t.insertedText.length;break;case l.EditSupport.NotEditable:n.preferredCaretPosition=t.position;break;case l.EditSupport.ConvertToPlainText:n.newContentState=o.undefineSpan(n.newContentState,i),n.newContentState=r.Modifier.insertText(n.newContentState,s,t.insertedText),n.preferredCaretPosition=t.position+t.insertedText.length;break;case l.EditSupport.WordWiseConvertionToPlainText:n.newContentState=o.convertToPlainTextWordWise(i,n.newContentState,t.position),n.newContentState=r.Modifier.insertText(n.newContentState,s,t.insertedText),n.preferredCaretPosition=t.position+t.insertedText.length}}while(0);return n}(n,e,c);return i},t.enforceEditConstraintsForBackspace=function(e,t){if(!t.isCollapsed()||0===t.getAnchorOffset())return;let i;const n=o.getSpan(e,t.getAnchorOffset()-1);n&&(i=d(e,{position:t.getAnchorOffset()-1,deletionLength:1,insertedText:""},n));if(i)return i;const r=e.getPlainText(),s=a.findStartPosOfBackspaceDeletion(r,t.getAnchorOffset());return{newContentState:a.removeText(e,s,t.getAnchorOffset()),preferredCaretPosition:s}};const n=i(197582),r=n.__importStar(i(909041)),s=n.__importStar(i(496486)),a=n.__importStar(i(217339)),o=n.__importStar(i(537967)),l=n.__importStar(i(788661));function d(e,t,i){if(0===t.deletionLength||!i.span)return;const n=t.position,r=t.position+t.deletionLength,s={newContentState:e,preferredCaretPosition:void 0};switch(i.span.getEditSupport()){case l.EditSupport.InPlaceEditable:break;case l.EditSupport.NotEditable:r>=i.spanEnd&&(s.newContentState=o.undefineSpan(s.newContentState,i),s.newContentState=a.removeText(s.newContentState,i.spanStart,Math.max(r,i.spanEnd)),s.preferredCaretPosition=i.spanStart);break;case l.EditSupport.ConvertToPlainText:s.newContentState=o.undefineSpan(s.newContentState,i),s.newContentState=a.removeText(s.newContentState,n,r),s.preferredCaretPosition=n;break;case l.EditSupport.WordWiseConvertionToPlainText:s.newContentState=o.convertToPlainTextWordWise(i,s.newContentState,n),s.newContentState=a.removeText(s.newContentState,n,r),s.preferredCaretPosition=n}return s}},868786:(e,t)=>{"use strict";function i(e,t){let i=0;for(;i<Math.min(e.length,t.length);i++)if(e.charCodeAt(i)!==t.charCodeAt(i))return i;return i}function n(e,t,i){let n=0;for(;n<e.length&&n<t.length&&e.length-n>i&&t.length-n>i;n++)if(e.charCodeAt(e.length-n-1)!==t.charCodeAt(t.length-n-1))return n;return n}Object.defineProperty(t,"__esModule",{value:!0}),t.getTextChanges=function(e,t,r){const s={position:0,deletionLength:0,insertedText:""};do{const a=i(e,t);if(a===e.length&&a===t.length)break;if(a===e.length)return{position:a,deletionLength:0,insertedText:t.substring(a)};const o=n(e,t,a);if(o===e.length)return{position:0,deletionLength:0,insertedText:t.substring(0,t.length-e.length)};if(o===t.length)return{position:0,deletionLength:e.length-t.length,insertedText:""};const l=Math.min(r.getAnchorOffset(),r.getFocusOffset());s.position=l,s.deletionLength=e.length-a-o,s.insertedText=t.substring(a,t.length-o)}while(0);return s}},51715:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=n.__importStar(i(909041)),s=n.__importStar(i(537967));t.default=class{constructor(e){this._isAutoCompletionInProgress=!1,this._view=e}setAutoCompletionTriggers(e){this._autoCompletionTriggers=e?{instantTriggers:e.instantTriggers?e.instantTriggers.map((e=>({pattern:e,regexp:new RegExp(e)}))):void 0,delayedTriggers:e.delayedTriggers?e.delayedTriggers.map((e=>({pattern:e,regexp:new RegExp(e)}))):void 0}:void 0}release(){this.cancelIfActive()}isActive(){return this._isAutoCompletionInProgress}cancelIfActive(){this._abortAutoCompletionRequestIfActive(),this._stopDelayedTriggerTimer()}notifyContentOrSelectionChanged(e){this._stopDelayedTriggerTimer();const t=this._isAutoCompletionInProgress;this._autoCompletionTriggers&&(this._checkSpecificTriggers(e,this._autoCompletionTriggers.instantTriggers||[])||(t?this._checkSpecificTriggers(e,this._autoCompletionTriggers.delayedTriggers||[])||this._abortAutoCompletionRequestIfActive():this._delayedTriggerTimer=window.setTimeout((()=>{!this._isAutoCompletionInProgress&&this._autoCompletionTriggers&&(this._checkSpecificTriggers(e,this._autoCompletionTriggers.delayedTriggers||[])||this._abortAutoCompletionRequestIfActive())}),this._view.getDelayedTriggetWaitTime())))}_checkSpecificTriggers(e,t){const i=e.getSelection();if(!i.isCollapsed()||0===i.getAnchorOffset())return!1;const n=e.getCurrentContent(),a=i.getAnchorOffset(),o=s.getSpans(n,0,a-1),l=o.length>0?o[o.length-1].spanEnd:0;let d=n.getPlainText().substring(l,a);const c=d.lastIndexOf("\n");-1!==c&&(d=d.substring(c+1)),d.length>64&&(d=d.substring(d.length-64,d.length));for(const e of t){const t=d.match(e.regexp);if(t&&2===t.length){const i=t[1],n=this._view.getLocalDataVersion();return this._isAutoCompletionInProgress=!0,this._view.sendOnAutoCompletionRequested(i,e.pattern).then((e=>{if(this._isAutoCompletionInProgress&&n===this._view.getLocalDataVersion()){this._isAutoCompletionInProgress=!1;const t=this._view.insertAutoReplacementResult(this._view.getEditorState(),e,r.SelectionState.createEmpty("0").merge({anchorOffset:a-i.length,focusOffset:a}));this._view.setNewEditorState(t)}})).catch((e=>{n===this._view.getLocalDataVersion()&&(this._isAutoCompletionInProgress=!1)})),!0}}return!1}_abortAutoCompletionRequestIfActive(){this._isAutoCompletionInProgress&&(this._view.sendOnAutoCompletionRequestAborted(),this._isAutoCompletionInProgress=!1)}_stopDelayedTriggerTimer(){void 0!==this._delayedTriggerTimer&&(window.clearTimeout(this._delayedTriggerTimer),this._delayedTriggerTimer=void 0)}}},888680:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582).__importStar(i(496486));t.default=class{constructor(e,t){this._lastEventWasUserActive=!1,this._lastUserActiveEventSentTime=0,this._sendInactiveEventIfRequired=()=>{this._lastEventWasUserActive&&(this._lastEventWasUserActive=!1,this._lastUserActiveEventSentTime=0,this._sendInactiveCallbackDelayed.cancel(),this._inactiveCallback&&this._inactiveCallback())},this._sendInactiveCallbackDelayed=n.debounce(this._sendInactiveEventIfRequired,5e3),this._activeCallback=e,this._inactiveCallback=t}release(){this._sendInactiveCallbackDelayed.cancel(),this._sendInactiveEventIfRequired()}setUserActive(){const e=Date.now();(!this._lastEventWasUserActive||e>this._lastUserActiveEventSentTime+1e4)&&(this._lastEventWasUserActive=!0,this._lastUserActiveEventSentTime=e,this._activeCallback&&this._activeCallback()),this._sendInactiveCallbackDelayed.cancel(),this._sendInactiveCallbackDelayed()}setUserInactive(){this._sendInactiveEventIfRequired()}}},542998:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=class{constructor(e,t,i){this._contentChangedSinceLastUpdate=!1,this._lastContentUpdatedEventSentTime=0,this._intermediateContentUpdatedEventInterval=e,this._callback=t,this._contentProvider=i}reset(){this._stopContentUpdatedEventSendTimer(),this._contentChangedSinceLastUpdate=!1,this._lastContentUpdatedEventSentTime=0}notifyFocusLoss(){this._sendContentUpdateEventIfRequired()}notifyContentChanged(e){if(this._contentChangedSinceLastUpdate=!0,this._intermediateContentUpdatedEventInterval){const t=Date.now(),i=this._lastContentUpdatedEventSentTime+this._intermediateContentUpdatedEventInterval;t>=i?this._sendContentUpdateEventIfRequired(e):(this._stopContentUpdatedEventSendTimer(),this._contentUpdateEventSendTimer=window.setTimeout((()=>{this._sendContentUpdateEventIfRequired()}),i-t))}}setUpdateInterval(e){this._intermediateContentUpdatedEventInterval=e}_sendContentUpdateEventIfRequired(e){this._contentChangedSinceLastUpdate&&(this._stopContentUpdatedEventSendTimer(),this._contentChangedSinceLastUpdate=!1,this._lastContentUpdatedEventSentTime=Date.now(),this._callback&&this._callback(this._contentProvider(e)))}_stopContentUpdatedEventSendTimer(){this._contentUpdateEventSendTimer&&(window.clearTimeout(this._contentUpdateEventSendTimer),this._contentUpdateEventSendTimer=void 0)}}},543323:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=class{constructor(e,t){this._isEmpty=!0,this._isEmptyFunction=e,this._eventCallback=t}isEmpty(){return this._isEmpty}notifyContentChanged(e){const t=this._isEmptyFunction(e);this._eventCallback&&t!==this._isEmpty&&(this._isEmpty=t,this._eventCallback(t))}}},95078:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=class{constructor(e,t){this._isEqual=!0,this._equalsInitialContentFunction=e,this._eventCallback=t}reset(){const e=this._isEqual;this._isEqual=!0,this._eventCallback&&!e&&(this._isEqual=!0,this._eventCallback(!0))}notifyContentChanged(e){const t=this._equalsInitialContentFunction(e);this._eventCallback&&t!==this._isEqual&&(this._isEqual=t,this._eventCallback(t))}}},790043:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=class{constructor(e){this._lastSentIndication=!1,this._eventCallback=e}hasUncommittedChanges(){return this._lastSentIndication}reset(){this._eventCallback&&this._lastSentIndication&&(this._lastSentIndication=!1,this._eventCallback(!1))}notifyContentChanged(){this._eventCallback&&!this._lastSentIndication&&(this._lastSentIndication=!0,this._eventCallback(!0))}}},164685:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=n.__importStar(i(516778)),a=i(26703),o=n.__importDefault(i(699655)),l=n.__importStar(i(788661)),d=(0,a.lazyProperties)({agnosticSpan:()=>s.Styles.createViewStyle({paddingLeft:2,paddingRight:2,borderRadius:4})});class c extends o.default{constructor(e,t){super(e),this._backgroundColor=t}getDisplayText(){return this.data.originalEntity.displayText}getEditSupport(){return l.EditSupport.NotEditable}appendConvenienceSpaceOnInsertion(){return!0}render(e){const t={backgroundColor:this._backgroundColor};return(0,r.jsx)("span",{style:s.Styles.combine(d.agnosticSpan,t),children:e.children})}rendersIntoObjectTextWithComparableText(){return!0}}t.default=c},520925:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=n.__importStar(i(496486)),a=n.__importStar(i(516778)),o=i(26703),l=n.__importDefault(i(699655)),d=n.__importStar(i(788661)),c=(0,o.lazyProperties)({atMentionSpan:()=>a.Styles.createTextStyle({fontFamily:'"SF Bold", "Segoe System UI Bold", "Segoe UI Bold", sans-serif',fontWeight:"400",paddingLeft:2,paddingRight:2,borderRadius:4})});class h extends l.default{constructor(e,t){super(e),this._backgroundColor=t}getDisplayText(){return"@"+this.data.originalEntity.displayText}getEntity(e){const t=s.clone(this.data.originalEntity);return e.length>0&&"@"===e[0]&&(t.displayText=e.substring(1)),t}getEditSupport(){return d.EditSupport.WordWiseConvertionToPlainText}appendConvenienceSpaceOnInsertion(){return!0}render(e){const t={backgroundColor:this._backgroundColor};return(0,r.jsx)("span",{style:a.Styles.combine(c.atMentionSpan,t),children:e.children})}rendersIntoObjectTextWithComparableText(){return!0}}t.default=h},872714:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=i(815063),a=n.__importDefault(i(699655)),o=n.__importStar(i(788661)),l=s.EnvironmentInfo.getPlatformType(),d={spanForGraphicalRender:{backgroundSize:"1.2em",backgroundRepeat:"no-repeat",backgroundPosition:"0.1em 0em",letterSpacing:"0.4em"},ariaLabel:{display:"none"}};class c extends a.default{constructor(e,t){super(e),this._useGraphicalEmoticons=t}getDisplayText(){return this._useGraphicalEmoticons?"":this.data.originalEntity.displayText}getEditSupport(){return o.EditSupport.NotEditable}appendConvenienceSpaceOnInsertion(){return!1}render(e){const t=this.data.originalEntity,i={backgroundImage:`url(${t.url})`};return this._useGraphicalEmoticons?l===s.PlatformType.OSX?this._osxGraphicalRender(e,i):this._defaultGraphicalRender(e,i,t):this._textRender(e)}rendersIntoObjectTextWithComparableText(){return!1}_textRender(e){return(0,r.jsx)("span",{children:e.children})}_defaultGraphicalRender(e,t,i){return(0,r.jsxs)("span",{style:Object.assign(Object.assign({},d.spanForGraphicalRender),t),children:[(0,r.jsx)("span",{style:d.ariaLabel,role:"img","aria-label":i.emoticonName,"aria-hidden":"false"}),e.children]})}_osxGraphicalRender(e,t){return(0,r.jsx)("span",{style:Object.assign(Object.assign({},d.spanForGraphicalRender),t),role:"img",children:e.children})}}t.default=c},293228:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=n.__importStar(i(516778)),a=i(26703),o=n.__importDefault(i(699655)),l=n.__importStar(i(788661)),d=(0,a.lazyProperties)({linkSpan:()=>s.Styles.createTextStyle({textDecorationLine:"underline",padding:2})});class c extends o.default{constructor(e,t){super(e),this._textColor=t}getDisplayText(){return this.data.originalEntity.displayText}getEntity(e){return{type:this.data.originalEntity.type,originId:this.data.originalEntity.originId,displayText:e,href:this.data.originalEntity.href}}getEditSupport(){return l.EditSupport.ConvertToPlainText}appendConvenienceSpaceOnInsertion(){return!1}render(e){const t={color:this._textColor};return(0,r.jsx)("span",{style:s.Styles.combine(d.linkSpan,t),children:e.children})}rendersIntoObjectTextWithComparableText(){return!0}}t.default=c},699655:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.Mutability=t.skypeSpanType=void 0,t.skypeSpanType="Skype",function(e){e.Mutable="MUTABLE",e.Immutable="IMMUTABLE",e.Segmented="SEGMENTED"}(i||(t.Mutability=i={}));t.default=class{constructor(e){this.data={originalEntity:e}}getEntity(e){return this.data.originalEntity}getOriginalDisplayText(){return this.data.originalEntity.displayText}}},537967:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getSpan=function(e,t){const i=e.getFirstBlock();if(!i)return;const n=i.getEntityAt(t);if(!n)return;if(e.getEntity(n).getType()!==a.skypeSpanType)return;let r;return i.findEntityRanges((e=>e.getEntity()===n),((t,i)=>{r={span:e.getEntity(n).getData(),spanKey:n,spanStart:t,spanEnd:i}})),r},t.getSpans=function(e,t,i){const n=e.getFirstBlock();if(!n)return[];const r=[];return n.findEntityRanges((t=>{const i=t.getEntity();return s.isString(i)&&""!==i&&e.getEntity(i).getType()===a.skypeSpanType}),((s,a)=>{if(t<a&&i>=s){const t=n.getEntityAt(s);r.push({span:e.getEntity(t).getData(),spanKey:t,spanStart:s,spanEnd:a})}})),r},t.getSpansAndPlainTextSections=function(e,t,i){const n=e.getFirstBlock();if(!n)return[];const r=[];return n.findEntityRanges((e=>!0),((s,a)=>{if(t<a&&i>=s){const t=n.getEntityAt(s);r.push({span:t?e.getEntity(t).getData():void 0,spanKey:t||void 0,spanStart:s,spanEnd:a})}})),r},t.getSpanCount=function(e,t){const i=e.getFirstBlock();if(!i)return 0;let n=0;return i.findEntityRanges((i=>{const n=i.getEntity();if(!s.isString(n)||""===n)return!1;const r=e.getEntity(n);return r.getType()===a.skypeSpanType&&r.getData().data.originalEntity.type===t}),(()=>{n++})),n},t.defineSpan=o,t.undefineSpan=l,t.convertToPlainTextWordWise=function(e,t,i){const n=t.getPlainText().substring(e.spanStart,i);if(t=l(t,e),!e.spanKey)return t;const r=n.lastIndexOf(" ");return o(t,e.spanKey,e.spanStart,-1===r?e.spanStart:e.spanStart+r)};const n=i(197582),r=i(909041),s=n.__importStar(i(496486)),a=i(699655);function o(e,t,i,n){const s=r.SelectionState.createEmpty("0").merge({anchorOffset:i,focusOffset:n});return r.Modifier.applyEntity(e,s,t)}function l(e,t){const i=r.SelectionState.createEmpty("0").merge({anchorOffset:t.spanStart,focusOffset:t.spanEnd});return r.Modifier.applyEntity(e,i,null)}},217339:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.rangeForCaretPosition=a,t.setCaretPosition=function(e,t,i){return t=Math.min(t,e.getCurrentContent().getPlainText().length),i(),n.EditorState.forceSelection(e,a(t))},t.isUndoKey=function(e){switch(s){case r.PlatformType.Linux:case r.PlatformType.Windows:return 90===e.keyCode&&!e.altKey&&e.ctrlKey&&!e.metaKey&&!e.shiftKey;case r.PlatformType.OSX:return 90===e.keyCode&&!e.altKey&&!e.ctrlKey&&e.metaKey&&!e.shiftKey}return!1},t.isRedoKey=function(e){switch(s){case r.PlatformType.Linux:case r.PlatformType.Windows:return 89===e.keyCode&&!e.altKey&&e.ctrlKey&&!e.metaKey&&!e.shiftKey||90===e.keyCode&&!e.altKey&&e.ctrlKey&&!e.metaKey&&e.shiftKey;case r.PlatformType.OSX:return 90===e.keyCode&&!e.altKey&&!e.ctrlKey&&e.metaKey&&e.shiftKey}return!1},t.insertText=function(e,t,i){return n.Modifier.insertText(e,a(i),t)},t.removeText=function(e,t,i){const r=n.SelectionState.createEmpty("0").merge({anchorOffset:t,focusOffset:i});return n.Modifier.removeRange(e,r,"forward")},t.findStartPosOfBackspaceDeletion=function(e,t){let i=Math.min(t-1,e.length-1);for(;i>=0&&o(e.charCodeAt(i));i--);return i},t.test_setPlatformType=function(e){s=e};const n=i(909041),r=i(815063);let s=r.EnvironmentInfo.getPlatformType();function a(e){return n.SelectionState.createEmpty("0").merge({anchorOffset:e,focusOffset:e})}function o(e){return e>=56320&&e<=57343||8205===e||65039===e}},197477:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=n.__importStar(i(496486)),s=n.__importStar(i(607573)),a=n.__importDefault(i(598178));t.default=class{constructor(e,t){this._htmlContent=e,this._domParser=t,this._rules=[new s.BrRule,new s.CodeRule,new s.GenericBlockElementRule,new s.ItalicsRule,new s.SpanBoldRule,new s.SpanItalicsRule,new s.SpanStrikeRule,new s.ParagraphRule,new s.PreRule,new s.StrikeThroughRule,new s.StrongRule]}parse(){const e=this._domParser.parseFromString(this._prepareHtmlText(this._htmlContent),"text/html");this._rootElement=e.getElementsByTagName("html")[0];const t=this._rootElement.getElementsByTagName("body")[0];return t&&(this._rootElement=t),this.applyAllRules(this._rootElement),this._rootElement.textContent?this._rootElement.textContent.trim():void 0}applyAllRules(e){this._rules.forEach((t=>this.executeRule(e,t)))}executeRule(e,t){t.tagNames().forEach((i=>{const n=e.getElementsByTagName(i);r.each(n,(e=>{if(!t.shouldIgnore(e)&&(e.textContent&&e.textContent.trim().length>1||t.canHaveEmptyContent())){let i="",n="";const a=t.replacementPosition(),o=t.attributes();if(o){if(e.hasAttribute("style")){const l=e.getAttribute("style");let d=!1;r.each(o,((e,t)=>!l||-1===l.indexOf(e)||-1===l.indexOf(t)||(d=!0,!1))),d&&(a!==s.ReplacementPosition.Both&&a!==s.ReplacementPosition.Start||(i=t.replacementStart()),a!==s.ReplacementPosition.Both&&a!==s.ReplacementPosition.End||(n=t.replacementEnd()),this._executeReplacement(e,i,n))}return}a!==s.ReplacementPosition.Both&&a!==s.ReplacementPosition.Start||(i=t.replacementStart()),a!==s.ReplacementPosition.Both&&a!==s.ReplacementPosition.End||(n=t.replacementEnd()),this._executeReplacement(e,i,n)}}))}))}_prepareHtmlText(e){return e=(e=(e=e.replace(/\n/g,"")).replace(/style="/g,' style="')).replace(/style=\'/g," style='")}_executeReplacement(e,t,i){e.innerHTML=a.default.sanitizeHtml(t+e.innerHTML+i)}}},607573:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.GenericBlockElementRule=t.BrRule=t.SpanStrikeRule=t.SpanItalicsRule=t.SpanBoldRule=t.ParagraphRule=t.PreRule=t.CodeRule=t.StrikeThroughRule=t.ItalicsRule=t.StrongRule=t.Rule=t.ReplacementPosition=void 0,function(e){e[e.Start=0]="Start",e[e.End=1]="End",e[e.Both=2]="Both"}(i||(t.ReplacementPosition=i={}));class n{constructor(e,t,i){this._tagNames=e,this._replacement=t,this._attributes=i}tagNames(){return this._tagNames}replacementStart(){return this._replacement}replacementEnd(){return this._replacement}replacementPosition(){return i.Both}canHaveEmptyContent(){return!1}shouldIgnore(e){return!1}attributes(){return this._attributes}}t.Rule=n;class r extends n{_hasPreAsAncestor(e){return!!e.parentElement&&("PRE"===e.parentElement.tagName||this._hasPreAsAncestor(e.parentElement))}shouldIgnore(e){return this._hasPreAsAncestor(e)}}t.StrongRule=class extends r{constructor(){super(["strong","b"],"*")}};t.ItalicsRule=class extends r{constructor(){super(["em","i"],"_")}};t.StrikeThroughRule=class extends r{constructor(){super(["s"],"~")}};t.CodeRule=class extends r{constructor(){super(["code"],"```")}};t.PreRule=class extends n{constructor(){super(["pre"],"```")}replacementStart(){return"\n```"}};t.ParagraphRule=class extends n{constructor(){super(["p"],"\n")}replacementPosition(){return i.End}};t.SpanBoldRule=class extends n{constructor(){super(["span","p"],"*",{"font-weight":"bold"})}};t.SpanItalicsRule=class extends n{constructor(){super(["span","p"],"_",{"font-style":"italic"})}};t.SpanStrikeRule=class extends n{constructor(){super(["span","p"],"~",{"text-decoration":"line-through"})}};t.BrRule=class extends n{constructor(){super(["br"],"\n")}replacementPosition(){return i.Start}canHaveEmptyContent(){return!0}};t.GenericBlockElementRule=class extends n{constructor(){super(["h1","h2","h3","h4","h5","h","ol","ul","address","blockquote","dl","div","fieldset","form","hr"],"\n")}replacementPosition(){return i.Start}}},788661:(e,t)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.EditSupport=void 0,function(e){e[e.InPlaceEditable=0]="InPlaceEditable",e[e.NotEditable=1]="NotEditable",e[e.ConvertToPlainText=2]="ConvertToPlainText",e[e.WordWiseConvertionToPlainText=3]="WordWiseConvertionToPlainText"}(i||(t.EditSupport=i={}))},130890:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(909041),s=n.__importStar(i(496486));t.default=class{constructor(){this._undoStack=[],this._redoStack=[]}pushToUndoStack(e){this._pushSizeCheckedAndSelectionNormalized(this._undoStack,e)}popFromUndoStack(e){if(this._undoStack.length>0)return this._pushSizeCheckedAndSelectionNormalized(this._redoStack,e),s.pullAt(this._undoStack,[this._undoStack.length-1])[0]}popFromRedoStack(e){if(this._redoStack.length>0)return this._pushSizeCheckedAndSelectionNormalized(this._undoStack,e),s.pullAt(this._redoStack,[this._redoStack.length-1])[0]}clear(){this._undoStack=[],this._redoStack=[]}_pushSizeCheckedAndSelectionNormalized(e,t){e.length>=10&&s.pullAt(e,[0]);const i=t.getSelection(),n=r.SelectionState.createEmpty("0").merge({anchorOffset:Math.min(i.getAnchorOffset(),i.getFocusOffset()),focusOffset:Math.max(i.getAnchorOffset(),i.getFocusOffset())});e.push(r.EditorState.forceSelection(t,n))}}},909712:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleCutOrCopy=function(e,t){let i="";t.forEach((e=>{switch(e.type){case a.EditableEntityType.Emoticon:i+="("+e.emoticonName+")";break;default:i+=e.displayText}})),e.clipboardData.setData("text/plain",i)},t.handlePaste=function(e,t,i,n,o,l){var d;let c=e.getData("text/plain"),h=!1;if(n){const i=function(e,t){const i=[];return r.each(e,(e=>{const n=e.getAttribute("href");n&&t&&t(n)&&i.push({href:n,label:e.textContent})})),i}((new DOMParser).parseFromString(e.getData("text/html"),"text/html").links,o),n=2===i.length&&function(e){var t,i;return(null===(t=e[0].href)||void 0===t?void 0:t.includes("onenote:"))||(null===(i=e[1].href)||void 0===i?void 0:i.includes("onenote:"))}(i);if(1===i.length||n){let e=i[0],r=e.label;const s=function(e,t,i,n){const r=e.replace(/[\r\n]/g," ").substring(0,t);if(i){const e=r.substring(0,r.indexOf("onenote:")-1);if(e&&n&&n(e))return e}return r}(c,t,n,o);if(n){const t=(null===(d=i[0].href)||void 0===d?void 0:d.includes("onenote:"))?0:1,n=i[t];e=i[Math.abs(t-1)],r=n.label}if(r=r&&r.replace(/[\r\n]/g," ").trim().substring(0,t),r&&e.href){if(s===r||s===e.href){return{extractedEntities:[{type:a.EditableEntityType.Link,originId:void 0,displayText:r,href:e.href}],pastedTextType:l?a.PastedTextType.DraggedLink:a.PastedTextType.Link}}h=!0}}else i.length>1&&(h=!0)}if(c&&c.length>0){c=e.getData("text/plain").replace(/\r\n/g,"\n").replace(/\r/g,"\n").substring(0,t);const r=i?function(e){const t=new s.default(e,new DOMParser);try{return t.parse()}catch(e){}return}(e.getData("text/html").replace(/\r\n/g,"\n").replace(/\r/g,"\n")):void 0;let o=l?a.PastedTextType.DraggedPlainText:a.PastedTextType.PlainText;i&&r&&(o=l?a.PastedTextType.DraggedHtmlText:a.PastedTextType.HtmlText),n&&h&&(o=l?a.PastedTextType.DraggedEscapedLink:a.PastedTextType.EscapedLink);return{extractedEntities:[{type:a.EditableEntityType.PlainText,originId:void 0,displayText:r||c}],pastedTextType:o}}return};const n=i(197582),r=n.__importStar(i(496486)),s=n.__importDefault(i(197477)),a=n.__importStar(i(208607))},935320:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dataUpdateReceivedEvent=void 0;const n=i(197582),r=i(785893),s=n.__importStar(i(909041)),a=n.__importStar(i(496486)),o=i(815063),l=n.__importStar(i(45697)),d=n.__importStar(i(516778)),c=i(4119),h=n.__importStar(i(409460)),u=n.__importDefault(i(974634)),p=n.__importStar(i(397691)),g=n.__importDefault(i(164685)),m=n.__importDefault(i(520925)),f=n.__importDefault(i(51715)),S=n.__importStar(i(909712)),v=n.__importDefault(i(888680)),y=n.__importDefault(i(542998)),C=n.__importStar(i(217339)),T=n.__importDefault(i(872714)),E=n.__importDefault(i(543323)),_=n.__importDefault(i(95078)),b=n.__importStar(i(208607)),P=n.__importDefault(i(293228)),I=n.__importStar(i(166691)),A=i(699655),R=n.__importStar(i(537967)),w=n.__importStar(i(868786)),M=n.__importDefault(i(790043)),O=n.__importDefault(i(130890));o.EnvironmentInfo.getPlatformType();t.dataUpdateReceivedEvent=new u.default;const D=new RegExp("^[ \\n]*$"),k="rgba(128, 128, 128, 0.3)",N={entities:[],downStreamDataVersion:-1},L={container:{flex:1,overflowY:"auto",overflowX:"hidden",marginTop:3},editorWrapper:{position:"relative",backgroundColor:"transparent",cursor:"text",wordBreak:"break-word",borderLeft:".1px solid transparent",fontVariantLigatures:"none"},placeholderStyle:{position:"absolute",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",width:"100%"}},x=new s.CompositeDecorator([{strategy:(e,t,i)=>{e.findEntityRanges((e=>{const t=e.getEntity();return t&&i.getEntity(t).getType()===A.skypeSpanType}),t)},component:e=>e.contentState.getEntity(e.entityKey).getData().render(e)}]);class F extends d.Component{constructor(e){super(e),this._downstreamDataVersion=0,this._localDataVersion=0,this._leadingAgnosticContent=[],this._tailingAgnosticContent=[],this._isFocused=!1,this._isMounted=!1,this._isShiftPressed=!1,this._undoStack=new O.default,this.onDragDropText=e=>{const t=this._getRemainingCapacity(),i=S.handlePaste(e.dataTransfer,t,!1,!0,this.props.validateUrl,!0);i&&this._onPastingTextToEditor(i)},this._onContainerViewRef=e=>{this._containerViewRef=e||void 0,this.setState({composerWidth:e?e.offsetWidth:0})},this._onEditorRef=e=>{this._draftJsEditorRef=e||void 0},this._onContentUpdated=e=>{this.props.customContext&&t.dataUpdateReceivedEvent.fire({forCustomContext:this.props.customContext,newContent:e})},this._onEscKeyPressed=e=>{if(this._autoCompletionEventSender.isActive()&&this.props.onAutoCompletionNavigationKey)return this.props.onAutoCompletionNavigationKey(e),e.stopPropagation(),void e.preventDefault();this.props.onNewContentAborted&&(this.props.onNewContentAborted(),e.stopPropagation(),e.preventDefault())},this._onNavigationKeyPressed=e=>{38!==e.keyCode||0!==this.state.editorState.getCurrentContent().getPlainText().length?this._autoCompletionEventSender.isActive()&&this.props.onAutoCompletionNavigationKey&&(this.props.onAutoCompletionNavigationKey(e),e.stopPropagation(),e.preventDefault()):this.props.onEditLastMessageRequested&&(this.props.onEditLastMessageRequested(),e.preventDefault(),e.stopPropagation())},this._onReturnKeyPressed=(e,t)=>{const i=e.altKey||e.ctrlKey||e.shiftKey;if(this.state.editorState.isInCompositionMode())return"handled";if(!i&&this._autoCompletionEventSender.isActive()&&this.props.onAutoCompletionNavigationKey)return this.props.onAutoCompletionNavigationKey(e),"handled";const n=!1!==this.props.enterKeyOnExtKeyboardSendsMessage;return n&&!i||!n&&i?(this.props.onNewContentCommitted&&this.props.onNewContentCommitted(this._getEditableContentInternal()),"handled"):(this._insertLineBreak(t),"handled")},this._keyBindingFn=e=>"Insert"!==e.key&&"Help"!==e.key||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey?C.isUndoKey(e)?(e.preventDefault(),e.stopPropagation(),"customized-undo"):C.isRedoKey(e)?(e.preventDefault(),e.stopPropagation(),"customized-redo"):s.getDefaultKeyBinding(e):(e.preventDefault(),e.stopPropagation(),null),this._handleKeyCommand=(e,t)=>{switch(e){case"customized-undo":{const e=this._undoStack.popFromUndoStack(this.state.editorState);return this._restoreState(e),"handled"}case"customized-redo":{const e=this._undoStack.popFromRedoStack(this.state.editorState);return this._restoreState(e),"handled"}case"backspace":{const e=t.getSelection();this.props.onBackspacePressedAtHeadPosition&&0===e.getAnchorOffset()&&0===e.getFocusOffset()&&this.props.onBackspacePressedAtHeadPosition();const i=I.enforceEditConstraintsForBackspace(t.getCurrentContent(),e);if(i){this._undoStack.pushToUndoStack(t);let e=s.EditorState.set(t,{currentContent:i.newContentState});return void 0!==i.preferredCaretPosition&&(e=C.setCaretPosition(e,i.preferredCaretPosition,this._onBeforeFocus)),this._setNewEditorState(e),"handled"}break}case"backspace-to-start-of-line":return t.getSelection().isCollapsed()?"not-handled":"handled"}return"not-handled"},this._handlePastedText=(e,t,i)=>"handled",this._noOpHandler=()=>"handled",this._onCutOrCopy=e=>{const t=this.state.editorState.getSelection(),i=this._getEditableContentInternal(void 0,t).entities;i.length>0&&S.handleCutOrCopy(e,i),e.stopPropagation(),e.preventDefault()},this._onKeyDown=e=>{this._isShiftPressed=e.shiftKey},this._getRemainingCapacity=()=>this.props.maxLength?Math.max(0,this.props.maxLength-this.state.editorState.getCurrentContent().getPlainText().length):void 0,this._onPastingTextToEditor=e=>{const{extractedEntities:t,pastedTextType:i}=e;this.props.onPastingText&&this.props.onPastingText(i);let n=this.state.editorState,r=!0;t.forEach((e=>{n=this._insertEditableEntity(n,e,r,!1),r=!1})),this._setNewEditorState(n).then((()=>{this._scrollToEnd()}))},this._onPaste=e=>{if(this.props.shouldDefaultPaste(e.nativeEvent)){const t=this._getRemainingCapacity(),i=this.props.enableHandlingHTMLonPaste&&!this._isShiftPressed,n=!this._isShiftPressed,r=S.handlePaste(e.clipboardData,t,i,n,this.props.validateUrl);if(r)return this._onPastingTextToEditor(r),e.stopPropagation(),void e.preventDefault()}this.props.onPaste&&this.props.onPaste(e)},this._onFocus=e=>{this._isFocused=!0,this.props.onFocus&&this.props.onFocus()},this._onBlur=e=>{this._isFocused=!1,this._contentUpdatedEventSender.notifyFocusLoss(),this.props.onBlur&&this.props.onBlur()},this._onChangeIntent=e=>{const t=this.state.editorState,n=i.g.getSelection(),r=e.getSelection(),a=n.anchorNode;let o=e;if(a&&a.nodeType===Node.TEXT_NODE&&a.textContent.length>=3&&"\n"===a.textContent[a.textContent.length-1]&&"\n"!==a.textContent[a.textContent.length-2]&&"\n"===a.textContent[a.textContent.length-3]){const t=e.getCurrentContent().getPlainText();r.getAnchorOffset()===t.length&&r.getFocusOffset()===t.length&&(a.nodeValue=a.textContent.substring(0,a.textContent.length-1),o=s.EditorState.forceSelection(o,r))}this._setNewEditorState(o);const l=t.getCurrentContent(),d=l.getPlainText(),c=o.getCurrentContent().getPlainText(),h=t.getSelection();if(d===c)return void(h!==o.getSelection()&&(this._localDataVersion++,this._autoCompletionEventSender.notifyContentOrSelectionChanged(o)));const u=w.getTextChanges(d,c,h),p=I.checkAndEnforceEditConstraints(u,l,h,this.props.maxLength);if(this._undoStack.pushToUndoStack(t),!p)return;let g=s.EditorState.set(o,{currentContent:p.newContentState});void 0!==p.preferredCaretPosition&&(g=C.setCaretPosition(g,p.preferredCaretPosition,this._onBeforeFocus)),this._setNewEditorState(g)},this._isEmptyInternal=e=>!a.isEmpty(e.match(D)),this._equalsInitialContentInternal=e=>{if(e!==this._initialText)return!1;const t=this._calcInvisibleContentString(this.state.editorState.getCurrentContent());return this._initialInvisibleContentString===t},this._equalsContent=e=>{if(this.state.editorState.getCurrentContent().getPlainText()!==e.getPlainText())return!1;return this._calcInvisibleContentString(this.state.editorState.getCurrentContent())===this._calcInvisibleContentString(e)},this._onBeforeFocus=()=>{if(!this._isFocused){const e=this._getDraftJsContentNode();e&&(h.default.setLastFocusedProgrammatically(e),c.FocusArbitratorProvider.requestFocus(this,(()=>{}),(()=>this._isMounted),c.FocusCandidateType.FocusFirst))}};this._autoCompletionEventSender=new f.default(this),this._autoCompletionEventSender.setAutoCompletionTriggers(this.props.autoCompletionTriggers),this._composingIndicationEventSender=new v.default(e.onComposingActive,e.onComposingInactive),this._contentUpdatedEventSender=new y.default(e.intermediateContentUpdatedEventInterval,this._onContentUpdated,(e=>this._getEditableContentInternal(e&&e.getCurrentContent()))),this._emptyIndicationEventSender=new E.default(this._isEmptyInternal,e.onEmptyIndicationChanged),this._equalsInitialContentEventSender=new _.default(this._equalsInitialContentInternal,e.onEqualsInitialContentChanged),this._uncommittedChangesEventSender=new M.default(this.props.onUncommittedChangesIndicationChanged);const n=s.convertFromRaw({blocks:[{key:"0",depth:1,text:"",type:"unstyled",inlineStyleRanges:[],entityRanges:[]}],entityMap:{}});this.state={editorState:s.EditorState.set(s.EditorState.createWithContent(n,x),{allowUndo:!1}),composerWidth:0}}componentDidMount(){this._isMounted=!0;const e=this._getDraftJsContentNode();e&&(e.style.webkitUserModify="read-write-plaintext-only"),a.defer((()=>{this._isMounted&&this.setContent(this.props.initialContent||N)}))}componentWillUnmount(){this._isMounted=!1,this._contentUpdatedEventSender.reset(),this._composingIndicationEventSender.release(),this._autoCompletionEventSender.release()}UNSAFE_componentWillUpdate(e,t,i){this.props.intermediateContentUpdatedEventInterval!==e.intermediateContentUpdatedEventInterval&&this._contentUpdatedEventSender.setUpdateInterval(e.intermediateContentUpdatedEventInterval)}componentDidUpdate(){this.props.onVisibleSelectionRect&&this.state.editorState.getSelection().getHasFocus()&&this.props.onVisibleSelectionRect(this.getVisibleSelectionRect());const e=this._containerViewRef?this._containerViewRef.offsetWidth:0;this.state.composerWidth!==e&&this.setState({composerWidth:this._containerViewRef?this._containerViewRef.offsetWidth:0})}getManagedHtmlElement(){return this._getDraftJsContentNode()}getContent(){return p.Resolved(this._getEditableContentInternal())}setContent(e){this._autoCompletionEventSender.cancelIfActive(),this._downstreamDataVersion=e.downStreamDataVersion;let t="";this._leadingAgnosticContent=[],this._tailingAgnosticContent=[];const i={},n=[];e.entities.forEach(((e,r)=>{const s=this._getDraftEntity(e);let a=!0;if(e.type===b.EditableEntityType.Agnostic){const t=e;switch(t.position){case b.AgnosticContentPosition.Leading:this._leadingAgnosticContent.push(t),a=!1;break;case b.AgnosticContentPosition.InPlaceWithTextStream:break;case b.AgnosticContentPosition.Tailing:this._tailingAgnosticContent.push(t),a=!1}}if(a){const a=s?s.data.getDisplayText():e.displayText.replace(/\r\n/g,"\n").replace(/\r/g,"\n");n.push({offset:t.length,length:a.length,key:r}),t+=a,s&&(i[r]=s)}}));const r={blocks:[{key:"0",depth:1,text:t,type:"unstyled",inlineStyleRanges:[],entityRanges:n}],entityMap:i};this._initialText=t;const a=s.convertFromRaw(r);this._initialInvisibleContentString=this._calcInvisibleContentString(a),this._composingIndicationEventSender.setUserInactive(),this._emptyIndicationEventSender.notifyContentChanged(t),this._equalsInitialContentEventSender.reset(),this._uncommittedChangesEventSender.reset(),this._undoStack.clear();let l=s.EditorState.set(s.EditorState.createWithContent(a,x),{allowUndo:!1});(!o.EnvironmentInfo.isMobile()||this._isFocused||t.length>0)&&(l=C.setCaretPosition(l,t.length,this._onBeforeFocus)),this._localDataVersion++,this._isMounted&&this.setState({editorState:l},(()=>{t.length>0&&this._scrollToEnd()}))}setCaretPosition(e){const t=C.setCaretPosition(this.state.editorState,e,this._onBeforeFocus);this._setNewEditorState(t)}insertContent(e,t){const i=this._insertEditableEntity(this.state.editorState,e,!0,!0,t);a.defer((()=>{this._isMounted&&this._setNewEditorState(i)}))}notifyBackspacePressedExternally(){}isEmpty(){return this._isEmptyInternal(this.state.editorState.getCurrentContent().getPlainText())}hasUncommittedChanges(){return this._uncommittedChangesEventSender.hasUncommittedChanges()}equalsInitialContent(){return this._equalsInitialContentInternal(this.state.editorState.getCurrentContent().getPlainText())}requestFocus(){c.FocusArbitratorProvider.requestFocus(this,(()=>this.focus()),(()=>this._isMounted))}focus(){this._draftJsEditorRef&&this._draftJsEditorRef.focus()}blur(){this._draftJsEditorRef&&this._draftJsEditorRef.blur()}isFocused(){return p.Resolved(this._isFocused)}setAccessibilityFocus(){}dismissKeyboard(){}getVisibleSelectionRect(){return s.getVisibleSelectionRect(window)}render(){const e=this.props.placeholder&&!this.state.editorState.isInCompositionMode()&&0===this.state.editorState.getCurrentContent().getPlainText().length,t=Object.assign(Object.assign({},L.placeholderStyle),{display:e?"block":"none",color:this.props.placeholderTextColor}),i=this.props.style instanceof Array?a.reduce(this.props.style,((e,t)=>a.merge({},e,t))):this.props.style,n=this.props.accessibilityLabel||this.props.placeholder;return(0,r.jsxs)("div",{style:d.Styles.combine(i,L.container),ref:this._onContainerViewRef,onCut:this._onCutOrCopy,onCopy:this._onCutOrCopy,onPaste:this._onPaste,onKeyDown:this._onKeyDown,children:[(0,r.jsx)("div",{style:t,"aria-hidden":"true",children:this.props.placeholder}),(0,r.jsx)("div",{style:L.editorWrapper,dir:"auto",children:(0,r.jsx)(s.Editor,{ariaMultiline:!0,autoCapitalize:"sentences",autoComplete:"on",autoCorrect:"on",ariaLabel:n,editorState:this.state.editorState,keyBindingFn:this._keyBindingFn,handleDrop:this._noOpHandler,handleDroppedFiles:this._noOpHandler,handleKeyCommand:this._handleKeyCommand,handlePastedText:this._handlePastedText,handleReturn:this._onReturnKeyPressed,onBlur:this._onBlur,onChange:this._onChangeIntent,onDownArrow:this._onNavigationKeyPressed,onEscape:this._onEscKeyPressed,onFocus:this._onFocus,onTab:this._onNavigationKeyPressed,onUpArrow:this._onNavigationKeyPressed,ref:this._onEditorRef,spellCheck:!0})})]})}getLocalDataVersion(){return this._localDataVersion}getDelayedTriggetWaitTime(){return this.props.delayedTriggersWaitTime||500}getEditorState(){return this.state.editorState}setNewEditorState(e){this._setNewEditorState(e)}insertAutoReplacementResult(e,t,i){return this._insertEditableEntity(e,t,!0,!0,i)}sendOnAutoCompletionRequested(e,t){return this.props.onAutoCompletionRequested?this.props.onAutoCompletionRequested(e,t):p.Rejected()}sendOnAutoCompletionRequestAborted(){this.props.onAutoCompletionRequestAborted&&this.props.onAutoCompletionRequestAborted()}_onContentChangeApplied(e){const t=e.getCurrentContent().getPlainText();this._composingIndicationEventSender.setUserActive(),this._emptyIndicationEventSender.notifyContentChanged(t),this._equalsInitialContentEventSender.notifyContentChanged(t),this._uncommittedChangesEventSender.notifyContentChanged(),this._autoCompletionEventSender.notifyContentOrSelectionChanged(e),this._contentUpdatedEventSender.notifyContentChanged(e)}_getEditableContentInternal(e,t){const i=e||this.state.editorState.getCurrentContent(),n=t||this._buildAllContentSelection(i),r=i.getPlainText();let s=Math.min(n.getAnchorOffset(),n.getFocusOffset());const a=Math.max(n.getAnchorOffset(),n.getFocusOffset()),o=R.getSpans(i,s,a),l={downStreamDataVersion:this._downstreamDataVersion,entities:[]};this._leadingAgnosticContent.forEach((e=>{l.entities.push(e)}));for(let e=0;e<o.length;e++){const t=o[e];s<t.spanStart&&l.entities.push({type:b.EditableEntityType.PlainText,displayText:r.substring(s,Math.min(t.spanStart,a))});const i=r.substring(Math.max(t.spanStart,s),Math.min(t.spanEnd,a));if(t.span&&l.entities.push(t.span.getEntity(i)),s=t.spanEnd,s>=a)break}return s<a&&l.entities.push({type:b.EditableEntityType.PlainText,displayText:r.substring(s,a)}),this._tailingAgnosticContent.forEach((e=>{l.entities.push(e)})),l}_getDraftEntity(e){switch(e.type){case b.EditableEntityType.Agnostic:{const t=e;return{type:A.skypeSpanType,mutability:A.Mutability.Mutable,data:new g.default(t,this.props.agnosticContentBackgroundColor||k)}}case b.EditableEntityType.AtMention:{const t=e;return{type:A.skypeSpanType,mutability:A.Mutability.Mutable,data:new m.default(t,this.props.atMentionBackgroundColor||"rgba(22, 134, 217, 0.3)")}}case b.EditableEntityType.Emoticon:{const t=e;return{type:A.skypeSpanType,mutability:A.Mutability.Mutable,data:new T.default(t,!!this.props.useGraphicalEmoticons)}}case b.EditableEntityType.Link:{const t=e;return{type:A.skypeSpanType,mutability:A.Mutability.Mutable,data:new P.default(t,this.props.linkTextColor||"#2A91DC")}}case b.EditableEntityType.SlashCommand:{const t=e;return{type:A.skypeSpanType,mutability:A.Mutability.Mutable,data:new g.default(t,this.props.agnosticContentBackgroundColor||k)}}case b.EditableEntityType.PlainText:default:return}}_insertEditableEntity(e,t,i,n,r){const a=r||e.getSelection();let o=e.getCurrentContent();const l=this._getDraftEntity(t),d=Math.min(a.getAnchorOffset(),a.getFocusOffset()),c=Math.max(a.getAnchorOffset(),a.getFocusOffset()),h=l?l.data.getDisplayText():t.displayText;let u;do{if(!l){const t=this._applyTextChange({position:d,deletionLength:c-d,insertedText:h},o,e.getSelection());o=t.newContentState,u=t.preferredCaretPosition;break}if(c>d){const t=this._applyTextChange({position:d,deletionLength:c-d,insertedText:""},o,e.getSelection());o=t.newContentState,u=t.preferredCaretPosition}const i=R.getSpan(o,d);if(i&&d!==i.spanStart){u=d;break}if(t.type===b.EditableEntityType.Emoticon&&R.getSpanCount(o,t.type)>=50)break;const r=n&&l.data.appendConvenienceSpaceOnInsertion()?h+" ":h;if(this.props.maxLength&&o.getPlainText().length+r.length>this.props.maxLength)break;o=s.Modifier.insertText(o,C.rangeForCaretPosition(d),r);const a=s.SelectionState.createEmpty("0").merge({anchorOffset:d,focusOffset:d+h.length});o.createEntity(l.type,l.mutability,l.data);const p=o.getLastCreatedEntityKey();o=s.Modifier.applyEntity(o,a,p),u=d+r.length}while(0);i&&this._undoStack.pushToUndoStack(this.state.editorState);let p=s.EditorState.set(this.state.editorState,{currentContent:o});return void 0!==u&&(p=C.setCaretPosition(p,u,this._onBeforeFocus)),p}_insertLineBreak(e){const t=e.getSelection(),i=this._applyTextChange({position:Math.min(t.getAnchorOffset(),t.getFocusOffset()),deletionLength:Math.abs(t.getFocusOffset()-t.getAnchorOffset()),insertedText:"\n"},e.getCurrentContent(),t);let n=s.EditorState.set(e,{currentContent:i.newContentState});i.preferredCaretPosition&&(n=C.setCaretPosition(n,i.preferredCaretPosition,this._onBeforeFocus)),this._undoStack.pushToUndoStack(this.state.editorState),this._setNewEditorState(n),a.defer((()=>{if(this._isMounted&&this._containerViewRef){const e=Math.max(23,this.props.lineHeight);this._containerViewRef.scrollTop+=e}})),this.props.onAccessibilityAnnouncementRequested&&this.props.onAccessibilityAnnouncementRequested(b.AccessibilityAnnouncement.NewLineAdded)}_applyTextChange(e,t,i){const n=I.checkAndEnforceEditConstraints(e,t,i,this.props.maxLength);if(n)return n;const r=s.SelectionState.createEmpty("0").merge({anchorOffset:e.position,focusOffset:e.position+e.deletionLength});return{newContentState:s.Modifier.replaceText(t,r,e.insertedText),preferredCaretPosition:e.position+e.insertedText.length}}_scrollToEnd(){this._containerViewRef&&(this._containerViewRef.scrollTop=this._containerViewRef.scrollHeight)}_setNewEditorState(e){const t=p.Defer();return this._equalsContent(e.getCurrentContent())||(this._localDataVersion++,this._onContentChangeApplied(e)),this.setState({editorState:e},(()=>{t.resolve(void 0)})),t.promise()}_restoreState(e){e&&(e=s.EditorState.forceSelection(e,s.SelectionState.createEmpty("0").merge({anchorOffset:e.getSelection().getAnchorOffset(),focusOffset:e.getSelection().getFocusOffset()})),this._setNewEditorState(e))}_buildAllContentSelection(e){return s.SelectionState.createEmpty("0").merge({anchorOffset:0,focusOffset:e.getPlainText().length})}_calcInvisibleContentString(e){let t="";const i=R.getSpans(e,0,e.getPlainText().length);for(const e of i)e.span&&!e.span.rendersIntoObjectTextWithComparableText()&&(t+=e.span.getOriginalDisplayText());return t}_getDraftJsContentNode(){if(!this._containerViewRef)return;const e=this._containerViewRef.querySelector(".public-DraftEditor-content");return e||void 0}}F.contextTypes={focusArbitrator:l.object},t.default=F,(0,h.applyFocusableComponentMixin)(F)},494255:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SpriteComponent=void 0;const n=i(197582).__importStar(i(516778));class r extends n.Component{}t.SpriteComponent=r},400214:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(698138),t);var r=i(698138);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},698138:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Types=void 0;const n=i(197582),r=i(785893),s=n.__importStar(i(494255));t.Types=s;class a extends s.SpriteComponent{render(){const e=this._createStyle(this.props);return(0,r.jsx)("span",{style:e.outerStyle,children:(0,r.jsx)("span",{style:e.innerStyle,className:"SpriteComponentAnimationPause",title:this.props.tooltip})})}_createStyle(e){const{sourceFramesCount:t}=e,i=e.style.width||e.originalWidth||0,n=e.style.height||e.originalHeight||0,r=n*t,s=t/(e.fps||24);return{outerStyle:{display:"inline-block",width:`${i}px`,height:`${n}px`},innerStyle:{display:"inline-block",width:`${i}px`,height:`${r}px`,backgroundImage:`url("${e.url}")`,backgroundSize:`${i}px ${r}px`,willChange:"transform",transform:`translate3d(0, ${-r}px, 0)`,transformOrigin:"top left",animation:`SpriteComponentAnimation ${s}s steps(${t}) 0s infinite`,backfaceVisibility:"hidden"}}}}t.default=a},615334:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SwipableTabViewBase=void 0;const n=i(197582),r=i(785893),s=n.__importStar(i(496486)),a=n.__importStar(i(859745)),o=n.__importStar(i(516778)),l=n.__importDefault(i(114818));class d extends o.Component{constructor(e){super(e),this._headerOffsets=[],this._currentTabVisibility=1,this._contentContainerAnimatedTranslateOffsets=[],this._contentContainerAnimatedTransformStyles=[],this._contentContainerAnimatedOpacityValues=[],this._contentContainerAnimatedOpacityStyles=[],this._headerContainerAnimatedTranslateOffsets=[],this._headerContainerAnimatedTransformStyles=[],this._isMounted=!1,this._onLayout=e=>{this._isMounted&&(this._lastLayoutInfo=e,this.state.viewWidth!==e.width&&this.setState({viewWidth:e.width}))},this._onTabPress=e=>{isNaN(e)||(this.props.onTabPress&&this.props.onTabPress(e),this.goToTab(e))},this._onTabLongPress=e=>{isNaN(e)||this.props.onTabLongPress&&this.props.onTabLongPress(e)},this.state=this._getInitialState(e),d._stylesCache||(d._stylesCache={panel:o.Styles.createViewStyle({flex:1,flexDirection:"column",overflow:"visible"}),sceneContainer:o.Styles.createViewStyle({flex:1,flexDirection:"row",overflow:"visible"}),tabAndHeaderContainer:o.Styles.createViewStyle({position:"absolute",top:0,left:0,right:0}),tabContainer:o.Styles.createViewStyle({position:"absolute",top:0,left:0,right:0,flexDirection:"row",overflow:"visible"}),tabHeaderContainer:o.Styles.createViewStyle({position:"absolute",top:0,left:0,right:0}),tab:o.Styles.createButtonStyle({flex:1,marginHorizontal:-1,paddingHorizontal:8,justifyContent:"center",alignItems:"stretch",width:0}),tabContentContainer:o.Styles.createViewStyle({position:"absolute",top:0,bottom:0,left:0,right:0,flexDirection:"column",overflow:"visible"}),tabUnderline:o.Styles.createViewStyle({position:"absolute",bottom:0,left:0}),overflowVisible:o.Styles.createViewStyle({overflow:"visible"}),flipHorizontal:o.Styles.createViewStyle({transform:[{scaleX:-1}]})})}_getInitialState(e){let t=0;return e.startingTabIndex&&e.startingTabIndex>=0&&e.startingTabIndex<(e.tabConfigs?e.tabConfigs.length:1)&&(t=e.startingTabIndex),{viewWidth:this._getInitialViewWidth(),currentTab:t,tabCountToRender:e.initialTabCountToRender||1}}UNSAFE_componentWillMount(){this._setInitalOffsetValues(!0)}componentDidMount(){this._setInitalOffsetValues(),this._isMounted=!0}componentWillUnmount(){this._isMounted=!1}_updateTabsHidden(e){a.timing.easeOut({value:this._tabContainerAnimatedOpacity,toValue:e?0:1,duration:a.Common.Duration.Short,useNativeDriver:this._useNativeDriver()}).start()}_setInitalOffsetValues(e=!1){const t=this.state.viewWidth/this._getNumberOfTabs(this.props),i=this._getTabUnderlineWidth(this.props,this.state),n=this.props.startingTabIndex||0;let r=n*t+(t-i)/2;this.props.isRTL&&(r*=-1),e?(this._tabUnderlineAnimatedTranslateOffset=new o.Animated.Value(r),this._tabUnderlineAnimatedTranslateStyle=o.Styles.createAnimatedViewStyle({transform:[{translateX:this._tabUnderlineAnimatedTranslateOffset}]})):this._tabUnderlineAnimatedTranslateOffset.setValue(r),e?(this._tabUnderlineAnimatedScaleX=new o.Animated.Value(1),this._tabUnderlineAnimatedScaleXStyle=o.Styles.createAnimatedViewStyle({transform:[{scaleX:this._tabUnderlineAnimatedScaleX}]})):this._tabUnderlineAnimatedScaleX.setValue(1);e?(this._tabContainerAnimatedTranslateOffset=new o.Animated.Value(0),this._tabContainerTranslateStyle=o.Styles.createAnimatedViewStyle({transform:[{translateX:this._tabContainerAnimatedTranslateOffset}]})):this._tabContainerAnimatedTranslateOffset.setValue(0);const s=this.props.tabsHidden?0:1;e?(this._tabContainerAnimatedOpacity=new o.Animated.Value(s),this._tabContainerOpacityStyle=o.Styles.createAnimatedViewStyle({opacity:this._tabContainerAnimatedOpacity})):this._tabContainerAnimatedOpacity.setValue(s);const a=this._tabOuterOffsetForTab(n,this.props,this.state);e?(this._tabOuterContainerAnimatedTranslateOffset=new o.Animated.Value(-1*a),this._tabOuterContainerTransformStyle=o.Styles.createAnimatedViewStyle({transform:[{translateX:this._tabOuterContainerAnimatedTranslateOffset}]})):this._tabOuterContainerAnimatedTranslateOffset.setValue(-1*a);const l=-(1-this._currentTabVisibility)*this.props.tabHeight;e?(this._tabAnimatedTranslateOffset=new o.Animated.Value(l),this._tabAnimatedTransformStyle=o.Styles.createAnimatedViewStyle({transform:[{translateY:this._tabAnimatedTranslateOffset}]})):this._tabAnimatedTranslateOffset.setValue(l);const d=this.props.tabHeight*this._currentTabVisibility,c=-1*(this.props.tabHeight-d);e?(this._tabAnimatedBackgroundTranslateOffset=new o.Animated.Value(c),this._tabAnimatedBackgroundTranslateStyle=o.Styles.createAnimatedViewStyle({transform:[{translateY:this._tabAnimatedBackgroundTranslateOffset}]})):this._tabAnimatedBackgroundTranslateOffset.setValue(c),this._setupTabOffsetValues(this.props,this.state,n,e),e&&this._useNativeDriver()&&(this._markNativeValue(this._tabUnderlineAnimatedTranslateOffset,r),this._markNativeValue(this._tabContainerAnimatedTranslateOffset,0),this._markNativeValue(this._tabContainerAnimatedOpacity,s),this._markNativeValue(this._tabOuterContainerAnimatedTranslateOffset,-1*a),this._markNativeValue(this._tabUnderlineAnimatedScaleX,1),this._markNativeValue(this._tabAnimatedBackgroundTranslateOffset,c),this._markNativeValue(this._tabAnimatedTranslateOffset,l))}_setupTabOffsetValues(e,t,i,n=!1){n&&(this._contentContainerAnimatedTranslateOffsets=[],this._contentContainerAnimatedTransformStyles=[],this._contentContainerAnimatedOpacityValues=[],this._contentContainerAnimatedOpacityStyles=[],this._headerContainerAnimatedTranslateOffsets=[],this._headerContainerAnimatedTransformStyles=[]),this._updateTabHeaderOffsets(e,t);const r=-1*this._headerOffsetForTab(i),s=[];for(let a=0;a<e.tabConfigs.length;a++){const e=(a-i)*t.viewWidth;n?(this._contentContainerAnimatedTranslateOffsets.push(new o.Animated.Value(e)),this._contentContainerAnimatedTransformStyles.push(o.Styles.createAnimatedViewStyle({transform:[{translateX:this._contentContainerAnimatedTranslateOffsets[a]}]}))):this._contentContainerAnimatedTranslateOffsets[a].setValue(e);const l=a===i?1:0;n?(this._contentContainerAnimatedOpacityValues.push(new o.Animated.Value(l)),this._contentContainerAnimatedOpacityStyles.push(o.Styles.createAnimatedViewStyle({opacity:this._contentContainerAnimatedOpacityValues[a]}))):this._contentContainerAnimatedOpacityValues[a].setValue(l);const d=r+this._headerOffsetForTab(a);s.push(d),n?(this._headerContainerAnimatedTranslateOffsets.push(new o.Animated.Value(d)),this._headerContainerAnimatedTransformStyles.push(o.Styles.createAnimatedViewStyle({transform:[{translateX:this._headerContainerAnimatedTranslateOffsets[a]}]}))):this._headerContainerAnimatedTranslateOffsets[a].setValue(d)}if(n&&this._useNativeDriver())for(let n=0;n<e.tabConfigs.length;n++){const e=(n-i)*t.viewWidth,r=n===i?1:0;this._markNativeValue(this._contentContainerAnimatedTranslateOffsets[n],e),this._markNativeValue(this._contentContainerAnimatedOpacityValues[n],r),this._markNativeValue(this._headerContainerAnimatedTranslateOffsets[n],s[n])}}_markNativeValue(e,t){a.NativeUtils.markAnimatedValue(e,t)}UNSAFE_componentWillUpdate(e,t){if(this.props.tabConfigs.length!==e.tabConfigs.length&&this._setupTabOffsetValues(e,t,t.currentTab,!0),this.state.currentTab!==t.currentTab&&this._updateTabContentVisibility(t.currentTab),this.props.tabHeight!==e.tabHeight){const t=-(1-this._currentTabVisibility)*e.tabHeight;this._tabAnimatedTranslateOffset.setValue(t);const i=e.tabHeight*this._currentTabVisibility;this._tabAnimatedBackgroundTranslateOffset.setValue(-1*(e.tabHeight-i))}this.state.viewWidth===t.viewWidth&&this._getNumberOfTabs(this.props)===this._getNumberOfTabs(e)||this._updateOffsets(e,t),this.props.tabsHidden!==e.tabsHidden&&this._updateTabsHidden(e.tabsHidden||!1)}componentDidUpdate(e,t){this.state.tabCountToRender<this._getNumberOfTabs(this.props)&&requestAnimationFrame((()=>{this._isMounted&&this.setState({tabCountToRender:this.state.tabCountToRender+1})}))}shouldComponentUpdate(e,t){return!(0,l.default)(this.state,t)||!(0,l.default)(this.props,e)}render(){const e=o.Styles.createViewStyle({height:this.props.tabHeight},!1),t=o.Styles.createViewStyle({marginTop:this._getHeaderHeight()},!1),i=[d._stylesCache.tabContainer,e,this._tabContainerTranslateStyle,this._tabContainerOpacityStyle],n=[d._stylesCache.tabContainer,e,this._tabAnimatedTransformStyle],a=[d._stylesCache.tabContainer,e,this.props.isRTL?d._stylesCache.flipHorizontal:void 0],l=[this.props.simpleLayout?void 0:d._stylesCache.tabAndHeaderContainer,this._getTabAndHeaderContainerStyle(),o.Styles.createViewStyle({height:this._getTabAndHeaderHeight()+this._getBottomViewHeight(),overflow:"visible"},!1)],c=this._renderTabContentNodes();let h;if(!this.props.contentOnly){const c=this._renderTabs(),u=this._renderTabUnderline();let p,g;p=this.props.staticHeader?this._renderTabHeader(this.state.currentTab):this._renderTabHeaderNodes(),g=this.props.staticHeader?this._renderHeaderBackground(this.state.currentTab):this._renderHeaderBackgrounds();const m=(0,r.jsxs)(o.View,{style:a,children:[c,u]});let f=(0,r.jsx)(o.Animated.View,{style:i,ignorePointerEvents:!0,children:(0,r.jsx)(o.Animated.View,{style:n,ignorePointerEvents:!0,children:m})});if(s.isUndefined(this.props.visibleTabBarRange)||s.isNull(this.props.visibleTabBarRange))i.push(t);else{const i=[d._stylesCache.tabContainer,d._stylesCache.overflowVisible,e,t,this._tabOuterContainerTransformStyle];f=(0,r.jsx)(o.Animated.View,{style:i,ignorePointerEvents:!0,children:f})}h=(0,r.jsxs)(o.View,{style:l,ignorePointerEvents:!0,children:[g,f,p]},"header")}return(0,r.jsxs)(o.View,{style:d._stylesCache.panel,onLayout:this._onLayout,ignorePointerEvents:!0,children:[this.props.simpleLayout?h:void 0,(0,r.jsx)(o.View,Object.assign({style:d._stylesCache.sceneContainer,ignorePointerEvents:!0},this._getOptionalPanHandlerProps(),{children:c}),"content"),this.props.simpleLayout?void 0:h]})}_getOptionalPanHandlerProps(){return null}_useNativeDriver(){return!1}_headerVisibleOverflow(){return!1}_renderTabs(){const e=[];return s.each(this.props.tabConfigs,((t,i)=>{const n=this._getTabStyles(i,d._stylesCache.tab),s=this.state.currentTab===i,a=s?[o.Types.AccessibilityTrait.Tab,o.Types.AccessibilityTrait.Selected]:[o.Types.AccessibilityTrait.Tab],l=t.tabTitleImportantForAccessibility||o.Types.ImportantForAccessibility.Yes,c=s&&t.selectedAccessibilityLabel?t.selectedAccessibilityLabel:t.accessibilityLabel;e.push((0,r.jsx)(o.Button,{style:n,onPress:this.props.tabsHidden?void 0:e=>this._onTabPress(i),onLongPress:!this.props.tabsHidden&&this.props.onTabLongPress?e=>this._onTabLongPress(i):void 0,accessibilityTraits:a,accessibilityLabel:c,importantForAccessibility:l,children:t.renderTabTitle?t.renderTabTitle():null},"tab"+i))})),e}_renderTabUnderline(){if(!this.props.hideTabUnderline){const e=[d._stylesCache.tabUnderline,d._stylesCache.overflowVisible,this._tabUnderlineAnimatedTranslateStyle],t=[this._tabUnderlineAnimatedScaleXStyle,o.Styles.createViewStyle({height:this._getTabUnderlineHeight(this.props,this.state),width:this._getTabUnderlineWidth(this.props,this.state),backgroundColor:this._getTabUnderlineColor(this.props,this.state)},!1)];return(0,r.jsx)(o.Animated.View,{style:e,children:(0,r.jsx)(o.Animated.View,{style:t})})}return null}_renderTabHeader(e){if(this.props.tabConfigs&&this.props.tabConfigs[e]){const t=this.props.tabConfigs[e].header;if(t)return this._renderTabWithHeaderInfo(t.renderHeaderNode(),t.headerHeight,e)}return null}_renderTabWithHeaderInfo(e,t,i){const n=[d._stylesCache.tabHeaderContainer,o.Styles.createViewStyle({height:t},!1),this.props.staticHeader?void 0:this._headerContainerAnimatedTransformStyles[i]];return this._headerVisibleOverflow()&&n.push(d._stylesCache.overflowVisible),(0,r.jsx)(o.Animated.View,{style:n,ignorePointerEvents:!0,children:e},"tabHeader"+i)}_updateTabHeaderOffsets(e,t){const i=[],n={};this._headerOffsets=[];let r=0;s.each(e.tabConfigs,((e,a)=>{if(!e)return;const o=e.header;if(o){if(o.headerId&&s.includes(i,o.headerId)){const e=n[o.headerId];return void this._headerOffsets.push(e)}o.headerId&&(i.push(o.headerId),n[o.headerId]=r),this._headerOffsets.push(r),r+=t.viewWidth}}))}_renderTabHeaderNodes(){const e=[],t=[],i={};this._headerOffsets=[];let n=0;s.each(this.props.tabConfigs,((r,a)=>{if(!r)return;const o=r.header;if(o){if(o.headerId&&s.includes(t,o.headerId)){const e=i[o.headerId];return void this._headerOffsets.push(e)}e.push(this._renderTabWithHeaderInfo(o.renderHeaderNode(),o.headerHeight,a)),o.headerId&&(t.push(o.headerId),i[o.headerId]=n),this._headerOffsets.push(n),n+=this.state.viewWidth}}));const a=this.props.tabConfigs[this.state.currentTab],l=[o.Styles.createViewStyle({flexDirection:"row",height:a&&a.header?a.header.headerHeight:0},!1)];return this._headerVisibleOverflow()&&l.push(d._stylesCache.overflowVisible),(0,r.jsx)(o.View,{style:l,ignorePointerEvents:!0,children:e})}_renderHeaderBackground(e){if(this.props.tabConfigs&&this.props.tabConfigs[e]){const t=this.props.tabConfigs[e].header;if(t){const i=this._renderHeaderBackgroundWithInfo(t,e);return(0,r.jsx)(o.View,{style:[d._stylesCache.tabAndHeaderContainer,d._stylesCache.overflowVisible],ignorePointerEvents:!0,children:i})}}return null}_renderHeaderBackgroundWithInfo(e,t){const i=e?e.headerHeight+this.props.tabHeight:0,n=e&&e.bottomViewHeight?e.bottomViewHeight:0,s=[d._stylesCache.tabHeaderContainer,o.Styles.createViewStyle({height:i+n},!1)],a=[...s,this._tabAnimatedBackgroundTranslateStyle],l=[...s,this._contentContainerAnimatedTransformStyles[t],this._contentContainerAnimatedOpacityStyles[t]];let c=null;if(e&&e.renderBottomView){l.push(d._stylesCache.overflowVisible),a.push(d._stylesCache.overflowVisible);const t=[o.Styles.createViewStyle({position:"absolute",left:0,right:0,top:i,width:this.state.viewWidth,height:n},!1),d._stylesCache.overflowVisible];c=(0,r.jsx)(o.View,{style:t,ignorePointerEvents:!0,children:e.renderBottomView()})}const h=o.Styles.createViewStyle({height:i,width:this.state.viewWidth,backgroundColor:e&&e.backgroundColor||d._defaultHeaderBackgroundColor,elevation:e?e.elevation:0},!1);return(0,r.jsx)(o.Animated.View,{style:l,ignorePointerEvents:!0,children:(0,r.jsxs)(o.Animated.View,{style:a,ignorePointerEvents:!0,children:[(0,r.jsx)(o.View,{style:h,ignorePointerEvents:!0}),c]})},"tabHeader"+t)}_renderHeaderBackgrounds(){const e=[];s.each(this.props.tabConfigs,((t,i)=>{if(!t)return;const n=t.header;n?e.push(this._renderHeaderBackgroundWithInfo(n,i)):e.push(this._renderHeaderBackgroundWithInfo(void 0,i))}));const t=[d._stylesCache.tabAndHeaderContainer,o.Styles.createViewStyle({height:this._getTabAndHeaderHeight()+this._getBottomViewHeight(),overflow:"visible"},!1)];return(0,r.jsx)(o.View,{style:t,ignorePointerEvents:!0,children:e})}_renderTabContentNodes(){const e=[];let t=0;const i=this._getNumberOfTabs(this.props)>this.state.tabCountToRender;return s.each(this.props.tabConfigs,(n=>{let s=0;n.tabsAndHeaderShouldOverlayContent||this.props.simpleLayout||(s=this._getTabAndHeaderHeight()),n.contentInset&&(s-=n.contentInset);const a=0!==s?o.Styles.createViewStyle({marginTop:s},!1):void 0,l=[d._stylesCache.tabContentContainer,a,this._contentContainerAnimatedTransformStyles[t],this._contentContainerAnimatedOpacityStyles[t]];!i||t<this.state.tabCountToRender-1||t===this.state.currentTab?e.push(this._renderTabContent(t,l)):e.push((0,r.jsx)(o.Animated.View,{style:l},"tabContent"+t)),t++})),e}_getTabAndHeaderHeight(){if(this.props.tabConfigs&&this.props.tabConfigs[this.state.currentTab]){const e=this.props.tabConfigs[this.state.currentTab],t=e&&e.header?e.header.headerHeight:0;return this.props.tabHeight+t}return this.props.tabHeight}_getBottomViewHeight(){if(this.props.tabConfigs&&this.props.tabConfigs[this.state.currentTab]){const e=this.props.tabConfigs[this.state.currentTab];return e&&e.header&&e.header.bottomViewHeight?e.header.bottomViewHeight:0}return 0}_getHeaderHeight(){if(this.props.tabConfigs&&this.props.tabConfigs[this.state.currentTab]){const e=this.props.tabConfigs[this.state.currentTab];return e&&e.header?e.header.headerHeight:0}return 0}goToTab(e,t=!0){isNaN(e)||e===this.state.currentTab||(this.props.onTabChangeStart&&this.props.onTabChangeStart(e,!1),this._transitionToTab(this.state.currentTab,e,t))}updateRenderedTabCount(e){this._isMounted&&e!==this.state.tabCountToRender&&this.setState({tabCountToRender:e})}setTabVisibility(e,t){if(this._currentTabVisibility!==e){const i=this.props.tabHeight*e,n=-(1-e)*this.props.tabHeight,r=-1*(this.props.tabHeight-i),s=this._getTabUnderlineCollapsedWidth(this.props,this.state),o=this._getTabUnderlineWidth(this.props,this.state),l=o&&s?this._mapVal(e,s,o)/o:1;if(t){const e=this._useNativeDriver();a.parallel([a.timing.easeOut({value:this._tabAnimatedTranslateOffset,toValue:n,duration:a.Common.Duration.Short,useNativeDriver:e}),a.timing.easeOut({value:this._tabAnimatedBackgroundTranslateOffset,toValue:r,duration:a.Common.Duration.Short,useNativeDriver:e}),a.timing.easeOut({value:this._tabUnderlineAnimatedScaleX,toValue:l,duration:a.Common.Duration.Short,useNativeDriver:e})]).start()}else this._tabAnimatedTranslateOffset.setValue(n),this._tabAnimatedBackgroundTranslateOffset.setValue(r),this._tabUnderlineAnimatedScaleX.setValue(l);this._currentTabVisibility=e}}_transitionToTab(e,t,i=!0){t!==this.state.currentTab&&this._showAllTabContent();const n=this.state.viewWidth/this._getNumberOfTabs(this.props),r=this._getTabUnderlineWidth(this.props,this.state),s=this._useNativeDriver(),o=-1*this._tabOuterOffsetForTab(t,this.props,this.state);let l=[];i?l=[a.timing.easeOut({value:this._tabContainerAnimatedTranslateOffset,toValue:0,duration:a.Common.Duration.Short,useNativeDriver:s}),a.timing.easeOut({value:this._tabOuterContainerAnimatedTranslateOffset,toValue:o,duration:a.Common.Duration.Short,useNativeDriver:s})]:(this._tabContainerAnimatedTranslateOffset.setValue(0),this._tabOuterContainerAnimatedTranslateOffset.setValue(o));const d=-1*this._headerOffsetForTab(t);for(let e=0;e<this.props.tabConfigs.length;e++){const n=(e-t)*this.state.viewWidth,r=d+this._headerOffsetForTab(e);i?(l.push(a.timing.easeOut({value:this._contentContainerAnimatedTranslateOffsets[e],toValue:n,duration:a.Common.Duration.Short,useNativeDriver:s})),l.push(a.timing.easeOut({value:this._headerContainerAnimatedTranslateOffsets[e],toValue:d+this._headerOffsetForTab(e),duration:a.Common.Duration.Short,useNativeDriver:s}))):(this._contentContainerAnimatedTranslateOffsets[e]&&this._contentContainerAnimatedTranslateOffsets[e].setValue(n),this._headerContainerAnimatedTranslateOffsets[e]&&this._headerContainerAnimatedTranslateOffsets[e].setValue(r))}if(!this.props.hideTabUnderline){let e=t*n+(n-r)/2;this.props.isRTL&&(e*=-1),i?l.push(a.timing.easeOut({value:this._tabUnderlineAnimatedTranslateOffset,toValue:e,duration:a.Common.Duration.Short,useNativeDriver:s})):this._tabUnderlineAnimatedTranslateOffset.setValue(e)}this.props.onTabChangeProgress&&this.props.onTabChangeProgress(e,t,1,!1);const c=e=>{this.props.onTabChangeEnd&&this.props.onTabChangeEnd(t,e),this._isMounted&&(this._updateTabContentVisibility(t),this.setState({currentTab:t}))};i?a.parallel(l).start((e=>c(e.finished))):c(!0)}_updateOffsets(e,t,i=0){if(!t.viewWidth)return;const n=-1*i/t.viewWidth;this._updateTabHeaderOffsets(e,t);const r=this._headerOffsetForTab(t.currentTab),s=this._tabOuterOffsetForTab(t.currentTab,e,t);let a,o;i>0?(a=this._headerOffsetForTab(t.currentTab-1),o=this._tabOuterOffsetForTab(t.currentTab-1,e,t)):i<0?(a=this._headerOffsetForTab(t.currentTab+1),o=this._tabOuterOffsetForTab(t.currentTab+1,e,t)):(a=r,o=s);const l=-1*this._mapVal(Math.abs(n),r,a);for(let n=0;n<e.tabConfigs.length;n++){const e=i-(t.currentTab-n)*t.viewWidth;this._contentContainerAnimatedTranslateOffsets[n].setValue(e);const r=this._headerOffsetForTab(n);this._headerContainerAnimatedTranslateOffsets[n].setValue(l+r)}const d=this._mapVal(Math.abs(n),s,o);this._tabOuterContainerAnimatedTranslateOffset.setValue(-1*d);const c=t.viewWidth/this._getNumberOfTabs(e),h=this._getTabUnderlineWidth(e,t),u=n*c;let p=t.currentTab*c+(c-h)/2+u;e.isRTL&&(p*=-1),this._tabUnderlineAnimatedTranslateOffset.setValue(p);const g=this._getTabUnderlineCollapsedWidth(e,t),m=this._getTabUnderlineWidth(e,t),f=m&&g?this._mapVal(this._currentTabVisibility,g,m)/m:1;this._tabUnderlineAnimatedScaleX.setValue(f)}_getNumberOfTabs(e){return e&&e.tabConfigs?e.tabConfigs.length:0}_getInitialViewWidth(){return o.UserInterface.measureWindow().width}_getTabUnderlineHeight(e,t){if(e.tabConfigs&&e.tabConfigs[t.currentTab]){const i=e.tabConfigs[t.currentTab];if(i.tabUnderlineHeight)return i.tabUnderlineHeight;if(e.defaultTabUnderlineHeight)return e.defaultTabUnderlineHeight}return d._defaultTabUnderlineHeight}_getTabUnderlineWidth(e,t){if(e.tabConfigs&&e.tabConfigs[t.currentTab]){const i=e.tabConfigs[t.currentTab];if(i.tabUnderlineWidth)return i.tabUnderlineWidth;if(e.defaultTabUnderlineWidth)return e.defaultTabUnderlineWidth}return t.viewWidth/this._getNumberOfTabs(e)}_getTabUnderlineCollapsedWidth(e,t){if(e.tabConfigs&&e.tabConfigs[t.currentTab]){const i=e.tabConfigs[t.currentTab];if(i.tabUnderlineCollpasedWidth)return i.tabUnderlineCollpasedWidth;if(e.defaultTabUnderlineCollapsedWidth)return e.defaultTabUnderlineCollapsedWidth}return t.viewWidth/this._getNumberOfTabs(e)}_getTabUnderlineColor(e,t){if(e.tabConfigs&&e.tabConfigs[t.currentTab]){const i=e.tabConfigs[t.currentTab];if(i.tabUnderlineColor)return i.tabUnderlineColor;if(e.defaultTabUnderlineColor)return e.defaultTabUnderlineColor}return d._defaultTabUnderlineColor}_getTabAndHeaderContainerStyle(){if(this.props.tabConfigs&&this.props.tabConfigs[this.state.currentTab]){return this.props.tabConfigs[this.state.currentTab].tabAndHeaderContainerStyle}}_getTabStyles(e,t){const i=[t];if(this.props.tabConfigs&&this.props.tabConfigs[this.state.currentTab]){const t=this.props.tabConfigs[this.state.currentTab];this.state.currentTab===e?(this.props.defaultSelectedTabStyle&&i.push(this.props.defaultSelectedTabStyle),t.selectedTabStyle&&i.push(t.selectedTabStyle)):(this.props.defaultTabStyle&&i.push(this.props.defaultTabStyle),t.styleOfOtherTabs&&i.push(t.styleOfOtherTabs))}return this.props.isRTL&&i.push(d._stylesCache.flipHorizontal),i}_headerOffsetForTab(e){return e<s.size(this._headerOffsets)?this._headerOffsets[e]:0}_tabOuterOffsetForTab(e,t,i){if(s.isUndefined(t.visibleTabBarRange)||s.isNull(t.visibleTabBarRange))return 0;let n;if(s.isArray(t.visibleTabBarRange)){if(s.isEmpty(t.visibleTabBarRange))return 0;if(1===t.visibleTabBarRange.length){const e=t.visibleTabBarRange[0];n=[e,e]}else n=t.visibleTabBarRange}else{const e=t.visibleTabBarRange;n=[e,e]}if(n&&n.length>=2){const t=n[0],r=n[1];if(e<t)return-1*i.viewWidth;if(e>r)return i.viewWidth}return 0}_showAllTabContent(){this._intUpdateTabContentVisibility(!0)}_updateTabContentVisibility(e){this._intUpdateTabContentVisibility(!1,e)}_intUpdateTabContentVisibility(e,t){for(let i=0;i<this.props.tabConfigs.length;i++){const n=e||i===t?1:0;this._contentContainerAnimatedOpacityValues[i].setValue(n)}}_mapVal(e,t,i){return t+(i-t)*e}}t.SwipableTabViewBase=d,d._defaultTabUnderlineHeight=2,d._defaultTabUnderlineColor="black",d._defaultHeaderBackgroundColor="transparent",t.default=d},972946:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(851168),t);var r=i(851168);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},851168:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=n.__importStar(i(516778)),a=i(615334);class o extends a.SwipableTabViewBase{_getAnimatedEasing(){return s.Animated.Easing.Default()}_renderTabContent(e,t){const i=s.Styles.combine(t);i.display="flex";const n=this.state.currentTab!==e?s.Types.ImportantForAccessibility.NoHideDescendants:void 0;return(0,r.jsx)(s.Animated.View,{style:i,importantForAccessibility:n,children:this.props.tabConfigs[e].renderContent()},"tabContent"+e)}_transitionToTab(e,t,i=!0){super._transitionToTab(e,t,i),this.props.onTabChangeEnd&&this.props.onTabChangeEnd(t,!0),this.setState({currentTab:t})}_getInitialViewWidth(){return 0}}t.default=o},302357:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582).__importStar(i(397691));t.default=new class{getToken(e){return n.Rejected("Not implemented.")}getTokens(){return n.Rejected("Not implemented.")}setToken(e,t,i){return n.Rejected("Not implemented.")}clearToken(){return n.Rejected("Not implemented.")}setListener(e){}removeListener(){}}},475661:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(302357),t);var r=i(302357);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},144062:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UrlUtilBase=void 0;t.UrlUtilBase=class{}},515305:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StubUrlUtil=void 0;const n=i(197582).__importStar(i(397691)),r=i(144062);class s extends r.UrlUtilBase{getUriComponents(e){return n.Resolved(void 0)}syncGetUriComponents(e){}}t.StubUrlUtil=s,t.default=new s},573248:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(515305),t);var r=i(515305);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},27133:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(567585),t);var r=i(567585);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},567585:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=n.__importStar(i(496486)),a=n.__importStar(i(973935)),o=n.__importStar(i(516778)),l={display:"flex"};class d extends o.Component{constructor(){super(...arguments),this._onLoadedData=()=>{if(this.props.onLoadedData){const e=a.findDOMNode(this);if(e){const t={duration:e.duration,naturalSize:{width:e.videoWidth,height:e.videoHeight}};this.props.onLoadedData(t)}}},this._onTimeUpdate=()=>{if(this.props.onProgress){const e=a.findDOMNode(this);e&&this.props.onProgress({currentTime:e.currentTime,playableDuration:e.duration})}},this._onError=()=>{this.props.onError&&this.props.onError()}}componentDidMount(){const e=a.findDOMNode(this);this.props.sourceObj&&(e.srcObject=this.props.sourceObj),e.onended=()=>{this.props.onEnded&&this.props.onEnded()}}componentWillUnmount(){const e=a.findDOMNode(this);e&&this.props.source&&(e.src="")}render(){let e=o.Styles.combine([l,this.props.style]);e="cover"===this.props.resizeMode?s.extend(e,{position:"absolute",minWidth:"100%",minHeight:"100%",width:"auto",height:"auto",top:"50%",left:"50%",WebkitTransform:"translate(-50%,-50%)",MozTransform:"translate(-50%,-50%)",msTransform:"translate(-50%,-50%)",transform:"translate(-50%,-50%)"}):"contain"===this.props.resizeMode?s.extend(e,{width:"100%",height:"100%"}):s.extend(e,{width:"auto",height:"auto",maxWidth:"100%",maxHeight:"100%"});const t={alt:this.props.accessibilityLabel,"aria-hidden":this.props.ariaHidden};return(0,r.jsx)("video",Object.assign({},t,{style:e,src:this.props.source,controls:this.props.showControls,loop:this.props.loop,onLoadedData:this._onLoadedData,onError:this._onError,onClick:this.props.onClick,onEnded:this.props.onEnded,onLoadStart:this.props.onLoadStart,onCanPlay:this.props.onCanPlay,onCanPlayThrough:this.props.onCanPlayThrough,onTimeUpdate:this.props.onProgress?this._onTimeUpdate:void 0,onWaiting:this.props.onWaiting,onPlaying:this.props.onPlaying}))}seek(e){const t=a.findDOMNode(this);t&&(t.currentTime=e)}seekPercent(e){const t=a.findDOMNode(this);t&&(t.currentTime=e*t.duration)}play(){const e=a.findDOMNode(this);e&&e.play()}pause(){const e=a.findDOMNode(this);e&&e.pause()}stop(){const e=a.findDOMNode(this);e&&(e.pause(),e.currentTime=0)}mute(e){const t=a.findDOMNode(this);t&&(t.muted=e)}}t.default=d},806518:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(438374),t);var r=i(438374);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},438374:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(174958),s=n.__importStar(i(496486)),a=i(815063),o=n.__importStar(i(167606)),l=n.__importDefault(i(375212)),d=n.__importStar(i(397691)),c=i(284841),h=void 0!==typeof navigator?navigator:{};t.default=new class{constructor(){this._devices=[]}_timeout(e,t=3e4){return d.raceTimer(e,t).then((e=>e.timedOut?d.Rejected("timed out"):d.Resolved(e.result)))}isAVRecordingSupported(){if(void 0===h||a.BrowserEnvironment.isEngineTrident()||a.BrowserEnvironment.isEngineWebkit()||a.BrowserEnvironment.isEngineEdgeHTML())return d.Resolved(!1);if(h.mediaDevices&&h.mediaDevices.getUserMedia&&h.mediaDevices.enumerateDevices){let e=!1,t=!1;const i=[];return this._timeout(d.fromThenable(h.mediaDevices.enumerateDevices()).then((n=>((0,c.chain)(n,(0,c.filter)((e=>""!==e.label)),(0,c.each)((n=>{i.push({type:n.kind,id:n.deviceId,label:n.label}),o.log(o.LogTraceArea.Capture,n.kind+": "+r.pii.Omit(n.label)+" id = "+n.deviceId),"videoinput"===n.kind&&(e=!0),"audioinput"===n.kind&&(t=!0)}))),o.log(o.LogTraceArea.Capture,"Current device AVsupport is "+(e&&t)),this._devices=i,e&&t))).fail((()=>{this._devices=[]})))}return this._devices=[],d.Resolved(!1)}mapLabelToDeviceId(e,t){let i;return t?(s.each(this._devices,(n=>{const r=-1!==n.label.lastIndexOf(t)||-1!==t.lastIndexOf(n.label);n.type===e&&r&&(i=n.id)})),i):i}startPreview(e,t,i){void 0!==h&&(h.userMediaFunction=h.getUserMedia||h.mozGetUserMedia||h.webkitGetUserMedia,h.userMediaFunction&&(void 0!==t&&void 0!==i?h.userMediaFunction({audio:{deviceId:i},video:{deviceId:t}},(t=>{this._stream=t,e(void 0,t)}),(t=>{e(void 0,void 0)})):h.userMediaFunction({audio:!0,video:!0},(t=>{this._stream=t,e(void 0,t)}),(t=>{e(void 0,void 0)}))))}startRecording(){this._recorder=(0,l.default)(this._stream,{type:"video",recorderType:l.default.MediaStreamRecorder,mimeType:"video/webm;codecs=h264",bitsPerSecond:8e5}),this._recorder.startRecording()}stopRecording(e){this._recorder&&this._recorder.stopRecording((t=>{e(t)}))}stopPreview(){this._stream&&s.each(this._stream.getTracks(),(e=>{e.stop()}))}getRecordedVideoBlob(e){const t=this._recorder.getBlob(),i=t?URL.createObjectURL(t):"";return t&&e(t,i),i}}},135285:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=i(197582),r=i(785893),s=n.__importStar(i(516778));class a extends s.Component{scrollBy(e,t,i){}render(){return(0,r.jsx)(s.View,{children:this.props.children})}}t.default=a},288400:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;const n=i(197582);n.__exportStar(i(135285),t);var r=i(135285);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.__importDefault(r).default}})},46227:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VirtualListCell=t.VirtualListView=t.VirtualListCellContext=t.AccessibilityGroupMarker=void 0;const n=i(197582),r=n.__importStar(i(667294)),s=n.__importStar(i(516778));var a;!function(e){e[e.Begin=1]="Begin",e[e.End=2]="End",e[e.BeginEnd=3]="BeginEnd"}(a||(t.AccessibilityGroupMarker=a={})),t.VirtualListCellContext=r.createContext({});class o extends s.Component{}t.VirtualListView=o;class l extends s.Component{}t.VirtualListCell=l},29746:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VirtualListCell=void 0;const n=i(197582),r=i(785893),s=n.__importStar(i(516778)),a=i(26703),o=n.__importStar(i(46227)),l=(0,a.lazyProperties)({itemBase:()=>s.Styles.createViewStyle({position:"absolute"}),overflowVisible:()=>s.Styles.createViewStyle({overflow:"visible"})}),d={willChange:"transform"},c=s.Animated.Easing.CubicBezier(1,0,.78,1),h=s.Animated.Easing.CubicBezier(.33,0,0,1);class u extends o.VirtualListCell{constructor(e){super(e),this._isMounted=!1,this._isVisible=!1,this._top=u._hiddenTopValue,this._calculatedHeight=0,this._renderedItemCache=void 0,this._virtualCellRefCallback=e=>{this._virtualCell=e},this._onFocus=e=>{this.props.onCellFocus&&this.props.onCellFocus(this.props.itemKey)},this._onBlur=e=>{this.props.onCellFocus&&this.props.onCellFocus(void 0)},this._onLayout=e=>{this._itemKey&&this.props.onLayout&&this.props.isActive&&(this._calculatedHeight=e.height,this.props.onLayout(this._itemKey,e.height))},this._onMouseEnter=e=>{this.setState({isHovering:!0})},this._onMouseLeave=e=>{this.setState({isHovering:!1})},this.state={accessibilityLabel:void 0,accessibilityTrait:e.item&&e.item.accessibilityTrait,isHovering:!1},this._renderedItemIsFocused=e.isFocused,this._isVisible=e.isVisible,this._top=e.top,this.setItemKey(e.itemKey);const t=this._isVisible?this._top:u._hiddenTopValue;this._topValue=new s.Animated.Value(t),e.useTransformOptimization?this._animatedStylePosition=s.Styles.createAnimatedViewStyle({transform:[{translateY:this._topValue}]}):this._animatedStylePosition=s.Styles.createAnimatedViewStyle({top:this._topValue}),this._widthValue=new s.Animated.Value(e.width||0),this._animatedStyleWidth=s.Styles.createAnimatedViewStyle({width:this._widthValue})}UNSAFE_componentWillReceiveProps(e,t){this.setItemKey(e.itemKey),this.props.width!==e.width&&this._widthValue.setValue(e.width),this.props.itemKey!==e.itemKey&&(this.setVisibility(e.isVisible),this.setTop({top:e.top}))}shouldComponentUpdate(e,t){return!!e.isActive&&(this.props.itemKey!==e.itemKey||this.props.webId!==e.webId||this.props.isFocused!==e.isFocused||this.state.accessibilityLabel!==t.accessibilityLabel||this.state.accessibilityTrait!==t.accessibilityTrait||this.state.isHovering!==t.isHovering||e.shouldUpdate)}componentDidUpdate(e,t,i){this._itemKey&&this.props.onLayout&&this.props.isActive&&this._calculatedHeight&&this.props.onLayout(this._itemKey,this._calculatedHeight)}componentDidMount(){this._isMounted=!0}componentWillUnmount(){this._isMounted=!1,this._topAnimation&&this._topAnimation.stop()}setVisibility(e){e!==this._isVisible&&(this._isVisible=e,this._topAnimation&&this._topAnimation.stop(),this._topValue.setValue(this._isVisible?this._top:u._hiddenTopValue))}isVisible(){return this._isVisible}setTop(e){const{top:t,animate:i=!1,animationDelay:n=0,animationOvershoot:r=0,animationDuration:a=200,animationEasingFunction:o=s.Animated.Easing.InOut()}=e;if(t!==this._top&&(this._top=t,this._isVisible)){let e=!1;if(this._topAnimation){const t=this._topAnimation;i&&(this._topAnimation=void 0),t.stop(),e=!0}i?(this._topAnimation=0!==r?s.Animated.sequence([s.Animated.timing(this._topValue,{toValue:t+r,duration:200,delay:n,easing:c}),s.Animated.timing(this._topValue,{toValue:t,duration:400,easing:h})]):s.Animated.timing(this._topValue,{toValue:t,duration:a,delay:n,easing:o}),this._itemKey&&!e&&this.props.onAnimateStartStop&&this.props.onAnimateStartStop(this._itemKey,!0),this._topAnimation.start((()=>{this._topAnimation&&(this._topAnimation=void 0,this._itemKey&&this.props.onAnimateStartStop&&this.props.onAnimateStartStop(this._itemKey,!1))}))):this._topValue.setValue(t)}}cancelPendingAnimation(){this._topAnimation&&this._topAnimation.stop()}setItemKey(e){this._itemKey=e}getTop(){return this._top}focus(){this.focusCell()}focusCell(){this._virtualCell&&this._virtualCell.focus()}setFocusLimited(e){this._virtualCell&&this._virtualCell.setFocusLimited(e)}render(){const e=[l.itemBase,l.overflowVisible,d,this._animatedStylePosition,this._animatedStyleWidth];return this.state.isHovering&&this.props.hoveredStyle&&e.push(this.props.hoveredStyle),!this.props.shouldUpdate&&this._renderedItemIsFocused===this.props.isFocused&&this._renderedItemCache||(this._renderedItemCache=this.props.renderItem(this.props.item,this.props.isFocused),this._renderedItemIsFocused=this.props.isFocused),(0,r.jsx)(s.Animated.View,Object.assign({},this._getAccessibilityAttributes(),{style:e,onLayout:this.props.onLayout?this._onLayout:void 0,ref:this._virtualCellRefCallback,limitFocusWithin:void 0===this.props.limitFocusWithin?s.Types.LimitFocusType.Limited:this.props.limitFocusWithin,onFocus:this._onFocus,onBlur:this._onBlur,onMouseEnter:this.props.hoveredStyle?this._onMouseEnter:void 0,onMouseLeave:this.props.hoveredStyle?this._onMouseLeave:void 0},this._getHandlersAndProps(),{children:this._renderedItemCache}))}_getAccessibilityAttributes(){return{accessibilityTraits:[s.Types.AccessibilityTrait.None]}}_getHandlersAndProps(){return{}}}t.VirtualListCell=u,u._hiddenTopValue=-32768},614080:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});i(197582).__exportStar(i(206150),t)},206150:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VirtualListCell=t.VirtualListView=t.Types=void 0;const n=i(197582).__importStar(i(46227));t.Types=n;const r=i(435013);Object.defineProperty(t,"VirtualListCell",{enumerable:!0,get:function(){return r.VirtualListCell}});const s=i(287214);Object.defineProperty(t,"VirtualListView",{enumerable:!0,get:function(){return s.VirtualListView}})},435013:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VirtualListCell=void 0;const n=i(197582),r=i(785893),s=n.__importStar(i(516778)),a=n.__importStar(i(46227)),o=i(29746);class l extends o.VirtualListCell{constructor(){super(...arguments),this._context={onListItemDetails:e=>this._onDetails(e)},this._onPress=e=>{this._handlerOnPress&&this._handlerOnPress(e)},this._onLongPress=e=>{this._handlerOnLongPress&&this._handlerOnLongPress(e)},this._onKeyPress=e=>{const t=this._handlerOnKeyPress||this._handlerOnPress;13===e.keyCode&&t&&(t(e),e.stopPropagation(),e.preventDefault())},this._onContextMenu=e=>{this._handlerOnContextMenu&&this._handlerOnContextMenu(e)},this._onHoverStart=e=>{this._handlerOnHoverStart&&this._handlerOnHoverStart(e)},this._onHoverEnd=e=>{this._handlerOnHoverEnd&&this._handlerOnHoverEnd(e)}}render(){return(0,r.jsx)(a.VirtualListCellContext.Provider,{value:this._context,children:super.render()})}_onDetails(e){const t=e||{},i={};Object.keys(t).forEach((e=>{switch(e){case"onPress":this._handlerOnPress=t.onPress;break;case"onLongPress":this._handlerOnLongPress=t.onLongPress;break;case"onKeyPress":this._handlerOnKeyPress=t.onKeyPress;break;case"onContextMenu":this._handlerOnContextMenu=t.onContextMenu;break;case"onHoverStart":this._handlerOnHoverStart=t.onHoverStart;break;case"onHoverEnd":this._handlerOnHoverEnd=t.onHoverEnd;break;case"accessibilityLabel":t.accessibilityLabel!==this.state.accessibilityLabel&&(i.accessibilityLabel=t.accessibilityLabel);break;case"accessibilityTrait":this.state.accessibilityTrait!==t.accessibilityTrait&&(i.accessibilityTrait=t.accessibilityTrait)}})),Object.keys(i).length&&setTimeout((()=>{this._isMounted&&this.setState(i)}))}_getAccessibilityAttributes(){return{id:this.props.webId,tabIndex:this.props.focusable?0:-1,accessibilityTraits:this.state.accessibilityTrait?[this.state.accessibilityTrait]:[s.Types.AccessibilityTrait.Summary],accessibilityLabel:this.state.accessibilityLabel,ariaRoleDescription:this.props.ariaRoleDescription}}_getHandlersAndProps(){return{onPress:this._onPress,onLongPress:this._onLongPress,onKeyPress:this._onKeyPress,onContextMenu:this._onContextMenu,onMouseEnter:this._onHoverStart,onMouseLeave:this._onHoverEnd}}}t.VirtualListCell=l},287214:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VirtualListView=t.VirtualListViewBottomUp=t.VirtualListViewWeb=void 0;const n=i(197582),r=i(785893),s=n.__importStar(i(45697)),a=n.__importStar(i(973935)),o=n.__importStar(i(516778)),l=n.__importDefault(i(114818)),d=i(26703),c=n.__importStar(i(46227));var h,u;!function(e){e[e.Up=-1]="Up",e[e.Down=1]="Down"}(h||(h={})),function(e){e[e.DisplayNone=0]="DisplayNone",e[e.Opacity0=1]="Opacity0",e[e.Visible=2]="Visible"}(u||(u={}));const p=(0,d.lazyProperties)({scrollContainer:()=>o.Styles.createScrollViewStyle({flex:1,position:"relative",flexDirection:"column"}),staticContainer:()=>o.Styles.createViewStyle({flex:1,flexDirection:"column"}),item:()=>o.Styles.createViewStyle({position:"relative",flex:0,flexDirection:"column",overflow:"visible",alignItems:"stretch"}),pointer:()=>o.Styles.createViewStyle({cursor:"pointer"})});let g;class m extends o.Component{constructor(){super(...arguments),this._isBottomUp=!1,this._setScrollTop=e=>{this._scrollView&&this._scrollView.setScrollTop(e,!1)},this._onScrollViewRef=e=>{if(this._scrollView=e,e){let t=a.findDOMNode(e);t&&this._isBottomUp&&(t.style.transform="rotateX(180deg)"),t&&t.classList.contains("rxCustomScroll")&&(t=t.firstChild),t&&(this._scrollElement=t,t.addEventListener("scroll",this._onScroll),t.addEventListener("wheel",this._onWheel),t.addEventListener("focusin",this._onFocusIn),t.addEventListener("focusout",this._onFocusOut))}else this._scrollElement&&(this._scrollElement.removeEventListener("scroll",this._onScroll),this._scrollElement.removeEventListener("wheel",this._onWheel),this._scrollElement.removeEventListener("focusin",this._onFocusIn),this._scrollElement.removeEventListener("focusout",this._onFocusOut))},this._onItemsContainerRef=e=>{e?(this._itemsContainer=a.findDOMNode(e),this._isBottomUp&&(this._itemsContainer.style.transform="rotateX(180deg)")):this._itemsContainer=null},this._onVLVInnerRef=e=>{this._vlvItems=e},this._onHeight=e=>{this._itemsContainer&&(this._itemsContainer.style.height=e+"px")},this._onWheel=e=>{this._scrollElement&&this._isBottomUp&&(e.preventDefault(),this._scrollElement.scrollTop-=e.deltaY)},this._onScroll=()=>{this._scrollElement&&this._vlvItems&&(this._vlvItems.onScroll(this._scrollElement.scrollTop,this._scrollElement),this.props.onScroll&&this.props.onScroll(this._scrollElement.scrollTop,this._scrollElement.scrollLeft))},this._onLayout=e=>{this._vlvItems&&this._vlvItems.onLayout(e)},this._onFocusIn=e=>{var t;null===(t=this._vlvItems)||void 0===t||t.onFocusIn(e)},this._onFocusOut=e=>{this._vlvItems&&this._vlvItems.onFocusOut(e)},this._onKeyPress=e=>{this._vlvItems&&this._vlvItems.onKeyPress(e)},this._onMouseMove=e=>{this._vlvItems&&this._vlvItems.onMouseMove(e.target)},this._onMouseLeave=e=>{this._vlvItems&&this._vlvItems.onMouseLeave()}}render(){this.context&&this.context.focusManager&&(g=this.context.focusManager.constructor);const e=[p.staticContainer];let t;return this.props.style&&e.push(this.props.style),this.props.horizontalPadding&&e.push(o.Styles.createViewStyle({paddingLeft:this.props.horizontalPadding.left||0,paddingRight:this.props.horizontalPadding.right||0},!1)),t=this.props.itemList.length>1?this.props.accessibilityTrait||o.Types.AccessibilityTrait.Group:o.Types.AccessibilityTrait.None,(0,r.jsx)(o.View,{style:[p.staticContainer,this.props.style],tabIndex:t===o.Types.AccessibilityTrait.None?void 0:-1,accessibilityLabel:this.props.accessibilityLabel,accessibilityTraits:t,children:(0,r.jsx)(o.ScrollView,{ref:this._onScrollViewRef,onLayout:this._onLayout,keyboardDismissMode:this.props.keyboardDismissMode,keyboardShouldPersistTaps:this.props.keyboardShouldPersistTaps,scrollsToTop:this.props.scrollsToTop,style:p.scrollContainer,bounces:!this.props.disableBouncing,onKeyPress:this._onKeyPress,scrollEnabled:!this.props.disableScrolling,scrollIndicatorInsets:this.props.scrollIndicatorInsets,accessibilityTraits:o.Types.AccessibilityTrait.List,children:(0,r.jsx)("div",{style:o.Styles.combine(e),ref:this._onItemsContainerRef,role:"none",onMouseMove:this._onMouseMove,onMouseLeave:this._onMouseLeave,children:(0,r.jsx)(S,{ref:this._onVLVInnerRef,isBottomUp:this._isBottomUp,itemList:this.props.itemList,renderItem:this.props.renderItem,animateChanges:this.props.animateChanges,skipRenderIfItemUnchanged:this.props.skipRenderIfItemUnchanged,onEndReached:this.props.onEndReached,onHeight:this._onHeight,onStartReached:this.props.onStartReached,onInitialRenderComplete:this.props.onInitialRenderComplete,setScrollTop:this._setScrollTop,hoveredStyle:this.props.hoveredItemStyle,restoreFocusAfterUpdate:this.props.restoreFocusAfterUpdate,endReachedThreshold:this.props.endReachedThreshold})})})})}focus(e){if(this._vlvItems){let t;if(e){let e;const i=this.props.itemList;for(let t=0;t<i.length;t++){const n=i[t];if(!1!==i[t].isNavigable){e=n;break}}e&&(t=e.key)}const i=this._vlvItems.setFocusableItem(t);i&&i.focusItem()}}scrollToTop(e=!0,t=0){this._scrollView&&this._scrollView.setScrollTop(t,e)}scrollToItem(e,t=!0){if(this._vlvItems&&this._scrollView){const i=this._vlvItems.getItemTop(e);void 0!==i&&this._scrollView.setScrollTop(i,t)}}triggerClickOnItem(e,t){this._vlvItems&&this._vlvItems.triggerClickOnItem(e,t)}}t.VirtualListViewWeb=m,t.VirtualListView=m,m.contextTypes={focusManager:s.object};t.VirtualListViewBottomUp=class extends m{constructor(){super(...arguments),this._isBottomUp=!0}};class f extends o.Component{constructor(e){super(e),this._forcePress=!1,this._context={onListItemDetails:e=>this._onDetails(e)},this._onRef=e=>{e?(this._item=e,this._itemNode=a.findDOMNode(e),this._visible===u.DisplayNone?this._itemNode.style.display="none":this._visible===u.Opacity0&&(this._itemNode.style.opacity="0"),this._accessibilityLabel&&this._updateAccessibilityLabel()):(this._item=void 0,this._itemNode=void 0)},this._onPress=e=>{this._handlerOnPress&&(this._handlerOnPress(e,this._forcePress),this._forcePress=!1)},this._onLongPress=e=>{this._handlerOnLongPress&&this._handlerOnLongPress(e)},this._onContextMenu=e=>{this._handlerOnContextMenu&&this._handlerOnContextMenu(e)},this._focus=()=>{this.focusItem()},this._visible=e.initiallyVisible,this.state={hovered:!1}}shouldComponentUpdate(e,t){return this.shouldUpdate||this.state.hovered!==t.hovered||this.state.accessibilityTrait!==t.accessibilityTrait}setVisible(e){this._itemNode&&e!==this._visible&&(this._visible=e,e===u.Opacity0?(this._itemNode.style.opacity="0",this._itemNode.style.display="flex"):(this._itemNode.style.opacity="1",this._itemNode.style.display=e===u.Visible?"flex":"none"))}isVisible(){return this._visible}render(){this.shouldUpdate=!1;const e=this.props.item,t=!1!==e.isNavigable,i=t?o.Types.ImportantForAccessibility.Yes:o.Types.ImportantForAccessibility.NoHideDescendants,n=e.accessibilityTrait||this.state.accessibilityTrait||o.Types.AccessibilityTrait.Summary;this._accessibilityLabel||(this._accessibilityLabel=e.accessibilityLabel);const s=[p.item];return!1!==e.isHoverable&&!1!==e.isNavigable&&s.push(p.pointer),this.props.hoveredStyle&&this.state.hovered&&s.push(this.props.hoveredStyle),this.props.item.measureHeight||s.push({height:this.props.item.height}),(0,r.jsx)(o.View,{id:this.props.uniqueId,ref:this._onRef,style:s,tabIndex:t&&n!==o.Types.AccessibilityTrait.None?0:void 0,importantForAccessibility:i,accessibilityTraits:n,ariaRoleDescription:this.props.item.ariaRoleDescription,limitFocusWithin:o.Types.LimitFocusType.Accessible,onPress:this._onPress,onLongPress:this._handlerOnLongPress?this._onLongPress:void 0,onContextMenu:this._onContextMenu,children:(0,r.jsx)(c.VirtualListCellContext.Provider,{value:this._context,children:this.props.renderItem(this.props.item,this.props.isFocused)})})}setFocusLimited(e){this._item&&this._item.setFocusLimited(e)}focusItem(){this._item&&this._item.focus()}onKeyPress(e){13===e.keyCode&&e.target===this._itemNode&&(this.click(),e.preventDefault(),e.stopPropagation())}onMouseEnter(){this.props.hoveredStyle&&!this.state.hovered&&!1!==this.props.item.isHoverable&&this.setState({hovered:!0}),this._handlerOnHoverStart&&this._handlerOnHoverStart()}onMouseLeave(){this.props.hoveredStyle&&this.state.hovered&&this.setState({hovered:!1}),this._handlerOnHoverEnd&&this._handlerOnHoverEnd()}onFocus(){this._handlerOnFocus&&this._handlerOnFocus()}onBlur(){this._handlerOnBlur&&this._handlerOnBlur()}click(e){this._itemNode&&(this._forcePress=!!e,this._itemNode.click())}_updateAccessibilityLabel(){this._itemNode&&(this._accessibilityLabel?this._itemNode.setAttribute("aria-label",this._accessibilityLabel):this._itemNode.removeAttribute("aria-label"))}_onDetails(e){const t=e||{},i={};return Object.keys(t).forEach((e=>{switch(e){case"onPress":this._handlerOnPress=t.onPress;break;case"onLongPress":this._handlerOnLongPress=t.onLongPress;break;case"onContextMenu":this._handlerOnContextMenu=t.onContextMenu;break;case"onFocus":this._handlerOnFocus=t.onFocus;break;case"onBlur":this._handlerOnBlur=t.onBlur;break;case"onHoverStart":this._handlerOnHoverStart=t.onHoverStart;break;case"onHoverEnd":this._handlerOnHoverEnd=t.onHoverEnd;break;case"accessibilityLabel":const e=t.accessibilityLabel;e!==this._accessibilityLabel&&(this._accessibilityLabel=e,this._updateAccessibilityLabel());break;case"accessibilityTrait":this.props.item.accessibilityTrait||this.state.accessibilityTrait===t.accessibilityTrait||(i.accessibilityTrait=t.accessibilityTrait)}})),Object.keys(i).length&&setTimeout((()=>{this._item&&this.setState(i)})),this._focus}}class S extends o.Component{constructor(e){super(e),this._height=0,this._scrollTop=0,this._scrollTopPrev=0,this._scrollHeight=0,this._topSpacerHeight=0,this._itemRefCallbacks={},this._groupRefCallbacks={},this._measuredHeights={},this._itemsRendered={},this._itemsNotRendered={},this._groupsRendered={},this._renderedCount=0,this._itemNodes={},this._groupNodes={},this._itemIdByKey={},this._itemKeyById={},this._idleRenderItems={},this._pendingTransform=[],this._renderMetadata=[],this._renderMetadataByKey={},this._isInitialRenderComplete=!1,this._itemListHasChanged=!1,this._totalHeight=0,this._getItemRefCallback=e=>{const t=e.key;let i=this._itemRefCallbacks[t];return i||(i=this._itemRefCallbacks[t]=i=>{let n=null;i?(this._itemsRendered[t]=i,n=a.findDOMNode(i),delete this._itemsNotRendered[t]):delete this._itemsRendered[t],this._onItemRef(e,n)}),i},this._getGroupRefCallback=e=>{const t=e.key;let i=this._groupRefCallbacks[t];return i||(i=this._groupRefCallbacks[t]=i=>{let n=null;i?(this._groupsRendered[t]=i,n=a.findDOMNode(i)):delete this._groupsRendered[t],this._onGroupRef(e,n)}),i},this._onContainerRef=e=>{this._container=e?a.findDOMNode(e):null},this._onResize=()=>{this._renderMissing(!0)},this.state={lastFocusedItemKey:null,isFocused:!1};const t=e.itemList;e.isBottomUp?(this._isBottomUp=e.isBottomUp,this._itemToRenderFirst=Math.max(0,t.length-S._initiallyRenderedLimit-1),this._itemToRenderLast=t.length-1):(this._itemToRenderFirst=0,this._itemToRenderLast=Math.min(S._initiallyRenderedLimit,t.length)-1);const i={},n=this._itemsNotRendered;for(let e=0;e<t.length;e++){const r=t[e],s=r.key;s in i&&this._duplicateKeyError(r),i[s]=e,n[s]=!0}this._itemIndexByKey=i}render(){this._keepScrollTop();const e=this._renderItems();return(0,r.jsx)("div",{ref:this._onContainerRef,role:"none",style:{willChange:"padding-top, height, contents, scroll-position"},children:e})}componentDidMount(){this._isMounted=!0,window.addEventListener("resize",this._onResize),this._setHeights(),this._scheduleIdleRender(),this.setFocusableItem(),!this._isInitialRenderComplete&&this.props.onInitialRenderComplete&&(this._isInitialRenderComplete=!0,this.props.onInitialRenderComplete())}UNSAFE_componentWillReceiveProps(e){this._chooseItemsToRender(e.itemList);const t=this.props.itemList,i=e.itemList,n=this._itemsRendered,r=this._itemsNotRendered,s=this._itemIndexByKey,a={},o=this.props.skipRenderIfItemUnchanged;if(this.props.restoreFocusAfterUpdate&&this.state.isFocused){const e=this.state.lastFocusedItemKey,i=e?s[e]:void 0;if(e&&void 0!==i){let e;i>0&&(e=t[i-1].key),this._prevFocusedItemKey=e}}for(let e=0;e<i.length;e++){const d=i[e],c=d.key,h=n[c];if(c in a&&this._duplicateKeyError(d),a[c]=e,h)if(o){const e=t[s[c]];e&&((0,l.default)(e,d)||(h.shouldUpdate=!0))}else h.shouldUpdate=!0;else r[c]=!0}this._itemListHasChanged=t.length!==i.length;for(let e=0;e<t.length;e++){const i=t[e].key;if(!(i in a)){const e=this._itemIdByKey[i];e&&(delete this._itemIdByKey[i],delete this._itemKeyById[e],delete this._measuredHeights[i]),delete r[i],this._itemListHasChanged=!0}}this._itemIndexByKey=a,this.props.animateChanges&&(this._rememberedItemTops=this._getItemTops())}componentDidUpdate(){this._setHeights(),this._restoreFocus(),this._animateChanges(),this._scheduleIdleRender(),this.setFocusableItem()}componentWillUnmount(){window.removeEventListener("resize",this._onResize),this._isMounted=!1}onLayout(e){this._height=e.height,this._renderMissing(!0)}onScroll(e,t){this._scrollTop=e,this._renderMissing(),this._scheduleIdleRender(),this._fireOnEdgeReached(e)}_isScrolledToEnd(e){if(this._isBottomUp)return 0===e;{const t=this.props.endReachedThreshold||0;return e+this._height+t>=this._totalHeight}}_isScrolledToStart(e){return this._isBottomUp?e+this._height===this._totalHeight:0===e}_fireOnEdgeReached(e){this.props.onEndReached&&this._isScrolledToEnd(e)&&this.props.onEndReached(),this.props.onStartReached&&this._isScrolledToStart(e)&&this.props.onStartReached()}onFocusIn(e){const t=this._getItemKeyByEventTarget(e.target),i=t&&t.key,n=i?this._renderMetadataByKey[i]:void 0;if(i&&n&&!1!==n.item.isNavigable&&(this._focusOutTimer&&(window.clearTimeout(this._focusOutTimer),this._focusOutTimer=void 0),!this.state.isFocused||this.state.lastFocusedItemKey!==i)){this.setFocusableItem(i);const e=this._itemsRendered[i];e&&e.onFocus(),this.setState({isFocused:!0,lastFocusedItemKey:i})}}onFocusOut(e){this._focusOutTimer||(this._focusOutTimer=window.setTimeout((()=>{if(this._focusOutTimer=void 0,this._isMounted&&this.state.isFocused){if(this.state.lastFocusedItemKey){const e=this._itemsRendered[this.state.lastFocusedItemKey];e&&e.onBlur()}this.setState({isFocused:!1})}})))}onKeyPress(e){if(e.altKey||e.ctrlKey||e.shiftKey||38!==e.keyCode&&40!==e.keyCode){const t=this.state.lastFocusedItemKey;if(t){const i=this._itemsRendered[t];i&&i.onKeyPress(e)}}else 38===e.keyCode?this._selectSubsequentItem(h.Up):40===e.keyCode&&this._selectSubsequentItem(h.Down),e.preventDefault(),e.stopPropagation()}onMouseMove(e){const t=this._getItemKeyByEventTarget(e),i=t&&t.key;if(i!==this._mouseOverKey){if(this._mouseOverKey){const e=this._itemsRendered[this._mouseOverKey];e&&e.onMouseLeave()}if(this._mouseOverKey=i,i){const e=this._itemsRendered[i];e&&e.onMouseEnter()}}}onMouseLeave(){if(this._mouseOverKey){const e=this._itemsRendered[this._mouseOverKey];e&&e.onMouseLeave(),this._mouseOverKey=void 0}}getItemTop(e){const t=this.props.itemList;let i=0;for(let n=0;n<t.length;n++){const r=t[n];if(r){if(r.key===e)return i;i+=this._getItemHeight(r)}}}triggerClickOnItem(e,t){const i=this._itemsRendered[e];i&&i.click(t)}_restoreFocus(){if(this.props.restoreFocusAfterUpdate&&this._itemListHasChanged&&this.state.isFocused){let e,t;this._itemListHasChanged=!1,this._prevFocusedItemKey?(e=this._itemIndexByKey[this._prevFocusedItemKey],void 0!==e?e++:e=0):e=0;const i=this.props.itemList;for(const e of i)if(this.state.lastFocusedItemKey?e.key===this.state.lastFocusedItemKey:!1!==e.isNavigable){t=e;break}if(t){const e=this._itemNodes[t.key];e&&(g&&g.setLastFocusedProgrammatically(e),e.focus())}this._prevFocusedItemKey=void 0}}_duplicateKeyError(e){const t=e.obfuscatedKeyForLogging?e.obfuscatedKeyForLogging:e.key;throw new Error("VirtualListView: Found a duplicate key for template: "+e.template+", origin: "+e.templateOrigin+", key: "+t)}_keepScrollTop(){this._keepScrollTopAnimationFrame&&cancelAnimationFrame(this._keepScrollTopAnimationFrame);const e=this._scrollTop;this._keepScrollTopAnimationFrame=requestAnimationFrame((()=>{this._keepScrollTopAnimationFrame=void 0,this._isMounted&&this.props.setScrollTop(e)}))}_renderItems(){this._buildRenderMetadataAndSetVisibility();const e=this._renderMetadata,t=[];for(let i=0;i<e.length;i++){const n=e[i];(n.shouldRender||n.isVisible!==u.DisplayNone)&&(n.isGroup?t.push(this._renderGroup(n)):t.push(this._renderItem(n.item,n.isVisible))),n.rendered&&n.rendered.setVisible(n.isVisible)}return t}_buildRenderMetadataAndSetVisibility(){const e=this.props.itemList,t=this._itemsRendered,i=[],n=this._itemToRenderFirst,r=Math.min(this._itemToRenderLast,e.length-1),s=this._idleRenderItems;let a=0,o=0;const l=[],d={};let h,p;this._renderMetadata=l,this._renderMetadataByKey=d;let g=!1;for(let m=0;m<e.length;m++){const f=e[m],S=f.key,v=t[S],y=m>=n&&m<=r,C=S in s,T=f.accessibilityGroup;T===c.AccessibilityGroupMarker.Begin||T===c.AccessibilityGroupMarker.BeginEnd?(h=p={isGroup:!0,isVisible:y?u.Visible:u.DisplayNone,rendered:v,item:f,children:[]},T===c.AccessibilityGroupMarker.BeginEnd&&(h=void 0),l.push(p)):T===c.AccessibilityGroupMarker.End&&h?(p={isVisible:y?u.Visible:u.DisplayNone,rendered:v,item:f,parent:h},h.children.push(p),h=void 0):(p={isVisible:y?u.Visible:u.DisplayNone,rendered:v,item:f,parent:h},(h&&h.children||l).push(p)),d[S]=p,(y||v||C||g)&&(m<r&&(g=!0),m===n&&(a=i.length),m===r&&(o=i.length,g=!1),i.push(p),C&&delete s[S])}if(i.length>S._maxRenderedCount&&o-a+1<S._maxRenderedCount){const e=i.length-S._maxRenderedCount;let t=Math.min(Math.ceil(e/2),a);const n=Math.min(e-t,i.length-o-1);if(t=e-n,n>0){for(let e=i.length-n;e<i.length;e++)p=i[e],p.isVisible=u.DisplayNone;i.splice(i.length-n,n)}if(t>0){for(let e=0;e<t;e++)p=i[e],p.isVisible=u.DisplayNone;i.splice(0,t)}}for(let e=0;e<i.length;e++){i[e].shouldRender=!0}for(let e=0;e<l.length;e++){const t=l[e],i=t.children;if(t.prev=l[e-1],t.next=l[e+1],i){let e,t;for(let n=0;n<i.length;n++)e=i[n],e.prev=i[n-1],e.next=i[n+1],!1!==e.item.isNavigable&&(t=e);t&&S._setOpacity0(t)}}this._renderedCount=i.length;const m=i[0];m&&(m.parent?(S._setOpacity0(m.parent),m.parent.prev&&(S._setOpacity0(m.parent.prev),S._setLastItemOpacity0(m.parent.prev))):m.prev&&(S._setOpacity0(m.prev),S._setLastItemOpacity0(m.prev)));const f=i[i.length-1];f&&(f.parent?(S._setOpacity0(f.parent),f.parent.next&&(S._setOpacity0(f.parent.next),S._setLastItemOpacity0(f.parent.next))):f.next&&(S._setOpacity0(f.next),S._setLastItemOpacity0(f.next)));let v=!0;for(let e=0;e<l.length;e++){p=l[e],p.rendered?p.rendered.setVisible(p.isVisible):p.isVisible!==u.DisplayNone&&(v=!1);const t=p.children;if(t)for(let e=0;e<t.length;e++)p=t[e],p.rendered?p.rendered.setVisible(p.isVisible):p.isVisible!==u.DisplayNone&&(v=!1)}return v}_renderGroup(e){const t=[],i=e.children,n=e.item;if(t.push(this._renderItem(n,e.isVisible)),i)for(let e=0;e<i.length;e++){const n=i[e];(n.shouldRender||n.isVisible!==u.DisplayNone)&&t.push(this._renderItem(n.item,n.isVisible))}return(0,r.jsx)(o.View,{ref:this._getGroupRefCallback(n),tabIndex:-1,accessibilityLabel:n.accessibilityGroupLabel,accessibilityTraits:n.accessibilityGroupTrait||o.Types.AccessibilityTrait.Group,children:t},n.key)}_renderItem(e,t){const i=e.key;let n=this._itemIdByKey[i];return n||(n=this._itemIdByKey[i]=S._uniqueIdPrefix+ ++S._lastUniqueId,this._itemKeyById[n]=i),(0,r.jsx)(f,{ref:this._getItemRefCallback(e),item:e,uniqueId:n,isFocused:!1,renderItem:this.props.renderItem,initiallyVisible:t,hoveredStyle:this.props.hoveredStyle},i)}_chooseItemsToRender(e){const t=e||this.props.itemList,i=this._scrollTop,n=this._height;let r=0,s=-1,a=0,o=0;if(this._isBottomUp){s=t.length-1;for(let e=t.length-1;e>=0;e--)o<i+S._heightReserve+n&&(r=e),o<i-S._heightReserve&&(s=e),a=this._getItemHeight(t[e]),o+=a}else for(let e=0;e<t.length;e++)o<i-S._heightReserve&&(r=e),o<i+S._heightReserve+n&&(s=e),a=this._getItemHeight(t[e]),o+=a;return this._totalHeight=o,(r!==this._itemToRenderFirst||s!==this._itemToRenderLast)&&(this._itemToRenderFirst=r,this._itemToRenderLast=s,!0)}_moveVisibiliyIfRendered(){return this._keepScrollTop(),!!this._buildRenderMetadataAndSetVisibility()&&(this._setHeights(),this.setFocusableItem(),!0)}_getItemHeight(e){const t=e.key;let i;if(e.measureHeight){const e=this._itemNodes[t];if(e){const n=e.offsetHeight;n>0&&(i=this._measuredHeights[t]=n)}else i=this._measuredHeights[t]}return i||e.height||50}_setHeights(){if(this._container){let e=0,t=0,i=!1;const n=this._renderMetadata;for(let r=0;r<n.length;r++){const s=n[r];if(s.isGroup){const n=this._setGroupHeightAndPadding(s.item.key);t+=n.height,n.nodeExists?i=!0:i||(e+=n.height)}else{const n=this._getItemHeight(s.item);t+=n,s.isVisible===u.Visible?i=!0:i||s.isVisible===u.Opacity0||(e+=n)}}this._topSpacerHeight!==e&&(this._topSpacerHeight=e,this._container.style.paddingTop=e+"px"),this._scrollHeight!==t&&(this._scrollHeight=t,this._container.style.height=t+"px",this._container.style.overflow="hidden",this.props.onHeight(t))}}_onItemRef(e,t){const i=e.key;t?this._itemNodes[i]=t:(delete this._itemRefCallbacks[i],delete this._itemNodes[i])}_onGroupRef(e,t){const i=e.key;t?this._groupNodes[i]=t:(delete this._groupRefCallbacks[i],delete this._groupNodes[i])}_setGroupHeightAndPadding(e){const t=this._renderMetadataByKey[e],i=t.children,n=this._itemIndexByKey[e]<this._itemToRenderFirst;let r=this._getItemHeight(t.item),s=t.isVisible===u.DisplayNone?r:0;if(i&&i.length){let e=!1;for(let t=0;t<i.length;t++){const a=i[t],o=this._getItemHeight(a.item);r+=o,n&&!e&&(a.isVisible===u.DisplayNone?s+=o:a.isVisible===u.Visible&&(e=!0))}}const a=this._groupNodes[e];return a?(a.style.height=r+"px",a.style.paddingTop=s+"px",{height:r,nodeExists:!0}):{height:r}}_renderMissing(e){(e||Math.abs(this._scrollTop-this._scrollTopPrev)>S._rerenderScrollTopDelta)&&(this._chooseItemsToRender()&&(this._moveVisibiliyIfRendered()||this.forceUpdate()),this._scrollTopPrev=this._scrollTop)}_getItemKeyByEventTarget(e){let t=e;for(;t;){const i=t.id;if(i&&i.substring(0,S._uniqueIdPrefix.length)===S._uniqueIdPrefix)return{key:this._itemKeyById[i],isItemContainer:t===e};t=t.parentNode}}_getItemTops(e,t){const i=this.props.itemList,n={};for(let r=this._itemToRenderFirst;r<=this._itemToRenderLast;r++){const s=i[r];if(s){const i=s.key,r=this._itemNodes[i];if(r){const s=r.getBoundingClientRect();s&&(void 0===e||s.bottom>=e)&&(void 0===t||s.top<=t)&&(n[i]=s.top)}}}return n}_animateChanges(){const e=this._rememberedItemTops,t=this._scrollTop;if(e&&this._container){if(this._animateChangesAnimationFrame&&(cancelAnimationFrame(this._animateChangesAnimationFrame),this._animateChangesAnimationFrame=void 0),this._pendingTransform.length){for(let e=0;e<this._pendingTransform.length;e++){const t=this._pendingTransform[e];t.style.transform="",t.style.transition="transform 0s"}this._pendingTransform=[]}const i=this._container.getBoundingClientRect().top+this._scrollTop-this._topSpacerHeight,n=i+this._height,r=this._getItemTops(i,n),s=this.props.itemList,a=[];for(let t=this._itemToRenderFirst;t<=this._itemToRenderLast;t++){const i=s[t];if(i){const t=i.key,n=e[t],s=r[t],o=this._itemNodes[t];o&&void 0!==n&&void 0!==s&&a.push({node:o,delta:n-s})}}this._rememberedItemTops=void 0,a.length&&(this._animateChangesAnimationFrame=requestAnimationFrame((()=>{if(this._scrollTop===t){for(let e=0;e<a.length;e++){const t=a[e];t.node.style.transform="translateY("+t.delta+"px)",t.node.style.transition="transform 0s",this._pendingTransform.push(t.node)}this._animateChangesAnimationFrame=requestAnimationFrame((()=>{this._animateChangesAnimationFrame=void 0;const e=this._scrollTop!==t;for(let t=0;t<a.length;t++){const i=a[t];i.node.style.transform="",e||(i.node.style.transition="transform .4s")}this._pendingTransform=[]}))}else this._animateChangesAnimationFrame=void 0})))}}_scheduleIdleRender(){this.props.skipRenderIfItemUnchanged&&(this._idleRenderTimer&&window.clearTimeout(this._idleRenderTimer),this._idleRenderTimer=window.setTimeout((()=>{if(this._idleRenderTimer=void 0,this._isMounted&&this._renderedCount<S._maxRenderedCount){const e=Object.keys(this._itemsNotRendered),t=this._idleRenderItems;for(let i=Math.min(S._idleRenderCount,e.length)-1;i>=0;i--)t[e[i]]=!0;e.length&&(this.forceUpdate(),this._scheduleIdleRender())}}),S._idleRenderTimeout))}setFocusableItem(e){const t=this._focusedItemKey?this._itemsRendered[this._focusedItemKey]:void 0;let i,n;if(e&&(i=e,n=this._itemsRendered[e]),!n&&t&&(i=this._focusedItemKey,n=t),n&&!n.isVisible()&&(i=void 0,n=void 0),!n){const e=this._findFirstVisibleItem();if(e){const t=e.key;n=this._itemsRendered[t],n&&(i=t)}}if(n)return t&&t!==n&&t.setFocusLimited(!0),this._focusedItemKey=i,n.setFocusLimited(!1),n}_findFirstVisibleItem(){const e=this.props.itemList,t=this._scrollTop;let i=0;for(let n=0;n<e.length;n++){const r=e[n];if(r){if(i>=t&&!1!==r.isNavigable)return r;i+=this._getItemHeight(r)}}}_selectSubsequentItem(e){if(this._focusedItemKey){const t=function e(t,i){let n=t&&t[i];for(;n;){if(n.isGroup){const e=n.children;if(e)if("next"===i)for(let t=0;t<e.length;t++){const i=e[t];if(i.rendered&&i.isVisible!==u.DisplayNone&&!1!==i.item.isNavigable)return i}else for(let t=e.length-1;t>=0;t--){const i=e[t];if(i.rendered&&i.isVisible!==u.DisplayNone&&!1!==i.item.isNavigable)return i}}else if(n.rendered&&n.isVisible!==u.DisplayNone&&!1!==n.item.isNavigable)return n;n=n[i]}const r=t&&t.parent;if(r)return e(r,i);return}(this._renderMetadataByKey[this._focusedItemKey],e===h.Down?"next":"prev");if(t){const e=t.item.key;if(e){const t=this.setFocusableItem(e);t&&t.focusItem()}}}}static _setOpacity0(e){e.isVisible===u.DisplayNone&&(e.isVisible=u.Opacity0)}static _setLastItemOpacity0(e){const t=e.children;if(t)for(let e=t.length-1;e>=0;e--){const i=t[e];if(!1!==i.item.isNavigable){i.isVisible===u.DisplayNone&&(i.isVisible=u.Opacity0);break}}}}S._initiallyRenderedLimit=12,S._heightReserve=1e3,S._rerenderScrollTopDelta=250,S._idleRenderTimeout=150,S._idleRenderCount=5,S._maxRenderedCount=100,S._lastUniqueId=0,S._uniqueIdPrefix="rx-vlv-"},545930:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});i(197582).__exportStar(i(765029),t)},765029:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setLanguageCookie=function(e){if("undefined"==typeof document)return;const t=function(e){return`${s}${e}`}(e),i=function(){const e=n.find(n.map(document.cookie.split(";"),(e=>e.trim())),(e=>e.startsWith(r)));return e&&e.substring(r.length)}();if(!i)return void o(t);const a=n.find(i.split(":"),(e=>e.startsWith(s)));o(a?i.replace(a,t):`${i}:${t}`)};const n=i(197582).__importStar(i(496486)),r="SC=",s="LC=",a="skype.com";function o(e){document.cookie=`${r}${e}; domain=${a}; path=/`}}}]);